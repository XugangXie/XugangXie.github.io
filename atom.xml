<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>xugang.xie&#39;s blog</title>
  
  <subtitle>Programmer</subtitle>
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2023-12-19T11:26:40.420Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>xugang.xie</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Infrastructure-AWS系列.2.部署EKS-部署Java微服务(使用ALB Ingress Controller)</title>
    <link href="http://example.com/2023/08/20/18.D002.Infrastructure-AWS%E7%B3%BB%E5%88%97.2.%E9%83%A8%E7%BD%B2EKS-%E9%83%A8%E7%BD%B2Java%E5%BE%AE%E6%9C%8D%E5%8A%A1(%E4%BD%BF%E7%94%A8ALB%20Ingress%20Controller)/"/>
    <id>http://example.com/2023/08/20/18.D002.Infrastructure-AWS%E7%B3%BB%E5%88%97.2.%E9%83%A8%E7%BD%B2EKS-%E9%83%A8%E7%BD%B2Java%E5%BE%AE%E6%9C%8D%E5%8A%A1(%E4%BD%BF%E7%94%A8ALB%20Ingress%20Controller)/</id>
    <published>2023-08-19T16:00:00.000Z</published>
    <updated>2023-12-19T11:26:40.420Z</updated>
    
    <content type="html"><![CDATA[<h2 id="&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x5728;AWS&#x91CC;"><a href="#&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x5728;AWS&#x91CC;" class="headerlink" title="&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x5728;AWS&#x91CC;"></a>&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x5728;AWS&#x91CC;</h2><p>1.&#x521B;&#x5EFA;EKS&#x96C6;&#x7FA4;&#xFF1B;<br>2.EKS&#x96C6;&#x7FA4;&#x91CC;&#x521B;&#x5EFA;&#x8282;&#x70B9;&#x7EC4;&#xFF1B;<br>3.EKS&#x96C6;&#x7FA4;&#x521B;&#x5EFA;&#x670D;&#x52A1;namespace&#xFF1B;<br>4.&#x521B;&#x5EFA;ECR&#xFF1B;<br>5.&#x521B;&#x5EFA;SSL/TLS&#x8BC1;&#x4E66;&#xFF0C;&#x5E76; &#x901A;&#x8FC7; CNAME &#x65B9;&#x5F0F;&#xFF0C;&#x57DF;&#x540D;&#x89E3;&#x6790;&#x7ED1;&#x5B9A;&#xFF1B;<br>6.&#x90E8;&#x7F72;ALB Ingress Controller</p><span id="more"></span><h2 id="&#x53C2;&#x8003;&#x8D44;&#x6599;&#xFF1A;"><a href="#&#x53C2;&#x8003;&#x8D44;&#x6599;&#xFF1A;" class="headerlink" title="&#x53C2;&#x8003;&#x8D44;&#x6599;&#xFF1A;"></a>&#x53C2;&#x8003;&#x8D44;&#x6599;&#xFF1A;</h2><ul><li><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/network-load-balancing.html">Amazon EKS &#x4E0A;&#x7684;&#x7F51;&#x7EDC;&#x8D1F;&#x8F7D;&#x5747;&#x8861;</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/alb-ingress.html">Amazon EKS &#x4E0A;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8D1F;&#x8F7D;&#x5747;&#x8861;</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/aws-load-balancer-controller.html">&#x5B89;&#x88C5; AWS Load Balancer Controller &#x9644;&#x52A0;&#x7EC4;&#x4EF6;</a></li><li><a href="https://zhuanlan.zhihu.com/p/458454919">AWS EKS &#x96C6;&#x7FA4;&#x914D;&#x7F6E;ALB Ingress</a></li></ul><h2 id="1-&#x73AF;&#x5883;"><a href="#1-&#x73AF;&#x5883;" class="headerlink" title="1.&#x73AF;&#x5883;"></a>1.&#x73AF;&#x5883;</h2><p>&#x516C;&#x6709;&#x4E91;&#xFF1A;AWS Cloud<br>&#x9879;&#x76EE;&#x540D;&#x79F0;&#xFF1A;mta-swappie<br>&#x9879;&#x76EE;&#x73AF;&#x5883;&#xFF1A;uat<br>&#x533A;&#x57DF;&#xFF1A; &#x4E9A;&#x592A;&#x5730;&#x533A;(&#x9999;&#x6E2F;) ap-east-1</p><p>IAM &#x6839;&#x8D26;&#x6237;&#x767B;&#x5F55;&#xFF1A; ???<br>&#x8D26;&#x6237;ID&#xFF1A;???<br>&#x7528;&#x6237;&#x540D;&#xFF1A;???<br>&#x5BC6;&#x7801;&#xFF1A;   ???</p><p>&#x8DF3;&#x677F;&#x673A;&#xFF1A;<code>10.112.36.9</code></p><h2 id="2-&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x5B89;&#x88C5;&#x547D;&#x4EE4;&#x884C;"><a href="#2-&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x5B89;&#x88C5;&#x547D;&#x4EE4;&#x884C;" class="headerlink" title="2.&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x5B89;&#x88C5;&#x547D;&#x4EE4;&#x884C;"></a>2.&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x5B89;&#x88C5;&#x547D;&#x4EE4;&#x884C;</h2><h3 id="1-AWS-CLI"><a href="#1-AWS-CLI" class="headerlink" title="1.AWS CLI"></a>1.AWS CLI</h3><p>&#x7565;</p><p>&#x5982;&#x679C;&#x8DF3;&#x677F;&#x673A;&#x4E0A;&#x5DF2;&#x7ECF;&#x6709;&#x4E86;aws&#x914D;&#x7F6E;&#x4E86;&#x3002;&#x518D;&#x914D;&#x7F6E;&#x4E2A;&#x7528;&#x6237;&#xFF0C;<a href="https://www.jibing57.com/2017/10/24/how-to-use-aws-cli-with-multi-user/">&#x8DF3;&#x677F;&#x673A;&#x4E0A;&#x914D;&#x7F6E;&#x591A;&#x7528;&#x6237;</a></p><h4 id="1-aws&#x8D26;&#x6237;&#x4E2D;&#x83B7;&#x53D6;accessID&#x548C;accessKey"><a href="#1-aws&#x8D26;&#x6237;&#x4E2D;&#x83B7;&#x53D6;accessID&#x548C;accessKey" class="headerlink" title="1.aws&#x8D26;&#x6237;&#x4E2D;&#x83B7;&#x53D6;accessID&#x548C;accessKey"></a>1.aws&#x8D26;&#x6237;&#x4E2D;&#x83B7;&#x53D6;accessID&#x548C;accessKey</h4><p>&#x8FDB;&#x5165;&#x53F3;&#x4E0A;&#x65B9;<code>&#x8D26;&#x6237;</code>&#xFF0C;&#x4E0B;&#x62C9;&#xFF0C;&#x627E;&#x5230;&#xFF1A;<code>Security Credentials</code>&#xFF0C;&#x70B9;&#x51FB;&#x8FDB;&#x5165;<br>&#x627E;&#x5230;<code>&#x8BBF;&#x95EE;&#x5BC6;&#x94A5;</code>&#xFF0C;&#x521B;&#x5EFA;&#x8BBF;&#x95EE;&#x5BC6;&#x94A5;&#xFF0C;&#x6700;&#x540E;&#x5F97;&#x5230; <code>ACCESS ID</code> &#x548C; <code>Access Key</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws_access_key_id = &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br><span class="line">aws_secret_access_key = &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br></pre></td></tr></table></figure><h4 id="2-&#x914D;&#x7F6E;"><a href="#2-&#x914D;&#x7F6E;" class="headerlink" title="2.&#x914D;&#x7F6E;"></a>2.&#x914D;&#x7F6E;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">su - gitlab-runner</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ~/.aws</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll</span></span><br><span class="line">-rw------- 1 gitlab-runner gitlab-runner  43 Jul 20 14:06 config</span><br><span class="line">-rw------- 1 gitlab-runner gitlab-runner 116 Jul 20 14:06 credentials</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">aws configure --profile devops</span></span><br><span class="line"></span><br><span class="line">&#x4EA4;&#x4E92;&#x5F0F;</span><br><span class="line">AWS Access Key ID [None]: &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br><span class="line">AWS Secret Access Key [None]: &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br><span class="line">Default region name [None]: ap-east-1</span><br><span class="line">Default output format [None]: json</span><br></pre></td></tr></table></figure><h4 id="3-&#x67E5;&#x8BE2;&#x547D;&#x4EE4;"><a href="#3-&#x67E5;&#x8BE2;&#x547D;&#x4EE4;" class="headerlink" title="3.&#x67E5;&#x8BE2;&#x547D;&#x4EE4;"></a>3.&#x67E5;&#x8BE2;&#x547D;&#x4EE4;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> ~/.aws/config</span></span><br><span class="line">[default]</span><br><span class="line">region = ap-east-1</span><br><span class="line">output = json</span><br><span class="line">[profile devops]</span><br><span class="line">region = ap-east-1</span><br><span class="line">output = json</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> ~/.aws/credentials</span></span><br><span class="line">[default]</span><br><span class="line">aws_access_key_id = &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br><span class="line">aws_secret_access_key = &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br><span class="line">[devops]</span><br><span class="line">aws_access_key_id = &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br><span class="line">aws_secret_access_key = &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">aws configure list</span></span><br><span class="line">      Name                    Value             Type    Location</span><br><span class="line">      ----                    -----             ----    --------</span><br><span class="line">   profile                &lt;not set&gt;             None    None</span><br><span class="line">access_key     ****************7NE7 shared-credentials-file    </span><br><span class="line">secret_key     ****************t3Sk shared-credentials-file    </span><br><span class="line">    region                ap-east-1      config-file    ~/.aws/confi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">aws configure list-profiles</span></span><br><span class="line">default</span><br><span class="line">devops</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">aws sts get-caller-identity --profile devops</span></span><br><span class="line">{</span><br><span class="line">    &quot;UserId&quot;: &quot;AIDAV64JZYENGH2XWUBGE&quot;,</span><br><span class="line">    &quot;Account&quot;: &quot;409921503514&quot;,</span><br><span class="line">    &quot;Arn&quot;: &quot;arn:aws:iam::409921503514:user/devops&quot;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="2-&#x5B89;&#x88C5;-eksctl"><a href="#2-&#x5B89;&#x88C5;-eksctl" class="headerlink" title="2.&#x5B89;&#x88C5; eksctl"></a>2.&#x5B89;&#x88C5; eksctl</h3><h4 id="1-&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;root&#x7528;&#x6237;&#x64CD;&#x4F5C;&#xFF1A;"><a href="#1-&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;root&#x7528;&#x6237;&#x64CD;&#x4F5C;&#xFF1A;" class="headerlink" title="1.&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;root&#x7528;&#x6237;&#x64CD;&#x4F5C;&#xFF1A;"></a>1.&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;<code>root</code>&#x7528;&#x6237;&#x64CD;&#x4F5C;&#xFF1A;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install dpkg</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dpkg --print-architecture</span></span><br><span class="line">amd64</span><br><span class="line"></span><br><span class="line">&#x5728; /etc/sudoers &#x6587;&#x4EF6;&#x91CC;&#xFF0C;&#x589E;&#x52A0;&#x7528;&#x6237; gitlab-runner &#x7684; sudo &#x65E0;&#x5BC6;&#x7801;&#x6743;&#x9650;</span><br><span class="line">TODO</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;-gitlab-runner-&#x7528;&#x6237;&#x64CD;&#x4F5C;&#x5B89;&#x88C5;eksctl&#xFF1A;"><a href="#2-&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;-gitlab-runner-&#x7528;&#x6237;&#x64CD;&#x4F5C;&#x5B89;&#x88C5;eksctl&#xFF1A;" class="headerlink" title="2.&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5; gitlab-runner &#x7528;&#x6237;&#x64CD;&#x4F5C;&#x5B89;&#x88C5;eksctl&#xFF1A;"></a>2.&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5; <code>gitlab-runner</code> &#x7528;&#x6237;&#x64CD;&#x4F5C;&#x5B89;&#x88C5;eksctl&#xFF1A;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">su - gitlab-runner</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">for</span> ARM systems, <span class="built_in">set</span> ARCH to: `arm64`, `armv6` or `armv7`</span></span><br><span class="line">ARCH=amd64</span><br><span class="line">PLATFORM=$(uname -s)_$ARCH</span><br><span class="line"></span><br><span class="line">curl -sLO &quot;https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_$PLATFORM.tar.gz&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(Optional) Verify checksum</span></span><br><span class="line">curl -sL &quot;https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_checksums.txt&quot; | grep $PLATFORM | sha256sum --check</span><br><span class="line"></span><br><span class="line">tar -xzf eksctl_$PLATFORM.tar.gz -C /tmp &amp;&amp; rm eksctl_$PLATFORM.tar.gz</span><br><span class="line"></span><br><span class="line">sudo mv /tmp/eksctl /usr/local/bin</span><br></pre></td></tr></table></figure><p>&#x9A8C;&#x8BC1;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">eksctl version</span></span><br><span class="line">0.150.0-dev</span><br></pre></td></tr></table></figure><h3 id="3-&#x5B89;&#x88C5;Helm"><a href="#3-&#x5B89;&#x88C5;Helm" class="headerlink" title="3.&#x5B89;&#x88C5;Helm"></a>3.&#x5B89;&#x88C5;Helm</h3><p><a href="https://helm.sh/zh/docs/intro/install/">https://helm.sh/zh/docs/intro/install/</a><br><a href="https://helm.sh/zh/docs/intro/quickstart/">https://helm.sh/zh/docs/intro/quickstart/</a></p><p>1.&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;<code>gitlab-runner</code>&#x7528;&#x6237;&#x64CD;&#x4F5C;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">su - gitlab-runner</span></span><br><span class="line"></span><br><span class="line">&#x4F7F;&#x7528;&#x811A;&#x672C;&#x5B89;&#x88C5;</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> 700 get_helm.sh</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./get_helm.sh</span></span><br><span class="line">Downloading https://get.helm.sh/helm-v3.12.2-linux-amd64.tar.gz</span><br><span class="line">Verifying checksum... Done.</span><br><span class="line">Preparing to install helm into /usr/local/bin</span><br><span class="line">helm installed into /usr/local/bin/helm</span><br></pre></td></tr></table></figure><p>&#x5982;&#x679C;&#x60F3;&#x76F4;&#x63A5;&#x6267;&#x884C;&#x5B89;&#x88C5;&#xFF0C;&#x8FD0;&#x884C;curl <code>https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm get -h</span></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="4-&#x5B89;&#x88C5;kubectl"><a href="#4-&#x5B89;&#x88C5;kubectl" class="headerlink" title="4.&#x5B89;&#x88C5;kubectl"></a>4.&#x5B89;&#x88C5;kubectl</h3><p>&#x7565;</p><h2 id="3-&#x521B;&#x5EFA;EKS&#x96C6;&#x7FA4;"><a href="#3-&#x521B;&#x5EFA;EKS&#x96C6;&#x7FA4;" class="headerlink" title="3.&#x521B;&#x5EFA;EKS&#x96C6;&#x7FA4;"></a>3.&#x521B;&#x5EFA;EKS&#x96C6;&#x7FA4;</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//&#x5217;&#x51FA;&#x96C6;&#x7FA4;</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">eksctl get cluster --profile devops</span></span><br><span class="line">NAME    REGION          EKSCTL CREATED</span><br><span class="line">uat-hk  ap-east-1       False</span><br><span class="line"></span><br><span class="line">//&#x5217;&#x51FA;&#x8282;&#x70B9;&#x7EC4;</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">eksctl get nodegroup --cluster=uat-hk --profile devops</span></span><br><span class="line">CLUSTER NODEGROUP       STATUS  CREATED                 MIN SIZE        MAX SIZE        DESIRED CAPACITY        INSTANCE TYPE   IMAGE ID        ASG NAME    TYPE</span><br><span class="line">uat-hk  uat-hk-node     ACTIVE  2023-07-24T07:27:09Z    1               2               1                       t3.xlarge       AL2_x86_64      eks-uat-hk-node-58c4c365-b840-0fef-5ab1-21d130c433a7 managed</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="1-eksctl-&#x547D;&#x4EE4;&#x521B;&#x5EFA;EKS"><a href="#1-eksctl-&#x547D;&#x4EE4;&#x521B;&#x5EFA;EKS" class="headerlink" title="1.eksctl &#x547D;&#x4EE4;&#x521B;&#x5EFA;EKS"></a><del>1.eksctl &#x547D;&#x4EE4;&#x521B;&#x5EFA;EKS</del></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">eksctl create cluster \</span></span><br><span class="line"><span class="language-bash">    --name uat-mta-hk \</span></span><br><span class="line"><span class="language-bash">    --version 1.27 \</span></span><br><span class="line"><span class="language-bash">    --nodes=1 \</span></span><br><span class="line"><span class="language-bash">    --node-type=t3.xlarge</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>&#x8BE5;&#x8FC7;&#x7A0B;&#x53EF;&#x80FD;&#x9700;&#x8981; 15 &#x5230; 20 &#x5206;&#x949F;&#x3002;&#x521B;&#x5EFA;&#x96C6;&#x7FA4;&#x540E;&#xFF0C;&#x76F8;&#x5E94;&#x7684; Kubernetes&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x4F1A;&#x6DFB;&#x52A0;&#x5230; <code>~/.kube/config</code></p><p>EKS&#x63A7;&#x5236;&#x53F0;&#x770B;&#x5230;&#xFF0C;&#x521B;&#x5EFA;&#x4E86;cluster-name=<code>uat-mta-hk</code>&#xFF0C;node-group-name=<code>ng-973757bd</code></p><p>&#x66F4;&#x6539; .kube/config &#x6587;&#x4EF6;&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mv ~/.kube/config ~/.kube/config-uat-aws-mta-hk-xxg</span><br></pre></td></tr></table></figure><p>&#x76EE;&#x524D;&#x8FD9;&#x4E2A;&#x9879;&#x76EE;&#x7684;kubeconfig&#x6587;&#x4EF6;&#x76EE;&#x5F55;&#xFF1A;<code>/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg</code></p><p><strong>&#x4E0D;&#x7528;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x521B;&#x5EFA;&#xFF0C;&#x56E0;&#x4E3A;&#x6CA1;&#x6CD5;&#x6307;&#x5B9A;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#x7684;&#x4E86;VPC&#xFF1A;<code>vpc-0c087f9ee1ce8c561</code>&#xFF0C;&#x6539;&#x7528;&#x63A7;&#x5236;&#x53F0;&#x521B;&#x5EFA;&#xFF0C;&#x5982;&#x4E0B;</strong></p><h3 id="2-&#x63A7;&#x5236;&#x53F0;&#x521B;&#x5EFA;EKS"><a href="#2-&#x63A7;&#x5236;&#x53F0;&#x521B;&#x5EFA;EKS" class="headerlink" title="2.&#x63A7;&#x5236;&#x53F0;&#x521B;&#x5EFA;EKS"></a>2.&#x63A7;&#x5236;&#x53F0;&#x521B;&#x5EFA;EKS</h3><h4 id="1-&#x521B;&#x5EFA;&#x96C6;&#x7FA4;-uat-mta-xxg"><a href="#1-&#x521B;&#x5EFA;&#x96C6;&#x7FA4;-uat-mta-xxg" class="headerlink" title="1.&#x521B;&#x5EFA;&#x96C6;&#x7FA4;: uat-mta-xxg"></a>1.&#x521B;&#x5EFA;&#x96C6;&#x7FA4;: uat-mta-xxg</h4><ol><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.1.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.2.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.3.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.4.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.5.png"></p></li><li><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x914D;&#x7F6E;&#x96C6;&#x7FA4;&#xFF1A;</span><br><span class="line">    &#x540D;&#x79F0;: uat-mta-xxg</span><br><span class="line">    Kubernetes &#x7248;&#x672C;: 1.27</span><br><span class="line">    &#x96C6;&#x7FA4;&#x670D;&#x52A1;&#x89D2;&#x8272;: arn:aws:iam::409921503514:role/eks-operator</span><br><span class="line">&#x6307;&#x5B9A;&#x8054;&#x7F51;&#xFF1A;</span><br><span class="line">    &#x9ED8;&#x8BA4; VPC&#x3001;3&#x4E2A;&#x5B50;&#x7F51;&#x3001;IPv4 &#x3001;&#x516C;&#x7F51;</span><br><span class="line">&#x914D;&#x7F6E;&#x65E5;&#x5FD7;&#x8BB0;&#x5F55;&#xFF1A;</span><br><span class="line">    &#x90FD;&#x52FE;&#x9009;</span><br><span class="line">&#x9009;&#x62E9;&#x63D2;&#x4EF6;&#xFF1A;</span><br><span class="line">    &#x7528;&#x9ED8;&#x8BA4;&#x7684;3&#x4E2A;</span><br><span class="line">&#x914D;&#x7F6E;&#x9009;&#x5B9A;&#x7684;&#x63D2;&#x4EF6;&#x8BBE;&#x7F6E;&#xFF1A;</span><br><span class="line">    &#x7528;&#x9ED8;&#x8BA4;&#x7684;&#x7248;&#x672C;</span><br><span class="line">&#x67E5;&#x770B;&#x548C;&#x521B;&#x5EFA;</span><br><span class="line">    &#x6700;&#x540E;&#x70B9;&#x51FB;&#x521B;&#x5EFA;</span><br></pre></td></tr></table></figure></li></ol><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.6.png"></p><p>6.1<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.6.1.png"></p><p>6.2<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.6.2.png"></p><ol start="7"><li><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.7.png"></li></ol><h4 id="2-&#x4E3A;&#x96C6;&#x7FA4;&#xFF1A;uat-mta-xxg&#xFF0C;&#x751F;&#x6210;-kube-x2F-config-&#x6587;&#x4EF6;"><a href="#2-&#x4E3A;&#x96C6;&#x7FA4;&#xFF1A;uat-mta-xxg&#xFF0C;&#x751F;&#x6210;-kube-x2F-config-&#x6587;&#x4EF6;" class="headerlink" title="2.&#x4E3A;&#x96C6;&#x7FA4;&#xFF1A;uat-mta-xxg&#xFF0C;&#x751F;&#x6210; .kube/config &#x6587;&#x4EF6;"></a>2.&#x4E3A;&#x96C6;&#x7FA4;&#xFF1A;uat-mta-xxg&#xFF0C;&#x751F;&#x6210; .kube/config &#x6587;&#x4EF6;</h4><blockquote><p>&#x56E0;&#x4E3A; <code>~/.aws/config</code> &#x91CC;&#x6709;&#x591A;&#x4E2A;&#x7528;&#x6237;&#xFF0C;&#x6240;&#x4EE5;&#x4F7F;&#x7528; <code>--profile devops</code> &#x6307;&#x5B9A;&#x4F7F;&#x7528;<code>devops</code>&#x7528;&#x6237;</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aws eks update-kubeconfig --region ap-east-1 --name uat-mta-xxg --profile devops</span></span><br><span class="line">Added new context arn:aws:eks:ap-east-1:409921503514:cluster/uat-mta-xxg to /home/gitlab-runner/.kube/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mv</span> ~/.kube/config ~/.kube/config-uat-aws-mta-hk-xxg</span></span><br></pre></td></tr></table></figure><h4 id="3-&#x4E3A;&#x96C6;&#x7FA4;-uat-mta-xxg-&#x521B;&#x5EFA;&#x8282;&#x70B9;&#x7EC4;-uta-mta-xxg-nodegroup"><a href="#3-&#x4E3A;&#x96C6;&#x7FA4;-uat-mta-xxg-&#x521B;&#x5EFA;&#x8282;&#x70B9;&#x7EC4;-uta-mta-xxg-nodegroup" class="headerlink" title="3.&#x4E3A;&#x96C6;&#x7FA4;: uat-mta-xxg &#x521B;&#x5EFA;&#x8282;&#x70B9;&#x7EC4;: uta-mta-xxg-nodegroup"></a>3.&#x4E3A;&#x96C6;&#x7FA4;: uat-mta-xxg &#x521B;&#x5EFA;&#x8282;&#x70B9;&#x7EC4;: uta-mta-xxg-nodegroup</h4><ol><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.1.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.2.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.3.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.4.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.5.png"></p></li></ol><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.5.1.png"></p><ol start="6"><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.6.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.7.1.png"></p></li></ol><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.7.png"></p><ol start="8"><li><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.8.png"></li></ol><p>&#x540D;&#x79F0;: uta-mta-xxg-nodegroup<br>&#x8282;&#x70B9; IAM &#x89D2;&#x8272;: arn:aws:iam::409921503514:role/AmazonEKSNodeRole</p><ol start="9"><li><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.9.png"></li></ol><p>EC2&#x8282;&#x70B9;&#x5217;&#x8868;&#x4E2D;&#xFF0C;&#x65B0;&#x589E;&#x4E86;&#x4E2A;&#x8282;&#x70B9;&#xFF1A;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.10.png"></p><h3 id="3-kubectl&#x521B;&#x5EFA;namespace"><a href="#3-kubectl&#x521B;&#x5EFA;namespace" class="headerlink" title="3.kubectl&#x521B;&#x5EFA;namespace"></a>3.kubectl&#x521B;&#x5EFA;namespace</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg create namespace java-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg get namespace</span></span><br><span class="line"></span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   121m</span><br><span class="line">java-service      Active   4s</span><br><span class="line">kube-node-lease   Active   121m</span><br><span class="line">kube-public       Active   121m</span><br><span class="line">kube-system       Active   121m</span><br></pre></td></tr></table></figure><h3 id="4-&#x914D;&#x7F6E;AWS-ECR"><a href="#4-&#x914D;&#x7F6E;AWS-ECR" class="headerlink" title="4. &#x914D;&#x7F6E;AWS ECR"></a>4. &#x914D;&#x7F6E;AWS ECR</h3><h4 id="1-&#x521B;&#x5EFA;-ECR"><a href="#1-&#x521B;&#x5EFA;-ECR" class="headerlink" title="1.&#x521B;&#x5EFA; ECR"></a>1.&#x521B;&#x5EFA; ECR</h4><p>Amazon ECR &#x2013;&gt; Repository &#x2013;&gt; &#x521B;&#x5EFA;&#x5B58;&#x50A8;&#x5E93;: <code>prod-swappie</code><br>URI: <code>409921503514.dkr.ecr.eu-central-1.amazonaws.com/prod-swappie</code></p><h4 id="2-&#x751F;&#x6210;docker-auth&#x6587;&#x4EF6;"><a href="#2-&#x751F;&#x6210;docker-auth&#x6587;&#x4EF6;" class="headerlink" title="2.&#x751F;&#x6210;docker auth&#x6587;&#x4EF6;"></a>2.&#x751F;&#x6210;docker auth&#x6587;&#x4EF6;</h4><p>&#x76EE;&#x5F55; <code>~/.docker/config.json</code> &#x4E0B;&#x7684;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#xFF0C;&#x4E0D;&#x7528;&#x4E3B;&#x52A8;&#x751F;&#x6210;&#xFF0C;CI&#x811A;&#x672C;&#x91CC;&#x4F7F;&#x7528;&#x547D;&#x4EE4;&#xFF1A;<code>aws ecr get-login-password --region ${region} --profile devops | docker --config=/home/gitlab-runner/awsdocker login --username AWS --password-stdin ${dockerRepo}</code>&#xFF0C;&#x4F1A;&#x5728;&#x76EE;&#x5F55; <code>/home/gitlab-runner/awsdocker</code> &#x4E0B;&#x751F;&#x4EA7;&#x4E2A;&#x4E34;&#x65F6;&#x7684;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x6587;&#x4EF6;&#xFF1A;config.json&#xFF0C;&#x6709;&#x6548;&#x671F;&#x4E3A;12&#x5C0F;&#x65F6;</p><p><a href="https://docs.aws.amazon.com/cli/latest/reference/ecr/get-login-password.html">get-login-password &#x8BF4;&#x660E;</a></p><p>&#x9879;&#x76EE;&#x4E2D;&#x7684;&#x547D;&#x4EE4;&#x4E3A;&#xFF1A;<code>aws ecr get-login-password --region ap-east-1 --profile devops | docker --config=/home/gitlab-runner/awsdocker login --username AWS --password-stdin 409921503514.dkr.ecr.ap-east-1.amazonaws.com</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /home/gitlab-runner/awsdocker/config.json</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="5-&#x5B89;&#x88C5;groovy"><a href="#5-&#x5B89;&#x88C5;groovy" class="headerlink" title="5.&#x5B89;&#x88C5;groovy"></a>5.&#x5B89;&#x88C5;groovy</h3><p>&#x7565;</p><h3 id="6-kubectl-&#x521B;&#x5EFA;&#x7EC4;&#x4EF6;"><a href="#6-kubectl-&#x521B;&#x5EFA;&#x7EC4;&#x4EF6;" class="headerlink" title="6.kubectl &#x521B;&#x5EFA;&#x7EC4;&#x4EF6;"></a>6.kubectl &#x521B;&#x5EFA;&#x7EC4;&#x4EF6;</h3><h4 id="1-&#x57DF;&#x540D;&#x521B;&#x5EFA;SSL-x2F-TLS&#x8BC1;&#x4E66;"><a href="#1-&#x57DF;&#x540D;&#x521B;&#x5EFA;SSL-x2F-TLS&#x8BC1;&#x4E66;" class="headerlink" title="1.&#x57DF;&#x540D;&#x521B;&#x5EFA;SSL/TLS&#x8BC1;&#x4E66;"></a>1.&#x57DF;&#x540D;&#x521B;&#x5EFA;SSL/TLS&#x8BC1;&#x4E66;</h4><p>&#x57DF;&#x540D;&#xFF1A;<code>mta-api.xiexugang.top</code></p><ol><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/acm/acm.1.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/acm/acm.2.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/acm/acm.3.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/acm/acm.4.png"></p></li></ol><p>&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;ACM&#x8BC1;&#x4E66;&#x540E;&#xFF0C;&#x5F97;&#x5230;&#xFF1A;<br>CNAME&#x540D;&#x79F0;=<code>_0c526310858e7611864e9a61ebf63585.mta-api.xiexugang.top.</code><br>CNAME&#x503C;=<code>_d25211e083127004cc043f3801a5e63e.vlvttdkdcz.acm-validations.aws.</code></p><p>&#x8FDB;&#x5165;&#x8FD9;&#x4E2A;&#x57DF;&#x540D;&#x7684;&#x6258;&#x7BA1;&#x5546;&#x540E;&#x53F0;&#xFF0C;&#x521B;&#x5EFA;&#x4E00;&#x6761;CNAME&#x8BB0;&#x5F55;&#xFF1A;<br><code>_0c526310858e7611864e9a61ebf63585.mta-api.xiexugang.top</code> CNAME <code>_d25211e083127004cc043f3801a5e63e.vlvttdkdcz.acm-validations.aws.</code></p><ol><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/acm/acm.5.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/acm/acm.6.png"></p></li></ol><p>&#x7136;&#x540E;&#x8FC7;&#x4E00;&#x4F1A;&#x513F;&#xFF08;1&#x5206;&#x949F;&#x4EE5;&#x5185;&#xFF09;&#xFF0C;&#x8FDB;&#x5165;ACM&#x4E2D;&#xFF0C;&#x67E5;&#x770B;&#x72B6;&#x6001;&#xFF1A;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/acm/acm.7.png"></p><h4 id="2-service"><a href="#2-service" class="headerlink" title="2.service"></a>2.service</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-uat-aws-xxg</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service apply -f service-clusterip-swappie.yaml</span></span><br><span class="line"></span><br><span class="line">service/mta-swappie-service created</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/create-eks-service.1.png"></p><p><code>service-clusterip-swappie.yaml</code> &#x5185;&#x5BB9;&#xFF1A;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span>  <span class="comment"># &#x7C7B;&#x578B;&#x4E3A; Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mta-swappie-service</span>  <span class="comment"># Service &#x7684;&#x540D;&#x79F0;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># &#x6807;&#x7B7E;&#x9009;&#x62E9;&#x5668;&#xFF0C;&#x4F1A;&#x548C;&#x4E0A;&#x9762;&#x521B;&#x5EFA;&#x7684; deployment.yaml &#x7684; pod &#x5173;&#x8054;&#x8D77;&#x6765;</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">  <span class="attr">clusterIP:</span>  <span class="comment"># service &#x7684; ip &#x5730;&#x5740;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5199;&#xFF0C;&#x9ED8;&#x8BA4;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;,&#x6CE8;&#x610F;&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x4E0D;&#x80FD;&#x5199;&#xFF0C;&#x6709;&#x4E2A;&#x8303;&#x56F4;&#x7684;&#xFF0C;&#x6211;&#x7684;&#x662F; 172.31.0.0/16</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span> <span class="comment"># &#x7C7B;&#x578B;&#x4E3A; Service &#x7684; ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span>  <span class="comment"># Service &#x7AEF;&#x53E3;&#xFF0C;&#x81EA;&#x5B9A;&#x4E49;</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span> <span class="comment"># pod &#x7AEF;&#x53E3;&#xFF0C;&#x4E0D;&#x5199;&#x9ED8;&#x8BA4;&#x662F; 80</span></span><br></pre></td></tr></table></figure><p>&#x622A;&#x6B62;&#x5230;&#x76EE;&#x524D;&#xFF0C;&#x5DF2;&#x7ECF;&#x521B;&#x5EFA;&#x4E86; <code>namespace</code>&#x3001;<code>service</code>&#x3001;<code>SSL/TLS</code>&#x8BC1;&#x4E66;&#x3001;&#x57DF;&#x540D;&#x9A8C;&#x8BC1;&#xFF0C; &#x5269;&#x4E0B;&#x7684;<code>ingressClass</code>&#x3001;<code>ingress</code>&#x3001;<code>deployment</code>&#x3001;<code>pod</code>&#x76EE;&#x524D;&#x8FD8;&#x4E0D;&#x80FD;&#x521B;&#x5EFA;&#xFF0C;&#x9700;&#x8981;&#x5148;&#x90E8;&#x7F72;&#x597D;&#xFF1A;  <code>AWS Application Loand Balance Ingress Controller</code></p><h3 id="7-&#x90E8;&#x7F72;-AWS-ALB-Ingress-Controller"><a href="#7-&#x90E8;&#x7F72;-AWS-ALB-Ingress-Controller" class="headerlink" title="7. &#x90E8;&#x7F72; AWS ALB Ingress Controller"></a>7. &#x90E8;&#x7F72; AWS ALB Ingress Controller</h3><p>&#x53C2;&#x8003;:</p><ul><li><a href="https://zhuanlan.zhihu.com/p/458454919">AWS EKS &#x96C6;&#x7FA4;&#x914D;&#x7F6E; ALB Ingress</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/aws-load-balancer-controller.html">&#x5B89;&#x88C5; AWS Load Balancer Controller &#x9644;&#x52A0;&#x7EC4;&#x4EF6;</a></li></ul><p>&#x6B65;&#x9AA4;1&#xFF1A;&#x521B;&#x5EFA;&#x7B56;&#x7565;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="https://zhuanlan.zhihu.com/p/458454919">AWS EKS &#x96C6;&#x7FA4;&#x914D;&#x7F6E; ALB Ingress</a></p><h4 id="1-&#x547D;&#x4EE4;&#x884C;&#x521B;&#x5EFA;&#x7B56;&#x7565;&#xFF1A;AWSLoadBalancerControllerIAMPolicyXxg"><a href="#1-&#x547D;&#x4EE4;&#x884C;&#x521B;&#x5EFA;&#x7B56;&#x7565;&#xFF1A;AWSLoadBalancerControllerIAMPolicyXxg" class="headerlink" title="1.&#x547D;&#x4EE4;&#x884C;&#x521B;&#x5EFA;&#x7B56;&#x7565;&#xFF1A;AWSLoadBalancerControllerIAMPolicyXxg"></a>1.&#x547D;&#x4EE4;&#x884C;&#x521B;&#x5EFA;&#x7B56;&#x7565;&#xFF1A;<code>AWSLoadBalancerControllerIAMPolicyXxg</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-uat-aws-xxg</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy.json</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aws iam create-policy \</span></span><br><span class="line"><span class="language-bash">    --policy-name AWSLoadBalancerControllerIAMPolicyXxg \</span></span><br><span class="line"><span class="language-bash">    --policy-document file://iam_policy.json</span></span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    &quot;Policy&quot;: {</span><br><span class="line">        &quot;PolicyName&quot;: &quot;AWSLoadBalancerControllerIAMPolicyXxg&quot;,</span><br><span class="line">        &quot;PolicyId&quot;: &quot;ANPAV64JZYENIBHOWCHEH&quot;,</span><br><span class="line">        &quot;Arn&quot;: &quot;arn:aws:iam::409921503514:policy/AWSLoadBalancerControllerIAMPolicyXxg&quot;,</span><br><span class="line">        &quot;Path&quot;: &quot;/&quot;,</span><br><span class="line">        &quot;DefaultVersionId&quot;: &quot;v1&quot;,</span><br><span class="line">        &quot;AttachmentCount&quot;: 0,</span><br><span class="line">        &quot;PermissionsBoundaryUsageCount&quot;: 0,</span><br><span class="line">        &quot;IsAttachable&quot;: true,</span><br><span class="line">        &quot;CreateDate&quot;: &quot;2023-07-29T07:53:33+00:00&quot;,</span><br><span class="line">        &quot;UpdateDate&quot;: &quot;2023-07-29T07:53:33+00:00&quot;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/eks-strategy.1.png)</span><br><span class="line"></span><br><span class="line">&#x4E0B;&#x9762;2&#x3001;3&#x3001;4 &#x6B65;&#x9AA4;&#xFF0C;&#x90FD;&#x53C2;&#x8003;&#xFF1A;[&#x5B89;&#x88C5; AWS Load Balancer Controller &#x9644;&#x52A0;&#x7EC4;&#x4EF6;](https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/aws-load-balancer-controller.html)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### 2.&#x521B;&#x5EFA; OpenID Connect (OIDC) provider</span></span></span><br><span class="line"></span><br><span class="line">1.&#x5728; AWS &#x4E2D;&#x63A7;&#x53F0;&#x9009;&#x62E9;&#x201C;EKS&#x201D;&#xFF0C;&#x8FDB;&#x5165; EKS &#x754C;&#x9762;&#xFF0C;&#x5728; Clusters &#x4E2D;&#x9009;&#x62E9;&#x4E0A;&#x6B21;&#x521B;&#x5EFA;&#x7684;&#x201C;</span><br><span class="line">uat-mta-xxg&#x201D;&#xFF0C;&#x5728; Details &#x90E8;&#x5206;&#xFF0C;&#x590D;&#x5236;&#x201C;OpenID Connect provider URL&#x201D;&#x7684;&#x5185;&#x5BB9;&#x5907;&#x7528;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/openid.1.png)</span><br><span class="line"></span><br><span class="line">OpenID Connect &#x63D0;&#x4F9B;&#x5546; URL:</span><br><span class="line">`https://oidc.eks.ap-east-1.amazonaws.com/id/9AE0C77523D6402B3CEF7103A22C1F84`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.&#x5728; AWS &#x4E2D;&#x63A7;&#x53F0;&#x9009;&#x62E9;&#x201C;IAM&#x201D;&#xFF0C;&#x8FDB;&#x5165; IAM &#x754C;&#x9762;&#xFF0C;&#x5728;&#x5DE6;&#x8FB9;&#x9009;&#x62E9;&#x201C;Identity Providers&#x201D;&#xFF0C;&#x70B9;&#x51FB;&#x201C;Add Provider&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/openid.2.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.&#x5728;&#x201C;Provider URL&#x201D;&#x4E2D;&#xFF0C;&#x7C98;&#x8D34;&#x4E0A;&#x4E00;&#x6B65;&#x4E2D;&#x201C;OpenID Connect provider URL&#x201D;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x7136;&#x540E;&#x70B9;&#x51FB;&#x201C;Get thumbprint&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/openid.3.png)</span><br><span class="line"></span><br><span class="line">4.&#x5728;&#x201C;Audience&#x201D;&#x4E2D;&#x6DFB;&#x52A0;&#x201C;sts.amazonaws.com&#x201D;&#xFF0C;&#x7136;&#x540E;&#x70B9;&#x51FB;&#x201C;Add provider&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/openid.4.png)</span><br><span class="line"></span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/openid.5.png)</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### 3.&#x521B;&#x5EFA;IAM Role</span></span></span><br><span class="line">1.&#x5728; AWS &#x4E2D;&#x63A7;&#x53F0;&#x9009;&#x62E9;&#x201C;IAM&#x201D;&#xFF0C;&#x8FDB;&#x5165; IAM &#x754C;&#x9762;&#xFF0C;&#x5728;&#x5DE6;&#x8FB9;&#x9009;&#x62E9;&#x201C;Roles&#x201D;&#xFF0C;&#x70B9;&#x51FB;&#x201C;Create Role&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.1.png)</span><br><span class="line"></span><br><span class="line">2.&#x5728;&#x201C;Select type of trusted entity&#x201D;&#x90E8;&#x5206;&#x9009;&#x62E9;&#x201C;Web identity&#x201D;&#xFF0C;&#x5728;&#x201C;Identity provider&#x201D;&#x4E2D;&#x9009;&#x62E9; EKS &#x4E2D;&#x201C;OpenID Connect provider URL&#x201D;&#x4E00;&#x6837;&#x7684; Ip&#xFF0C;&#x5728;&#x201C;Audience&#x201D;&#x4E2D;&#x9009;&#x62E9;&#x201C;sts.amazonaws.com&#x201D;&#xFF0C;&#x70B9;&#x51FB;&#x201C;Next: Permissions&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.2.png)</span><br><span class="line"></span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.3.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.&#x641C;&#x7D22;&#x4E0A;&#x9762;&#x521B;&#x5EFA;&#x7684; Policy &#x201C;AWSLoadBalancerControllerIAMPolicyXxg&#x201D;&#xFF0C;&#x52FE;&#x9009;&#x540E;&#x70B9;&#x51FB;&#x201C;Next: Tags&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.4.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.`&#x6DFB;&#x52A0;&#x6807;&#x7B7E;`&#xFF0C;&#x8FD9;&#x91CC;&#x65E0;&#x9700;&#x6DFB;&#x52A0;&#x4EC0;&#x4E48;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x7528;&#x70B9;</span><br><span class="line"></span><br><span class="line">5.&#x6DFB;&#x52A0; Role &#x540D;&#x79F0; `AmazonEKSLoadBalancerControllerRoleXxg` &#xFF0C;&#x70B9;&#x51FB;&#x201C;Create Role&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.5.png)</span><br><span class="line"></span><br><span class="line">&#x5168;&#x89C8;&#x4E00;&#x4E0B;&#xFF1A;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.6.png)</span><br><span class="line"></span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.7.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6.Role &#x201C;AmazonEKSLoadBalancerControllerRoleXxg&#x201D;&#x521B;&#x5EFA;&#x597D;&#x540E;&#xFF0C;&#x70B9;&#x51FB;&#x8FDB;&#x5165;&#xFF0C;&#x9009;&#x62E9;&#x201C;Trust relationships&#x201D;&#xFF0C;&#x70B9;&#x51FB;&#x201C;Edit trust relationship&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.8.png)</span><br><span class="line"></span><br><span class="line">7.&#x7136;&#x540E;&#x627E;&#x5230;&#x4E0B;&#x9762;&#x5185;&#x5BB9;&#xFF0C;&#x5E76;&#x66FF;&#x6362;&#xFF1A;</span><br></pre></td></tr></table></figure><p>&#x539F;&#x59CB;&#x5185;&#x5BB9;&#xFF1A;oidc.eks.ap-east-1.amazonaws.com/id/9AE0C77523D6402B3CEF7103A22C1F84:aud&#x201D;: &#x201C;sts.amazonaws.com&#x201D;</p><p>&#x66FF;&#x6362;&#x6210;&#x4E3A;<br>oidc.eks.ap-east-1.amazonaws.com/id/9AE0C77523D6402B3CEF7103A22C1F84:sub&#x201D;: &#x201C;system:serviceaccount:kube-system:aws-load-balancer-controller&#x201D;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.9.png)</span><br><span class="line"></span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.10.png)</span><br><span class="line"></span><br><span class="line">&#x89D2;&#x8272;--AmazonEKSLoadBalancerControllerRoleXxg--&#x4FE1;&#x4EFB;&#x5173;&#x7CFB;&#x91CC;&#x7684; &#x53EF;&#x4FE1;&#x5B9E;&#x4F53; &#x5B8C;&#x6574;&#x5185;&#x5BB9;&#xFF1A;</span><br><span class="line">```json</span><br><span class="line">{</span><br><span class="line">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">    &quot;Statement&quot;: [</span><br><span class="line">        {</span><br><span class="line">            &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line">            &quot;Principal&quot;: {</span><br><span class="line">                &quot;Federated&quot;: &quot;arn:aws:iam::409921503514:oidc-provider/oidc.eks.ap-east-1.amazonaws.com/id/9AE0C77523D6402B3CEF7103A22C1F84&quot;</span><br><span class="line">            },</span><br><span class="line">            &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;,</span><br><span class="line">            &quot;Condition&quot;: {</span><br><span class="line">                &quot;StringEquals&quot;: {</span><br><span class="line">                    &quot;oidc.eks.ap-east-1.amazonaws.com/id/9AE0C77523D6402B3CEF7103A22C1F84:sub&quot;: &quot;system:serviceaccount:kube-system:aws-load-balancer-controller&quot;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h4 id="4-&#x521B;&#x5EFA;iamserviceaccount"><a href="#4-&#x521B;&#x5EFA;iamserviceaccount" class="headerlink" title="4.&#x521B;&#x5EFA;iamserviceaccount"></a>4.&#x521B;&#x5EFA;iamserviceaccount</h4><p>1.&#x65B9;&#x5F0F;1&#xFF1A;&#x58F0;&#x660E;yaml&#x5E76;apply</p><p>&#x521B;&#x5EFA;<code>aws-load-balancer-controller-service-account.yaml</code>,&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">eks.amazonaws.com/role-arn:</span> <span class="string">arn:aws:iam::409921503514:role/AmazonEKSLoadBalancerControllerRoleXxg</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-uat-aws-xxg</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg apply -f aws-load-balancer-controller-service-account.yaml</span></span><br><span class="line"></span><br><span class="line">serviceaccount/aws-load-balancer-controller created</span><br></pre></td></tr></table></figure><p>&#x67E5;&#x770B;&#x521B;&#x5EFA;&#x7684; Serivce account &#x8BE6;&#x60C5;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg describe serviceaccount/aws-load-balancer-controller -n kube-system</span></span><br><span class="line"></span><br><span class="line">Name:                aws-load-balancer-controller</span><br><span class="line">Namespace:           kube-system</span><br><span class="line">Labels:              app.kubernetes.io/component=controller</span><br><span class="line">                     app.kubernetes.io/name=aws-load-balancer-controller</span><br><span class="line">Annotations:         eks.amazonaws.com/role-arn: arn:aws:iam::409921503514:role/AmazonEKSLoadBalancerControllerRoleXxg</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>2.&#x65B9;&#x5F0F;2&#xFF1A;eksctl&#x547D;&#x4EE4;&#x521B;&#x5EFA;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">eksctl create iamserviceaccount \</span></span><br><span class="line"><span class="language-bash">    --cluster=uat-mta-xxg \</span></span><br><span class="line"><span class="language-bash">    --namespace=kube-system \</span></span><br><span class="line"><span class="language-bash">    --name=aws-load-balancer-controller \</span></span><br><span class="line"><span class="language-bash">    --role-name AmazonEKSLoadBalancerControllerRoleXxg \</span></span><br><span class="line"><span class="language-bash">    --attach-policy-arn=arn:aws:iam::409921503514:policy/AWSLoadBalancerControllerIAMPolicyXxg \</span></span><br><span class="line"><span class="language-bash">    --approve</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>3.&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7528;&#x4E0B;&#x5217;&#x547D;&#x4EE4;&#x67E5;&#x770B;&#x662F;&#x5426;&#x5B58;&#x5728;&#x8001;&#x7684; AWS ALB Ingress Controller<br>&#x6309;&#x5B98;&#x65B9;&#x6587;&#x6863;&#x8BF4;&#x6CD5;&#xFF0C;&#x5728;&#x90E8;&#x7F72; AWS Load Balancer Controller &#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x5148;&#x628A;&#x8001;&#x7684; AWS ALB Ingress Controller &#x5220;&#x9664;&#x3002;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg get deployment -n kube-system alb-ingress-controller</span></span><br><span class="line"></span><br><span class="line">Error from server (NotFound): deployments.apps &quot;alb-ingress-controller&quot; not found</span><br></pre></td></tr></table></figure><p>&#x4EE5;&#x4E0A;&#x7ED3;&#x679C;&#x663E;&#x793A;&#x4E0D;&#x5B58;&#x5728;<br>&#x8BF4;&#x660E;&#xFF1A;&#x5982;&#x679C;&#x771F;&#x6709;&#x8001;&#x7684; AWS ALB Ingress Controller&#xFF0C;&#x53C2;&#x8003; <code>10. &#x5378;&#x8F7D; alb ingress controller</code></p><h4 id="5-&#x90E8;&#x7F72;-cert-manager&#xFF0C;-&#x5C06;&#x8BC1;&#x4E66;&#x914D;&#x7F6E;&#x6CE8;&#x5165;&#x5230;-webhook-&#x4E2D;"><a href="#5-&#x90E8;&#x7F72;-cert-manager&#xFF0C;-&#x5C06;&#x8BC1;&#x4E66;&#x914D;&#x7F6E;&#x6CE8;&#x5165;&#x5230;-webhook-&#x4E2D;" class="headerlink" title="5.&#x90E8;&#x7F72; cert-manager&#xFF0C; &#x5C06;&#x8BC1;&#x4E66;&#x914D;&#x7F6E;&#x6CE8;&#x5165;&#x5230; webhook &#x4E2D;"></a>5.&#x90E8;&#x7F72; cert-manager&#xFF0C; &#x5C06;&#x8BC1;&#x4E66;&#x914D;&#x7F6E;&#x6CE8;&#x5165;&#x5230; webhook &#x4E2D;</h4><blockquote><p>&#x6CE8;&#x610F;&#xFF1A;cert-manager.yaml &#x6587;&#x4EF6;&#x7248;&#x672C;&#x662F;&#xFF1A;v1.5.4&#xFF0C;&#x800C;&#x4E0D;&#x662F;v1.1.1&#xFF0C;&#x5426;&#x5219;&#x540E;&#x9762;&#x5728;&#x6267;&#x884C;v2_4_7_full.yaml&#x65F6;&#xFF0C;&#x4F1A;&#x62A5;&#x9519;</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg \</span></span><br><span class="line"><span class="language-bash">    apply \</span></span><br><span class="line"><span class="language-bash">    --validate=<span class="literal">false</span> \</span></span><br><span class="line"><span class="language-bash">    -f https://github.com/jetstack/cert-manager/releases/download/v1.5.4/cert-manager.yaml</span></span><br><span class="line"></span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/certificaterequests.cert-manager.io configured</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/certificates.cert-manager.io configured</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/challenges.acme.cert-manager.io configured</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterissuers.cert-manager.io configured</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/issuers.cert-manager.io configured</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/orders.acme.cert-manager.io configured</span><br><span class="line">namespace/cert-manager unchanged</span><br><span class="line">serviceaccount/cert-manager-cainjector configured</span><br><span class="line">serviceaccount/cert-manager configured</span><br><span class="line">serviceaccount/cert-manager-webhook configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-cainjector configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-issuers configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-clusterissuers configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-certificates configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-orders configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-challenges configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-ingress-shim configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-view configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-edit configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-approve:cert-manager-io created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-certificatesigningrequests created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-webhook:subjectaccessreviews created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-cainjector configured</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-issuers configured</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-clusterissuers configured</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-certificates configured</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-orders configured</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-challenges configured</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-ingress-shim configured</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-approve:cert-manager-io created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-certificatesigningrequests created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-webhook:subjectaccessreviews created</span><br><span class="line">role.rbac.authorization.k8s.io/cert-manager-cainjector:leaderelection configured</span><br><span class="line">role.rbac.authorization.k8s.io/cert-manager:leaderelection configured</span><br><span class="line">role.rbac.authorization.k8s.io/cert-manager-webhook:dynamic-serving configured</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/cert-manager-cainjector:leaderelection configured</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/cert-manager:leaderelection configured</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/cert-manager-webhook:dynamic-serving configured</span><br><span class="line">service/cert-manager configured</span><br><span class="line">service/cert-manager-webhook configured</span><br><span class="line">deployment.apps/cert-manager-cainjector configured</span><br><span class="line">deployment.apps/cert-manager configured</span><br><span class="line">deployment.apps/cert-manager-webhook configured</span><br><span class="line">mutatingwebhookconfiguration.admissionregistration.k8s.io/cert-manager-webhook configured</span><br><span class="line">validatingwebhookconfiguration.admissionregistration.k8s.io/cert-manager-webhook configured</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&#x6216;&#x8005;&#xFF0C;&#x4E0B;&#x8F7D;&#x4E0B;&#x6765;&#xFF0C;&#x518D;apply</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://github.com/jetstack/cert-manager/releases/download/v1.5.4/cert-manager.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg apply -f cert-manager.yaml</span></span><br></pre></td></tr></table></figure><h4 id="6-&#x5B89;&#x88C5;-aws-load-balancer-controller&#xFF1A;"><a href="#6-&#x5B89;&#x88C5;-aws-load-balancer-controller&#xFF1A;" class="headerlink" title="6.&#x5B89;&#x88C5; aws-load-balancer-controller&#xFF1A;"></a>6.&#x5B89;&#x88C5; aws-load-balancer-controller&#xFF1A;</h4><p>&#x8FD9;&#x91CC;&#x8981;&#x53C2;&#x8003;&#xFF1A;<a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/aws-load-balancer-controller.html">&#x5B89;&#x88C5; AWS Load Balancer Controller &#x9644;&#x52A0;&#x7EC4;&#x4EF6;</a></p><p>1.&#x4E0B;&#x8F7D;v2.4.7/v2_4_7_full.yaml</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-uat-aws-xxg</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl -Lo v2_4_7_full.yaml https://github.com/kubernetes-sigs/aws-load-balancer-controller/releases/download/v2.4.7/v2_4_7_full.yaml</span></span><br></pre></td></tr></table></figure><p>2.&#x5982;&#x679C;&#x60A8;&#x5DF2;&#x4E0B;&#x8F7D; <code>v2_4_7_full.yaml</code> &#x6587;&#x4EF6;&#xFF0C;&#x8BF7;&#x8FD0;&#x884C;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x4EE5;&#x5220;&#x9664;&#x6E05;&#x5355;&#x4E2D;&#x7684; ServiceAccount &#x90E8;&#x5206;&#xFF08;&#x7B2C;561~569&#x884C;&#xFF09;&#x3002;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i.bak -e &apos;561,569d&apos; ./v2_4_7_full.yaml</span><br></pre></td></tr></table></figure><p>&#x5982;&#x679C;&#x60A8;&#x5DF2;&#x4E0B;&#x8F7D;&#x5176;&#x4ED6;&#x6587;&#x4EF6;&#x7248;&#x672C;&#xFF0C;&#x8BF7;&#x5728;&#x7F16;&#x8F91;&#x5668;&#x4E2D;&#x6253;&#x5F00;&#x6B64;&#x6587;&#x4EF6;&#xFF0C;&#x7136;&#x540E;&#x5220;&#x9664;&#x4EE5;&#x4E0B;&#x884C;&#x3002;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><p>3.&#x8BF7;&#x5C06; <code>my-cluster</code> &#x66FF;&#x6362;&#x4E3A;&#x60A8;&#x7684;&#x96C6;&#x7FA4;&#x540D;&#x79F0;&#xFF0C;&#x5C06;&#x6587;&#x4EF6;&#x7684; Deployment spec &#x90E8;&#x5206;&#x4E2D;&#x7684; your-cluster-name &#x66FF;&#x6362;&#x4E3A;&#x60A8;&#x7684;&#x96C6;&#x7FA4;&#x540D;&#x79F0;&#x3002;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i.bak -e &apos;s|your-cluster-name|uat-hk|&apos; ./v2_4_7_full.yaml</span><br><span class="line"></span><br><span class="line">sed -i.bak -e &apos;s|your-cluster-name|uat-mta-xxg|&apos; ./v2_4_7_full.yaml</span><br></pre></td></tr></table></figure><p>4.&#x5E94;&#x7528;&#x5E76;&#x751F;&#x6548;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg apply -f v2_4_7_full.yaml</span></span><br><span class="line"></span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ingressclassparams.elbv2.k8s.aws unchanged</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/targetgroupbindings.elbv2.k8s.aws unchanged</span><br><span class="line">role.rbac.authorization.k8s.io/aws-load-balancer-controller-leader-election-role unchanged</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/aws-load-balancer-controller-role configured</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/aws-load-balancer-controller-leader-election-rolebinding unchanged</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/aws-load-balancer-controller-rolebinding unchanged</span><br><span class="line">service/aws-load-balancer-webhook-service unchanged</span><br><span class="line">deployment.apps/aws-load-balancer-controller created</span><br><span class="line">certificate.cert-manager.io/aws-load-balancer-serving-cert created</span><br><span class="line">issuer.cert-manager.io/aws-load-balancer-selfsigned-issuer created</span><br><span class="line">mutatingwebhookconfiguration.admissionregistration.k8s.io/aws-load-balancer-webhook configured</span><br><span class="line">validatingwebhookconfiguration.admissionregistration.k8s.io/aws-load-balancer-webhook configured</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="7-&#x5B89;&#x88C5;ingressClass"><a href="#7-&#x5B89;&#x88C5;ingressClass" class="headerlink" title="7.&#x5B89;&#x88C5;ingressClass"></a>7.&#x5B89;&#x88C5;ingressClass</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl -Lo v2_4_7_ingclass.yaml https://github.com/kubernetes-sigs/aws-load-balancer-controller/releases/download/v2.4.7/v2_4_7_ingclass.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg apply -f v2_4_7_ingclass.yaml</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&#x6216;&#x8005;&#xFF0C;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#x81EA;&#x5DF1;&#x5B9A;&#x4E49;&#x7684;&#x7B80;&#x5316;&#x7248;&#x7684;ingressClass&#xFF0C;&#x4E0D;&#x5EFA;&#x8BAE;:<br><code>ingress-class-alb.yaml</code> &#x5185;&#x5BB9;&#xFF1A;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">controller:</span> <span class="string">ingress.k8s.aws/alb</span></span><br></pre></td></tr></table></figure><h4 id="8-&#x9A8C;&#x8BC1;&#x63A7;&#x5236;&#x5668;&#x662F;&#x5426;&#x5DF2;&#x5B89;&#x88C5;"><a href="#8-&#x9A8C;&#x8BC1;&#x63A7;&#x5236;&#x5668;&#x662F;&#x5426;&#x5DF2;&#x5B89;&#x88C5;" class="headerlink" title="8.&#x9A8C;&#x8BC1;&#x63A7;&#x5236;&#x5668;&#x662F;&#x5426;&#x5DF2;&#x5B89;&#x88C5;"></a>8.&#x9A8C;&#x8BC1;&#x63A7;&#x5236;&#x5668;&#x662F;&#x5426;&#x5DF2;&#x5B89;&#x88C5;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n kube-system get deployment/aws-load-balancer-controller</span></span><br><span class="line"></span><br><span class="line">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">aws-load-balancer-controller   0/1     0            0           12m</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/alb.2.png"></p><h4 id="8-1-EKS-&#x8282;&#x70B9;&#x6240;&#x5728;&#x7684;3&#x4E2A;&#x5B50;&#x7F51;&#xFF0C;&#x5206;&#x522B;&#x6253;&#x6807;&#x7B7E;"><a href="#8-1-EKS-&#x8282;&#x70B9;&#x6240;&#x5728;&#x7684;3&#x4E2A;&#x5B50;&#x7F51;&#xFF0C;&#x5206;&#x522B;&#x6253;&#x6807;&#x7B7E;" class="headerlink" title="8.1 EKS &#x8282;&#x70B9;&#x6240;&#x5728;&#x7684;3&#x4E2A;&#x5B50;&#x7F51;&#xFF0C;&#x5206;&#x522B;&#x6253;&#x6807;&#x7B7E;"></a>8.1 EKS &#x8282;&#x70B9;&#x6240;&#x5728;&#x7684;3&#x4E2A;&#x5B50;&#x7F51;&#xFF0C;&#x5206;&#x522B;&#x6253;&#x6807;&#x7B7E;</h4><p>EKS &#x8282;&#x70B9;&#x6240;&#x5728;&#x7684;3&#x4E2A;&#x5B50;&#x7F51;&#xFF0C;&#x90FD;&#x8981;&#x5206;&#x522B;&#x8FDB;&#x5165;&#x6807;&#x7B7E;&#xFF0C;&#x6DFB;&#x52A0;&#x6807;&#x7B7E;&#xFF1A;&#x952E;<code>kubernetes.io/role/elb</code> &#x503C;<code>1</code>&#xFF0C;&#x5426;&#x5219;ingress&#x4F1A;&#x521B;&#x5EFA;&#x5931;&#x8D25;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ingress&#x91CC;&#x7684;&#x62A5;&#x9519;&#xFF1A;</span><br><span class="line">Failed build model due to couldn&apos;t auto-discover subnets: unable to discover at least one subnet</span><br><span class="line"></span><br><span class="line">failed load groupID due to invalid ingress class: IngressClass.networking.k8s.io &quot;alb&quot; not found</span><br></pre></td></tr></table></figure><h4 id="9-&#x5B89;&#x88C5;ingress&#x5E76;&#x751F;&#x6548;"><a href="#9-&#x5B89;&#x88C5;ingress&#x5E76;&#x751F;&#x6548;" class="headerlink" title="9.&#x5B89;&#x88C5;ingress&#x5E76;&#x751F;&#x6548;"></a>9.&#x5B89;&#x88C5;ingress&#x5E76;&#x751F;&#x6548;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg apply -f ingress-uat.yaml</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ingress-uat.yaml &#x5185;&#x5BB9;:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mta-swappie-backend-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># Ingress Core Settings</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/scheme:</span> <span class="string">&apos;internet-facing&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/target-type:</span> <span class="string">&apos;ip&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/load-balancer-attributes:</span> <span class="string">idle_timeout.timeout_seconds=400</span></span><br><span class="line">    <span class="comment"># Health Check Settings</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/healthcheck-protocol:</span> <span class="string">&apos;HTTP&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/healthcheck-path:</span> <span class="string">&apos;/mta-swappie-service/health/check&apos;</span></span><br><span class="line">    <span class="comment">## SSL Settings</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/listen-ports:</span> <span class="string">&apos;[{&quot;HTTP&quot;: 80}, {&quot;HTTPS&quot;: 443}]&apos;</span></span><br><span class="line">    <span class="comment"># alb.ingress.kubernetes.io/certificate-arn: &apos;arn:aws:acm:eu-central-1:409921503514:certificate/7f065637-1580-47e0-8d1e-0f4340ab83d4&apos;</span></span><br><span class="line">    <span class="comment"># redirect all HTTP to HTTPS</span></span><br><span class="line">    <span class="comment"># alb.ingress.kubernetes.io/actions.ssl-redirect: &apos;{&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;: { &quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;}}&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&apos;443&apos;</span>    </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">alb</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span>  <span class="string">mta-api.xiexugang.top</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/mta-swappie-service</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><p>ingress &#x7684;&#x51E0;&#x4E2A;&#x6CE8;&#x89E3;&#x914D;&#x7F6E;&#xFF0C;&#x53C2;&#x8003;&#x81EA;&#xFF1A;<a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/ingress/annotations/"></a></p><ul><li><p>ingress &#x8D85;&#x65F6;&#x914D;&#x7F6E;&#x6CE8;&#x89E3;&#xFF1A;<br><code>alb.ingress.kubernetes.io/load-balancer-attributes: idle_timeout.timeout_seconds=400</code></p></li><li><p>http&#x91CD;&#x5B9A;&#x5411;&#x5230;https<br><code>alb.ingress.kubernetes.io/ssl-redirect: &apos;443&apos;</code></p></li></ul><h4 id="10-&#x6267;&#x884C;gitlab&#x4E2D;&#x7684;pipeline"><a href="#10-&#x6267;&#x884C;gitlab&#x4E2D;&#x7684;pipeline" class="headerlink" title="10.&#x6267;&#x884C;gitlab&#x4E2D;&#x7684;pipeline"></a>10.&#x6267;&#x884C;gitlab&#x4E2D;&#x7684;pipeline</h4><p>gitlab&#x4E2D;&#x7684;pipeline&#xFF0C;&#x4ECE;&#x800C;&#x80FD;&#x521B;&#x5EFA; deployment</p><h4 id="11-&#x5230;-EC2-gt-Load-balancers-&#x91CC;&#x770B;&#x770B;&#xFF0C;&#x4F1A;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x751F;&#x6210;-ALB-Ingress-Controller"><a href="#11-&#x5230;-EC2-gt-Load-balancers-&#x91CC;&#x770B;&#x770B;&#xFF0C;&#x4F1A;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x751F;&#x6210;-ALB-Ingress-Controller" class="headerlink" title="11.&#x5230; EC2 --&gt; Load balancers &#x91CC;&#x770B;&#x770B;&#xFF0C;&#x4F1A;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x751F;&#x6210; ALB Ingress Controller:"></a>11.&#x5230; <code>EC2 --&gt; Load balancers</code> &#x91CC;&#x770B;&#x770B;&#xFF0C;&#x4F1A;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x751F;&#x6210; ALB Ingress Controller:</h4><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/alb.3.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/alb.4.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/alb.5.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/alb.6.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/alb.7.png"></p><blockquote><p>&#x8FD9;&#x91CC;&#x6709;&#x4E2A;&#x5751;:<br>&#x5230;&#x5173;&#x8054;&#x7684;<code>Target Group</code>&#x4E2D;&#xFF0C;&#x770B;&#x4E0B; <code>Registered targets</code>&#xFF0C;Zone&#x662F; <code>ap-east-1c</code> &#x7684;&#xFF0C;&#x7136;&#x800C;ALB&#x4E2D;&#x7684;&#x53EF;&#x7528;&#x533A;&#x53EA;&#x6709; <code>ap-east-1a</code> &#x548C; <code>ap-east-1b</code> &#xFF0C;&#x6CA1;&#x6709; <code>ap-east-1c</code></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.1.png"></p><p>&#x5230;ALB&#x4E2D;&#xFF0C;&#x624B;&#x52A8;&#x6DFB;&#x52A0;&#x4E0B;&#xFF0C;&#x5426;&#x5219;&#x548C;&#x8FD9;&#x4E2A;LB&#x5173;&#x8054;&#x7684;Target Group&#x4E0B;&#x7684; Health checks &#x4F1A;&#x5931;&#x8D25;</p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.2.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.3.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.4.png"></p><p>&#x6DFB;&#x52A0;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x518D;&#x5230;&#x5173;&#x8054;&#x7684;Target Group&#x4E2D;&#xFF0C;&#x4FEE;&#x6539;&#x4E0B; Health Checks&#x7684;Path<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.6.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.7.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.8.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.9.png"></p><h4 id="12-&#x914D;&#x7F6E;&#x4E8C;&#x7EA7;&#x57DF;&#x540D;CNAME&#x5230;ALB&#x7684;&#x57DF;&#x540D;"><a href="#12-&#x914D;&#x7F6E;&#x4E8C;&#x7EA7;&#x57DF;&#x540D;CNAME&#x5230;ALB&#x7684;&#x57DF;&#x540D;" class="headerlink" title="12.&#x914D;&#x7F6E;&#x4E8C;&#x7EA7;&#x57DF;&#x540D;CNAME&#x5230;ALB&#x7684;&#x57DF;&#x540D;"></a>12.&#x914D;&#x7F6E;&#x4E8C;&#x7EA7;&#x57DF;&#x540D;CNAME&#x5230;ALB&#x7684;&#x57DF;&#x540D;</h4><p>&#x4E8C;&#x7EA7;&#x57DF;&#x540D;&#xFF1A;<code>mta-api.xiexugang.top</code><br>ALB&#x7684;&#x57DF;&#x540D;: <code>k8s-javaserv-mtaswapp-591beea7f0-1776529407.ap-east-1.elb.amazonaws.com</code></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/alb.domain.bind.1.png"></p><h4 id="13-&#x63A5;&#x53E3;&#x8C03;&#x7528;&#x9A8C;&#x8BC1;"><a href="#13-&#x63A5;&#x53E3;&#x8C03;&#x7528;&#x9A8C;&#x8BC1;" class="headerlink" title="13.&#x63A5;&#x53E3;&#x8C03;&#x7528;&#x9A8C;&#x8BC1;"></a>13.&#x63A5;&#x53E3;&#x8C03;&#x7528;&#x9A8C;&#x8BC1;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ping mta-api.xiexugang.top</span><br><span class="line"></span><br><span class="line">Pinging k8s-javaserv-mtaswapp-591beea7f0-1776529407.ap-east-1.elb.amazonaws.com [18.166.5.81] with 32 bytes of data:</span><br><span class="line">Reply from 18.166.5.81: bytes=32 time=38ms TTL=239</span><br><span class="line">Reply from 18.166.5.81: bytes=32 time=36ms TTL=239</span><br><span class="line">Reply from 18.166.5.81: bytes=32 time=35ms TTL=239</span><br><span class="line">Reply from 18.166.5.81: bytes=32 time=35ms TTL=239</span><br><span class="line"></span><br><span class="line">Ping statistics for 18.166.5.81:</span><br><span class="line">    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),</span><br><span class="line">Approximate round trip times in milli-seconds:</span><br><span class="line">    Minimum = 35ms, Maximum = 38ms, Average = 36ms</span><br></pre></td></tr></table></figure><p>&#x6D4F;&#x89C8;&#x5668;&#x91CC;&#x8F93;&#x5165;&#xFF1A;<code>https://mta-api.xiexugang.top/mta-swappie-service/health/check</code></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/api-test.png"></p><h4 id="14-&#x5B89;&#x88C5;cloudwatch-logs&#x4EE3;&#x7406;"><a href="#14-&#x5B89;&#x88C5;cloudwatch-logs&#x4EE3;&#x7406;" class="headerlink" title="14.&#x5B89;&#x88C5;cloudwatch logs&#x4EE3;&#x7406;"></a>14.&#x5B89;&#x88C5;cloudwatch logs&#x4EE3;&#x7406;</h4><ul><li><a href="https://www.jianshu.com/p/236ead86096f">AWS &#x4F7F;&#x7528; CloudWatch Logs &#x6536;&#x96C6;&#x65E5;&#x5FD7;</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/AmazonCloudWatch/latest/logs/QuickStartEC2Instance.html">&#x5FEB;&#x901F;&#x5165;&#x95E8;&#xFF1A;&#x5728;&#x8FD0;&#x884C;&#x7684; EC2 Linux &#x5B9E;&#x4F8B;&#x4E0A;&#x5B89;&#x88C5;&#x548C;&#x914D;&#x7F6E; CloudWatch Logs &#x4EE3;&#x7406;</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/AmazonCloudWatch/latest/logs/AgentReference.html">CloudWatch Logs &#x4EE3;&#x7406;&#x53C2;&#x8003;</a></li></ul><h5 id="1-&#x524D;&#x63D0;&#xFF1A;"><a href="#1-&#x524D;&#x63D0;&#xFF1A;" class="headerlink" title="1.&#x524D;&#x63D0;&#xFF1A;"></a>1.&#x524D;&#x63D0;&#xFF1A;</h5><p>&#x76EE;&#x524D;k8s&#x96C6;&#x7FA4;&#x4E2D;&#x6709;2&#x4E2A;&#x8282;&#x70B9;&#xFF1A;<code>i-04ccf53f8f5138168</code> &#x548C; <code>i-0f332710992b9de95</code>&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x8282;&#x70B9;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x7684;&#x516C;&#x94A5;&#x6587;&#x4EF6;&#x90FD;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#xFF1A;<code>eks-node-rsa-pair.pem</code></p><p>i-04ccf53f8f5138168 &#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x547D;&#x4EE4;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i &quot;eks-node-rsa-pair.pem&quot; ec2-user@ec2-35-158-45-195.eu-central-1.compute.amazonaws.com</span><br></pre></td></tr></table></figure><p>i-0f332710992b9de95 &#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x547D;&#x4EE4;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i &quot;eks-node-rsa-pair.pem&quot; ec2-user@ec2-3-122-95-149.eu-central-1.compute.amazonaws.com</span><br></pre></td></tr></table></figure><h5 id="1-&#x5206;&#x522B;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x4E0A;&#x9762;2&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x6267;&#x884C;&#x5982;&#x4E0B;&#x547D;&#x4EE4;"><a href="#1-&#x5206;&#x522B;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x4E0A;&#x9762;2&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x6267;&#x884C;&#x5982;&#x4E0B;&#x547D;&#x4EE4;" class="headerlink" title="1.&#x5206;&#x522B;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x4E0A;&#x9762;2&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x6267;&#x884C;&#x5982;&#x4E0B;&#x547D;&#x4EE4;"></a>1.&#x5206;&#x522B;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x4E0A;&#x9762;2&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x6267;&#x884C;&#x5982;&#x4E0B;&#x547D;&#x4EE4;</h5><h5 id="2-&#x4EE5;&#x8FDC;&#x7A0B;&#x767B;&#x5F55;&#xFF1A;i-04ccf53f8f5138168-&#x4E3A;&#x4F8B;&#xFF1A;"><a href="#2-&#x4EE5;&#x8FDC;&#x7A0B;&#x767B;&#x5F55;&#xFF1A;i-04ccf53f8f5138168-&#x4E3A;&#x4F8B;&#xFF1A;" class="headerlink" title="2.&#x4EE5;&#x8FDC;&#x7A0B;&#x767B;&#x5F55;&#xFF1A;i-04ccf53f8f5138168  &#x4E3A;&#x4F8B;&#xFF1A;"></a>2.&#x4EE5;&#x8FDC;&#x7A0B;&#x767B;&#x5F55;&#xFF1A;i-04ccf53f8f5138168  &#x4E3A;&#x4F8B;&#xFF1A;</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo -i</span><br><span class="line">yum update -y</span><br></pre></td></tr></table></figure><p>&#x7F16;&#x8F91;&#xFF1A; <code>/etc/awslogs/awslogs.conf</code><br>&#x53BB;&#x9664;&#x6700;&#x540E;&#x90E8;&#x5206;&#x7684; [/var/logs/??]&#x90E8;&#x5206;&#xFF0C;&#x52A0;&#x4E0A;&#x5982;&#x4E0B;:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[logstream/request]</span><br><span class="line">datetime_format = %b %d %H:%M:%S</span><br><span class="line">file = /var/log/ahs-pods/mount/containers/mta-swappie-service/request/info.log</span><br><span class="line">buffer_duration = 5000</span><br><span class="line">log_stream_name = mta_swappie_service_prod_request_{instance_id}</span><br><span class="line">initial_position = start_of_file</span><br><span class="line">log_group_name = mta-swappie-service-request-log</span><br><span class="line">multi_line_start_pattern = {datetime_format}</span><br><span class="line">time_zone = UTC</span><br><span class="line">encoding = utf_8</span><br><span class="line"></span><br><span class="line">[logstream/info]</span><br><span class="line">datetime_format = %b %d %H:%M:%S</span><br><span class="line">file = /var/log/ahs-pods/mount/containers/mta-swappie-service/info/info.log</span><br><span class="line">buffer_duration = 5000</span><br><span class="line">log_stream_name = mta_swappie_service_prod_info_{instance_id}</span><br><span class="line">initial_position = start_of_file</span><br><span class="line">log_group_name = mta-swappie-service-info-log</span><br><span class="line">time_zone = UTC</span><br><span class="line">encoding = utf_8</span><br><span class="line"></span><br><span class="line">[logstream/warn]</span><br><span class="line">datetime_format = %b %d %H:%M:%S</span><br><span class="line">file = /var/log/ahs-pods/mount/containers/mta-swappie-service/warn/info.log</span><br><span class="line">buffer_duration = 5000</span><br><span class="line">log_stream_name = mta_swappie_service_prod_warn_{instance_id}</span><br><span class="line">initial_position = start_of_file</span><br><span class="line">log_group_name = mta-swappie-service-warn-log</span><br><span class="line">time_zone = UTC</span><br><span class="line">encoding = utf_8</span><br><span class="line"></span><br><span class="line">[logstream/error]</span><br><span class="line">datetime_format = %b %d %H:%M:%S</span><br><span class="line">file = /var/log/ahs-pods/mount/containers/mta-swappie-service/error/error.log</span><br><span class="line">buffer_duration = 5000</span><br><span class="line">log_stream_name = mta_swappie_service_prod_error_{instance_id}</span><br><span class="line">initial_position = start_of_file</span><br><span class="line">log_group_name = mta-swappie-service-error-log</span><br><span class="line">time_zone = UTC</span><br><span class="line">encoding = utf_8</span><br></pre></td></tr></table></figure><p>:wq &#x4FDD;&#x5B58;</p><p>&#x7F16;&#x8F91;&#xFF1A; <code>/etc/awslogs/awscli.conf</code><br><code>region = us-east-1</code> &#x6539;&#x6210;&#xFF1A; <code>region = eu-central-1</code></p><p>:wq &#x4FDD;&#x5B58;</p><p>&#x8BBE;&#x7F6E;&#x6210;&#x5F00;&#x673A;&#x542F;&#x542F;&#x52A8;&#xFF1A;<br><code>systemctl enable awslogsd.service</code></p><p>&#x542F;&#x52A8;&#xFF1A;<br><code>systemctl start awslogsd</code></p><p>&#x67E5;&#x770B;&#xFF1A;<br><code>systemctl status awslogsd</code></p><p>&#x5B9E;&#x65F6;&#x5237;&#x5C4F;&#x67E5;&#x770B;:<br><code>tail -fn 800 /var/log/awslogs.log</code></p><h5 id="3-&#x8282;&#x70B9;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;&#x3001;&#x5BB9;&#x5668;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;-&#x7684;&#x6302;&#x8F7D;&#x6620;&#x5C04;&#x5173;&#x7CFB;"><a href="#3-&#x8282;&#x70B9;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;&#x3001;&#x5BB9;&#x5668;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;-&#x7684;&#x6302;&#x8F7D;&#x6620;&#x5C04;&#x5173;&#x7CFB;" class="headerlink" title="3.&#x8282;&#x70B9;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;&#x3001;&#x5BB9;&#x5668;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84; &#x7684;&#x6302;&#x8F7D;&#x6620;&#x5C04;&#x5173;&#x7CFB;"></a>3.&#x8282;&#x70B9;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;&#x3001;&#x5BB9;&#x5668;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84; &#x7684;&#x6302;&#x8F7D;&#x6620;&#x5C04;&#x5173;&#x7CFB;</h5><p>k8s&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x8FD0;&#x884C;&#x5728;&#x8282;&#x70B9;&#x6C60;&#x91CC;&#x7684;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x4E0A;&#x7684;&#xFF0C;&#x6BCF;&#x4E2A;&#x7269;&#x7406;/&#x4E91;&#x8282;&#x70B9;&#x4E0A;&#xFF0C;&#x6709;&#x4E00;&#x4E2A;&#x8DEF;&#x5F84;&#xFF1A;<br><code>/var/log/ahs-pods/mount</code>(mta-swappie-service.yaml&#x4E2D;&#x6709;&#x5B9A;&#x4E49;)&#xFF0C;&#x8FD9;&#x4E2A;&#x8DEF;&#x5F84;&#x4E0B;&#x6302;&#x8F7D;&#x4E86;&#x5BB9;&#x5668;&#x91CC;&#x7684;&#x5E94;&#x7528;&#x670D;&#x52A1;&#x65E5;&#x5FD7;&#x6587;&#x4EF6;&#xFF1A;<code>/var/log/containers/mta-swappie-service</code>(&#x5DE5;&#x7A0B;:mta-swappie-package&#x4E0B;&#x7684;logback-spring.xml&#x91CC;&#x6709;&#x5199;&#x8BE5;&#x8DEF;&#x5F84;)</p><table><thead><tr><th>deployment.yaml&#x4E2D;&#x5B9A;&#x4E49;&#x7684;business&#x8DEF;&#x5F84;</th><th>&#x6620;&#x5C04;</th><th>&#x5E94;&#x7528;&#x4E2D;&#x7684;logback.xml&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;</th></tr></thead><tbody><tr><td>/var/log/ahs-pods/mount</td><td>&#x2192;&#x2192;</td><td>/var/log/containers</td></tr></tbody></table><p>&#x5BBF;&#x4E3B;&#x673A;&#x91CC;&#x7684;<code>/var/log/containers/ahs-pods/mount</code> &#x7B49;&#x540C;&#x4E8E;&#x5BB9;&#x5668;&#x91CC;&#x7684;<code>/var/log/containers</code>&#xFF0C;<br>&#x8FD9;&#x79CD;&#x6302;&#x8F7D;&#x6620;&#x5C04;&#xFF0C;&#x5728;deployment&#x4E2D;&#x7684;&#x5B9A;&#x4E49;&#x5173;&#x7CFB;&#xFF0C;&#x5982;&#x4E0B;&#x5173;&#x952E;&#x90E8;&#x5206;&#xFF1A;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">          <span class="string">...</span></span><br><span class="line">          <span class="string">...</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/log/containers</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/log/containers/ahs-pods/mount</span></span><br></pre></td></tr></table></figure><h4 id="15-&#x5378;&#x8F7D;-alb-ingress-controller"><a href="#15-&#x5378;&#x8F7D;-alb-ingress-controller" class="headerlink" title="15. &#x5378;&#x8F7D; alb ingress controller"></a>15. &#x5378;&#x8F7D; alb ingress controller</h4><blockquote><p>&#x5982;&#x679C;&#x4E0A;&#x9762;&#x6700;&#x540E;&#x521B;&#x5EFA;ingress&#x7684;&#x65F6;&#x5019;&#x62A5;&#x9519;&#xFF0C;&#x53EF;&#x4EE5;&#x6309;&#x4E0B;&#x9762;&#x6B65;&#x9AA4;&#x5220;&#x9664;&#x5404;&#x4E2A;&#x7EC4;&#x4EF6;&#xFF0C;&#x7136;&#x540E;&#x91CD;&#x65B0;&#x8D70;&#x4E0A;&#x9762;&#x7684;&#x521B;&#x5EFA;&#x6D41;&#x7A0B;&#xFF0C;&#x5220;&#x9664;&#x987A;&#x5E8F;: ingress &#x2013;&gt; ingressClass &#x2013;&gt; deployment</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//&#x5220;&#x9664; Ingress</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get ingress</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service delete ingress/mta-swappie-backend-ingress</span><br><span class="line"></span><br><span class="line">//&#x5220;&#x9664; IngressClassParams</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg get IngressClassParams</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg delete IngressClassParams/alb</span><br><span class="line"></span><br><span class="line">//&#x5220;&#x9664; IngressClass</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg get ingressClass</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg delete ingressClass/alb</span><br><span class="line"></span><br><span class="line">//&#x5220;&#x9664; deployment/aws-load-balancer-controller</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n kube-system get deployment/aws-load-balancer-controller</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n kube-system delete deployment/aws-load-balancer-controller</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="16-&#x5176;&#x4ED6;"><a href="#16-&#x5176;&#x4ED6;" class="headerlink" title="16.&#x5176;&#x4ED6;"></a>16.&#x5176;&#x4ED6;</h4><p>1.&#x8FDB;&#x5165;&#x5BB9;&#x5668;&#x5185;&#x90E8;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <code>-- /bin/bash</code> &#x6216; <code>-- sh</code>&#xFF0C;&#x611F;&#x89C9;&#x7528;<code>-- /bin/bash</code> &#x66F4;&#x597D;&#xFF0C;&#x56E0;&#x4E3A;&#x5728;&#x5BB9;&#x5668;&#x5185;&#x90E8;&#x6709;&#x8DEF;&#x5F84;&#x63D0;&#x793A;&#xFF0C;&#x548C;&#x81EA;&#x52A8;&#x8865;&#x5168;&#xFF0C;&#x7136;&#x800C;sh &#x90FD;&#x6CA1;&#x6709;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service exec -it mta-swappie-service-7d58f94788-kgqhw -- sh</span><br><span class="line">#</span><br></pre></td></tr></table></figure><p>&#x548C;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service exec -it mta-swappie-service-7d58f94788-kgqhw -- /bin/bash</span><br><span class="line">root@mta-swappie-service-7d58f94788-kgqhw:/usr/src/myapp#</span><br></pre></td></tr></table></figure><h2 id="&#x9006;&#x5411;&#x6D41;&#x7A0B;"><a href="#&#x9006;&#x5411;&#x6D41;&#x7A0B;" class="headerlink" title="&#x9006;&#x5411;&#x6D41;&#x7A0B;"></a>&#x9006;&#x5411;&#x6D41;&#x7A0B;</h2><h3 id="1-&#x5220;&#x9664;EKS&#x96C6;&#x7FA4;&#xFF1A;"><a href="#1-&#x5220;&#x9664;EKS&#x96C6;&#x7FA4;&#xFF1A;" class="headerlink" title="1.&#x5220;&#x9664;EKS&#x96C6;&#x7FA4;&#xFF1A;"></a>1.&#x5220;&#x9664;EKS&#x96C6;&#x7FA4;&#xFF1A;</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg get namespace</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg get nodes</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get service</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get ingressClass</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get ingress</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get deployment</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get events</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service describe deployment/mta-swappie-service</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg get svc --all-namespaces</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get deployment</span><br><span class="line">&#x5220;&#x9664;deployment/mta-swappie-service:</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service delete deployment/mta-swappie-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n kube-system delete deployment/aws-load-balancer-controller</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n cert-manager delete deployment/cert-manager</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n cert-manager delete deployment/cert-manager-cainjector</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n cert-manager delete deployment/cert-manager-webhook</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get service</span><br><span class="line">&#x5220;&#x9664;service/mta-sawppie-service:</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service delete service/mta-swappie-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n kube-system delete service/aws-load-balancer-webhook-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n cert-manager delete service/cert-manager</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n cert-manager delete service/cert-manager-webhook</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get ingressClass</span><br><span class="line">&#x5220;&#x9664; ingressClass/alb</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service delete ingressClass/alb</span></span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get ingress</span><br><span class="line">&#x5220;&#x9664;ingress/mta-xx-backend-ingress</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service delete ingress/mta-xx-backend-ingress</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">eksctl delete cluster --name uat-mta-xxg</span></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="&#x51E0;&#x4E2A;&#x7EC4;&#x4EF6;&#x5BF9;&#x5E94;&#x7684;yaml&#x7533;&#x660E;"><a href="#&#x51E0;&#x4E2A;&#x7EC4;&#x4EF6;&#x5BF9;&#x5E94;&#x7684;yaml&#x7533;&#x660E;" class="headerlink" title="&#x51E0;&#x4E2A;&#x7EC4;&#x4EF6;&#x5BF9;&#x5E94;&#x7684;yaml&#x7533;&#x660E;"></a>&#x51E0;&#x4E2A;&#x7EC4;&#x4EF6;&#x5BF9;&#x5E94;&#x7684;yaml&#x7533;&#x660E;</h2><h3 id="1-Dockerfile-template-MultiEnv-&#x5185;&#x5BB9;&#xFF1A;"><a href="#1-Dockerfile-template-MultiEnv-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="1. Dockerfile-template-MultiEnv &#x5185;&#x5BB9;&#xFF1A;"></a>1. <code>Dockerfile-template-MultiEnv</code> &#x5185;&#x5BB9;&#xFF1A;</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>u332-jre-bullseye</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/src/myapp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./<span class="variable">$package_path</span>/target/<span class="variable">$service_jar</span> /usr/src/myapp/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./<span class="variable">$package_path</span>/target/transmittable-thread-local-2.10.2.jar /usr/src/myapp/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./<span class="variable">$package_path</span>/target/start_jar.sh /usr/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/timezone &amp;&amp; <span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># specify the procps version so that Docker can cache it</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> DEBIAN_FRONTEND=noninteractive apt-get update &amp;&amp; apt-get install -y procps=2:3.3.17-5 &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/usr/bin/start_jar.sh&quot;</span>, <span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;-Dspring.profiles.active=<span class="variable">$active_env</span>&quot;</span> ,<span class="string">&quot;<span class="variable">$service_jar</span>&quot;</span>]</span></span><br></pre></td></tr></table></figure><h4 id="&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;"><a href="#&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;"></a>&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;</h4><p>&#x8DEF;&#x5F84;&#xFF1A; <code>/home/gitlab-runner/builds/vzxoq1eW/0/Creative/mta-swappie-package/mta-swappie-service/target/Dockerfile</code></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>u332-jre-bullseye</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/src/myapp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./mta-swappie-service/target/mta-swappie-service.jar /usr/src/myapp/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./mta-swappie-service/target/transmittable-thread-local-2.10.2.jar /usr/src/myapp/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./mta-swappie-service/target/start_jar.sh /usr/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/timezone &amp;&amp; <span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># specify the procps version so that Docker can cache it</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> DEBIAN_FRONTEND=noninteractive apt-get update &amp;&amp; apt-get install -y procps=2:3.3.17-5 &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/usr/bin/start_jar.sh&quot;</span>, <span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;-Dspring.profiles.active=uat&quot;</span> ,<span class="string">&quot;mta-swappie-service.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure><h3 id="2-service-clusterip-swappie-yaml-&#x5185;&#x5BB9;&#xFF1A;"><a href="#2-service-clusterip-swappie-yaml-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="2. service-clusterip-swappie.yaml &#x5185;&#x5BB9;&#xFF1A;"></a>2. <code>service-clusterip-swappie.yaml</code> &#x5185;&#x5BB9;&#xFF1A;</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span>  <span class="comment"># &#x7C7B;&#x578B;&#x4E3A; Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mta-swappie-service</span>  <span class="comment"># Service &#x7684;&#x540D;&#x79F0;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># &#x6807;&#x7B7E;&#x9009;&#x62E9;&#x5668;&#xFF0C;&#x4F1A;&#x548C;&#x4E0A;&#x9762;&#x521B;&#x5EFA;&#x7684; deployment.yaml &#x7684; pod &#x5173;&#x8054;&#x8D77;&#x6765;</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">  <span class="attr">clusterIP:</span>  <span class="comment"># service &#x7684; ip &#x5730;&#x5740;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5199;&#xFF0C;&#x9ED8;&#x8BA4;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;,&#x6CE8;&#x610F;&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x4E0D;&#x80FD;&#x5199;&#xFF0C;&#x6709;&#x4E2A;&#x8303;&#x56F4;&#x7684;&#xFF0C;&#x6211;&#x7684;&#x662F; 172.31.0.0/16</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span> <span class="comment"># &#x7C7B;&#x578B;&#x4E3A; Service &#x7684; ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span>  <span class="comment"># Service &#x7AEF;&#x53E3;&#xFF0C;&#x81EA;&#x5B9A;&#x4E49;</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span> <span class="comment"># pod &#x7AEF;&#x53E3;&#xFF0C;&#x4E0D;&#x5199;&#x9ED8;&#x8BA4;&#x662F; 80</span></span><br></pre></td></tr></table></figure><h3 id="3-ingress-class-alb-yaml-&#x5185;&#x5BB9;&#xFF1A;"><a href="#3-ingress-class-alb-yaml-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="3.ingress-class-alb.yaml &#x5185;&#x5BB9;&#xFF1A;"></a>3.<code>ingress-class-alb.yaml</code> &#x5185;&#x5BB9;&#xFF1A;</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">controller:</span> <span class="string">ingress.k8s.aws/alb</span></span><br></pre></td></tr></table></figure><p>&#x6216;&#x8005;&#x7528;&#x7F51;&#x4E0A;&#x7684;<code>v2_4_7_ingclass.yaml</code>&#x5185;&#x5BB9;&#xFF1A;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">elbv2.k8s.aws/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressClassParams</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alb</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">controller:</span> <span class="string">ingress.k8s.aws/alb</span></span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">apiGroup:</span> <span class="string">elbv2.k8s.aws</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">IngressClassParams</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">alb</span></span><br></pre></td></tr></table></figure><h3 id="4-ingress-uat-yaml-&#x5185;&#x5BB9;&#xFF1A;"><a href="#4-ingress-uat-yaml-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="4.ingress-uat.yaml &#x5185;&#x5BB9;&#xFF1A;"></a>4.<code>ingress-uat.yaml</code> &#x5185;&#x5BB9;&#xFF1A;</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mta-swappie-backend-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># Ingress Core Settings</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/scheme:</span> <span class="string">&apos;internet-facing&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/target-type:</span> <span class="string">&apos;ip&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/load-balancer-attributes:</span> <span class="string">idle_timeout.timeout_seconds=400</span></span><br><span class="line">    <span class="comment"># Health Check Settings</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/healthcheck-protocol:</span> <span class="string">&apos;HTTP&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/healthcheck-path:</span> <span class="string">&apos;/mta-swappie-service/health/check&apos;</span></span><br><span class="line">    <span class="comment">## SSL Settings</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/listen-ports:</span> <span class="string">&apos;[{&quot;HTTP&quot;: 80}, {&quot;HTTPS&quot;: 443}]&apos;</span></span><br><span class="line">    <span class="comment"># alb.ingress.kubernetes.io/certificate-arn: &apos;arn:aws:acm:eu-central-1:409921503514:certificate/7f065637-1580-47e0-8d1e-0f4340ab83d4&apos;</span></span><br><span class="line">    <span class="comment"># redirect all HTTP to HTTPS</span></span><br><span class="line">    <span class="comment"># alb.ingress.kubernetes.io/actions.ssl-redirect: &apos;{&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;: { &quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;}}&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&apos;443&apos;</span>    </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">alb</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span>  <span class="string">mta-api.xiexugang.top</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/mta-swappie-service</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><h3 id="5-deployment-template-uat-yaml-&#x5185;&#x5BB9;&#xFF1A;"><a href="#5-deployment-template-uat-yaml-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="5.deployment-template-uat.yaml &#x5185;&#x5BB9;&#xFF1A;"></a>5.<code>deployment-template-uat.yaml</code> &#x5185;&#x5BB9;&#xFF1A;</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">$service_name</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="string">$kube_replicas</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">50</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span><span class="string">%</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">$service_name</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">$service_name</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">$version</span></span><br><span class="line">        <span class="attr">release:</span> <span class="string">normal</span></span><br><span class="line">        <span class="attr">updatedTimestamp:</span> <span class="string">&quot;$timestamp&quot;</span></span><br><span class="line">        <span class="attr">language:</span> <span class="string">java</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">podAffinityTerm:</span>      </span><br><span class="line">              <span class="attr">labelSelector:</span></span><br><span class="line">                <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">$service_name</span></span><br><span class="line">              <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">$service_name</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">$image</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">lifecycle:</span></span><br><span class="line">            <span class="attr">preStop:</span></span><br><span class="line">              <span class="attr">exec:</span></span><br><span class="line">                <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-ce&quot;</span>, <span class="string">&quot;tail -f /dev/null&quot;</span>]</span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">18080</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">28080</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_IP</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_PORT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ENV</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;uat&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PINPOINT_OPTS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;-Xmx2048M -Xms2048M -XX:+PrintHeapAtGC -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:/var/log/$service_name-gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/$service_name.dump -javaagent:/usr/src/myapp/transmittable-thread-local-2.10.2.jar&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CATALINA_OPTS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;-XX:+PrintHeapAtGC -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:/var/log/$service_name-gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/$service_name.dump -javaagent:/usr/local/tomcat/transmittable-thread-local-2.10.2.jar&quot;</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">3000m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">3072M</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">300m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">3072M</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">$health_check</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">$health_check</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">200</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/log/ahs-pods/mount</span></span><br></pre></td></tr></table></figure><h4 id="&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;-1"><a href="#&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;-1" class="headerlink" title="&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;"></a>&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;</h4><p>&#x8DEF;&#x5F84;&#xFF1A;<code>/home/gitlab-runner/builds/vzxoq1eW/0/Creative/mta-swappie-package/mta-swappie-service/target/deployment.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">50</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span><span class="string">%</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">20230731_094602.gcp</span></span><br><span class="line">        <span class="attr">release:</span> <span class="string">normal</span></span><br><span class="line">        <span class="attr">updatedTimestamp:</span> <span class="string">&quot;2023463194627&quot;</span></span><br><span class="line">        <span class="attr">language:</span> <span class="string">java</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">podAffinityTerm:</span>      </span><br><span class="line">              <span class="attr">labelSelector:</span></span><br><span class="line">                <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">mta-swappie-service</span></span><br><span class="line">              <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">          <span class="attr">image:</span> <span class="number">409921503514.</span><span class="string">dkr.ecr.ap-east-1.amazonaws.com/uat-swappie:20230731_094602</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">lifecycle:</span></span><br><span class="line">            <span class="attr">preStop:</span></span><br><span class="line">              <span class="attr">exec:</span></span><br><span class="line">                <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-ce&quot;</span>, <span class="string">&quot;tail -f /dev/null&quot;</span>]</span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">18080</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">28080</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_IP</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_PORT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ENV</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;uat&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PINPOINT_OPTS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;-Xmx2048M -Xms2048M -XX:+PrintHeapAtGC -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:/var/log/mta-swappie-service-gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/mta-swappie-service.dump -javaagent:/usr/src/myapp/transmittable-thread-local-2.10.2.jar&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CATALINA_OPTS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;-XX:+PrintHeapAtGC -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:/var/log/mta-swappie-service-gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/mta-swappie-service.dump -javaagent:/usr/local/tomcat/transmittable-thread-local-2.10.2.jar&quot;</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">3000m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">3072M</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">300m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">3072M</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/mta-swappie-service/health/check</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/mta-swappie-service/health/check</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">200</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/log/ahs-pods/mount</span></span><br></pre></td></tr></table></figure><h4 id="deployment&#x91CC;&#x7684;&#x8DEF;&#x5F84;&#x8BF4;&#x660E;&#xFF1A;"><a href="#deployment&#x91CC;&#x7684;&#x8DEF;&#x5F84;&#x8BF4;&#x660E;&#xFF1A;" class="headerlink" title="deployment&#x91CC;&#x7684;&#x8DEF;&#x5F84;&#x8BF4;&#x660E;&#xFF1A;"></a>deployment&#x91CC;&#x7684;&#x8DEF;&#x5F84;&#x8BF4;&#x660E;&#xFF1A;</h4><p>deployment&#x91CC;&#x6700;&#x540E;&#x4E00;&#x884C; <code>path: /var/log/ahs-pods/mount</code>&#xFF0C;&#x8FD9;&#x4E2A;&#x8DEF;&#x5F84;&#x662F;&#x5BBF;&#x4E3B;&#x673A;&#x8282;&#x70B9;&#x91CC;&#x7684;&#x8DEF;&#x5F84;&#xFF0C;&#x4ED6;&#x662F;&#x6620;&#x5C04;&#x4E86;pod&#x91CC;&#x7684;&#x5BB9;&#x5668;&#x91CC;&#x7684;&#x8DEF;&#x5F84;&#xFF08;&#x6362;&#x8A00;&#x4E4B;&#xFF0C;&#x5C06;&#x5BB9;&#x5668;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;&#xFF0C;&#x6620;&#x5C04;&#x5230;&#x4E86;&#x5BBF;&#x4E3B;&#x673A;&#x8FD9;&#x4E2A;&#x8DEF;&#x5F84;&#x91CC;&#x4E86;&#xFF09;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x6392;&#x67E5;pod&#x542F;&#x52A8;&#x5931;&#x8D25;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x65E0;&#x6CD5;&#x8FDB;&#x5165;&#x5BB9;&#x5668;&#xFF0C;&#x6B64;&#x65F6;&#x5230;&#x5BBF;&#x4E3B;&#x673A;&#x7684;&#x8FD9;&#x4E2A;&#x76EE;&#x5F55;&#x4E0B;&#x770B;&#xFF0C;&#x662F;&#x6700;&#x65B9;&#x4FBF;&#x7684;&#x4E86;&#x3002;</p><h4 id="&#x6587;&#x4EF6;&#x4E00;&#x89C8;&#xFF1A;"><a href="#&#x6587;&#x4EF6;&#x4E00;&#x89C8;&#xFF1A;" class="headerlink" title="&#x6587;&#x4EF6;&#x4E00;&#x89C8;&#xFF1A;"></a>&#x6587;&#x4EF6;&#x4E00;&#x89C8;&#xFF1A;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-uat-aws-xxg</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[gitlab-runner@iZj6cc75gbmdwcpi6dy9yeZ deployment-uat-aws-xxg]$ ll</span></span><br><span class="line">total 964</span><br><span class="line">-rw-r--r-- 1 root root    336 Jul 29 19:37 aws-load-balancer-controller-service-account.yaml</span><br><span class="line">-rw-r--r-- 1 root root   2989 Jul 28 15:34 deployment-template-uat.yaml</span><br><span class="line">-rw-r--r-- 1 root root    659 Jul 28 16:57 Dockerfile-template-MultiEnv</span><br><span class="line">-rw-r--r-- 1 root root   8386 Jul 29 15:51 iam_policy.json</span><br><span class="line">-rw-r--r-- 1 root root    114 Jul 29 18:17 ingress-class-alb.yaml</span><br><span class="line">-rw-r--r-- 1 root root   1131 Jul 31 10:08 ingress-uat.yaml</span><br><span class="line">-rw-r--r-- 1 root root    659 Jul 28 13:47 service-clusterip-cruiser.yaml</span><br><span class="line">-rw-r--r-- 1 root root    665 Jul 28 13:47 service-clusterip-docomo.yaml</span><br><span class="line">-rw-r--r-- 1 root root    571 Jul 28 13:47 service-clusterip-swappie.yaml</span><br><span class="line">-rwxr-xr-x 1 root root    991 Jul 28 17:23 start_jar.sh</span><br><span class="line">-rw-r--r-- 1 root root 857936 Jul 28 17:23 transmittable-thread-local-2.10.2.jar</span><br><span class="line">-rw-r--r-- 1 root root  33643 Jul 29 17:52 v2_4_7_full.yaml</span><br><span class="line">-rw-r--r-- 1 root root  33649 Jul 29 17:51 v2_4_7_full.yaml.bak</span><br><span class="line">-rw-r--r-- 1 root root    418 Jul 29 18:20 v2_4_7_ingclass.yaml</span><br></pre></td></tr></table></figure><h3 id="6-aws-deploy-&#x5185;&#x5BB9;&#xFF1A;"><a href="#6-aws-deploy-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="6.aws_deploy &#x5185;&#x5BB9;&#xFF1A;"></a>6.<code>aws_deploy</code> &#x5185;&#x5BB9;&#xFF1A;</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">aws_deploy</span> {</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> main(args) {</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;=========================1.print args:========================&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> (args != <span class="literal">null</span> &amp;&amp; args.length &gt; <span class="number">0</span>) {</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">def</span> i = <span class="number">0</span>; i &lt; args.length; i++) {</span><br><span class="line">println <span class="string">&quot;i=${i}, value=${args[i]}&quot;</span></span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> serviceName = args[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">def</span> env = args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> currentDir = <span class="string">&quot;pwd&quot;</span>.execute().text</span><br><span class="line">println(<span class="string">&quot;currentDir=${currentDir}&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> dockerizeDir = <span class="string">&quot;/home/gitlab-runner/dockerize/deployment-prod-aws-europe&quot;</span></span><br><span class="line"><span class="keyword">def</span> dockerFileName = <span class="string">&quot;Dockerfile-template-MultiEnv&quot;</span></span><br><span class="line"><span class="keyword">def</span> k8sDeployFileName = <span class="string">&quot;deployment-template-prod.yaml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> kubeConfig = System.getenv(<span class="string">&quot;KUBE_CONFIG&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> region = System.getenv(<span class="string">&quot;REGION&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> kubeReplicas = System.getenv(<span class="string">&quot;KUBE_REPLICAS&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> healthCheck = System.getenv(<span class="string">&quot;HEALTH_CHECK&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> dockerRepo = System.getenv(<span class="string">&quot;DOCKER_REPO&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> dockerRepository = System.getenv(<span class="string">&quot;DOCKER_REPOSITORY&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================2.print env variables from .gitlab-ci.yml list:========================&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;env REGION=${region}&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;env KUBE_REPLICAS=${kubeReplicas}&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;env HEALTH_CHECK=${healthCheck}&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;env DOCKER_REPO=${dockerRepo}&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;env DOCKER_REPOSITORY=${dockerRepository}&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================3.mvn package========================&quot;</span>)</span><br><span class="line">runCommandResult(<span class="string">&quot;mvn -e -DskipTests=true clean package&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================4.create Dockerfile========================&quot;</span>)</span><br><span class="line">File dockerFile = <span class="keyword">new</span> File(<span class="string">&quot;${dockerizeDir}/${dockerFileName}&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> dockerFileTempleteContent = dockerFile.text</span><br><span class="line">println(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;dockerFileTempleteContent=\n${dockerFileTempleteContent}&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> serviceJar = serviceName + <span class="string">&quot;.jar&quot;</span></span><br><span class="line"><span class="keyword">def</span> lastDockerFileTempleteContent = dockerFileTempleteContent.replaceAll(<span class="string">&quot;\\\$package_path&quot;</span>, serviceName)</span><br><span class="line">.replaceAll(<span class="string">&quot;\\\$service_jar&quot;</span>, serviceJar)</span><br><span class="line">.replaceAll(<span class="string">&quot;\\\$active_env&quot;</span>, env)</span><br><span class="line">println(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;lastDockerFileTempleteContent=\n${lastDockerFileTempleteContent}&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#x5F53;&#x524D;&#x76EE;&#x5F55;&#x5728;: /home/gitlab-runner/builds/vzxoq1eW/0/Creative/mta-swappie-package</span></span><br><span class="line">File lastDockerFile = <span class="keyword">new</span> File(<span class="string">&quot;./${serviceName}/target/Dockerfile&quot;</span>)</span><br><span class="line">lastDockerFile.write(lastDockerFileTempleteContent)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================5.docker build image========================&quot;</span>)</span><br><span class="line">runCommandResult(<span class="string">&quot;sudo cp ${dockerizeDir}/start_jar.sh ./${serviceName}/target/&quot;</span>)</span><br><span class="line">runCommandResult(<span class="string">&quot;sudo cp ${dockerizeDir}/transmittable-thread-local-2.10.2.jar ./${serviceName}/target/&quot;</span>)</span><br><span class="line"></span><br><span class="line">runCommandResult(<span class="string">&quot;docker --version&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> dockerTag = ymdhms()</span><br><span class="line"><span class="keyword">def</span> dockerImage = dockerRepository + <span class="string">&quot;:&quot;</span> + dockerTag</span><br><span class="line">println(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;docker build -f ./${serviceName}/target/Dockerfile -t ${dockerImage} .&quot;</span>)</span><br><span class="line">runCommandResult(<span class="string">&quot;docker build -f ./${serviceName}/target/Dockerfile -t ${dockerImage} .&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================6.docker push image========================&quot;</span>)</span><br><span class="line"><span class="comment">// https://docs.aws.amazon.com/zh_cn/AmazonECR/latest/userguide/registry_auth.html</span></span><br><span class="line"><span class="comment">// docker login -u AWS -p &lt;password&gt; &lt;aws_account_id&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com  &#x4E0D;&#x77E5;&#x9053;&#x5BC6;&#x7801;</span></span><br><span class="line"><span class="comment">// https://docs.aws.amazon.com/zh_tw/AmazonECR/latest/userguide/getting-started-cli.html</span></span><br><span class="line"><span class="comment">// aws ecr get-login-password --region region | docker login --username AWS --password-stdin aws_account_id.dkr.ecr.region.amazonaws.com</span></span><br><span class="line"><span class="comment">// &#x4E0A;&#x9762;&#x8FD9;&#x6761;&#x547D;&#x4EE4;&#xFF0C;&#x4F1A;&#x5728;&#x76EE;&#x5F55; ~/.docker/ &#x4E0B;&#x751F;&#x4EA7;&#x4E2A;&#x4E34;&#x65F6;&#x7684;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x6587;&#x4EF6;&#xFF1A;config.json&#xFF0C;&#x6709;&#x6548;&#x671F;&#x4E3A;12&#x5C0F;&#x65F6;</span></span><br><span class="line">runPipeline(<span class="string">&quot;aws ecr get-login-password --region ${region} --profile devops | docker --config=/home/gitlab-runner/awsdocker login --username AWS --password-stdin ${dockerRepo}&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;docker --config=/home/gitlab-runner/awsdocker push ${dockerImage}&quot;</span>)</span><br><span class="line">runCommandResult(<span class="string">&quot;docker --config=/home/gitlab-runner/awsdocker push ${dockerImage}&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================7.create deployment.yaml========================&quot;</span>)</span><br><span class="line">File k8sDeploymentFile = <span class="keyword">new</span> File(<span class="string">&quot;${dockerizeDir}/${k8sDeployFileName}&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> k8sDeploymentFileContent = k8sDeploymentFile.text</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> lastK8sDeploymentFileContent = k8sDeploymentFileContent</span><br><span class="line">.replaceAll(<span class="string">&quot;\\\$service_name&quot;</span>, serviceName)</span><br><span class="line">.replaceAll(<span class="string">&quot;\\\$timestamp&quot;</span>, <span class="keyword">new</span> Date().format(<span class="string">&quot;YmdHms&quot;</span>))</span><br><span class="line">.replaceAll(<span class="string">&quot;\\\$image&quot;</span>, dockerImage)</span><br><span class="line">.replaceAll(<span class="string">&quot;\\\$version&quot;</span>, dockerTag+<span class="string">&quot;.gcp&quot;</span>)</span><br><span class="line">.replaceAll(<span class="string">&quot;\\\$service-context&quot;</span>, serviceName)</span><br><span class="line">.replaceAll(<span class="string">&quot;\\\$health_check&quot;</span>, healthCheck)</span><br><span class="line">.replaceAll(<span class="string">&quot;\\\$kube_replicas&quot;</span>, kubeReplicas)</span><br><span class="line">File lastK8sDeploymentFile = <span class="keyword">new</span> File(<span class="string">&quot;./${serviceName}/target/deployment.yaml&quot;</span>)</span><br><span class="line">lastK8sDeploymentFile.write(lastK8sDeploymentFileContent)</span><br><span class="line"></span><br><span class="line"><span class="comment">// kubectl --kubeconfig=/home/gitlab-runner/.kube/config-aws-prod-europe get namespaces</span></span><br><span class="line"><span class="comment">// kubectl --kubeconfig=/home/gitlab-runner/.kube/config-aws-prod-europe get nodes</span></span><br><span class="line"><span class="comment">// kubectl --kubeconfig=/home/gitlab-runner/.kube/config-aws-prod-europe -n java-service get service</span></span><br><span class="line"><span class="comment">// kubectl --kubeconfig=/home/gitlab-runner/.kube/config-aws-prod-europe -n java-service get ingress</span></span><br><span class="line"><span class="comment">// kubectl --kubeconfig=/home/gitlab-runner/.kube/config-aws-prod-europe -n java-service get deployment</span></span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================8.EKS list nodes========================&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;kubectl get nodes --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line">runCommand(<span class="string">&quot;kubectl get nodes --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================9.EKS list pods========================&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line">runCommand(<span class="string">&quot;kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================10.EKS apply deployment========================&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;kubectl apply -f ./${serviceName}/target/deployment.yaml --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> k1 = <span class="string">&quot;kubectl apply -f ./${serviceName}/target/deployment.yaml --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>.execute().text</span><br><span class="line">runCommand(<span class="string">&quot;echo 3_____${k1}&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> (k1.contains(<span class="string">&quot;configured&quot;</span>)) {</span><br><span class="line">println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;EKS deployment configured!&quot;</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================11.EKS detect pods status: ContainerCreating========================&quot;</span>)</span><br><span class="line"><span class="comment">//&#x67E5;&#x770B;k8s&#x72B6;&#x6001;</span></span><br><span class="line">runCommand(<span class="string">&quot;date&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;4__Detect ContainerCreating==&gt; kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}  | grep ${serviceName}  | grep ContainerCreating -c&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">def</span> index = <span class="number">1</span>; index &lt;= <span class="number">10</span>; index++) {</span><br><span class="line"><span class="keyword">def</span> podStatus = runPipeline(<span class="string">&quot;kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}  | grep ${serviceName}  | grep ContainerCreating -c \n&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> (podStatus.equals(<span class="string">&quot;1&quot;</span>)) {</span><br><span class="line">println(<span class="string">&quot;&#x5BB9;&#x5668;&#x6B63;&#x5728;&#x521B;&#x5EFA;&#x4E2D;...\n&quot;</span>)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">}</span><br><span class="line">sleep(<span class="number">1000</span>L)</span><br><span class="line">}</span><br><span class="line">runCommand(<span class="string">&quot;date&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================12.EKS detect deployment status: successfully========================&quot;</span>)</span><br><span class="line">runCommand(<span class="string">&quot;date&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;6__Detect successfully==&gt; kubectl rollout status deployment/${serviceName}  -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig} | grep successfully -c&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">def</span> index = <span class="number">1</span>; index &lt;= <span class="number">10</span>; index++) {</span><br><span class="line"><span class="keyword">def</span> deploymentStatus = runPipeline(<span class="string">&quot;kubectl rollout status deployment/${serviceName}  -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig} | grep successfully -c \n&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> (deploymentStatus.equals(<span class="string">&quot;1&quot;</span>)) {</span><br><span class="line">println(<span class="string">&quot;&#x53D1;&#x5E03;&#x6210;&#x529F;!\n&quot;</span>)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">}</span><br><span class="line">sleep(<span class="number">1000</span>L)</span><br><span class="line">}</span><br><span class="line">runCommand(<span class="string">&quot;date&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#x666E;&#x901A;shell&#x547D;&#x4EE4;&#xFF0C;&#x6CA1;&#x6709;&#x7BA1;&#x9053;</span></span><br><span class="line"><span class="keyword">def</span> <span class="keyword">static</span> runCommand(<span class="keyword">def</span> command) {</span><br><span class="line">println command.execute().text</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#x666E;&#x901A;shell&#x547D;&#x4EE4;&#xFF0C;&#x6CA1;&#x6709;&#x7BA1;&#x9053;</span></span><br><span class="line"><span class="keyword">def</span> <span class="keyword">static</span> runCommandResult(<span class="keyword">def</span> command) {</span><br><span class="line"><span class="keyword">def</span> info  = <span class="keyword">new</span> StringBuilder()</span><br><span class="line"><span class="keyword">def</span> error = <span class="keyword">new</span> StringBuilder()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> proc = command.execute()<span class="comment">// Call *execute* on the string</span></span><br><span class="line">proc.consumeProcessOutput(info, error)</span><br><span class="line">proc.waitFor()<span class="comment">// Wait for the command to finish</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!error.toString().equals(<span class="string">&quot;&quot;</span>)) {</span><br><span class="line">println <span class="string">&quot;Command[ ${command} ] &gt;&gt;error: ${error.toString()}&quot;</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">println <span class="string">&quot;Command[ ${command} ] &gt;&gt;result: ${info.toString()}&quot;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#x6709;&#x7BA1;&#x9053;&#x7684;shell&#x547D;&#x4EE4;</span></span><br><span class="line"><span class="keyword">def</span> <span class="keyword">static</span> runPipeline(<span class="keyword">def</span> command) {</span><br><span class="line">Runtime rt = Runtime.getRuntime()</span><br><span class="line">String[] commands = [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, command]</span><br><span class="line">Process proc = rt.exec(commands)</span><br><span class="line"></span><br><span class="line">BufferedReader stdInput = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span></span><br><span class="line">InputStreamReader(proc.getInputStream()))</span><br><span class="line"></span><br><span class="line">BufferedReader stdError = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span></span><br><span class="line">InputStreamReader(proc.getErrorStream()))</span><br><span class="line"></span><br><span class="line"><span class="comment">// Read the output from the command</span></span><br><span class="line">println(<span class="string">&quot;Here is the standard output of the command:\n&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> infoBuilder = <span class="keyword">new</span> StringBuilder()</span><br><span class="line"><span class="keyword">def</span> infostr = <span class="literal">null</span></span><br><span class="line"><span class="keyword">while</span> ((infostr = stdInput.readLine()) != <span class="literal">null</span>) {</span><br><span class="line">infoBuilder.append(infostr)</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (!infoBuilder.toString().equals(<span class="string">&quot;&quot;</span>)) {</span><br><span class="line"><span class="comment">//println &quot;AAAAAAAAAA&quot;</span></span><br><span class="line"><span class="keyword">return</span> infoBuilder.toString()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Read any errors from the attempted command</span></span><br><span class="line">println(<span class="string">&quot;Here is the standard error of the command (if any):\n&quot;</span>);</span><br><span class="line"><span class="keyword">def</span> errorBuilder = <span class="keyword">new</span> StringBuilder()</span><br><span class="line"><span class="keyword">def</span> errorstr = <span class="literal">null</span></span><br><span class="line"><span class="keyword">while</span> ((errorstr = stdError.readLine()) != <span class="literal">null</span>) {</span><br><span class="line">errorBuilder.append(errorstr)</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (!errorBuilder.toString().equals(<span class="string">&quot;&quot;</span>)) {</span><br><span class="line"><span class="comment">//println &quot;BBBBBBBBBB&quot;</span></span><br><span class="line"><span class="keyword">return</span> errorBuilder.toString()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="keyword">static</span> ymdhms() {</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> Date().format(<span class="string">&quot;yyyyMMdd_HHmmss&quot;</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="7-gitlab-ci-yml-&#x5185;&#x5BB9;&#xFF1A;"><a href="#7-gitlab-ci-yml-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="7..gitlab-ci.yml &#x5185;&#x5BB9;&#xFF1A;"></a>7.<code>.gitlab-ci.yml</code> &#x5185;&#x5BB9;&#xFF1A;</h3><p>&#x76EE;&#x524D;&#x8D77;&#x4F5C;&#x7528;&#x7684; stage=<code>deploy-aws-uat-xxg</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start check environment&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">whoami</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pwd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">java</span> <span class="string">-version</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">groovy</span> <span class="string">-version</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">aws</span> <span class="string">--version</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">eksctl</span> <span class="string">version</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">version</span> <span class="string">--client</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-gcp-uat:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">KUBE_CONFIG:</span> <span class="string">&quot;config-uat-asia&quot;</span> <span class="comment">#&#x4F7F;&#x7528;kubeconfig&#x6587;&#x4EF6;&#x540D;</span></span><br><span class="line">    <span class="attr">KUBE_SERVICE_ACCOUNT:</span> <span class="string">&quot;creative-cicd-uat-asia@atrenew-docomo-uat.iam.gserviceaccount.com&quot;</span> <span class="comment">#&#x4F7F;&#x7528;serviceaccount&#x8D26;&#x6237;</span></span><br><span class="line">    <span class="attr">KUBE_REPLICAS:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">HEALTH_CHECK:</span> <span class="string">&quot;/mta-swappie-service/actuator/health&quot;</span>  <span class="comment">#healthCheck&#x8DEF;&#x5F84;&#xFF0C;&#x6CE8;&#x610F;&#x5E26;&#x4E0A;contextPath</span></span><br><span class="line">    <span class="attr">DOCKER_REPOSITORY:</span> <span class="string">&quot;asia-northeast1-docker.pkg.dev/atrenew-docomo-uat/uat/&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start deploy &quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">gcp_creative_package</span>  <span class="string">mta-swappie-service</span> <span class="string">uat</span> <span class="comment">#&#x53C2;&#x6570;1.serviceName&#xFF08;&#x5305;&#x540D;&#xFF09; 2.&#x73AF;&#x5883;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;deploy success&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">uat</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hk-aliyun</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-gcp-prod:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">KUBE_CONFIG:</span> <span class="string">&quot;config-prod-europe&quot;</span> <span class="comment">#&#x4F7F;&#x7528;kubeconfig&#x6587;&#x4EF6;&#x540D;</span></span><br><span class="line">    <span class="attr">KUBE_SERVICE_ACCOUNT:</span> <span class="string">&quot;creative-cicd-prod-asia@atrenew-japan-docomo.iam.gserviceaccount.com&quot;</span> <span class="comment">#&#x4F7F;&#x7528;serviceaccount&#x8D26;&#x6237;</span></span><br><span class="line">    <span class="attr">KUBE_REPLICAS:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">HEALTH_CHECK:</span> <span class="string">&quot;/mta-swappie-service/actuator/health&quot;</span>  <span class="comment">#healthCheck&#x8DEF;&#x5F84;&#xFF0C;&#x6CE8;&#x610F;&#x5E26;&#x4E0A;</span></span><br><span class="line">    <span class="attr">DOCKER_REPOSITORY:</span> <span class="string">&quot;asia-northeast1-docker.pkg.dev/atrenew-japan-docomo/asia-prod-java/swappie/&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start deploy &quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">gcp_creative_package</span>  <span class="string">mta-swappie-service</span> <span class="string">prod</span> <span class="comment">#&#x53C2;&#x6570;1.serviceName&#xFF08;&#x5305;&#x540D;&#xFF09; 2.&#x73AF;&#x5883;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hk-aliyun</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-aws-uat:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">KUBE_CONFIG:</span> <span class="string">&quot;config-uat-aws-hk&quot;</span> <span class="comment">#&#x4F7F;&#x7528;kubeconfig&#x6587;&#x4EF6;&#x540D;</span></span><br><span class="line">    <span class="attr">REGION:</span> <span class="string">&quot;ap-east-1&quot;</span> <span class="comment">#&#x533A;&#x57DF;</span></span><br><span class="line">    <span class="attr">KUBE_REPLICAS:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">HEALTH_CHECK:</span> <span class="string">&quot;/mta-swappie-service/mta/web/health/check&quot;</span>  <span class="comment">#healthCheck&#x8DEF;&#x5F84;&#xFF0C;&#x6CE8;&#x610F;&#x5E26;&#x4E0A;contextPath</span></span><br><span class="line">    <span class="attr">DOCKER_REPO:</span> <span class="string">&quot;409921503514.dkr.ecr.ap-east-1.amazonaws.com&quot;</span></span><br><span class="line">    <span class="attr">DOCKER_REPOSITORY:</span> <span class="string">&quot;$DOCKER_REPO/uat-swappie&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start deploy &quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">aws_creative_package</span>  <span class="string">mta-swappie-service</span> <span class="string">uat</span> <span class="comment">#&#x53C2;&#x6570;1.serviceName&#xFF08;&#x5305;&#x540D;&#xFF09; 2.&#x73AF;&#x5883;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;deploy success&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">uat-aws</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hk-aliyun</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-aws-uat-xxg:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">KUBE_CONFIG:</span> <span class="string">&quot;config-uat-aws-mta-hk-xxg&quot;</span> <span class="comment">#&#x4F7F;&#x7528;kubeconfig&#x6587;&#x4EF6;&#x540D;</span></span><br><span class="line">    <span class="attr">REGION:</span> <span class="string">&quot;ap-east-1&quot;</span> <span class="comment">#&#x533A;&#x57DF;</span></span><br><span class="line">    <span class="attr">KUBE_REPLICAS:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">HEALTH_CHECK:</span> <span class="string">&quot;/mta-swappie-service/mta/web/health/check&quot;</span>  <span class="comment">#healthCheck&#x8DEF;&#x5F84;&#xFF0C;&#x6CE8;&#x610F;&#x5E26;&#x4E0A;contextPath</span></span><br><span class="line">    <span class="attr">DOCKER_REPO:</span> <span class="string">&quot;409921503514.dkr.ecr.ap-east-1.amazonaws.com&quot;</span></span><br><span class="line">    <span class="attr">DOCKER_REPOSITORY:</span> <span class="string">&quot;$DOCKER_REPO/uat-swappie&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start deploy &quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">groovy</span> <span class="string">./aws_deploy.groovy</span> <span class="string">mta-swappie-service</span> <span class="string">uat</span> <span class="comment">#&#x53C2;&#x6570;1.serviceName&#xFF08;&#x5305;&#x540D;&#xFF09; 2.&#x73AF;&#x5883;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;deploy success&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">uat-awsxxg</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hk-aliyun</span>    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-aws-prod:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">KUBE_CONFIG:</span> <span class="string">&quot;config-aws-prod-europe&quot;</span> <span class="comment">#&#x4F7F;&#x7528;kubeconfig&#x6587;&#x4EF6;&#x540D;</span></span><br><span class="line">    <span class="attr">REGION:</span> <span class="string">&quot;eu-central-1&quot;</span> <span class="comment">#&#x533A;&#x57DF;</span></span><br><span class="line">    <span class="attr">KUBE_REPLICAS:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">HEALTH_CHECK:</span> <span class="string">&quot;/mta-swappie-service/mta/web/health/check&quot;</span>  <span class="comment">#healthCheck&#x8DEF;&#x5F84;&#xFF0C;&#x6CE8;&#x610F;&#x5E26;&#x4E0A;contextPath</span></span><br><span class="line">    <span class="attr">DOCKER_REPO:</span> <span class="string">&quot;409921503514.dkr.ecr.eu-central-1.amazonaws.com&quot;</span></span><br><span class="line">    <span class="attr">DOCKER_REPOSITORY:</span> <span class="string">&quot;$DOCKER_REPO/prod-swappie&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start deploy&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">groovy</span> <span class="string">./aws_deploy.groovy</span> <span class="string">mta-swappie-service</span> <span class="string">prod</span> <span class="comment">#&#x53C2;&#x6570;1.serviceName&#xFF08;&#x5305;&#x540D;&#xFF09; 2.&#x73AF;&#x5883;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;deploy success&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main-aws</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hk-aliyun</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5B9E;&amp;#x73B0;&amp;#x5728;AWS&amp;#x91CC;&quot;&gt;&lt;a href=&quot;#&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5B9E;&amp;#x73B0;&amp;#x5728;AWS&amp;#x91CC;&quot; class=&quot;headerlink&quot; title=&quot;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5B9E;&amp;#x73B0;&amp;#x5728;AWS&amp;#x91CC;&quot;&gt;&lt;/a&gt;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5B9E;&amp;#x73B0;&amp;#x5728;AWS&amp;#x91CC;&lt;/h2&gt;&lt;p&gt;1.&amp;#x521B;&amp;#x5EFA;EKS&amp;#x96C6;&amp;#x7FA4;&amp;#xFF1B;&lt;br&gt;2.EKS&amp;#x96C6;&amp;#x7FA4;&amp;#x91CC;&amp;#x521B;&amp;#x5EFA;&amp;#x8282;&amp;#x70B9;&amp;#x7EC4;&amp;#xFF1B;&lt;br&gt;3.EKS&amp;#x96C6;&amp;#x7FA4;&amp;#x521B;&amp;#x5EFA;&amp;#x670D;&amp;#x52A1;namespace&amp;#xFF1B;&lt;br&gt;4.&amp;#x521B;&amp;#x5EFA;ECR&amp;#xFF1B;&lt;br&gt;5.&amp;#x521B;&amp;#x5EFA;SSL/TLS&amp;#x8BC1;&amp;#x4E66;&amp;#xFF0C;&amp;#x5E76; &amp;#x901A;&amp;#x8FC7; CNAME &amp;#x65B9;&amp;#x5F0F;&amp;#xFF0C;&amp;#x57DF;&amp;#x540D;&amp;#x89E3;&amp;#x6790;&amp;#x7ED1;&amp;#x5B9A;&amp;#xFF1B;&lt;br&gt;6.&amp;#x90E8;&amp;#x7F72;ALB Ingress Controller&lt;/p&gt;</summary>
    
    
    
    <category term="Infrastructure" scheme="http://example.com/categories/Infrastructure/"/>
    
    
    <category term="AWS-EC2" scheme="http://example.com/tags/AWS-EC2/"/>
    
  </entry>
  
  <entry>
    <title>Infrastructure-AWS系列.1.创建EC2实例、LB、RDS、ElastiCache</title>
    <link href="http://example.com/2023/07/21/18.D001.Infrastructure-AWS%E7%B3%BB%E5%88%97.1.%E5%88%9B%E5%BB%BARDS%E3%80%81ElasticCache/"/>
    <id>http://example.com/2023/07/21/18.D001.Infrastructure-AWS%E7%B3%BB%E5%88%97.1.%E5%88%9B%E5%BB%BARDS%E3%80%81ElasticCache/</id>
    <published>2023-07-20T16:00:00.000Z</published>
    <updated>2023-10-12T07:17:23.074Z</updated>
    
    <content type="html"><![CDATA[<h2 id="&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x5728;AWS&#x91CC;"><a href="#&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x5728;AWS&#x91CC;" class="headerlink" title="&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x5728;AWS&#x91CC;"></a>&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x5728;AWS&#x91CC;</h2><p>1.&#x521B;&#x5EFA;EC2&#x5B9E;&#x4F8B;&#xFF0C;&#x90E8;&#x7F72;nginx&#xFF1B;<br>2.&#x521B;&#x5EFA;EC2&#x5B9E;&#x4F8B;&#xFF0C;&#x90E8;&#x7F72;tomcat&#x3001;xxl-job&#xFF1B;<br>3.&#x4E3A;nginx&#x90E8;&#x7F72;LB&#xFF1B;<br>4.&#x90E8;&#x7F72;&#x5355;&#x8282;&#x70B9;RDS (mysql-5.7)&#xFF1B;<br>5.&#x90E8;&#x7F72;&#x5355;&#x8282;&#x70B9;ElastiCache (redis-5.0)&#xFF1B;</p><span id="more"></span><h2 id="1-&#x73AF;&#x5883;"><a href="#1-&#x73AF;&#x5883;" class="headerlink" title="1.&#x73AF;&#x5883;"></a>1.&#x73AF;&#x5883;</h2><p>&#x516C;&#x6709;&#x4E91;&#xFF1A;AWS Cloud<br>&#x9879;&#x76EE;&#x540D;&#x79F0;&#xFF1A;mta-swappie<br>&#x9879;&#x76EE;&#x73AF;&#x5883;&#xFF1A;UAT<br>&#x533A;&#x57DF;&#xFF1A; &#x4E9A;&#x592A;&#x5730;&#x533A;(&#x9999;&#x6E2F;) ap-east-1</p><p>IAM &#x6839;&#x8D26;&#x6237;&#x767B;&#x5F55;&#xFF1A; ???<br>&#x8D26;&#x6237;ID&#xFF1A;???<br>&#x7528;&#x6237;&#x540D;&#xFF1A;???<br>&#x5BC6;&#x7801;&#xFF1A;   ???</p><h2 id="2-&#x5B89;&#x88C5;AWS-CLI"><a href="#2-&#x5B89;&#x88C5;AWS-CLI" class="headerlink" title="2.&#x5B89;&#x88C5;AWS CLI"></a>2.&#x5B89;&#x88C5;AWS CLI</h2><p>&#x7565;</p><p>&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x64CD;&#x4F5C;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">su - gitlab-runner</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ~/.aws</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll</span></span><br><span class="line">-rw------- 1 gitlab-runner gitlab-runner  43 Jul 20 14:06 config</span><br><span class="line">-rw------- 1 gitlab-runner gitlab-runner 116 Jul 20 14:06 credentials</span><br></pre></td></tr></table></figure><p>&#x5DF2;&#x7ECF;&#x6709;&#x4E86;aws&#x914D;&#x7F6E;&#x4E86;&#x3002;&#x518D;&#x914D;&#x7F6E;&#x4E2A;&#x7528;&#x6237;:<br>&#x8FDB;&#x5165;&#x53F3;&#x4E0A;&#x65B9;<code>&#x8D26;&#x6237;</code>&#xFF0C;&#x4E0B;&#x62C9;&#xFF0C;&#x627E;&#x5230;&#xFF1A;<code>Security Credentials</code>&#xFF0C;&#x70B9;&#x51FB;&#x8FDB;&#x5165;<br>&#x627E;&#x5230;<code>&#x8BBF;&#x95EE;&#x5BC6;&#x94A5;</code>&#xFF0C;&#x521B;&#x5EFA;&#x8BBF;&#x95EE;&#x5BC6;&#x94A5;&#xFF0C;&#x6700;&#x540E;&#x5F97;&#x5230; <code>ACCESS ID</code> &#x548C; <code>Access Key</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws_access_key_id = ???</span><br><span class="line">aws_secret_access_key = ???</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-access-key/accessKey.1.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-access-key/accessKey.2.png"></p><p>&#x8DF3;&#x677F;&#x673A;&#x4E0A;&#x914D;&#x7F6E;&#x591A;&#x7528;&#x6237;&#xFF0C;&#x53C2;&#x8003;<a href="https://www.jibing57.com/2017/10/24/how-to-use-aws-cli-with-multi-user/">&#x8FD9;&#x91CC;</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">aws configure --profile devops</span></span><br><span class="line"></span><br><span class="line">&#x4EA4;&#x4E92;&#x5F0F;</span><br><span class="line">AWS Access Key ID [None]: ???</span><br><span class="line">AWS Secret Access Key [None]: ???</span><br><span class="line">Default region name [None]: ap-east-1</span><br><span class="line">Default output format [None]: json</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll ~/.aws</span></span><br><span class="line">total 8</span><br><span class="line">-rw------- 1 gitlab-runner gitlab-runner  93 Jul 25 14:28 config</span><br><span class="line">-rw------- 1 gitlab-runner gitlab-runner 231 Jul 25 14:28 credentials</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> ~/.aws/config</span></span><br><span class="line">[default]</span><br><span class="line">region = ap-east-1</span><br><span class="line">output = json</span><br><span class="line">[profile devops]</span><br><span class="line">region = ap-east-1</span><br><span class="line">output = json</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> ~/.aws/credentials</span></span><br><span class="line">[default]</span><br><span class="line">aws_access_key_id = ???</span><br><span class="line">aws_secret_access_key = ???</span><br><span class="line">[devops]</span><br><span class="line">aws_access_key_id = ???</span><br><span class="line">aws_secret_access_key = ???</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">aws configure list</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">aws configure list-profiles</span></span><br><span class="line">default</span><br><span class="line">devops</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">aws sts get-caller-identity --profile devops</span></span><br><span class="line">{</span><br><span class="line">    &quot;UserId&quot;: &quot;AIDAV64JZYENGH2XWUBGE&quot;,</span><br><span class="line">    &quot;Account&quot;: &quot;409921503514&quot;,</span><br><span class="line">    &quot;Arn&quot;: &quot;arn:aws:iam::409921503514:user/devops&quot;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h2 id="3-&#x5B89;&#x88C5;-eksctl"><a href="#3-&#x5B89;&#x88C5;-eksctl" class="headerlink" title="3.&#x5B89;&#x88C5; eksctl"></a>3.&#x5B89;&#x88C5; eksctl</h2><p>1.&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;<code>root</code>&#x7528;&#x6237;&#x64CD;&#x4F5C;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install dpkg</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dpkg --print-architecture</span></span><br><span class="line">amd64</span><br><span class="line"></span><br><span class="line">&#x5728; /etc/sudoers &#x6587;&#x4EF6;&#x91CC;&#xFF0C;&#x589E;&#x52A0;&#x7528;&#x6237; gitlab-runner &#x7684; sudo &#x65E0;&#x5BC6;&#x7801;&#x6743;&#x9650;</span><br><span class="line">TODO</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2.&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5; <code>gitlab-runner</code> &#x7528;&#x6237;&#x64CD;&#x4F5C;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">su - gitlab-runner</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">for</span> ARM systems, <span class="built_in">set</span> ARCH to: `arm64`, `armv6` or `armv7`</span></span><br><span class="line">ARCH=amd64</span><br><span class="line">PLATFORM=$(uname -s)_$ARCH</span><br><span class="line"></span><br><span class="line">curl -sLO &quot;https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_$PLATFORM.tar.gz&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(Optional) Verify checksum</span></span><br><span class="line">curl -sL &quot;https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_checksums.txt&quot; | grep $PLATFORM | sha256sum --check</span><br><span class="line"></span><br><span class="line">tar -xzf eksctl_$PLATFORM.tar.gz -C /tmp &amp;&amp; rm eksctl_$PLATFORM.tar.gz</span><br><span class="line"></span><br><span class="line">sudo mv /tmp/eksctl /usr/local/bin</span><br></pre></td></tr></table></figure><p>&#x9A8C;&#x8BC1;&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ eksctl version</span><br><span class="line">0.150.0-dev</span><br></pre></td></tr></table></figure><h2 id="4-&#x5B89;&#x88C5;Helm"><a href="#4-&#x5B89;&#x88C5;Helm" class="headerlink" title="4.&#x5B89;&#x88C5;Helm"></a>4.&#x5B89;&#x88C5;Helm</h2><p><a href="https://helm.sh/zh/docs/intro/install/">https://helm.sh/zh/docs/intro/install/</a><br><a href="https://helm.sh/zh/docs/intro/quickstart/">https://helm.sh/zh/docs/intro/quickstart/</a></p><p>1.&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;<code>gitlab-runner</code>&#x7528;&#x6237;&#x64CD;&#x4F5C;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">su - gitlab-runner</span></span><br><span class="line"></span><br><span class="line">&#x4F7F;&#x7528;&#x811A;&#x672C;&#x5B89;&#x88C5;</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> 700 get_helm.sh</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./get_helm.sh</span></span><br><span class="line">Downloading https://get.helm.sh/helm-v3.12.2-linux-amd64.tar.gz</span><br><span class="line">Verifying checksum... Done.</span><br><span class="line">Preparing to install helm into /usr/local/bin</span><br><span class="line">helm installed into /usr/local/bin/helm</span><br></pre></td></tr></table></figure><p>&#x5982;&#x679C;&#x60F3;&#x76F4;&#x63A5;&#x6267;&#x884C;&#x5B89;&#x88C5;&#xFF0C;&#x8FD0;&#x884C;curl <code>https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm get -h</span></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="5-&#x5B89;&#x88C5;kubectl"><a href="#5-&#x5B89;&#x88C5;kubectl" class="headerlink" title="5.&#x5B89;&#x88C5;kubectl"></a>5.&#x5B89;&#x88C5;kubectl</h2><p>&#x7565;</p><p>&#x76EE;&#x524D;&#x8FD9;&#x4E2A;&#x9879;&#x76EE;&#x7684;kubeconfig&#x6587;&#x4EF6;&#x76EE;&#x5F55;&#xFF1A;<code>/home/gitlab-runner/.kube/config-uat-aws-hk</code></p><p>&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#xFF0C;&#x4F7F;&#x7528;kubectl&#x547D;&#x4EE4;&#x64CD;&#x4F5C;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">su - gitlabrunner</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-hk -n java-service get pods</span></span><br><span class="line">NAME                                   READY   STATUS             RESTARTS   AGE</span><br><span class="line">mta-swappie-service-7747d94b99-f2sw7   1/1     Running            0          18h</span><br><span class="line">mta-swappie-service-84cc4d5d4b-7mzc6   0/1     ImagePullBackOff   0          3h31m</span><br></pre></td></tr></table></figure><h2 id="6-&#x521B;&#x5EFA;-web-nginx-&#x5B9E;&#x4F8B;"><a href="#6-&#x521B;&#x5EFA;-web-nginx-&#x5B9E;&#x4F8B;" class="headerlink" title="6.&#x521B;&#x5EFA; web-nginx &#x5B9E;&#x4F8B;"></a>6.&#x521B;&#x5EFA; web-nginx &#x5B9E;&#x4F8B;</h2><h3 id="&#x624B;&#x52A8;&#x521B;&#x5EFA;&#x6B65;&#x9AA4;"><a href="#&#x624B;&#x52A8;&#x521B;&#x5EFA;&#x6B65;&#x9AA4;" class="headerlink" title="&#x624B;&#x52A8;&#x521B;&#x5EFA;&#x6B65;&#x9AA4;"></a>&#x624B;&#x52A8;&#x521B;&#x5EFA;&#x6B65;&#x9AA4;</h3><ol><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/ec2.web-nginx.1.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/ec2.web-nginx.2.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/ec2.web-nginx.3.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/ec2.web-nginx.4.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/ec2.web-nginx.5.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/ec2.web-nginx.6.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/ec2.web-nginx.7.png"></p></li></ol><h3 id="&#x4E3A;-EC2-web-nginx-&#x5206;&#x914D;&#x5F39;&#x6027;IP"><a href="#&#x4E3A;-EC2-web-nginx-&#x5206;&#x914D;&#x5F39;&#x6027;IP" class="headerlink" title="&#x4E3A; EC2: web-nginx &#x5206;&#x914D;&#x5F39;&#x6027;IP"></a>&#x4E3A; EC2: web-nginx &#x5206;&#x914D;&#x5F39;&#x6027;IP</h3><p>&#x521B;&#x5EFA;&#x5F39;&#x6027;IP<br>1.<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/ec2.web-nginx.%E5%BC%B9%E6%80%A7IP.1.png"></p><ol start="2"><li><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/ec2.web-nginx.%E5%BC%B9%E6%80%A7IP.2.png"></li></ol><p>&#x5F97;&#x5230;&#x5F39;&#x6027;IP&#xFF1A;18.163.150.205</p><h3 id="&#x5F39;&#x6027;IP&#x548C;EC2-web-nginx&#x5B9E;&#x4F8B;&#x5173;&#x8054;"><a href="#&#x5F39;&#x6027;IP&#x548C;EC2-web-nginx&#x5B9E;&#x4F8B;&#x5173;&#x8054;" class="headerlink" title="&#x5F39;&#x6027;IP&#x548C;EC2:web-nginx&#x5B9E;&#x4F8B;&#x5173;&#x8054;"></a>&#x5F39;&#x6027;IP&#x548C;EC2:web-nginx&#x5B9E;&#x4F8B;&#x5173;&#x8054;</h3><ol><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/%E5%BC%B9%E6%80%A7IP%E5%92%8CEC2-web-nginx%E5%AE%9E%E4%BE%8B%E5%85%B3%E8%81%94.1.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/%E5%BC%B9%E6%80%A7IP%E5%92%8CEC2-web-nginx%E5%AE%9E%E4%BE%8B%E5%85%B3%E8%81%94.2.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/%E5%BC%B9%E6%80%A7IP%E5%92%8CEC2-web-nginx%E5%AE%9E%E4%BE%8B%E5%85%B3%E8%81%94.3.png"></p></li></ol><p>&#x5F39;&#x6027;Ip&#xFF1A;<code>18.163.150.205</code>  &#x548C; EC2&#x5B9E;&#x4F8B;&#xFF1A;<code>web-nginx</code> &#x5173;&#x8054;&#x4E86;&#x540E;&#xFF0C;ping &#x4E0B;&#x8BD5;&#x8BD5;&#xFF1A;&#x3000;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">% </span><span class="language-bash">ping 18.163.150.205</span></span><br><span class="line">PING 18.163.150.205 (18.163.150.205): 56 data bytes</span><br><span class="line">Request timeout for icmp_seq 0</span><br><span class="line">Request timeout for icmp_seq 1</span><br><span class="line">Request timeout for icmp_seq 2</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>&#x53D1;&#x73B0;ping &#x4E0D;&#x901A;&#xFF0C;&#x89E3;&#x51B3;&#x529E;&#x6CD5;&#xFF1A;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/%E5%BC%B9%E6%80%A7IP-ping%E4%B8%8D%E9%80%9A%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%881.png"></p><p>&#x5728;&#x7F51;&#x7EDC;&#x4E0E;&#x5B89;&#x5168;&#x2013;&#x5B89;&#x5168;&#x7EC4;&#x4E2D;&#xFF0C;&#x627E;&#x5230;&#x5165;&#x7AD9;&#x7684;&#x90A3;&#x6761;&#xFF0C;&#x521B;&#x5EFA;&#x4E2A;<code>&#x6240;&#x6709;&#x6D41;&#x91CF;</code>&#x7684;<code>&#x5165;&#x7AD9;&#x89C4;</code>&#x5219;`&#x5373;&#x53EF;&#x3002;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">% </span><span class="language-bash">ping 18.163.150.205</span></span><br><span class="line">PING 18.163.150.205 (18.163.150.205): 56 data bytes</span><br><span class="line">64 bytes from 18.163.150.205: icmp_seq=0 ttl=236 time=67.679 ms</span><br><span class="line">64 bytes from 18.163.150.205: icmp_seq=1 ttl=236 time=75.729 ms</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="SSH-&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;"><a href="#SSH-&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;" class="headerlink" title="SSH &#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;"></a>SSH &#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">i-03629cc1c8b1d7e62 (web-nginx)</span><br><span class="line">&#x6253;&#x5F00; SSH &#x5BA2;&#x6237;&#x7AEF;&#x3002;</span><br><span class="line"></span><br><span class="line">&#x67E5;&#x627E;&#x60A8;&#x7684;&#x79C1;&#x6709;&#x5BC6;&#x94A5;&#x6587;&#x4EF6;&#x3002;&#x7528;&#x4E8E;&#x542F;&#x52A8;&#x6B64;&#x5B9E;&#x4F8B;&#x7684;&#x5BC6;&#x94A5;&#x4E3A; web-nginx-rsa-pair.pem</span><br><span class="line"></span><br><span class="line">&#x5982;&#x6709;&#x9700;&#x8981;&#xFF0C;&#x8FD0;&#x884C;&#x6B64;&#x547D;&#x4EE4;&#xFF0C;&#x4EE5;&#x786E;&#x4FDD;&#x60A8;&#x7684;&#x5BC6;&#x94A5;&#x4E0D;&#x516C;&#x5F00;&#x53EF;&#x89C1;&#x3002;</span><br><span class="line"> chmod 400 web-nginx-rsa-pair.pem</span><br><span class="line"></span><br><span class="line">&#x901A;&#x8FC7;&#x5176; &#x516C;&#x6709; DNS &#x8FDE;&#x63A5;&#x5230;&#x60A8;&#x7684;&#x5B9E;&#x4F8B;:</span><br><span class="line"> ec2-43-198-199-170.ap-east-1.compute.amazonaws.com</span><br><span class="line"></span><br><span class="line">&#x793A;&#x4F8B;:</span><br><span class="line"></span><br><span class="line"> ssh -i &quot;web-nginx-rsa-pair.pem&quot; ec2-user@ec2-43-198-199-170.ap-east-1.compute.amazonaws.com</span><br></pre></td></tr></table></figure><h4 id="1-&#x4E2A;&#x4EBA;&#x5F00;&#x53D1;MacOS&#x4E0A;&#xFF1A;"><a href="#1-&#x4E2A;&#x4EBA;&#x5F00;&#x53D1;MacOS&#x4E0A;&#xFF1A;" class="headerlink" title="1.&#x4E2A;&#x4EBA;&#x5F00;&#x53D1;MacOS&#x4E0A;&#xFF1A;"></a>1.&#x4E2A;&#x4EBA;&#x5F00;&#x53D1;MacOS&#x4E0A;&#xFF1A;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /Users/xiexugang127580/myprojects/aws/uat/mta-swappie</span><br><span class="line"></span><br><span class="line">chmod 400 web-nginx-rsa-pair.pem</span><br><span class="line"></span><br><span class="line">//&#x4E34;&#x65F6;&#x65B9;&#x6848;&#xFF0C;&#x56E0;&#x4E3A;&#x57DF;&#x540D;&#x4F1A;&#x53D8;&#xFF0C;&#x540E;&#x9762;&#x6709;&#x4E86;&#x5F39;&#x6027;IP&#xFF0C;&#x5C31;&#x7528;&#x56FA;&#x5B9A;&#x7684;&#x5F39;&#x6027;IP</span><br><span class="line">ssh -i &quot;web-nginx-rsa-pair.pem&quot; ec2-user@ec2-43-198-199-170.ap-east-1.compute.amazonaws.com</span><br></pre></td></tr></table></figure><h4 id="2-&#x7528;&#x5F39;&#x6027;IP-&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x8FDE;&#x63A5;&#xFF1A;"><a href="#2-&#x7528;&#x5F39;&#x6027;IP-&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x8FDE;&#x63A5;&#xFF1A;" class="headerlink" title="2.&#x7528;&#x5F39;&#x6027;IP &#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x8FDE;&#x63A5;&#xFF1A;"></a>2.&#x7528;&#x5F39;&#x6027;IP &#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x8FDE;&#x63A5;&#xFF1A;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /Users/xiexugang127580/myprojects/aws/uat/mta-swappie</span><br><span class="line"></span><br><span class="line">ssh -i &quot;web-nginx-rsa-pair.pem&quot; ec2-user@18.163.150.205</span><br></pre></td></tr></table></figure><h3 id="&#x66F4;&#x6539;&#x670D;&#x52A1;&#x5668;&#x5B9E;&#x4F8B;&#x65F6;&#x533A;"><a href="#&#x66F4;&#x6539;&#x670D;&#x52A1;&#x5668;&#x5B9E;&#x4F8B;&#x65F6;&#x533A;" class="headerlink" title="&#x66F4;&#x6539;&#x670D;&#x52A1;&#x5668;&#x5B9E;&#x4F8B;&#x65F6;&#x533A;"></a>&#x66F4;&#x6539;&#x670D;&#x52A1;&#x5668;&#x5B9E;&#x4F8B;&#x65F6;&#x533A;</h3><p>&#x7528;&#x4EE5;&#x4E0A;&#x5F39;&#x6027;IP &#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x8FDE;&#x63A5;&#x540E;&#xFF0C;&#x66F4;&#x6539;&#x670D;&#x52A1;&#x5668;&#x65F6;&#x533A;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sudo -i</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">date</span></span></span><br><span class="line">2023&#x5E74; 07&#x6708; 21&#x65E5; &#x661F;&#x671F;&#x4E94; 01:49:28 UTC</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">timedatectl</span></span><br><span class="line">      Local time: &#x4E94; 2023-07-21 01:50:49 UTC</span><br><span class="line">  Universal time: &#x4E94; 2023-07-21 01:50:49 UTC</span><br><span class="line">        RTC time: &#x4E94; 2023-07-21 01:50:50</span><br><span class="line">       Time zone: n/a (UTC, +0000)</span><br><span class="line">     NTP enabled: yes</span><br><span class="line">NTP synchronized: yes</span><br><span class="line"> RTC in local TZ: no</span><br><span class="line">      DST active: n/a</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">timedatectl set-timezone Asia/Shanghai</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">timedatectl</span></span><br><span class="line">      Local time: &#x4E94; 2023-07-21 09:51:26 CST</span><br><span class="line">  Universal time: &#x4E94; 2023-07-21 01:51:26 UTC</span><br><span class="line">        RTC time: &#x4E94; 2023-07-21 01:51:26</span><br><span class="line">       Time zone: Asia/Shanghai (CST, +0800)</span><br><span class="line">     NTP enabled: yes</span><br><span class="line">NTP synchronized: yes</span><br><span class="line"> RTC in local TZ: no</span><br><span class="line">      DST active: n/a</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">date</span></span></span><br><span class="line">2023&#x5E74; 07&#x6708; 21&#x65E5; &#x661F;&#x671F;&#x4E94; 09:51:43 CST    </span><br></pre></td></tr></table></figure><h3 id="&#x5B89;&#x88C5;nginx"><a href="#&#x5B89;&#x88C5;nginx" class="headerlink" title="&#x5B89;&#x88C5;nginx"></a>&#x5B89;&#x88C5;nginx</h3><p>&#x7528;&#x4EE5;&#x4E0A;&#x5F39;&#x6027;IP &#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x8FDE;&#x63A5;&#x540E;&#xFF0C;&#x5B89;&#x88C5;nginx&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /proc/version</span></span><br><span class="line">Linux version 5.10.184-175.731.amzn2.x86_64 (mockbuild@ip-10-0-58-129) (gcc10-gcc (GCC) 10.4.1 20221124 (Red Hat 10.4.0-1), GNU ld version 2.35.2-9.amzn2.0.1) #1 SMP Tue Jun 27 21:48:55 UTC 2023</span><br><span class="line"></span><br><span class="line">//&#x65E0;&#x5BC6;&#x7801;&#xFF0C;&#x5207;&#x6362;&#x5230;root&#x8D26;&#x6237;</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo -i</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">yum repolist</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">yum install nginx</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl <span class="built_in">enable</span> nginx</span></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.</span><br><span class="line"></span><br><span class="line">//&#x66F4;&#x6539;nginx&#x7684;&#x4E00;&#x4E9B;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vi /etc/nginx/nginx.conf</span></span><br><span class="line"></span><br><span class="line">user  nginx; &#x6539;&#x6210; user  root;</span><br><span class="line"></span><br><span class="line">:wq</span><br><span class="line"></span><br><span class="line">// /usr/share/nginx/html &#x8FD9;&#x4E2A;&#x76EE;&#x5F55;&#x6743;&#x9650;&#x6539;&#x6210;777</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">chmod</span> 777 /usr/share/nginx/html</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl restart nginx</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="&#x9636;&#x6BB5;&#x603B;&#x7ED3;"><a href="#&#x9636;&#x6BB5;&#x603B;&#x7ED3;" class="headerlink" title="&#x9636;&#x6BB5;&#x603B;&#x7ED3;"></a>&#x9636;&#x6BB5;&#x603B;&#x7ED3;</h3><p>1.EC2&#x8282;&#x70B9;&#xFF1A;web-nginx&#x5DF2;&#x7ECF;&#x521B;&#x5EFA;<br>2.nginx&#x5DF2;&#x7ECF;&#x90E8;&#x7F72;&#x5E76;&#x542F;&#x52A8;<br>3.&#x521B;&#x5EFA;&#x4E86;&#x5F39;&#x6027;IP&#xFF1A;<code>18.163.150.205</code>&#xFF0C;&#x5E76;&#x548C;&#x5B9E;&#x4F8B;&#xFF1A;<code>web-nginx</code> &#x5173;&#x8054;<br>4.&#x6D4F;&#x89C8;&#x5668;&#x91CC;&#x8BBF;&#x95EE;nginx&#x9ED8;&#x8BA4;&#x9875;&#x9762;&#xFF1A;<code>http://18.163.150.205</code><br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/ec2.web-nginx-80.access.png"></p><h3 id="&#x7F16;&#x5199;shell&#x811A;&#x672C;&#xFF1A;&#x65E0;&#x5BC6;&#x7801;&#x4E0A;&#x4F20;&#x6587;&#x4EF6;&#x5230;EC2-web-nginx&#x5B9E;&#x4F8B;"><a href="#&#x7F16;&#x5199;shell&#x811A;&#x672C;&#xFF1A;&#x65E0;&#x5BC6;&#x7801;&#x4E0A;&#x4F20;&#x6587;&#x4EF6;&#x5230;EC2-web-nginx&#x5B9E;&#x4F8B;" class="headerlink" title="&#x7F16;&#x5199;shell&#x811A;&#x672C;&#xFF1A;&#x65E0;&#x5BC6;&#x7801;&#x4E0A;&#x4F20;&#x6587;&#x4EF6;&#x5230;EC2: web-nginx&#x5B9E;&#x4F8B;"></a>&#x7F16;&#x5199;shell&#x811A;&#x672C;&#xFF1A;&#x65E0;&#x5BC6;&#x7801;&#x4E0A;&#x4F20;&#x6587;&#x4EF6;&#x5230;EC2: web-nginx&#x5B9E;&#x4F8B;</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cd /Users/xiexugang127580/myprojects/aws/uat/mta-swappie</span><br><span class="line"></span><br><span class="line">//1.&#x8FDC;&#x7A0B;&#x8FDB;&#x5165;EC2</span><br><span class="line">ssh -i &quot;web-nginx-rsa-pair.pem&quot; ec2-user@18.163.150.205</span><br><span class="line"></span><br><span class="line">//2.&#x5207;&#x6362;&#x7528;&#x6237;&#x4E3A;root</span><br><span class="line">sudo -i</span><br><span class="line"></span><br><span class="line">//3.&#x9759;&#x6001;&#x6587;&#x4EF6;&#x5B58;&#x653E;&#x7684;&#x76EE;&#x5F55;&#xFF0C;&#x6743;&#x9650;&#x6539;&#x4E3A;777</span><br><span class="line">chmod 777 /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">//4.&#x7136;&#x540E;&#x9000;&#x51FA;EC2 &#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#xFF0C;&#x8FDB;&#x5165;MacOS&#x7EC8;&#x7AEF;&#xFF1A;</span><br><span class="line">cd /Users/xiexugang127580/myprojects/aws/uat/mta-swappie</span><br><span class="line"></span><br><span class="line">//5.&#x6D4B;&#x8BD5;&#x4E0B;&#x662F;&#x5426;&#x80FD;&#x591F;&#x65E0;&#x5BC6;&#x7801;&#xFF0C;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#xFF0C;&#x5E76;&#x4E0A;&#x4F20;&#x6587;&#x4EF6;</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">bash remote-access.sh</span></span><br><span class="line">ec2-user</span><br><span class="line">/home/ec2-user</span><br><span class="line">&#x603B;&#x7528;&#x91CF; 8</span><br><span class="line">drwxrwxrwx 2 root root  40 7&#x6708;  19 08:20 .</span><br><span class="line">drwxr-xr-x 3 root root  18 7&#x6708;  19 08:20 ..</span><br><span class="line">-rw-r--r-- 1 root root 497 4&#x6708;  11 17:22 50x.html</span><br><span class="line">-rw-r--r-- 1 root root 615 4&#x6708;  11 17:22 index.html</span><br><span class="line">ec2.web-nginx.1.png                                                                                                 100%  216KB   1.0MB/s   00:00    </span><br><span class="line">Upload successfully</span><br></pre></td></tr></table></figure><p>remote-access.sh &#x5185;&#x5BB9;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">REMOTE_USERNAME=ec2-user</span><br><span class="line">REMOTE_IP=18.163.150.205</span><br><span class="line">HTML_DIR=/usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">cd /Users/xiexugang127580/myprojects/aws/uat/mta-swappie</span><br><span class="line"></span><br><span class="line">ssh -i &quot;web-nginx-rsa-pair.pem&quot; ${REMOTE_USERNAME}@${REMOTE_IP} -o &quot;StrictHostKeyChecking no&quot; &quot;whoami; pwd; ls -al /${HTML_DIR}&quot;</span><br><span class="line"></span><br><span class="line">scp -i &quot;web-nginx-rsa-pair.pem&quot; ./ec2.web-nginx.1.png ${REMOTE_USERNAME}@${REMOTE_IP}:${HTML_DIR}</span><br><span class="line"></span><br><span class="line">echo &quot;Upload successfully&quot;</span><br></pre></td></tr></table></figure><h3 id="nginx&#x914D;&#x7F6E;&#x57DF;&#x540D;"><a href="#nginx&#x914D;&#x7F6E;&#x57DF;&#x540D;" class="headerlink" title="nginx&#x914D;&#x7F6E;&#x57DF;&#x540D;"></a>nginx&#x914D;&#x7F6E;&#x57DF;&#x540D;</h3><p>&#x4E8C;&#x7EA7;&#x57DF;&#x540D;&#xFF1A;<code>uat-mta-swappie.ahsdevice.com</code> A Record: <code>18.163.150.205</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cd /Users/xiexugang127580/myprojects/aws/uat/mta-swappie</span><br><span class="line"></span><br><span class="line">//1.&#x8FDC;&#x7A0B;&#x8FDB;&#x5165;EC2</span><br><span class="line">ssh -i &quot;web-nginx-rsa-pair.pem&quot; ec2-user@18.163.150.205</span><br><span class="line"></span><br><span class="line">sudo -i</span><br><span class="line"></span><br><span class="line">cd /etc/nginx/conf.d</span><br><span class="line"></span><br><span class="line">touch uat-mta-swappie.conf</span><br><span class="line"></span><br><span class="line">vi uat-mta-swappie.conf</span><br><span class="line">&#x52A0;&#x5165;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#xFF0C;:wq &#x4FDD;&#x5B58;</span><br><span class="line"></span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><p>uat-mta-swappie.conf &#x5185;&#x5BB9;&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server {</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  uat-mta-swappie.ahsdevice.com;</span><br><span class="line"></span><br><span class="line">    location / {</span><br><span class="line">        root   /usr/share/nginx/html/swappie;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        try_files $uri $uri/ /index.html;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html {</span><br><span class="line">        root   /usr/share/nginx/html/swappie;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="&#x521B;&#x5EFA;LB-uat-mta-web-lb"><a href="#&#x521B;&#x5EFA;LB-uat-mta-web-lb" class="headerlink" title="&#x521B;&#x5EFA;LB: uat-mta-web-lb"></a>&#x521B;&#x5EFA;LB: uat-mta-web-lb</h3><h4 id="1-&#x624B;&#x52A8;&#x521B;&#x5EFA;&#x6B65;&#x9AA4;"><a href="#1-&#x624B;&#x52A8;&#x521B;&#x5EFA;&#x6B65;&#x9AA4;" class="headerlink" title="1.&#x624B;&#x52A8;&#x521B;&#x5EFA;&#x6B65;&#x9AA4;"></a>1.&#x624B;&#x52A8;&#x521B;&#x5EFA;&#x6B65;&#x9AA4;</h4><ol><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/uat-mta-web-lb.1.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/uat-mta-web-lb.2.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/uat-mta-web-lb.3.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/uat-mta-web-lb.4.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/uat-mta-web-lb.5.png"></p></li></ol><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/uat-mta-web-lb.5.1.png"></p><ol start="6"><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/uat-mta-web-lb.6.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/uat-mta-web-lb.7.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/uat-mta-web-lb.8.png"></p></li></ol><h4 id="2-&#x914D;&#x7F6E;HTTP&#x91CD;&#x5B9A;&#x5411;&#x5230;HTTPS"><a href="#2-&#x914D;&#x7F6E;HTTP&#x91CD;&#x5B9A;&#x5411;&#x5230;HTTPS" class="headerlink" title="2.&#x914D;&#x7F6E;HTTP&#x91CD;&#x5B9A;&#x5411;&#x5230;HTTPS"></a>2.&#x914D;&#x7F6E;HTTP&#x91CD;&#x5B9A;&#x5411;&#x5230;HTTPS</h4><ol><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/http-https.1.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/http-https.2.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-ec2-nginx/http-https.3.png"></p></li></ol><h2 id="7-&#x521B;&#x5EFA;-xxl-job-&#x5B9E;&#x4F8B;"><a href="#7-&#x521B;&#x5EFA;-xxl-job-&#x5B9E;&#x4F8B;" class="headerlink" title="7.&#x521B;&#x5EFA; xxl-job &#x5B9E;&#x4F8B;"></a>7.&#x521B;&#x5EFA; xxl-job &#x5B9E;&#x4F8B;</h2><h3 id="1-&#x624B;&#x52A8;&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;&#x6B65;&#x9AA4;"><a href="#1-&#x624B;&#x52A8;&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;&#x6B65;&#x9AA4;" class="headerlink" title="1.&#x624B;&#x52A8;&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;&#x6B65;&#x9AA4;"></a>1.&#x624B;&#x52A8;&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;&#x6B65;&#x9AA4;</h3><ol><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/ws-uat-ec2-xxl-job/xxl-job.1.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/ws-uat-ec2-xxl-job/xxl-job.2.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/ws-uat-ec2-xxl-job/xxl-job.3.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/ws-uat-ec2-xxl-job/xxl-job.4.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/ws-uat-ec2-xxl-job/xxl-job.5.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/ws-uat-ec2-xxl-job/xxl-job.6.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/ws-uat-ec2-xxl-job/xxl-job.7.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/ws-uat-ec2-xxl-job/xxl-job.8.png"></p></li></ol><h3 id="2-&#x4E3A;-EC2-xxl-job-instance-&#x5206;&#x914D;&#x5F39;&#x6027;IP"><a href="#2-&#x4E3A;-EC2-xxl-job-instance-&#x5206;&#x914D;&#x5F39;&#x6027;IP" class="headerlink" title="2.&#x4E3A; EC2: xxl-job-instance &#x5206;&#x914D;&#x5F39;&#x6027;IP"></a>2.&#x4E3A; EC2: xxl-job-instance &#x5206;&#x914D;&#x5F39;&#x6027;IP</h3><p>&#x56FE;&#x7565;</p><p>&#x5F97;&#x5230;&#x5F39;&#x6027;IP&#xFF1A;??.???.???.?</p><h3 id="3-&#x5F39;&#x6027;IP&#x548C;EC2-xxl-job-instance&#x5B9E;&#x4F8B;&#x5173;&#x8054;"><a href="#3-&#x5F39;&#x6027;IP&#x548C;EC2-xxl-job-instance&#x5B9E;&#x4F8B;&#x5173;&#x8054;" class="headerlink" title="3.&#x5F39;&#x6027;IP&#x548C;EC2:xxl-job-instance&#x5B9E;&#x4F8B;&#x5173;&#x8054;"></a>3.&#x5F39;&#x6027;IP&#x548C;EC2:xxl-job-instance&#x5B9E;&#x4F8B;&#x5173;&#x8054;</h3><p>&#x56FE;&#x7565;</p><p>&#x5F39;&#x6027;IP&#xFF1A;<code>??.???.???.?</code> &#x548C; EC2&#x5B9E;&#x4F8B;&#xFF1A;<code>xxl-job-instance</code> &#x5173;&#x8054;&#x4E86;&#x540E;&#xFF0C;ping &#x4E0B;&#x8BD5;&#x8BD5;&#xFF1A;&#x3000;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">% </span><span class="language-bash">ping ??.???.???.?</span></span><br><span class="line">PING ??.???.???.? (??.???.???.?): 56 data bytes</span><br><span class="line">64 bytes from ??.???.???.?: icmp_seq=0 ttl=235 time=52.455 ms</span><br><span class="line">64 bytes from ??.???.???.?: icmp_seq=1 ttl=235 time=32.616 ms</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="4-&#x4F7F;&#x7528;&#x5F39;&#x6027;IP&#xFF0C;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;EC2-xxl-job-instance&#x5B9E;&#x4F8B;"><a href="#4-&#x4F7F;&#x7528;&#x5F39;&#x6027;IP&#xFF0C;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;EC2-xxl-job-instance&#x5B9E;&#x4F8B;" class="headerlink" title="4.&#x4F7F;&#x7528;&#x5F39;&#x6027;IP&#xFF0C;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;EC2:xxl-job-instance&#x5B9E;&#x4F8B;"></a>4.&#x4F7F;&#x7528;&#x5F39;&#x6027;IP&#xFF0C;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;EC2:xxl-job-instance&#x5B9E;&#x4F8B;</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /Users/xiexugang127580/myprojects/aws/uat/mta-swappie</span><br><span class="line"></span><br><span class="line">chmod 400 xxl-job-rsa-pair.pem</span><br><span class="line"></span><br><span class="line">ssh -i &quot;xxl-job-rsa-pair.pem&quot; ec2-user@??.???.???.?</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="5-&#x66F4;&#x6539;&#x670D;&#x52A1;&#x5668;&#x5B9E;&#x4F8B;&#x65F6;&#x533A;"><a href="#5-&#x66F4;&#x6539;&#x670D;&#x52A1;&#x5668;&#x5B9E;&#x4F8B;&#x65F6;&#x533A;" class="headerlink" title="5.&#x66F4;&#x6539;&#x670D;&#x52A1;&#x5668;&#x5B9E;&#x4F8B;&#x65F6;&#x533A;"></a>5.&#x66F4;&#x6539;&#x670D;&#x52A1;&#x5668;&#x5B9E;&#x4F8B;&#x65F6;&#x533A;</h3><p>&#x7528;&#x4EE5;&#x4E0A;&#x5F39;&#x6027;IP &#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x8FDE;&#x63A5;&#x540E;&#xFF0C;&#x66F4;&#x6539;&#x670D;&#x52A1;&#x5668;&#x65F6;&#x533A;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">date</span></span></span><br><span class="line">2023&#x5E74; 07&#x6708; 21&#x65E5; &#x661F;&#x671F;&#x4E94; 01:49:28 UTC</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">timedatectl</span></span><br><span class="line">      Local time: &#x4E94; 2023-07-21 01:50:49 UTC</span><br><span class="line">  Universal time: &#x4E94; 2023-07-21 01:50:49 UTC</span><br><span class="line">        RTC time: &#x4E94; 2023-07-21 01:50:50</span><br><span class="line">       Time zone: n/a (UTC, +0000)</span><br><span class="line">     NTP enabled: yes</span><br><span class="line">NTP synchronized: yes</span><br><span class="line"> RTC in local TZ: no</span><br><span class="line">      DST active: n/a</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">timedatectl set-timezone Asia/Shanghai</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">timedatectl</span></span><br><span class="line">      Local time: &#x4E94; 2023-07-21 09:51:26 CST</span><br><span class="line">  Universal time: &#x4E94; 2023-07-21 01:51:26 UTC</span><br><span class="line">        RTC time: &#x4E94; 2023-07-21 01:51:26</span><br><span class="line">       Time zone: Asia/Shanghai (CST, +0800)</span><br><span class="line">     NTP enabled: yes</span><br><span class="line">NTP synchronized: yes</span><br><span class="line"> RTC in local TZ: no</span><br><span class="line">      DST active: n/a</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">date</span></span></span><br><span class="line">2023&#x5E74; 07&#x6708; 21&#x65E5; &#x661F;&#x671F;&#x4E94; 09:51:43 CST</span><br></pre></td></tr></table></figure><h3 id="6-&#x5728;EC2-xxl-job-instance-&#x4E0A;&#xFF0C;&#x90E8;&#x7F72;tomcat-&#x548C;-xxl-job-admin-war&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x5F00;&#x673A;&#x81EA;&#x542F;&#x52A8;"><a href="#6-&#x5728;EC2-xxl-job-instance-&#x4E0A;&#xFF0C;&#x90E8;&#x7F72;tomcat-&#x548C;-xxl-job-admin-war&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x5F00;&#x673A;&#x81EA;&#x542F;&#x52A8;" class="headerlink" title="6.&#x5728;EC2: xxl-job-instance &#x4E0A;&#xFF0C;&#x90E8;&#x7F72;tomcat &#x548C; xxl-job-admin.war&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x5F00;&#x673A;&#x81EA;&#x542F;&#x52A8;"></a>6.&#x5728;EC2: xxl-job-instance &#x4E0A;&#xFF0C;&#x90E8;&#x7F72;tomcat &#x548C; xxl-job-admin.war&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x5F00;&#x673A;&#x81EA;&#x542F;&#x52A8;</h3><h4 id="1-&#x4E0A;&#x4F20;tomcat&#x3001;war&#x5230;EC2&#x5B9E;&#x4F8B;"><a href="#1-&#x4E0A;&#x4F20;tomcat&#x3001;war&#x5230;EC2&#x5B9E;&#x4F8B;" class="headerlink" title="1.&#x4E0A;&#x4F20;tomcat&#x3001;war&#x5230;EC2&#x5B9E;&#x4F8B;"></a>1.&#x4E0A;&#x4F20;tomcat&#x3001;war&#x5230;EC2&#x5B9E;&#x4F8B;</h4><p>MacOS&#x4E0A;&#xFF0C;&#x76EE;&#x5F55;&#xFF1A;<code>/Users/xiexugang127580/myprojects/aws/uat/mta-swappie</code>&#x4E0B;&#xFF0C;<br>&#x51C6;&#x5907;&#xFF1A;<code>apache-tomcat-8.5.86.zip</code>&#x3001;<code>jdk-8u202-linux-x64.tar.gz</code>&#x3001;<code>xxl-job-admin.war</code></p><p>upload-xxl-job.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">REMOTE_USERNAME=ec2-user</span><br><span class="line">REMOTE_IP=??.???.???.?</span><br><span class="line">APP_DIR=/app</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MacOS&#x4E0A;&#xFF0C;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#xFF1A;ssh -i <span class="string">&quot;xxl-job-rsa-pair.pem&quot;</span> ec2-user@??.???.???.?</span></span><br><span class="line">cd /Users/xiexugang127580/myprojects/aws/uat/mta-swappie</span><br><span class="line"></span><br><span class="line">ssh -i &quot;xxl-job-rsa-pair.pem&quot; ${REMOTE_USERNAME}@${REMOTE_IP} -o &quot;StrictHostKeyChecking no&quot; &quot;whoami; pwd; ls -al /app;&quot;</span><br><span class="line"></span><br><span class="line">scp -i &quot;xxl-job-rsa-pair.pem&quot; ./jdk-8u202-linux-x64.tar.gz ${REMOTE_USERNAME}@${REMOTE_IP}:${APP_DIR}</span><br><span class="line"></span><br><span class="line">scp -i &quot;xxl-job-rsa-pair.pem&quot; ./apache-tomcat-8.5.86.zip ${REMOTE_USERNAME}@${REMOTE_IP}:${APP_DIR}</span><br><span class="line"></span><br><span class="line">scp -i &quot;xxl-job-rsa-pair.pem&quot; .//xxl-job-1.9.1-uat/xxl-job-admin/target/xxl-job-admin.war ${REMOTE_USERNAME}@${REMOTE_IP}:${APP_DIR}</span><br></pre></td></tr></table></figure><p>&#x6267;&#x884C;&#x5B8C;&#x6BD5;<code>upload-xxl-job.sh</code>&#xFF0C;&#x4E0A;&#x4F20;&#x6587;&#x4EF6;&#x5B8C;&#x6BD5;&#x540E;&#xFF0C;&#x8FDB;&#x5165;EC2&#xFF1A;<br><code>ssh -i &quot;xxl-job-rsa-pair.pem&quot; ec2-user@??.???.???.?</code><br><code>sudo -i</code> //&#x5207;&#x6362;&#x6210;root&#x7528;&#x6237;&#x64CD;&#x4F5C;</p><h4 id="2-&#x914D;&#x7F6E;jdk"><a href="#2-&#x914D;&#x7F6E;jdk" class="headerlink" title="2.&#x914D;&#x7F6E;jdk"></a>2.&#x914D;&#x7F6E;jdk</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sudo -i</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">chown</span> -R root:root /app</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">chmod</span> -R 755 /app</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /app</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tar -zxvf jdk-8u202-linux-x64.tar.gz</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vi /etc/profile</span></span><br><span class="line"></span><br><span class="line">&#x672B;&#x5C3E;&#x52A0;&#x4E0A;&#xFF1A;</span><br><span class="line">JAVA_HOME=/app/jdk1.8.0_202</span><br><span class="line">JRE_HOME=$JAVA_HOME/jre</span><br><span class="line">PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin</span><br><span class="line">export JAVA_HOME JRE_HOME PATH</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">source</span> /etc/profile</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">java -version</span></span><br><span class="line">java version &quot;1.8.0_202&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_202-b08)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.202-b08, mixed mode)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="3-&#x914D;&#x7F6E;tomcat"><a href="#3-&#x914D;&#x7F6E;tomcat" class="headerlink" title="3.&#x914D;&#x7F6E;tomcat"></a>3.&#x914D;&#x7F6E;tomcat</h4><p>&#x89E3;&#x538B;tomcat&#xFF0C;&#x5C06; <code>xxl-job-admin.war</code> &#x90E8;&#x7F72;&#x5230;webapps&#x4E0B;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /app</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">unzip apache-tomcat-8.5.86.zip</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mv</span> apache-tomcat-8.5.86 tomcat</span></span><br></pre></td></tr></table></figure><p>&#x5728;<code>catalina.sh</code>&#x4E2D;&#x52A0;&#x5165;<code>JAVA_HOME</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> tomcat/bin</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vi catalina.sh</span></span><br><span class="line">&#x7B2C;3&#x884C;&#xFF0C;&#x52A0;&#x5165;&#xFF1A;</span><br><span class="line"></span><br><span class="line">export JAVA_HOME=/app/jdk1.8.0_202</span><br><span class="line"></span><br><span class="line">:wq</span><br></pre></td></tr></table></figure><p>&#x8BBE;&#x7F6E;&#x5F00;&#x673A;&#x81EA;&#x542F;&#x52A8;:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vi /etc/systemd/system/tomcat.service</span></span><br><span class="line"></span><br><span class="line">&#x52A0;&#x5165;&#xFF1A;</span><br><span class="line">[Unit]</span><br><span class="line">Description=Tomcat8.5</span><br><span class="line">After=syslog.target network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">ExecStart=/app/tomcat/bin/startup.sh</span><br><span class="line">ExecStop=/app/tomcat/bin/shutdown.sh</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">RemainAfterExit=yes</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>&#x7136;&#x540E;&#x6267;&#x884C;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable tomcat</span><br><span class="line"></span><br><span class="line">chmod -R 755 tomcat</span><br><span class="line"></span><br><span class="line">systemctl start tomcat</span><br><span class="line">systemctl status tomcat</span><br></pre></td></tr></table></figure><p>&#x6D4F;&#x89C8;&#x5668;&#x9A8C;&#x8BC1;&#xFF1A;<code>http://??.???.???.?:8080</code></p><p>&#x90E8;&#x7F72; <code>xxl-job-admin</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop tomcat</span><br><span class="line">rm -rf /app/tomcat/webapps/*</span><br><span class="line"></span><br><span class="line">cp /app/xxl-job-admin.war /app/tomcat/webapps/</span><br><span class="line"></span><br><span class="line">chmod -R 755 tomcat</span><br><span class="line"></span><br><span class="line">systemctl start tomcat</span><br><span class="line"></span><br><span class="line">tail -fn 800 /app/tomcat/logs/catalina.out</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>xxl-job-admin &#x63A7;&#x5236;&#x53F0;&#xFF1A;<br><code>http://??.???.???.?:8080/xxl-job-admin</code><br><code>admin / 123456</code></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/ws-uat-ec2-xxl-job/xxl-job-admin.1.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/ws-uat-ec2-xxl-job/xxl-job-admin2.png"></p><h2 id="8-&#x90E8;&#x7F72;&#x5355;&#x8282;&#x70B9;RDS-mysql-5-7"><a href="#8-&#x90E8;&#x7F72;&#x5355;&#x8282;&#x70B9;RDS-mysql-5-7" class="headerlink" title="8.&#x90E8;&#x7F72;&#x5355;&#x8282;&#x70B9;RDS (mysql-5.7)"></a>8.&#x90E8;&#x7F72;&#x5355;&#x8282;&#x70B9;RDS (mysql-5.7)</h2><h3 id="&#x524D;&#x63D0;&#x51C6;&#x5907;&#xFF1A;"><a href="#&#x524D;&#x63D0;&#x51C6;&#x5907;&#xFF1A;" class="headerlink" title="&#x524D;&#x63D0;&#x51C6;&#x5907;&#xFF1A;"></a>&#x524D;&#x63D0;&#x51C6;&#x5907;&#xFF1A;</h3><h4 id="1-&#x521B;&#x5EFA;&#x53C2;&#x6570;&#x7EC4;"><a href="#1-&#x521B;&#x5EFA;&#x53C2;&#x6570;&#x7EC4;" class="headerlink" title="1.&#x521B;&#x5EFA;&#x53C2;&#x6570;&#x7EC4;"></a>1.&#x521B;&#x5EFA;&#x53C2;&#x6570;&#x7EC4;</h4><p>&#x8FDB;&#x5165;AWS RDS &#x7684;&#x63A7;&#x5236;&#x9762;&#x677F;&#x9875;&#x9762;&#xFF0C;&#x627E;&#x5230;&#x53C2;&#x6570;&#x7EC4;&#xFF0C;&#x8FDB;&#x5165;&#x53C2;&#x6570;&#x7EC4;&#x9875;&#x9762;&#xFF0C;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x81EA;&#x5B9A;&#x4E49;&#x53C2;&#x6570;&#x7EC4;&#xFF1A;<code>mysql57-parameter-group</code>&#xFF0C;&#x7CFB;&#x5217;&#xFF1A;<code>mysql5.7</code>&#xFF0C;&#x7C7B;&#x578B;&#x548C;&#x63CF;&#x8FF0;&#x968F;&#x4FBF;&#x5199;&#x3002;<br>&#x65B0;&#x5EFA;&#x5B8C;&#x6BD5;&#x540E;&#xFF0C;&#x70B9;&#x51FB;&#x8FD9;&#x4E2A;&#x81EA;&#x5B9A;&#x4E49;&#x53C2;&#x6570;&#x7EC4;&#xFF0C;&#x5728;&#x53C2;&#x6570;&#x91CC;&#x627E;&#x5230;&#xFF1A;<br>1.<code>tx_isolation</code>&#xFF0C;&#x503C;&#x4FEE;&#x6539;&#x4E3A;&#xFF1A;<code>READ-COMMITTED</code><br>2.<code>max_allowed_packet</code>&#xFF0C;&#x503C;&#x4FEE;&#x6539;&#x4E3A;&#xFF1A;<code>33554432</code><br>3.<code>time_zone</code>&#xFF0C;&#x503C;&#x4FEE;&#x6539;&#x4E3A;&#xFF1A;<code>Asia/Shanghai</code></p><blockquote><p>&#x5982;&#x679C;&#x65B0;&#x5EFA;&#x4E86;&#x53C2;&#x6570;&#x7EC4;&#xFF0C;&#x91CC;&#x9762;&#x6709;&#x90E8;&#x5206;&#x53C2;&#x6570;&#x5FD8;&#x8BB0;&#x8BBE;&#x7F6E;&#x4E86;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;mysql&#x5B9E;&#x4F8B;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#x540E;&#xFF0C;&#x8FDB;&#x5165;&#x53C2;&#x6570;&#x7EC4;&#x66F4;&#x6539;&#xFF0C;&#x66F4;&#x6539;&#x5B8C;&#x6BD5;&#x540E;&#xFF0C;&#x91CD;&#x542F;&#x4E0B;mysql&#x5B9E;&#x4F8B;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;</p></blockquote><p>mysql&#x5B9E;&#x4F8B;&#x5DF2;&#x7ECF;&#x521B;&#x5EFA;&#x597D;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8FDB;&#x5165;&#x53C2;&#x6570;&#x7EC4;&#x66F4;&#x6539;&#xFF1A;</p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.21-%E8%AE%BE%E7%BD%AEisolation.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.22-%E8%AE%BE%E7%BD%AEisolation.2.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.23-%E8%AE%BE%E7%BD%AEisolation.3.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.24-%E8%AE%BE%E7%BD%AEisolation.4.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.25.png"></p><h4 id="2-&#x521B;&#x5EFA;VPC&#x5B89;&#x5168;&#x7EC4;"><a href="#2-&#x521B;&#x5EFA;VPC&#x5B89;&#x5168;&#x7EC4;" class="headerlink" title="2.&#x521B;&#x5EFA;VPC&#x5B89;&#x5168;&#x7EC4;"></a>2.&#x521B;&#x5EFA;VPC&#x5B89;&#x5168;&#x7EC4;</h4><p>&#x8FDB;&#x5165;&#x7F51;&#x8DEF;&#x4E0E;&#x5B89;&#x5168;&#x2013;&#x5B89;&#x5168;&#x7EC4;&#xFF0C;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x5B89;&#x5168;&#x7EC4;&#xFF1A;ahsOffice&#xFF0C;&#x65B0;&#x5EFA;3&#x4E2A;&#x5165;&#x7AD9;&#x89C4;&#x5219;&#x548C;1&#x4E2A;&#x51FA;&#x6218;&#x89C4;&#x5219;&#xFF1A;<br>&#x56FE;</p><h4 id="3-&#x65B0;&#x5EFA;&#x6570;&#x636E;&#x5E93;&#x5B9E;&#x4F8B;&#xFF1A;uat-mta"><a href="#3-&#x65B0;&#x5EFA;&#x6570;&#x636E;&#x5E93;&#x5B9E;&#x4F8B;&#xFF1A;uat-mta" class="headerlink" title="3.&#x65B0;&#x5EFA;&#x6570;&#x636E;&#x5E93;&#x5B9E;&#x4F8B;&#xFF1A;uat-mta"></a>3.&#x65B0;&#x5EFA;&#x6570;&#x636E;&#x5E93;&#x5B9E;&#x4F8B;&#xFF1A;uat-mta</h4><ol><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.1.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.2.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.3.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.4.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.5.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.6.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.7.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.8.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.9.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.10.png"></p></li></ol><p>11.&#x6570;&#x636E;&#x5E93;&#x53C2;&#x6570;&#x7EC4;&#xFF0C;&#x8FD9;&#x91CC;&#x8981;&#x9009;&#x62E9;&#x4E8B;&#x5148;&#x521B;&#x5EFA;&#x597D;&#x7684;&#xFF1A;<code>mysql57-parameter-group</code>&#xFF0C;&#x622A;&#x56FE;&#x91CC;&#x7684;&#x6CA1;&#x9009;&#x62E9;&#x597D;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.11.png"></p><ol start="12"><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.12.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.13.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.14.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.15.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.16.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-rds/rds.20.png"></p></li></ol><h4 id="4-&#x521B;&#x5EFA;&#x5F00;&#x53D1;&#x8D26;&#x53F7;&#x548C;&#x5BC6;&#x7801;&#x3001;&#x521B;&#x5EFA;&#x4E1A;&#x52A1;&#x6570;&#x636E;&#x5E93;&#x548C;&#x5BFC;&#x5165;&#x6570;&#x636E;"><a href="#4-&#x521B;&#x5EFA;&#x5F00;&#x53D1;&#x8D26;&#x53F7;&#x548C;&#x5BC6;&#x7801;&#x3001;&#x521B;&#x5EFA;&#x4E1A;&#x52A1;&#x6570;&#x636E;&#x5E93;&#x548C;&#x5BFC;&#x5165;&#x6570;&#x636E;" class="headerlink" title="4.&#x521B;&#x5EFA;&#x5F00;&#x53D1;&#x8D26;&#x53F7;&#x548C;&#x5BC6;&#x7801;&#x3001;&#x521B;&#x5EFA;&#x4E1A;&#x52A1;&#x6570;&#x636E;&#x5E93;&#x548C;&#x5BFC;&#x5165;&#x6570;&#x636E;"></a>4.&#x521B;&#x5EFA;&#x5F00;&#x53D1;&#x8D26;&#x53F7;&#x548C;&#x5BC6;&#x7801;&#x3001;&#x521B;&#x5EFA;&#x4E1A;&#x52A1;&#x6570;&#x636E;&#x5E93;&#x548C;&#x5BFC;&#x5165;&#x6570;&#x636E;</h4><h5 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h5><p>&#x6570;&#x636E;&#x5E93;&#x5B9E;&#x4F8B;&#xFF1A;uat-mta<br>uat-mta.cocpnpwzmuuo.ap-east-1.rds.amazonaws.com<br>3306<br>root<br>password????</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="variable">@GLOBAL</span>.tx_isolation, @<span class="variable">@tx</span>_isolation;</span><br><span class="line"></span><br><span class="line">@<span class="variable">@GLOBAL</span>.tx_isolation<span class="operator">|</span>@<span class="variable">@tx</span>_isolation<span class="operator">|</span></span><br><span class="line"><span class="comment">---------------------+--------------+</span></span><br><span class="line">READ<span class="operator">-</span>COMMITTED       <span class="operator">|</span>READ<span class="operator">-</span>COMMITTED<span class="operator">|</span></span><br></pre></td></tr></table></figure><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x4E8B;&#x52A1;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x662F; RC &#x4E86;</p><h5 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h5><p>&#x521B;&#x5EFA;&#x6570;&#x636E;&#x5E93;: <code>mta_swappie_uat</code> &#x548C; <code>xxl_job</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE `mta_swappie_uat` <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE `xxl_job` <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci;</span><br></pre></td></tr></table></figure><h5 id="3-&#x521B;&#x5EFA;&#x5F00;&#x53D1;&#x8D26;&#x6237;"><a href="#3-&#x521B;&#x5EFA;&#x5F00;&#x53D1;&#x8D26;&#x6237;" class="headerlink" title="3.&#x521B;&#x5EFA;&#x5F00;&#x53D1;&#x8D26;&#x6237;"></a>3.&#x521B;&#x5EFA;&#x5F00;&#x53D1;&#x8D26;&#x6237;</h5><p>1.&#x4E3A;&#x6570;&#x636E;&#x5E93;&#xFF1A;<code>mta_swappie_uat</code>&#xFF0C;&#x521B;&#x5EFA;&#x7528;&#x6237;&#xFF1A;<code>swappie_uat</code>&#xFF0C;&#x5BC6;&#x7801;&#xFF1A;<code>uat_qwert12345</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&apos;swappie_uat&apos;</span>@<span class="string">&apos;%&apos;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&apos;uat_qwert12345&apos;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span> <span class="keyword">ON</span> mta_swappie_uat.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&apos;swappie_uat&apos;</span>@<span class="string">&apos;%&apos;</span>;</span><br></pre></td></tr></table></figure><p>2.&#x4E3A;&#x6570;&#x636E;&#x5E93;&#xFF1A;<code>xxl_job</code>&#xFF0C;&#x521B;&#x5EFA;&#x7528;&#x6237;&#xFF1A;<code>xxl_job_user</code>&#xFF0C;&#x5BC6;&#x7801;&#xFF1A;<code>xxl_job_user_qwert12345</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &apos;xxl_job_user&apos;@&apos;%&apos; IDENTIFIED BY &apos;xxl_job_user_qwert12345&apos;;</span><br><span class="line">GRANT SELECT, INSERT, UPDATE, DELETE ON xxl_job.* TO &apos;xxl_job_user&apos;@&apos;%&apos;;</span><br></pre></td></tr></table></figure><h5 id="4-&#x4ECE;GCP-UAT&#x73AF;&#x5883;&#xFF0C;&#x5BFC;&#x51FA;&#x6570;&#x636E;&#x5E93;&#xFF1A;"><a href="#4-&#x4ECE;GCP-UAT&#x73AF;&#x5883;&#xFF0C;&#x5BFC;&#x51FA;&#x6570;&#x636E;&#x5E93;&#xFF1A;" class="headerlink" title="4.&#x4ECE;GCP UAT&#x73AF;&#x5883;&#xFF0C;&#x5BFC;&#x51FA;&#x6570;&#x636E;&#x5E93;&#xFF1A;"></a>4.&#x4ECE;GCP UAT&#x73AF;&#x5883;&#xFF0C;&#x5BFC;&#x51FA;&#x6570;&#x636E;&#x5E93;&#xFF1A;</h5><p>1.mta_swappie_uat &#x7684;&#x8868;&#x7ED3;&#x6784;&#x548C;&#x6570;&#x636E;<br>2.xxl_job &#x7684;&#x8868;&#x7ED3;&#x6784;&#x548C;&#x6570;&#x636E;</p><p>&#x7136;&#x540E;&#x5BFC;&#x5165;&#x5230;AWS RDS &#x4E0A;&#x7684;&#x5BF9;&#x5E94;&#x7684;&#x4E24;&#x4E2A;&#x6570;&#x636E;&#x5E93;<br>&#x5728;win10&#x4E0A;&#x64CD;&#x4F5C;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /d C:\Program Files\MySQL\MySQL Server 5.7\bin</span><br><span class="line"></span><br><span class="line">mysql -huat-mta.cocpnpwzmuuo.ap-east-1.rds.amazonaws.com -P3306 -uroot -pZMtDDxtEyomXnpnvc0X3 --default-character-set=utf8mb4 mta_swappie_uat &lt; D:\dev\career\aihuishou\document\GCP&#x8FC1;&#x79FB;&#x5230;AWS\uat\mta_swappie_uat_data_20230720.sql</span><br></pre></td></tr></table></figure><p>&#x51FA;&#x73B0;&#x5982;&#x4E0B;&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 2006 (HY000): MySQL server has gone away</span><br></pre></td></tr></table></figure><p>&#x89E3;&#x51B3;&#x529E;&#x6CD5;&#xFF0C;&#x4FEE;&#x6539;&#x53C2;&#x6570;&#x7EC4;&#xFF1A;<code>mysql57-parameter-group</code>&#xFF0C;&#x627E;&#x5230;&#xFF1A;<code>max_allowed_packet</code>&#xFF0C;&#x503C;&#x4FEE;&#x6539;&#x4E3A;&#xFF1A;<code>33554432</code>&#xFF0C;&#x7136;&#x540E;&#x91CD;&#x542F;MySQL Server&#x5373;&#x53EF;&#x751F;&#x6548;&#x3002;</p><h2 id="9-&#x90E8;&#x7F72;&#x5355;&#x8282;&#x70B9;ElastiCache-redis-5-0"><a href="#9-&#x90E8;&#x7F72;&#x5355;&#x8282;&#x70B9;ElastiCache-redis-5-0" class="headerlink" title="9.&#x90E8;&#x7F72;&#x5355;&#x8282;&#x70B9;ElastiCache (redis-5.0)"></a>9.&#x90E8;&#x7F72;&#x5355;&#x8282;&#x70B9;ElastiCache (redis-5.0)</h2><p>&#x4E0D;&#x7528; <code>Amazon MemoryDB for Redis</code><br>&#x9999;&#x6E2F;MTA&#x7528;&#x7684;&#x662F;&#xFF1A;<code>Amazon ElastiCache for Redis</code>&#xFF0C;&#x8FD9;&#x4E2A;&#x66F4;&#x597D;</p><ol><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-elasticache/redis.1.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-elasticache/redis.2.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-elasticache/redis.3.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-elasticache/redis.4.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-elasticache/redis.5.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-elasticache/redis.6.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-elasticache/redis.7.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-elasticache/redis.8.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-elasticache/redis.9.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-elasticache/redis.10.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D001.Infrastructure-AWS.1.%E5%88%9B%E5%BB%BAEC2%E5%AE%9E%E4%BE%8B%E3%80%81LB%E3%80%81RDS%E3%80%81ElastiCache/aws-uat-elasticache/redis.11.png"></p></li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5B9E;&amp;#x73B0;&amp;#x5728;AWS&amp;#x91CC;&quot;&gt;&lt;a href=&quot;#&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5B9E;&amp;#x73B0;&amp;#x5728;AWS&amp;#x91CC;&quot; class=&quot;headerlink&quot; title=&quot;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5B9E;&amp;#x73B0;&amp;#x5728;AWS&amp;#x91CC;&quot;&gt;&lt;/a&gt;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5B9E;&amp;#x73B0;&amp;#x5728;AWS&amp;#x91CC;&lt;/h2&gt;&lt;p&gt;1.&amp;#x521B;&amp;#x5EFA;EC2&amp;#x5B9E;&amp;#x4F8B;&amp;#xFF0C;&amp;#x90E8;&amp;#x7F72;nginx&amp;#xFF1B;&lt;br&gt;2.&amp;#x521B;&amp;#x5EFA;EC2&amp;#x5B9E;&amp;#x4F8B;&amp;#xFF0C;&amp;#x90E8;&amp;#x7F72;tomcat&amp;#x3001;xxl-job&amp;#xFF1B;&lt;br&gt;3.&amp;#x4E3A;nginx&amp;#x90E8;&amp;#x7F72;LB&amp;#xFF1B;&lt;br&gt;4.&amp;#x90E8;&amp;#x7F72;&amp;#x5355;&amp;#x8282;&amp;#x70B9;RDS (mysql-5.7)&amp;#xFF1B;&lt;br&gt;5.&amp;#x90E8;&amp;#x7F72;&amp;#x5355;&amp;#x8282;&amp;#x70B9;ElastiCache (redis-5.0)&amp;#xFF1B;&lt;/p&gt;</summary>
    
    
    
    <category term="Infrastructure" scheme="http://example.com/categories/Infrastructure/"/>
    
    
    <category term="AWS-EC2" scheme="http://example.com/tags/AWS-EC2/"/>
    
  </entry>
  
  <entry>
    <title>Infrastructure-GCP系列.gitlab-runner实现java微服务CICD--5.GKE-Java微服务编排</title>
    <link href="http://example.com/2023/06/20/18.C001.Infrastructure-GCP%E7%B3%BB%E5%88%97.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/"/>
    <id>http://example.com/2023/06/20/18.C001.Infrastructure-GCP%E7%B3%BB%E5%88%97.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/</id>
    <published>2023-06-19T16:00:00.000Z</published>
    <updated>2023-10-12T11:25:07.586Z</updated>
    
    <content type="html"><![CDATA[<h2 id="&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;GKE&#x91CC;&#xFF1A;"><a href="#&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;GKE&#x91CC;&#xFF1A;" class="headerlink" title="&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;GKE&#x91CC;&#xFF1A;"></a>&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;GKE&#x91CC;&#xFF1A;</h2><ol><li>&#x521B;&#x5EFA; K8&#x96C6;&#x7FA4;&#x548C;&#x8282;&#x70B9;&#xFF08;&#x4E0A;&#x7BC7;&#x5DF2;&#x7ECF;&#x521B;&#x5EFA;&#xFF09;&#xFF0C;&#x521B;&#x5EFA; namespace&#xFF1B;</li><li>&#x521B;&#x5EFA; BackendConfig &#x5E76;&#x751F;&#x6548;&#xFF1B;</li><li>&#x521B;&#x5EFA; service &#x5E76;&#x751F;&#x6548;&#xFF1B;</li><li>&#x521B;&#x5EFA; &#x9759;&#x6001;IP&#x3001;&#x7533;&#x8BF7;&#x57DF;&#x540D;&#x3001;&#x57DF;&#x540D;&#x89E3;&#x6790;&#xFF1B;</li><li>&#x521B;&#x5EFA; &#x6258;&#x7BA1;SSL&#x8BC1;&#x4E66; &#x5E76;&#x751F;&#x6548;&#xFF1B;</li><li>&#x521B;&#x5EFA;&#x5DE5;&#x4F5C;&#x8D1F;&#x8F7D;deployment&#x5E76;&#x751F;&#x6548;;</li><li>&#x521B;&#x5EFA; Ingress&#xFF0C;&#x57DF;&#x540D;&#x548C;SSL&#x8BC1;&#x4E66;&#x7684;&#x7ED1;&#x5B9A;&#xFF0C;&#x6700;&#x7EC8; user-service &#x5C31;&#x80FD;&#x90E8;&#x7F72;&#x6210;&#x529F;&#x4E86;&#xFF1B;</li></ol><span id="more"></span><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><ul><li>GCP Project: <code>atrenew-swappie-prod</code></li><li>&#x76EE;&#x5F55;&#x7ED3;&#x6784;:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/home/gitlab-runner</span><br><span class="line">    |- .bach_profile</span><br><span class="line">    |- .kube</span><br><span class="line">    |- gcp_deploy.groovy</span><br><span class="line">    |- google-cloud-sdk</span><br><span class="line">    |- dockerize</span><br><span class="line">        |- deployment-prod</span><br><span class="line">            |- user-service</span><br><span class="line">                |- Dockerfile-template-MultiEnv</span><br><span class="line">                |- ssl.yaml</span><br><span class="line">                |- ingress.yaml</span><br><span class="line">                |- backend-config.yaml</span><br><span class="line">                |- service-clusterip.yaml</span><br><span class="line">                |- deployment-template.yaml</span><br></pre></td></tr></table></figure></li></ul><h2 id="1-&#x5207;&#x6362;&#x670D;&#x52A1;&#x8D26;&#x53F7;"><a href="#1-&#x5207;&#x6362;&#x670D;&#x52A1;&#x8D26;&#x53F7;" class="headerlink" title="1.&#x5207;&#x6362;&#x670D;&#x52A1;&#x8D26;&#x53F7;"></a>1.&#x5207;&#x6362;&#x670D;&#x52A1;&#x8D26;&#x53F7;</h2><p>&#x4EE5;&#x4E0B;&#x6240;&#x6709;&#x64CD;&#x4F5C;&#xFF0C;&#x90FD;&#x662F;&#x4EE5;gitlab-runner&#x7528;&#x6237;&#x64CD;&#x4F5C;&#x7684;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">su - gitlab-runner</span></span><br></pre></td></tr></table></figure><p>&#x67E5;&#x770B;&#x4E0B;&#x5F53; active &#x7684; account &#x662F;&#x5426;&#x662F; <code>creative-cicd-prod-asia</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gcloud auth list</span></span><br></pre></td></tr></table></figure><p>&#x5982;&#x679C;&#x5F53;&#x524D; active &#x7684; account &#x4E0D;&#x662F;&#xFF1A; <code>creative-cicd-prod-europe@atrenew-swappie-prod.iam.gserviceaccount.com</code>&#xFF0C;&#x5219;&#x9700;&#x8981;&#x5982;&#x4E0B;&#x547D;&#x4EE4;&#x5207;&#x6362;&#x4E0B;&#x8D26;&#x6237;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gcloud config <span class="built_in">set</span> account  creative-cicd-prod-europe@atrenew-swappie-prod.iam.gserviceaccount.com</span></span><br></pre></td></tr></table></figure><h2 id="2-&#x521B;&#x5EFA;Dockerfile&#x6587;&#x4EF6;"><a href="#2-&#x521B;&#x5EFA;Dockerfile&#x6587;&#x4EF6;" class="headerlink" title="2.&#x521B;&#x5EFA;Dockerfile&#x6587;&#x4EF6;"></a>2.&#x521B;&#x5EFA;Dockerfile&#x6587;&#x4EF6;</h2><p>&#x5728;&#x76EE;&#x5F55;&#xFF1A; <code>/home/gitlab-runner/dockerize/deployment-prod/user-service</code> &#x4E0B;&#x521B;&#x5EFA; <code>Dockerfile-template-MultiEnv</code> &#x6587;&#x4EF6;&#xFF0C;&#x5185;&#x5BB9;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span>  /home/gitlab-runner/dockerize/deployment-prod/user-service</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vi Dockerfile-template-MultiEnv</span></span><br></pre></td></tr></table></figure><p>&#x52A0;&#x5165;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#xFF0C;&#x7136;&#x540E; :wq &#x4FDD;&#x5B58;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk:8u332-jre-bullseye</span><br><span class="line"></span><br><span class="line">WORKDIR /usr/src/myapp</span><br><span class="line"></span><br><span class="line">COPY ./target/@@service_jar /usr/src/myapp/</span><br><span class="line"></span><br><span class="line">RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/timezone &amp;&amp; ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;@@service_jar&quot;]</span><br></pre></td></tr></table></figure><h2 id="3-&#x5728;GKE&#x96C6;&#x7FA4;&#x4E2D;&#xFF0C;&#x521B;&#x5EFA;namespace-java-service"><a href="#3-&#x5728;GKE&#x96C6;&#x7FA4;&#x4E2D;&#xFF0C;&#x521B;&#x5EFA;namespace-java-service" class="headerlink" title="3.&#x5728;GKE&#x96C6;&#x7FA4;&#x4E2D;&#xFF0C;&#x521B;&#x5EFA;namespace: java-service"></a>3.&#x5728;GKE&#x96C6;&#x7FA4;&#x4E2D;&#xFF0C;&#x521B;&#x5EFA;namespace: java-service</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl create namespace java-service  --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span></span><br><span class="line">namespace/java-service created</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get namespace --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span></span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   9d</span><br><span class="line">java-service      Active   82s</span><br><span class="line">kube-node-lease   Active   9d</span><br><span class="line">kube-public       Active   9d</span><br><span class="line">kube-system       Active   9d</span><br></pre></td></tr></table></figure><h2 id="4-yaml&#x521B;&#x5EFA;BackendConfig"><a href="#4-yaml&#x521B;&#x5EFA;BackendConfig" class="headerlink" title="4.yaml&#x521B;&#x5EFA;BackendConfig"></a>4.yaml&#x521B;&#x5EFA;BackendConfig</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-prod/user-service</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vi backend-config.yaml</span></span><br></pre></td></tr></table></figure><p>&#x52A0;&#x5165;&#x5185;&#x5BB9;&#xFF1A;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">cloud.google.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">BackendConfig</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">user-service-backendconfig</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">timeoutSec:</span> <span class="number">300</span></span><br></pre></td></tr></table></figure><h2 id="5-BackendConfig&#x6267;&#x884C;&#x5E76;&#x751F;&#x6548;"><a href="#5-BackendConfig&#x6267;&#x884C;&#x5E76;&#x751F;&#x6548;" class="headerlink" title="5.BackendConfig&#x6267;&#x884C;&#x5E76;&#x751F;&#x6548;"></a>5.BackendConfig&#x6267;&#x884C;&#x5E76;&#x751F;&#x6548;</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-prod/user-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl apply -n java-service -f backend-config.yaml --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span></span><br><span class="line">backendconfig.cloud.google.com/user-service-backendconfig created</span><br></pre></td></tr></table></figure><h2 id="6-yaml&#x521B;&#x5EFA;service"><a href="#6-yaml&#x521B;&#x5EFA;service" class="headerlink" title="6.yaml&#x521B;&#x5EFA;service"></a>6.yaml&#x521B;&#x5EFA;service</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> home/gitlab-runner/dockerize/deployment-prod/user-srvcie</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vi service-clusterip.yaml</span></span><br></pre></td></tr></table></figure><p>service-clusterip.yaml&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span>  <span class="comment"># &#x7C7B;&#x578B;&#x4E3A; Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">user-service</span>  <span class="comment"># Service &#x7684;&#x540D;&#x79F0;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">beta.cloud.google.com/backend-config:</span> <span class="string">&apos;{&quot;default&quot;: &quot;user-service-backendconfig&quot;}&apos;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># &#x6807;&#x7B7E;&#x9009;&#x62E9;&#x5668;&#xFF0C;&#x4F1A;&#x548C;&#x4E0A;&#x9762;&#x521B;&#x5EFA;&#x7684; deployment.yaml &#x7684; pod &#x5173;&#x8054;&#x8D77;&#x6765;</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">user-service</span></span><br><span class="line">  <span class="attr">clusterIP:</span>  <span class="comment"># service &#x7684; ip &#x5730;&#x5740;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5199;&#xFF0C;&#x9ED8;&#x8BA4;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;,&#x6CE8;&#x610F;&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x4E0D;&#x80FD;&#x5199;&#xFF0C;&#x6709;&#x4E2A;&#x8303;&#x56F4;&#x7684;&#xFF0C;&#x6211;&#x7684;&#x662F; 172.31.0.0/16</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span> <span class="comment"># &#x7C7B;&#x578B;&#x4E3A; Service &#x7684; ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span>  <span class="comment"># Service &#x7AEF;&#x53E3;&#xFF0C;&#x81EA;&#x5B9A;&#x4E49;</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span> <span class="comment"># pod &#x7AEF;&#x53E3;&#xFF0C;&#x4E0D;&#x5199;&#x9ED8;&#x8BA4;&#x662F; 80</span></span><br></pre></td></tr></table></figure><h2 id="7-service&#x6267;&#x884C;&#x5E76;&#x751F;&#x6548;&#xFF1A;"><a href="#7-service&#x6267;&#x884C;&#x5E76;&#x751F;&#x6548;&#xFF1A;" class="headerlink" title="7.service&#x6267;&#x884C;&#x5E76;&#x751F;&#x6548;&#xFF1A;"></a>7.service&#x6267;&#x884C;&#x5E76;&#x751F;&#x6548;&#xFF1A;</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-prod/user-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl apply -n java-service -f service-clusterip.yaml --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span></span><br><span class="line">service/user-service created</span><br></pre></td></tr></table></figure><p>GCP-GCK&#x91CC;&#x7684;Service&#x770B;&#x4E0B;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/service.1.png"></p><p>&#x76EE;&#x524D;&#x770B;&#x5230;service: user-service&#xFF0C;pod&#x6570;&#x91CF;&#x662F;0</p><h2 id="8-&#x90E8;&#x7F72;GKE-&#x5DE5;&#x4F5C;&#x8D1F;&#x8F7D;deployment"><a href="#8-&#x90E8;&#x7F72;GKE-&#x5DE5;&#x4F5C;&#x8D1F;&#x8F7D;deployment" class="headerlink" title="8.&#x90E8;&#x7F72;GKE-&#x5DE5;&#x4F5C;&#x8D1F;&#x8F7D;deployment:"></a>8.&#x90E8;&#x7F72;GKE-&#x5DE5;&#x4F5C;&#x8D1F;&#x8F7D;deployment:</h2><h3 id="1-&#x6A21;&#x677F;-deployment-template-yaml-&#x5185;&#x5BB9;&#xFF1A;"><a href="#1-&#x6A21;&#x677F;-deployment-template-yaml-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="1.&#x6A21;&#x677F; deployment-template.yaml &#x5185;&#x5BB9;&#xFF1A;"></a>1.&#x6A21;&#x677F; deployment-template.yaml &#x5185;&#x5BB9;&#xFF1A;</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">@@service_name</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="string">@@kube_replicas</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">50</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span><span class="string">%</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">@@service_name</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">@@service_name</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">@@version</span></span><br><span class="line">        <span class="attr">release:</span> <span class="string">normal</span></span><br><span class="line">        <span class="attr">updatedTimestamp:</span> <span class="string">&quot;@@timestamp&quot;</span></span><br><span class="line">        <span class="attr">language:</span> <span class="string">java</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">podAffinityTerm:</span>      </span><br><span class="line">              <span class="attr">labelSelector:</span></span><br><span class="line">                <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">@@service_name</span></span><br><span class="line">              <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">@@service_name</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">@@image</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">lifecycle:</span></span><br><span class="line">            <span class="attr">preStop:</span></span><br><span class="line">              <span class="attr">exec:</span></span><br><span class="line">                <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 30&quot;</span>]</span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">18080</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">28080</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_IP</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_PORT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ENV</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;pro&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PINPOINT_OPTS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;-Xmx2048M -Xms2048M -XX:+PrintHeapAtGC -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:/data/log/@@service_name-gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/data/log/@@service_name.dump -javaagent:/usr/src/myapp/transmittable-thread-local-2.10.2.jar&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CATALINA_OPTS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;-XX:+PrintHeapAtGC -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:/data/log/@@service_name-gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/data/log/$service_name.dump -javaagent:/usr/local/tomcat/transmittable-thread-local-2.10.2.jar&quot;</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">3000m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">3072M</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">300m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">3072M</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/@@service-context/actuator/health</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/@@service-context/actuator/health</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">200</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data/log</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/log/ahs-pods/mount</span></span><br></pre></td></tr></table></figure><p><code>deployment-template.yaml</code> &#x91CC;&#x7684;&#x5F88;&#x591A;&#x53D8;&#x91CF;&#xFF0C;&#x90FD;&#x662F;&#x6839;&#x636E;&#x6BCF;&#x6B21;&#x90E8;&#x7F72;&#x65F6;&#x5019;&#x7684;&#x65F6;&#x95F4;&#x6233;&#xFF0C;&#x5B9E;&#x65F6;&#x53D8;&#x5316;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x8FD9;&#x91CC;&#x4E0D;&#x505A;&#x624B;&#x52A8;&#x66F4;&#x6539;&#x548C;apply&#xFF0C;&#x653E;&#x5728;gitlab CI/CD&#x7684;Groovy&#x811A;&#x672C;&#x91CC;&#x6267;&#x884C;&#x8FD9;&#x4E2A; <code>deployment.yaml</code></p><p>&#x67D0;&#x4E00;&#x6B21;&#x6784;&#x5EFA;&#x5F97;&#x5230;&#x7684;<code>deployment.yaml</code>&#x5185;&#x5BB9;&#xFF1A;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">user-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">50</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span><span class="string">%</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">user-service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">user-service</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">20230504_170126.gcp</span></span><br><span class="line">        <span class="attr">release:</span> <span class="string">normal</span></span><br><span class="line">        <span class="attr">updatedTimestamp:</span> <span class="string">&quot;20231417155&quot;</span></span><br><span class="line">        <span class="attr">language:</span> <span class="string">java</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">podAffinityTerm:</span>      </span><br><span class="line">              <span class="attr">labelSelector:</span></span><br><span class="line">                <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">user-service</span></span><br><span class="line">              <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">user-service</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">europe-west3-docker.pkg.dev/atrenew-swappie-prod/prod/user-service:20230504_170126</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">lifecycle:</span></span><br><span class="line">            <span class="attr">preStop:</span></span><br><span class="line">              <span class="attr">exec:</span></span><br><span class="line">                <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 30&quot;</span>]</span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">18080</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">28080</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_IP</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_PORT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ENV</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;pro&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PINPOINT_OPTS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;-Xmx2048M -Xms2048M -XX:+PrintHeapAtGC -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:/data/log/user-service-gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/data/log/user-service.dump -javaagent:/usr/src/myapp/transmittable-thread-local-2.10.2.jar&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CATALINA_OPTS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;-XX:+PrintHeapAtGC -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:/data/log/user-service-gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/data/log/$service_name.dump -javaagent:/usr/local/tomcat/transmittable-thread-local-2.10.2.jar&quot;</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">3000m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">3072M</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">300m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">3072M</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/user/actuator/health</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/user/actuator/health</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">200</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data/log</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/log/ahs-pods/mount</span></span><br></pre></td></tr></table></figure><h3 id="2-&#x624B;&#x52A8;&#x90E8;&#x7F72;deployment"><a href="#2-&#x624B;&#x52A8;&#x90E8;&#x7F72;deployment" class="headerlink" title="2.&#x624B;&#x52A8;&#x90E8;&#x7F72;deployment"></a>2.&#x624B;&#x52A8;&#x90E8;&#x7F72;deployment</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/builds/DYbAzYGs/0/e-commerce/user-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl apply -f ./target/deployment.yaml --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span></span><br><span class="line">ingress.networking.k8s.io/user-service-backend-ingress configured</span><br><span class="line"></span><br><span class="line">//&#x67E5;&#x770B;&#x4E0B;&#x90E8;&#x7F72;&#x7684;pod&#x6709;&#x6CA1;&#x6709;&#x8FD0;&#x884C;&#x8D77;&#x6765;&#xFF1A;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS      AGE</span><br><span class="line">user-service-7f6b887766-wqxxh   0/1     Running   6 (79s ago)   26m</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="GKE&#x91CC;&#x7684;deployment&#x60C5;&#x51B5;"><a href="#GKE&#x91CC;&#x7684;deployment&#x60C5;&#x51B5;" class="headerlink" title="GKE&#x91CC;&#x7684;deployment&#x60C5;&#x51B5;:"></a>GKE&#x91CC;&#x7684;deployment&#x60C5;&#x51B5;:</h4><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/deployment.1.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/deployment.2.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/deployment.3.png"></p><h2 id="9-&#x90E8;&#x7F72;GKE-ingress"><a href="#9-&#x90E8;&#x7F72;GKE-ingress" class="headerlink" title="9.&#x90E8;&#x7F72;GKE-ingress:"></a>9.&#x90E8;&#x7F72;GKE-ingress:</h2><h3 id="1-&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x9884;&#x7559;&#x56FA;&#x5B9A;IP"><a href="#1-&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x9884;&#x7559;&#x56FA;&#x5B9A;IP" class="headerlink" title="1.&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x9884;&#x7559;&#x56FA;&#x5B9A;IP"></a>1.&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x9884;&#x7559;&#x56FA;&#x5B9A;IP</h3><p>&#x53EF;&#x4EE5;&#x5728;GCP Console&#x2013;VPC &#x7F51;&#x7EDC;&#x2013;IP &#x5730;&#x5740; &#x4E2D;&#xFF0C;&#x70B9;&#x51FB; <code>RESERVE EXTERNAL STATIC ADDRESS</code> &#x6765;&#x521B;&#x5EFA;<br>&#x6216;&#x8005;&#x53EF;&#x4EE5;&#x7528;gcloud&#x547D;&#x4EE4;&#x6765;&#x521B;&#x5EFA;</p><p>&#x8FD9;&#x91CC;&#x5728;<code>GCP Console</code>&#x2013;<code>VPC &#x7F51;&#x7EDC;</code>&#x2013;<code>IP&#x5730;&#x5740;</code> &#x4E2D;&#x521B;&#x5EFA;&#xFF0C;Console&#x7F51;&#x5740;&#xFF1A;<code>https://console.cloud.google.com/networking/addresses/list?project=atrenew-swappie-prod</code></p><p>&#x521B;&#x5EFA;&#x5168;&#x7403;&#x9884;&#x7559;IP&#xFF0C;&#x540D;&#x79F0;&#xFF1A;<code>user-service-prod-ingress-static-ip</code>&#xFF0C;&#x56FA;&#x5B9A;IP&#x4E3A;&#xFF1A;<code>34.111.251.63</code></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/static.ip.1.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/static.ip.2.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/static.ip.3.png"></p><p>&#x8981;&#x786E;&#x4FDD;&#x8FD9;&#x4E2A;IP: <code>34.111.251.63</code>&#xFF0C;&#x516C;&#x7F51;&#x80FD;ping&#x7684;&#x901A;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/static.ip.4.png"></p><h3 id="2-&#x5C06;&#x9759;&#x6001;IP&#xFF1A;user-service-prod-ingress-static-ip-&#x548C;-&#x76EE;&#x6807;&#x57DF;&#x540D;&#x7ED1;&#x5B9A;"><a href="#2-&#x5C06;&#x9759;&#x6001;IP&#xFF1A;user-service-prod-ingress-static-ip-&#x548C;-&#x76EE;&#x6807;&#x57DF;&#x540D;&#x7ED1;&#x5B9A;" class="headerlink" title="2.&#x5C06;&#x9759;&#x6001;IP&#xFF1A;user-service-prod-ingress-static-ip &#x548C; &#x76EE;&#x6807;&#x57DF;&#x540D;&#x7ED1;&#x5B9A;"></a>2.&#x5C06;&#x9759;&#x6001;IP&#xFF1A;<code>user-service-prod-ingress-static-ip</code> &#x548C; &#x76EE;&#x6807;&#x57DF;&#x540D;&#x7ED1;&#x5B9A;</h3><h4 id="1-&#x8D2D;&#x4E70;&#x57DF;&#x540D;"><a href="#1-&#x8D2D;&#x4E70;&#x57DF;&#x540D;" class="headerlink" title="1.&#x8D2D;&#x4E70;&#x57DF;&#x540D;"></a>1.&#x8D2D;&#x4E70;&#x57DF;&#x540D;</h4><p>&#x5BFB;&#x627E;&#x514D;&#x8D39;&#x57DF;&#x540D;&#x63D0;&#x4F9B;&#x5546; VS &#x8D2D;&#x4E70;&#x4FBF;&#x5B9C;&#x7684;&#x57DF;&#x540D;</p><p>&#x627E;&#x4E86;&#x534A;&#x5929;&#xFF0C;&#x6CA1;&#x627E;&#x5230;&#x514D;&#x8D39;&#x7684;&#x57DF;&#x540D;&#xFF0C;&#x4E70;&#x4E2A;&#x963F;&#x91CC;&#x4E91;&#x4FBF;&#x5B9C;&#x70B9;&#x7684;&#x57DF;&#x540D;<br><a href="https://wanwang.aliyun.com/domain/searchresult/?keyword=xiexugang&amp;suffix=.top#?keyword=xiexugang&amp;suffix=asia">https://wanwang.aliyun.com/domain/searchresult/?keyword=xiexugang&amp;suffix=.top#?keyword=xiexugang&amp;suffix=asia</a></p><p>&#x4E70;&#x57DF;&#x540D;&#xFF1A; <code>xiexugang-api.top</code> &#xFF08;&#x672C;&#x60F3;&#x4E70;6&#x5143;&#x7684;<code>.asia</code>&#x4E00;&#x7EA7;&#x57DF;&#x540D;&#xFF0C;&#x7136;&#x800C;<code>.top</code>&#x89C9;&#x5F97;&#x66F4;&#x987A;&#x773C;(<em>^_^</em>)&#xFF09;</p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/domain.1.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/domain2.png"></p><blockquote><p>&#x6CE8;&#xFF1A;&#x8D2D;&#x4E70;&#x57DF;&#x540D;&#x5E76;&#x4ED8;&#x94B1;&#x4E4B;&#x524D;&#xFF0C;&#x9700;&#x8981;&#x5148;&#x586B;&#x5199;&#x4FE1;&#x606F;&#x6A21;&#x677F;&#xFF0C;&#x5E76;&#x63D0;&#x4EA4;&#x5BA1;&#x6838;&#xFF0C;&#x53EA;&#x6709;&#x7B49;&#x5BA1;&#x6838;&#x901A;&#x8FC7;&#x540E;&#xFF0C;&#x624D;&#x80FD;&#x5728;&#x8D2D;&#x4E70;&#x57DF;&#x540D;&#x9875;&#x9762;&#xFF0C;&#x52FE;&#x9009;&#x521A;&#x624D;&#x5BA1;&#x6838;&#x901A;&#x8FC7;&#x7684;&#x4FE1;&#x606F;&#x6A21;&#x677F;&#xFF0C;&#x624D;&#x80FD;&#x6700;&#x7EC8;&#x4ED8;&#x6B3E;&#x3002;</p><p>&#x4FE1;&#x606F;&#x6A21;&#x677F;&#x586B;&#x5199;&#x5B8C;&#x6BD5;&#x540E;&#xFF0C;&#x5927;&#x6982;&#x534A;&#x5C0F;&#x65F6;&#x5C31;&#x80FD;&#x5BA1;&#x6838;&#x901A;&#x8FC7;&#xFF0C;&#x901A;&#x8FC7;&#x4FE1;&#x606F;&#x662F;&#x4EE5;&#x77ED;&#x4FE1;&#x4E0B;&#x53D1;&#x544A;&#x77E5;&#x7684;&#x3002;</p></blockquote><h4 id="2-&#x57DF;&#x540D;&#x89E3;&#x6790;"><a href="#2-&#x57DF;&#x540D;&#x89E3;&#x6790;" class="headerlink" title="2.&#x57DF;&#x540D;&#x89E3;&#x6790;"></a>2.&#x57DF;&#x540D;&#x89E3;&#x6790;</h4><p>&#x7B49;&#x4E0A;&#x9762;&#x7684;&#x57DF;&#x540D;&#x7533;&#x8BF7;&#x901A;&#x8FC7;&#x540E;&#xFF0C;&#x63A5;&#x7740;&#x662F; &#x76EE;&#x6807;&#x57DF;&#x540D;&#x548C;&#x9759;&#x6001;IP&#x7ED1;&#x5B9A;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;<code>&#x57DF;&#x540D;&#x89E3;&#x6790;</code></p><p>&#x963F;&#x91CC;&#x4E91;&#x6709;&#x514D;&#x8D39;&#x7684;&#x57DF;&#x540D;&#x89E3;&#x6790;&#x8BBE;&#x7F6E;&#xFF1A;<br>&#x8BB0;&#x5F55;&#x7C7B;&#x578B;&#xFF1A;A<br>&#x4E3B;&#x673A;&#x8BB0;&#x5F55;&#xFF1A;@</p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/domain.3.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/domain.4.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/domain.5.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/domain.6.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/domain.7.png"></p><p>IP&#x5730;&#x5740;&#x66F4;&#x6539;&#x4E3A;&#xFF1A;<code>34.111.251.63</code><br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/domain.8.png"></p><p>&#x4EE5;&#x4E0A;&#x8BBE;&#x7F6E;&#x5B8C;&#x6BD5;&#x540E;&#xFF0C;&#x7B49;&#x51E0;&#x5206;&#x949F;&#xFF0C;&#x518D;ping&#x4E0B;&#x57DF;&#x540D;&#xFF0C;&#x770B;&#x89E3;&#x6790;&#x662F;&#x5426;&#x751F;&#x6548;&#xFF1A;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/domain.9.png"><br>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x57DF;&#x540D;&#x89E3;&#x6790;&#x5DF2;&#x751F;&#x6548;</p><p>cloudflare &#x57DF;&#x540D;&#x89E3;&#x6790;<br>TODO</p><p>&#x7B49;&#x57DF;&#x540D;&#x548C;IP&#x89E3;&#x6790;&#x751F;&#x6548;&#x540E;&#xFF0C;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x4E0B;&#x9762;</p><h3 id="3-yaml&#x521B;&#x5EFA;SSL&#x8BC1;&#x4E66;&#x5E76;&#x5E94;&#x7528;&#x751F;&#x6548;"><a href="#3-yaml&#x521B;&#x5EFA;SSL&#x8BC1;&#x4E66;&#x5E76;&#x5E94;&#x7528;&#x751F;&#x6548;" class="headerlink" title="3.yaml&#x521B;&#x5EFA;SSL&#x8BC1;&#x4E66;&#x5E76;&#x5E94;&#x7528;&#x751F;&#x6548;"></a>3.yaml&#x521B;&#x5EFA;SSL&#x8BC1;&#x4E66;&#x5E76;&#x5E94;&#x7528;&#x751F;&#x6548;</h3><p>GCP&#x4E0A;&#x7684;SSL&#x6258;&#x7BA1;SSL&#x8BC1;&#x4E66;&#x662F;&#x514D;&#x8D39;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x4F7F;&#x7528;GCP&#x7684;&#x8BC1;&#x4E66;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-prod/user-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> vi ssl.yaml</span></span><br></pre></td></tr></table></figure><p>ssl.yaml&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.gke.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ManagedCertificate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">user-service-api-cert</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">domains:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">xiexugang-api.top</span> <span class="comment">#SSL&#x8BC1;&#x4E66;&#x8981;&#x7ED1;&#x5B9A;&#x7684;&#x7F51;&#x57DF;/&#x57DF;&#x540D;</span></span><br></pre></td></tr></table></figure><h3 id="4-SSL&#x6B63;&#x5F0F;&#x6267;&#x884C;&#x5E76;&#x751F;&#x6548;&#xFF1A;"><a href="#4-SSL&#x6B63;&#x5F0F;&#x6267;&#x884C;&#x5E76;&#x751F;&#x6548;&#xFF1A;" class="headerlink" title="4.SSL&#x6B63;&#x5F0F;&#x6267;&#x884C;&#x5E76;&#x751F;&#x6548;&#xFF1A;"></a>4.SSL&#x6B63;&#x5F0F;&#x6267;&#x884C;&#x5E76;&#x751F;&#x6548;&#xFF1A;</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-prod/user-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl apply -n java-service -f ssl.yaml --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span></span><br></pre></td></tr></table></figure><p>&#x8FDB;&#x5165;GCP Certificate Manager&#x91CC;&#x770B;&#x4E0B;&#x8BC1;&#x4E66;&#x662F;&#x5426;&#x751F;&#x6210;&#xFF1A;<br><code>https://console.cloud.google.com/security/ccm/list/lbCertificates?project=atrenew-swappie-prod</code></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/cm.1.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/cm.2.png"></p><p>&#x4E0A;&#x56FE;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x76EE;&#x524D;&#x72B6;&#x6001;&#x662F;&#xFF1A;<code>PROVSIONING</code>&#xFF0C;&#x53EF;&#x80FD;&#x8FD8;&#x5728;&#x5BA1;&#x6838;??</p><p>&#x8FC7;&#x4E86;&#x534A;&#x5C0F;&#x65F6;&#x540E;&#xFF0C;&#x518D;&#x6B21;&#x67E5;&#x770B;&#xFF0C;SSL&#x8BC1;&#x4E66;&#x751F;&#x6548;&#xFF1A;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/cm.3.png"></p><h3 id="5-yaml&#x521B;&#x5EFA;ingress"><a href="#5-yaml&#x521B;&#x5EFA;ingress" class="headerlink" title="5.yaml&#x521B;&#x5EFA;ingress"></a>5.yaml&#x521B;&#x5EFA;ingress</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-prod/user-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vi ingress.yaml</span></span><br></pre></td></tr></table></figure><p>&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">user-service-backend-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.global-static-ip-name:</span> <span class="string">&quot;user-service-prod-ingress-static-ip&quot;</span></span><br><span class="line">    <span class="attr">networking.gke.io/managed-certificates:</span> <span class="string">&quot;user-service-api-cert&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">xiexugang-api.top</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">user-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/user</span> <span class="comment"># &#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x7684;path&#xFF0C;&#x662F;&#x4E1A;&#x52A1;&#x670D;&#x52A1;&#x7684;servlet-contextPath</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">user-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br></pre></td></tr></table></figure><h3 id="6-&#x6267;&#x884C;ingress&#x5E76;&#x751F;&#x6548;"><a href="#6-&#x6267;&#x884C;ingress&#x5E76;&#x751F;&#x6548;" class="headerlink" title="6.&#x6267;&#x884C;ingress&#x5E76;&#x751F;&#x6548;"></a>6.&#x6267;&#x884C;ingress&#x5E76;&#x751F;&#x6548;</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-prod/user-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl apply -n java-service -f ingress.yaml --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>GCP-GCK&#x91CC;&#x7684;Ingress&#x770B;&#x4E0B;&#xFF0C;&#x76EE;&#x524D;Ingress&#x6B63;&#x5728;&#x521B;&#x5EFA;&#x4E2D;&#xFF1A;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/ingress.1.png"></p><p>&#x518D;&#x5230;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x91CC;&#x770B;&#x4E0B;&#xFF1A;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/ingress.2.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/ingress.3.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/ingress.4.png"></p><p>&#x81F3;&#x6B64;&#xFF0C;GKE&#x91CC;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;&#x4E86;&#xFF1A;</p><ol><li>K8&#x96C6;&#x7FA4;&#x548C;&#x8282;&#x70B9;&#x7684;&#x521B;&#x5EFA;&#xFF0C;&#x547D;&#x540D;&#x7A7A;&#x95F4;&#x7684;&#x521B;&#x5EFA;&#xFF1B;</li><li>BackendConfig&#x7684;&#x521B;&#x5EFA;&#xFF1B;</li><li>service&#x7684;&#x521B;&#x5EFA;&#xFF1B;</li><li>&#x9759;&#x6001;IP&#x7684;&#x521B;&#x5EFA;&#x3001;&#x57DF;&#x540D;&#x7684;&#x521B;&#x5EFA;&#x3001;&#x57DF;&#x540D;&#x89E3;&#x6790;&#x7684;&#x7ED1;&#x5B9A;&#xFF1B;</li><li>&#x521B;&#x5EFA;&#x5DE5;&#x4F5C;&#x8D1F;&#x8F7D;deployment&#x5E76;&#x751F;&#x6548;&#xFF0C;</li><li>&#x6258;&#x7BA1;SSL&#x8BC1;&#x4E66;&#x521B;&#x5EFA;&#x5E76;&#x751F;&#x6548;&#xFF1B;</li><li>&#x57DF;&#x540D;&#x548C;SSL&#x8BC1;&#x4E66;&#x7684;&#x7ED1;&#x5B9A;&#x3001;</li><li>&#x521B;&#x5EFA;Ingress&#x5E76;&#x751F;&#x6548;&#xFF0C;&#x6700;&#x7EC8; user-service &#x5C31;&#x80FD;&#x90E8;&#x7F72;&#x6210;&#x529F;&#x4E86;&#xFF01;</li></ol><h2 id="10-&#x6700;&#x540E;&#x7684;&#x68C0;&#x67E5;"><a href="#10-&#x6700;&#x540E;&#x7684;&#x68C0;&#x67E5;" class="headerlink" title="10.&#x6700;&#x540E;&#x7684;&#x68C0;&#x67E5;"></a>10.&#x6700;&#x540E;&#x7684;&#x68C0;&#x67E5;</h2><h3 id="Service"><a href="#Service" class="headerlink" title="Service:"></a>Service:</h3><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/service..2.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/service..3.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/service..4.png"></p><h3 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress:"></a>Ingress:</h3><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/ingress..3.png"></p><p>&#x770B;&#x5230;&#x4E0A;&#x9762;&#x7684;Ingress&#x72B6;&#x6001;&#x662F;&#xFF1A;<code>Some backend services are in UNHEALTHY state</code>&#xFF0C;&#x5F88;&#x53EF;&#x80FD;&#x662F;&#x521A;&#x624D;&#x7684; <code>ingress.yaml</code> &#x91CC;&#x7684; <code>path</code> &#x6CA1;&#x6709;&#x914D;&#x7F6E;&#x6210; <code>/user</code> &#xFF08;&#x8FD9;&#x4E2A;&#x5C31;&#x662F;&#x9879;&#x76EE;&#x91CC;&#x7684;<code>servlet-context-path</code>&#xFF0C;&#x8981;&#x4E00;&#x81F4;&#xFF09;&#xFF0C;&#x66F4;&#x6539;&#x5B8C;&#x6210;&#x540E;&#xFF0C;<strong>&#x628A;Service&#x5220;&#x6389;&#x3001;Ingress&#x5220;&#x6389;&#x3001;Deployment&#x5DE5;&#x4F5C;&#x8D1F;&#x8F7D;&#x5220;&#x6389;</strong><br>&#x91CD;&#x65B0;kubectl apply &#x4E0A;&#x9762;&#x7684;<code>service</code>&#x3001;<code>deployment</code>&#x3001;<code>ingress</code>&#xFF0C;&#x7EE7;&#x7EED;&#x67E5;&#x770B;&#xFF1A;</p><h3 id="Service&#x518D;&#x6B21;&#x68C0;&#x67E5;"><a href="#Service&#x518D;&#x6B21;&#x68C0;&#x67E5;" class="headerlink" title="Service&#x518D;&#x6B21;&#x68C0;&#x67E5;:"></a>Service&#x518D;&#x6B21;&#x68C0;&#x67E5;:</h3><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/service..5.png"></p><h3 id="Ingress&#x518D;&#x6B21;&#x68C0;&#x67E5;"><a href="#Ingress&#x518D;&#x6B21;&#x68C0;&#x67E5;" class="headerlink" title="Ingress&#x518D;&#x6B21;&#x68C0;&#x67E5;:"></a>Ingress&#x518D;&#x6B21;&#x68C0;&#x67E5;:</h3><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/service..6.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/service..7.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/service..8.png"></p><h3 id="&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF1A;"><a href="#&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF1A;" class="headerlink" title="&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF1A;"></a>&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF1A;</h3><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/lb..3.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/lb..4.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/lb..5.png"></p><h2 id="11-&#x8C03;&#x7528;&#x63A5;&#x53E3;&#x9A8C;&#x8BC1;&#xFF1A;"><a href="#11-&#x8C03;&#x7528;&#x63A5;&#x53E3;&#x9A8C;&#x8BC1;&#xFF1A;" class="headerlink" title="11. &#x8C03;&#x7528;&#x63A5;&#x53E3;&#x9A8C;&#x8BC1;&#xFF1A;"></a>11. &#x8C03;&#x7528;&#x63A5;&#x53E3;&#x9A8C;&#x8BC1;&#xFF1A;</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># curl -X GET https://xiexugang-api.top/user/actuator/health</span><br><span class="line">{&quot;status&quot;:&quot;UP&quot;,&quot;groups&quot;:[&quot;liveness&quot;,&quot;readiness&quot;]}</span><br><span class="line"></span><br><span class="line"># curl -X GET https://xiexugang-api.top/user/test/</span><br><span class="line">ok</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&#x6216;</p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/validate.1.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C001.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--5.GKE-Java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92/validate.2.png"></p><h2 id="12-&#x5176;&#x4ED6;"><a href="#12-&#x5176;&#x4ED6;" class="headerlink" title="12.&#x5176;&#x4ED6;:"></a>12.&#x5176;&#x4ED6;:</h2><h3 id="kubectl&#x51E0;&#x4E2A;&#x67E5;&#x770B;&#x547D;&#x4EE4;&#xFF1A;"><a href="#kubectl&#x51E0;&#x4E2A;&#x67E5;&#x770B;&#x547D;&#x4EE4;&#xFF1A;" class="headerlink" title="kubectl&#x51E0;&#x4E2A;&#x67E5;&#x770B;&#x547D;&#x4EE4;&#xFF1A;"></a>kubectl&#x51E0;&#x4E2A;&#x67E5;&#x770B;&#x547D;&#x4EE4;&#xFF1A;</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">//1.&#x663E;&#x793A;&#x96C6;&#x7FA4;&#x4FE1;&#x606F;</span><br><span class="line"># kubectl cluster-info --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span><br><span class="line"></span><br><span class="line">//2.&#x67E5;&#x770B;&#x547D;&#x540D;&#x7A7A;&#x95F4;</span><br><span class="line"># kubectl get namespace --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span><br><span class="line"></span><br><span class="line">//3.&#x67E5;&#x770B;&#x547D;&#x540D;&#x7A7A;&#x95F4;:java-service&#x4E0B;&#x7684;&#x6240;&#x6709;&#x8282;&#x70B9;</span><br><span class="line"># kubectl get nodes -n java-service --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//4.&#x67E5;&#x770B;&#x547D;&#x540D;&#x7A7A;&#x95F4;:java-service&#x4E0B;&#x7684;&#x6240;&#x6709;pod</span><br><span class="line"># kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//4.&#x67E5;&#x770B;&#x547D;&#x540D;&#x7A7A;&#x95F4;:java-service&#x4E0B;&#x7684;pod&#x540D;&#x79F0;=user-service&#xFF0C;&#x72B6;&#x6001;&#x662F; ContainerCreating &#x7684;&#x4E2A;&#x6570;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E00;&#x822C;&#x7528;&#x4E8E;Shell&#x811A;&#x672C;&#x4E2D;&#xFF0C;&#x76D1;&#x542C;pod&#x662F;&#x5426;&#x6B63;&#x5728;&#x521B;&#x5EFA;&#x4E2D;</span><br><span class="line"># kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe | grep user-service  |grep ContainerCreating -c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 5.&#x67E5;&#x770B;&#x547D;&#x540D;&#x7A7A;&#x95F4;:java-service&#x4E0B;&#x7684;&#x8D44;&#x6E90;&#x72B6;&#x6001;</span><br><span class="line"># kubectl rollout status deployment/user-service -n java-service --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//6.&#x67E5;&#x770B;&#x547D;&#x540D;&#x7A7A;&#x95F4;:java-service&#x4E0B;&#x7684;&#x8D44;&#x6E90;&#x72B6;&#x6001;&#xFF0C;&#x662F;&#x5426;&#x662F;successfully&#xFF0C;&#x8FD9;&#x4E2A;&#x4E00;&#x822C;&#x7528;&#x4E8E;Shell&#x811A;&#x672C;&#x4E2D;&#xFF0C;&#x76D1;&#x542C;deployment&#x662F;&#x5426;&#x521B;&#x5EFA;&#x6210;&#x529F;</span><br><span class="line"># kubectl rollout status deployment/user-service -n java-service --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe |grep successfully -c</span><br><span class="line"></span><br><span class="line">//7.&#x67E5;&#x770B;&#x67D0;&#x4E2A;pod&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x6BD4;&#x5982;&#x6709;&#x4E2A;pod&#x540D;&#x79F0;=user-service-7b4bc6d59f-tlrkx</span><br><span class="line"># kubectl describe pod user-service-7b4bc6d59f-tlrkx -n java-service --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span><br><span class="line"></span><br><span class="line">//8.&#x8FDB;&#x5165;&#x67D0;&#x4E2A;&#x5BB9;&#x5668;</span><br><span class="line">&#x8BED;&#x6CD5;&#xFF1A;kubectl exec -it {podName}  -c  {containerName} /bin/bash -n {namespace} --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span><br><span class="line"></span><br><span class="line">//&#x6BD4;&#x5982;&#x8FDB;&#x5165;pod&#x540D;&#x79F0;=user-service-7b4bc6d59f-tlrkx  container&#x540D;&#x79F0;=user-service</span><br><span class="line"># kubectl exec -it user-service-7b4bc6d59f-tlrkx  -c  user-service /bin/bash -n java-service --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="CI-x2F-CD&#x6838;&#x5FC3;&#x811A;&#x672C;&#xFF1A;gcp-deploy-groovy"><a href="#CI-x2F-CD&#x6838;&#x5FC3;&#x811A;&#x672C;&#xFF1A;gcp-deploy-groovy" class="headerlink" title="CI/CD&#x6838;&#x5FC3;&#x811A;&#x672C;&#xFF1A;gcp_deploy.groovy"></a>CI/CD&#x6838;&#x5FC3;&#x811A;&#x672C;&#xFF1A;<code>gcp_deploy.groovy</code></h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">gcp_deploy</span> {</span><br><span class="line"><span class="keyword">static</span> main(args) {</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;=========================1.print args:========================&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> (args != <span class="literal">null</span> &amp;&amp; args.length &gt; <span class="number">0</span>) {</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">def</span> i = <span class="number">0</span>; i &lt; args.length; i++) {</span><br><span class="line">println <span class="string">&quot;i=${i}, value=${args[i]}&quot;</span></span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> serviceName = args[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">def</span> env = args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> currentDir = <span class="string">&quot;pwd&quot;</span>.execute().text</span><br><span class="line">println(<span class="string">&quot;currentDir=${currentDir}&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> dockerizeDir = <span class="string">&quot;/home/gitlab-runner/dockerize&quot;</span></span><br><span class="line"><span class="keyword">def</span> dockerFileName = <span class="string">&quot;Dockerfile-template-MultiEnv&quot;</span></span><br><span class="line"><span class="keyword">def</span> k8sDeployFileName = <span class="string">&quot;deployment-template.yaml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> gcloud = <span class="string">&quot;/home/gitlab-runner/google-cloud-sdk/bin/gcloud&quot;</span></span><br><span class="line"><span class="keyword">def</span> kubectl = <span class="string">&quot;/usr/local/bin/kubectl&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> kubeConfig = System.getenv(<span class="string">&quot;KUBE_CONFIG&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> kubeServiceAccount = System.getenv(<span class="string">&quot;KUBE_SERVICE_ACCOUNT&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> kubeReplicas = System.getenv(<span class="string">&quot;KUBE_REPLICAS&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> healthCheck = System.getenv(<span class="string">&quot;HEALTH_CHECK&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> dockerRegistry = System.getenv(<span class="string">&quot;DOCKER_REPOSITORY&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> servletContext = System.getenv(<span class="string">&quot;SERLET_CONTEXT&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================2.print env variables from .gitlab-ci.yml list:========================&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;env KUBE_CONFIG=${kubeConfig}&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;env KUBE_SERVICE_ACCOUNT=${kubeServiceAccount}&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;env KUBE_REPLICAS=${kubeReplicas}&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;env HEALTH_CHECK=${healthCheck}&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;env DOCKER_REPOSITORY=${dockerRegistry}&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;========================3.mvn package========================&quot;</span>)</span><br><span class="line">runCommandResult(<span class="string">&quot;mvn -e -DskipTests=true clean package&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================4.docker build image========================&quot;</span>)</span><br><span class="line">runCommandResult(<span class="string">&quot;docker --version&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================5.gcloud change account========================&quot;</span>)</span><br><span class="line">runCommandResult(<span class="string">&quot;gcloud config set account ${kubeServiceAccount}&quot;</span>)</span><br><span class="line">runCommandResult(<span class="string">&quot;gcloud auth list&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================6.Create Dockerfile========================&quot;</span>)</span><br><span class="line">File dockerFile = <span class="keyword">new</span> File(<span class="string">&quot;${dockerizeDir}/deployment-prod/user-service/${dockerFileName}&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> dockerFileTempleteContent = dockerFile.text</span><br><span class="line">println(<span class="string">&quot;dockerFileTempleteContent=${dockerFileTempleteContent}&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> serviceJar = serviceName + <span class="string">&quot;.jar&quot;</span></span><br><span class="line"><span class="keyword">def</span> lastDockerFileTempleteContent = dockerFileTempleteContent.replaceAll(<span class="string">&quot;@@service_name&quot;</span>, serviceName)</span><br><span class="line">.replaceAll(<span class="string">&quot;@@service_jar&quot;</span>, serviceJar)</span><br><span class="line">println(<span class="string">&quot;lastDockerFileTempleteContent=${lastDockerFileTempleteContent}&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#x5F53;&#x524D;&#x76EE;&#x5F55;&#x5728;: /home/gitlab-runner/builds/DYbAzYGs/0/e-commerce/user-service</span></span><br><span class="line">File lastDockerFile = <span class="keyword">new</span> File(<span class="string">&quot;./target/Dockerfile&quot;</span>)</span><br><span class="line">lastDockerFile.write(lastDockerFileTempleteContent)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> dockerTag = ymdhms()</span><br><span class="line"><span class="keyword">def</span> dockerImage = dockerRegistry + <span class="string">&quot;:&quot;</span> + dockerTag</span><br><span class="line">println(<span class="string">&quot;sudo docker build -f ./target/Dockerfile -t ${dockerImage} .&quot;</span>)</span><br><span class="line">runCommandResult(<span class="string">&quot;sudo docker build -f ./target/Dockerfile -t ${dockerImage} .&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================7.docker push image========================&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;sudo docker push ${dockerImage}&quot;</span>)</span><br><span class="line">runCommandResult(<span class="string">&quot;sudo docker push ${dockerImage}&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================8.Create deployment.yaml========================&quot;</span>)</span><br><span class="line">File k8sDeploymentFile = <span class="keyword">new</span> File(<span class="string">&quot;${dockerizeDir}/deployment-prod/user-service/${k8sDeployFileName}&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> k8sDeploymentFileContent = k8sDeploymentFile.text</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> lastK8sDeploymentFileContent = k8sDeploymentFileContent</span><br><span class="line">.replaceAll(<span class="string">&quot;@@service_name&quot;</span>, serviceName)</span><br><span class="line">.replaceAll(<span class="string">&quot;@@timestamp&quot;</span>, <span class="keyword">new</span> Date().format(<span class="string">&quot;YmdHms&quot;</span>))</span><br><span class="line">.replaceAll(<span class="string">&quot;@@image&quot;</span>, dockerImage)</span><br><span class="line">.replaceAll(<span class="string">&quot;@@version&quot;</span>, dockerTag+<span class="string">&quot;.gcp&quot;</span>)</span><br><span class="line">.replaceAll(<span class="string">&quot;@@service-context&quot;</span>, servletContext)</span><br><span class="line">.replaceAll(<span class="string">&quot;@@health_check&quot;</span>, healthCheck)</span><br><span class="line">.replaceAll(<span class="string">&quot;@@kube_replicas&quot;</span>, kubeReplicas)</span><br><span class="line">File lastK8sDeploymentFile = <span class="keyword">new</span> File(<span class="string">&quot;./target/deployment.yaml&quot;</span>)</span><br><span class="line">lastK8sDeploymentFile.write(lastK8sDeploymentFileContent)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================9.GKE list nodes========================&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;1_kubectl get nodes --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line">runCommand(<span class="string">&quot;kubectl get nodes --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================10.GKE list pods========================&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;2_kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line">runCommand(<span class="string">&quot;kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================11.GKE apply deployment========================&quot;</span>)</span><br><span class="line"><span class="comment">//kubectl apply -f ... </span></span><br><span class="line">println(<span class="string">&quot;3_kubectl apply -f ./target/deployment.yaml --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> k1 = <span class="string">&quot;kubectl apply -f ./target/deployment.yaml --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>.execute().text</span><br><span class="line">runCommand(<span class="string">&quot;echo 3_____${k1}&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> (k1.contains(<span class="string">&quot;configured&quot;</span>)) {</span><br><span class="line">println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;GKE deployment configured!&quot;</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================12.GKE detect pods status: ContainerCreating========================&quot;</span>)</span><br><span class="line"><span class="comment">//&#x67E5;&#x770B;k8s&#x72B6;&#x6001;</span></span><br><span class="line">runCommand(<span class="string">&quot;date&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;4__Detect ContainerCreating==&gt; kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}  | grep ${serviceName}  | grep ContainerCreating -c&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">def</span> index = <span class="number">1</span>; index &lt;= <span class="number">10</span>; index++) {</span><br><span class="line"><span class="keyword">def</span> podStatus = runPipeline(<span class="string">&quot;kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}  | grep ${serviceName}  | grep ContainerCreating -c \n&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> (podStatus.equals(<span class="string">&quot;1&quot;</span>)) {</span><br><span class="line">println(<span class="string">&quot;&#x5BB9;&#x5668;&#x6B63;&#x5728;&#x521B;&#x5EFA;&#x4E2D;...\n&quot;</span>)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">}</span><br><span class="line">sleep(<span class="number">1000</span>L)</span><br><span class="line">}</span><br><span class="line">runCommand(<span class="string">&quot;date&quot;</span>)</span><br><span class="line"></span><br><span class="line">println(<span class="string">&quot;========================13.GKE detect deployment status: successfully========================&quot;</span>)</span><br><span class="line">runCommand(<span class="string">&quot;date&quot;</span>)</span><br><span class="line">println(<span class="string">&quot;6__Detect successfully==&gt; kubectl rollout status deployment/${serviceName}  -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig} | grep successfully -c&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">def</span> index = <span class="number">1</span>; index &lt;= <span class="number">10</span>; index++) {</span><br><span class="line"><span class="keyword">def</span> deploymentStatus = runPipeline(<span class="string">&quot;kubectl rollout status deployment/${serviceName}  -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig} | grep successfully -c \n&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> (deploymentStatus.equals(<span class="string">&quot;1&quot;</span>)) {</span><br><span class="line">println(<span class="string">&quot;&#x53D1;&#x5E03;&#x6210;&#x529F;!\n&quot;</span>)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">}</span><br><span class="line">sleep(<span class="number">1000</span>L)</span><br><span class="line">}</span><br><span class="line">runCommand(<span class="string">&quot;date&quot;</span>)</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#x666E;&#x901A;shell&#x547D;&#x4EE4;&#xFF0C;&#x6CA1;&#x6709;&#x7BA1;&#x9053;</span></span><br><span class="line"><span class="keyword">def</span> <span class="keyword">static</span> runCommand(<span class="keyword">def</span> command) {</span><br><span class="line">println command.execute().text</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#x666E;&#x901A;shell&#x547D;&#x4EE4;&#xFF0C;&#x6CA1;&#x6709;&#x7BA1;&#x9053;</span></span><br><span class="line"><span class="keyword">def</span> <span class="keyword">static</span> runCommandResult(<span class="keyword">def</span> command) {</span><br><span class="line"><span class="keyword">def</span> info  = <span class="keyword">new</span> StringBuilder()</span><br><span class="line"><span class="keyword">def</span> error = <span class="keyword">new</span> StringBuilder()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> proc = command.execute()<span class="comment">// Call *execute* on the string</span></span><br><span class="line">proc.consumeProcessOutput(info, error)</span><br><span class="line">proc.waitFor()<span class="comment">// Wait for the command to finish</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!error.toString().equals(<span class="string">&quot;&quot;</span>)) {</span><br><span class="line">println <span class="string">&quot;Command[ ${command} ] &gt;&gt;error: ${error.toString()}&quot;</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">println <span class="string">&quot;Command[ ${command} ] &gt;&gt;result: ${info.toString()}&quot;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#x6709;&#x7BA1;&#x9053;&#x7684;shell&#x547D;&#x4EE4;</span></span><br><span class="line"><span class="comment">//https://stackoverflow.com/questions/5711084/java-runtime-getruntime-getting-output-from-executing-a-command-line-program</span></span><br><span class="line"><span class="keyword">def</span> <span class="keyword">static</span> runPipeline(<span class="keyword">def</span> command) {</span><br><span class="line">Runtime rt = Runtime.getRuntime()</span><br><span class="line">String[] commands = [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, command]</span><br><span class="line">Process proc = rt.exec(commands)</span><br><span class="line"></span><br><span class="line">BufferedReader stdInput = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span></span><br><span class="line">InputStreamReader(proc.getInputStream()))</span><br><span class="line"></span><br><span class="line">    BufferedReader stdError = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span></span><br><span class="line">InputStreamReader(proc.getErrorStream()))</span><br><span class="line"></span><br><span class="line"><span class="comment">// Read the output from the command</span></span><br><span class="line">println(<span class="string">&quot;Here is the standard output of the command:\n&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> infoBuilder = <span class="keyword">new</span> StringBuilder()</span><br><span class="line"><span class="keyword">def</span> infostr = <span class="literal">null</span></span><br><span class="line"><span class="keyword">while</span> ((infostr = stdInput.readLine()) != <span class="literal">null</span>) {</span><br><span class="line">infoBuilder.append(infostr)</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (!infoBuilder.toString().equals(<span class="string">&quot;&quot;</span>)) {</span><br><span class="line"><span class="comment">//println &quot;AAAAAAAAAA&quot;</span></span><br><span class="line"><span class="keyword">return</span> infoBuilder.toString()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Read any errors from the attempted command</span></span><br><span class="line">println(<span class="string">&quot;Here is the standard error of the command (if any):\n&quot;</span>);</span><br><span class="line"><span class="keyword">def</span> errorBuilder = <span class="keyword">new</span> StringBuilder()</span><br><span class="line"><span class="keyword">def</span> errorstr = <span class="literal">null</span></span><br><span class="line"><span class="keyword">while</span> ((errorstr = stdError.readLine()) != <span class="literal">null</span>) {</span><br><span class="line">errorBuilder.append(errorstr)</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (!errorBuilder.toString().equals(<span class="string">&quot;&quot;</span>)) {</span><br><span class="line"><span class="comment">//println &quot;BBBBBBBBBB&quot;</span></span><br><span class="line"><span class="keyword">return</span> errorBuilder.toString()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="keyword">static</span> ymdhms() {</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> Date().format(<span class="string">&quot;yyyyMMdd_HHmmss&quot;</span>)</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="&#x524D;&#x7AEF;reactive&#x9879;&#x76EE;&#x91CC;&#x7684;-gitlab-ci-yml"><a href="#&#x524D;&#x7AEF;reactive&#x9879;&#x76EE;&#x91CC;&#x7684;-gitlab-ci-yml" class="headerlink" title="&#x524D;&#x7AEF;reactive&#x9879;&#x76EE;&#x91CC;&#x7684; .gitlab-ci.yml"></a>&#x524D;&#x7AEF;reactive&#x9879;&#x76EE;&#x91CC;&#x7684; .gitlab-ci.yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">uat</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy-hk-aliyun</span></span><br><span class="line"></span><br><span class="line"><span class="attr">master:</span></span><br><span class="line">    <span class="attr">stage:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">script:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pwd</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">whoami</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">yarn</span> <span class="string">install</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">yarn</span> <span class="string">run</span> <span class="string">prod</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">front_deploy</span></span><br><span class="line">    <span class="attr">only:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hk-aliyun</span></span><br><span class="line"><span class="attr">uat:</span></span><br><span class="line">    <span class="attr">stage:</span> <span class="string">uat</span></span><br><span class="line">    <span class="attr">script:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pwd</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">whoami</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">yarn</span> <span class="string">install</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">yarn</span> <span class="string">run</span> <span class="string">uat</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">npx</span> <span class="string">shipit</span> <span class="string">uat</span> <span class="string">deploy</span></span><br><span class="line">    <span class="attr">only:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">uat</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hangzhou-aliyun</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-hk-aliyun:</span></span><br><span class="line">    <span class="attr">stage:</span> <span class="string">deploy-hk-aliyun</span></span><br><span class="line">    <span class="attr">script:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pwd</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">whoami</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">yarn</span> <span class="string">install</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">yarn</span> <span class="string">run</span> <span class="string">aliyun_prod</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">npx</span> <span class="string">shipit</span> <span class="string">aliyun_prod</span> <span class="string">deploy</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">manual</span></span><br></pre></td></tr></table></figure><h3 id="&#x524D;&#x7AEF;reactive&#x9879;&#x76EE;&#x91CC;&#x7684;-front-deploy"><a href="#&#x524D;&#x7AEF;reactive&#x9879;&#x76EE;&#x91CC;&#x7684;-front-deploy" class="headerlink" title="&#x524D;&#x7AEF;reactive&#x9879;&#x76EE;&#x91CC;&#x7684; front_deploy"></a>&#x524D;&#x7AEF;reactive&#x9879;&#x76EE;&#x91CC;&#x7684; front_deploy</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$nginx_root</span> = <span class="string">&apos;/usr/share/nginx/html/janpara-admin-ui&apos;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$current_dir</span> = <span class="title function_ invoke__">getcwd</span>();</span><br><span class="line"><span class="variable">$version</span> = <span class="title function_ invoke__">date</span>(<span class="string">&apos;YmdHis&apos;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">run_command</span>(<span class="string">&quot;kubectl cp <span class="subst">$current_dir</span>/dist/ management-nginx-0:<span class="subst">$nginx_root</span>/releases/<span class="subst">$version</span>  -c nginx -n java-service&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">run_command</span>(<span class="string">&quot;kubectl exec -i management-nginx-0 -n java-service -c nginx -- bash -c \&quot;cd <span class="subst">$nginx_root</span> &amp;&amp; ln -sfn releases/<span class="subst">$version</span> current\&quot;&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Files have been copied to PersistentVolumeClaim&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run_command</span>(<span class="params"><span class="variable">$command</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="title function_ invoke__">passthru</span>(<span class="variable">$command</span>, <span class="variable">$result_code</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$result_code</span> != <span class="number">0</span>) <span class="keyword">exit</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5B9E;&amp;#x73B0;GKE&amp;#x91CC;&amp;#xFF1A;&quot;&gt;&lt;a href=&quot;#&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5B9E;&amp;#x73B0;GKE&amp;#x91CC;&amp;#xFF1A;&quot; class=&quot;headerlink&quot; title=&quot;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5B9E;&amp;#x73B0;GKE&amp;#x91CC;&amp;#xFF1A;&quot;&gt;&lt;/a&gt;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5B9E;&amp;#x73B0;GKE&amp;#x91CC;&amp;#xFF1A;&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&amp;#x521B;&amp;#x5EFA; K8&amp;#x96C6;&amp;#x7FA4;&amp;#x548C;&amp;#x8282;&amp;#x70B9;&amp;#xFF08;&amp;#x4E0A;&amp;#x7BC7;&amp;#x5DF2;&amp;#x7ECF;&amp;#x521B;&amp;#x5EFA;&amp;#xFF09;&amp;#xFF0C;&amp;#x521B;&amp;#x5EFA; namespace&amp;#xFF1B;&lt;/li&gt;
&lt;li&gt;&amp;#x521B;&amp;#x5EFA; BackendConfig &amp;#x5E76;&amp;#x751F;&amp;#x6548;&amp;#xFF1B;&lt;/li&gt;
&lt;li&gt;&amp;#x521B;&amp;#x5EFA; service &amp;#x5E76;&amp;#x751F;&amp;#x6548;&amp;#xFF1B;&lt;/li&gt;
&lt;li&gt;&amp;#x521B;&amp;#x5EFA; &amp;#x9759;&amp;#x6001;IP&amp;#x3001;&amp;#x7533;&amp;#x8BF7;&amp;#x57DF;&amp;#x540D;&amp;#x3001;&amp;#x57DF;&amp;#x540D;&amp;#x89E3;&amp;#x6790;&amp;#xFF1B;&lt;/li&gt;
&lt;li&gt;&amp;#x521B;&amp;#x5EFA; &amp;#x6258;&amp;#x7BA1;SSL&amp;#x8BC1;&amp;#x4E66; &amp;#x5E76;&amp;#x751F;&amp;#x6548;&amp;#xFF1B;&lt;/li&gt;
&lt;li&gt;&amp;#x521B;&amp;#x5EFA;&amp;#x5DE5;&amp;#x4F5C;&amp;#x8D1F;&amp;#x8F7D;deployment&amp;#x5E76;&amp;#x751F;&amp;#x6548;;&lt;/li&gt;
&lt;li&gt;&amp;#x521B;&amp;#x5EFA; Ingress&amp;#xFF0C;&amp;#x57DF;&amp;#x540D;&amp;#x548C;SSL&amp;#x8BC1;&amp;#x4E66;&amp;#x7684;&amp;#x7ED1;&amp;#x5B9A;&amp;#xFF0C;&amp;#x6700;&amp;#x7EC8; user-service &amp;#x5C31;&amp;#x80FD;&amp;#x90E8;&amp;#x7F72;&amp;#x6210;&amp;#x529F;&amp;#x4E86;&amp;#xFF1B;&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Infrastructure" scheme="http://example.com/categories/Infrastructure/"/>
    
    
    <category term="gitlab-runner" scheme="http://example.com/tags/gitlab-runner/"/>
    
    <category term="GCP-GKE" scheme="http://example.com/tags/GCP-GKE/"/>
    
  </entry>
  
  <entry>
    <title>Infrastructure-GCP系列.gitlab-runner实现java微服务CICD--4.GCP服务账号激活、创建镜像库、运行pipeline</title>
    <link href="http://example.com/2023/06/20/18.C002.Infrastructure-GCP%E7%B3%BB%E5%88%97.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E8%BF%90%E8%A1%8Cpipeline/"/>
    <id>http://example.com/2023/06/20/18.C002.Infrastructure-GCP%E7%B3%BB%E5%88%97.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E8%BF%90%E8%A1%8Cpipeline/</id>
    <published>2023-06-19T16:00:00.000Z</published>
    <updated>2023-10-12T12:48:33.122Z</updated>
    
    <content type="html"><![CDATA[<h2 id="&#x670D;&#x52A1;&#x5668;B&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;"><a href="#&#x670D;&#x52A1;&#x5668;B&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;" class="headerlink" title="&#x670D;&#x52A1;&#x5668;B&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;"></a>&#x670D;&#x52A1;&#x5668;B&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;</h2><h3 id="&#x4F5C;&#x7528;&#xFF1A;"><a href="#&#x4F5C;&#x7528;&#xFF1A;" class="headerlink" title="&#x4F5C;&#x7528;&#xFF1A;"></a>&#x4F5C;&#x7528;&#xFF1A;</h3><ul><li>kubectl &#x547D;&#x4EE4;&#x53EF;&#x7528;</li><li>GCP Project: <code>atrenew-swappie-prod </code>&#x521B;&#x5EFA;&#x5E76;&#x914D;&#x7F6E;&#x597D;&#x670D;&#x52A1;&#x8D26;&#x53F7;&#x7684;&#x89D2;&#x8272;&#xFF0C;&#x4F7F;&#x5176;&#x62E5;&#x6709;&#x955C;&#x50CF;&#x5E93;&#x7684;&#x63A8;&#x9001;&#x6743;&#x9650;</li><li>gitlab&#x91CC;&#x7684;pipeline&#xFF0C;&#x80FD;&#x591F;&#x8FD0;&#x884C;&#x8D77;&#x6765;</li></ul><span id="more"></span><h3 id="&#x914D;&#x7F6E;&#xFF1A;"><a href="#&#x914D;&#x7F6E;&#xFF1A;" class="headerlink" title="&#x914D;&#x7F6E;&#xFF1A;"></a>&#x914D;&#x7F6E;&#xFF1A;</h3><ul><li>&#x9999;&#x6E2F;&#x963F;&#x91CC;&#x4E91;-&#x8F7B;&#x91CF;&#x7EA7;&#x670D;&#x52A1;&#x5668;</li><li>IP&#x5730;&#x5740;  : <code>(&#x516C;) 8.210.133.189</code></li><li>2&#x6838;8G</li><li>CentoOS 7.6 <code>root</code>  / <code>???</code></li></ul><h3 id="1-&#x5B89;&#x88C5;&#x4E0B;kubectl&#x547D;&#x4EE4;"><a href="#1-&#x5B89;&#x88C5;&#x4E0B;kubectl&#x547D;&#x4EE4;" class="headerlink" title="1.&#x5B89;&#x88C5;&#x4E0B;kubectl&#x547D;&#x4EE4;"></a>1.&#x5B89;&#x88C5;&#x4E0B;kubectl&#x547D;&#x4EE4;</h3><p>&#x5B89;&#x88C5;&#x4E0B;kubectl&#x547D;&#x4EE4;&#xFF1A;<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/">Install and Set Up kubectl on Linux</a></p><h4 id="1-&#x68C0;&#x67E5;&#x4E0B;&#x662F;amd64&#x8FD8;&#x662F;arm64"><a href="#1-&#x68C0;&#x67E5;&#x4E0B;&#x662F;amd64&#x8FD8;&#x662F;arm64" class="headerlink" title="1.&#x68C0;&#x67E5;&#x4E0B;&#x662F;amd64&#x8FD8;&#x662F;arm64"></a>1.&#x68C0;&#x67E5;&#x4E0B;&#x662F;amd64&#x8FD8;&#x662F;arm64</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dpkg --print-architecture</span></span><br><span class="line">amd64</span><br></pre></td></tr></table></figure><h4 id="2-&#x4E0B;&#x8F7D;"><a href="#2-&#x4E0B;&#x8F7D;" class="headerlink" title="2.&#x4E0B;&#x8F7D;"></a>2.&#x4E0B;&#x8F7D;</h4><p>&#x4EE5;&#x4E0A;&#x8FD4;&#x56DE;&#x7684;&#x662F;<code>amd64</code>&#xFF0C;&#x56E0;&#x6B64;&#x9009;&#x62E9;<code>x86-64</code>&#x8FDB;&#x884C;&#x5B89;&#x88C5;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">su - gitlab-runner</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl -LO <span class="string">&quot;https://dl.k8s.io/release/<span class="subst">$(curl -L -s https://dl.k8s.io/release/stable.txt)</span>/bin/linux/amd64/kubectl&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl -LO <span class="string">&quot;https://dl.k8s.io/<span class="subst">$(curl -L -s https://dl.k8s.io/release/stable.txt)</span>/bin/linux/amd64/kubectl.sha256&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(cat kubectl.sha256)</span>  kubectl&quot;</span> | <span class="built_in">sha256sum</span> --check</span></span><br><span class="line">kubectl: OK</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="3-&#x5B89;&#x88C5;"><a href="#3-&#x5B89;&#x88C5;" class="headerlink" title="3.&#x5B89;&#x88C5;"></a>3.&#x5B89;&#x88C5;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//&#x5207;&#x6362;&#x6210;root&#x7528;&#x6237;&#xFF0C;&#x5728;sudoers&#x6587;&#x4EF6;&#x91CC;&#xFF0C;&#x589E;&#x52A0;&#x7528;&#x6237; gitlab-runner &#x7684;sudo &#x65E0;&#x5BC6;&#x7801;&#x6743;&#x9650;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">su -</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">chmod</span> 755 /etc/sudoers</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vi /etc/sudoers</span></span><br><span class="line"></span><br><span class="line">&#x589E;&#x52A0;&#xFF1A;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Allows people in group wheel to run all commands</span></span></span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">wheel  ALL=(ALL)       ALL</span></span><br><span class="line">gitlab-runner   ALL=(ALL)       NOPASSWD:ALL</span><br><span class="line"></span><br><span class="line">:wq &#x4FDD;&#x5B58;</span><br><span class="line"></span><br><span class="line">//&#x6700;&#x540E;&#x6587;&#x4EF6;&#x6743;&#x9650;&#x8FD8;&#x539F;&#x6210;&#xFF1A;440</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">chmod</span> 440 /etc/sudoers</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//&#x4EE5;gitlab-runner&#x7528;&#x6237;&#x64CD;&#x4F5C;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">su - gitlab-runner</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl version --client --output=yaml</span></span><br></pre></td></tr></table></figure><h3 id="2-GCP-Project-atrenew-swappie-prod-&#x4E0B;&#xFF0C;&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x8D26;&#x53F7;&#x5E76;&#x914D;&#x7F6E;&#x89D2;&#x8272;"><a href="#2-GCP-Project-atrenew-swappie-prod-&#x4E0B;&#xFF0C;&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x8D26;&#x53F7;&#x5E76;&#x914D;&#x7F6E;&#x89D2;&#x8272;" class="headerlink" title="2.GCP Project: atrenew-swappie-prod &#x4E0B;&#xFF0C;&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x8D26;&#x53F7;&#x5E76;&#x914D;&#x7F6E;&#x89D2;&#x8272;"></a>2.GCP Project: <code>atrenew-swappie-prod</code> &#x4E0B;&#xFF0C;&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x8D26;&#x53F7;&#x5E76;&#x914D;&#x7F6E;&#x89D2;&#x8272;</h3><h4 id="1-GCP-&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x8D26;&#x53F7;"><a href="#1-GCP-&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x8D26;&#x53F7;" class="headerlink" title="1.GCP &#x521B;&#x5EFA;&#x670D;&#x52A1;&#x8D26;&#x53F7;"></a>1.GCP &#x521B;&#x5EFA;&#x670D;&#x52A1;&#x8D26;&#x53F7;</h4><p>GCP Project: <code>atrenew-swappie-prod</code><br>&#x5728;&#x8BE5;&#x9879;&#x76EE;&#x4E0B;&#xFF0C;&#x521B;&#x5EFA;<code>&#x670D;&#x52A1;&#x8D26;&#x53F7;</code>&#xFF1A;<code>creative-cicd-prod-europe@atrenew-swappie-prod.iam.gserviceaccount.com</code>&#xFF0C;&#x5E76;&#x6302;&#x4E0A;&#x89D2;&#x8272;&#xFF1A;</p><ul><li><code>Cloud Build Service Agent</code>&#x3001;</li><li><code>Kubernetes Engine Service Agent</code>&#x3001;</li><li><code>roles/artifactregistry.createOnPushWriter</code></li></ul><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C002.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E6%88%90%E5%8A%9F%E8%BF%90%E8%A1%8Cpipeline/serviceaccount.1.png"></p><p>&#x6B65;&#x9AA4;&#xFF1A;<br>1.<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C002.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E6%88%90%E5%8A%9F%E8%BF%90%E8%A1%8Cpipeline/serviceaccount.2.png"></p><ol start="2"><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C002.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E6%88%90%E5%8A%9F%E8%BF%90%E8%A1%8Cpipeline/serviceaccount.3.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C002.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E6%88%90%E5%8A%9F%E8%BF%90%E8%A1%8Cpipeline/serviceaccount.4.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C002.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E6%88%90%E5%8A%9F%E8%BF%90%E8%A1%8Cpipeline/serviceaccount.5.png"></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C002.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E6%88%90%E5%8A%9F%E8%BF%90%E8%A1%8Cpipeline/serviceaccount.6.png"></p></li></ol><h4 id="2-&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x8D26;&#x53F7;&#x7684;&#x5BC6;&#x94A5;&#x6587;&#x4EF6;&#xFF1A;"><a href="#2-&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x8D26;&#x53F7;&#x7684;&#x5BC6;&#x94A5;&#x6587;&#x4EF6;&#xFF1A;" class="headerlink" title="2.&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x8D26;&#x53F7;&#x7684;&#x5BC6;&#x94A5;&#x6587;&#x4EF6;&#xFF1A;"></a>2.&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x8D26;&#x53F7;&#x7684;&#x5BC6;&#x94A5;&#x6587;&#x4EF6;&#xFF1A;</h4><p>&#xFF08;&#x53C2;&#x8003;&#xFF1A; <a href="https://cloud.google.com/iam/docs/keys-create-delete?hl=zh-cn%EF%BC%89">https://cloud.google.com/iam/docs/keys-create-delete?hl=zh-cn&#xFF09;</a></p><p>&#x670D;&#x52A1;&#x8D26;&#x53F7;&#x94FE;&#x63A5;&#xFF1A;<a href="https://console.cloud.google.com/iam-admin/serviceaccounts/details/101525918011731677250/keys?project=atrenew-swappie-prod">https://console.cloud.google.com/iam-admin/serviceaccounts/details/101525918011731677250/keys?project=atrenew-swappie-prod</a></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C002.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E6%88%90%E5%8A%9F%E8%BF%90%E8%A1%8Cpipeline/key.1.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C002.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E6%88%90%E5%8A%9F%E8%BF%90%E8%A1%8Cpipeline/key.2.png"></p><p>&#x70B9;&#x51FB;&#x521B;&#x5EFA;&#x540E;&#xFF0C;&#x4F1A;&#x751F;&#x6210;&#x5E76;&#x4E0B;&#x8F7D;&#x5F97;&#x5230;<strong>json&#x683C;&#x5F0F;&#x7684;&#x79C1;&#x94A5;&#x6587;&#x4EF6;</strong>&#xFF1A; <code>atrenew-swappie-prod-bf2a4130f275.json</code></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C002.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E6%88%90%E5%8A%9F%E8%BF%90%E8%A1%8Cpipeline/key.3.png"></p><p><code>atrenew-swappie-prod-bf2a4130f275.json</code>&#x5185;&#x5BB9;&#xFF1A;</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;service_account&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;project_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;atrenew-swappie-prod&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;private_key_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bf2a4130f275e4831f891a31bd29dfa92755768e&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;private_key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-----BEGIN PRIVATE KEY-----\n&#x4E0D;&#x65B9;&#x4FBF;&#x5C55;&#x793A;\n-----END PRIVATE KEY-----\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;client_email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;creative-cicd-prod-europe@atrenew-swappie-prod.iam.gserviceaccount.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;client_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;101525918011731677250&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auth_uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://accounts.google.com/o/oauth2/auth&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;token_uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://oauth2.googleapis.com/token&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auth_provider_x509_cert_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://www.googleapis.com/oauth2/v1/certs&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;client_x509_cert_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://www.googleapis.com/robot/v1/metadata/x509/creative-cicd-prod-europe%40atrenew-swappie-prod.iam.gserviceaccount.com&quot;</span></span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="3-&#x5C06;&#x79C1;&#x94A5;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x5230;&#x8DF3;&#x677F;&#x673A;&#x4E0A;&#xFF08;&#x7565;&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x8DF3;&#x677F;&#x673A;&#x6FC0;&#x6D3B;&#x8D26;&#x6237;"><a href="#3-&#x5C06;&#x79C1;&#x94A5;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x5230;&#x8DF3;&#x677F;&#x673A;&#x4E0A;&#xFF08;&#x7565;&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x8DF3;&#x677F;&#x673A;&#x6FC0;&#x6D3B;&#x8D26;&#x6237;" class="headerlink" title="3.&#x5C06;&#x79C1;&#x94A5;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x5230;&#x8DF3;&#x677F;&#x673A;&#x4E0A;&#xFF08;&#x7565;&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x8DF3;&#x677F;&#x673A;&#x6FC0;&#x6D3B;&#x8D26;&#x6237;"></a>3.&#x5C06;&#x79C1;&#x94A5;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x5230;&#x8DF3;&#x677F;&#x673A;&#x4E0A;&#xFF08;&#x7565;&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x8DF3;&#x677F;&#x673A;&#x6FC0;&#x6D3B;&#x8D26;&#x6237;</h4><blockquote><p>&#x6CE8;&#xFF1A;&#x4EE5;&#x4E0B;&#x64CD;&#x4F5C;&#x90FD;&#x5FC5;&#x987B;&#x8981;&#x5207;&#x6362;&#x5230;gitlab-runner&#x7528;&#x6237;<br>&#x590D;&#x4E60;&#x4E0B;&#xFF0C;linux&#x4E2D;&#xFF1A;<br>//&#x666E;&#x901A;&#x7528;&#x6237;&#x5207;&#x6362;&#x5230;root&#x7528;&#x6237;<br>sudo -i</p><p>//&#x5207;&#x6362;&#x7528;&#x6237;&#x5230; gitlab-runner<br>su - gitlab-runner</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">su - gitlab-runner</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mkdir</span> -p dockerize/key</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> dockerize/key</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vi atrenew-swappie-prod-bf2a4130f275.json</span></span><br><span class="line">&#x52A0;&#x5165;&#x4E0A;&#x9762;&#x5185;&#x5BB9;&#xFF0C;&#x7136;&#x540E; :wq&#x4FDD;&#x5B58;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/key</span></span><br><span class="line"></span><br><span class="line">//&#x6FC0;&#x6D3B;&#x670D;&#x52A1;&#x8D26;&#x53F7;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gcloud auth activate-service-account creative-cicd-prod-europe@atrenew-swappie-prod.iam.gserviceaccount.com --key-file=/home/gitlab-runner/dockerize/key/atrenew-swappie-prod-bf2a4130f275.json</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gcloud container clusters get-credentials europe-prod --zone=europe-west3-a</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>europe-prod</code>&#xFF1A;&#x5728;GKE&#x7684;&#x96C6;&#x7FA4;&#x5217;&#x8868;&#x4E2D;&#xFF0C;&#x662F;&#x96C6;&#x7FA4;&#x540D;&#x79F0;<br><code>europe-west3-a</code>&#xFF1A;&#x5728;GKE&#x7684;&#x96C6;&#x7FA4;&#x5217;&#x8868;&#x4E2D;&#xFF0C;&#x662F;&#x96C6;&#x7FA4;&#x7684;&#x53EF;&#x7528;&#x533A;&#x4F4D;&#x7F6E;</p><h4 id="4-&#x51FA;&#x73B0;&#x9519;&#x8BEF;&#xFF1A;"><a href="#4-&#x51FA;&#x73B0;&#x9519;&#x8BEF;&#xFF1A;" class="headerlink" title="4.&#x51FA;&#x73B0;&#x9519;&#x8BEF;&#xFF1A;"></a>4.&#x51FA;&#x73B0;&#x9519;&#x8BEF;&#xFF1A;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ERROR: (gcloud.container.clusters.get-credentials) The required property [project] is not currently set.</span><br><span class="line">It can be set on a per-command basis by re-running your command with the [--project] flag.</span><br><span class="line"></span><br><span class="line">You may set it for your current workspace by running:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  $ </span><span class="language-bash">gcloud config <span class="built_in">set</span> project VALUE</span></span><br></pre></td></tr></table></figure><p>&#x5728;&#x6BCF;&#x4E2A;&#x547D;&#x4EE4;&#x540E;&#x9762;&#xFF0C;&#x52A0;&#x4E0A;&#x2013;project &#x5427;:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gcloud container clusters get-credentials europe-prod --zone=europe-west3-a --project=atrenew-swappie-prod</span></span><br><span class="line">Fetching cluster endpoint and auth data.</span><br><span class="line">kubeconfig entry generated for europe-prod.</span><br></pre></td></tr></table></figure><p>&#x6CE8;&#x610F;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x5B89;&#x88C5;kubectl&#x547D;&#x4EE4;&#xFF0C;&#x56E0;&#x6B64;&#x4F1A;&#x51FA;&#x73B0;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gcloud container clusters get-credentials europe-prod --zone=europe-west3-a</span></span><br><span class="line">WARNING: Accessing a Kubernetes Engine cluster requires the kubernetes commandline</span><br><span class="line">client [kubectl]. To install, run</span><br><span class="line"><span class="meta prompt_">  $ </span><span class="language-bash">gcloud components install kubectl</span></span><br><span class="line"></span><br><span class="line">Fetching cluster endpoint and auth data.</span><br><span class="line">CRITICAL: ACTION REQUIRED: gke-gcloud-auth-plugin, which is needed for continued use of kubectl, was not found or is not executable. Install gke-gcloud-auth-plugin for use with kubectl by following https://cloud.google.com/blog/products/containers-kubernetes/kubectl-auth-changes-in-gke</span><br></pre></td></tr></table></figure><h4 id="5-&#x66F4;&#x6539;-x2F-kube-x2F-config-&#x6587;&#x4EF6;&#x540D;"><a href="#5-&#x66F4;&#x6539;-x2F-kube-x2F-config-&#x6587;&#x4EF6;&#x540D;" class="headerlink" title="5.&#x66F4;&#x6539;~/.kube/config &#x6587;&#x4EF6;&#x540D;"></a>5.&#x66F4;&#x6539;~/.kube/config &#x6587;&#x4EF6;&#x540D;</h4><p><code>~/.kube/</code> &#x76EE;&#x5F55;&#x4E0B;&#xFF0C;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;config&#x6587;&#x4EF6;&#xFF0C;&#x8FDB;&#x5165;&#x66F4;&#x6539;&#x540D;&#x5B57;&#x4E3A; <code>config-prod-europe</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bash-4.2$ cd ~/.kube/</span><br><span class="line">bash-4.2$ ll</span><br><span class="line">bash: ll: command not found</span><br><span class="line">bash-4.2$ ls -al</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 2 gitlab-runner gitlab-runner 4096 May  2 15:46 .</span><br><span class="line">drwx------ 8 gitlab-runner gitlab-runner 4096 May  2 15:46 ..</span><br><span class="line">-rw------- 1 gitlab-runner gitlab-runner 2872 May  2 15:46 config</span><br><span class="line">bash-4.2$ mv config config-prod-europe</span><br><span class="line">bash-4.2$ ls -al</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 2 gitlab-runner gitlab-runner 4096 May  2 15:46 .</span><br><span class="line">drwx------ 8 gitlab-runner gitlab-runner 4096 May  2 15:46 ..</span><br><span class="line">-rw------- 1 gitlab-runner gitlab-runner 2872 May  2 15:46 config-prod-europe</span><br></pre></td></tr></table></figure><h4 id="6-&#x4F7F;&#x7528;kubectl&#x67E5;&#x770B;&#x4E0B;GKE&#x96C6;&#x7FA4;&#x4FE1;&#x606F;&#xFF1A;"><a href="#6-&#x4F7F;&#x7528;kubectl&#x67E5;&#x770B;&#x4E0B;GKE&#x96C6;&#x7FA4;&#x4FE1;&#x606F;&#xFF1A;" class="headerlink" title="6.&#x4F7F;&#x7528;kubectl&#x67E5;&#x770B;&#x4E0B;GKE&#x96C6;&#x7FA4;&#x4FE1;&#x606F;&#xFF1A;"></a>6.&#x4F7F;&#x7528;kubectl&#x67E5;&#x770B;&#x4E0B;GKE&#x96C6;&#x7FA4;&#x4FE1;&#x606F;&#xFF1A;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl cluster-info --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span></span><br><span class="line">E0502 14:36:50.565692   23464 memcache.go:265] couldn\&apos;t get current server API group list: Get &quot;https://35.246.200.121/api?timeout=32s&quot;: getting credentials: exec: executable gke-gcloud-auth-plugin not found</span><br><span class="line"></span><br><span class="line">It looks like you are trying to use a client-go credential plugin that is not installed.</span><br><span class="line"></span><br><span class="line">To learn more about this feature, consult the documentation available at:</span><br><span class="line">      https://kubernetes.io/docs/reference/access-authn-authz/authentication/#client-go-credential-plugins</span><br><span class="line"></span><br><span class="line">Install gke-gcloud-auth-plugin for use with kubectl by following https://cloud.google.com/blog/products/containers-kubernetes/kubectl-auth-changes-in-gke</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use &apos;kubectl cluster-info dump&apos;.</span><br><span class="line">Unable to connect to the server: getting credentials: exec: executable gke-gcloud-auth-plugin not found</span><br><span class="line"></span><br><span class="line">It looks like you are trying to use a client-go credential plugin that is not installed.</span><br><span class="line"></span><br><span class="line">To learn more about this feature, consult the documentation available at:</span><br><span class="line">      https://kubernetes.io/docs/reference/access-authn-authz/authentication/#client-go-credential-plugins</span><br><span class="line"></span><br><span class="line">Install gke-gcloud-auth-plugin for use with kubectl by following https://cloud.google.com/blog/products/containers-kubernetes/kubectl-auth-changes-in-gke</span><br></pre></td></tr></table></figure><h4 id="7-&#x5B89;&#x88C5;&#xFF1A;gke-gcloud-auth-plugin"><a href="#7-&#x5B89;&#x88C5;&#xFF1A;gke-gcloud-auth-plugin" class="headerlink" title="7.&#x5B89;&#x88C5;&#xFF1A;gke-gcloud-auth-plugin"></a>7.&#x5B89;&#x88C5;&#xFF1A;gke-gcloud-auth-plugin</h4><p>&#x4E0A;&#x9762;&#x63D0;&#x793A;&#xFF1A;<code>gke-gcloud-auth-plugin not found</code>&#xFF0C;&#x5B89;&#x88C5;&#x4E0B;&#xFF1A;</p><p>Install using &#x201C;gcloud components install&#x201D;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gcloud components install gke-gcloud-auth-plugin</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Your current Google Cloud CLI version is: 428.0.0</span><br><span class="line">Installing components from version: 428.0.0</span><br><span class="line"></span><br><span class="line">&#x250C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2510;</span><br><span class="line">&#x2502;    These components will be installed.     &#x2502;</span><br><span class="line">&#x251C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x252C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x252C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2524;</span><br><span class="line">&#x2502;          Name          &#x2502; Version &#x2502;   Size  &#x2502;</span><br><span class="line">&#x251C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x253C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x253C;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2524;</span><br><span class="line">&#x2502; gke-gcloud-auth-plugin &#x2502;   0.5.2 &#x2502; 7.7 MiB &#x2502;</span><br><span class="line">&#x2514;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2534;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2534;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2518;</span><br><span class="line"></span><br><span class="line">For the latest full release notes, please visit:</span><br><span class="line">  https://cloud.google.com/sdk/release_notes</span><br><span class="line"></span><br><span class="line">Do you want to continue (Y/n)?  y</span><br><span class="line"></span><br><span class="line">&#x2554;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2557;</span><br><span class="line">&#x2560;&#x2550; Creating update staging area                             &#x2550;&#x2563;</span><br><span class="line">&#x255A;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2560;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2563;</span><br><span class="line">&#x2560;&#x2550; Installing: gke-gcloud-auth-plugin                       &#x2550;&#x2563;</span><br><span class="line">&#x255A;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2560;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2563;</span><br><span class="line">&#x2560;&#x2550; Installing: gke-gcloud-auth-plugin                       &#x2550;&#x2563;</span><br><span class="line">&#x255A;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2560;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2563;</span><br><span class="line">&#x2560;&#x2550; Creating backup and activating new installation          &#x2550;&#x2563;</span><br><span class="line">&#x255A;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x2550;&#x255D;</span><br><span class="line"></span><br><span class="line">Performing post processing steps...done.                                                                                 </span><br><span class="line"></span><br><span class="line">Update done!</span><br></pre></td></tr></table></figure><p>&#x67E5;&#x770B;&#x4E0B;<code>gke-gcloud-auth-plugin</code>&#x7248;&#x672C;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gke-gcloud-auth-plugin --version</span></span><br><span class="line">Kubernetes v1.26.2-alpha+038d2342e9672c4772e9ee48a3f1dd9438156eba</span><br></pre></td></tr></table></figure><p>&#x518D;&#x6B21;&#x67E5;&#x770B;GKE&#x96C6;&#x7FA4;&#x4FE1;&#x606F;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bash-4.2$ kubectl cluster-info --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span><br><span class="line">Kubernetes control plane is running at https://35.246.200.121</span><br><span class="line">GLBCDefaultBackend is running at https://35.246.200.121/api/v1/namespaces/kube-system/services/default-http-backend:http/proxy</span><br><span class="line">KubeDNS is running at https://35.246.200.121/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br><span class="line">Metrics-server is running at https://35.246.200.121/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use &apos;kubectl cluster-info dump&apos;.</span><br></pre></td></tr></table></figure><h4 id="8-&#x67E5;&#x770B;GKE&#x96C6;&#x7FA4;&#x4E0B;&#x7684;&#x8282;&#x70B9;&#x4FE1;&#x606F;"><a href="#8-&#x67E5;&#x770B;GKE&#x96C6;&#x7FA4;&#x4E0B;&#x7684;&#x8282;&#x70B9;&#x4FE1;&#x606F;" class="headerlink" title="8.&#x67E5;&#x770B;GKE&#x96C6;&#x7FA4;&#x4E0B;&#x7684;&#x8282;&#x70B9;&#x4FE1;&#x606F;"></a>8.&#x67E5;&#x770B;GKE&#x96C6;&#x7FA4;&#x4E0B;&#x7684;&#x8282;&#x70B9;&#x4FE1;&#x606F;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get nodes --kubeconfig=/home/gitlab-runner/.kube/config-prod-europe</span></span><br><span class="line">NAME                                         STATUS   ROLES    AGE   VERSION</span><br><span class="line">gke-europe-prod-pool-europe1-a0373232-3nqs   Ready    &lt;none&gt;   9d    v1.24.10-gke.2300</span><br><span class="line">gke-europe-prod-pool-europe1-a0373232-6f89   Ready    &lt;none&gt;   9d    v1.24.10-gke.2300</span><br></pre></td></tr></table></figure><p>&#x8FDB;&#x5165;GCP-GKE&#xFF0C;&#x96C6;&#x7FA4;&#x91CC;&#x770B;&#x4E0B;&#xFF0C;2&#x4E2A;&#x8282;&#x70B9;&#x7684;ID&#x662F;&#x5426;&#x548C;&#x4E0A;&#x9762;&#x7684;2&#x4E2A;&#x5BF9;&#x7684;&#x4E0A;&#xFF1A;</p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C002.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E6%88%90%E5%8A%9F%E8%BF%90%E8%A1%8Cpipeline/gke.1.png"></p><h3 id="3-&#x9879;&#x76EE;&#x6839;&#x76EE;&#x5F55;&#x4E2D;&#x6DFB;&#x52A0;-gitlab-ci-yml"><a href="#3-&#x9879;&#x76EE;&#x6839;&#x76EE;&#x5F55;&#x4E2D;&#x6DFB;&#x52A0;-gitlab-ci-yml" class="headerlink" title="3.&#x9879;&#x76EE;&#x6839;&#x76EE;&#x5F55;&#x4E2D;&#x6DFB;&#x52A0;.gitlab-ci.yml"></a>3.&#x9879;&#x76EE;&#x6839;&#x76EE;&#x5F55;&#x4E2D;&#x6DFB;&#x52A0;.gitlab-ci.yml</h3><p>&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start check environment&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">whoami</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pwd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">java</span> <span class="string">-version</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">CURRENT_DIR=$(cd</span> <span class="string">$(dirname</span> <span class="string">$0);</span> <span class="string">pwd);</span> <span class="string">echo</span> <span class="string">$CURRENT_DIR;</span> <span class="string">echo</span> <span class="string">$(pwd)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">${pwd}</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">sudo</span> <span class="string">cp</span> <span class="string">/home/gitlab-runner/gcp_deploy.groovy</span> <span class="string">$(pwd)/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-gcp-uat:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span>                     <span class="comment"># groovy&#x811A;&#x672C;&#x91CC;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;System.getEnv(&quot;xxx&quot;)&#x83B7;&#x5F97;     </span></span><br><span class="line">    <span class="attr">KUBE_CONFIG:</span> <span class="string">&quot;config-prod-europe&quot;</span>  <span class="comment"># &#x76EE;&#x5F55;&#x4E0B;&#x7684;&#xFF1A; ~/.kube/config-prod-europe</span></span><br><span class="line">    <span class="attr">KUBE_SERVICE_ACCOUNT:</span> <span class="string">&quot;creative-cicd-prod-europe@atrenew-swappie-prod.iam.gserviceaccount.com&quot;</span>  <span class="comment">#&#x4F7F;&#x7528;serviceaccount&#x8D26;&#x6237;</span></span><br><span class="line">    <span class="attr">KUBE_REPLICAS:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">HEALTH_CHECK:</span> <span class="string">&quot;/user/actuator/health&quot;</span>  <span class="comment">#healthCheck&#x8DEF;&#x5F84;&#xFF0C;&#x6CE8;&#x610F;&#x5E26;&#x4E0A;contextPath</span></span><br><span class="line">    <span class="attr">SERLET_CONTEXT:</span> <span class="string">&quot;/user&quot;</span></span><br><span class="line">    <span class="attr">DOCKER_REPOSITORY:</span> <span class="string">&quot;europe-west3-docker.pkg.dev/atrenew-swappie-prod/prod/user-service&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start job&gt;&gt;&gt;&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">groovy</span> <span class="string">gcp_deploy.groovy</span> <span class="string">user-service</span> <span class="string">prod</span>    <span class="comment"># &#x4E24;&#x4E2A;&#x53C2;&#x6570;&#x503C;&#xFF1A;user-service &#x548C; prod &#x4F20;&#x9012;&#x7ED9;groovy&#x91CC;&#x7684; static main(args)  &#x4E2D;&#x7684;args</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;finished job&lt;&lt;&lt;&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hk-aliyun</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-home-gitlab-runner&#x4E0B;&#xFF0C;&#x521B;&#x5EFA;gcp-deploy-groovy&#x811A;&#x672C;"><a href="#4-home-gitlab-runner&#x4E0B;&#xFF0C;&#x521B;&#x5EFA;gcp-deploy-groovy&#x811A;&#x672C;" class="headerlink" title="4./home/gitlab-runner&#x4E0B;&#xFF0C;&#x521B;&#x5EFA;gcp_deploy.groovy&#x811A;&#x672C;"></a>4.<code>/home/gitlab-runner</code>&#x4E0B;&#xFF0C;&#x521B;&#x5EFA;<code>gcp_deploy.groovy</code>&#x811A;&#x672C;</h3><p>&#x4E0A;&#x8FF0;&#x76EE;&#x5F55;&#x4E0B;&#xFF0C;&#x521B;&#x5EFA;<code>gcp_deploy.groovy</code>&#x811A;&#x672C;&#xFF0C;&#x5185;&#x5BB9;&#x968F;&#x610F;&#xFF0C;&#x7136;&#x540E;&#x5230; gitlab &#x7684;&#x9879;&#x76EE;&#x91CC;&#xFF0C;&#x627E;&#x5230; CI/CD&#x2013;Pipeline,&#x624B;&#x52A8;&#x6267;&#x884C;JOB&#xFF0C;&#x4F1A;&#x51FA;&#x73B0;&#x4E0B;&#x9762;2&#x4E2A;&#x9519;&#x8BEF;&#xFF1A;</p><h4 id="1-gitlab-runner&#x7528;&#x6237;&#xFF0C;&#x6CA1;&#x6709;sudo&#x6743;&#x9650;"><a href="#1-gitlab-runner&#x7528;&#x6237;&#xFF0C;&#x6CA1;&#x6709;sudo&#x6743;&#x9650;" class="headerlink" title="1.gitlab-runner&#x7528;&#x6237;&#xFF0C;&#x6CA1;&#x6709;sudo&#x6743;&#x9650;"></a>1.gitlab-runner&#x7528;&#x6237;&#xFF0C;&#x6CA1;&#x6709;sudo&#x6743;&#x9650;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">cp</span> /home/gitlab-runner/gcp_deploy.groovy $(<span class="built_in">cd</span> $(<span class="built_in">dirname</span> <span class="variable">$0</span>); <span class="built_in">pwd</span>)/</span></span><br><span class="line">We trust you have received the usual lecture from the local System</span><br><span class="line">Administrator. It usually boils down to these three things:</span><br><span class="line">    #1) Respect the privacy of others.</span><br><span class="line">    #2) Think before you type.</span><br><span class="line">    #3) With great power comes great responsibility.</span><br><span class="line">sudo: no tty present and no askpass program specified</span><br></pre></td></tr></table></figure><p>centos&#x52A0;&#x4E0A;&#x7528;&#x6237;gitlab-runner&#x7684;sudo&#x6743;&#x9650;&#xFF0C;&#x5E76;&#x4E14;&#x4E0D;&#x8981;&#x8F93;&#x5165;&#x5BC6;&#x7801;<br>(<a href="https://www.cnblogs.com/ssyfj/p/9176015.html">https://www.cnblogs.com/ssyfj/p/9176015.html</a>)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">su -</span></span><br><span class="line">//&#x5207;&#x6362;&#x6210;root&#x7528;&#x6237;&#x64CD;&#x4F5C;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vi /etc/sudoers</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Allows people in group wheel to run all commands</span></span></span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">wheel  ALL=(ALL)       ALL</span></span><br><span class="line">gitlab-runner   ALL=(ALL)       NOPASSWD:ALL</span><br><span class="line"></span><br><span class="line">:wq</span><br></pre></td></tr></table></figure><h4 id="2-git-&#x7248;&#x672C;&#x8FC7;&#x4F4E;"><a href="#2-git-&#x7248;&#x672C;&#x8FC7;&#x4F4E;" class="headerlink" title="2. git &#x7248;&#x672C;&#x8FC7;&#x4F4E;"></a>2. git &#x7248;&#x672C;&#x8FC7;&#x4F4E;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Running with gitlab-runner 15.11.0 (436955cb)</span><br><span class="line">  on user-service@uat DYbAzYGs, system ID: s_9ec25d1764c9</span><br><span class="line">Preparing the &quot;shell&quot; executor</span><br><span class="line">00:00</span><br><span class="line">Using Shell (bash) executor...</span><br><span class="line">Preparing environment</span><br><span class="line">00:00</span><br><span class="line">Running on iZj6ceptfg1yxcr02av6syZ...</span><br><span class="line">Getting source from Git repository</span><br><span class="line">00:00</span><br><span class="line">Fetching changes with git depth set to 20...</span><br><span class="line">Reinitialized existing Git repository in /home/gitlab-runner/builds/DYbAzYGs/0/e-commerce/user-service/.git/</span><br><span class="line">fatal: git fetch-pack: expected shallow list</span><br><span class="line">fatal: The remote end hung up unexpectedly</span><br><span class="line">ERROR: Job failed: exit status 1</span><br></pre></td></tr></table></figure><p>&#x62A5;&#x9519;&#x65F6;&#x7531;&#x4E8E;git&#x7248;&#x672C;&#x5F15;&#x8D77;&#x7684;&#xFF0C;&#x67E5;&#x770B;git&#x7248;&#x672C;<br>(<a href="https://www.cnblogs.com/heian99/p/17026950.html">https://www.cnblogs.com/heian99/p/17026950.html</a>)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git --version</span></span><br><span class="line">git version 1.8.3.1</span><br></pre></td></tr></table></figure><p>&#x5347;&#x7EA7;git&#x7248;&#x672C;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install http://opensource.wandisco.com/centos/7/git/x86_64/wandisco-git-release-7-2.noarch.rpm</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum -y install git</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git --version</span></span><br><span class="line">git version 2.39.1</span><br></pre></td></tr></table></figure><h3 id="5-GCP-Artifact-Registry-&#x521B;&#x5EFA;&#x955C;&#x50CF;&#x5E93;"><a href="#5-GCP-Artifact-Registry-&#x521B;&#x5EFA;&#x955C;&#x50CF;&#x5E93;" class="headerlink" title="5.GCP-Artifact Registry &#x521B;&#x5EFA;&#x955C;&#x50CF;&#x5E93;"></a>5.GCP-Artifact Registry &#x521B;&#x5EFA;&#x955C;&#x50CF;&#x5E93;</h3><ul><li>GCP-Artifact Registry&#x4EE3;&#x7801;&#x5E93;: user-service</li><li>&#x5B8C;&#x6574;&#x7684;&#x4ED3;&#x5E93;&#x8DEF;&#x5F84;&#xFF1A;<code>europe-west3-docker.pkg.dev/atrenew-swappie-prod/prod/user-service</code></li></ul><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C002.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E6%88%90%E5%8A%9F%E8%BF%90%E8%A1%8Cpipeline/ar.1.png"></p><h4 id="1-&#x67E5;&#x770B;&#x4E0B;&#x955C;&#x50CF;&#x5E93;&#x5217;&#x8868;"><a href="#1-&#x67E5;&#x770B;&#x4E0B;&#x955C;&#x50CF;&#x5E93;&#x5217;&#x8868;" class="headerlink" title="1.&#x67E5;&#x770B;&#x4E0B;&#x955C;&#x50CF;&#x5E93;&#x5217;&#x8868;"></a>1.&#x67E5;&#x770B;&#x4E0B;&#x955C;&#x50CF;&#x5E93;&#x5217;&#x8868;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gcloud artifacts repositories list --project=atrenew-swappie-prod</span></span><br><span class="line">ERROR: (gcloud.artifacts.repositories.list) Your current active account [creative-cicd-uat-asia@atrenew-docomo-uat.iam.gserviceaccount.com] does not have any valid credentials</span><br><span class="line">Please run:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  $ </span><span class="language-bash">gcloud auth login</span></span><br><span class="line"></span><br><span class="line">to obtain new credentials.</span><br><span class="line"></span><br><span class="line">For service account, please activate it first:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  $ </span><span class="language-bash">gcloud auth activate-service-account ACCOUNT</span></span><br></pre></td></tr></table></figure><p>gcloud&#x767B;&#x5F55;&#x8BA4;&#x8BC1;&#xFF0C;&#x8BBE;&#x7F6E;&#x5168;&#x5C40;project</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gcloud auth login</span></span><br><span class="line">Go to the following link in your browser:</span><br><span class="line"></span><br><span class="line">    https://accounts.google.com/o/oauth2/auth?response_type=code&amp;client_id=32555940559.apps.googleusercontent.com&amp;redirect_uri=https%3A%2F%2Fsdk.cloud.google.com%2Fauthcode.html&amp;scope=openid+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fappengine.admin+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fsqlservice.login+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcompute+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Faccounts.reauth&amp;state=HpvNRycbTy9Rx69MZfGstPum1yxeGM&amp;prompt=consent&amp;access_type=offline&amp;code_challenge=KQDENWWA1z33W6W_olHdotuv-UVTkZKPUavNPAtAxzo&amp;code_challenge_method=S256</span><br><span class="line"></span><br><span class="line">Enter authorization code: 4/0AbUR2VP37qSB_N0qq3D1pbr0fF1zld-8kshUfAHj1WiaIUxY7bVMoP9Rfu2eNvuWKNbRPw</span><br><span class="line"></span><br><span class="line">You are now logged in as [admin@ahsdevice.com].</span><br><span class="line">Your current project is [None].  You can change this setting by running:</span><br><span class="line"><span class="meta prompt_">  $ </span><span class="language-bash">gcloud config <span class="built_in">set</span> project PROJECT_ID</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gcloud config <span class="built_in">set</span> project atrenew-swappie-prod</span></span><br><span class="line">Updated property [core/project].</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bash-4.2$ gcloud artifacts repositories list</span><br><span class="line">Listing items under project atrenew-swappie-prod, across all locations.</span><br><span class="line"></span><br><span class="line">                                                                   ARTIFACT_REGISTRY</span><br><span class="line">REPOSITORY       FORMAT  MODE                 DESCRIPTION  LOCATION      LABELS  ENCRYPTION          CREATE_TIME          UPDATE_TIME          SIZE (MB)</span><br><span class="line">ms-user-service  DOCKER  STANDARD_REPOSITORY               europe-west3          Google-managed key  2023-05-02T14:59:36  2023-05-02T14:59:36  0</span><br></pre></td></tr></table></figure><p>&#x624B;&#x52A8;&#x6784;&#x5EFA;docker&#x955C;&#x50CF;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">bash-4.2$ cd /home/gitlab-runner/builds/DYbAzYGs/0/e-commerce/user-service</span><br><span class="line">bash-4.2$ sudo docker build -f ./target/Dockerfile -t europe-west3-docker.pkg.dev/atrenew-swappie-prod/ms-user-service:20230502_172547 .</span><br><span class="line">Sending build context to Docker daemon  18.13MB</span><br><span class="line">Step 1/6 : FROM openjdk:8u332-jre-bullseye</span><br><span class="line">8u332-jre-bullseye: Pulling from library/openjdk</span><br><span class="line">d836772a1c1f: Pull complete</span><br><span class="line">66a9e63c657a: Pull complete</span><br><span class="line">d1989b6e74cf: Pull complete</span><br><span class="line">19babefbed06: Pull complete</span><br><span class="line">9cc5cfae1007: Pull complete</span><br><span class="line">904a5a310a02: Pull complete</span><br><span class="line">Digest: sha256:dc9fe1af315306eb1c7862553edcb1e9ed3e67c8f61c3f7b43c9e9ebf89f143a</span><br><span class="line">Status: Downloaded newer image for openjdk:8u332-jre-bullseye</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">a18e587149c9</span></span><br><span class="line">Step 2/6 : WORKDIR /usr/src/myapp</span><br><span class="line">Removing intermediate container 1bdebd317480</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">88fb0399592f</span></span><br><span class="line">Step 3/6 : COPY ./target/user-service.jar /usr/src/myapp/</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">3302c811689b</span></span><br><span class="line">Step 4/6 : RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/timezone &amp;&amp; ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 5bb9bd3aef38</span></span><br><span class="line">Removing intermediate container 5bb9bd3aef38</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">cfccee871d29</span></span><br><span class="line">Step 5/6 : EXPOSE 8080</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> cc3a52243687</span></span><br><span class="line">Removing intermediate container cc3a52243687</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">10a821bec254</span></span><br><span class="line">Step 6/6 : ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;user-service.jar&quot;]</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 3e5985597430</span></span><br><span class="line">Removing intermediate container 3e5985597430</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">8e813b67b6ff</span></span><br><span class="line">Successfully built 8e813b67b6ff</span><br><span class="line">Successfully tagged europe-west3-docker.pkg.dev/atrenew-swappie-prod/ms-user-service:20230502_172547</span><br></pre></td></tr></table></figure><p>&#x624B;&#x52A8;&#x63A8;&#x9001;&#x955C;&#x50CF;&#x5230;GCP &#x955C;&#x50CF;&#x5E93;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">bash-4.2$ sudo docker push europe-west3-docker.pkg.dev/atrenew-swappie-prod/ms-user-service:20230502_172547</span><br><span class="line">The push refers to repository [europe-west3-docker.pkg.dev/atrenew-swappie-prod/ms-user-service]</span><br><span class="line">794b6c381ec0: Preparing</span><br><span class="line">05eb6471367e: Preparing</span><br><span class="line">0f25bc91c189: Preparing</span><br><span class="line">aa0ef87ca021: Preparing</span><br><span class="line">ad301ec69e29: Preparing</span><br><span class="line">425e7e958da4: Waiting</span><br><span class="line">9be7f4e74e71: Waiting</span><br><span class="line">36cd374265f4: Waiting</span><br><span class="line">5bdeef4a08f3: Waiting</span><br><span class="line">denied: Permission &quot;artifactregistry.repositories.uploadArtifacts&quot; denied on resource &quot;projects/atrenew-swappie-prod/locations/europe-west3/repositories/ms-user-service&quot; (or it may not exist)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//https://stackoverflow.com/questions/75840164/permission-artifactregistry-repositories-uploadartifacts-denied-on-resource-usin</span><br><span class="line"></span><br><span class="line">bash-4.2$ gcloud auth configure-docker europe-west3-docker.pkg.dev</span><br><span class="line">Adding credentials for: europe-west3-docker.pkg.dev</span><br><span class="line">After update, the following will be written to your Docker config file located at [/home/gitlab-runner/.docker/config.json]:</span><br><span class="line"> {</span><br><span class="line">  &quot;credHelpers&quot;: {</span><br><span class="line">    &quot;europe-west3-docker.pkg.dev&quot;: &quot;gcloud&quot;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">Do you want to continue (Y/n)?  y</span><br><span class="line"></span><br><span class="line">Docker configuration file updated.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>GCP &#x4EE3;&#x7801;&#x5E93;&#x4E2D;&#x6388;&#x4E88;&#x7528;&#x6237;&#x89D2;&#x8272;&#xFF1A;<br><a href="https://cloud.google.com/artifact-registry/docs/access-control?hl=zh_CN">https://cloud.google.com/artifact-registry/docs/access-control?hl=zh_CN</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo docker push europe-west3-docker.pkg.dev/atrenew-swappie-prod/ms-user-service:20230502_195005</span><br><span class="line"></span><br><span class="line">gcloud auth configure-docker europe-west3-docker.pkg.dev</span><br><span class="line"></span><br><span class="line">gcloud artifacts locations list</span><br></pre></td></tr></table></figure><p>&#x4EE5;&#x4E0A;&#x90FD;&#x4E0D;&#x884C;&#xFF0C;GCP&#x4E0A;&#x64CD;&#x4F5C;&#xFF0C;&#x5C06;&#x955C;&#x50CF;&#x5E93;&#x516C;&#x5F00;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;</p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C002.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E6%88%90%E5%8A%9F%E8%BF%90%E8%A1%8Cpipeline/ar.2.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C002.Infrastructure-gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--4.GCP%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E6%BF%80%E6%B4%BB%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%BA%93%E3%80%81%E6%88%90%E5%8A%9F%E8%BF%90%E8%A1%8Cpipeline/ar.3.png"></p><h3 id="&#x5176;&#x4ED6;&#xFF1A;"><a href="#&#x5176;&#x4ED6;&#xFF1A;" class="headerlink" title="&#x5176;&#x4ED6;&#xFF1A;"></a>&#x5176;&#x4ED6;&#xFF1A;</h3><h4 id="1-&#x5982;&#x6709;&#x5FC5;&#x8981;&#xFF0C;&#x5378;&#x8F7D;docker&#xFF0C;&#x91CD;&#x65B0;&#x5B89;&#x88C5;-&#x4E0A;&#x9762;&#x4E0D;&#x77E5;&#x54EA;&#x4E2A;&#x73AF;&#x8282;&#xFF0C;&#x5C06;docker&#x5347;&#x7EA7;&#x4E86;&#xFF0C;&#x5BFC;&#x81F4;docker-build&#x63D0;&#x793A;-builder-buildx-build-&#xFF1A;"><a href="#1-&#x5982;&#x6709;&#x5FC5;&#x8981;&#xFF0C;&#x5378;&#x8F7D;docker&#xFF0C;&#x91CD;&#x65B0;&#x5B89;&#x88C5;-&#x4E0A;&#x9762;&#x4E0D;&#x77E5;&#x54EA;&#x4E2A;&#x73AF;&#x8282;&#xFF0C;&#x5C06;docker&#x5347;&#x7EA7;&#x4E86;&#xFF0C;&#x5BFC;&#x81F4;docker-build&#x63D0;&#x793A;-builder-buildx-build-&#xFF1A;" class="headerlink" title="1.&#x5982;&#x6709;&#x5FC5;&#x8981;&#xFF0C;&#x5378;&#x8F7D;docker&#xFF0C;&#x91CD;&#x65B0;&#x5B89;&#x88C5;(&#x4E0A;&#x9762;&#x4E0D;&#x77E5;&#x54EA;&#x4E2A;&#x73AF;&#x8282;&#xFF0C;&#x5C06;docker&#x5347;&#x7EA7;&#x4E86;&#xFF0C;&#x5BFC;&#x81F4;docker build&#x63D0;&#x793A; builder -buildx build...)&#xFF1A;"></a>1.&#x5982;&#x6709;&#x5FC5;&#x8981;&#xFF0C;&#x5378;&#x8F7D;docker&#xFF0C;&#x91CD;&#x65B0;&#x5B89;&#x88C5;(&#x4E0A;&#x9762;&#x4E0D;&#x77E5;&#x54EA;&#x4E2A;&#x73AF;&#x8282;&#xFF0C;&#x5C06;docker&#x5347;&#x7EA7;&#x4E86;&#xFF0C;&#x5BFC;&#x81F4;<code>docker build</code>&#x63D0;&#x793A; <code>builder -buildx build...</code>)&#xFF1A;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum list installed | grep docker</span></span><br><span class="line">docker-buildx-plugin.x86_64        0.10.4-1.el7                    @docker-ce-stable</span><br><span class="line">docker-ce-cli.x86_64               1:23.0.5-1.el7                  @docker-ce-stable</span><br><span class="line">docker-compose-plugin.x86_64       2.17.3-1.el7                    @docker-ce-stable</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum -y remove docker-buildx-plugin.x86_64</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum -y remove docker-ce-cli.x86_64</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum -y remove docker-compose-plugin.x86_64</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum remove docker \</span></span><br><span class="line"><span class="language-bash">           docker-client \</span></span><br><span class="line"><span class="language-bash">           docker-client-latest \</span></span><br><span class="line"><span class="language-bash">           docker-common \</span></span><br><span class="line"><span class="language-bash">           docker-latest \</span></span><br><span class="line"><span class="language-bash">           docker-latest-logrotate \</span></span><br><span class="line"><span class="language-bash">           docker-logrotate \</span></span><br><span class="line"><span class="language-bash">           docker-selinux \</span></span><br><span class="line"><span class="language-bash">           docker-engine-selinux \</span></span><br><span class="line"><span class="language-bash">           docker-engine</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum remove docker-ce \</span></span><br><span class="line"><span class="language-bash">           docker-ce-cli \</span></span><br><span class="line"><span class="language-bash">           containerd</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl stop docker</span><br><span class="line">rm -rf /etc/systemd/system/docker.service.d</span><br><span class="line">rm -rf /etc/systemd/system/docker.service</span><br><span class="line">rm -rf /var/lib/docker</span><br><span class="line">rm -rf /var/run/docker</span><br><span class="line">rm -rf /usr/local/docker</span><br><span class="line">rm -rf /etc/docker</span><br><span class="line">rm -rf /usr/bin/docker* /usr/bin/containerd* /usr/bin/runc /usr/bin/ctr</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;&amp;#x670D;&amp;#x52A1;&amp;#x5668;B&amp;#x7684;&amp;#x4F5C;&amp;#x7528;&amp;#x4E0E;&amp;#x914D;&amp;#x7F6E;&amp;#x8BF4;&amp;#x660E;&quot;&gt;&lt;a href=&quot;#&amp;#x670D;&amp;#x52A1;&amp;#x5668;B&amp;#x7684;&amp;#x4F5C;&amp;#x7528;&amp;#x4E0E;&amp;#x914D;&amp;#x7F6E;&amp;#x8BF4;&amp;#x660E;&quot; class=&quot;headerlink&quot; title=&quot;&amp;#x670D;&amp;#x52A1;&amp;#x5668;B&amp;#x7684;&amp;#x4F5C;&amp;#x7528;&amp;#x4E0E;&amp;#x914D;&amp;#x7F6E;&amp;#x8BF4;&amp;#x660E;&quot;&gt;&lt;/a&gt;&amp;#x670D;&amp;#x52A1;&amp;#x5668;B&amp;#x7684;&amp;#x4F5C;&amp;#x7528;&amp;#x4E0E;&amp;#x914D;&amp;#x7F6E;&amp;#x8BF4;&amp;#x660E;&lt;/h2&gt;&lt;h3 id=&quot;&amp;#x4F5C;&amp;#x7528;&amp;#xFF1A;&quot;&gt;&lt;a href=&quot;#&amp;#x4F5C;&amp;#x7528;&amp;#xFF1A;&quot; class=&quot;headerlink&quot; title=&quot;&amp;#x4F5C;&amp;#x7528;&amp;#xFF1A;&quot;&gt;&lt;/a&gt;&amp;#x4F5C;&amp;#x7528;&amp;#xFF1A;&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;kubectl &amp;#x547D;&amp;#x4EE4;&amp;#x53EF;&amp;#x7528;&lt;/li&gt;
&lt;li&gt;GCP Project: &lt;code&gt;atrenew-swappie-prod &lt;/code&gt;&amp;#x521B;&amp;#x5EFA;&amp;#x5E76;&amp;#x914D;&amp;#x7F6E;&amp;#x597D;&amp;#x670D;&amp;#x52A1;&amp;#x8D26;&amp;#x53F7;&amp;#x7684;&amp;#x89D2;&amp;#x8272;&amp;#xFF0C;&amp;#x4F7F;&amp;#x5176;&amp;#x62E5;&amp;#x6709;&amp;#x955C;&amp;#x50CF;&amp;#x5E93;&amp;#x7684;&amp;#x63A8;&amp;#x9001;&amp;#x6743;&amp;#x9650;&lt;/li&gt;
&lt;li&gt;gitlab&amp;#x91CC;&amp;#x7684;pipeline&amp;#xFF0C;&amp;#x80FD;&amp;#x591F;&amp;#x8FD0;&amp;#x884C;&amp;#x8D77;&amp;#x6765;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="Infrastructure" scheme="http://example.com/categories/Infrastructure/"/>
    
    
    <category term="gitlab-runner" scheme="http://example.com/tags/gitlab-runner/"/>
    
    <category term="GCP-GKE" scheme="http://example.com/tags/GCP-GKE/"/>
    
  </entry>
  
  <entry>
    <title>Infrastructure-GCP系列.gitlab-runner实现java微服务CICD--3.安装编译工具</title>
    <link href="http://example.com/2023/06/20/18.C003.Infrastructure-GCP%E7%B3%BB%E5%88%97.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--3.%E5%AE%89%E8%A3%85%E7%BC%96%E8%AF%91%E5%B7%A5%E5%85%B7/"/>
    <id>http://example.com/2023/06/20/18.C003.Infrastructure-GCP%E7%B3%BB%E5%88%97.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--3.%E5%AE%89%E8%A3%85%E7%BC%96%E8%AF%91%E5%B7%A5%E5%85%B7/</id>
    <published>2023-06-19T16:00:00.000Z</published>
    <updated>2023-10-12T11:19:56.541Z</updated>
    
    <content type="html"><![CDATA[<h2 id="&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;B&#x5B9E;&#x73B0;&#xFF1A;"><a href="#&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;B&#x5B9E;&#x73B0;&#xFF1A;" class="headerlink" title="&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;B&#x5B9E;&#x73B0;&#xFF1A;"></a>&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;B&#x5B9E;&#x73B0;&#xFF1A;</h2><ol><li>&#x5B89;&#x88C5; <code>JDK8</code>&#xFF1B;</li><li>&#x5B89;&#x88C5; <code>Groovy</code>&#xFF1B;</li><li>&#x5B89;&#x88C5; <code>Maven</code>&#xFF1B;</li><li>&#x5B89;&#x88C5; <code>Gcloud CLI</code>&#xFF1B;</li></ol><span id="more"></span><h2 id="&#x670D;&#x52A1;&#x5668;B&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;"><a href="#&#x670D;&#x52A1;&#x5668;B&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;" class="headerlink" title="&#x670D;&#x52A1;&#x5668;B&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;"></a>&#x670D;&#x52A1;&#x5668;B&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;</h2><h3 id="&#x4F5C;&#x7528;&#xFF1A;"><a href="#&#x4F5C;&#x7528;&#xFF1A;" class="headerlink" title="&#x4F5C;&#x7528;&#xFF1A;"></a>&#x4F5C;&#x7528;&#xFF1A;</h3><ul><li>&#x57FA;&#x4E8E;maven&#x7F16;&#x8BD1; java&#x5FAE;&#x670D;&#x52A1;&#xFF1B;</li><li>&#x63A8;&#x9001;&#x955C;&#x50CF;&#x5230;GCP-<code>Artifact Registry</code></li><li>GCP&#x7684;&#x7BA1;&#x7406;&#x5458;&#x8D26;&#x6237;&#xFF1A;<ul><li>&#x8D26;&#x53F7;: <code>admin@ahsdevice.com</code></li><li>&#x5BC6;&#x7801;: <code>???</code></li></ul></li><li>GCP&#x4E0A;&#x521B;&#x5EFA;&#x9879;&#x76EE;&#xFF1A;<code>atrenew-swappie-prod</code></li></ul><h3 id="&#x914D;&#x7F6E;&#xFF1A;"><a href="#&#x914D;&#x7F6E;&#xFF1A;" class="headerlink" title="&#x914D;&#x7F6E;&#xFF1A;"></a>&#x914D;&#x7F6E;&#xFF1A;</h3><ul><li>&#x9999;&#x6E2F;&#x963F;&#x91CC;&#x4E91;-&#x8F7B;&#x91CF;&#x7EA7;&#x670D;&#x52A1;&#x5668;</li><li>IP&#x5730;&#x5740;  : <code>(&#x516C;) 8.210.133.189</code></li><li>CentoOS 7.6  2&#x6838;8G <code>root</code>  / <code>???</code></li></ul><h3 id="1-&#x5B89;&#x88C5;JDK8"><a href="#1-&#x5B89;&#x88C5;JDK8" class="headerlink" title="1.&#x5B89;&#x88C5;JDK8"></a>1.&#x5B89;&#x88C5;JDK8</h3><p>&#x5148;&#x8FDB;&#x5165;<a href="https://www.oracle.com/java/technologies/javase/javase8u211-later-archive-downloads.html">Oracle JDK&#x5B98;&#x7F51;</a>&#xFF0C;&#x767B;&#x5F55;&#x8BA4;&#x8BC1;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x5F97;&#x5230;&#x4E0B;&#x8F7D;&#x94FE;&#x63A5;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://download.oracle.com/otn/java/jdk/8u202-b08/1961070e4c9b4e26a04e7f5a083f551e/jdk-8u202-linux-x64.tar.gz?AuthParam=1682868772_465185ad9310cae2d73528481d3f5f7d</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mv</span> jdk-8u202-linux-x64.tar.gz\?AuthParam\=1682869079_51b81b6da5581a5f609991728a38491a jdk-8u202-linux-x64.tar.gz</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tar -zxvf jdk-8u202-linux-x64.tar.gz</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mkdir</span> /usr/java</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mv</span> jdk1.8.0_202 /usr/java</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vi /etc/profile</span></span><br><span class="line"></span><br><span class="line">&#x672B;&#x5C3E;&#x52A0;&#x4E0A;&#xFF1A;</span><br><span class="line">JAVA_HOME=/usr/java/jdk1.8.0_202</span><br><span class="line">JRE_HOME=$JAVA_HOME/jre</span><br><span class="line">PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin</span><br><span class="line">export JAVA_HOME JRE_HOME PATH</span><br><span class="line"></span><br><span class="line">:wq</span><br></pre></td></tr></table></figure><p>&#x4F7F;&#x751F;&#x6548;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">source</span> /etc/profile</span></span><br></pre></td></tr></table></figure><p>&#x9A8C;&#x8BC1;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">java -version</span></span><br><span class="line">java version &quot;1.8.0_202&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_202-b08)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.202-b08, mixed mode)</span><br></pre></td></tr></table></figure><h3 id="2-&#x5B89;&#x88C5;-Groovy"><a href="#2-&#x5B89;&#x88C5;-Groovy" class="headerlink" title="2.&#x5B89;&#x88C5; Groovy"></a>2.&#x5B89;&#x88C5; Groovy</h3><p>Groovy-SDK&#x4E0B;&#x8F7D;&#x5B98;&#x7F51;&#xFF1A;<a href="https://groovy.apache.org/download.html">https://groovy.apache.org/download.html</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /root/</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://dlcdn.apache.org/groovy/4.0.11/distribution/apache-groovy-binary-4.0.11.zip</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">unzip apache-groovy-binary-4.0.11.zip</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mkdir</span> /usr/groovy</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mv</span> groovy-4.0.11 /usr/groovy/</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vi /etc/profile</span></span><br><span class="line"></span><br><span class="line">&#x672B;&#x5C3E;&#x52A0;&#x4E0A;&#xFF1A;</span><br><span class="line">JAVA_HOME=/usr/java/jdk1.8.0_202</span><br><span class="line">JRE_HOME=$JAVA_HOME/jre</span><br><span class="line">GROOVY_HOME=/usr/groovy/groovy-4.0.11</span><br><span class="line">PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin:$GROOVY_HOME/bin</span><br><span class="line">export JAVA_HOME JRE_HOME GROOVY_HOME PATH</span><br><span class="line"></span><br><span class="line">:wq</span><br></pre></td></tr></table></figure><p>&#x4F7F;&#x751F;&#x6548;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">source</span> /etc/profile</span></span><br></pre></td></tr></table></figure><p>&#x9A8C;&#x8BC1;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">groovy -v</span></span><br><span class="line">Groovy Version: 4.0.11 JVM: 1.8.0_202 Vendor: Oracle Corporation OS: Linux</span><br></pre></td></tr></table></figure><h3 id="3-&#x5B89;&#x88C5;-Maven"><a href="#3-&#x5B89;&#x88C5;-Maven" class="headerlink" title="3.&#x5B89;&#x88C5; Maven"></a>3.&#x5B89;&#x88C5; Maven</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /root</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://dlcdn.apache.org/maven/maven-3/3.9.1/binaries/apache-maven-3.9.1-bin.zip</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">unzip apache-maven-3.9.1-bin.zip</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mkdir</span> /usr/maven</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mv</span> apache-maven-3.9.1 /usr/maven/</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vi /etc/profile</span></span><br><span class="line"></span><br><span class="line">&#x672B;&#x5C3E;&#x52A0;&#x4E0A;&#xFF1A;</span><br><span class="line"></span><br><span class="line">JAVA_HOME=/usr/java/jdk1.8.0_202</span><br><span class="line">JRE_HOME=$JAVA_HOME/jre</span><br><span class="line">GROOVY_HOME=/usr/groovy/apache-maven-3.9.1</span><br><span class="line">MAVEN_HOME=/usr/maven/apache-maven-3.9.1</span><br><span class="line">PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin:$GROOVY_HOME/bin:$MAVEN_HOME/bin</span><br><span class="line">export JAVA_HOME JRE_HOME GROOVY_HOME MAVEN_HOME PATH</span><br><span class="line"></span><br><span class="line">:wq</span><br></pre></td></tr></table></figure><p>&#x4F7F;&#x751F;&#x6548;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">source</span> /etc/profile</span></span><br></pre></td></tr></table></figure><p>&#x9A8C;&#x8BC1;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mvn -version</span></span><br><span class="line">Apache Maven 3.9.1 (2e178502fcdbffc201671fb2537d0cb4b4cc58f8)</span><br><span class="line">Maven home: /usr/maven/apache-maven-3.9.1</span><br><span class="line">Java version: 1.8.0_202, vendor: Oracle Corporation, runtime: /usr/java/jdk1.8.0_202/jre</span><br><span class="line">Default locale: en_US, platform encoding: UTF-8</span><br><span class="line">OS name: &quot;linux&quot;, version: &quot;3.10.0-957.21.3.el7.x86_64&quot;, arch: &quot;amd64&quot;, family: &quot;unix&quot;</span><br></pre></td></tr></table></figure><h3 id="4-&#x5B89;&#x88C5;-gcloud-CLI"><a href="#4-&#x5B89;&#x88C5;-gcloud-CLI" class="headerlink" title="4. &#x5B89;&#x88C5; gcloud CLI"></a>4. &#x5B89;&#x88C5; gcloud CLI</h3><p>&#x53C2;&#x8003;&#xFF1A;<a href="https://cloud.google.com/sdk/docs/install?hl=zh-cn#linux">https://cloud.google.com/sdk/docs/install?hl=zh-cn#linux</a></p><h4 id="1-&#x5347;&#x7EA7;Python"><a href="#1-&#x5347;&#x7EA7;Python" class="headerlink" title="1.&#x5347;&#x7EA7;Python"></a>1.&#x5347;&#x7EA7;Python</h4><h5 id="1-&#x68C0;&#x67E5;centos&#x81EA;&#x5E26;&#x7684;python&#x7248;&#x672C;"><a href="#1-&#x68C0;&#x67E5;centos&#x81EA;&#x5E26;&#x7684;python&#x7248;&#x672C;" class="headerlink" title="1.&#x68C0;&#x67E5;centos&#x81EA;&#x5E26;&#x7684;python&#x7248;&#x672C;"></a>1.&#x68C0;&#x67E5;centos&#x81EA;&#x5E26;&#x7684;python&#x7248;&#x672C;</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">python -V</span></span><br><span class="line">Python 2.7.5</span><br></pre></td></tr></table></figure><h5 id="2-&#x5B89;&#x88C5;&#x65B0;&#x7248;&#x672C;3-9-1"><a href="#2-&#x5B89;&#x88C5;&#x65B0;&#x7248;&#x672C;3-9-1" class="headerlink" title="2.&#x5B89;&#x88C5;&#x65B0;&#x7248;&#x672C;3.9.1"></a>2.&#x5B89;&#x88C5;&#x65B0;&#x7248;&#x672C;3.9.1</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//&#x5B89;&#x88C5;&#x4F9D;&#x8D56;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install gcc gcc-c++ libffi-devel python-setuptools vim wget make sqlite-devel zlib*  bzip2-devel openssl-devel ncurses-devel readline-devel tk-devel  -y</span></span><br><span class="line"></span><br><span class="line">//&#x5207;&#x6362;&#x76EE;&#x5F55;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /opt</span></span><br><span class="line"></span><br><span class="line">//&#x4E0B;&#x8F7D;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://www.python.org/ftp/python/3.9.1/Python-3.9.1.tgz</span></span><br><span class="line"></span><br><span class="line">//&#x89E3;&#x538B;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tar -zxvf Python-3.9.1.tgz</span></span><br><span class="line"></span><br><span class="line">//&#x5207;&#x6362;&#x5230;&#x89E3;&#x538B;&#x76EE;&#x5F55;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /opt/Python-3.9.1</span></span><br><span class="line"></span><br><span class="line">//&#x914D;&#x7F6E;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">./configure --with-ssl</span></span><br><span class="line"></span><br><span class="line">//&#x7F16;&#x8BD1;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">make</span></span><br><span class="line"></span><br><span class="line">//&#x5B89;&#x88C5;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">make install</span></span><br><span class="line"></span><br><span class="line">&#x4F1A;&#x5728; /usr/local/bin/&#x4E0B;&#x5B89;&#x88C5;python3.9</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-&#x8BBE;&#x7F6E;&#x9ED8;&#x8BA4;&#x7248;&#x672C;"><a href="#3-&#x8BBE;&#x7F6E;&#x9ED8;&#x8BA4;&#x7248;&#x672C;" class="headerlink" title="3.&#x8BBE;&#x7F6E;&#x9ED8;&#x8BA4;&#x7248;&#x672C;"></a>3.&#x8BBE;&#x7F6E;&#x9ED8;&#x8BA4;&#x7248;&#x672C;</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">python3 -V</span></span><br><span class="line">Python 3.9.1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&#x5C06;&#x539F;&#x6765; python &#x7684;&#x8F6F;&#x94FE;&#x63A5;&#x91CD;&#x547D;&#x540D;&#xFF1A;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mv</span> /usr/bin/python /usr/bin/python.bak</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&#x5C06; python &#x94FE;&#x63A5;&#x81F3; python3&#xFF1A;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">ln</span> -s /usr/local/bin/python3 /usr/bin/python</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="4-&#x4FEE;&#x590D;yum"><a href="#4-&#x4FEE;&#x590D;yum" class="headerlink" title="4.&#x4FEE;&#x590D;yum"></a>4.&#x4FEE;&#x590D;yum</h5><p>&#x5347;&#x7EA7; Python &#x4E4B;&#x540E;&#xFF0C;&#x7531;&#x4E8E;&#x5C06;&#x9ED8;&#x8BA4;&#x7684; python &#x6307;&#x5411;&#x4E86; python3&#xFF0C;yum &#x4E0D;&#x80FD;&#x6B63;&#x5E38;&#x4F7F;&#x7528;,&#x4F7F;&#x7528;yum&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x62A5;&#x4EE5;&#x4E0B;&#x9519;&#x8BEF;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">File &quot;/usr/bin/yum&quot;, line 30</span><br><span class="line">    except KeyboardInterrupt, e:</span><br><span class="line">                            ^</span><br><span class="line">SyntaxError: invalid syntax</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&#x4FEE;&#x6539;<code>/usr/bin/yum</code>&#x548C;<code>/usr/libexec/urlgrabber-ext-down</code>&#xFF0C;&#x5C06; <code>#!/usr/bin/python</code> &#x6539;&#x4E3A; <code>#!/usr/bin/python2.7</code>&#xFF0C;&#x4FDD;&#x5B58;&#x9000;&#x51FA;&#x5373;&#x53EF;&#x3002;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/bin/yum</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/python</span>  </span><br><span class="line">&#x6539;&#x4E3A;&#xFF1A;#!/usr/bin/python2.7</span><br><span class="line"></span><br><span class="line">:wq</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/libexec/urlgrabber-ext-down</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /usr/bin/python</span></span><br><span class="line">&#x6539;&#x4E3A;&#xFF1A;#! /usr/bin/python2.7</span><br><span class="line"></span><br><span class="line">:wq</span><br></pre></td></tr></table></figure><h5 id="5-&#x5347;&#x7EA7;pip"><a href="#5-&#x5347;&#x7EA7;pip" class="headerlink" title="5.&#x5347;&#x7EA7;pip"></a>5.&#x5347;&#x7EA7;pip</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pip3 --version</span></span><br><span class="line">pip 20.2.3 from /usr/local/lib/python3.9/site-packages/pip (python 3.9)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pip3 install --upgrade pip</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pip3 --version</span></span><br><span class="line">pip 23.1.2 from /usr/local/lib/python3.9/site-packages/pip (python 3.9)</span><br></pre></td></tr></table></figure><h4 id="2-&#x5B89;&#x88C5;Gcloud-CLI"><a href="#2-&#x5B89;&#x88C5;Gcloud-CLI" class="headerlink" title="2.&#x5B89;&#x88C5;Gcloud CLI"></a>2.&#x5B89;&#x88C5;Gcloud CLI</h4><h5 id="1-&#x4E0B;&#x8F7D;-google-cloud-cli-Linux-64-&#x4F4D;&#x5F52;&#x6863;&#x6587;&#x4EF6;"><a href="#1-&#x4E0B;&#x8F7D;-google-cloud-cli-Linux-64-&#x4F4D;&#x5F52;&#x6863;&#x6587;&#x4EF6;" class="headerlink" title="1.&#x4E0B;&#x8F7D; google-cloud-cli Linux 64 &#x4F4D;&#x5F52;&#x6863;&#x6587;&#x4EF6;"></a>1.&#x4E0B;&#x8F7D; google-cloud-cli Linux 64 &#x4F4D;&#x5F52;&#x6863;&#x6587;&#x4EF6;</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x6CE8;&#xFF1A;&#x8FD9;&#x91CC;&#x4E00;&#x5B9A;&#x8981;&#x5207;&#x6362;&#x6210;gitlab-runner&#x7528;&#x6237;&#xFF0C;&#x4E0B;&#x8F7D;&#x5B89;&#x88C5;google-cloud-sdk&#x90FD;&#x8981;&#x7528;&#x8FD9;&#x4E2A;&#x7528;&#x6237;&#x64CD;&#x4F5C;&#xFF0C;&#x5426;&#x5219;&#x540E;&#x9762;&#x8981;&#x5C06;&#x8FD9;&#x4E2A;&#x76EE;&#x5F55;&#xFF0C;&#x5207;&#x6362;&#x7528;&#x6237;&#x548C;&#x7EC4;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">su - gitlab-runner</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-428.0.0-linux-x86_64.tar.gz</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&#x89E3;&#x538B;&#x540E;&#x7684;&#x76EE;&#x5F55;&#x540D;&#x4E3A;&#xFF1A;google-cloud-sdk</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tar -xf google-cloud-cli-428.0.0-linux-x86_64.tar.gz</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">./google-cloud-sdk/install.sh</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="2-&#x5982;&#x9700;&#x521D;&#x59CB;&#x5316;-gcloud-CLI&#xFF0C;&#x8BF7;&#x8FD0;&#x884C;-gcloud-init&#xFF1A;"><a href="#2-&#x5982;&#x9700;&#x521D;&#x59CB;&#x5316;-gcloud-CLI&#xFF0C;&#x8BF7;&#x8FD0;&#x884C;-gcloud-init&#xFF1A;" class="headerlink" title="2.&#x5982;&#x9700;&#x521D;&#x59CB;&#x5316; gcloud CLI&#xFF0C;&#x8BF7;&#x8FD0;&#x884C; gcloud init&#xFF1A;"></a>2.&#x5982;&#x9700;&#x521D;&#x59CB;&#x5316; gcloud CLI&#xFF0C;&#x8BF7;&#x8FD0;&#x884C; gcloud init&#xFF1A;</h5><p>&#x8D26;&#x53F7;: <code>admin@ahsdevice.com</code><br>&#x5BC6;&#x7801;: <code>???</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">./google-cloud-sdk/bin/gcloud init</span></span><br><span class="line"></span><br><span class="line">Welcome! This command will take you through the configuration of gcloud.</span><br><span class="line"></span><br><span class="line">Your current configuration has been set to: [default]</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C003.Infrastructure.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--3.%E5%AE%89%E8%A3%85%E7%BC%96%E8%AF%91%E5%B7%A5%E5%85%B7/iL8bGQ.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gcloud auth list</span></span><br><span class="line">-bash: gcloud: command not found</span><br></pre></td></tr></table></figure><h5 id="3-gcloud&#x547D;&#x4EE4;&#x4E0D;&#x8BC6;&#x522B;"><a href="#3-gcloud&#x547D;&#x4EE4;&#x4E0D;&#x8BC6;&#x522B;" class="headerlink" title="3.gcloud&#x547D;&#x4EE4;&#x4E0D;&#x8BC6;&#x522B;"></a>3.gcloud&#x547D;&#x4EE4;&#x4E0D;&#x8BC6;&#x522B;</h5><p>&#x89E3;&#x51B3;&#x529E;&#x6CD5;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The next line updates PATH <span class="keyword">for</span> the Google Cloud SDK.</span></span><br><span class="line">source &apos;/home/gitlab-runner/google-cloud-sdk/path.bash.inc&apos;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The next line enables bash completion <span class="keyword">for</span> gcloud.</span></span><br><span class="line">source &apos;/home/gitlab-runner/google-cloud-sdk/completion.bash.inc&apos;</span><br></pre></td></tr></table></figure><p>&#x518D;&#x6B21;&#x67E5;&#x770B;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gcloud auth list</span></span><br><span class="line">   Credentialed Accounts</span><br><span class="line">ACTIVE  ACCOUNT</span><br><span class="line">*       admin@ahsdevice.com</span><br><span class="line"></span><br><span class="line">To set the active account, run:</span><br><span class="line">    $ gcloud config set account `ACCOUNT`</span><br></pre></td></tr></table></figure><p>&#x5982;&#x679C;&#x4E00;&#x5F00;&#x59CB;&#x4E0B;&#x8F7D;&#x3001;&#x89E3;&#x538B;google-cloud-sdk&#xFF0C;&#x662F;&#x4EE5;root&#x7528;&#x6237;&#x64CD;&#x4F5C;&#x7684;&#xFF0C;&#x4E0D;&#x662F;&#x4EE5;gitlab-runner&#x7528;&#x6237;&#x64CD;&#x4F5C;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x5C06;&#x8FD9;&#x4E2A;&#x76EE;&#x5F55;&#x5207;&#x6362;&#x7528;&#x6237;&#x548C;&#x7EC4;&#x3002;<br>&#x5230;/home/gitlab-runner&#x76EE;&#x5F55;&#x4E0B;&#xFF0C;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo cp -R /root/google-cloud-sdk /home/gitlab-runner/</span><br><span class="line"></span><br><span class="line">&#x66F4;&#x6539;&#x76EE;&#x5F55;&#xFF1A;google-cloud-sdk &#x7684;&#x7528;&#x6237;&#x548C;&#x7EC4;&#xFF0C;&#x90FD;&#x4E3A;gitlab-runner</span><br><span class="line">cd /home/gitlab-runner</span><br><span class="line"></span><br><span class="line">sudo chown -R gitlab-runner google-cloud-sdk</span><br><span class="line">// &#x4E0A;&#x9762;&#x53EA;&#x662F;&#x8BE5;&#x4E86;&#x76EE;&#x5F55;&#x7684;&#x6240;&#x5C5E;&#x7528;&#x6237;&#xFF0C;&#x8FD8;&#x6CA1;&#x6539;&#x7EC4;&#xFF0C;&#x4E0B;&#x9762;&#x7684;&#x662F;&#x66F4;&#x6539;&#x7EC4;</span><br><span class="line">sudo chgrp -R gitlab-runner google-cloud-sdk</span><br><span class="line"></span><br><span class="line">// &#x6216;&#x8005;&#x8FD9;&#x4E2A;&#x4E00;&#x6B65;&#x5230;&#x4F4D;&#xFF0C;&#x540C;&#x65F6;&#x66F4;&#x6539;&#x7EC4;&#x548C;&#x76EE;&#x5F55;&#x6240;&#x5C5E;&#x7528;&#x6237;</span><br><span class="line">sudo chown -R gitlab-runner:gitlab-runner google-cloud-sdk</span><br></pre></td></tr></table></figure><p>&#x4EE5;&#x4E0A;&#x53EA;&#x662F;&#x4E34;&#x65F6;&#x65B9;&#x6848;&#xFF0C;&#x5982;&#x679C;&#x5173;&#x95ED;&#x4E86;&#x7EC8;&#x7AEF;&#xFF0C;&#x4E0B;&#x6B21;&#x518D;&#x6B21;&#x8FDE;&#x63A5;&#xFF0C;&#x4F9D;&#x65E7;&#x4E0D;&#x4ECD;&#x662F;gcloud&#x547D;&#x4EE4;&#xFF0C;&#x7528;&#x4EE5;&#x4E0B;&#x65B9;&#x6CD5;&#x4E00;&#x52B3;&#x6C38;&#x9038;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /home/gitlab-runner</span><br><span class="line">vi ~/.bash_profile</span><br><span class="line"></span><br><span class="line">export PATH=&quot;/home/gitlab-runner/google-cloud-sdk/bin:$PATH&quot;</span><br><span class="line"></span><br><span class="line">:wq</span><br><span class="line"></span><br><span class="line">source ~/.bash_profile</span><br></pre></td></tr></table></figure><h5 id="4-gcloud&#x6838;&#x5FC3;&#x547D;&#x4EE4;"><a href="#4-gcloud&#x6838;&#x5FC3;&#x547D;&#x4EE4;" class="headerlink" title="4.gcloud&#x6838;&#x5FC3;&#x547D;&#x4EE4;"></a>4.gcloud&#x6838;&#x5FC3;&#x547D;&#x4EE4;</h5><p><a href="https://cloud.google.com/sdk/docs/install-sdk?hl=zh-cn#running_core_commands">https://cloud.google.com/sdk/docs/install-sdk?hl=zh-cn#running_core_commands</a></p><p>1.<strong>&#x5217;&#x51FA;&#x5176;&#x51ED;&#x636E;&#x5B58;&#x50A8;&#x5728;&#x672C;&#x5730;&#x7CFB;&#x7EDF;&#x4E0A;&#x7684;&#x5E10;&#x53F7;</strong>&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcloud auth list</span><br></pre></td></tr></table></figure><p>2.<strong>&#x5207;&#x6362;&#x8D26;&#x53F7;&#xFF1A;</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcloud config set account `ACCOUNT`</span><br></pre></td></tr></table></figure><p>3.<strong>&#x67E5;&#x770B;&#x5F53;&#x524D;&#x9879;&#x76EE;</strong>&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcloud config get-value project</span><br></pre></td></tr></table></figure><p>4.<strong>&#x8BBE;&#x7F6E;&#x5168;&#x5C40;&#x9879;&#x76EE;&#xFF1A;</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcloud config set project atrenew-swappie-prod</span><br></pre></td></tr></table></figure><p>5.&#x5217;&#x51FA;&#x6D3B;&#x8DC3; gcloud CLI &#x914D;&#x7F6E;&#x4E2D;&#x7684;&#x5C5E;&#x6027;&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcloud config list</span><br></pre></td></tr></table></figure><p>6.&#x67E5;&#x770B;&#x6709;&#x5173;&#x60A8;&#x7684; gcloud CLI &#x5B89;&#x88C5;&#x548C;&#x6D3B;&#x8DC3;&#x914D;&#x7F6E;&#x7684;&#x4FE1;&#x606F;&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcloud info</span><br></pre></td></tr></table></figure><p>7.&#x67E5;&#x770B;&#x6709;&#x5173; gcloud &#x547D;&#x4EE4;&#x548C;&#x5176;&#x4ED6;&#x4E3B;&#x9898;&#x7684;&#x4FE1;&#x606F;&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcloud help</span><br></pre></td></tr></table></figure><p>8.&#x66F4;&#x65B0;&#x7EC4;&#x4EF6;&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcloud components update</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5728;&amp;#x670D;&amp;#x52A1;&amp;#x5668;B&amp;#x5B9E;&amp;#x73B0;&amp;#xFF1A;&quot;&gt;&lt;a href=&quot;#&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5728;&amp;#x670D;&amp;#x52A1;&amp;#x5668;B&amp;#x5B9E;&amp;#x73B0;&amp;#xFF1A;&quot; class=&quot;headerlink&quot; title=&quot;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5728;&amp;#x670D;&amp;#x52A1;&amp;#x5668;B&amp;#x5B9E;&amp;#x73B0;&amp;#xFF1A;&quot;&gt;&lt;/a&gt;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5728;&amp;#x670D;&amp;#x52A1;&amp;#x5668;B&amp;#x5B9E;&amp;#x73B0;&amp;#xFF1A;&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&amp;#x5B89;&amp;#x88C5; &lt;code&gt;JDK8&lt;/code&gt;&amp;#xFF1B;&lt;/li&gt;
&lt;li&gt;&amp;#x5B89;&amp;#x88C5; &lt;code&gt;Groovy&lt;/code&gt;&amp;#xFF1B;&lt;/li&gt;
&lt;li&gt;&amp;#x5B89;&amp;#x88C5; &lt;code&gt;Maven&lt;/code&gt;&amp;#xFF1B;&lt;/li&gt;
&lt;li&gt;&amp;#x5B89;&amp;#x88C5; &lt;code&gt;Gcloud CLI&lt;/code&gt;&amp;#xFF1B;&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Infrastructure" scheme="http://example.com/categories/Infrastructure/"/>
    
    
    <category term="gitlab-runner" scheme="http://example.com/tags/gitlab-runner/"/>
    
    <category term="GCP-GKE" scheme="http://example.com/tags/GCP-GKE/"/>
    
  </entry>
  
  <entry>
    <title>Infrastructure-GCP系列.gitlab-runner实现java微服务CICD--2.安装gitlab-runner</title>
    <link href="http://example.com/2023/06/20/18.C004.Infrastructure-GCP%E7%B3%BB%E5%88%97.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--2.%E5%AE%89%E8%A3%85gitlab-runner/"/>
    <id>http://example.com/2023/06/20/18.C004.Infrastructure-GCP%E7%B3%BB%E5%88%97.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--2.%E5%AE%89%E8%A3%85gitlab-runner/</id>
    <published>2023-06-19T16:00:00.000Z</published>
    <updated>2023-10-12T11:13:47.472Z</updated>
    
    <content type="html"><![CDATA[<h2 id="&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;B&#x5B9E;&#x73B0;&#xFF1A;"><a href="#&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;B&#x5B9E;&#x73B0;&#xFF1A;" class="headerlink" title="&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;B&#x5B9E;&#x73B0;&#xFF1A;"></a>&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;B&#x5B9E;&#x73B0;&#xFF1A;</h2><p>1.&#x5B89;&#x88C5;<code>docker</code><br>2.&#x5B89;&#x88C5;<code>git</code><br>3.&#x5B89;&#x88C5;<code>gitlab-runner</code></p><span id="more"></span><h2 id="&#x670D;&#x52A1;&#x5668;B&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;"><a href="#&#x670D;&#x52A1;&#x5668;B&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;" class="headerlink" title="&#x670D;&#x52A1;&#x5668;B&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;"></a>&#x670D;&#x52A1;&#x5668;B&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;</h2><h3 id="&#x4F5C;&#x7528;&#xFF1A;"><a href="#&#x4F5C;&#x7528;&#xFF1A;" class="headerlink" title="&#x4F5C;&#x7528;&#xFF1A;"></a>&#x4F5C;&#x7528;&#xFF1A;</h3><ul><li>&#x4F7F;&#x7528;<code>maven</code>&#x7F16;&#x8BD1;&#x9879;&#x76EE;&#xFF1B;&#x4F7F;&#x7528;<code>gitlab-runner</code>&#x5B8C;&#x6210; <code>CI/CD</code>&#xFF1B;</li></ul><h3 id="&#x914D;&#x7F6E;&#xFF1A;"><a href="#&#x914D;&#x7F6E;&#xFF1A;" class="headerlink" title="&#x914D;&#x7F6E;&#xFF1A;"></a>&#x914D;&#x7F6E;&#xFF1A;</h3><ul><li>&#x9999;&#x6E2F;&#x963F;&#x91CC;&#x4E91;-&#x8F7B;&#x91CF;&#x7EA7;&#x670D;&#x52A1;&#x5668;</li><li>IP&#x5730;&#x5740;  :  (&#x516C;) <code>8.210.133.189</code></li><li>CentoOS 7.6 2&#x6838;8G <code>root</code>  / <code>???</code></li></ul><h3 id="1-&#x5B89;&#x88C5;docker"><a href="#1-&#x5B89;&#x88C5;docker" class="headerlink" title="1.&#x5B89;&#x88C5;docker"></a>1.&#x5B89;&#x88C5;docker</h3><ul><li>&#x53C2;&#x8003; <a href="https://xugangxie.github.io/2021/10/07/18.006%20DevOps%E7%B3%BB%E5%88%97-centos7.8%E5%AE%89%E8%A3%85docker%E5%92%8Cdocker-compose/">&#x8FD9;&#x91CC;</a></li></ul><h3 id="2-&#x5B89;&#x88C5;git"><a href="#2-&#x5B89;&#x88C5;git" class="headerlink" title="2.&#x5B89;&#x88C5;git"></a>2.&#x5B89;&#x88C5;git</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum -y install curl-devel expat-devel gettext-devel openssl-devel zlib-devel</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum -y install git</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git --version</span></span><br><span class="line"></span><br><span class="line">git version 1.8.3.1</span><br></pre></td></tr></table></figure><p>&#x5982;&#x679C;&#x8981;&#x751F;&#x7EA7;&#x6216;&#x662F;&#x5B89;&#x88C5;&#x6700;&#x65B0;&#x7248;&#x672C;&#x7684;git&#xFF0C;&#x53EF;&#x4EE5;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install http://opensource.wandisco.com/centos/7/git/x86_64/wandisco-git-release-7-2.noarch.rpm</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum -y install git</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git --version</span></span><br><span class="line">git version 2.39.1</span><br></pre></td></tr></table></figure><h3 id="3-gitlab&#x4E2D;&#x521B;&#x5EFA;group&#x3001;&#x521B;&#x5EFA;&#x9879;&#x76EE;&#x3001;&#x7F16;&#x5199;-gitlab-ci-yml"><a href="#3-gitlab&#x4E2D;&#x521B;&#x5EFA;group&#x3001;&#x521B;&#x5EFA;&#x9879;&#x76EE;&#x3001;&#x7F16;&#x5199;-gitlab-ci-yml" class="headerlink" title="3.gitlab&#x4E2D;&#x521B;&#x5EFA;group&#x3001;&#x521B;&#x5EFA;&#x9879;&#x76EE;&#x3001;&#x7F16;&#x5199;.gitlab-ci.yml"></a>3.gitlab&#x4E2D;&#x521B;&#x5EFA;group&#x3001;&#x521B;&#x5EFA;&#x9879;&#x76EE;&#x3001;&#x7F16;&#x5199;.gitlab-ci.yml</h3><h4 id="1-gitlab&#x4E2D;&#x521B;&#x5EFA;group&#x3001;&#x521B;&#x5EFA;&#x9879;&#x76EE;&#xFF08;&#x8FC7;&#x7A0B;&#x7565;&#xFF09;"><a href="#1-gitlab&#x4E2D;&#x521B;&#x5EFA;group&#x3001;&#x521B;&#x5EFA;&#x9879;&#x76EE;&#xFF08;&#x8FC7;&#x7A0B;&#x7565;&#xFF09;" class="headerlink" title="1.gitlab&#x4E2D;&#x521B;&#x5EFA;group&#x3001;&#x521B;&#x5EFA;&#x9879;&#x76EE;&#xFF08;&#x8FC7;&#x7A0B;&#x7565;&#xFF09;"></a>1.gitlab&#x4E2D;&#x521B;&#x5EFA;group&#x3001;&#x521B;&#x5EFA;&#x9879;&#x76EE;&#xFF08;&#x8FC7;&#x7A0B;&#x7565;&#xFF09;</h4><p>group: <code>e-commerce</code><br>project: <code>user-service</code></p><h4 id="2-&#x9879;&#x76EE;user-service&#x4E2D;&#x7F16;&#x5199;-gitlab-ci-yml"><a href="#2-&#x9879;&#x76EE;user-service&#x4E2D;&#x7F16;&#x5199;-gitlab-ci-yml" class="headerlink" title="2.&#x9879;&#x76EE;user-service&#x4E2D;&#x7F16;&#x5199;.gitlab-ci.yml"></a>2.&#x9879;&#x76EE;user-service&#x4E2D;&#x7F16;&#x5199;.gitlab-ci.yml</h4><p>.gitlab-ci.yml&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start check environment&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">whoami</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pwd</span> <span class="comment"># &#x6267;&#x884C;&#x8BE5;&#x811A;&#x672C;&#x7684;&#x5F53;&#x524D;&#x76EE;&#x5F55;&#xFF1A;/home/gitlab-runner/builds/DYbAzYGs/0/e-commerce/user-service</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">java</span> <span class="string">-version</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">CURRENT_DIR=$(cd</span> <span class="string">$(dirname</span> <span class="string">$0);</span> <span class="string">pwd);</span> <span class="string">echo</span> <span class="string">$CURRENT_DIR;</span> <span class="string">echo</span> <span class="string">$(pwd)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">sudo</span> <span class="string">cp</span> <span class="string">/home/gitlab-runner/gcp_deploy.groovy</span> <span class="string">$(pwd)/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-gcp-uat:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">KUBE_CONFIG:</span> <span class="string">&quot;config-prod-europe&quot;</span>  <span class="comment"># &#x76EE;&#x5F55;&#x4E0B;&#x7684;&#xFF1A; ~/.kube/config-prod-europe</span></span><br><span class="line">    <span class="attr">KUBE_SERVICE_ACCOUNT:</span> <span class="string">&quot;creative-cicd-prod-europe@atrenew-swappie-prod.iam.gserviceaccount.com&quot;</span> <span class="comment">#&#x4F7F;&#x7528;serviceaccount&#x8D26;&#x6237;</span></span><br><span class="line">    <span class="attr">KUBE_REPLICAS:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">HEALTH_CHECK:</span> <span class="string">&quot;/user/actuator/health&quot;</span>  <span class="comment">#healthCheck&#x8DEF;&#x5F84;&#xFF0C;&#x6CE8;&#x610F;&#x5E26;&#x4E0A;contextPath</span></span><br><span class="line">    <span class="attr">SERLET_CONTEXT:</span> <span class="string">&quot;/user&quot;</span></span><br><span class="line">    <span class="attr">DOCKER_REPOSITORY:</span> <span class="string">&quot;europe-west3-docker.pkg.dev/atrenew-swappie-prod/prod/user-service&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start job&gt;&gt;&gt;&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">groovy</span> <span class="string">gcp_deploy.groovy</span> <span class="string">user-service</span> <span class="string">prod</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;finished job&lt;&lt;&lt;&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">uat</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hk-aliyun</span></span><br></pre></td></tr></table></figure><h3 id="2-&#x5B89;&#x88C5;GitLab-Runner"><a href="#2-&#x5B89;&#x88C5;GitLab-Runner" class="headerlink" title="2.&#x5B89;&#x88C5;GitLab Runner"></a>2.&#x5B89;&#x88C5;GitLab Runner</h3><p>&#x8FD9;&#x91CC;&#x5B89;&#x88C5;&#x9879;&#x76EE;&#x7EA7;&#x522B;&#x7684;Runner</p><p>&#x8FDB;&#x5165;&#xFF1A;<code>http://47.243.76.76/e-commerce/user-service/-/settings/ci_cd</code><br>&#x6309;&#x7167; <code>Set up a project runner for a project</code> &#x7684;&#x4E09;&#x6B65;&#xFF1A;</p><h4 id="1-&#x70B9;&#x51FB;Install-GitLab-Runner-and-ensure-it-39-s-running"><a href="#1-&#x70B9;&#x51FB;Install-GitLab-Runner-and-ensure-it-39-s-running" class="headerlink" title="1.&#x70B9;&#x51FB;Install GitLab Runner and ensure it&apos;s running."></a>1.&#x70B9;&#x51FB;<code>Install GitLab Runner and ensure it&apos;s running.</code></h4><p>&#x8FDB;&#x5165;&#x94FE;&#x63A5;&#xFF1A;<a href="https://docs.gitlab.com/runner/install/">https://docs.gitlab.com/runner/install/</a> &#x2013;&gt; <a href="https://docs.gitlab.com/runner/install/linux-manually.html">https://docs.gitlab.com/runner/install/linux-manually.html</a><br>&#x6309;&#x7167;&#x4E0A;&#x9762;&#x6D41;&#x7A0B;&#xFF0C;&#x5B89;&#x88C5;&#x5982;&#x4E0B;&#xFF1A;</p><h4 id="2-CentOS&#x4E0A;&#x5B89;&#x88C5;dpkg&#x547D;&#x4EE4;&#xFF1A;"><a href="#2-CentOS&#x4E0A;&#x5B89;&#x88C5;dpkg&#x547D;&#x4EE4;&#xFF1A;" class="headerlink" title="2.CentOS&#x4E0A;&#x5B89;&#x88C5;dpkg&#x547D;&#x4EE4;&#xFF1A;"></a>2.CentOS&#x4E0A;&#x5B89;&#x88C5;dpkg&#x547D;&#x4EE4;&#xFF1A;</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release</span><br><span class="line">yum repolist</span><br><span class="line">yum install dpkg-devel dpkg-dev</span><br></pre></td></tr></table></figure><p>&#x68C0;&#x67E5;&#x4E0B;&#x662F;amd64&#x8FD8;&#x662F;arm64</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dpkg --print-architecture</span><br><span class="line">amd64</span><br></pre></td></tr></table></figure><h4 id="3-&#x4E0B;&#x8F7D;-gitlab-runner-amd64-rpm"><a href="#3-&#x4E0B;&#x8F7D;-gitlab-runner-amd64-rpm" class="headerlink" title="3.&#x4E0B;&#x8F7D; gitlab-runner_amd64.rpm"></a>3.&#x4E0B;&#x8F7D; gitlab-runner_amd64.rpm</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Replace ${arch} with any of the supported architectures, e.g. amd64, arm, arm64</span><br><span class="line"># A full list of architectures can be found here https://gitlab-runner-downloads.s3.amazonaws.com/latest/index.html</span><br><span class="line">curl -LJO &quot;https://gitlab-runner-downloads.s3.amazonaws.com/latest/rpm/gitlab-runner_amd64.rpm&quot;</span><br></pre></td></tr></table></figure><h4 id="4-&#x5B89;&#x88C5;&#xFF1A;"><a href="#4-&#x5B89;&#x88C5;&#xFF1A;" class="headerlink" title="4.&#x5B89;&#x88C5;&#xFF1A;"></a>4.&#x5B89;&#x88C5;&#xFF1A;</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># rpm -i gitlab-runner_amd64.rpm</span><br><span class="line">warning: gitlab-runner_amd64.rpm: Header V4 RSA/SHA512 Signature, key ID 35dfa027: NOKEY</span><br><span class="line">GitLab Runner: creating gitlab-runner...</span><br><span class="line">Home directory skeleton not used</span><br><span class="line">Runtime platform                                    arch=amd64 os=linux pid=23926 revision=436955cb version=15.11.0</span><br><span class="line">gitlab-runner: the service is not installed</span><br><span class="line">Runtime platform                                    arch=amd64 os=linux pid=23932 revision=436955cb version=15.11.0</span><br><span class="line">gitlab-ci-multi-runner: the service is not installed</span><br><span class="line">Runtime platform                                    arch=amd64 os=linux pid=23950 revision=436955cb version=15.11.0</span><br><span class="line">Runtime platform                                    arch=amd64 os=linux pid=23984 revision=436955cb version=15.11.0</span><br><span class="line"></span><br><span class="line">Check and remove all unused containers (both dangling and unreferenced) including volumes.</span><br><span class="line">------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure><p>&#x5982;&#x679C;&#x6CA1;&#x5B89;&#x88C5;&#x597D;&#xFF0C;&#x53EF;&#x4EE5;&#x5378;&#x8F7D;&#x5E76;&#x91CD;&#x65B0;&#x5B89;&#x88C5;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rpm -qa | grep gitlab-runner</span></span><br><span class="line">gitlab-runner-15.11.0-1.x86_64</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rpm -e gitlab-runner-15.11.0-1.x86_64</span></span><br></pre></td></tr></table></figure><h4 id="5-&#x67E5;&#x770B;&#x8FD0;&#x884C;&#x72B6;&#x6001;&#xFF1A;"><a href="#5-&#x67E5;&#x770B;&#x8FD0;&#x884C;&#x72B6;&#x6001;&#xFF1A;" class="headerlink" title="5.&#x67E5;&#x770B;&#x8FD0;&#x884C;&#x72B6;&#x6001;&#xFF1A;"></a>5.&#x67E5;&#x770B;&#x8FD0;&#x884C;&#x72B6;&#x6001;&#xFF1A;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gitlab-runner status</span></span><br><span class="line">Runtime platform                                    arch=amd64 os=linux pid=24028 revision=436955cb version=15.11.0</span><br><span class="line">gitlab-runner: Service is running</span><br></pre></td></tr></table></figure><h3 id="3-&#x6CE8;&#x518C;gitlab-runner"><a href="#3-&#x6CE8;&#x518C;gitlab-runner" class="headerlink" title="3.&#x6CE8;&#x518C;gitlab-runner"></a>3.&#x6CE8;&#x518C;gitlab-runner</h3><p>&#x662F;&#x4E2A;QA&#x4EA4;&#x4E92;&#x5F0F;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;To register a runner under Linux:<br><a href="https://docs.gitlab.com/runner/register/index.html#linux">https://docs.gitlab.com/runner/register/index.html#linux</a></p><blockquote><p>1.Enter your GitLab instance URL (also known as the gitlab-ci coordinator URL).<br>2.Enter the token you obtained to register the runner.<br>3.Enter a description for the runner. You can change this value later in the GitLab user interface.<br>4.Enter the tags associated with the runner, separated by commas. You can change this value later in the GitLab user interface.<br>5.Enter any optional maintenance note for the runner.<br>6.Provide the runner executor. For most use cases, enter docker.<br>7.If you entered docker as your executor, you are asked for the default image to be used for projects that do not define one in .gitlab-ci.yml.</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@iZj6c8d28ml82iyhgbpnrjZ ~]# gitlab-runner register</span><br><span class="line">Runtime platform                                    arch=amd64 os=linux pid=23707 revision=436955cb version=15.11.0</span><br><span class="line">Running in system-mode.                            </span><br><span class="line"></span><br><span class="line">Enter the GitLab instance URL (for example, https://gitlab.com/):</span><br><span class="line">http://47.243.76.76/</span><br><span class="line"></span><br><span class="line">Enter the registration token:</span><br><span class="line">GR1348941nExJaQHkkHEBskyXF7L4</span><br><span class="line"></span><br><span class="line">Enter a description for the runner:</span><br><span class="line">[iZj6c8d28ml82iyhgbpnrjZ]: user-service@uat</span><br><span class="line"></span><br><span class="line">Enter tags for the runner (comma-separated):</span><br><span class="line">hk-aliyun</span><br><span class="line"></span><br><span class="line">Enter optional maintenance note for the runner:</span><br><span class="line">note:xxx</span><br><span class="line">WARNING: Support for registration tokens and runner parameters in the &apos;register&apos; command has been deprecated in GitLab Runner 15.6 and will be replaced with support for authentication tokens. For more information, see https://gitlab.com/gitlab-org/gitlab/-/issues/380872</span><br><span class="line">Registering runner... succeeded                     runner=GR1348941Up79GQim</span><br><span class="line"></span><br><span class="line">Enter an executor: docker-ssh+machine, instance, docker, docker-windows, shell, ssh, docker-autoscaler, docker+machine, kubernetes, custom, docker-ssh, parallels, virtualbox:</span><br><span class="line">shell</span><br><span class="line"></span><br><span class="line">Runner registered successfully. Feel free to start it, but if it\&apos;s running already the config should be automatically reloaded!</span><br><span class="line"></span><br><span class="line">Configuration (with the authentication token) was saved in &quot;/etc/gitlab-runner/config.toml&quot;</span><br></pre></td></tr></table></figure><p>&#x521A;&#x624D;QA&#x5F0F;&#x7684;&#x521B;&#x5EFA;runner&#xFF0C;&#x4F1A;&#x5199;&#x5165; <code>/etc/gitlab-runner/config.toml</code>&#xFF0C; &#x67E5;&#x770B;&#x4E0B;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /etc/gitlab-runner/config.toml</span></span><br><span class="line">concurrent = 1</span><br><span class="line">check_interval = 0</span><br><span class="line">shutdown_timeout = 0</span><br><span class="line"></span><br><span class="line">[session_server]</span><br><span class="line">  session_timeout = 1800</span><br><span class="line"></span><br><span class="line">[[runners]]</span><br><span class="line">  name = &quot;user-service@uat&quot;</span><br><span class="line">  url = &quot;http://47.243.76.76/&quot;</span><br><span class="line">  id = 1</span><br><span class="line">  token = &quot;DYbAzYGs2swCxb_dqxfq&quot;</span><br><span class="line">  token_obtained_at = 2023-04-30T14:56:34Z</span><br><span class="line">  token_expires_at = 0001-01-01T00:00:00Z</span><br><span class="line">  executor = &quot;shell&quot;</span><br><span class="line">  [runners.cache]</span><br><span class="line">    MaxUploadedArchiveSize = 0</span><br></pre></td></tr></table></figure><h3 id="4-&#x9A8C;&#x8BC1;"><a href="#4-&#x9A8C;&#x8BC1;" class="headerlink" title="4.&#x9A8C;&#x8BC1;"></a>4.&#x9A8C;&#x8BC1;</h3><p>&#x5230;&#x8FD9;&#x91CC;&#xFF0C;<code>gitlab-runner</code> &#x5DF2;&#x7ECF;&#x521B;&#x5EFA;&#x597D;&#x4E86;&#xFF0C;&#x5230;&#x672C;&#x5730;&#x9879;&#x76EE;&#x4E0B;&#xFF0C;&#x968F;&#x4FBF;&#x66F4;&#x6539;&#x4E2A;&#x4E1C;&#x897F;&#xFF0C;&#x7136;&#x540E;&#x63A8;&#x9001;&#x5230;gitlab&#xFF0C;&#x5230;gitlab&#x7684;&#x9879;&#x76EE;&#xFF1A;<code>user-service</code>&#x4E0B;&#xFF0C;<code>CI/CD--Pipelines</code></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C004.Infrastructure.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--2.%E5%AE%89%E8%A3%85gitlab-runner/iLfqg3.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C004.Infrastructure.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--2.%E5%AE%89%E8%A3%85gitlab-runner/iLfuLy.png"></p><p>&#x56DE;&#x5230;&#x9879;&#x76EE;user-service&#x91CC;&#x7684; settings&#x2013;CI/CD&#xFF0C;&#x5C55;&#x5F00;Runner&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;</p><blockquote><p>Tips&#xFF1A;<br>&#x5728;&#x670D;&#x52A1;&#x5668;B&#x4E2D;&#xFF0C;&#x6CE8;&#x518C;runner&#x540E;&#xFF0C;&#x4F1A;&#x5728;home&#x76EE;&#x5F55;&#x4E0B;&#xFF0C;&#x4F1A;&#x6709;&#x4E2A; gitlab-runner &#x76EE;&#x5F55;&#x3002;&#x6362;&#x8A00;&#x4E4B;&#x4F1A;&#x5728;centos&#x7CFB;&#x7EDF;&#x4E2D;&#xFF0C;&#x521B;&#x5EFA;&#x4E2A; <code>gitlab-runner</code> &#x7528;&#x6237;&#xFF1B;</p></blockquote><p>&#x5207;&#x6362;&#x7528;&#x6237;: gitlab-runer</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - gitlab-runner</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5728;&amp;#x670D;&amp;#x52A1;&amp;#x5668;B&amp;#x5B9E;&amp;#x73B0;&amp;#xFF1A;&quot;&gt;&lt;a href=&quot;#&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5728;&amp;#x670D;&amp;#x52A1;&amp;#x5668;B&amp;#x5B9E;&amp;#x73B0;&amp;#xFF1A;&quot; class=&quot;headerlink&quot; title=&quot;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5728;&amp;#x670D;&amp;#x52A1;&amp;#x5668;B&amp;#x5B9E;&amp;#x73B0;&amp;#xFF1A;&quot;&gt;&lt;/a&gt;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5728;&amp;#x670D;&amp;#x52A1;&amp;#x5668;B&amp;#x5B9E;&amp;#x73B0;&amp;#xFF1A;&lt;/h2&gt;&lt;p&gt;1.&amp;#x5B89;&amp;#x88C5;&lt;code&gt;docker&lt;/code&gt;&lt;br&gt;2.&amp;#x5B89;&amp;#x88C5;&lt;code&gt;git&lt;/code&gt;&lt;br&gt;3.&amp;#x5B89;&amp;#x88C5;&lt;code&gt;gitlab-runner&lt;/code&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Infrastructure" scheme="http://example.com/categories/Infrastructure/"/>
    
    
    <category term="gitlab-runner" scheme="http://example.com/tags/gitlab-runner/"/>
    
    <category term="GCP-GKE" scheme="http://example.com/tags/GCP-GKE/"/>
    
  </entry>
  
  <entry>
    <title>Infrastructure-GCP系列.gitlab-runner实现java微服务CICD--1.安装gitlab-ce</title>
    <link href="http://example.com/2023/06/20/18.C005.Infrastructure-GCP%E7%B3%BB%E5%88%97.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--1.%E5%AE%89%E8%A3%85gitlab-ce/"/>
    <id>http://example.com/2023/06/20/18.C005.Infrastructure-GCP%E7%B3%BB%E5%88%97.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--1.%E5%AE%89%E8%A3%85gitlab-ce/</id>
    <published>2023-06-19T16:00:00.000Z</published>
    <updated>2023-10-12T11:14:33.402Z</updated>
    
    <content type="html"><![CDATA[<h2 id="&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;A&#x5B9E;&#x73B0;&#xFF1A;"><a href="#&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;A&#x5B9E;&#x73B0;&#xFF1A;" class="headerlink" title="&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;A&#x5B9E;&#x73B0;&#xFF1A;"></a>&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;A&#x5B9E;&#x73B0;&#xFF1A;</h2><p>1.&#x5B89;&#x88C5;<code>docker</code><br>2.&#x5B89;&#x88C5;<code>git</code><br>3.&#x5B89;&#x88C5;<code>gitlab-ce</code></p><span id="more"></span><h2 id="&#x670D;&#x52A1;&#x5668;A&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;"><a href="#&#x670D;&#x52A1;&#x5668;A&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;" class="headerlink" title="&#x670D;&#x52A1;&#x5668;A&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;"></a>&#x670D;&#x52A1;&#x5668;A&#x7684;&#x4F5C;&#x7528;&#x4E0E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;</h2><h3 id="&#x4F5C;&#x7528;&#xFF1A;"><a href="#&#x4F5C;&#x7528;&#xFF1A;" class="headerlink" title="&#x4F5C;&#x7528;&#xFF1A;"></a>&#x4F5C;&#x7528;&#xFF1A;</h3><ul><li>&#x90E8;&#x7F72;gitlab-ce&#xFF0C;&#x5C06;&#x9879;&#x76EE;&#x6258;&#x7BA1;&#x81F3;<code>gitlab</code></li></ul><h3 id="&#x914D;&#x7F6E;&#xFF1A;"><a href="#&#x914D;&#x7F6E;&#xFF1A;" class="headerlink" title="&#x914D;&#x7F6E;&#xFF1A;"></a>&#x914D;&#x7F6E;&#xFF1A;</h3><ul><li>&#x9999;&#x6E2F;&#x963F;&#x91CC;&#x4E91;-&#x8F7B;&#x91CF;&#x7EA7;&#x670D;&#x52A1;&#x5668;</li><li>IP&#x5730;&#x5740;  :  (&#x516C;) <code>47.243.76.76</code></li><li>CentoOS 7.6 2&#x6838; 8G <code>root</code>  /  <code>???</code></li></ul><h3 id="1-&#x5B89;&#x88C5;docker"><a href="#1-&#x5B89;&#x88C5;docker" class="headerlink" title="1.&#x5B89;&#x88C5;docker"></a>1.&#x5B89;&#x88C5;docker</h3><ul><li>&#x53C2;&#x8003; <a href="https://xugangxie.github.io/2021/10/07/18.006%20DevOps%E7%B3%BB%E5%88%97-centos7.8%E5%AE%89%E8%A3%85docker%E5%92%8Cdocker-compose/">&#x8FD9;&#x91CC;</a></li></ul><h3 id="2-&#x5B89;&#x88C5;git"><a href="#2-&#x5B89;&#x88C5;git" class="headerlink" title="2.&#x5B89;&#x88C5;git"></a>2.&#x5B89;&#x88C5;git</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum -y install curl-devel expat-devel gettext-devel openssl-devel zlib-devel</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum -y install git</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git --version</span></span><br><span class="line"></span><br><span class="line">git version 1.8.3.1</span><br></pre></td></tr></table></figure><p>&#x5982;&#x679C;&#x8981;&#x751F;&#x7EA7;&#x6216;&#x662F;&#x5B89;&#x88C5;&#x6700;&#x65B0;&#x7248;&#x672C;&#x7684;git&#xFF0C;&#x53EF;&#x4EE5;&#xFF1A;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install http://opensource.wandisco.com/centos/7/git/x86_64/wandisco-git-release-7-2.noarch.rpm</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum -y install git</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git --version</span></span><br><span class="line">git version 2.39.1</span><br></pre></td></tr></table></figure><h3 id="3-&#x5B89;&#x88C5;curl"><a href="#3-&#x5B89;&#x88C5;curl" class="headerlink" title="3.&#x5B89;&#x88C5;curl"></a>3.&#x5B89;&#x88C5;curl</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum -y install curl</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl --version</span></span><br></pre></td></tr></table></figure><h3 id="3-&#x5B89;&#x88C5;gitlab"><a href="#3-&#x5B89;&#x88C5;gitlab" class="headerlink" title="3.&#x5B89;&#x88C5;gitlab"></a>3.&#x5B89;&#x88C5;gitlab</h3><p><code>https://packages.gitlab.com/gitlab/gitlab-ce</code> &#x4E0A;&#xFF0C;&#x70B9;&#x51FB;<code>RPM</code>&#x56FE;&#x6807;&#xFF0C;<br>&#x627E;&#x5230; <code>RPM Installation Instructions</code> &#x4E0B;&#x7684;&#x955C;&#x50CF;&#x6E90;&#x547D;&#x4EE4;<br>(&#x622A;&#x81F3;&#x5230;&#x76EE;&#x524D;&#xFF0C;&#x8BE5;&#x955C;&#x50CF;&#x6E90;&#x7684;&#x7248;&#x672C;&#x662F;&#xFF1A;<code>gitlab-ce.x86_64 0:15.11.0-ce.0.el7</code>)</p><h4 id="1-&#x5B89;&#x88C5;&#x955C;&#x50CF;&#x6E90;"><a href="#1-&#x5B89;&#x88C5;&#x955C;&#x50CF;&#x6E90;" class="headerlink" title="1.&#x5B89;&#x88C5;&#x955C;&#x50CF;&#x6E90;"></a>1.&#x5B89;&#x88C5;&#x955C;&#x50CF;&#x6E90;</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash</span><br></pre></td></tr></table></figure><h4 id="2-&#x5B89;&#x88C5;-yum-install-gitlab-ce"><a href="#2-&#x5B89;&#x88C5;-yum-install-gitlab-ce" class="headerlink" title="2.&#x5B89;&#x88C5;: yum install gitlab-ce"></a>2.&#x5B89;&#x88C5;: yum install gitlab-ce</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install gitlab-ce</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">Resolving Dependencies</span><br><span class="line"><span class="meta prompt_">--&gt; </span><span class="language-bash">Running transaction check</span></span><br><span class="line"><span class="meta prompt_">---&gt; </span><span class="language-bash">Package gitlab-ce.x86_64 0:15.11.0-ce.0.el7 will be installed</span></span><br><span class="line"><span class="meta prompt_">--&gt; </span><span class="language-bash">Finished Dependency Resolution</span></span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">===============================================================================================================================================</span><br><span class="line"> Package                        Arch                        Version                                Repository                             Size</span><br><span class="line">===============================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> gitlab-ce                      x86_64                      15.11.0-ce.0.el7                       gitlab_gitlab-ce                      1.2 G</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">===============================================================================================================================================</span><br><span class="line">Install  1 Package</span><br><span class="line"></span><br><span class="line">Total download size: 1.2 G</span><br><span class="line">Installed size: 2.6 G</span><br><span class="line">Is this ok [y/d/N]: y</span><br><span class="line">Downloading packages:</span><br><span class="line">warning: /var/cache/yum/x86_64/7/gitlab_gitlab-ce/packages/gitlab-ce-15.11.0-ce.0.el7.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID f27eab47: NOKEY</span><br><span class="line">Public key for gitlab-ce-15.11.0-ce.0.el7.x86_64.rpm is not installed</span><br><span class="line">gitlab-ce-15.11.0-ce.0.el7.x86_64.rpm                                                                                   | 1.2 GB  00:05:55     </span><br><span class="line">Retrieving key from https://packages.gitlab.com/gitlab/gitlab-ce/gpgkey</span><br><span class="line">Importing GPG key 0x51312F3F:</span><br><span class="line"> Userid     : &quot;GitLab B.V. (package repository signing key) &lt;packages@gitlab.com&gt;&quot;</span><br><span class="line"> Fingerprint: f640 3f65 44a3 8863 daa0 b6e0 3f01 618a 5131 2f3f</span><br><span class="line"> From       : https://packages.gitlab.com/gitlab/gitlab-ce/gpgkey</span><br><span class="line">Is this ok [y/N]: y</span><br><span class="line">Retrieving key from https://packages.gitlab.com/gitlab/gitlab-ce/gpgkey/gitlab-gitlab-ce-3D645A26AB9FBD22.pub.gpg</span><br><span class="line">Importing GPG key 0xF27EAB47:</span><br><span class="line"> Userid     : &quot;GitLab, Inc. &lt;support@gitlab.com&gt;&quot;</span><br><span class="line"> Fingerprint: dbef 8977 4ddb 9eb3 7d9f c3a0 3cfc f9ba f27e ab47</span><br><span class="line"> From       : https://packages.gitlab.com/gitlab/gitlab-ce/gpgkey/gitlab-gitlab-ce-3D645A26AB9FBD22.pub.gpg</span><br><span class="line">Is this ok [y/N]: y</span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction test</span><br><span class="line">Transaction test succeeded</span><br><span class="line">Running transaction</span><br><span class="line">  Installing : gitlab-ce-15.11.0-ce.0.el7.x86_64                                                                                           1/1</span><br><span class="line">It looks like GitLab has not been configured yet; skipping the upgrade script.</span><br><span class="line"></span><br><span class="line">       *.                  *.</span><br><span class="line">      ***                 ***</span><br><span class="line">     *****               *****</span><br><span class="line">    .******             *******</span><br><span class="line">    ********            ********</span><br><span class="line">   ,,,,,,,,,***********,,,,,,,,,</span><br><span class="line">  ,,,,,,,,,,,*********,,,,,,,,,,,</span><br><span class="line">  .,,,,,,,,,,,*******,,,,,,,,,,,,</span><br><span class="line">      ,,,,,,,,,*****,,,,,,,,,.</span><br><span class="line">         ,,,,,,,****,,,,,,</span><br><span class="line">            .,,,***,,,,</span><br><span class="line">                ,*,.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     _______ __  __          __</span><br><span class="line">    / ____(_) /_/ /   ____ _/ /_</span><br><span class="line">   / / __/ / __/ /   / __ `/ __ \</span><br><span class="line">  / /_/ / / /_/ /___/ /_/ / /_/ /</span><br><span class="line">  \____/_/\__/_____/\__,_/_.___/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Thank you for installing GitLab!</span><br><span class="line">GitLab was unable to detect a valid hostname for your instance.</span><br><span class="line">Please configure a URL for your GitLab instance by setting `external_url`</span><br><span class="line">configuration in /etc/gitlab/gitlab.rb file.</span><br><span class="line">Then, you can start your GitLab instance by running the following command:</span><br><span class="line">  sudo gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line">For a comprehensive list of configuration options please see the Omnibus GitLab readme</span><br><span class="line">https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md</span><br><span class="line"></span><br><span class="line">Help us improve the installation experience, let us know how we did with a 1 minute survey:</span><br><span class="line">https://gitlab.fra1.qualtrics.com/jfe/form/SV_6kVqZANThUQ1bZb?installation=omnibus&amp;release=15-11</span><br><span class="line"></span><br><span class="line">  Verifying  : gitlab-ce-15.11.0-ce.0.el7.x86_64                                                                                           1/1</span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  gitlab-ce.x86_64 0:15.11.0-ce.0.el7                                                                                                          </span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure><p>&#x5230;&#x6B64;&#x5DF2;&#x7ECF;&#x5B89;&#x88C5;&#x597D;&#x4E86;&#xFF0C;&#x53EF;&#x4EE5;&#x542F;&#x52A8;&#x4F7F;&#x7528;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x7531;&#x4E8E;&#x5176;&#x5185;&#x5B58;&#x5360;&#x7528;&#x8F83;&#x5927;&#xFF0C;&#x6545;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x6839;&#x636E;&#x5B9E;&#x9645;&#x60C5;&#x51B5;&#x8BBE;&#x7F6E;&#x4E00;&#x4E9B;&#x914D;&#x7F6E;&#xFF0C;&#x4FEE;&#x6539;&#x914D;&#x7F6E;&#x540E;&#x8FD8;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x914D;&#x7F6E;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x91CD;&#x65B0;&#x542F;&#x52A8;</p><h4 id="3-&#x4F18;&#x5316;&#x914D;&#x7F6E;"><a href="#3-&#x4F18;&#x5316;&#x914D;&#x7F6E;" class="headerlink" title="3.&#x4F18;&#x5316;&#x914D;&#x7F6E;"></a>3.&#x4F18;&#x5316;&#x914D;&#x7F6E;</h4><h5 id="3-1-&#x4FEE;&#x6539;-external-url"><a href="#3-1-&#x4FEE;&#x6539;-external-url" class="headerlink" title="3.1 &#x4FEE;&#x6539; external_url"></a>3.1 &#x4FEE;&#x6539; external_url</h5><p>&#x7F16;&#x8F91;/etc/gitlab/gitlab.rb&#x6587;&#x4EF6;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/gitlab/gitlab.rb</span><br></pre></td></tr></table></figure><p>&#x4FEE;&#x6539;external_url&#xFF0C;&#x76F4;&#x63A5;&#x589E;&#x52A0;&#x7AEF;&#x53E3;&#x53F7;&#x5373;&#x53EF;&#xFF0C;&#x6BD4;&#x5982;&#x6211;&#x8FD9;&#x91CC;&#x7528;80&#x7AEF;&#x53E3;&#xFF1A;<br>(&#x627E;&#x5230; <code>external_url &apos;http://gitlab.example.com&apos;</code>&#xFF0C;&#x6539;&#x6210;)<br><code>external_url &apos;http://47.243.76.76&apos;</code></p><h4 id="4-&#x52A0;&#x8F7D;&#x914D;&#x7F6E;"><a href="#4-&#x52A0;&#x8F7D;&#x914D;&#x7F6E;" class="headerlink" title="4.&#x52A0;&#x8F7D;&#x914D;&#x7F6E;"></a>4.&#x52A0;&#x8F7D;&#x914D;&#x7F6E;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gitlab-ctl reconfigure</span></span><br><span class="line">&#x8017;&#x65F6;&#x6BD4;&#x8F83;&#x957F;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="5-&#x67E5;&#x770B;&#x72B6;&#x6001;"><a href="#5-&#x67E5;&#x770B;&#x72B6;&#x6001;" class="headerlink" title="5.&#x67E5;&#x770B;&#x72B6;&#x6001;"></a>5.&#x67E5;&#x770B;&#x72B6;&#x6001;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gitlab-ctl status</span></span><br><span class="line">run: alertmanager: (pid 7293) 112s; run: log: (pid 7131) 155s</span><br><span class="line">run: gitaly: (pid 7240) 120s; run: log: (pid 24689) 266s</span><br><span class="line">run: gitlab-exporter: (pid 7271) 114s; run: log: (pid 7037) 171s</span><br><span class="line">run: gitlab-kas: (pid 7250) 116s; run: log: (pid 24856) 255s</span><br><span class="line">run: gitlab-workhorse: (pid 7258) 115s; run: log: (pid 6950) 187s</span><br><span class="line">run: logrotate: (pid 24607) 281s; run: log: (pid 24616) 277s</span><br><span class="line">run: nginx: (pid 6960) 186s; run: log: (pid 6983) 183s</span><br><span class="line">run: node-exporter: (pid 7266) 115s; run: log: (pid 7014) 177s</span><br><span class="line">run: postgres-exporter: (pid 7302) 112s; run: log: (pid 7167) 147s</span><br><span class="line">run: postgresql: (pid 24723) 262s; run: log: (pid 24734) 261s</span><br><span class="line">run: prometheus: (pid 7279) 113s; run: log: (pid 7070) 159s</span><br><span class="line">run: puma: (pid 6888) 200s; run: log: (pid 6895) 199s</span><br><span class="line">run: redis: (pid 24638) 275s; run: log: (pid 24656) 272s</span><br><span class="line">run: redis-exporter: (pid 7273) 114s; run: log: (pid 7051) 167s</span><br><span class="line">run: sidekiq: (pid 6905) 194s; run: log: (pid 6921) 193s</span><br></pre></td></tr></table></figure><h4 id="6-&#x5176;&#x4ED6;&#x547D;&#x4EE4;"><a href="#6-&#x5176;&#x4ED6;&#x547D;&#x4EE4;" class="headerlink" title="6.&#x5176;&#x4ED6;&#x547D;&#x4EE4;:"></a>6.&#x5176;&#x4ED6;&#x547D;&#x4EE4;:</h4><p>&#x91CD;&#x65B0;&#x542F;&#x52A8;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl restart</span><br></pre></td></tr></table></figure><h4 id="7-&#x8BBF;&#x95EE;gitlab"><a href="#7-&#x8BBF;&#x95EE;gitlab" class="headerlink" title="7.&#x8BBF;&#x95EE;gitlab"></a>7.&#x8BBF;&#x95EE;gitlab</h4><p>&#x518D;&#x6B21;&#x8F93;&#x5165;&#x6D4F;&#x89C8;&#x5668;&#x8F93;&#x5165;&#x5730;&#x5740;&#xFF1A;<code>http://47.243.76.76</code>&#xFF0C;&#x53EF;&#x4EE5;&#x6253;&#x5F00;<br>&#x521D;&#x88C5;&#x4EE5;&#x540E;&#xFF0C;&#x628A;&#x5BC6;&#x7801;&#x653E;&#x5728;&#x4E86;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x4E2D;&#xFF1A;<code>/etc/gitlab/initial_root_password</code>&#xFF0C;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x5C06;&#x5728;&#x9996;&#x6B21;&#x6267;&#x884C;reconfigure&#x540E;24&#x5C0F;&#x65F6;&#x81EA;&#x52A8;&#x5220;&#x9664;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/gitlab/initial_root_password</span><br><span class="line"># WARNING: This value is valid only in the following conditions</span><br><span class="line">#          1. If provided manually (either via `GITLAB_ROOT_PASSWORD` environment variable or via `gitlab_rails[&apos;initial_root_password&apos;]` setting in `gitlab.rb`, it was provided before database was seeded for the first time (usually, the first reconfigure run).</span><br><span class="line">#          2. Password hasn&apos;t been changed manually, either via UI or via command line.</span><br><span class="line">#</span><br><span class="line">#          If the password shown here doesn&apos;t work, you must reset the admin password following https://docs.gitlab.com/ee/security/reset_user_password.html#reset-your-root-password.</span><br><span class="line"></span><br><span class="line">Password: 94oiZZ956k9yliJz5qclir9ZY0yGDNPiP0OMElf+//U=</span><br><span class="line"></span><br><span class="line"># NOTE: This file will be automatically deleted in the first reconfigure run after 24 hours.</span><br></pre></td></tr></table></figure><p><code>root</code> / <code>94oiZZ956k9yliJz5qclir9ZY0yGDNPiP0OMElf+//U=</code><br>&#x767B;&#x5F55;&#x8FDB;&#x53BB;&#x540E;&#xFF0C;&#x70B9;&#x51FB;&#x5DE6;&#x4E0A;&#x65B9;Meus&#x2013;&gt;Admin&#xFF0C;&#x627E;&#x5230;&#x5DE6;&#x8FB9;&#x7684;Overview&#x2013;Users&#xFF0C;&#x53F3;&#x8FB9;&#x5217;&#x8868;&#x91CC;&#x6709;&#x4E2A;Administrator&#xFF0C;&#x70B9;&#x51FB;Edit&#xFF0C;&#x8FDB;&#x5165;&#x4FEE;&#x6539;&#x5BC6;&#x7801;&#x4E3A;&#xFF1A;<code>xiexugang</code><br>&#x56E0;&#x6B64;&#xFF0C;&#x76EE;&#x524D;&#x7528;&#x6237;&#x540D;&#x5BC6;&#x7801;&#x4E3A;&#xFF1A;<code>root</code> / <code>xiexugang</code></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C005.Infrastructure.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--1.%E5%AE%89%E8%A3%85gitlab-ce/iLyiU5.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.C005.Infrastructure.gitlab-runner%E5%AE%9E%E7%8E%B0java%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD--1.%E5%AE%89%E8%A3%85gitlab-ce/iLyVR8.png"></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5728;&amp;#x670D;&amp;#x52A1;&amp;#x5668;A&amp;#x5B9E;&amp;#x73B0;&amp;#xFF1A;&quot;&gt;&lt;a href=&quot;#&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5728;&amp;#x670D;&amp;#x52A1;&amp;#x5668;A&amp;#x5B9E;&amp;#x73B0;&amp;#xFF1A;&quot; class=&quot;headerlink&quot; title=&quot;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5728;&amp;#x670D;&amp;#x52A1;&amp;#x5668;A&amp;#x5B9E;&amp;#x73B0;&amp;#xFF1A;&quot;&gt;&lt;/a&gt;&amp;#x672C;&amp;#x7BC7;&amp;#x4E3B;&amp;#x8981;&amp;#x5728;&amp;#x670D;&amp;#x52A1;&amp;#x5668;A&amp;#x5B9E;&amp;#x73B0;&amp;#xFF1A;&lt;/h2&gt;&lt;p&gt;1.&amp;#x5B89;&amp;#x88C5;&lt;code&gt;docker&lt;/code&gt;&lt;br&gt;2.&amp;#x5B89;&amp;#x88C5;&lt;code&gt;git&lt;/code&gt;&lt;br&gt;3.&amp;#x5B89;&amp;#x88C5;&lt;code&gt;gitlab-ce&lt;/code&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Infrastructure" scheme="http://example.com/categories/Infrastructure/"/>
    
    
    <category term="gitlab-runner" scheme="http://example.com/tags/gitlab-runner/"/>
    
    <category term="GCP-GKE" scheme="http://example.com/tags/GCP-GKE/"/>
    
  </entry>
  
  <entry>
    <title>java8系列-时间日期API</title>
    <link href="http://example.com/2023/04/28/14.006%20java8%E7%B3%BB%E5%88%97-%E6%97%B6%E9%97%B4%E6%97%A5%E6%9C%9FAPI/"/>
    <id>http://example.com/2023/04/28/14.006%20java8%E7%B3%BB%E5%88%97-%E6%97%B6%E9%97%B4%E6%97%A5%E6%9C%9FAPI/</id>
    <published>2023-04-27T16:00:00.000Z</published>
    <updated>2023-10-11T13:29:44.101Z</updated>
    
    <content type="html"><![CDATA[<p>&#x53EF;&#x4EE5;&#x5F88;&#x6E05;&#x6670;&#x7684;&#x770B;&#x51FA;ZonedDateTime&#x76F8;&#x5F53;&#x4E8E;LocalDateTime+ZoneId&#x3002;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/java8-%20%E6%97%A5%E6%9C%9F%E6%97%B6%E9%97%B4API.png"></p><span id="more"></span><h3 id="&#x65F6;&#x533A;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#xFF0C;&#x65F6;&#x533A;&#xFF0C;UTC&#x65F6;&#x95F4;&#xFF0C;GMT&#x65F6;&#x95F4;&#xFF0C;Unix&#x65F6;&#x95F4;&#x6233;"><a href="#&#x65F6;&#x533A;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#xFF0C;&#x65F6;&#x533A;&#xFF0C;UTC&#x65F6;&#x95F4;&#xFF0C;GMT&#x65F6;&#x95F4;&#xFF0C;Unix&#x65F6;&#x95F4;&#x6233;" class="headerlink" title="&#x65F6;&#x533A;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#xFF0C;&#x65F6;&#x533A;&#xFF0C;UTC&#x65F6;&#x95F4;&#xFF0C;GMT&#x65F6;&#x95F4;&#xFF0C;Unix&#x65F6;&#x95F4;&#x6233;"></a>&#x65F6;&#x533A;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#xFF0C;&#x65F6;&#x533A;&#xFF0C;UTC&#x65F6;&#x95F4;&#xFF0C;GMT&#x65F6;&#x95F4;&#xFF0C;Unix&#x65F6;&#x95F4;&#x6233;</h3><h4 id="&#x65F6;&#x533A;"><a href="#&#x65F6;&#x533A;" class="headerlink" title="&#x65F6;&#x533A;"></a>&#x65F6;&#x533A;</h4><p>&#x5730;&#x7403;&#x81EA;&#x897F;&#x5411;&#x4E1C;&#x65CB;&#x8F6C;&#xFF0C;&#x4E1C;&#x8FB9;&#x6BD4;&#x897F;&#x8FB9;&#x5148;&#x770B;&#x5230;&#x592A;&#x9633;&#xFF0C;&#x4E1C;&#x8FB9;&#x7684;&#x65F6;&#x95F4;&#x4E5F;&#x6BD4;&#x897F;&#x8FB9;&#x7684;&#x65E9;&#x3002;&#x4E3A;&#x4E86;&#x7EDF;&#x4E00;&#x4E16;&#x754C;&#x7684;&#x65F6;&#x95F4;&#xFF0C;1884&#x5E74;&#x7684;&#x56FD;&#x9645;&#x7ECF;&#x5EA6;&#x4F1A;&#x8BAE;&#x89C4;&#x89C4;&#x5B9A;&#x5C06;&#x5168;&#x7403;&#x5212;&#x5206;&#x4E3A;24&#x4E2A;&#x65F6;&#x533A;&#xFF08;&#x4E1C;&#x3001;&#x897F;&#x5404;12&#x4E2A;&#x65F6;&#x533A;&#xFF09;&#x3002;&#x89C4;&#x5B9A;&#x82F1;&#x56FD;&#xFF08;&#x683C;&#x6797;&#x5C3C;&#x6CBB;&#x5929;&#x6587;&#x53F0;&#x65E7;&#x5740;&#xFF09;&#x4E3A;&#x96F6;&#x65F6;&#x533A;&#xFF08;GMT+00&#xFF09;&#xFF0C;&#x4E1C;1-12&#x533A;&#xFF0C;&#x897F;1-12&#x533A;&#xFF0C;&#x4E2D;&#x56FD;&#x5317;&#x4EAC;&#x5904;&#x4E8E;&#x4E1C;8&#x533A;&#xFF08;GMT+08&#xFF09;&#x3002;</p><p>&#x82E5;&#x82F1;&#x56FD;&#x65F6;&#x95F4;&#x4E3A;6&#x70B9;&#x6574;&#xFF0C;&#x5219;GMT&#x65F6;&#x95F4;&#x4E3A;6&#x70B9;&#x6574;&#xFF0C;&#x5219;&#x5317;&#x4EAC;&#x65F6;&#x95F4;&#x4E3A;14&#x70B9;&#x6574;&#x3002;</p><h4 id="GMT&#x548C;UTC"><a href="#GMT&#x548C;UTC" class="headerlink" title="GMT&#x548C;UTC"></a>GMT&#x548C;UTC</h4><p>GMT&#xFF0C;&#x5373;&#x683C;&#x6797;&#x5C3C;&#x6CBB;&#x6807;&#x51C6;&#x65F6;&#x95F4;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x4E16;&#x754C;&#x65F6;&#x3002;GMT&#x7684;&#x6B63;&#x5348;&#x662F;&#x6307;&#x5F53;&#x592A;&#x9633;&#x6A2A;&#x7A7F;&#x683C;&#x6797;&#x5C3C;&#x6CBB;&#x5B50;&#x5348;&#x7EBF;&#xFF08;&#x672C;&#x521D;&#x5B50;&#x5348;&#x7EBF;&#xFF09;&#x65F6;&#x7684;&#x65F6;&#x95F4;&#x3002;&#x4F46;&#x7531;&#x4E8E;&#x5730;&#x7403;&#x81EA;&#x8F6C;&#x4E0D;&#x5747;&#x5300;&#x4E0D;&#x89C4;&#x5219;&#xFF0C;&#x5BFC;&#x81F4;GMT&#x4E0D;&#x7CBE;&#x786E;&#xFF0C;&#x73B0;&#x5728;&#x5DF2;&#x7ECF;&#x4E0D;&#x518D;&#x4F5C;&#x4E3A;&#x4E16;&#x754C;&#x6807;&#x51C6;&#x65F6;&#x95F4;&#x4F7F;&#x7528;&#x3002;</p><p>UTC&#xFF0C;&#x5373;&#x534F;&#x8C03;&#x4E16;&#x754C;&#x65F6;&#x3002;UTC&#x662F;&#x4EE5;&#x539F;&#x5B50;&#x65F6;&#x79D2;&#x957F;&#x4E3A;&#x57FA;&#x7840;&#xFF0C;&#x5728;&#x65F6;&#x523B;&#x4E0A;&#x5C3D;&#x91CF;&#x63A5;&#x8FD1;&#x4E8E;GMT&#x7684;&#x4E00;&#x79CD;&#x65F6;&#x95F4;&#x8BA1;&#x91CF;&#x7CFB;&#x7EDF;&#x3002;&#x4E3A;&#x786E;&#x4FDD;UTC&#x4E0E;GMT&#x76F8;&#x5DEE;&#x4E0D;&#x4F1A;&#x8D85;&#x8FC7;0.9&#x79D2;&#xFF0C;&#x5728;&#x6709;&#x9700;&#x8981;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x5728;UTC&#x5185;&#x52A0;&#x4E0A;&#x6B63;&#x6216;&#x8D1F;&#x95F0;&#x79D2;&#x3002;UTC&#x73B0;&#x5728;&#x4F5C;&#x4E3A;&#x4E16;&#x754C;&#x6807;&#x51C6;&#x65F6;&#x95F4;&#x4F7F;&#x7528;&#x3002;</p><p>&#x6240;&#x4EE5;&#xFF0C;UTC&#x4E0E;GMT&#x57FA;&#x672C;&#x4E0A;&#x7B49;&#x540C;&#xFF0C;&#x8BEF;&#x5DEE;&#x4E0D;&#x8D85;&#x8FC7;0.9&#x79D2;&#x3002;</p><h4 id="UNIX&#x65F6;&#x95F4;&#x6233;"><a href="#UNIX&#x65F6;&#x95F4;&#x6233;" class="headerlink" title="UNIX&#x65F6;&#x95F4;&#x6233;"></a>UNIX&#x65F6;&#x95F4;&#x6233;</h4><p>&#x8BA1;&#x7B97;&#x673A;&#x4E2D;&#x7684;UNIX&#x65F6;&#x95F4;&#x6233;&#xFF0C;&#x662F;&#x4EE5;GMT/UTC&#x65F6;&#x95F4;&#x300C;1970-01-01T00:00:00&#x300D;&#x4E3A;&#x8D77;&#x70B9;&#xFF0C;&#x5230;&#x5177;&#x4F53;&#x65F6;&#x95F4;&#x7684;&#x79D2;&#x6570;&#xFF0C;&#x4E0D;&#x8003;&#x8651;&#x95F0;&#x79D2;&#x3002;&#x8FD9;&#x4E48;&#x505A;&#x5F53;&#x7136;&#x662F;&#x4E3A;&#x4E86;&#x7B80;&#x5316;&#x8BA1;&#x7B97;&#x673A;&#x5BF9;&#x65F6;&#x95F4;&#x64CD;&#x4F5C;&#x7684;&#x590D;&#x6742;&#x5EA6;&#x3002;</p><p>&#x6BD4;&#x5982;&#x6211;&#x7684;&#x7535;&#x8111;&#x73B0;&#x5728;&#x7684;&#x7CFB;&#x7EDF;&#x65F6;&#x95F4;&#x4E3A;2015&#x5E74;2&#x6708;27&#x65E5;15&#x70B9;43&#x5206;0&#x79D2;&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x7684;&#x7535;&#x8111;&#x9ED8;&#x8BA4;&#x65F6;&#x533A;&#x4E3A;&#x4E1C;8&#x533A;&#xFF0C;&#x5219;0&#x65F6;&#x533A;&#x7684;&#x65F6;&#x95F4;&#x4E3A;2015&#x5E74;2&#x6708;27&#x65E5;7&#x70B9;43&#x5206;0&#x79D2;&#xFF0C;&#x5219;UNIX&#x65F6;&#x95F4;&#x6233;&#x4E3A;1425022980&#x79D2;&#x3002;</p><h4 id="JAVA-&#x4E2D;&#x5E38;&#x7528;&#x7684;zoneId-&#x6709;2&#x79CD;&#x683C;&#x5F0F;"><a href="#JAVA-&#x4E2D;&#x5E38;&#x7528;&#x7684;zoneId-&#x6709;2&#x79CD;&#x683C;&#x5F0F;" class="headerlink" title="JAVA &#x4E2D;&#x5E38;&#x7528;&#x7684;zoneId &#x6709;2&#x79CD;&#x683C;&#x5F0F;:"></a>JAVA &#x4E2D;&#x5E38;&#x7528;&#x7684;zoneId &#x6709;2&#x79CD;&#x683C;&#x5F0F;:</h4><p>1.&#x65F6;&#x533A;&#x504F;&#x79FB;&#x91CF;&#x7684;&#x5F62;&#x5F0F;&#xFF1A;GMT+8<br>2.&#x533A;&#x57DF;&#x7684;&#x5F62;&#x5F0F;&#xFF1A;Asia/Shanghai&#xFF08;&#x5E38;&#x7528;&#xFF09;&#xFF0C;<strong>java&#x4E2D;&#x4F7F;&#x7528;&#x8BE5;&#x5F62;&#x5F0F;&#x7684;zoneId&#x4F1A;&#x81EA;&#x52A8;&#x8BA1;&#x7B97;&#x590F;&#x4EE4;&#x65F6;</strong>&#x3002;</p><p>&#x6D4B;&#x8BD5;&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">public class ZoneTest {</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) {</span><br><span class="line">TimeZone defaultTimeZone = TimeZone.getDefault();</span><br><span class="line">ZoneId defaultZoneId = ZoneId.systemDefault();</span><br><span class="line">log.info(&quot;\ndefaultZoneId={}\ndefaultTimeZone={}&quot;, defaultTimeZone, defaultZoneId);</span><br><span class="line">//&#x7ED3;&#x679C;&#xFF1A;</span><br><span class="line">//defaultZoneId=sun.util.calendar.ZoneInfo[id=&quot;Asia/Shanghai&quot;,offset=28800000,dstSavings=0,useDaylight=false,transitions=31,lastRule=null]</span><br><span class="line">//defaultTimeZone=Asia/Shanghai</span><br><span class="line"></span><br><span class="line">Set&lt;String&gt; zoneSet = ZoneId.getAvailableZoneIds();</span><br><span class="line">//&#x7ED3;&#x679C;&#xFF1A;</span><br><span class="line">//zoneSet=[Asia/Aden, America/Cuiaba, Etc/GMT+9, Etc/GMT+8, Africa/Nairobi, America/Marigot, Asia/Aqtau, Pacific/Kwajalein, America/El_Salvador, Asia/Pontianak, Africa/Cairo, Pacific/Pago_Pago, Africa/Mbabane, Asia/Kuching, Pacific/Honolulu, Pacific/Rarotonga, America/Guatemala, Australia/Hobart, Europe/London, America/Belize, America/Panama, Asia/Chungking, America/Managua, America/Indiana/Petersburg, Asia/Yerevan, Europe/Brussels, GMT, Europe/Warsaw, America/Chicago, Asia/Kashgar, Chile/Continental, Pacific/Yap, CET, Etc/GMT-1, Etc/GMT-0, Europe/Jersey, America/Tegucigalpa, Etc/GMT-5, Europe/Istanbul, America/Eirunepe, Etc/GMT-4, America/Miquelon, Etc/GMT-3, Europe/Luxembourg, Etc/GMT-2, Etc/GMT-9, America/Argentina/Catamarca, Etc/GMT-8, Etc/GMT-7, Etc/GMT-6, Europe/Zaporozhye, Canada/Yukon, Canada/Atlantic, Atlantic/St_Helena, Australia/Tasmania, Libya, Europe/Guernsey, America/Grand_Turk, Asia/Samarkand, America/Argentina/Cordoba, Asia/Phnom_Penh, Africa/Kigali, Asia/Almaty, US/Alaska, Asia/Dubai, Europe/Isle_of_Man, America/Araguaina, Cuba, Asia/Novosibirsk, America/Argentina/Salta, Etc/GMT+3, Africa/Tunis, Etc/GMT+2, Etc/GMT+1, Pacific/Fakaofo, Africa/Tripoli, Etc/GMT+0, Israel, Africa/Banjul, Etc/GMT+7, Indian/Comoro, Etc/GMT+6, Etc/GMT+5, Etc/GMT+4, Pacific/Port_Moresby, US/Arizona, Antarctica/Syowa, Indian/Reunion, Pacific/Palau, Europe/Kaliningrad, America/Montevideo, Africa/Windhoek, Asia/Karachi, Africa/Mogadishu, Australia/Perth, Brazil/East, Etc/GMT, Asia/Chita, Pacific/Easter, Antarctica/Davis, Antarctica/McMurdo, Asia/Macao, America/Manaus, Africa/Freetown, Europe/Bucharest, Asia/Tomsk, America/Argentina/Mendoza, Asia/Macau, Europe/Malta, Mexico/BajaSur, Pacific/Tahiti, Africa/Asmera, Europe/Busingen, America/Argentina/Rio_Gallegos, Africa/Malabo, Europe/Skopje, America/Catamarca, America/Godthab, Europe/Sarajevo, Australia/ACT, GB-Eire, Africa/Lagos, America/Cordoba, Europe/Rome, Asia/Dacca, Indian/Mauritius, Pacific/Samoa, America/Regina, America/Fort_Wayne, America/Dawson_Creek, Africa/Algiers, Europe/Mariehamn, America/St_Johns, America/St_Thomas, Europe/Zurich, America/Anguilla, Asia/Dili, America/Denver, Africa/Bamako, Europe/Saratov, GB, Mexico/General, Pacific/Wallis, Europe/Gibraltar, Africa/Conakry, Africa/Lubumbashi, Asia/Istanbul, America/Havana, NZ-CHAT, Asia/Choibalsan, America/Porto_Acre, Asia/Omsk, Europe/Vaduz, US/Michigan, Asia/Dhaka, America/Barbados, Europe/Tiraspol, Atlantic/Cape_Verde, Asia/Yekaterinburg, America/Louisville, Pacific/Johnston, Pacific/Chatham, Europe/Ljubljana, America/Sao_Paulo, Asia/Jayapura, America/Curacao, Asia/Dushanbe, America/Guyana, America/Guayaquil, America/Martinique, Portugal, Europe/Berlin, Europe/Moscow, Europe/Chisinau, America/Puerto_Rico, America/Rankin_Inlet, Pacific/Ponape, Europe/Stockholm, Europe/Budapest, America/Argentina/Jujuy, Australia/Eucla, Asia/Shanghai, Universal, Europe/Zagreb, America/Port_of_Spain, Europe/Helsinki, Asia/Beirut, Asia/Tel_Aviv, Pacific/Bougainville, US/Central, Africa/Sao_Tome, Indian/Chagos, America/Cayenne, Asia/Yakutsk, Pacific/Galapagos, Australia/North, Europe/Paris, Africa/Ndjamena, Pacific/Fiji, America/Rainy_River, Indian/Maldives, Australia/Yancowinna, SystemV/AST4, Asia/Oral, America/Yellowknife, Pacific/Enderbury, America/Juneau, Australia/Victoria, America/Indiana/Vevay, Asia/Tashkent, Asia/Jakarta, Africa/Ceuta, Asia/Barnaul, America/Recife, America/Buenos_Aires, America/Noronha, America/Swift_Current, Australia/Adelaide, America/Metlakatla, Africa/Djibouti, America/Paramaribo, Asia/Qostanay, Europe/Simferopol, Europe/Sofia, Africa/Nouakchott, Europe/Prague, America/Indiana/Vincennes, Antarctica/Mawson, America/Kralendijk, Antarctica/Troll, Europe/Samara, Indian/Christmas, America/Antigua, Pacific/Gambier, America/Indianapolis, America/Inuvik, America/Iqaluit, Pacific/Funafuti, UTC, Antarctica/Macquarie, Canada/Pacific, America/Moncton, Africa/Gaborone, Pacific/Chuuk, Asia/Pyongyang, America/St_Vincent, Asia/Gaza, Etc/Universal, PST8PDT, Atlantic/Faeroe, Asia/Qyzylorda, Canada/Newfoundland, America/Kentucky/Louisville, America/Yakutat, Asia/Ho_Chi_Minh, Antarctica/Casey, Europe/Copenhagen, Africa/Asmara, Atlantic/Azores, Europe/Vienna, ROK, Pacific/Pitcairn, America/Mazatlan, Australia/Queensland, Pacific/Nauru, Europe/Tirane, Asia/Kolkata, SystemV/MST7, Australia/Canberra, MET, Australia/Broken_Hill, Europe/Riga, America/Dominica, Africa/Abidjan, America/Mendoza, America/Santarem, Kwajalein, America/Asuncion, Asia/Ulan_Bator, NZ, America/Boise, Australia/Currie, EST5EDT, Pacific/Guam, Pacific/Wake, Atlantic/Bermuda, America/Costa_Rica, America/Dawson, Asia/Chongqing, Eire, Europe/Amsterdam, America/Indiana/Knox, America/North_Dakota/Beulah, Africa/Accra, Atlantic/Faroe, Mexico/BajaNorte, America/Maceio, Etc/UCT, Pacific/Apia, GMT0, America/Atka, Pacific/Niue, Australia/Lord_Howe, Europe/Dublin, Pacific/Truk, MST7MDT, America/Monterrey, America/Nassau, America/Jamaica, Asia/Bishkek, America/Atikokan, Atlantic/Stanley, Australia/NSW, US/Hawaii, SystemV/CST6, Indian/Mahe, Asia/Aqtobe, America/Sitka, Asia/Vladivostok, Africa/Libreville, Africa/Maputo, Zulu, America/Kentucky/Monticello, Africa/El_Aaiun, Africa/Ouagadougou, America/Coral_Harbour, Pacific/Marquesas, Brazil/West, America/Aruba, America/North_Dakota/Center, America/Cayman, Asia/Ulaanbaatar, Asia/Baghdad, Europe/San_Marino, America/Indiana/Tell_City, America/Tijuana, Pacific/Saipan, SystemV/YST9, Africa/Douala, America/Chihuahua, America/Ojinaga, Asia/Hovd, America/Anchorage, Chile/EasterIsland, America/Halifax, Antarctica/Rothera, America/Indiana/Indianapolis, US/Mountain, Asia/Damascus, America/Argentina/San_Luis, America/Santiago, Asia/Baku, America/Argentina/Ushuaia, Atlantic/Reykjavik, Africa/Brazzaville, Africa/Porto-Novo, America/La_Paz, Antarctica/DumontDUrville, Asia/Taipei, Antarctica/South_Pole, Asia/Manila, Asia/Bangkok, Africa/Dar_es_Salaam, Poland, Atlantic/Madeira, Antarctica/Palmer, America/Thunder_Bay, Africa/Addis_Ababa, Asia/Yangon, Europe/Uzhgorod, Brazil/DeNoronha, Asia/Ashkhabad, Etc/Zulu, America/Indiana/Marengo, America/Creston, America/Punta_Arenas, America/Mexico_City, Antarctica/Vostok, Asia/Jerusalem, Europe/Andorra, US/Samoa, PRC, Asia/Vientiane, Pacific/Kiritimati, America/Matamoros, America/Blanc-Sablon, Asia/Riyadh, Iceland, Pacific/Pohnpei, Asia/Ujung_Pandang, Atlantic/South_Georgia, Europe/Lisbon, Asia/Harbin, Europe/Oslo, Asia/Novokuznetsk, CST6CDT, Atlantic/Canary, America/Knox_IN, Asia/Kuwait, SystemV/HST10, Pacific/Efate, Africa/Lome, America/Bogota, America/Menominee, America/Adak, Pacific/Norfolk, Europe/Kirov, America/Resolute, Pacific/Kanton, Pacific/Tarawa, Africa/Kampala, Asia/Krasnoyarsk, Greenwich, SystemV/EST5, America/Edmonton, Europe/Podgorica, Australia/South, Canada/Central, Africa/Bujumbura, America/Santo_Domingo, US/Eastern, Europe/Minsk, Pacific/Auckland, Africa/Casablanca, America/Glace_Bay, Canada/Eastern, Asia/Qatar, Europe/Kiev, Singapore, Asia/Magadan, SystemV/PST8, America/Port-au-Prince, Europe/Belfast, America/St_Barthelemy, Asia/Ashgabat, Africa/Luanda, America/Nipigon, Atlantic/Jan_Mayen, Brazil/Acre, Asia/Muscat, Asia/Bahrain, Europe/Vilnius, America/Fortaleza, Etc/GMT0, US/East-Indiana, America/Hermosillo, America/Cancun, Africa/Maseru, Pacific/Kosrae, Africa/Kinshasa, Asia/Kathmandu, Asia/Seoul, Australia/Sydney, America/Lima, Australia/LHI, America/St_Lucia, Europe/Madrid, America/Bahia_Banderas, America/Montserrat, Asia/Brunei, America/Santa_Isabel, Canada/Mountain, America/Cambridge_Bay, Asia/Colombo, Australia/West, Indian/Antananarivo, Australia/Brisbane, Indian/Mayotte, US/Indiana-Starke, Asia/Urumqi, US/Aleutian, Europe/Volgograd, America/Lower_Princes, America/Vancouver, Africa/Blantyre, America/Rio_Branco, America/Danmarkshavn, America/Detroit, America/Thule, Africa/Lusaka, Asia/Hong_Kong, Iran, America/Argentina/La_Rioja, Africa/Dakar, SystemV/CST6CDT, America/Tortola, America/Porto_Velho, Asia/Sakhalin, Etc/GMT+10, America/Scoresbysund, Asia/Kamchatka, Asia/Thimbu, Africa/Harare, Etc/GMT+12, Etc/GMT+11, Navajo, America/Nome, Europe/Tallinn, Turkey, Africa/Khartoum, Africa/Johannesburg, Africa/Bangui, Europe/Belgrade, Jamaica, Africa/Bissau, Asia/Tehran, WET, Europe/Astrakhan, Africa/Juba, America/Campo_Grande, America/Belem, Etc/Greenwich, Asia/Saigon, America/Ensenada, Pacific/Midway, America/Jujuy, Africa/Timbuktu, America/Bahia, America/Goose_Bay, America/Virgin, America/Pangnirtung, Asia/Katmandu, America/Phoenix, Africa/Niamey, America/Whitehorse, Pacific/Noumea, Asia/Tbilisi, America/Montreal, Asia/Makassar, America/Argentina/San_Juan, Hongkong, UCT, Asia/Nicosia, America/Indiana/Winamac, SystemV/MST7MDT, America/Argentina/ComodRivadavia, America/Boa_Vista, America/Grenada, Asia/Atyrau, Australia/Darwin, Asia/Khandyga, Asia/Kuala_Lumpur, Asia/Famagusta, Asia/Thimphu, Asia/Rangoon, Europe/Bratislava, Asia/Calcutta, America/Argentina/Tucuman, Asia/Kabul, Indian/Cocos, Japan, Pacific/Tongatapu, America/New_York, Etc/GMT-12, Etc/GMT-11, America/Nuuk, Etc/GMT-10, SystemV/YST9YDT, Europe/Ulyanovsk, Etc/GMT-14, Etc/GMT-13, W-SU, America/Merida, EET, America/Rosario, Canada/Saskatchewan, America/St_Kitts, Arctic/Longyearbyen, America/Fort_Nelson, America/Caracas, America/Guadeloupe, Asia/Hebron, Indian/Kerguelen, SystemV/PST8PDT, Africa/Monrovia, Asia/Ust-Nera, Egypt, Asia/Srednekolymsk, America/North_Dakota/New_Salem, Asia/Anadyr, Australia/Melbourne, Asia/Irkutsk, America/Shiprock, America/Winnipeg, Europe/Vatican, Asia/Amman, Etc/UTC, SystemV/AST4ADT, Asia/Tokyo, America/Toronto, Asia/Singapore, Australia/Lindeman, America/Los_Angeles, SystemV/EST5EDT, Pacific/Majuro, America/Argentina/Buenos_Aires, Europe/Nicosia, Pacific/Guadalcanal, Europe/Athens, US/Pacific, Europe/Monaco]</span><br><span class="line">log.info(&quot;\nzoneSet={}&quot;, zoneSet);</span><br><span class="line"></span><br><span class="line">log.info(&quot;==============================&quot;);</span><br><span class="line"></span><br><span class="line">//&#x590F;&#x4EE4;&#x65F6;&#x662F;&#x4ECE;&#x6BCF;&#x5E74;3&#x6708;&#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x661F;&#x671F;&#x65E5;&#x5230;10&#x6708;&#x4EFD;&#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x661F;&#x671F;&#x65E5;&#xFF0C;&#x8FD9;&#x65F6;&#x5FB7;&#x56FD;&#x548C;&#x4E2D;&#x56FD;&#x65F6;&#x5DEE;&#x65F6;6&#x5C0F;&#x65F6;&#xFF0C;&#x4E4B;&#x540E;&#x5C31;&#x8F6C;&#x4E3A;&#x51AC;&#x4EE4;&#x65F6;&#xFF0C;&#x65F6;&#x5DEE;&#x6539;&#x4E3A;7&#x5C0F;&#x65F6;</span><br><span class="line"></span><br><span class="line">//&#x4E2D;&#x56FD;&#x4E0A;&#x6D77;&#x76EE;&#x524D;&#x7684;&#x65F6;&#x95F4;</span><br><span class="line">LocalDateTime shanghaiLocalDateTime = LocalDateTime.now();</span><br><span class="line">ZoneId currentZoneId = OffsetDateTime.now().getOffset();</span><br><span class="line"></span><br><span class="line">//&#x590F;&#x4EE4;&#x65F6;&#x6D4B;&#x8BD5;&#xFF0C;&#x5F53;&#x524D;&#x4E2D;&#x56FD;&#x4E0A;&#x6D77;&#x65F6;&#x95F4;&#x662F;&#xFF1A;2023-04-28T21:46:36.503</span><br><span class="line">//&#x5FB7;&#x56FD;&#x65F6;&#x533A;ID: Europe/Berlin</span><br><span class="line">ZoneId berlinZoneId = ZoneId.of(&quot;Europe/Berlin&quot;);</span><br><span class="line">//&#x5C06;&#x5F53;&#x524D;&#x7684;&#x4E2D;&#x56FD;&#x4E0A;&#x6D77;&#x65F6;&#x95F4;&#xFF0C;&#x8F6C;&#x6362;&#x6210;&#x5FB7;&#x56FD;&#x67CF;&#x6797;&#x65F6;&#x95F4; (&#x5FB7;&#x56FD;&#x6709;&#x590F;&#x4EE4;&#x65F6;&#x548C;&#x51AC;&#x4EE4;&#x65F6;&#xFF0C;2&#x4E2A;&#x65F6;&#x533A;&#xFF0C;&#x4E0B;&#x9762;&#x63A5;&#x53E3;&#x5185;&#x90E8;&#x4F1A;&#x81EA;&#x52A8;&#x8F6C;)</span><br><span class="line">LocalDateTime berlinLocalDateTime = shanghaiLocalDateTime.atZone(currentZoneId)</span><br><span class="line">.withZoneSameInstant(berlinZoneId).toLocalDateTime();</span><br><span class="line">//&#x7ED3;&#x679C;&#xFF1A;</span><br><span class="line">//shanghaiLocalDateTime=2023-04-28T21:46:36.503</span><br><span class="line">//berlinLocalDateTime=2023-04-28T15:46:36.503</span><br><span class="line">log.info(&quot;\nshanghaiLocalDateTime={}\nberlinLocalDateTime={}&quot;, shanghaiLocalDateTime, berlinLocalDateTime);</span><br><span class="line"></span><br><span class="line">log.info(&quot;==============================&quot;);</span><br><span class="line"></span><br><span class="line">//&#x51AC;&#x4EE4;&#x65F6;&#x6D4B;&#x8BD5;&#xFF0C;&#x5FB7;&#x56FD;&#x51AC;&#x4EE4;&#x65F6;&#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x4E0E;&#x56FD;&#x5185;&#x7684;&#x65F6;&#x5DEE;&#x4E3A;7&#x5C0F;&#x65F6;</span><br><span class="line">//&#x6A21;&#x62DF;&#x5F53;&#x524D;&#x4E2D;&#x56FD;&#x4E0A;&#x6D77;&#x65F6;&#x95F4;&#x662F;&#xFF1A;2022-12-25T08:00:00.000</span><br><span class="line">ZoneId asiaShanghaiZoneId = ZoneId.of(&quot;Asia/Shanghai&quot;);</span><br><span class="line">LocalDateTime aisaShanghaiLocalDateTime = LocalDateTime.of(2022, 12, 25, 8, 0, 0);</span><br><span class="line">ZonedDateTime asiaShanghaiZonedDateTime = ZonedDateTime.of(aisaShanghaiLocalDateTime, asiaShanghaiZoneId);</span><br><span class="line"></span><br><span class="line">LocalDateTime europeGermanyLocalDateTime = asiaShanghaiZonedDateTime.withZoneSameInstant(berlinZoneId).toLocalDateTime();</span><br><span class="line">//&#x7ED3;&#x679C;&#xFF1A;</span><br><span class="line">//Mock--aisaShanghaiLocalDateTime=2022-12-25T08:00</span><br><span class="line">//Mock--europeGermanyLocalDateTime=2022-12-25T01:00</span><br><span class="line">log.info(&quot;\nMock--aisaShanghaiLocalDateTime={}\nMock--europeGermanyLocalDateTime={}&quot;, aisaShanghaiLocalDateTime, europeGermanyLocalDateTime);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;#x53EF;&amp;#x4EE5;&amp;#x5F88;&amp;#x6E05;&amp;#x6670;&amp;#x7684;&amp;#x770B;&amp;#x51FA;ZonedDateTime&amp;#x76F8;&amp;#x5F53;&amp;#x4E8E;LocalDateTime+ZoneId&amp;#x3002;&lt;br&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/java8-%20%E6%97%A5%E6%9C%9F%E6%97%B6%E9%97%B4API.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="java8" scheme="http://example.com/categories/java8/"/>
    
    
    <category term="java8" scheme="http://example.com/tags/java8/"/>
    
  </entry>
  
  <entry>
    <title>笔记-通过域名，反查到Nginx服务器的IP和.conf配置</title>
    <link href="http://example.com/2023/04/28/15.004%20%E7%AC%94%E8%AE%B0-%E9%80%9A%E8%BF%87%E5%9F%9F%E5%90%8D%EF%BC%8C%E5%8F%8D%E6%9F%A5%E5%88%B0Nginx%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84IP%E5%92%8C.conf%E9%85%8D%E7%BD%AE/"/>
    <id>http://example.com/2023/04/28/15.004%20%E7%AC%94%E8%AE%B0-%E9%80%9A%E8%BF%87%E5%9F%9F%E5%90%8D%EF%BC%8C%E5%8F%8D%E6%9F%A5%E5%88%B0Nginx%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84IP%E5%92%8C.conf%E9%85%8D%E7%BD%AE/</id>
    <published>2023-04-27T16:00:00.000Z</published>
    <updated>2023-10-11T13:30:29.724Z</updated>
    
    <content type="html"><![CDATA[<p>dig&#x547D;&#x4EE4;: DNS &#x67E5;&#x8BE2;&#x5B9E;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p><p>&#x80CC;&#x666F;&#xFF1A;<br>&#x67D0;&#x4E2A;&#x524D;&#x7AEF;&#x9759;&#x6001;&#x9875;&#x9762;&#x7684;&#x57DF;&#x540D;&#xFF1A;<a href="http://uat-apple-mta-admin-ad.xxx.com/">http://uat-apple-mta-admin-ad.xxx.com</a><br>&#x73B0;&#x5728;&#x60F3;&#x8981;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;&#x57DF;&#x540D;&#xFF1A;<code>uat-apple-mta-admin-ad.xxx.com</code>&#xFF0C;&#x6240;&#x5728;&#x7684;&#x6B63;&#x5411;&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;Nginx&#x7684;IP&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; dig &#x547D;&#x4EE4;&#x53CD;&#x67E5;&#x3002;</p><span id="more"></span><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">% dig uat-apple-mta-admin-ad.xxx.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; uat-apple-mta-admin-ad.xxx.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 43933</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;uat-apple-mta-admin-ad.xxx.com. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">uat-apple-mta-admin-ad.xxx.com. 600 IN A192.168.100.98</span><br><span class="line"></span><br><span class="line">;; Query time: 369 msec</span><br><span class="line">;; SERVER: 202.96.209.133#53(202.96.209.133)</span><br><span class="line">;; WHEN: Fri Apr 28 18:32:44 CST 2023</span><br><span class="line">;; MSG SIZE  rcvd: 81</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&#x770B;&#x5230; <code>ANSWER SECTION  192.168.100.98</code></p><p>&#x8FDB;&#x5165;&#x670D;&#x52A1;&#x5668;&#xFF1A;<code>192.168.100.98</code> (&#x8DF3;&#x677F;&#x673A;)&#xFF0C;&#x8FDB;&#x5165;Nginx&#x7684;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E;&#x8DEF;&#x5F84;&#xFF1A;<code>/etc/nginx/conf.d</code>&#xFF0C;<br>&#x770B;&#x4E0B;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x91CC;&#x7684; <code>server_name</code> &#x662F;&#x5426;&#x662F; <code>uat-apple-mta-admin-ad.xxx.com</code>&#xFF0C;&#x5982;&#x679C;&#x662F;&#xFF0C;&#x5219;&#x8868;&#x793A;&#x670D;&#x52A1;&#x5668;&#x627E;&#x5BF9;&#x4E86;&#x3002;</p><p>&#x4E0B;&#x9762;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;80&#x7AEF;&#x53E3;&#x76D1;&#x542C;&#x7684;&#x57DF;&#x540D;&#x786E;&#x5B9E;&#x662F;&#xFF1A;<code>uat-apple-mta-admin-ad.xxx.com</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">You are on 192.168.100.98.</span><br><span class="line"></span><br><span class="line">[root@os-app-uat ~]# cat /etc/nginx/conf.d/cruiser-admin-ui-apple.conf</span><br><span class="line">server {</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name uat-apple-mta-admin-ad.xxx.com;</span><br><span class="line">  root /var/www/cruiser-admin-ui-apple/current;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  location / {</span><br><span class="line">    try_files $uri /index.html;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  location /api/ {</span><br><span class="line">    proxy_pass http://10.190.96.13/;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header Host $http_host;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  access_log /var/log/nginx/cruiser-admin-ui-apple-access.log;</span><br><span class="line">  error_log /var/log/nginx/cruiser-admin-ui-apple-error.log;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;dig&amp;#x547D;&amp;#x4EE4;: DNS &amp;#x67E5;&amp;#x8BE2;&amp;#x5B9E;&amp;#x7528;&amp;#x7A0B;&amp;#x5E8F;&amp;#x3002;&lt;/p&gt;
&lt;p&gt;&amp;#x80CC;&amp;#x666F;&amp;#xFF1A;&lt;br&gt;&amp;#x67D0;&amp;#x4E2A;&amp;#x524D;&amp;#x7AEF;&amp;#x9759;&amp;#x6001;&amp;#x9875;&amp;#x9762;&amp;#x7684;&amp;#x57DF;&amp;#x540D;&amp;#xFF1A;&lt;a href=&quot;http://uat-apple-mta-admin-ad.xxx.com/&quot;&gt;http://uat-apple-mta-admin-ad.xxx.com&lt;/a&gt;&lt;br&gt;&amp;#x73B0;&amp;#x5728;&amp;#x60F3;&amp;#x8981;&amp;#x77E5;&amp;#x9053;&amp;#x8FD9;&amp;#x4E2A;&amp;#x57DF;&amp;#x540D;&amp;#xFF1A;&lt;code&gt;uat-apple-mta-admin-ad.xxx.com&lt;/code&gt;&amp;#xFF0C;&amp;#x6240;&amp;#x5728;&amp;#x7684;&amp;#x6B63;&amp;#x5411;&amp;#x4EE3;&amp;#x7406;&amp;#x670D;&amp;#x52A1;&amp;#x5668;Nginx&amp;#x7684;IP&amp;#xFF0C;&amp;#x53EF;&amp;#x4EE5;&amp;#x4F7F;&amp;#x7528; dig &amp;#x547D;&amp;#x4EE4;&amp;#x53CD;&amp;#x67E5;&amp;#x3002;&lt;/p&gt;</summary>
    
    
    
    <category term="笔记" scheme="http://example.com/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="运维" scheme="http://example.com/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>生活照片</title>
    <link href="http://example.com/2022/09/20/24.001.%E7%94%9F%E6%B4%BB%E7%85%A7%E7%89%87/"/>
    <id>http://example.com/2022/09/20/24.001.%E7%94%9F%E6%B4%BB%E7%85%A7%E7%89%87/</id>
    <published>2022-09-19T16:00:00.000Z</published>
    <updated>2023-11-08T12:50:09.139Z</updated>
    
    <content type="html"><![CDATA[<p>&#x5730;&#x70B9;&#xFF1A;&#x4E0A;&#x6D77;&#x4E09;&#x95E8;&#x8DEF;</p><span id="more"></span><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>&#x5730;&#x70B9;&#xFF1A;xxx</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;#x5730;&amp;#x70B9;&amp;#xFF1A;&amp;#x4E0A;&amp;#x6D77;&amp;#x4E09;&amp;#x95E8;&amp;#x8DEF;&lt;/p&gt;</summary>
    
    
    
    <category term="生活" scheme="http://example.com/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
    <category term="照片" scheme="http://example.com/tags/%E7%85%A7%E7%89%87/"/>
    
  </entry>
  
  <entry>
    <title>笔记-Springboot-MDC-为每个请求设置唯一ID</title>
    <link href="http://example.com/2022/08/28/15.005%20%E7%AC%94%E8%AE%B0-Springboot-MDC-%E4%B8%BA%E6%AF%8F%E4%B8%AA%E8%AF%B7%E6%B1%82%E8%AE%BE%E7%BD%AE%E5%94%AF%E4%B8%80ID/"/>
    <id>http://example.com/2022/08/28/15.005%20%E7%AC%94%E8%AE%B0-Springboot-MDC-%E4%B8%BA%E6%AF%8F%E4%B8%AA%E8%AF%B7%E6%B1%82%E8%AE%BE%E7%BD%AE%E5%94%AF%E4%B8%80ID/</id>
    <published>2022-08-27T16:00:00.000Z</published>
    <updated>2023-12-19T11:01:02.192Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>&#x76EE;&#x6807;&#xFF1A;&#x4E3A;&#x6BCF;&#x4E2A;HTTP &#x8BF7;&#x6C42;&#x7684;Server&#x7AEF;&#x65E5;&#x5FD7;&#x91CC;&#xFF0C;&#x52A0;&#x5165;&#x5168;&#x5C40;&#x7684;&#x552F;&#x4E00;ID&#xFF0C;&#x8FD4;&#x56DE;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x3002;&#x5982;&#x679C;&#x63A5;&#x53E3;&#x62A5;&#x9519;&#xFF0C;&#x4ECE;&#x5BA2;&#x6237;&#x7AEF;&#x7ED9;&#x5230;&#x8FD9;&#x4E2A;&#x552F;&#x4E00;ID&#xFF0C;&#x7136;&#x540E;&#x5230;Server&#x7AEF;&#x65E5;&#x5FD7;&#x91CC;&#x641C;&#x5BFB;&#x65E5;&#x5FD7;&#x8C03;&#x7528;&#x94FE;&#xFF0C;&#x65B9;&#x4FBF;&#x6392;&#x67E5;&#x3002;</p></blockquote><span id="more"></span><h4 id="1-&#x521B;&#x5EFA;springboot&#x9879;&#x76EE;&#xFF1A;springboot-mdc"><a href="#1-&#x521B;&#x5EFA;springboot&#x9879;&#x76EE;&#xFF1A;springboot-mdc" class="headerlink" title="1.&#x521B;&#x5EFA;springboot&#x9879;&#x76EE;&#xFF1A;springboot-mdc"></a>1.&#x521B;&#x5EFA;springboot&#x9879;&#x76EE;&#xFF1A;<code>springboot-mdc</code></h4><h4 id="2-&#x521B;&#x5EFA;-Slf4jMDCFilter-java"><a href="#2-&#x521B;&#x5EFA;-Slf4jMDCFilter-java" class="headerlink" title="2.&#x521B;&#x5EFA; Slf4jMDCFilter.java"></a>2.&#x521B;&#x5EFA; <code>Slf4jMDCFilter.java</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.MDC;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Slf4jMDCFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> {</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String responseHeader;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String mdcTokenKey;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String requestHeader;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span><br><span class="line"><span class="keyword">throws</span> ServletException, IOException {</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line"><span class="keyword">final</span> String token;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(requestHeader) &amp;&amp; StringUtils.isNotBlank(request.getHeader(requestHeader))) {</span><br><span class="line">token = request.getHeader(requestHeader);</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">token = UUID.randomUUID().toString().toUpperCase().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">}</span><br><span class="line">MDC.put(mdcTokenKey, token);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(responseHeader)) {</span><br><span class="line">response.addHeader(responseHeader, token);</span><br><span class="line">}</span><br><span class="line">filterChain.doFilter(request, response);</span><br><span class="line">} <span class="keyword">finally</span> {</span><br><span class="line">MDC.remove(mdcTokenKey);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure><h4 id="3-&#x521B;&#x5EFA;-Slf4jMDCFilterConfiguration-java&#xFF0C;&#x914D;&#x7F6E;Filter"><a href="#3-&#x521B;&#x5EFA;-Slf4jMDCFilterConfiguration-java&#xFF0C;&#x914D;&#x7F6E;Filter" class="headerlink" title="3.&#x521B;&#x5EFA; Slf4jMDCFilterConfiguration.java&#xFF0C;&#x914D;&#x7F6E;Filter"></a>3.&#x521B;&#x5EFA; <code>Slf4jMDCFilterConfiguration.java</code>&#xFF0C;&#x914D;&#x7F6E;Filter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xxg.mdc.mdc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;config.slf4jfilter&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Slf4jMDCFilterConfiguration</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_RESPONSE_TOKEN_HEADER</span> <span class="operator">=</span> <span class="string">&quot;Response-TraceId&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_MDC_UUID_TOKEN_KEY</span> <span class="operator">=</span> <span class="string">&quot;traceId&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">responseHeader</span> <span class="operator">=</span> DEFAULT_RESPONSE_TOKEN_HEADER;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">mdcTokenKey</span> <span class="operator">=</span> DEFAULT_MDC_UUID_TOKEN_KEY;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">requestHeader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistrationBean&lt;Slf4jMDCFilter&gt; <span class="title function_">servletRegistrationBean</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">final</span> FilterRegistrationBean&lt;Slf4jMDCFilter&gt; registrationBean = <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Slf4jMDCFilter</span> <span class="variable">log4jMDCFilterFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Slf4jMDCFilter</span>(responseHeader, mdcTokenKey, requestHeader);</span><br><span class="line">        registrationBean.setFilter(log4jMDCFilterFilter);</span><br><span class="line">        registrationBean.addUrlPatterns(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        registrationBean.setName(<span class="string">&quot;Slf4jMDCFilter&quot;</span>);</span><br><span class="line">        registrationBean.setOrder(-<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h4 id="4-pom-xml&#x91CC;&#xFF0C;&#x52A0;&#x5165;logback&#x4F9D;&#x8D56;&#xFF1A;"><a href="#4-pom-xml&#x91CC;&#xFF0C;&#x52A0;&#x5165;logback&#x4F9D;&#x8D56;&#xFF1A;" class="headerlink" title="4.pom.xml&#x91CC;&#xFF0C;&#x52A0;&#x5165;logback&#x4F9D;&#x8D56;&#xFF1A;"></a>4.pom.xml&#x91CC;&#xFF0C;&#x52A0;&#x5165;logback&#x4F9D;&#x8D56;&#xFF1A;</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>&#x5B8C;&#x6574;&#x7684;pom.xml:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xxg<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-mdc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>springboot-mdc<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot with MDC<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project.build.resourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.resourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">maven.test.skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">maven.test.skip</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-lang3 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="5-src-main-resources&#x4E0B;&#xFF0C;&#x521B;&#x5EFA;logback-spring-xml&#xFF1A;"><a href="#5-src-main-resources&#x4E0B;&#xFF0C;&#x521B;&#x5EFA;logback-spring-xml&#xFF1A;" class="headerlink" title="5.src/main/resources&#x4E0B;&#xFF0C;&#x521B;&#x5EFA;logback-spring.xml&#xFF1A;"></a>5.<code>src/main/resources</code>&#x4E0B;&#xFF0C;&#x521B;&#x5EFA;<code>logback-spring.xml</code>&#xFF1A;</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">resource</span>=<span class="string">&quot;org/springframework/boot/logging/logback/defaults.xml&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">resource</span>=<span class="string">&quot;org/springframework/boot/logging/logback/console-appender.xml&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">springProperty</span> <span class="attr">scope</span>=<span class="string">&quot;context&quot;</span> <span class="attr">name</span>=<span class="string">&quot;APPLICATION_NAME&quot;</span> <span class="attr">source</span>=<span class="string">&quot;spring.application.name&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">2023-11-07 14:59:37.933 [3A91AE7D75D741E0A768D174E45C8B5A] [http-nio-8080-exec-1] INFO org.xxg.mdc.controller.TestController [24] - result={aa=aa, 11=11, list=[]}</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;COMMON_CONSOLE_LOG_PATTERN&quot;</span> <span class="attr">value</span>=<span class="string">&quot;%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{traceId}] [%t] %p %c{256} [%line] - %m%n&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!--1. &#x8F93;&#x51FA;&#x5230;&#x63A7;&#x5236;&#x53F0;--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;CONSOLE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--&#x6B64;&#x65E5;&#x5FD7;appender&#x662F;&#x4E3A;&#x5F00;&#x53D1;&#x4F7F;&#x7528;&#xFF0C;&#x53EA;&#x914D;&#x7F6E;&#x6700;&#x5E95;&#x7EA7;&#x522B;&#xFF0C;&#x63A7;&#x5236;&#x53F0;&#x8F93;&#x51FA;&#x7684;&#x65E5;&#x5FD7;&#x7EA7;&#x522B;&#x662F;&#x5927;&#x4E8E;&#x6216;&#x7B49;&#x4E8E;&#x6B64;&#x7EA7;&#x522B;&#x7684;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.ThresholdFilter&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">level</span>&gt;</span>debug<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>${COMMON_CONSOLE_LOG_PATTERN}<span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">&lt;!-- &#x8BBE;&#x7F6E;&#x5B57;&#x7B26;&#x96C6; --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;CONSOLE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="6-&#x6D4B;&#x8BD5;&#xFF1A;GET-http-localhost-8080-rest-test"><a href="#6-&#x6D4B;&#x8BD5;&#xFF1A;GET-http-localhost-8080-rest-test" class="headerlink" title="6.&#x6D4B;&#x8BD5;&#xFF1A;GET http://localhost:8080/rest/test/"></a>6.&#x6D4B;&#x8BD5;&#xFF1A;GET <code>http://localhost:8080/rest/test/</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">2023-11-07 20:22:29.344 [ED40CCF2886F4656A300AB9349A0F299] [http-nio-8080-exec-2] INFO org.xxg.mdc.controller.TestController [24] - result={aa=aa, 11=11, list=[]}</span><br></pre></td></tr></table></figure><p>&#x5BA2;&#x6237;&#x7AEF;&#x8BF7;&#x6C42;&#x53EF;&#x4EE5;&#x770B;&#x5230;Response&#x91CC;&#x7684;<code>Response-TraceId</code>:</p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/15.005.%E7%AC%94%E8%AE%B0-Springboot-MDC-%E4%B8%BA%E6%AF%8F%E4%B8%AA%E8%AF%B7%E6%B1%82%E8%AE%BE%E7%BD%AE%E5%94%AF%E4%B8%80ID/1.png"></p><hr><p>&#x53E6;&#x4E00;&#x79CD;&#x5199;&#x6CD5;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;&#x65E5;&#x5FD7;&#x91CC;&#x770B;&#x5230;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8BF7;&#x6C42;IP&#xFF0C;&#x5199;&#x6CD5;&#x5927;&#x540C;&#x5C0F;&#x5F02;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</p><h4 id="1-Slf4jMDCFilterV2-java"><a href="#1-Slf4jMDCFilterV2-java" class="headerlink" title="1.Slf4jMDCFilterV2.java"></a>1.<code>Slf4jMDCFilterV2.java</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xxg.mdc.mdc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.MDC;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Slf4jMDCFilterV2</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String responseHeader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mdcTokenKey;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mdcClientIpKey;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String requestHeader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Slf4jMDCFilterV2</span><span class="params">()</span> {</span><br><span class="line">        responseHeader = Slf4jMDCFilterConfigurationV2.DEFAULT_RESPONSE_TOKEN_HEADER;</span><br><span class="line">        mdcTokenKey = Slf4jMDCFilterConfigurationV2.DEFAULT_MDC_UUID_TOKEN_KEY;</span><br><span class="line">        mdcClientIpKey = Slf4jMDCFilterConfigurationV2.DEFAULT_MDC_CLIENT_IP_KEY;</span><br><span class="line">        requestHeader = <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Slf4jMDCFilterV2</span><span class="params">(<span class="keyword">final</span> String responseHeader, <span class="keyword">final</span> String mdcTokenKey, <span class="keyword">final</span> String mdcClientIPKey, <span class="keyword">final</span> String requestHeader)</span> {</span><br><span class="line">        <span class="built_in">this</span>.responseHeader = responseHeader;</span><br><span class="line">        <span class="built_in">this</span>.mdcTokenKey = mdcTokenKey;</span><br><span class="line">        <span class="built_in">this</span>.mdcClientIpKey = mdcClientIPKey;</span><br><span class="line">        <span class="built_in">this</span>.requestHeader = requestHeader;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(<span class="keyword">final</span> HttpServletRequest request, <span class="keyword">final</span> HttpServletResponse response, <span class="keyword">final</span> FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> java.io.IOException, ServletException {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> extractToken(request);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">clientIP</span> <span class="operator">=</span> extractClientIP(request);</span><br><span class="line">            MDC.put(mdcClientIpKey, clientIP);</span><br><span class="line">            MDC.put(mdcTokenKey, token);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotBlank(responseHeader)) {</span><br><span class="line">                response.addHeader(responseHeader, token);</span><br><span class="line">            }</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            MDC.remove(mdcTokenKey);</span><br><span class="line">            MDC.remove(mdcClientIpKey);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">extractToken</span><span class="params">(<span class="keyword">final</span> HttpServletRequest request)</span> {</span><br><span class="line">        <span class="keyword">final</span> String token;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(requestHeader) &amp;&amp; StringUtils.isNotBlank(request.getHeader(requestHeader))) {</span><br><span class="line">            token = request.getHeader(requestHeader);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            token = UUID.randomUUID().toString().toUpperCase().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">extractClientIP</span><span class="params">(<span class="keyword">final</span> HttpServletRequest request)</span> {</span><br><span class="line">        <span class="keyword">final</span> String clientIP;</span><br><span class="line">        <span class="keyword">if</span> (request.getHeader(<span class="string">&quot;X-Forwarded-For&quot;</span>) != <span class="literal">null</span>) {</span><br><span class="line">            clientIP = request.getHeader(<span class="string">&quot;X-Forwarded-For&quot;</span>).split(<span class="string">&quot;,&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            clientIP = request.getRemoteAddr();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> clientIP;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isAsyncDispatch</span><span class="params">(<span class="keyword">final</span> HttpServletRequest request)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">shouldNotFilterErrorDispatch</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure><h4 id="2-Slf4jMDCFilterConfigurationV2-java"><a href="#2-Slf4jMDCFilterConfigurationV2-java" class="headerlink" title="2.Slf4jMDCFilterConfigurationV2.java"></a>2.<code>Slf4jMDCFilterConfigurationV2.java</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xxg.mdc.mdc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;summer.slf4jfilter&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Slf4jMDCFilterConfigurationV2</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_RESPONSE_TOKEN_HEADER</span> <span class="operator">=</span> <span class="string">&quot;Response_Token&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_MDC_UUID_TOKEN_KEY</span> <span class="operator">=</span> <span class="string">&quot;traceId&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_MDC_CLIENT_IP_KEY</span> <span class="operator">=</span> <span class="string">&quot;clientIP&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">responseHeader</span> <span class="operator">=</span> DEFAULT_RESPONSE_TOKEN_HEADER;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">mdcTokenKey</span> <span class="operator">=</span> DEFAULT_MDC_UUID_TOKEN_KEY;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">mdcClientIpKey</span> <span class="operator">=</span> DEFAULT_MDC_CLIENT_IP_KEY;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">requestHeader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistrationBean&lt;Slf4jMDCFilterV2&gt; <span class="title function_">servletRegistrationBean</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">final</span> FilterRegistrationBean&lt;Slf4jMDCFilterV2&gt; registrationBean = <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Slf4jMDCFilterV2</span> <span class="variable">log4jMDCFilterFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Slf4jMDCFilterV2</span>(responseHeader, mdcTokenKey, mdcClientIpKey, requestHeader);</span><br><span class="line">        registrationBean.setFilter(log4jMDCFilterFilter);</span><br><span class="line">        registrationBean.setOrder(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h4 id="3-pom-xml&#x4E2D;&#x52A0;&#x5165;logback&#x4F9D;&#x8D56;&#xFF1A;"><a href="#3-pom-xml&#x4E2D;&#x52A0;&#x5165;logback&#x4F9D;&#x8D56;&#xFF1A;" class="headerlink" title="3.pom.xml&#x4E2D;&#x52A0;&#x5165;logback&#x4F9D;&#x8D56;&#xFF1A;"></a>3.<code>pom.xml</code>&#x4E2D;&#x52A0;&#x5165;logback&#x4F9D;&#x8D56;&#xFF1A;</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="4-src-main-resources&#x4E0B;&#x521B;&#x5EFA;logback-spring-xml"><a href="#4-src-main-resources&#x4E0B;&#x521B;&#x5EFA;logback-spring-xml" class="headerlink" title="4.src/main/resources&#x4E0B;&#x521B;&#x5EFA;logback-spring.xml:"></a>4.<code>src/main/resources&#x4E0B;&#x521B;&#x5EFA;logback-spring.xml</code>:</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">resource</span>=<span class="string">&quot;org/springframework/boot/logging/logback/defaults.xml&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">resource</span>=<span class="string">&quot;org/springframework/boot/logging/logback/console-appender.xml&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">springProperty</span> <span class="attr">scope</span>=<span class="string">&quot;context&quot;</span> <span class="attr">name</span>=<span class="string">&quot;APPLICATION_NAME&quot;</span> <span class="attr">source</span>=<span class="string">&quot;spring.application.name&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;COMMON_CONSOLE_LOG_PATTERN_V2&quot;</span> <span class="attr">value</span>=<span class="string">&quot;%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{traceId}] [%X{clientIP}] [%t] %p %c{256} [%line] - %m%n&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!--1. &#x8F93;&#x51FA;&#x5230;&#x63A7;&#x5236;&#x53F0;--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;CONSOLE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--&#x6B64;&#x65E5;&#x5FD7;appender&#x662F;&#x4E3A;&#x5F00;&#x53D1;&#x4F7F;&#x7528;&#xFF0C;&#x53EA;&#x914D;&#x7F6E;&#x6700;&#x5E95;&#x7EA7;&#x522B;&#xFF0C;&#x63A7;&#x5236;&#x53F0;&#x8F93;&#x51FA;&#x7684;&#x65E5;&#x5FD7;&#x7EA7;&#x522B;&#x662F;&#x5927;&#x4E8E;&#x6216;&#x7B49;&#x4E8E;&#x6B64;&#x7EA7;&#x522B;&#x7684;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.ThresholdFilter&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">level</span>&gt;</span>debug<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>${COMMON_CONSOLE_LOG_PATTERN_V2}<span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">&lt;!-- &#x8BBE;&#x7F6E;&#x5B57;&#x7B26;&#x96C6; --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;CONSOLE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="5-&#x6D4B;&#x8BD5;&#xFF1A;GET-http-localhost-8080-rest-test"><a href="#5-&#x6D4B;&#x8BD5;&#xFF1A;GET-http-localhost-8080-rest-test" class="headerlink" title="5.&#x6D4B;&#x8BD5;&#xFF1A;GET http://localhost:8080/rest/test/"></a>5.&#x6D4B;&#x8BD5;&#xFF1A;GET <code>http://localhost:8080/rest/test/</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">2023-11-07 20:49:39.308 [093FF19E54B542BD872E4BC536DD0AC3] [0:0:0:0:0:0:0:1] [http-nio-8080-exec-4] INFO org.xxg.mdc.controller.TestController [24] - result={aa=aa, 11=11, list=[]}</span><br></pre></td></tr></table></figure><p>&#x5BA2;&#x6237;&#x7AEF;&#x8BF7;&#x6C42;&#x53EF;&#x4EE5;&#x770B;&#x5230;Response&#x91CC;&#x7684;<code>Response-TraceId</code>:</p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/15.005.%E7%AC%94%E8%AE%B0-Springboot-MDC-%E4%B8%BA%E6%AF%8F%E4%B8%AA%E8%AF%B7%E6%B1%82%E8%AE%BE%E7%BD%AE%E5%94%AF%E4%B8%80ID/2.png"></p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&amp;#x76EE;&amp;#x6807;&amp;#xFF1A;&amp;#x4E3A;&amp;#x6BCF;&amp;#x4E2A;HTTP &amp;#x8BF7;&amp;#x6C42;&amp;#x7684;Server&amp;#x7AEF;&amp;#x65E5;&amp;#x5FD7;&amp;#x91CC;&amp;#xFF0C;&amp;#x52A0;&amp;#x5165;&amp;#x5168;&amp;#x5C40;&amp;#x7684;&amp;#x552F;&amp;#x4E00;ID&amp;#xFF0C;&amp;#x8FD4;&amp;#x56DE;&amp;#x7ED9;&amp;#x5BA2;&amp;#x6237;&amp;#x7AEF;&amp;#x3002;&amp;#x5982;&amp;#x679C;&amp;#x63A5;&amp;#x53E3;&amp;#x62A5;&amp;#x9519;&amp;#xFF0C;&amp;#x4ECE;&amp;#x5BA2;&amp;#x6237;&amp;#x7AEF;&amp;#x7ED9;&amp;#x5230;&amp;#x8FD9;&amp;#x4E2A;&amp;#x552F;&amp;#x4E00;ID&amp;#xFF0C;&amp;#x7136;&amp;#x540E;&amp;#x5230;Server&amp;#x7AEF;&amp;#x65E5;&amp;#x5FD7;&amp;#x91CC;&amp;#x641C;&amp;#x5BFB;&amp;#x65E5;&amp;#x5FD7;&amp;#x8C03;&amp;#x7528;&amp;#x94FE;&amp;#xFF0C;&amp;#x65B9;&amp;#x4FBF;&amp;#x6392;&amp;#x67E5;&amp;#x3002;&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="笔记" scheme="http://example.com/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="MDC" scheme="http://example.com/tags/MDC/"/>
    
  </entry>
  
  <entry>
    <title>框架-[feign]-Feign原理与源码分析</title>
    <link href="http://example.com/2022/08/07/9G2.001.%E6%A1%86%E6%9E%B6-[feign]-Feign%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://example.com/2022/08/07/9G2.001.%E6%A1%86%E6%9E%B6-[feign]-Feign%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</id>
    <published>2022-08-06T16:00:00.000Z</published>
    <updated>2022-08-18T06:41:17.074Z</updated>
    
    <content type="html"><![CDATA[<p>Feign Bean&#x521B;&#x5EFA;&#x6D41;&#x7A0B;&#xFF1A;</p><p>&#x5148;&#x5173;&#x6CE8;&#x5BF9;&#x4E8E; <code>@EnableFeignClients</code> &#x7684;&#x5904;&#x7406;&#x3002;&#x5B83;&#x4F7F;&#x7528;&#x4E86;<code>@Import(FeignClientsRegistrar.class)</code><br>Spring &#x901A;&#x8FC7;&#x8C03;&#x7528;&#x5176; <code>registerBeanDefinitions</code> &#x65B9;&#x6CD5;&#x6765;&#x83B7;&#x53D6;&#x5176;&#x63D0;&#x4F9B;&#x7684; bean definition&#x3002;</p><span id="more"></span><ol><li><p>Feign&#x7EC4;&#x4EF6;&#x521D;&#x59CB;&#x5316;&#x662F;&#x4ECE; <code>@EnableFeignClients</code> &#x6CE8;&#x89E3;&#x5F00;&#x59CB;&#x7684;&#xFF0C;&#x6CE8;&#x89E3;&#x4E0A;&#x6709;&#x4E00;&#x4E2A;&#x5173;&#x952E;&#x6CE8;&#x89E3;&#xFF1A;<code>@Import(FeignClientsRegistrar.class)</code></p></li><li><p><code>FeignClientsRegistrar</code> &#x2013;&gt; <code>registerFeignClient</code> &#x51FD;&#x6570;&#xFF0C;&#x627E;&#x5230;&#x6709;&#x6CE8;&#x89E3;FeignClient&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x5C01;&#x88C5;&#x6210;BeanDefinition&#xFF0C;&#x6700;&#x540E;&#x6CE8;&#x518C;&#x5230;spring&#x5BB9;&#x5668;;</p></li></ol><ul><li><p>&#x5C06;&#x63A5;&#x53E3;&#x7684;Bean&#x7C7B;&#x578B;&#xFF0C;&#x6539;&#x7F16;&#x6210;&#xFF1A;<code>FeignClientFactoryBean</code><br><code>BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(FeignClientFactoryBean.class);</code></p></li><li><p>spring&#x5BB9;&#x5668;&#x4F1A;&#x5728;&#x542F;&#x52A8;&#x671F;&#x95F4;&#xFF0C;&#x521D;&#x59CB;&#x5316;&#x5B9E;&#x4F8B;&#xFF0C;&#x5E76;&#x8C03;&#x7528;getObject()&#x65B9;&#x6CD5;&#xFF0C;&#x5C06;&#x6BCF;&#x4E2A;Feign&#x63A5;&#x53E3;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x5B9E;&#x4F8B;&#x5316;<br>&#x81F3;&#x6B64;&#xFF0C;&#x4E00;&#x4E2A;Feign&#x63A5;&#x53E3;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#xFF1A;&#x4EE3;&#x7406;Bean&#x7EC8;&#x4E8E;&#x521D;&#x59CB;&#x5316;&#x5B8C;&#x6210;&#x3002;</p></li></ul><ol start="3"><li>FeignClientFactoryBean &#x2013;&gt; getObject()&#xFF0C;&#x8FD4;&#x56DE;&#x7684;&#x662F;Target&#x63A5;&#x53E3;&#x7684;&#x5B9E;&#x4F8B;&#xFF1B;<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Target&#x5B9E;&#x73B0;&#x7C7B;&#x6709;2&#x4E2A;&#xFF1A;DefaultTargeter &#x548C; HystrixTargeter;</span><br><span class="line"></span><br><span class="line">DefaultTargeter -- ReflectiveFeign.newInstance--InvocationHandlerFactory.create(target, methodToHandler) &#x6700;&#x7EC8;&#x901A;&#x8FC7;jdk&#x52A8;&#x6001;&#x4EE3;&#x7406;&#xFF0C;&#x751F;&#x6210;Feign&#x63A5;&#x53E3;&#x7684;&#x4EE3;&#x7406;&#x7C7B;:FeignInvocationHandler, invoke&#x65B9;&#x6CD5;&#x91CC;&#x8C03;&#x7528;REST&#x63A5;&#x53E3;&#xFF1A;MethodHandler.invoke</span><br><span class="line"></span><br><span class="line">HystrixTargeter -- ReflectiveFeign.newInstance &#x6700;&#x7EC8;&#x901A;&#x8FC7;jdk&#x52A8;&#x6001;&#x4EE3;&#x7406;&#xFF0C;&#x751F;&#x6210;&#x5E26;&#x7194;&#x65AD;&#x529F;&#x80FD;&#x7684;Feign&#x63A5;&#x53E3;&#x4EE3;&#x7406;&#x7C7B;:HystrixInvocationHandler,invoke&#x65B9;&#x6CD5;&#x91CC;&#xFF0C;&#x4F7F;&#x7528;HystrixCommand&#x8C03;&#x7528;REST&#x63A5;&#x53E3;</span><br><span class="line"></span><br><span class="line">DefaultTargeter &#x6700;&#x7EC8;&#x8C03;&#x7528; FeignInvocationHandler.invoke&#xFF1B;</span><br><span class="line">HystrixTargeter&#x6700;&#x7EC8;&#x8C03;&#x7528; FeignInvocationHandler.invoke ;</span><br></pre></td></tr></table></figure></li></ol><p>Feign&#x7EC4;&#x4EF6;&#x7684;&#x914D;&#x7F6E;&#x4E3B;&#x8981;&#x6709;3&#x4E2A;&#x81EA;&#x52A8;&#x5316;&#x914D;&#x7F6E;&#x7C7B;&#xFF1A;</p><ul><li><code>FeignAutoConfiguration</code> &#xFF1A;&#x914D;&#x7F6E;Feign&#x4E0A;&#x4E0B;&#x6587;&#xFF08;FeignContext&#xFF09;&#x3001;&#x914D;&#x7F6E;Targeter&#x3001;&#x914D;&#x7F6E;Client(&#x4EC5;&#x4EC5;&#x7EC4;&#x4EF6;)</li><li><code>FeignClientsConfiguration</code> &#xFF1A;Decoder&#x3001;Encoder&#x3001;Retryer&#x3001;Contract&#xFF08;SpringMvcContract&#xFF09;&#x3001;FeignBuilder</li><li><code>FeignRibbonClientAutoConfiguration</code> &#xFF1A;Request Options&#xFF08;&#x8D85;&#x65F6;&#x914D;&#x7F6E;&#xFF09;&#x3001;&#x914D;&#x7F6E;Client(&#x5E26;&#x8D1F;&#x8F7D;&#x5747;&#x8861;)</li><li>Feign&#x7684;&#x91CD;&#x8BD5;&#x662F;&#x901A;&#x8FC7;&#x914D;&#x7F6E;Retryer&#x6765;&#x5B9E;&#x73B0;&#xFF0C;&#x5728;<code>FeignClientsConfiguration</code>&#x81EA;&#x52A8;&#x914D;&#x7F6E;&#x7C7B;&#x4E2D;&#xFF0C;&#x914D;&#x7F6E;&#x4E86;&#x4E00;&#x4E2A;&#x9ED8;&#x8BA4;&#x7684;Retryer.NEVER_RETRY&#xFF0C;&#x8868;&#x793A;&#x7528;&#x4E0D;&#x91CD;&#x8BD5;&#x3002;&#x4E0D;&#x91CD;&#x8BD5;&#x548C;&#x91CD;&#x8BD5;&#x8D85;&#x8FC7;&#x9650;&#x5236;&#x6B21;&#x6570;&#x90FD;&#x662F;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#x6765;&#x505C;&#x6B62;&#x91CD;&#x8BD5;&#x3002;</li></ul><p>&#x603B;&#x7ED3;&#x4E00;&#x4E0B;</p><ul><li><p>&#x5728;&#x542F;&#x52A8;&#x65F6;&#xFF0C;&#x5904;&#x7406;&#x4E86; <code>EnableFeignClients</code> &#x6CE8;&#x89E3;&#x540E;&#xFF0C; <code>registry</code> &#x91CC;&#x9762;&#x4F1A;&#x591A;&#x51FA;&#x4E00;&#x4E9B;&#x5173;&#x4E8E; Feign &#x7684; BeanDefinition&#xFF0C;&#x8FD9;&#x4E9B; BeanDefinition &#x5206;&#x4E3A;&#x4E24;&#x7C7B;&#xFF1A;<br>&#x4E00;&#x7C7B;&#x662F; <code>FeignClientSpecification</code> &#xFF0C;&#x5305;&#x62EC;&#x4E86;&#x6240;&#x6709; FeignClient &#x4E0A;&#x6307;&#x5B9A; configuration &#x4EE5;&#x53CA;&#x5728; EnableFeignClients &#x4E0A;&#x6307;&#x5B9A;&#x7684; defaultConfiguration&#x3002;<br>&#x524D;&#x8005;&#x7684;&#x540D;&#x5B57;&#x4E3A;&#x6CE8;&#x89E3;&#x7684; URL &#x6216;&#x8005; value &#x7EC4;&#x6210;&#xFF0C;&#x6BD4;&#x5982;TEST-SERVICE&#xFF0C;&#x540E;&#x8005;&#x7684;&#x540D;&#x5B57;&#x4E3A; default.$CLASSNAME&#xFF0C;&#x6BD4;&#x5982; default.name.org.xiang.SpringBootApp&#x3002;</p></li><li><p>&#x8FD8;&#x6709;&#x4E00;&#x7C7B;&#x662F; <code>FeignClientFactoryBean</code> &#xFF0C;&#x5B83;&#x5305;&#x542B;&#x4E86;&#x6240;&#x6709;&#x4F7F;&#x7528;&#x4E86; FeignClient &#x6CE8;&#x89E3;&#x7684;&#x63A5;&#x53E3;&#x4FE1;&#x606F;&#x4EE5;&#x53CA;&#x6CE8;&#x89E3;&#x4E0A;&#x9762;&#x7684;&#x53C2;&#x6570;&#x3002;<br>&#x5B83;&#x7684;&#x540D;&#x5B57;&#x4E3A;&#x6CE8;&#x89E3;&#x7684; URL &#x6216;&#x8005; value&#xFF0C;&#x6BD4;&#x5982; TEST-SERVICE&#xFF0C;&#x8DDF;&#x5B83;&#x4E0A;&#x9762;&#x7684; configuration &#x521B;&#x5EFA;&#x51FA;&#x6765;&#x7684; bean &#x5B9A;&#x4E49;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#x540D;&#x5B57;&#x3002;</p></li><li><p><code>FeignClientFactoryBean</code> &#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x4E2A;&#x5DE5;&#x5382;&#x7C7B;&#xFF0C;Spring Context &#x521B;&#x5EFA; Bean &#x5B9E;&#x4F8B;&#x65F6;&#x4F1A;&#x8C03;&#x7528;&#x5B83;&#x7684; getObject &#x65B9;&#x6CD5;&#x3002;<br>&#x7136;&#x540E;&#x662F;&#x6700;&#x5173;&#x952E;&#x7684;&#x4E00;&#x6B65;&#xFF0C;&#x83B7;&#x53D6; Targeter &#x6765;&#x751F;&#x6210;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x7C7B;&#xFF0C;&#x5728; <code>FeignAutoConfiguration</code> &#x91CC;&#x9762;&#xFF0C;&#x6307;&#x5B9A;&#x4E86;&#x751F;&#x6210; <code>HystrixTargeter</code> &#x3002;</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SynchronousMethodHandler &#x7684; invoke &#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x662F;&#x5E94;&#x7528; encoder&#xFF0C;decoder &#x4EE5;&#x53CA; retry &#x7B49;&#x914D;&#x7F6E;&#xFF0C; &#x5E76;&#x4E14;&#x81EA;&#x8EAB;&#x5BF9;&#x4E8E;&#x8C03;&#x7528;&#x7ED3;&#x679C;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x5904;&#x7406;&#x903B;&#x8F91;&#x3002;</span><br><span class="line">&#x6211;&#x4EEC;&#x6700;&#x5173;&#x5FC3;&#x7684;&#x8BF7;&#x6C42;&#x5B9E;&#x73B0;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x5728;&#x7EC4;&#x88C5; SynchronousMethodHandler &#x7684; client &#x53C2;&#x6570;&#x4E0A;&#xFF0C;</span><br><span class="line">&#x8FD9;&#x4E2A;client&#x662F;&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x5B9E;&#x73B0;&#x7C7B;&#x6709;&#xFF1A;Default(&#x4F7F;&#x7528;httpurl&#x5BF9;restfult&#x63A5;&#x53E3;&#x7684;&#x8C03;&#x7528;)&#x3001; LoadBalancerFeignClient(&#x4F7F;&#x7528;Ribbon&#x548C;rxjava&#xFF0C;&#x5B9E;&#x73B0;&#x5BF9;restful&#x63A5;&#x53E3;&#x8C03;&#x7528;&#x7684;&#x8D1F;&#x8F7D;&#x5747;&#x8861;)</span><br><span class="line">&#x5373;&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x524D;&#x8DEF;&#x5F84;&#x91CC;&#x9762;&#x6709; Ribbon&#xFF0C;&#x5C31;&#x662F; LoadBalancerFeignClient&#xFF0C;</span><br><span class="line">&#x5982;&#x679C;&#x6CA1;&#x6709;&#xFF0C;&#x6839;&#x636E;&#x914D;&#x7F6E;&#x751F;&#x6210; ApacheHttpClient &#x6216;&#x8005; OKHttpClient&#x3002;</span><br><span class="line">&#x5728; Ribbon &#x91CC;&#x9762;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86; Eureka &#x670D;&#x52A1;&#x53D1;&#x73B0;&#x4EE5;&#x53CA;&#x8FDB;&#x884C;&#x8BF7;&#x6C42;&#x7B49;&#x52A8;&#x4F5C;&#x3002;&#x5F53;&#x7136; Ribbon &#x91CC;&#x9762;&#x8FD8;&#x5E26;&#x4E86;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x903B;&#x8F91;&#x3002;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Feign Bean&amp;#x521B;&amp;#x5EFA;&amp;#x6D41;&amp;#x7A0B;&amp;#xFF1A;&lt;/p&gt;
&lt;p&gt;&amp;#x5148;&amp;#x5173;&amp;#x6CE8;&amp;#x5BF9;&amp;#x4E8E; &lt;code&gt;@EnableFeignClients&lt;/code&gt; &amp;#x7684;&amp;#x5904;&amp;#x7406;&amp;#x3002;&amp;#x5B83;&amp;#x4F7F;&amp;#x7528;&amp;#x4E86;&lt;code&gt;@Import(FeignClientsRegistrar.class)&lt;/code&gt;&lt;br&gt;Spring &amp;#x901A;&amp;#x8FC7;&amp;#x8C03;&amp;#x7528;&amp;#x5176; &lt;code&gt;registerBeanDefinitions&lt;/code&gt; &amp;#x65B9;&amp;#x6CD5;&amp;#x6765;&amp;#x83B7;&amp;#x53D6;&amp;#x5176;&amp;#x63D0;&amp;#x4F9B;&amp;#x7684; bean definition&amp;#x3002;&lt;/p&gt;</summary>
    
    
    
    <category term="Framework-框架" scheme="http://example.com/categories/Framework-%E6%A1%86%E6%9E%B6/"/>
    
    
    <category term="feign" scheme="http://example.com/tags/feign/"/>
    
  </entry>
  
  <entry>
    <title>框架-[eureka]-服务发现Eureka原理与源码分析</title>
    <link href="http://example.com/2022/08/07/9G1.001.%E6%A1%86%E6%9E%B6-[eureka]-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0Eureka%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://example.com/2022/08/07/9G1.001.%E6%A1%86%E6%9E%B6-[eureka]-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0Eureka%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</id>
    <published>2022-08-06T16:00:00.000Z</published>
    <updated>2023-09-20T09:05:42.496Z</updated>
    
    <content type="html"><![CDATA[<h3 id="&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x4E0E;&#x53D1;&#x73B0;&#x7EC4;&#x4EF6;Eureka"><a href="#&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x4E0E;&#x53D1;&#x73B0;&#x7EC4;&#x4EF6;Eureka" class="headerlink" title="&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x4E0E;&#x53D1;&#x73B0;&#x7EC4;&#x4EF6;Eureka"></a>&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x4E0E;&#x53D1;&#x73B0;&#x7EC4;&#x4EF6;Eureka</h3><p>Eureka&#x662F;Netflix&#x5F00;&#x53D1;&#x7684;&#x670D;&#x52A1;&#x53D1;&#x73B0;&#x7EC4;&#x4EF6;&#xFF0C;&#x672C;&#x8EAB;&#x662F;&#x4E00;&#x4E2A;&#x57FA;&#x4E8E;REST&#x7684;&#x670D;&#x52A1;&#x3002;Spring Cloud&#x5C06;&#x5B83;&#x96C6;&#x6210;&#x5728;&#x5176;&#x5B50;&#x9879;&#x76EE;spring-cloud-netflix&#x4E2D;&#xFF0C;&#x4EE5;&#x5B9E;&#x73B0;Spring Cloud&#x7684;&#x670D;&#x52A1;&#x53D1;&#x73B0;&#x529F;&#x80FD;</p><p>Eureka<br>&#x6E90;&#x7801;&#xFF1A;<a href="https://github.com/Netflix/eureka/">https://github.com/Netflix/eureka/</a><br>&#x6587;&#x6863;&#xFF1A;<a href="https://github.com/Netflix/eureka/wiki">https://github.com/Netflix/eureka/wiki</a><br>&#x67B6;&#x6784;&#x4ECB;&#x7ECD;&#xFF1A;High level architecture: <a href="https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance">https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance</a></p><span id="more"></span><h3 id="&#x57FA;&#x4E8E;CAP&#x7406;&#x8BBA;&#xFF0C;&#x6BD4;&#x8F83;ZK&#x548C;Eureka"><a href="#&#x57FA;&#x4E8E;CAP&#x7406;&#x8BBA;&#xFF0C;&#x6BD4;&#x8F83;ZK&#x548C;Eureka" class="headerlink" title="&#x57FA;&#x4E8E;CAP&#x7406;&#x8BBA;&#xFF0C;&#x6BD4;&#x8F83;ZK&#x548C;Eureka"></a>&#x57FA;&#x4E8E;CAP&#x7406;&#x8BBA;&#xFF0C;&#x6BD4;&#x8F83;ZK&#x548C;Eureka</h3><ul><li><code>ZK</code> &#x7684;&#x8BBE;&#x8BA1;&#x539F;&#x5219;&#x662F; <code>CP</code>&#xFF0C;&#x5373;<code>&#x5F3A;&#x4E00;&#x81F4;&#x6027;</code>&#x548C;<code>&#x5206;&#x533A;&#x5BB9;&#x9519;</code>&#x6027;&#x3002;&#x4ED6;&#x4FDD;&#x8BC1;&#x6570;&#x636E;&#x7684;&#x5F3A;&#x4E00;&#x81F4;&#x6027;&#xFF0C;&#x4F46;&#x820D;&#x5F03;&#x4E86;&#x53EF;&#x7528;&#x6027;&#xFF0C;&#x5982;&#x679C;&#x51FA;&#x73B0;&#x7F51;&#x7EDC;&#x95EE;&#x9898;&#x53EF;&#x80FD;&#x4F1A;&#x5F71;&#x54CD; ZK &#x7684;&#x9009;&#x4E3E;&#xFF0C;&#x5BFC;&#x81F4; ZK &#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x7684;&#x4E0D;&#x53EF;&#x7528;&#x3002;</li><li><code>Eureka</code> &#x7684;&#x8BBE;&#x8BA1;&#x539F;&#x5219;&#x662F; <code>AP</code>&#xFF0C;&#x5373;<code>&#x53EF;&#x7528;&#x6027;</code>&#x548C;<code>&#x5206;&#x533A;&#x5BB9;&#x9519;&#x6027;</code>&#x3002;&#x4ED6;&#x4FDD;&#x8BC1;&#x4E86;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x7684;&#x53EF;&#x7528;&#x6027;&#xFF0C;&#x4F46;&#x820D;&#x5F03;&#x4E86;&#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;&#xFF0C;&#x5404;&#x8282;&#x70B9;&#x4E0A;&#x7684;&#x6570;&#x636E;&#x6709;&#x53EF;&#x80FD;&#x662F;&#x4E0D;&#x4E00;&#x81F4;&#x7684;&#xFF08;&#x4F1A;&#x6700;&#x7EC8;&#x4E00;&#x81F4;&#xFF09;&#x3002;</li></ul><p>Eureka &#x91C7;&#x7528;&#x7EAF; Java &#x5B9E;&#x73B0;&#xFF0C;&#x9664;&#x5B9E;&#x73B0;&#x4E86;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x57FA;&#x672C;&#x7684;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x548C;&#x53D1;&#x73B0;&#x4E4B;&#x5916;&#xFF0C;&#x6781;&#x5927;&#x7684;&#x6EE1;&#x8DB3;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x7684;&#x53EF;&#x7528;&#x6027;&#xFF0C;&#x5373;&#x4F7F;&#x53EA;&#x6709;&#x4E00;&#x53F0;&#x670D;&#x52A1;&#x53EF;&#x7528;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x7684;&#x53EF;&#x7528;&#x6027;&#x3002;<br>&#x4ECE;CAP&#x7406;&#x8BBA;&#x89D2;&#x5EA6;&#x6765;&#x770B;&#xFF0C;eureka&#x6EE1;&#x8DB3;&#x4E86;AP&#xFF0C;&#x800C;zookeeper&#x6EE1;&#x8DB3;&#x4E86;CP&#x3002;</p><h3 id="&#x67B6;&#x6784;&#x56FE;"><a href="#&#x67B6;&#x6784;&#x56FE;" class="headerlink" title="&#x67B6;&#x6784;&#x56FE;"></a>&#x67B6;&#x6784;&#x56FE;</h3><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/9G1.001.%E6%A1%86%E6%9E%B6-[eureka]-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0Eureka%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/2.jpg"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/9G1.001.%E6%A1%86%E6%9E%B6-[eureka]-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0Eureka%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/3.png"></p><h4 id="&#x51E0;&#x4E2A;&#x91CD;&#x8981;&#x6B65;&#x9AA4;&#xFF1A;"><a href="#&#x51E0;&#x4E2A;&#x91CD;&#x8981;&#x6B65;&#x9AA4;&#xFF1A;" class="headerlink" title="&#x51E0;&#x4E2A;&#x91CD;&#x8981;&#x6B65;&#x9AA4;&#xFF1A;"></a>&#x51E0;&#x4E2A;&#x91CD;&#x8981;&#x6B65;&#x9AA4;&#xFF1A;</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x5BF9;&#x4E8E;&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;&#xFF0C;&#x4F1A;&#x4E3B;&#x52A8;&#x505A;&#x4E0B;&#x9762;&#x4E09;&#x4EF6;&#x4E8B;                            </span><br><span class="line">    Register  &#x670D;&#x52A1;&#x6CE8;&#x518C;    ---------------&gt; ---------</span><br><span class="line">    Renew     &#x670D;&#x52A1;&#x7684;&#x7EED;&#x671F;    ---------------&gt; &#x6CE8;&#x518C;&#x4E2D;&#x5FC3;</span><br><span class="line">    Cancel: &#x670D;&#x52A1;&#x4E0B;&#x7EBF;    ---------------&gt; ---------</span><br><span class="line"></span><br><span class="line">&#x5BF9;&#x4E8E;&#x670D;&#x52A1;&#x6D88;&#x8D39;&#x8005;&#xFF0C;&#x4F1A;&#x505A;&#x4E0B;&#x9762;&#xFF1A;</span><br><span class="line">    Fetch Registry : &#x83B7;&#x53D6;&#x6CE8;&#x518C;&#x5217;&#x8868;&#x4FE1;&#x606F;</span><br><span class="line"></span><br><span class="line">&#x5BF9;&#x4E8E;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#xFF0C;&#x4F1A;&#x505A;&#x4E0B;&#x9762;&#xFF1A;</span><br><span class="line">    Eviction &#x670D;&#x52A1;&#x5254;&#x9664;/&#x5931;&#x6548;&#x5254;&#x9664;</span><br><span class="line">    Replicate &#x670D;&#x52A1;&#x540C;&#x6B65;</span><br></pre></td></tr></table></figure><p>&#x5931;&#x6548;&#x5254;&#x9664;&#xFF1A;&#x628A;&#x6CA1;&#x6709;&#x53CA;&#x65F6;&#x7EED;&#x7EA6;&#x7684;&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;&#x5254;&#x9664;&#xFF0C;&#x9ED8;&#x8BA4;&#x6BCF;&#x9694;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#xFF08;&#x9ED8;&#x8BA4;60&#x79D2;&#xFF09;&#x5C06;&#x5F53;&#x524D;&#x6E05;&#x5355;&#x4E2D;&#x8D85;&#x8FC7;&#xFF08;&#x9ED8;&#x8BA4;90&#x79D2;&#xFF09;&#x6CA1;&#x6709;&#x7EED;&#x7EA6;&#x7684;&#x670D;&#x52A1;&#x5254;&#x9664;&#x51FA;&#x53BB;&#x3002;<br>&#x81EA;&#x6211;&#x4FDD;&#x62A4;&#xFF1A;&#x4F1A;&#x7EDF;&#x8BA1;&#x5FC3;&#x8DF3;&#x5931;&#x8D25;&#x7684;&#x6BD4;&#x4F8B;&#x5728;15&#x5206;&#x949F;&#x4E4B;&#x5185;&#x662F;&#x5426;&#x4F4E;&#x4E8E;85%&#xFF08;&#x901A;&#x5E38;&#x7531;&#x4E8E;&#x7F51;&#x7EDC;&#x4E0D;&#x7A33;&#x5B9A;&#x5BFC;&#x81F4;&#xFF09;&#x3002;Eureka Server&#x4F1A;&#x5C06;&#x5F53;&#x524D;&#x7684;&#x5B9E;&#x4F8B;&#x6CE8;&#x518C;&#x4FE1;&#x606F;&#x4FDD;&#x62A4;&#x8D77;&#x6765;&#xFF0C;&#x8BA9;&#x8FD9;&#x4E9B;&#x5B9E;&#x4F8B;&#x4E0D;&#x4F1A;&#x8FC7;&#x671F;&#xFF0C;&#x5C3D;&#x53EF;&#x80FD;&#x4FDD;&#x62A4;&#x8FD9;&#x4FA7;&#x6CE8;&#x518C;&#x4FE1;&#x606F;&#x3002;</p><h4 id="&#x7EC4;&#x4EF6;&#x8C03;&#x7528;&#x5173;&#x7CFB;"><a href="#&#x7EC4;&#x4EF6;&#x8C03;&#x7528;&#x5173;&#x7CFB;" class="headerlink" title="&#x7EC4;&#x4EF6;&#x8C03;&#x7528;&#x5173;&#x7CFB;"></a>&#x7EC4;&#x4EF6;&#x8C03;&#x7528;&#x5173;&#x7CFB;</h4><h5 id="&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;"><a href="#&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;" class="headerlink" title="&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;"></a>&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;</h5><p>&#x542F;&#x52A8;&#x540E;&#xFF0C;&#x5411;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x53D1;&#x8D77; register &#x8BF7;&#x6C42;&#xFF0C;&#x6CE8;&#x518C;&#x670D;&#x52A1;<br>&#x5728;&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x5B9A;&#x65F6;&#x5411;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x53D1;&#x9001; renew &#x5FC3;&#x8DF3;&#xFF0C;&#x8BC1;&#x660E;&#x201C;&#x6211;&#x8FD8;&#x6D3B;&#x7740;&#x201D;&#x3002;<br>&#x505C;&#x6B62;&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;&#xFF0C;&#x5411;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x53D1;&#x8D77; cancel &#x8BF7;&#x6C42;&#xFF0C;&#x6E05;&#x7A7A;&#x5F53;&#x524D;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x4FE1;&#x606F;&#x3002;</p><h5 id="&#x670D;&#x52A1;&#x6D88;&#x8D39;&#x8005;"><a href="#&#x670D;&#x52A1;&#x6D88;&#x8D39;&#x8005;" class="headerlink" title="&#x670D;&#x52A1;&#x6D88;&#x8D39;&#x8005;"></a>&#x670D;&#x52A1;&#x6D88;&#x8D39;&#x8005;</h5><p>&#x542F;&#x52A8;&#x540E;&#xFF0C;&#x4ECE;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x62C9;&#x53D6;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x4FE1;&#x606F;<br>&#x5728;&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x5B9A;&#x65F6;&#x66F4;&#x65B0;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x4FE1;&#x606F;&#x3002;<br>&#x670D;&#x52A1;&#x6D88;&#x8D39;&#x8005;&#x53D1;&#x8D77;&#x8FDC;&#x7A0B;&#x8C03;&#x7528;&#xFF1A;<br>a&gt; &#x670D;&#x52A1;&#x6D88;&#x8D39;&#x8005;&#xFF08;&#x5317;&#x4EAC;&#xFF09;&#x4F1A;&#x4ECE;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x4FE1;&#x606F;&#x4E2D;&#x9009;&#x62E9;&#x540C;&#x673A;&#x623F;&#x7684;&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;&#xFF08;&#x5317;&#x4EAC;&#xFF09;&#xFF0C;&#x53D1;&#x8D77;&#x8FDC;&#x7A0B;&#x8C03;&#x7528;&#x3002;&#x53EA;&#x6709;&#x540C;&#x673A;&#x623F;&#x7684;&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;&#x6302;&#x4E86;&#x624D;&#x4F1A;&#x9009;&#x62E9;&#x5176;&#x4ED6;&#x673A;&#x623F;&#x7684;&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;&#xFF08;&#x9752;&#x5C9B;&#xFF09;&#x3002;<br>b&gt; &#x670D;&#x52A1;&#x6D88;&#x8D39;&#x8005;&#xFF08;&#x5929;&#x6D25;&#xFF09;&#x56E0;&#x4E3A;&#x540C;&#x673A;&#x623F;&#x5185;&#x6CA1;&#x6709;&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;&#xFF0C;&#x5219;&#x4F1A;&#x6309;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x7B97;&#x6CD5;&#x9009;&#x62E9;&#x5317;&#x4EAC;&#x6216;&#x9752;&#x5C9B;&#x7684;&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;&#xFF0C;&#x53D1;&#x8D77;&#x8FDC;&#x7A0B;&#x8C03;&#x7528;&#x3002;</p><h5 id="&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;"><a href="#&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;" class="headerlink" title="&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;"></a>&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;</h5><p>&#x542F;&#x52A8;&#x540E;&#xFF0C;&#x4ECE;&#x5176;&#x4ED6;&#x8282;&#x70B9;&#x62C9;&#x53D6;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x4FE1;&#x606F;&#x3002;<br>&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x5B9A;&#x65F6;&#x8FD0;&#x884C; evict &#x4EFB;&#x52A1;&#xFF0C;&#x5254;&#x9664;&#x6CA1;&#x6709;&#x6309;&#x65F6; renew &#x7684;&#x670D;&#x52A1;&#xFF08;&#x5305;&#x62EC;&#x975E;&#x6B63;&#x5E38;&#x505C;&#x6B62;&#x548C;&#x7F51;&#x7EDC;&#x6545;&#x969C;&#x7684;&#x670D;&#x52A1;&#xFF09;&#x3002;<br>&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x63A5;&#x6536;&#x5230;&#x7684; register&#x3001;renew&#x3001;cancel &#x8BF7;&#x6C42;&#xFF0C;&#x90FD;&#x4F1A;&#x540C;&#x6B65;&#x81F3;&#x5176;&#x4ED6;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x8282;&#x70B9;&#x3002;</p><h3 id="Eureka&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF1A;&#x4E09;&#x7EA7;&#x7F13;&#x5B58;"><a href="#Eureka&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF1A;&#x4E09;&#x7EA7;&#x7F13;&#x5B58;" class="headerlink" title="Eureka&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF1A;&#x4E09;&#x7EA7;&#x7F13;&#x5B58;"></a>Eureka&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF1A;&#x4E09;&#x7EA7;&#x7F13;&#x5B58;</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#xFF08;Registry&#xFF09;ConcurrentHashMap</span><br><span class="line">&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#xFF08;ReadWriteMap&#xFF09;guava#LoadingCache</span><br><span class="line">&#x4E09;&#x7EA7;&#x7F13;&#x5B58;&#xFF08;ReadOnlyMap&#xFF09;ConcurrentHashMap</span><br><span class="line"></span><br><span class="line">&#x6CE8;&#x518C;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x5B9E;&#x4F8B;</span><br><span class="line">    &#x5411;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#xFF08;Registry&#xFF09;&#x6CE8;&#x518C;&#x8868; &#x4E2D;&#x5199;&#x5165;&#x670D;&#x52A1;&#x5B9E;&#x4F8B;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x4F7F;&#x5F97; &#x4E8C;&#x7EA7;&#x7F13;&#x5B58; &#x5931;&#x6548;</span><br><span class="line"></span><br><span class="line">&#x5BFB;&#x627E;&#x4E00;&#x4E2A;&#x670D;&#x52A1;</span><br><span class="line">    &#x4ECE;&#x4E09;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;&#x627E;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x5219;&#x8FD4;&#x56DE;&#xFF0C;</span><br><span class="line">    &#x5982;&#x679C;&#x6CA1;&#x6709;&#x5219;&#x53BB;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x62FF;&#x5E76;&#x66F4;&#x65B0;&#xFF0C;</span><br><span class="line">        &#x5982;&#x679C;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x5DF2;&#x7ECF;&#x5931;&#x6548;&#xFF0C;&#x89E6;&#x53D1;guava&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x4ECE;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#xFF08;Registry&#xFF09;&#x6CE8;&#x518C;&#x8868;&#x4E2D;&#x540C;&#x6B65;&#x3002;</span><br><span class="line"></span><br><span class="line">&#x6570;&#x636E;&#x540C;&#x6B65;&#x5B9A;&#x65F6;&#x5668;</span><br><span class="line">    &#x6BCF; 30s &#x4ECE;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x5411;&#x4E09;&#x7EA7;&#x7F13;&#x5B58;&#x540C;&#x6B65;&#x6570;&#x636E;</span><br><span class="line">    &#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x6709;&#x6548;</span><br><span class="line">        &#x4ECE;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x5411;&#x4E09;&#x7EA7;&#x7F13;&#x5B58;&#x540C;&#x6B65;&#x6570;&#x636E;</span><br><span class="line">    &#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x5931;&#x6548;</span><br><span class="line">        &#x89E6;&#x53D1;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x7684;&#x540C;&#x6B65;&#xFF08;&#x4ECE;&#x6CE8;&#x518C;&#x8868;&#x4E2D;&#x62C9;&#x53D6;&#x6570;&#x636E;&#xFF09;</span><br></pre></td></tr></table></figure><p>&#x56FE;&#x89E3;&#xFF1A;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/9G1.001.%E6%A1%86%E6%9E%B6-[eureka]-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0Eureka%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Eureka%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98.png"></p><h3 id="Eureka&#x6E90;&#x7801;&#x5206;&#x6790;"><a href="#Eureka&#x6E90;&#x7801;&#x5206;&#x6790;" class="headerlink" title="Eureka&#x6E90;&#x7801;&#x5206;&#x6790;"></a>Eureka&#x6E90;&#x7801;&#x5206;&#x6790;</h3><p><code>spring-cloud-dependencies</code>&#x7248;&#x672C;&#xFF1A;<code>Edgware.SR3</code></p><h4 id="Eureka-Client&#x542F;&#x52A8;&#x8FC7;&#x7A0B;"><a href="#Eureka-Client&#x542F;&#x52A8;&#x8FC7;&#x7A0B;" class="headerlink" title="Eureka Client&#x542F;&#x52A8;&#x8FC7;&#x7A0B;"></a>Eureka Client&#x542F;&#x52A8;&#x8FC7;&#x7A0B;</h4><p>1.&#x6CE8;&#x89E3; <code>@EnableDiscoveryClient</code> &#x2013;&gt; <code>EnableDiscoveryClientImportSelector</code> &#xFF0C;&#x8FD9;&#x4E2A;&#x7EE7;&#x627F;&#x4E86; <code>extends SpringFactoryImportSelector </code></p><p>&#x4F1A;&#x6267;&#x884C;<code>spring.factories</code>&#x4E2D;key&#x4E3A; <code>org.springframework.cloud.client.discovery.EnableDiscoveryClient</code> &#x7684;@Configuration&#x7C7B;</p><p>2.<code>spring.factories</code>&#x6587;&#x4EF6;&#x5728;: <code>spring-cloud-netflix-eureka-client-{version}</code>.jar&#x5305;&#x4E0B;</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.cloud.netflix.eureka.config.EurekaClientConfigServerAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.cloud.netflix.ribbon.eureka.RibbonEurekaAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientConfiguration</span></span><br><span class="line"></span><br><span class="line"><span class="attr">org.springframework.cloud.bootstrap.BootstrapConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceBootstrapConfiguration</span></span><br></pre></td></tr></table></figure><p>3.&#x4ECE;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x4F1A;&#x5148;&#x53BB;&#x6267;&#x884C; <code>EurekaDiscoveryClientConfiguration</code> &#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x52A0;&#x8F7D;&#x5176;&#x4E2D;&#x7684;&#x914D;&#x7F6E;,&#x7136;&#x540E;&#x518D;&#x53BB;&#x6267;&#x884C; <code>EurekaClientAutoConfiguration</code> &#x914D;&#x7F6E;&#x7C7B;<br>&#x4E24;&#x4E2A;&#x6BD4;&#x8F83;&#x5173;&#x952E;&#x7684;&#x7C7B;&#xFF1A;<br><code>EurekaDiscoveryClientConfiguration</code> &#x548C; <code>EurekaClientAutoConfiguration</code></p><p><code>EurekaClientAutoConfiguration</code> &#x7C7B;&#x4E2D;&#x521B;&#x5EFA;<code>EurekaClient</code>&#xFF1A;&#xFF08;&#x6700;&#x7EC8;&#x5B9E;&#x4F8B;&#xFF1A;CloudEurekaClient` &#xFF09;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> EurekaClient <span class="title function_">eurekaClient</span><span class="params">(ApplicationInfoManager manager,</span></span><br><span class="line"><span class="params">        EurekaClientConfig config, EurekaInstanceConfig instance)</span> {</span><br><span class="line">    manager.getInfo(); <span class="comment">// force initialization</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CloudEurekaClient</span>(manager, config, <span class="built_in">this</span>.optionalArgs,</span><br><span class="line">            <span class="built_in">this</span>.context);</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p><code>EurekaClient</code>&#x662F;&#x5728;<code>EurekaClientAutoConfiguration</code>$<code>RefreshableEurekaClientConfiguration</code>#<code>eurekaClient</code>(<code>ApplicationInfoManager, EurekaClientConfig, EurekaInstanceConfig</code>)&#x65B9;&#x6CD5;&#x4E2D;&#x521B;&#x5EFA;&#x7684;,<br>&#x521B;&#x5EFA;&#x7684;&#x662F; <code>org.springframework.cloud.netflix.eureka.CloudEurekaClient</code></p><p>&#x7C7B;&#x5C42;&#x6B21;&#x5173;&#x7CFB;&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">springcloud&#x63A5;&#x53E3;&#xFF1A;DiscoveryClient</span><br><span class="line">    String description();</span><br><span class="line">    List&lt;ServiceInstance&gt; getInstances(String serviceId)</span><br><span class="line">    List&lt;String&gt; getServices();</span><br><span class="line"></span><br><span class="line">netflix EurekaDiscoveryClient &#x5B9E;&#x73B0;&#x4E86;springcloud&#x63A5;&#x53E3;&#xFF1A;DiscoveryClient</span><br><span class="line">EurekaDiscoveryClient &#x6784;&#x9020;&#x65B9;&#x6CD5;&#x91CC;&#xFF0C;&#x521D;&#x59CB;&#x5316;&#x4E86;netflix EurekaClient&#x63A5;&#x53E3;&#x7684;&#x5F15;&#x7528;&#xFF08;&#x5B9E;&#x73B0;&#x7C7B;&#x662F;&#xFF1A;CloudEurekaClient&#xFF09;</span><br><span class="line"></span><br><span class="line">&#x63A5;&#x53E3;netflix EurekaClient &#x7EE7;&#x627F;&#x4E86;&#x63A5;&#x53E3;&#xFF1A;netflix LookupService</span><br><span class="line">    &#x5B9E;&#x73B0;&#x7C7B;&#xFF1A;netflix DiscoveryClient</span><br><span class="line">        &#x5B50;&#x7C7B;&#xFF1A;CloudEurekaClient &#x7EE7;&#x627F;&#x4E86;&#xFF1A;netflix DiscoveryClient</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">spring-cloud-netflix-eureka-client-{version}.jar&#x5305;&#x4E0B;spring.factories</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">  org.springframework.cloud.netflix.eureka.server.EurekaServerAutoConfiguration</span><br></pre></td></tr></table></figure><p>UML&#x7C7B;&#x56FE;&#x5C42;&#x6B21;&#x5173;&#x7CFB;&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">interface DiscoveryClient</span><br><span class="line">DiscoveryClient : springcloud&#x63A5;&#x53E3;</span><br><span class="line"></span><br><span class="line">class EurekaDiscoveryClient</span><br><span class="line">EurekaDiscoveryClient : springcloud&#x5B9E;&#x73B0;&#x7C7B;</span><br><span class="line"></span><br><span class="line">DiscoveryClient &lt;|.. EurekaDiscoveryClient</span><br><span class="line"></span><br><span class="line">class CloudEurekaClient</span><br><span class="line">CloudEurekaClient : springcloud&#x5B9E;&#x73B0;&#x7C7B;</span><br><span class="line"></span><br><span class="line">EurekaDiscoveryClient o-- CloudEurekaClient : &#x6784;&#x9020;&#x65B9;&#x6CD5;&#x805A;&#x5408;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface LookupService</span><br><span class="line">LookupService : netflix&#x63A5;&#x53E3;</span><br><span class="line"></span><br><span class="line">interface EurekaClient</span><br><span class="line">EurekaClient : netflix&#x63A5;&#x53E3;</span><br><span class="line"></span><br><span class="line">class netfix_DiscoveryClient</span><br><span class="line">netfix_DiscoveryClient : netflix&#x5B9E;&#x73B0;&#x7C7B;</span><br><span class="line"></span><br><span class="line">LookupService &lt;|-- EurekaClient</span><br><span class="line">EurekaClient &lt;|.. netfix_DiscoveryClient</span><br><span class="line"></span><br><span class="line">netfix_DiscoveryClient &lt;|-- CloudEurekaClient</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/9G1.001.%E6%A1%86%E6%9E%B6-[eureka]-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0Eureka%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/eureka-client.png"></p><p>4.&#x6838;&#x5FC3;&#x903B;&#x8F91;&#x4EE3;&#x7801;<br><code>CloudEurekaClient</code>&#x7EE7;&#x627F;&#x4E86;<code>com.netflix.discovery.DiscoveryClient</code>&#xFF0C;&#x5728;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x4E2D;&#x8C03;&#x7528;&#x4E86;<code>initScheduledTasks()</code>&#x65B9;&#x6CD5;&#xFF0C;<br>&#x5728;&#x8BE5;&#x65B9;&#x6CD5;&#x4E2D;&#x6839;&#x636E;&#x914D;&#x7F6E;&#x4E2D;&#x7684; <code>eureka.client.fetch-registry</code> &#x548C; <code>eureka.client.register-with-eureka</code> &#x7684;&#x503C;&#xFF0C;<br>&#x5224;&#x65AD;&#x662F;&#x5426;&#x521B;&#x5EFA;&#x62C9;&#x53D6;&#x670D;&#x52A1;&#x6E05;&#x5355;&#x7684;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x548C;<code>&#x670D;&#x52A1;&#x7EED;&#x7EA6;&#x7684;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;</code>&#x4EE5;&#x53CA;&#x670D;&#x52A1;&#x83B7;&#x53D6;&#x7684;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x3002;</p><p>CloudEurekaClient</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiscoveryClient</span> <span class="keyword">implements</span> <span class="title class_">EurekaClient</span> {</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes all scheduled tasks.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initScheduledTasks</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) {</span><br><span class="line">            <span class="comment">// registry cache refresh timer</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">registryFetchIntervalSeconds</span> <span class="operator">=</span> clientConfig.getRegistryFetchIntervalSeconds();</span><br><span class="line">            <span class="type">int</span> <span class="variable">expBackOffBound</span> <span class="operator">=</span> clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</span><br><span class="line">            <span class="comment">//&#x521B;&#x5EFA;&#x62C9;&#x53D6;&#x670D;&#x52A1;&#x6E05;&#x5355;&#x7684;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;</span></span><br><span class="line">            scheduler.schedule(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">TimedSupervisorTask</span>(</span><br><span class="line">                            <span class="string">&quot;cacheRefresh&quot;</span>,</span><br><span class="line">                            scheduler,</span><br><span class="line">                            cacheRefreshExecutor,</span><br><span class="line">                            registryFetchIntervalSeconds,</span><br><span class="line">                            TimeUnit.SECONDS,</span><br><span class="line">                            expBackOffBound,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">CacheRefreshThread</span>()</span><br><span class="line">                    ),</span><br><span class="line">                    registryFetchIntervalSeconds, TimeUnit.SECONDS);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) {</span><br><span class="line">            <span class="type">int</span> <span class="variable">renewalIntervalInSecs</span> <span class="operator">=</span> instanceInfo.getLeaseInfo().getRenewalIntervalInSecs();</span><br><span class="line">            <span class="type">int</span> <span class="variable">expBackOffBound</span> <span class="operator">=</span> clientConfig.getHeartbeatExecutorExponentialBackOffBound();</span><br><span class="line">            logger.info(<span class="string">&quot;Starting heartbeat executor: &quot;</span> + <span class="string">&quot;renew interval is: &quot;</span> + renewalIntervalInSecs);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x7EED;&#x7EA6;&#x7684;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;(&#x5FC3;&#x8DF3;)</span></span><br><span class="line">            <span class="comment">// Heartbeat timer</span></span><br><span class="line">            scheduler.schedule(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">TimedSupervisorTask</span>(</span><br><span class="line">                            <span class="string">&quot;heartbeat&quot;</span>,</span><br><span class="line">                            scheduler,</span><br><span class="line">                            heartbeatExecutor,</span><br><span class="line">                            renewalIntervalInSecs,</span><br><span class="line">                            TimeUnit.SECONDS,</span><br><span class="line">                            expBackOffBound,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">HeartbeatThread</span>()</span><br><span class="line">                    ),</span><br><span class="line">                    renewalIntervalInSecs, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//&#x8FD9;&#x662F;&#x4E00;&#x4E2A;Runnable&#x63A5;&#x53E3;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x7684;&#x903B;&#x8F91;&#x5C31;&#x5728;run()&#x65B9;&#x6CD5;&#x4E2D;&#x3002;</span></span><br><span class="line">            <span class="comment">// InstanceInfo replicator</span></span><br><span class="line">            instanceInfoReplicator = <span class="keyword">new</span> <span class="title class_">InstanceInfoReplicator</span>(</span><br><span class="line">                    <span class="built_in">this</span>,</span><br><span class="line">                    instanceInfo,</span><br><span class="line">                    clientConfig.getInstanceInfoReplicationIntervalSeconds(),</span><br><span class="line">                    <span class="number">2</span>); <span class="comment">// burstSize</span></span><br><span class="line">            <span class="comment">//&#x670D;&#x52A1;&#x5B9E;&#x4F8B;&#x72B6;&#x6001;&#x76D1;&#x542C;&#x5668;</span></span><br><span class="line">            statusChangeListener = <span class="keyword">new</span> <span class="title class_">ApplicationInfoManager</span>.StatusChangeListener() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> {</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;statusChangeListener&quot;</span>;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notify</span><span class="params">(StatusChangeEvent statusChangeEvent)</span> {</span><br><span class="line">                    <span class="keyword">if</span> (InstanceStatus.DOWN == statusChangeEvent.getStatus() ||</span><br><span class="line">                            InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) {</span><br><span class="line">                        <span class="comment">// log at warn level if DOWN was involved</span></span><br><span class="line">                        logger.warn(<span class="string">&quot;Saw local status change event {}&quot;</span>, statusChangeEvent);</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        logger.info(<span class="string">&quot;Saw local status change event {}&quot;</span>, statusChangeEvent);</span><br><span class="line">                    }</span><br><span class="line"><span class="comment">//&#x5982;&#x679C;&#x72B6;&#x6001;&#x53D1;&#x751F;&#x6539;&#x53D8;&#xFF0C; &#x91CD;&#x65B0;&#x5C06;&#x5B9E;&#x4F8B;&#x4FE1;&#x606F;&#x6CE8;&#x518C;&#x5230;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;</span></span><br><span class="line">instanceInfoReplicator.onDemandUpdate();</span><br><span class="line">                }</span><br><span class="line">            };</span><br><span class="line">        <span class="comment">//&#x5224;&#x65AD;&#x914D;&#x7F6E;&#x4E2D;&#x662F;&#x5426;&#x8BBE;&#x7F6E;&#x4E86;&#x6CE8;&#x518C;&#x670D;&#x52A1;&#x5B9E;&#x4F8B;&#x72B6;&#x6001;&#x76D1;&#x542C;&#x5668;</span></span><br><span class="line">            <span class="keyword">if</span> (clientConfig.shouldOnDemandUpdateStatusChange()) {</span><br><span class="line">                applicationInfoManager.registerStatusChangeListener(statusChangeListener);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#x5C06;&#x81EA;&#x8EAB;&#x6CE8;&#x518C;&#x5230;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x4E2D;</span></span><br><span class="line">instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            logger.info(<span class="string">&quot;Not registering with Eureka server per configuration&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>InstanceInfoReplicator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">InstanceInfoReplicator</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="type">int</span> initialDelayMs)</span> {</span><br><span class="line">        <span class="keyword">if</span> (started.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) {</span><br><span class="line">            instanceInfo.setIsDirty();  <span class="comment">// for initial register</span></span><br><span class="line">            <span class="comment">//&#x5C06;&#x6CE8;&#x518C;&#x7684;&#x52A8;&#x4F5C;&#x6DFB;&#x52A0;&#x5230;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x4E2D;</span></span><br><span class="line">            <span class="type">Future</span> <span class="variable">next</span> <span class="operator">=</span> scheduler.schedule(<span class="built_in">this</span>, initialDelayMs, TimeUnit.SECONDS);</span><br><span class="line">            scheduledPeriodicRef.set(next);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> {</span><br><span class="line">        scheduler.shutdownNow();</span><br><span class="line">        started.set(<span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onDemandUpdate</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">if</span> (rateLimiter.acquire(burstSize, allowedRatePerMinute)) {</span><br><span class="line">            scheduler.submit(<span class="keyword">new</span> <span class="title class_">Runnable</span>() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">                    logger.debug(<span class="string">&quot;Executing on-demand update of local InstanceInfo&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="type">Future</span> <span class="variable">latestPeriodic</span> <span class="operator">=</span> scheduledPeriodicRef.get();</span><br><span class="line">                    <span class="keyword">if</span> (latestPeriodic != <span class="literal">null</span> &amp;&amp; !latestPeriodic.isDone()) {</span><br><span class="line">                        logger.debug(<span class="string">&quot;Canceling the latest scheduled update, it will be rescheduled at the end of on demand update&quot;</span>);</span><br><span class="line">                        latestPeriodic.cancel(<span class="literal">false</span>);</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    InstanceInfoReplicator.<span class="built_in">this</span>.run();</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            logger.warn(<span class="string">&quot;Ignoring onDemand update due to rate limiter&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            discoveryClient.refreshInstanceInfo();</span><br><span class="line"></span><br><span class="line">            <span class="type">Long</span> <span class="variable">dirtyTimestamp</span> <span class="operator">=</span> instanceInfo.isDirtyWithTime();</span><br><span class="line">            <span class="keyword">if</span> (dirtyTimestamp != <span class="literal">null</span>) {</span><br><span class="line">                <span class="comment">//&#x6CE8;&#x518C;&#x5230;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#xFF0C;&#x5E76;&#x6807;&#x8BB0;</span></span><br><span class="line">                discoveryClient.register();</span><br><span class="line">                instanceInfo.unsetIsDirty(dirtyTimestamp);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">            logger.warn(<span class="string">&quot;There was a problem with the instance info replicator&quot;</span>, t);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="type">Future</span> <span class="variable">next</span> <span class="operator">=</span> scheduler.schedule(<span class="built_in">this</span>, replicationIntervalSeconds, TimeUnit.SECONDS);</span><br><span class="line">            scheduledPeriodicRef.set(next);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>&#x4ECE;&#x4E0A;&#x8FF0;&#x7684;&#x4EE3;&#x7801;&#x4E2D;&#x53EF;&#x4EE5;&#x5230;&#x770B;&#x5230;&#xFF0C;&#x670D;&#x52A1;&#x5728;&#x542F;&#x52A8;&#x65F6;&#xFF0C;&#x6839;&#x636E;&#x914D;&#x7F6E;&#x521B;&#x5EFA;&#x4E86;&#x76F8;&#x5173;&#x7684;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#xFF0C;&#x5982;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x3001;&#x670D;&#x52A1;&#x83B7;&#x53D6;&#x3001;&#x670D;&#x52A1;&#x7EED;&#x7EA6;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E2A;&#x529F;&#x80FD;&#x7684;&#x903B;&#x8F91;&#x5165;&#x53E3;&#x4F9D;&#x7136;&#x662F;&#x5728;com.netflix.discovery.DiscoveryClient&#x4E2D;&#xFF1A;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.netflix.discovery;</span><br><span class="line">...</span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiscoveryClient</span> <span class="keyword">implements</span> <span class="title class_">EurekaClient</span> {</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register with the eureka service by making the appropriate REST call.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">//&#x6CE8;&#x518C;</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">register</span><span class="params">()</span> <span class="keyword">throws</span> Throwable {</span><br><span class="line">        logger.info(PREFIX + appPathIdentifier + <span class="string">&quot;: registering service...&quot;</span>);</span><br><span class="line">        EurekaHttpResponse&lt;Void&gt; httpResponse;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            httpResponse = eurekaTransport.registrationClient.register(instanceInfo);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            logger.warn(<span class="string">&quot;{} - registration failed {}&quot;</span>, PREFIX + appPathIdentifier, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br><span class="line">            logger.info(<span class="string">&quot;{} - registration status: {}&quot;</span>, PREFIX + appPathIdentifier, httpResponse.getStatusCode());</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> httpResponse.getStatusCode() == <span class="number">204</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Renew with the eureka service by making the appropriate REST call</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">//&#x7EED;&#x7EA6;</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">renew</span><span class="params">()</span> {</span><br><span class="line">        EurekaHttpResponse&lt;InstanceInfo&gt; httpResponse;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            httpResponse = eurekaTransport.registrationClient.sendHeartBeat(instanceInfo.getAppName(), instanceInfo.getId(), instanceInfo, <span class="literal">null</span>);</span><br><span class="line">            logger.debug(<span class="string">&quot;{} - Heartbeat status: {}&quot;</span>, PREFIX + appPathIdentifier, httpResponse.getStatusCode());</span><br><span class="line">            <span class="keyword">if</span> (httpResponse.getStatusCode() == <span class="number">404</span>) {</span><br><span class="line">                REREGISTER_COUNTER.increment();</span><br><span class="line">                logger.info(<span class="string">&quot;{} - Re-registering apps/{}&quot;</span>, PREFIX + appPathIdentifier, instanceInfo.getAppName());</span><br><span class="line">                <span class="keyword">return</span> register();</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> httpResponse.getStatusCode() == <span class="number">200</span>;</span><br><span class="line">        } <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line">            logger.error(<span class="string">&quot;{} - was unable to send heartbeat!&quot;</span>, PREFIX + appPathIdentifier, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//&#x4E0B;&#x7EBF;</span></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">if</span> (isShutdown.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) {</span><br><span class="line">            logger.info(<span class="string">&quot;Shutting down DiscoveryClient ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (statusChangeListener != <span class="literal">null</span> &amp;&amp; applicationInfoManager != <span class="literal">null</span>) {</span><br><span class="line">                applicationInfoManager.unregisterStatusChangeListener(statusChangeListener.getId());</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            cancelScheduledTasks();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If APPINFO was registered</span></span><br><span class="line">            <span class="keyword">if</span> (applicationInfoManager != <span class="literal">null</span> &amp;&amp; clientConfig.shouldRegisterWithEureka()) {</span><br><span class="line">                applicationInfoManager.setInstanceStatus(InstanceStatus.DOWN);</span><br><span class="line">                unregister();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (eurekaTransport != <span class="literal">null</span>) {</span><br><span class="line">                eurekaTransport.shutdown();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            heartbeatStalenessMonitor.shutdown();</span><br><span class="line">            registryStalenessMonitor.shutdown();</span><br><span class="line"></span><br><span class="line">            logger.info(<span class="string">&quot;Completed shut down of DiscoveryClient&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//&#x83B7;&#x53D6;&#x670D;&#x52A1;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">fetchRegistry</span><span class="params">(<span class="type">boolean</span> forceFullRegistryFetch)</span> {</span><br><span class="line">        <span class="type">Stopwatch</span> <span class="variable">tracer</span> <span class="operator">=</span> FETCH_REGISTRY_TIMER.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// If the delta is disabled or if it is the first time, get all</span></span><br><span class="line">            <span class="comment">// applications</span></span><br><span class="line">            <span class="type">Applications</span> <span class="variable">applications</span> <span class="operator">=</span> getApplications();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clientConfig.shouldDisableDelta()</span><br><span class="line">                    || (!Strings.isNullOrEmpty(clientConfig.getRegistryRefreshSingleVipAddress()))</span><br><span class="line">                    || forceFullRegistryFetch</span><br><span class="line">                    || (applications == <span class="literal">null</span>)</span><br><span class="line">                    || (applications.getRegisteredApplications().size() == <span class="number">0</span>)</span><br><span class="line">                    || (applications.getVersion() == -<span class="number">1</span>)) <span class="comment">//Client application does not have latest library supporting delta</span></span><br><span class="line">            {</span><br><span class="line">                logger.info(<span class="string">&quot;Disable delta property : {}&quot;</span>, clientConfig.shouldDisableDelta());</span><br><span class="line">                logger.info(<span class="string">&quot;Single vip registry refresh property : {}&quot;</span>, clientConfig.getRegistryRefreshSingleVipAddress());</span><br><span class="line">                logger.info(<span class="string">&quot;Force full registry fetch : {}&quot;</span>, forceFullRegistryFetch);</span><br><span class="line">                logger.info(<span class="string">&quot;Application is null : {}&quot;</span>, (applications == <span class="literal">null</span>));</span><br><span class="line">                logger.info(<span class="string">&quot;Registered Applications size is zero : {}&quot;</span>,</span><br><span class="line">                        (applications.getRegisteredApplications().size() == <span class="number">0</span>));</span><br><span class="line">                logger.info(<span class="string">&quot;Application version is -1: {}&quot;</span>, (applications.getVersion() == -<span class="number">1</span>));</span><br><span class="line">                getAndStoreFullRegistry();</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                getAndUpdateDelta(applications);</span><br><span class="line">            }</span><br><span class="line">            applications.setAppsHashCode(applications.getReconcileHashCode());</span><br><span class="line">            logTotalInstances();</span><br><span class="line">        } <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line">            logger.error(PREFIX + appPathIdentifier + <span class="string">&quot; - was unable to refresh its cache! status = &quot;</span> + e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">if</span> (tracer != <span class="literal">null</span>) {</span><br><span class="line">                tracer.stop();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Notify about cache refresh before updating the instance remote status</span></span><br><span class="line">        onCacheRefreshed();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update remote status based on refreshed data held in the cache</span></span><br><span class="line">        updateInstanceRemoteStatus();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// registry was fetched successfully, so return true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">refreshRegistry</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> fetchRegistry(remoteRegionsModified);</span><br><span class="line">            <span class="keyword">if</span> (success) {</span><br><span class="line">                registrySize = localRegionApps.get().size();</span><br><span class="line">                lastSuccessfulRegistryFetchTimestamp = System.currentTimeMillis();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            ...      </span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>&#x7CBE;&#x7B80;&#x4E0B;&#xFF1A;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">&#x6838;&#x5FC3;&#x903B;&#x8F91;&#xFF1A;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">springclound</span>.CloudEurekaClient <span class="keyword">extends</span> <span class="title class_">netflix</span>.DiscoveryClient {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">netflix</span>.DiscoveryClient {</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">DiscoveryClient() {</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">initScheduledTasks();</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">initScheduledTasks) {</span><br><span class="line"><span class="comment">//1.&#x542F;&#x52A8; FetchRegistry &#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#xFF1A; CacheRefreshThread--FetchRegistry</span></span><br><span class="line"><span class="comment">//2.&#x542F;&#x52A8; Renew &#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#xFF1A; HeatBeatThread--Renew</span></span><br><span class="line"><span class="comment">//3.&#x521B;&#x5EFA;InstanceInfoReplicator&#x5B9E;&#x5217;&#xFF0C;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x5185;&#x90E8;&#x4F1A;&#x5BF9;Instance&#x5B9E;&#x4F8B;&#x8FDB;&#x884C;register</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#x670D;&#x52A1;&#x7684;&#x6CE8;&#x518C;</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">register</span><span class="params">()</span> <span class="keyword">throws</span> Throwable {</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#x670D;&#x52A1;&#x7684;renew</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">renew</span><span class="params">()</span> {</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@PreDestroy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> {</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">unregister();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#x670D;&#x52A1;&#x7684;cancellation</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">unregister</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HeartBeatThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">          <span class="keyword">if</span> (renew()) {</span><br><span class="line">              lastSuccessfulHeartbeatTimestamp = System.currentTimeMillis();</span><br><span class="line">          }</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheRefreshThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">refreshRegistry();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">refreshRegistry</span><span class="params">()</span> {</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> fetchRegistry(remoteRegionsModified);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InstanceInfoReplicator</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">discoveryClient.register();</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/9G1.001.%E6%A1%86%E6%9E%B6-[eureka]-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0Eureka%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Eureka-client%E6%BA%90%E7%A0%811.png"></p><h4 id="Eureka-Server&#x542F;&#x52A8;&#x8FC7;&#x7A0B;"><a href="#Eureka-Server&#x542F;&#x52A8;&#x8FC7;&#x7A0B;" class="headerlink" title="Eureka Server&#x542F;&#x52A8;&#x8FC7;&#x7A0B;"></a>Eureka Server&#x542F;&#x52A8;&#x8FC7;&#x7A0B;</h4><p>&#x540C;EurekaClient&#x542F;&#x52A8;&#x4E00;&#x6837;&#xFF0C;&#x9700;&#x8981;&#x6DFB;&#x52A0;<code>@EnableEurekaServer</code>&#x6CE8;&#x89E3;&#x3002;&#x5728;&#x8BE5;&#x7C7B;&#x4E2D;&#x7528;<code>@Import(EurekaServerMarkerConfiguration.class)</code>&#x8868;&#x660E;&#x4E86;&#x7A0B;&#x5E8F;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x4F1A;&#x5148;&#x52A0;&#x8F7D;<code>EurekaServerMarkerConfiguration</code>&#x914D;&#x7F6E;&#x7C7B;&#x4E2D;&#x7684;&#x914D;&#x7F6E;&#xFF0C;<br>&#x800C;&#x5728;&#x8BE5;&#x914D;&#x7F6E;&#x7C7B;&#x4E2D;&#xFF0C;&#x53D1;&#x5E03;&#x4E86;&#x4E00;&#x4E2A;&#x6807;&#x8BB0;&#x7C7B; <code>EurekaServerMarkerConfiguration$Marker</code>&#xFF0C;&#x8BE5;&#x6807;&#x8BB0;&#x7C7B;&#x4F1A;&#x7528;&#x4E8E;&#x5F00;&#x542F;&#x540E;&#x7EED;EurekaServer&#x76F8;&#x5173;&#x914D;&#x7F6E;&#x7684;&#x52A0;&#x8F7D;&#x5DE5;&#x4F5C;&#x3002;</p><p>org.springframework.cloud.netflix.eureka.server.EnableEurekaServer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.cloud.netflix.eureka.server;</span><br><span class="line">...</span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(EurekaServerMarkerConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableEurekaServer {</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>org.springframework.cloud.netflix.eureka.server.EurekaServerMarkerConfiguration</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.cloud.netflix.eureka.server;</span><br><span class="line">...</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaServerMarkerConfiguration</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Marker <span class="title function_">eurekaServerMarkerBean</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Marker</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Marker</span> {</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>spring-cloud-netflix-eureka-server-{version}.jar!META-INF/spring.factories</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">  org.springframework.cloud.netflix.eureka.server.EurekaServerAutoConfiguration</span><br></pre></td></tr></table></figure><p>&#x4ECE;&#x4E0A;&#x9762;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#xFF0C;&#x627E;&#x5230;&#x4F1A;&#x88AB;&#x81EA;&#x52A8;&#x52A0;&#x8F7D;&#x7684;EurekaServerAutoConfiguration&#x914D;&#x7F6E;&#x7C7B;</p><p>org.springframework.cloud.netflix.eureka.server.EurekaServerAutoConfiguration</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.cloud.netflix.eureka.server;</span><br><span class="line">...</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(EurekaServerInitializerConfiguration.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(EurekaServerMarkerConfiguration.Marker.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties({ EurekaDashboardProperties.class,</span></span><br><span class="line"><span class="meta">        InstanceRegistryProperties.class })</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:/eureka/server.properties&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaServerAutoConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurerAdapter</span> {</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] EUREKA_PACKAGES = <span class="keyword">new</span> <span class="title class_">String</span>[] { <span class="string">&quot;com.netflix.discovery&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.netflix.eureka&quot;</span> };</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register the Jersey filter</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistrationBean <span class="title function_">jerseyFilterRegistration</span><span class="params">(</span></span><br><span class="line"><span class="params">            javax.ws.rs.core.Application eurekaJerseyApp)</span> {</span><br><span class="line">        <span class="type">FilterRegistrationBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>();</span><br><span class="line">        bean.setFilter(<span class="keyword">new</span> <span class="title class_">ServletContainer</span>(eurekaJerseyApp));</span><br><span class="line">        bean.setOrder(Ordered.LOWEST_PRECEDENCE);</span><br><span class="line">        <span class="comment">//(2)&#x521B;&#x5EFA;Filter,&#x5E76;&#x5339;&#x914D;&#x8DEF;&#x5F84;/eureka/*</span></span><br><span class="line">        bean.setUrlPatterns(</span><br><span class="line">                Collections.singletonList(EurekaConstants.DEFAULT_PREFIX + <span class="string">&quot;/*&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Construct a Jersey {<span class="doctag">@link</span> javax.ws.rs.core.Application} with all the resources</span></span><br><span class="line"><span class="comment">     * required by the Eureka server.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> javax.ws.rs.core.Application <span class="title function_">jerseyApplication</span><span class="params">(Environment environment,</span></span><br><span class="line"><span class="params">            ResourceLoader resourceLoader)</span> {</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassPathScanningCandidateComponentProvider</span> <span class="variable">provider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathScanningCandidateComponentProvider</span>(</span><br><span class="line">                <span class="literal">false</span>, environment);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Filter to include only classes that have a particular annotation.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// (1) &#x521B;&#x5EFA;&#x76F8;&#x5173;&#x7684;web&#x8282;&#x70B9;&#xFF0C; &#x6BD4;&#x5982;&#x6CE8;&#x518C;&#x63A5;&#x53E3;/eureka/apps/{appId}</span></span><br><span class="line">        provider.addIncludeFilter(<span class="keyword">new</span> <span class="title class_">AnnotationTypeFilter</span>(Path.class));</span><br><span class="line">        provider.addIncludeFilter(<span class="keyword">new</span> <span class="title class_">AnnotationTypeFilter</span>(Provider.class));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Find classes in Eureka packages (or subpackages)</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; classes = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">        <span class="comment">//&#x626B;&#x63CF;restful&#x63A5;&#x53E3;&#x8D44;&#x6E90;&#x7684;&#x7C7B;</span></span><br><span class="line">        <span class="keyword">for</span> (String basePackage : EUREKA_PACKAGES) {</span><br><span class="line">            Set&lt;BeanDefinition&gt; beans = provider.findCandidateComponents(basePackage);</span><br><span class="line">            <span class="keyword">for</span> (BeanDefinition bd : beans) {</span><br><span class="line">                Class&lt;?&gt; cls = ClassUtils.resolveClassName(bd.getBeanClassName(),</span><br><span class="line">                        resourceLoader.getClassLoader());</span><br><span class="line">                classes.add(cls);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Construct the Jersey ResourceConfig</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        Map&lt;String, Object&gt; propsAndFeatures = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        propsAndFeatures.put(</span><br><span class="line">                <span class="comment">// Skip static content used by the webapp</span></span><br><span class="line">                ServletContainer.PROPERTY_WEB_PAGE_CONTENT_REGEX,</span><br><span class="line">                EurekaConstants.DEFAULT_PREFIX + <span class="string">&quot;/(fonts|images|css|js)/.*&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">DefaultResourceConfig</span> <span class="variable">rc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultResourceConfig</span>(classes);</span><br><span class="line">        rc.setPropertiesAndFeatures(propsAndFeatures);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>org.springframework.cloud.netflix.eureka.server.EurekaController</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;${eureka.dashboard.path:/}&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaController</span> {</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;${eureka.dashboard.path:/}&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">dashboardPath</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> ApplicationInfoManager applicationInfoManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">EurekaController</span><span class="params">(ApplicationInfoManager applicationInfoManager)</span> {</span><br><span class="line"><span class="built_in">this</span>.applicationInfoManager = applicationInfoManager;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">status</span><span class="params">(HttpServletRequest request, Map&lt;String, Object&gt; model)</span> {</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequestMapping(value = &quot;/lastn&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">lastn</span><span class="params">(HttpServletRequest request, Map&lt;String, Object&gt; model)</span> {</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&#x670D;&#x52A1;&#x7684;&#x5254;&#x9664;&#x903B;&#x8F91;&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">EurekaServerInitializerConfiguration # start() -&gt;</span><br><span class="line">EurekaServerBootstrap # contextInitialized() -&gt;</span><br><span class="line">                      # initEurekaServerContext() -&gt;</span><br><span class="line">PeerAwareInstanceRegistryImpl # openForTraffic() -&gt;</span><br><span class="line">AbstractInstanceRegistry # postInit()</span><br></pre></td></tr></table></figure><p>AbstractInstanceRegistry&#x4E2D;&#x521B;&#x5EFA;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;: EvictionTask</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractInstanceRegistry</span> <span class="keyword">implements</span> <span class="title class_">InstanceRegistry</span> {</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">postInit</span><span class="params">()</span> {</span><br><span class="line">      renewsLastMin.start();</span><br><span class="line">      <span class="keyword">if</span> (evictionTaskRef.get() != <span class="literal">null</span>) {</span><br><span class="line">          evictionTaskRef.get().cancel();</span><br><span class="line">      }</span><br><span class="line">      evictionTaskRef.set(<span class="keyword">new</span> <span class="title class_">EvictionTask</span>());</span><br><span class="line">      evictionTimer.schedule(evictionTaskRef.get(),</span><br><span class="line">              serverConfig.getEvictionIntervalTimerInMs(),</span><br><span class="line">              serverConfig.getEvictionIntervalTimerInMs());</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>com.netflix.eureka.registry.PeerAwareInstanceRegistry</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PeerAwareInstanceRegistry</span> <span class="keyword">extends</span> <span class="title class_">InstanceRegistry</span> {</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>org.springframework.cloud.netflix.eureka.server.InstanceRegistry</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InstanceRegistry</span> <span class="keyword">extends</span> <span class="title class_">PeerAwareInstanceRegistryImpl</span></span><br><span class="line"><span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> {</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">renew</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x4E3B;&#x8981;&#x4ECB;&#x7ECD;Eureka Server&#x5728;&#x542F;&#x52A8;&#x65F6;&#xFF0C;&#x521B;&#x5EFA;&#x76F8;&#x5173;&#x63A5;&#x53E3;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x8FD9;&#x4E9B;&#x63A5;&#x53E3;&#x662F;&#x7528;&#x4E8E;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#xFF0C;&#x670D;&#x52A1;&#x7EED;&#x7EA6;&#xFF0C;&#x4EE5;&#x53CA;&#x670D;&#x52A1;&#x4E0B;&#x7EBF;&#x7B49;&#x3002;&#x8FD9;&#x4E9B;&#x63A5;&#x53E3;&#x662F;&#x7528;jersey&#x53D1;&#x5E03;&#x7684;restful&#x63A5;&#x53E3;&#xFF0C;<br>&#x8D44;&#x6E90;&#x7C7B;&#x90FD;&#x5728;<code>com.netflix.eureka.resources</code>&#x5305;&#x4E0B;&#x3002;</p><p>&#x672C;&#x7BC7;&#x6E90;&#x7801;&#x5206;&#x6790;&#x5199;&#x7684;&#x6BD4;&#x8F83;&#x7C97;&#xFF0C;&#x8BE6;&#x7EC6;&#x770B;&#x770B;&#x4EBA;&#x5BB6;&#x7684;:</p><ul><li><a href="https://juejin.cn/post/7020203732407156750">https://juejin.cn/post/7020203732407156750</a></li><li><a href="https://juejin.cn/post/7020208871809482766">https://juejin.cn/post/7020208871809482766</a></li><li><a href="https://juejin.cn/post/7020312146516934669">https://juejin.cn/post/7020312146516934669</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;&amp;#x670D;&amp;#x52A1;&amp;#x6CE8;&amp;#x518C;&amp;#x4E0E;&amp;#x53D1;&amp;#x73B0;&amp;#x7EC4;&amp;#x4EF6;Eureka&quot;&gt;&lt;a href=&quot;#&amp;#x670D;&amp;#x52A1;&amp;#x6CE8;&amp;#x518C;&amp;#x4E0E;&amp;#x53D1;&amp;#x73B0;&amp;#x7EC4;&amp;#x4EF6;Eureka&quot; class=&quot;headerlink&quot; title=&quot;&amp;#x670D;&amp;#x52A1;&amp;#x6CE8;&amp;#x518C;&amp;#x4E0E;&amp;#x53D1;&amp;#x73B0;&amp;#x7EC4;&amp;#x4EF6;Eureka&quot;&gt;&lt;/a&gt;&amp;#x670D;&amp;#x52A1;&amp;#x6CE8;&amp;#x518C;&amp;#x4E0E;&amp;#x53D1;&amp;#x73B0;&amp;#x7EC4;&amp;#x4EF6;Eureka&lt;/h3&gt;&lt;p&gt;Eureka&amp;#x662F;Netflix&amp;#x5F00;&amp;#x53D1;&amp;#x7684;&amp;#x670D;&amp;#x52A1;&amp;#x53D1;&amp;#x73B0;&amp;#x7EC4;&amp;#x4EF6;&amp;#xFF0C;&amp;#x672C;&amp;#x8EAB;&amp;#x662F;&amp;#x4E00;&amp;#x4E2A;&amp;#x57FA;&amp;#x4E8E;REST&amp;#x7684;&amp;#x670D;&amp;#x52A1;&amp;#x3002;Spring Cloud&amp;#x5C06;&amp;#x5B83;&amp;#x96C6;&amp;#x6210;&amp;#x5728;&amp;#x5176;&amp;#x5B50;&amp;#x9879;&amp;#x76EE;spring-cloud-netflix&amp;#x4E2D;&amp;#xFF0C;&amp;#x4EE5;&amp;#x5B9E;&amp;#x73B0;Spring Cloud&amp;#x7684;&amp;#x670D;&amp;#x52A1;&amp;#x53D1;&amp;#x73B0;&amp;#x529F;&amp;#x80FD;&lt;/p&gt;
&lt;p&gt;Eureka&lt;br&gt;&amp;#x6E90;&amp;#x7801;&amp;#xFF1A;&lt;a href=&quot;https://github.com/Netflix/eureka/&quot;&gt;https://github.com/Netflix/eureka/&lt;/a&gt;&lt;br&gt;&amp;#x6587;&amp;#x6863;&amp;#xFF1A;&lt;a href=&quot;https://github.com/Netflix/eureka/wiki&quot;&gt;https://github.com/Netflix/eureka/wiki&lt;/a&gt;&lt;br&gt;&amp;#x67B6;&amp;#x6784;&amp;#x4ECB;&amp;#x7ECD;&amp;#xFF1A;High level architecture: &lt;a href=&quot;https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance&quot;&gt;https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Framework-框架" scheme="http://example.com/categories/Framework-%E6%A1%86%E6%9E%B6/"/>
    
    
    <category term="eureka" scheme="http://example.com/tags/eureka/"/>
    
  </entry>
  
  <entry>
    <title>框架-[hystrix]-Hystrix原理与源码分析</title>
    <link href="http://example.com/2022/08/07/9G3.001.%E6%A1%86%E6%9E%B6-[hystrix]-Hystrix%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://example.com/2022/08/07/9G3.001.%E6%A1%86%E6%9E%B6-[hystrix]-Hystrix%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</id>
    <published>2022-08-06T16:00:00.000Z</published>
    <updated>2023-09-20T09:05:42.497Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Hystrix&#x4E2D;&#x4F1A;&#x89E6;&#x53D1;&#x964D;&#x7EA7;&#x7684;&#x4E09;&#x79CD;&#x9014;&#x5F84;"><a href="#Hystrix&#x4E2D;&#x4F1A;&#x89E6;&#x53D1;&#x964D;&#x7EA7;&#x7684;&#x4E09;&#x79CD;&#x9014;&#x5F84;" class="headerlink" title="Hystrix&#x4E2D;&#x4F1A;&#x89E6;&#x53D1;&#x964D;&#x7EA7;&#x7684;&#x4E09;&#x79CD;&#x9014;&#x5F84;:"></a>Hystrix&#x4E2D;&#x4F1A;&#x89E6;&#x53D1;&#x964D;&#x7EA7;&#x7684;&#x4E09;&#x79CD;&#x9014;&#x5F84;:</h3><p>1.<code>&#x7194;&#x65AD;</code>&#x89E6;&#x53D1;&#x964D;&#x7EA7;<br>2.<code>&#x8BF7;&#x6C42;&#x8D85;&#x65F6;</code>&#x89E6;&#x53D1;&#x964D;&#x7EA7;<br>3.<code>&#x8D44;&#x6E90;&#x9694;&#x79BB;</code>&#x89E6;&#x53D1;&#x964D;&#x7EA7;</p><span id="more"></span><p>&#x89E6;&#x53D1;<code>&#x7194;&#x65AD;fusing</code>&#x7684;&#x60C5;&#x5F62;&#x6709;&#xFF1A;<br>1.&#x9519;&#x8BEF;&#x7684;&#x5931;&#x8D25;&#x8C03;&#x7528;&#x6B21;&#x6570;&#x767E;&#x5206;&#x6BD4;&#xFF0C;&#x8FBE;&#x5230;&#x9600;&#x503C;&#x540E;&#xFF0C;&#x89E6;&#x53D1;&#x7194;&#x65AD;&#xFF1A;&#x5728;<code>sleepWindowInMilliseconds</code>&#x7A97;&#x53E3;&#x65F6;&#x95F4;&#x5185;&#xFF0C;&#x6700;&#x5C0F;&#x8BF7;&#x6C42;:<code>requestVolumeThreshold</code>&#x6B21;&#xFF0C;&#x82E5;&#x767E;&#x5206;&#x6BD4;&#x8D85;&#x8FC7;&#xFF1A;<code>errorThresholdPercentage</code>&#xFF0C;&#x5C31;&#x4F1A;&#x7194;&#x65AD;&#xFF0C;&#x8FDB;&#x5165;&#x964D;&#x7EA7;&#x903B;&#x8F91;<br>2.&#x8BF7;&#x6C42;&#x8D85;&#x65F6;&#x89E6;&#x53D1;&#x7194;&#x65AD;&#xFF0C;&#x8FDB;&#x5165;&#x964D;&#x7EA7;&#x903B;&#x8F91;<br>3.&#x8D44;&#x6E90;&#x9694;&#x79BB;&#x89E6;&#x53D1;&#x7194;&#x65AD;&#xFF0C;&#x8FDB;&#x5165;&#x964D;&#x7EA7;&#x903B;&#x8F91;</p><p>&#x4ECE;&#x4EE5;&#x4E0A;&#x770B;&#x51FA;&#xFF0C;&#x89E6;&#x53D1;&#x964D;&#x7EA7;&#x7684;&#x6839;&#x672C;&#x539F;&#x56E0;&#xFF0C;&#x662F;&#x89E6;&#x53D1;&#x4E86;&#x7194;&#x65AD;</p><h3 id="hystrix&#x7194;&#x65AD;&#x903B;&#x8F91;&#xFF1A;"><a href="#hystrix&#x7194;&#x65AD;&#x903B;&#x8F91;&#xFF1A;" class="headerlink" title="hystrix&#x7194;&#x65AD;&#x903B;&#x8F91;&#xFF1A;"></a>hystrix&#x7194;&#x65AD;&#x903B;&#x8F91;&#xFF1A;</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x7194;&#x65AD;&#x5668;&#x5DF2;&#x7ECF;&#x5F00;&#x542F;&#xFF0C;&#x4F1A;&#x8FDB;&#x5165;&#x964D;&#x7EA7;&#x65B9;&#x6CD5;&#xFF1B;</span><br><span class="line">      &#x6CA1;&#x6709;&#x5F00;&#x542F;&#xFF0C;&#x5224;&#x65AD;&#x7EBF;&#x7A0B;&#x6C60;&#x662F;&#x5426;&#x6EE1;&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x6EE1;&#x4E86;&#xFF0C;&#x4F1A;&#x8FDB;&#x5165;&#x964D;&#x7EA7;&#x65B9;&#x6CD5;&#xFF1B;</span><br><span class="line">                                    &#x5982;&#x679C;&#x6CA1;&#x6709;&#x6EE1;&#xFF0C;&#x6267;&#x884C;&#x4E1A;&#x52A1;&#x65B9;&#x6CD5;&#xFF0C;&#x6B64;&#x65F6;&#x5224;&#x65AD;&#x4E1A;&#x52A1;&#x65B9;&#x6CD5;&#x662F;&#x5426;&#x6267;&#x884C;&#x5F02;&#x5E38;&#xFF0C;&#x5982;&#x679C;&#x5F02;&#x5E38;&#xFF0C;&#x8FDB;&#x5165;&#x964D;&#x7EA7;&#x65B9;&#x6CD5;&#xFF1B;</span><br><span class="line">                                                                                            &#x5982;&#x679C;&#x6CA1;&#x6709;&#x5F02;&#x5E38;&#xFF0C;&#x5224;&#x65AD;&#x6267;&#x884C;&#x65F6;&#x95F4;&#x662F;&#x5426;&#x8D85;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x8D85;&#x65F6;&#xFF0C;&#x8FDB;&#x5165;&#x964D;&#x7EA7;&#x65B9;&#x6CD5;&#xFF1B;</span><br><span class="line">                                                                                                                                &#x5982;&#x679C;&#x6CA1;&#x6709;&#x8D85;&#x65F6;&#xFF0C;&#x6210;&#x529F;&#x8FD4;&#x56DE;&#xFF1B;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/9G3.001.%E6%A1%86%E6%9E%B6-[hystrix]-Hystrix%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/1.png"></p><h3 id="Hystrix&#x662F;&#x600E;&#x4E48;&#x505A;&#x5230;&#x964D;&#x7EA7;&#x7684;&#x5462;&#xFF1F;"><a href="#Hystrix&#x662F;&#x600E;&#x4E48;&#x505A;&#x5230;&#x964D;&#x7EA7;&#x7684;&#x5462;&#xFF1F;" class="headerlink" title="Hystrix&#x662F;&#x600E;&#x4E48;&#x505A;&#x5230;&#x964D;&#x7EA7;&#x7684;&#x5462;&#xFF1F;"></a>Hystrix&#x662F;&#x600E;&#x4E48;&#x505A;&#x5230;&#x964D;&#x7EA7;&#x7684;&#x5462;&#xFF1F;</h3><p>&#x4ED6;&#x901A;&#x8FC7;&#x4E00;&#x79CD;&#x53EB;&#x505A;&#x201C;&#x547D;&#x4EE4;&#x6A21;&#x5F0F;&#x201D;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x7EE7;&#x627F;(HystrixCommand&#x7C7B;)&#x6765;&#x5305;&#x88F9;&#x5177;&#x4F53;&#x7684;&#x670D;&#x52A1;&#x8C03;&#x7528; &#x903B;&#x8F91;(run&#x65B9;&#x6CD5;), &#x5E76;&#x5728;&#x547D;&#x4EE4;&#x6A21;&#x5F0F;&#x4E2D;&#x6DFB;&#x52A0;&#x4E86;&#x670D;&#x52A1;&#x8C03;&#x7528;&#x5931;&#x8D25;&#x540E;&#x7684;&#x964D;&#x7EA7;&#x903B;&#x8F91;(getFallback)</p><h3 id="&#x89E6;&#x53D1;&#x964D;&#x7EA7;&#x56DE;&#x9000;fallback&#x7684;&#x573A;&#x666F;"><a href="#&#x89E6;&#x53D1;&#x964D;&#x7EA7;&#x56DE;&#x9000;fallback&#x7684;&#x573A;&#x666F;" class="headerlink" title="&#x89E6;&#x53D1;&#x964D;&#x7EA7;&#x56DE;&#x9000;fallback&#x7684;&#x573A;&#x666F;"></a>&#x89E6;&#x53D1;&#x964D;&#x7EA7;&#x56DE;&#x9000;fallback&#x7684;&#x573A;&#x666F;</h3><p><a href="https://www.iocoder.cn/Hystrix/circuit-breaker/">https://www.iocoder.cn/Hystrix/circuit-breaker/</a><br>1.&#x603B;&#x8BF7;&#x6C42;&#x6570;&#x8D85;&#x8FC7;&#x4E00;&#x5B9A;&#x91CF;( &#x53EF;&#x914D;&#xFF0C;HystrixCommandProperties.circuitBreakerRequestVolumeThreshold = 20 )<br>2.&#x9519;&#x8BEF;&#x8BF7;&#x6C42;&#x5360;&#x603B;&#x8BF7;&#x6C42;&#x6570;&#x8D85;&#x8FC7;&#x4E00;&#x5B9A;&#x6BD4;&#x4F8B;( &#x53EF;&#x914D;&#xFF0C;HystrixCommandProperties.circuitBreakerErrorThresholdPercentage = 50% )</p><p>&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF1A;<br>&#x8BA2;&#x5355;&#x670D;&#x52A1;order &#x2014;&#x4F9D;&#x8D56;/&#x8C03;&#x7528;&#x2014;&gt; &#x7528;&#x6237;&#x670D;&#x52A1;user<br>&#x89E6;&#x53D1;&#x964D;&#x7EA7;&#x56DE;&#x9000;fallback&#x7684;&#x60C5;&#x5F62;&#x6709;&#xFF08;&#x4E00;&#x5B9A;&#x662F;&#x5728;&#x8C03;&#x7528;&#x65B9;&#x6765;&#x505A;&#x964D;&#x7EA7;&#xFF0C;&#x8BA2;&#x5355;&#x670D;&#x52A1;&#xFF09;&#xFF1A;<br>a.&#x7528;&#x6237;&#x670D;&#x52A1;&#x5B95;&#x673A;&#x4E0D;&#x53EF;&#x7528;&#xFF0C;&#x7F51;&#x5173;502&#xFF1B;<br>b.&#x7528;&#x6237;&#x670D;&#x52A1;&#x54CD;&#x5E94;&#x8D85;&#x65F6;&#xFF1B;&#xFF08;&#x8C03;&#x7528;&#x65B9;&#x9ED8;&#x8BA4;&#x7684;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x662F;2&#x79D2;&#xFF09;<br>c.&#x7528;&#x6237;&#x670D;&#x52A1;&#x5185;&#x90E8;500&#x9519;&#x8BEF;&#xFF0C;&#x670D;&#x52A1;&#x5185;&#x90E8;&#x629B;exception&#xFF1B;<br>d.&#x8BA2;&#x5355;&#x670D;&#x52A1;&#x63A5;&#x53E3;&#x8BBE;&#x5B9A;&#x7684;&#x9650;&#x6D41;&#x914D;&#x7F6E;&#xFF0C;&#x8D85;&#x8FC7;&#x7684;&#x9650;&#x6D41;&#x6570;&#xFF0C;&#x4F1A;&#x8FDB;&#x5165;&#x964D;&#x7EA7;</p><p>&#x7194;&#x65AD;&#x3001;&#x9650;&#x6D41; &#x6700;&#x7EC8;&#x90FD;&#x4F1A;&#x8FDB;&#x5165; &#x964D;&#x7EA7;&#x56DE;&#x9000; &#x903B;&#x8F91;<br>&#x8D44;&#x6E90;&#x9694;&#x79BB;&#x7194;&#x65AD;&#xFF1A;&#x8D44;&#x6E90;&#x9694;&#x79BB;&#x7194;&#x65AD;&#x53EF;&#x4EE5;&#x5206;&#x4E3A; &#x4FE1;&#x53F7;&#x91CF;&#x9694;&#x79BB;&#x548C;&#x7EBF;&#x7A0B;&#x6C60;&#x9694;&#x79BB;&#x3002;</p><h3 id="&#x6CE8;&#x89E3;-HystrixCommand&#xFF0C;&#x5982;&#x4F55;&#x88AB;&#x8BC6;&#x522B;&#x7684;&#xFF1F;"><a href="#&#x6CE8;&#x89E3;-HystrixCommand&#xFF0C;&#x5982;&#x4F55;&#x88AB;&#x8BC6;&#x522B;&#x7684;&#xFF1F;" class="headerlink" title="&#x6CE8;&#x89E3;@HystrixCommand&#xFF0C;&#x5982;&#x4F55;&#x88AB;&#x8BC6;&#x522B;&#x7684;&#xFF1F;"></a>&#x6CE8;&#x89E3;@HystrixCommand&#xFF0C;&#x5982;&#x4F55;&#x88AB;&#x8BC6;&#x522B;&#x7684;&#xFF1F;</h3><p>Hystrix&#x7194;&#x65AD;&#x7684; @HystrixCommand &#x6CE8;&#x89E3;&#xFF0C;&#x662F;&#x901A;&#x8FC7; HystrixCommandAspect &#x8FD9;&#x4E2A;&#x5207;&#x9762;&#x6765;&#x5904;&#x7406;&#x7684;</p><p>Hystrix &#x6700;&#x6838;&#x5FC3;&#x7684;&#x57FA;&#x7840;&#x7EC4;&#x4EF6;&#xFF0C;&#x5F53;&#x5C5E;&#x63D0;&#x4F9B;&#x89C2;&#x5BDF;&#x8005;&#x6A21;&#x5F0F;&#xFF08;&#x53D1;&#x5E03;-&#x8BA2;&#x9605;&#x6A21;&#x5F0F;&#xFF09;&#x7684; RxJava&#x3002;</p><h3 id="Hystrix&#x7684;&#x9650;&#x6D41;-&#x6570;&#x636E;&#x7EDF;&#x8BA1;&#x662F;&#x91C7;&#x7528;&#x7684;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;"><a href="#Hystrix&#x7684;&#x9650;&#x6D41;-&#x6570;&#x636E;&#x7EDF;&#x8BA1;&#x662F;&#x91C7;&#x7528;&#x7684;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;" class="headerlink" title="Hystrix&#x7684;&#x9650;&#x6D41;-&#x6570;&#x636E;&#x7EDF;&#x8BA1;&#x662F;&#x91C7;&#x7528;&#x7684;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;"></a>Hystrix&#x7684;&#x9650;&#x6D41;-&#x6570;&#x636E;&#x7EDF;&#x8BA1;&#x662F;&#x91C7;&#x7528;&#x7684;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;</h3><p>Hystrix &#x5B9E;&#x73B0;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x5229;&#x7528;&#x4E86; RxJava &#x8FD9;&#x4E2A;&#x54CD;&#x5E94;&#x5F0F;&#x51FD;&#x6570;&#x7F16;&#x7A0B;&#x6846;&#x67B6;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x5176;&#x4E2D;&#x7684;&#x51E0;&#x4E2A;&#x51FD;&#x6570;&#xFF1A;</p><ol><li>window&#xFF1A;&#x6839;&#x636E;&#x6307;&#x5B9A;&#x65F6;&#x95F4;&#x6216;&#x6307;&#x5B9A;&#x6570;&#x91CF;&#x5BF9;&#x6570;&#x636E;&#x6D41;&#x8FDB;&#x884C;&#x805A;&#x96C6;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E; 1 &#x5BF9; N &#x7684;&#x8F6C;&#x6362;&#xFF1B;</li><li>flatMap&#xFF1A;&#x5C06;&#x8F93;&#x5165;&#x6570;&#x636E;&#x6D41;&#xFF0C;&#x8F6C;&#x6362;&#x6210;&#x53E6;&#x4E00;&#x79CD;&#x683C;&#x5F0F;&#x7684;&#x6570;&#x636E;&#x6D41;&#xFF0C;&#x5728;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x7EDF;&#x8BA1;&#x4E2D;&#x8D77;&#x5230;&#x4E86;&#x6570;&#x636E;&#x6C42;&#x548C;&#x7684;&#x529F;&#x80FD;&#xFF08;&#x5F53;&#x7136;&#x5176;&#x529F;&#x80FD;&#x5E76;&#x4E0D;&#x9650;&#x4E8E;&#x6C42;&#x548C;&#xFF09;&#x3002;<br>&#x5229;&#x7528;rxJava&#x6A21;&#x62DF;&#x5B9E;&#x73B0;hystrix&#x91CC;&#x7684;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#xFF1A;<a href="https://blog.csdn.net/hustspy1990/article/details/77978329">https://blog.csdn.net/hustspy1990/article/details/77978329</a></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> rx.Observable;</span><br><span class="line"><span class="keyword">import</span> rx.functions.Func1;</span><br><span class="line"><span class="keyword">import</span> rx.functions.Func2;</span><br><span class="line"><span class="keyword">import</span> rx.subjects.PublishSubject;</span><br><span class="line"><span class="keyword">import</span> rx.subjects.SerializedSubject;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * https://blog.csdn.net/hustspy1990/article/details/77978329</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ray</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RollingWindowTest</span> {</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Func2&lt;Integer, Integer, Integer&gt; INTEGER_SUM =</span><br><span class="line">(integer, integer2) -&gt; integer + integer2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Func1&lt;Observable&lt;Integer&gt;, Observable&lt;Integer&gt;&gt; WINDOW_SUM =  </span><br><span class="line">window -&gt; window.scan(<span class="number">0</span>, INTEGER_SUM).skip(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Func1&lt;Observable&lt;Integer&gt;, Observable&lt;Integer&gt;&gt; INNER_BUCKET_SUM =</span><br><span class="line">        integerObservable -&gt; integerObservable.reduce(<span class="number">0</span>, INTEGER_SUM);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">DateTimeFormatter</span> <span class="variable">dtf</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy/MM/dd HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">PublishSubject&lt;Integer&gt; publishSubject = PublishSubject.create();</span><br><span class="line">SerializedSubject&lt;Integer, Integer&gt; serializedSubject = publishSubject.toSerialized();</span><br><span class="line">serializedSubject</span><br><span class="line">.window(<span class="number">5</span>, TimeUnit.SECONDS)  <span class="comment">// 5&#x79D2;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;bucket</span></span><br><span class="line">.flatMap(INNER_BUCKET_SUM) <span class="comment">// &#x4E00;&#x4E2A;bucket&#x5185;&#x6570;&#x636E;&#x6C42;&#x548C;</span></span><br><span class="line">.window(<span class="number">3</span>, <span class="number">1</span>)<span class="comment">// 3&#x4E2A;bucket&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x7A97;&#x53E3;&#xFF0C;&#x6ED1;&#x52A8;&#x6B65;&#x6570;&#x4E3A;1</span></span><br><span class="line">.flatMap(WINDOW_SUM)<span class="comment">// &#x7A97;&#x53E3;&#x6570;&#x636E;&#x6C42;&#x548C;</span></span><br><span class="line">.subscribe(integer -&gt; <span class="comment">// &#x8F93;&#x51FA;&#x7EDF;&#x8BA1;&#x6570;&#x636E;&#x5230;&#x65E5;&#x5FD7;</span></span><br><span class="line">System.out.println(String.format(<span class="string">&quot;%s:[%s] call ..... %s&quot;</span>, dtf.format(LocalDateTime.now()), Thread.currentThread().getName(), integer)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// &#x7F13;&#x6162;&#x53D1;&#x9001;&#x6570;&#x636E;&#xFF0C;&#x89C2;&#x5BDF;&#x6548;&#x679C;</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; ++i) {</span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">30</span>) {</span><br><span class="line">                serializedSubject.onNext(<span class="number">1</span>);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                serializedSubject.onNext(<span class="number">2</span>);</span><br><span class="line">            }</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="Hystrix&#x4E2D;&#xFF0C;&#x8D85;&#x65F6;&#x89E6;&#x53D1;&#x7684;&#x7194;&#x65AD;&#xFF0C;&#x8FDB;&#x800C;&#x8C03;&#x7528;&#x964D;&#x7EA7;&#x65B9;&#x6CD5;&#x7684;&#x5927;&#x81F4;&#x903B;&#x8F91;&#xFF1A;"><a href="#Hystrix&#x4E2D;&#xFF0C;&#x8D85;&#x65F6;&#x89E6;&#x53D1;&#x7684;&#x7194;&#x65AD;&#xFF0C;&#x8FDB;&#x800C;&#x8C03;&#x7528;&#x964D;&#x7EA7;&#x65B9;&#x6CD5;&#x7684;&#x5927;&#x81F4;&#x903B;&#x8F91;&#xFF1A;" class="headerlink" title="Hystrix&#x4E2D;&#xFF0C;&#x8D85;&#x65F6;&#x89E6;&#x53D1;&#x7684;&#x7194;&#x65AD;&#xFF0C;&#x8FDB;&#x800C;&#x8C03;&#x7528;&#x964D;&#x7EA7;&#x65B9;&#x6CD5;&#x7684;&#x5927;&#x81F4;&#x903B;&#x8F91;&#xFF1A;"></a>Hystrix&#x4E2D;&#xFF0C;&#x8D85;&#x65F6;&#x89E6;&#x53D1;&#x7684;<code>&#x7194;&#x65AD;</code>&#xFF0C;&#x8FDB;&#x800C;&#x8C03;&#x7528;<code>&#x964D;&#x7EA7;</code>&#x65B9;&#x6CD5;&#x7684;&#x5927;&#x81F4;&#x903B;&#x8F91;&#xFF1A;</h3><p>(&#x6A21;&#x62DF;&#x5B9E;&#x73B0;&#xFF1A;<a href="https://www.cnblogs.com/wuzhenzhao/p/13726372.html">https://www.cnblogs.com/wuzhenzhao/p/13726372.html</a>)</p><blockquote><p>&#x91C7;&#x7528; <code>@HystrixCommand</code> &#x6CE8;&#x89E3;&#x6765;&#x5B9E;&#x73B0;&#x670D;&#x52A1;&#x964D;&#x7EA7;&#xFF0C;&#x5728;Hystrix &#x7684;&#x5185;&#x90E8;&#x662F;&#x91C7;&#x7528; AOP &#x7684;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x62E6;&#x622A;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x7684;&#x3002;<br>&#x5C06;&#x8C03;&#x7528;&#x4E1A;&#x52A1;&#x65B9;&#x6CD5;&#xFF0C;&#x653E;&#x5728;&#x7EBF;&#x7A0B;&#x6C60;&#x4E2D;&#x6267;&#x884C;&#xFF0C;&#x8C03;&#x7528;Future.get&#x65B9;&#x6CD5;&#xFF0C;&#x540C;&#x6B65;&#x7B49;&#x5F85; timeout&#x53C2;&#x6570;&#x4E2A;&#x65F6;&#x95F4;&#xFF0C;&#x8BF4;&#x767D;&#x4E86;&#xFF0C;&#x6CA1;&#x6709;&#x8D85;&#x65F6;&#x5C31;&#x6210;&#x529F;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#xFF1B;&#x5982;&#x679C;&#x8D85;&#x65F6;&#x4E86;&#xFF0C;&#x5C31;&#x8C03;&#x7528;&#x964D;&#x7EA7;&#x65B9;&#x6CD5;&#x3002;<br>&#x8BF4;&#x767D;&#x4E86;&#xFF0C;&#x8D85;&#x65F6;&#x673A;&#x5236;&#xFF0C;&#x5C31;&#x662F;&#x5229;&#x7528;JUC&#x5305;&#x4E0B;&#x7684;Future.get&#x65B9;&#x6CD5;&#x3002;</p></blockquote><h3 id="Hystrix&#x6574;&#x4F53;&#x6E90;&#x7801;&#x5206;&#x6790;"><a href="#Hystrix&#x6574;&#x4F53;&#x6E90;&#x7801;&#x5206;&#x6790;" class="headerlink" title="Hystrix&#x6574;&#x4F53;&#x6E90;&#x7801;&#x5206;&#x6790;"></a>Hystrix&#x6574;&#x4F53;&#x6E90;&#x7801;&#x5206;&#x6790;</h3><p><a href="https://www.cnblogs.com/wuzhenzhao/p/13726372.html">https://www.cnblogs.com/wuzhenzhao/p/13726372.html</a></p><p>Hystrix&#x7194;&#x65AD;&#x7684;<code>@HystrixCommand</code>&#x6CE8;&#x89E3;&#xFF0C;&#x662F;&#x901A;&#x8FC7; <code>HystrixCommandAspect</code> &#x8FD9;&#x4E2A;&#x5207;&#x9762;&#x6765;&#x5904;&#x7406;&#x7684;&#x3002;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HystrixCommandAspect</span><br><span class="line">    methodsAnnotatedWithHystrixCommand &#x65B9;&#x6CD5;&#xFF0C;&#x62E6;&#x622A;&#x6CE8;&#x89E3;&#xFF1A;HystrixCommand &#x548C; HystrixCollapser</span><br><span class="line">        CommandExecutor.execute    &#x662F;&#x5426;&#x662F;&#x54CD;&#x5E94;&#x5F0F;&#x7684;&#xFF08;&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x8FD9;&#x4E9B;&#x90FD;&#x662F;&#x540C;&#x6B65;&#x7684;&#x4F1A;&#x8D70;&#x8FD9;&#x4E2A;&#x903B;&#x8F91;&#xFF09;</span><br><span class="line">        executeObservable</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">CommandExecutor.execute            &#x4E3B;&#x8981;&#x7528;&#x6765;&#x6267;&#x884C;&#x547D;&#x4EE4;    &#x9ED8;&#x8BA4;&#x7684;executionType=SYNCHRONOUS &#xFF0C;&#x540C;&#x6B65;&#x8BF7;&#x6C42;        </span><br><span class="line">    executionType&#xFF1A;    SYNCHRONOUS        &#x540C;&#x6B65;        </span><br><span class="line">                    ASYNCHRONOUS    &#x5F02;&#x6B65;    </span><br><span class="line">                    OBSERVABLE        &#x54CD;&#x5E94;&#x5F0F;    </span><br><span class="line">execute():&#x540C;&#x6B65;&#x6267;&#x884C;&#xFF0C;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x5355;&#x4E00;&#x7684;&#x5BF9;&#x8C61;&#x7ED3;&#x679C;&#xFF0C;&#x53D1;&#x751F;&#x9519;&#x8BEF;&#x65F6;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#x3002;</span><br><span class="line">queue():&#x5F02;&#x6B65;&#x6267;&#x884C;&#xFF0C;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A; Future &#x5BF9;&#x8C61;&#xFF0C;&#x5305;&#x542B;&#x7740;&#x6267;&#x884C;&#x7ED3;&#x675F;&#x540E;&#x8FD4;&#x56DE;&#x7684;&#x5355;&#x4E00;&#x7ED3;&#x679C;&#x3002;&#x6BD4;&#x8F83;&#x6709;&#x610F;&#x601D;&#x7684;&#x662F;&#xFF0C;FutureDecorator&#x7C7B;&#x88C5;&#x9970;&#x5C01;&#x88C5;&#x4E86;Future&#x3002;</span><br><span class="line">observe():&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A; Observable &#x5BF9;&#x8C61;&#xFF0C;&#x5B83;&#x4EE3;&#x8868;&#x64CD;&#x4F5C;&#x7684;&#x591A;&#x4E2A;&#x7ED3;&#x679C;&#xFF0C;&#x4F46;&#x662F;&#x5DF2;&#x7ECF;&#x88AB;&#x8BA2;&#x9605;&#x8005;&#x6D88;&#x8D39;&#x6389;&#x4E86;&#x3002;</span><br><span class="line">toObservable():&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A; Observable &#x5BF9;&#x8C61;&#xFF0C;&#x5B83;&#x4EE3;&#x8868;&#x64CD;&#x4F5C;&#x7684;&#x591A;&#x4E2A;&#x7ED3;&#x679C;&#xFF0C;&#x9700;&#x8981;&#x54B1;&#x4EEC;&#x81EA;&#x5DF1;&#x624B;&#x52A8;&#x8BA2;&#x9605;&#x5E76;&#x6D88;&#x8D39;&#x6389;&#x3002;</span><br><span class="line"></span><br><span class="line">&#x56E0;&#x4E3A;&#x9ED8;&#x8BA4;&#x7684;executionType=SYNCHRONOUS &#xFF0C;&#x540C;&#x6B65;&#x8BF7;&#x6C42;</span><br><span class="line">&#x6240;&#x4EE5;&#x4F1A;&#x8C03;&#x7528;castToExecutable(invokable, executionType).execute()&#xFF0C;castToExecutable(invokable, executionType)&#x662F; HystrixCommand &#x5B9E;&#x4F8B;</span><br><span class="line">&#x6240;&#x4EE5;&#x4F1A;&#x8C03;&#x7528; HystrixCommand.execute()&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;future&#x5BF9;&#x8C61;&#x3002;</span><br><span class="line"></span><br><span class="line">&#x91CD;&#x70B9;&#x6765;&#x4E86;&#xFF0C;&#x6784;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A; java.util.concurrent.Future &#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528; get&#x7684;&#x65F6;&#x5019;&#x59D4;&#x6D3E;&#x7ED9; delegate&#xFF0C;&#x800C; delegate&#x6765;&#x81EA;&#x4E8E; toObservable().toBlocking().toFuture();</span><br><span class="line"></span><br><span class="line">executeCommandAndObserve(_cmd)</span><br><span class="line">    AbstractCommand.executeCommandAndObserve(AbstractCommand&lt;R&gt; _cmd)</span><br><span class="line">    ...</span><br><span class="line">    executeCommandWithSpecifiedIsolation:&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x9996;&#x5148;&#x662F;&#x6839;&#x636E;&#x5F53;&#x524D;&#x4E0D;&#x540C;&#x7684;&#x8D44;&#x6E90;&#x9694;&#x79BB;&#x7B56;&#x7565;&#x6267;&#x884C;&#x4E0D;&#x540C;&#x7684;&#x903B;&#x8F91;&#xFF0C;THREAD&#x3001;SEMAPHORE:            </span><br><span class="line">         getUserExecutionObservable &#x3002;&#x7136;&#x540E;&#x4F1A;&#x6267;&#x884C; HystrixCommand#getExecutionObservable</span><br><span class="line">            run()    &#x53C8;&#x770B;&#x5230;&#x719F;&#x6089;&#x7684;&#x4EE3;&#x7801;   &#xFF0C;&#x8FD9;&#x4E2A; run() &#x65B9;&#x6CD5;&#x5728;&#x901A;&#x8FC7;&#x96C6;&#x6210; HystrixCommand &#x7C7B;&#x6765;&#x5B9E;&#x73B0;&#x7194;&#x65AD;&#x964D;&#x7EA7;&#x7684;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x91CD;&#x5199;&#x4E86;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x662F;&#x771F;&#x6B63;&#x7684;&#x6267;&#x884C;&#x65B9;&#x6CD5;&#x3002;</span><br><span class="line">                    &#x8FD9;&#x91CC;&#x6700;&#x7EC8;&#x8C03;&#x7528;&#x7684;&#x662F;run&#x65B9;&#x6CD5;&#xFF0C;&#x901A;&#x8FC7;Observable.just&#xFF0C; just&#x662F;RxJava&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x64CD;&#x4F5C;&#x7B26;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x63A5;&#x53D7;&#x4E00;&#x4E2A;&#x6216;&#x8005;&#x591A;&#x4E2A;&#x53C2;&#x6570;&#x6765;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;Observable&#x5BF9;&#x8C61;&#x3002;&#x800C;&#x8FD9;&#x4E2A;run&#xFF08;&#xFF09;&#x65B9;&#x6CD5;&#x662F;&#x4E00;&#x4E2A;&#x62BD;&#x8C61;&#x65B9;&#x6CD5;&#xFF0C;&#x5728;HystrixCommand&#x4E2D;&#x5E76;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;&#xFF0C;&#x800C;&#x662F;&#x5728;&#x5B50;&#x7C7B;&#x4E2D;&#x5B9E;&#x73B0;&#xFF0C;&#x800C;&#x6B64;&#x65F6;&#x4F20;&#x9012;&#x7684;cmd=GenricCommand&#x6B63;&#x597D;&#x5B9E;&#x73B0;&#x4E86;HystrixCommand&#xFF0C;&#x91CD;&#x5199;&#x4E86;run&#x65B9;&#x6CD5;&#x3002;            </span><br><span class="line"></span><br><span class="line">&#x771F;&#x6B63;&#x8C03;&#x7528;&#x201D;&#x4E1A;&#x52A1;&#x65B9;&#x91CD;&#x5199;&#x7684;&#x964D;&#x7EA7;&#x65B9;&#x6CD5;&#x201C;&#xFF1A;</span><br><span class="line">GenericCommand.run() throws Exception {</span><br><span class="line">    LOGGER.debug(&quot;execute command: {}&quot;, getCommandKey().name());</span><br><span class="line">    return process(new Action() {</span><br><span class="line">        @Override</span><br><span class="line">        Object execute() {</span><br><span class="line">            return getCommandAction().execute(getExecutionType());</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">}    </span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/9G3.001.%E6%A1%86%E6%9E%B6-[hystrix]-Hystrix%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/2.png"></p><h3 id="Hystrix&#x914D;&#x7F6E;&#xFF1A;"><a href="#Hystrix&#x914D;&#x7F6E;&#xFF1A;" class="headerlink" title="Hystrix&#x914D;&#x7F6E;&#xFF1A;"></a>Hystrix&#x914D;&#x7F6E;&#xFF1A;</h3><ul><li><a href="https://my.oschina.net/dengfuwei/blog/1621342">spring-cloud&#x6E90;&#x7801;&#x89E3;&#x6790;-hystrix&#x7684;&#x57FA;&#x672C;&#x4ECB;&#x7ECD;&#x548C;&#x914D;&#x7F6E;&#x5C5E;&#x6027;&#x8BF4;&#x660E;</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;Hystrix&amp;#x4E2D;&amp;#x4F1A;&amp;#x89E6;&amp;#x53D1;&amp;#x964D;&amp;#x7EA7;&amp;#x7684;&amp;#x4E09;&amp;#x79CD;&amp;#x9014;&amp;#x5F84;&quot;&gt;&lt;a href=&quot;#Hystrix&amp;#x4E2D;&amp;#x4F1A;&amp;#x89E6;&amp;#x53D1;&amp;#x964D;&amp;#x7EA7;&amp;#x7684;&amp;#x4E09;&amp;#x79CD;&amp;#x9014;&amp;#x5F84;&quot; class=&quot;headerlink&quot; title=&quot;Hystrix&amp;#x4E2D;&amp;#x4F1A;&amp;#x89E6;&amp;#x53D1;&amp;#x964D;&amp;#x7EA7;&amp;#x7684;&amp;#x4E09;&amp;#x79CD;&amp;#x9014;&amp;#x5F84;:&quot;&gt;&lt;/a&gt;Hystrix&amp;#x4E2D;&amp;#x4F1A;&amp;#x89E6;&amp;#x53D1;&amp;#x964D;&amp;#x7EA7;&amp;#x7684;&amp;#x4E09;&amp;#x79CD;&amp;#x9014;&amp;#x5F84;:&lt;/h3&gt;&lt;p&gt;1.&lt;code&gt;&amp;#x7194;&amp;#x65AD;&lt;/code&gt;&amp;#x89E6;&amp;#x53D1;&amp;#x964D;&amp;#x7EA7;&lt;br&gt;2.&lt;code&gt;&amp;#x8BF7;&amp;#x6C42;&amp;#x8D85;&amp;#x65F6;&lt;/code&gt;&amp;#x89E6;&amp;#x53D1;&amp;#x964D;&amp;#x7EA7;&lt;br&gt;3.&lt;code&gt;&amp;#x8D44;&amp;#x6E90;&amp;#x9694;&amp;#x79BB;&lt;/code&gt;&amp;#x89E6;&amp;#x53D1;&amp;#x964D;&amp;#x7EA7;&lt;/p&gt;</summary>
    
    
    
    <category term="Framework-框架" scheme="http://example.com/categories/Framework-%E6%A1%86%E6%9E%B6/"/>
    
    
    <category term="hystrix" scheme="http://example.com/tags/hystrix/"/>
    
  </entry>
  
  <entry>
    <title>框架-[ribbon]-Ribbon原理与源码分析</title>
    <link href="http://example.com/2022/08/07/9G4.001.%E6%A1%86%E6%9E%B6-[ribbon]-Ribbon%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://example.com/2022/08/07/9G4.001.%E6%A1%86%E6%9E%B6-[ribbon]-Ribbon%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</id>
    <published>2022-08-06T16:00:00.000Z</published>
    <updated>2022-08-18T06:41:17.089Z</updated>
    
    <content type="html"><![CDATA[<h3 id="LoadBalanced&#x6CE8;&#x89E3;"><a href="#LoadBalanced&#x6CE8;&#x89E3;" class="headerlink" title="@LoadBalanced&#x6CE8;&#x89E3;"></a>@LoadBalanced&#x6CE8;&#x89E3;</h3><p>&#x4ECE;<code>@LoadBalanced</code>&#x6CE8;&#x89E3;&#x6E90;&#x7801;&#x7684;&#x6CE8;&#x91CA;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x8BE5;&#x6CE8;&#x89E3;&#x7528;&#x6765;&#x7ED9;RestTemplate&#x6807;&#x8BB0;&#xFF0C;&#x4EE5;&#x4F7F;&#x7528;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#xFF08;<code>LoadBalancerClient</code>&#xFF09;&#x6765;&#x914D;&#x7F6E;&#x5B83;&#x3002;</p><blockquote><p>Annotation to mark a RestTemplate bean to be configured to use a LoadBalancerClient</p></blockquote><span id="more"></span><p>&#x2013;&gt; <code>LoadBalancerClient</code> &#x63A5;&#x53E3;&#xFF0C;&#x7236;&#x63A5;&#x53E3; <code>ServiceInstanceChooser</code> &#xFF1A;&#x4E3B;&#x8981;&#x6709;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x7528;&#x6765;&#x6839;&#x636E;<code>serviceId</code>&#x6765;&#x83B7;&#x53D6; <code>ServiceInstance</code> &#xFF1A;<br><code>ServiceInstance choose(String serviceId)</code>;</p><p>&#x2013;&gt; &#x5B9E;&#x73B0;&#x7C7B;&#x662F; <code>RibbonLoadBalancerClient</code>  &#x8FD9;&#x4E2A;&#x7C7B;&#x662F;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x4E2A;&#x7C7B;&#xFF0C;&#x6700;&#x7EC8;&#x7684;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x7684;&#x8BF7;&#x6C42;&#x5904;&#x7406;&#xFF0C;&#x7531;&#x5B83;&#x6765;&#x6267;&#x884C;&#x3002;<br>&#x5728; <code>RibbonLoadBalancerClient</code> &#x7684;&#x6E90;&#x7801;&#x4E2D;&#xFF0C;&#x5176;&#x4E2D;choose()&#x65B9;&#x6CD5;&#x662F;&#x9009;&#x62E9;&#x5177;&#x4F53;&#x670D;&#x52A1;&#x5B9E;&#x4F8B;&#x7684;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x3002;<br>&#x8BE5;&#x65B9;&#x6CD5;&#x901A;&#x8FC7;<code>getServer()</code>&#x65B9;&#x6CD5;&#x53BB;&#x83B7;&#x53D6;&#x5B9E;&#x4F8B;&#xFF0C;&#x7ECF;&#x8FC7;&#x6E90;&#x7801;&#x8DDF;&#x8E2A;&#xFF0C;&#x6700;&#x7EC8;&#x4EA4;&#x7ED9;&#x4E86;<code>ILoadBalancer</code>&#x5B9E;&#x4F8B;&#x7C7B;&#x53BB;&#x9009;&#x62E9;&#x670D;&#x52A1;&#x5B9E;&#x4F8B;&#x3002;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> loadBalancer.chooseServer(<span class="string">&quot;default&quot;</span>); <span class="comment">// <span class="doctag">TODO:</span> better handling of key</span></span><br></pre></td></tr></table></figure><p>&#x2013;&gt; <code>loadBalancer.chooseServer</code> &#x4E2D;&#x7684; <code>loadBalancer</code> &#x662F; <code>ILoadBalancer</code> &#x63A5;&#x53E3;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#x5B9E;&#x4F8B;</p><p>&#x2013;&gt; <code>BaseLoadBalancer</code> &#x7C7B; &#x91CC;&#x6709;&#xFF1A;&#xFF0C;IClientConfig&#x3001;IRule&#x3001;IPing &#x3001; ServerList &#x3001; ServerListFilter &#x548C; ILoadBalancer</p><p>&#x5B83;&#x9ED8;&#x8BA4;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86;&#x4EE5;&#x4E0B;&#x914D;&#x7F6E;&#xFF1A;<br>IClientConfig ribbonClientConfig: DefaultClientConfigImpl&#x914D;&#x7F6E;<br>IRule ribbonRule: RoundRobinRule &#x8DEF;&#x7531;&#x7B56;&#x7565;<br>IPing ribbonPing: DummyPing<br>ServerList ribbonServerList: ConfigurationBasedServerList<br>ServerListFilter ribbonServerListFilter: ZonePreferenceServerListFilter<br>ILoadBalancer ribbonLoadBalancer: ZoneAwareLoadBalancer</p><p>IRule&#x6709;&#x5F88;&#x591A;&#x9ED8;&#x8BA4;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x8FD9;&#x4E9B;&#x5B9E;&#x73B0;&#x7C7B;&#x6839;&#x636E;&#x4E0D;&#x540C;&#x7684;&#x7B97;&#x6CD5;&#x548C;&#x903B;&#x8F91;&#x6765;&#x5904;&#x7406;&#x8D1F;&#x8F7D;&#x5747;<br>&#x8861;&#x3002;Ribbon&#x5B9E;&#x73B0;&#x7684;IRule&#x6709;&#x4E00;&#x4E0B;&#x3002;&#x5728;&#x5927;&#x591A;&#x6570;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8FD9;&#x4E9B;&#x9ED8;&#x8BA4;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#x662F;&#x53EF;&#x4EE5;&#x6EE1;<br>&#x8DB3;&#x9700;&#x6C42;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x7279;&#x6027;&#x7684;&#x9700;&#x6C42;&#xFF0C;&#x53EF;&#x4EE5;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;&#x3002;</p><p>Ribbon&#x7684;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF0C;&#x6709;7&#x4E2A;&#xFF1A;</p><ol><li>RoundRobinRule &#x8F6E;&#x8BE2;&#x9009;&#x62E9;server</li><li>RandomRule &#x968F;&#x673A;&#x9009;&#x62E9;&#x4E00;&#x4E2A;server</li><li>RetryRule &#x6839;&#x636E;&#x8F6E;&#x8BE2;&#x7684;&#x65B9;&#x5F0F;&#x91CD;&#x8BD5;</li><li>WeightedResponseTimeRule &#x6839;&#x636E;&#x54CD;&#x5E94;&#x65F6;&#x95F4;&#x53BB;&#x5206;&#x914D;&#x4E00;&#x4E2A;weight &#xFF0C;weight&#x8D8A;&#x4F4E;&#xFF0C;&#x88AB;&#x9009;&#x62E9;&#x7684;&#x53EF;&#x80FD;&#x6027;&#x5C31;&#x8D8A;&#x4F4E;</li><li>BestAvailableRule &#x9009;&#x62E9;&#x6700;&#x5C0F;&#x8BF7;&#x6C42;&#x6570;</li><li>AvailabilityFilteringRule</li><li>ZoneAvoidanceRule &#x6839;&#x636E;server&#x7684;zone&#x533A;&#x57DF;&#x548C;&#x53EF;&#x7528;&#x6027;&#x6765;&#x8F6E;&#x8BE2;&#x9009;&#x62E9;</li></ol><p>ServerList&#x7684;&#x5B9E;&#x73B0;&#x7C7B; &#x4E3A; DiscoveryEnabledNIWSServerList<br>&#x5728; <code>ribbon-eureka.jar</code> &#x7684;<br>com.netflix.niws.loadbalancer&#x4E0B;&#x3002;&#x5176;&#x4E2D;DiscoveryEnabledNIWSServerList&#x6709;getInitialListOfServers()&#x548C;getUpdatedListOfServers()&#x65B9;&#x6CD5;&#xFF0C;</p><p>EurekaClient&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#x4E3A;DiscoveryClient&#xFF0C;&#x5728;&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x5206;&#x6790;&#x4E86;&#x5B83;&#x5177;&#x6709;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x3001;&#x83B7;&#x53D6;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x5217;&#x8868;&#x7B49;&#x7684;&#x5168;&#x90E8;&#x529F;&#x80FD;&#x3002;<br>&#x7531;&#x6B64;&#x53EF;&#x89C1;&#xFF0C;<strong>&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x5668;&#x662F;&#x4ECE;EurekaClient&#x83B7;&#x53D6;&#x670D;&#x52A1;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x6839;&#x636E;IRule&#x53BB;&#x8DEF;&#x7531;&#xFF0C;&#x5E76;&#x4E14;&#x6839;&#x636E;IPing&#x53BB;&#x5224;&#x65AD;&#x670D;&#x52A1;&#x7684;&#x53EF;&#x7528;&#x6027;</strong>&#x3002;<br>&#x90A3;&#x4E48;&#x73B0;&#x5728;&#x8FD8;&#x6709;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x5668;&#x591A;&#x4E45;&#x4E00;&#x6B21;&#x53BB;&#x83B7;&#x53D6;&#x4E00;&#x6B21;&#x4ECE;Eureka Client&#x83B7;&#x53D6;&#x6CE8;&#x518C;&#x4FE1;&#x606F;&#x5462;&#x3002;<br>&#x5728;BaseLoadBalancer&#x7C7B;&#x4E0B;&#xFF0C;BaseLoadBalancer&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x8BE5;&#x6784;&#x9020;&#x51FD;&#x6570;&#x5F00;&#x542F;&#x4E86;&#x4E00;&#x4E2A;PingTask&#x4EFB;&#x52A1;</p><p>setupPingTask()&#x7684;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x903B;&#x8F91;&#xFF0C;&#x5B83;&#x5F00;&#x542F;&#x4E86;ShutdownEnabledTimer&#x6267;&#x884C;<br>PingTask&#x4EFB;&#x52A1;&#xFF0C;&#x5728;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;pingIntervalSeconds&#x4E3A;10&#xFF0C;&#x5373;&#x6BCF;10&#x79D2;&#x949F;&#xFF0C;&#x5411;EurekaClient&#x53D1;&#x9001;&#x4E00;&#x6B21;&#x201D;ping&#x201D;&#x3002;</p><p>&#x67E5;&#x770B;Pinger&#x7684;runPinger()&#x65B9;&#x6CD5;&#xFF0C;&#x6700;&#x7EC8;&#x6839;&#x636E; pingerStrategy.pingServers(ping,allServers)&#x6765;&#x83B7;&#x53D6;&#x670D;&#x52A1;&#x7684;&#x53EF;&#x7528;&#x6027;&#xFF0C;<br>&#x5982;&#x679C;&#x8BE5;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#xFF0C;&#x5982;&#x4E4B;&#x524D;&#x76F8;&#x540C;&#xFF0C;&#x5219;&#x4E0D;&#x53BB;&#x5411;EurekaClient&#x83B7;&#x53D6;&#x6CE8;&#x518C;&#x5217;&#x8868;&#xFF0C;<br>&#x5982;&#x679C;&#x4E0D;&#x540C;&#x5219;&#x901A;&#x77E5;ServerStatusChangeListener &#x6216;&#x8005;changeListeners &#x53D1;&#x751F;&#x4E86;&#x6539;&#x53D8;&#xFF0C;&#x8FDB;&#x884C;&#x66F4;&#x65B0;&#x6216;&#x8005;&#x91CD;&#x65B0;&#x62C9;&#x53D6;&#x3002;</p><p>&#x7531;&#x6B64;&#x53EF;&#x89C1;&#xFF0C;<strong>LoadBalancerClient &#x662F;&#x5728;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x5411;Eureka&#x83B7;&#x53D6;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x5217;&#x8868;&#xFF0C;&#x5E76;&#x4E14;&#x5411;&#x901A;&#x8FC7;10s&#x4E00;&#x6B21;&#x5411;EurekaClient&#x53D1;&#x9001;&#x201C;ping&#x201D;&#xFF0C;&#x6765;&#x5224;&#x65AD;&#x670D;&#x52A1;&#x7684;&#x53EF;&#x7528;&#x6027;&#xFF0C;&#x5982;&#x679C;&#x670D;&#x52A1;&#x7684;&#x53EF;&#x7528;&#x6027;&#x53D1;&#x751F;&#x4E86;&#x6539;&#x53D8;&#x6216;&#x8005;&#x670D;&#x52A1;&#x6570;&#x91CF;&#x548C;&#x4E4B;&#x524D;&#x7684;&#x4E0D;&#x4E00;&#x81F4;&#xFF0C;&#x5219;&#x66F4;&#x65B0;&#x6216;&#x8005;&#x91CD;&#x65B0;&#x62C9;&#x53D6;&#x3002;</strong></p><p><strong>LoadBalancerClient&#x6709;&#x4E86;&#x8FD9;&#x4E9B;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x5217;&#x8868;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x5177;&#x4F53;&#x7684;IRule&#x6765;&#x8FDB;&#x884C;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x3002;</strong></p><h3 id="RestTemplate&#x662F;&#x5982;&#x4F55;&#x548C;Ribbon&#x7ED3;&#x5408;&#x7684;"><a href="#RestTemplate&#x662F;&#x5982;&#x4F55;&#x548C;Ribbon&#x7ED3;&#x5408;&#x7684;" class="headerlink" title="RestTemplate&#x662F;&#x5982;&#x4F55;&#x548C;Ribbon&#x7ED3;&#x5408;&#x7684;?"></a>RestTemplate&#x662F;&#x5982;&#x4F55;&#x548C;Ribbon&#x7ED3;&#x5408;&#x7684;?</h3><p>&#x6700;&#x540E;&#xFF0C;&#x56DE;&#x7B54;&#x95EE;&#x9898;&#x7684;&#x672C;&#x8D28;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x5728;RestTemplate&#x52A0;&#x4E00;&#x4E2A;@LoadBalance&#x6CE8;&#x89E3;&#x5C31;&#x53EF;&#x4EE5;&#x5F00;&#x542F;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x5462;&#xFF1F;</p><p>&#x2013;&gt; <code>LoadBalancerAutoConfiguration</code> &#x7C7B;&#xFF0C;&#x5373; LoadBalancer &#x81EA;&#x52A8;&#x914D;&#x7F6E;&#x7C7B;<br>&#x5728;&#x8BE5;&#x7C7B;&#x4E2D;&#xFF0C;&#x9996;&#x5148;&#x7EF4;&#x62A4;&#x4E86;&#x4E00;&#x4E2A;&#x88AB;<code>@LoadBalanced</code>&#x4FEE;&#x9970;&#x7684;RestTemplate&#x5BF9;&#x8C61;&#x7684;List&#xFF0C;<br>&#x5728;&#x521D;&#x59CB;&#x5316;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x901A;&#x8FC7;&#x8C03;&#x7528;<code>customizer.customize(restTemplate)</code>&#x65B9;&#x6CD5;&#x6765;&#x7ED9;RestTemplate&#x589E;&#x52A0;&#x62E6;&#x622A;&#x5668; <code>LoadBalancerInterceptor</code> &#x3002;<br>&#x800C; <code>LoadBalancerInterceptor</code> &#xFF0C;&#x7528;&#x4E8E;&#x5B9E;&#x65F6;&#x62E6;&#x622A;&#xFF0C;&#x5728; <code>LoadBalancerInterceptor</code> &#x8FD9;&#x91CC;&#x5B9E;&#x73B0;&#x6765;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x3002;</p><p>&#x603B;&#x7ED3;<br>&#x7EFC;&#x4E0A;&#x6240;&#x8FF0;&#xFF0C;Ribbon&#x7684;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF0C;&#x4E3B;&#x8981;&#x901A;&#x8FC7;</p><ol><li><p>LoadBalancerClient &#x6765;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x800C; LoadBalancerClient &#x5177;&#x4F53;&#x4EA4;&#x7ED9;&#x4E86;ILoadBalancer &#x6765;&#x5904;&#x7406;</p></li><li><p>ILoadBalancer&#x901A;&#x8FC7;&#x914D;&#x7F6E;IRule&#x3001;IPing&#x7B49;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x5411;EurekaClient&#x83B7;&#x53D6;&#x6CE8;&#x518C;&#x5217;&#x8868;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x9ED8;&#x8BA4;10&#x79D2;&#x4E00;&#x6B21;&#x5411;EurekaClient&#x53D1;&#x9001;&#x201C;ping&#x201D;,<br>&#x8FDB;&#x800C;&#x68C0;&#x67E5;&#x662F;&#x5426;&#x66F4;&#x65B0;&#x670D;&#x52A1;&#x5217;&#x8868;&#xFF0C;&#x6700;&#x540E;&#xFF0C;&#x5F97;&#x5230;&#x6CE8;&#x518C;&#x5217;&#x8868;&#x540E;&#xFF0C;ILoadBalancer&#x6839;&#x636E;IRule&#x7684;&#x7B56;&#x7565;&#x8FDB;&#x884C;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x3002;</p></li><li><p>&#x800C; RestTemplate &#x88AB; @LoadBalance &#x6CE8;&#x89E3;&#x540E;&#xFF0C;&#x80FD;&#x5B9E;&#x73B0;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x7EF4;&#x62A4;&#x4E86;&#x4E00;&#x4E2A;&#x88AB; @LoadBalance &#x6CE8;&#x89E3;&#x7684; RestTemplate&#x5217;&#x8868;&#xFF0C;&#x5E76;&#x7ED9;&#x5217;&#x8868;&#x4E2D;&#x7684;RestTemplate&#x6DFB;&#x52A0;&#x62E6;&#x622A;&#x5668;&#xFF0C;&#x8FDB;&#x800C;&#x4EA4;&#x7ED9;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x5668;&#x53BB;&#x5904;&#x7406;&#x3002;</p></li></ol>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;LoadBalanced&amp;#x6CE8;&amp;#x89E3;&quot;&gt;&lt;a href=&quot;#LoadBalanced&amp;#x6CE8;&amp;#x89E3;&quot; class=&quot;headerlink&quot; title=&quot;@LoadBalanced&amp;#x6CE8;&amp;#x89E3;&quot;&gt;&lt;/a&gt;@LoadBalanced&amp;#x6CE8;&amp;#x89E3;&lt;/h3&gt;&lt;p&gt;&amp;#x4ECE;&lt;code&gt;@LoadBalanced&lt;/code&gt;&amp;#x6CE8;&amp;#x89E3;&amp;#x6E90;&amp;#x7801;&amp;#x7684;&amp;#x6CE8;&amp;#x91CA;&amp;#x4E2D;&amp;#xFF0C;&amp;#x6211;&amp;#x4EEC;&amp;#x53EF;&amp;#x4EE5;&amp;#x77E5;&amp;#x9053;&amp;#x8BE5;&amp;#x6CE8;&amp;#x89E3;&amp;#x7528;&amp;#x6765;&amp;#x7ED9;RestTemplate&amp;#x6807;&amp;#x8BB0;&amp;#xFF0C;&amp;#x4EE5;&amp;#x4F7F;&amp;#x7528;&amp;#x8D1F;&amp;#x8F7D;&amp;#x5747;&amp;#x8861;&amp;#x7684;&amp;#x5BA2;&amp;#x6237;&amp;#x7AEF;&amp;#xFF08;&lt;code&gt;LoadBalancerClient&lt;/code&gt;&amp;#xFF09;&amp;#x6765;&amp;#x914D;&amp;#x7F6E;&amp;#x5B83;&amp;#x3002;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Annotation to mark a RestTemplate bean to be configured to use a LoadBalancerClient&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Framework-框架" scheme="http://example.com/categories/Framework-%E6%A1%86%E6%9E%B6/"/>
    
    
    <category term="ribbon" scheme="http://example.com/tags/ribbon/"/>
    
  </entry>
  
  <entry>
    <title>系统设计-限流算法与实现</title>
    <link href="http://example.com/2022/07/15/11B007.%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1-%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95%E4%B8%8E%E5%AE%9E%E7%8E%B0/"/>
    <id>http://example.com/2022/07/15/11B007.%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1-%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95%E4%B8%8E%E5%AE%9E%E7%8E%B0/</id>
    <published>2022-07-14T16:00:00.000Z</published>
    <updated>2023-09-20T09:05:42.364Z</updated>
    
    <content type="html"><![CDATA[<blockquote></blockquote><p><a href="https://blog.csdn.net/y277an/article/details/97074272">https://blog.csdn.net/y277an/article/details/97074272</a><br><a href="https://blog.csdn.net/hustspy1990/article/details/77978329">https://blog.csdn.net/hustspy1990/article/details/77978329</a><br>RxJava&#x8F85;&#x52A9;&#xFF1A;<br><a href="https://www.jianshu.com/p/5e93c9101dc5">https://www.jianshu.com/p/5e93c9101dc5</a><br><a href="https://www.jianshu.com/p/240f1c8ebf9d">https://www.jianshu.com/p/240f1c8ebf9d</a></p><h3 id="&#x4E00;&#x4E9B;&#x5F00;&#x6E90;&#x6846;&#x67B6;&#x9650;&#x6D41;&#x7684;&#x505A;&#x6CD5;&#xFF1A;"><a href="#&#x4E00;&#x4E9B;&#x5F00;&#x6E90;&#x6846;&#x67B6;&#x9650;&#x6D41;&#x7684;&#x505A;&#x6CD5;&#xFF1A;" class="headerlink" title="&#x4E00;&#x4E9B;&#x5F00;&#x6E90;&#x6846;&#x67B6;&#x9650;&#x6D41;&#x7684;&#x505A;&#x6CD5;&#xFF1A;"></a>&#x4E00;&#x4E9B;&#x5F00;&#x6E90;&#x6846;&#x67B6;&#x9650;&#x6D41;&#x7684;&#x505A;&#x6CD5;&#xFF1A;</h3><blockquote><ol><li>&#x963F;&#x91CC;&#x5F00;&#x6E90;&#x7684;<code>Sentinel</code>&#xFF0C;&#x91C7;&#x7528;&#x7684;&#x662F;<code>&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;</code>&#x8FDB;&#x884C;&#x9650;&#x6D41;&#xFF1B;</li><li><code>Guava RateLimiter</code>&#xFF0C;&#x91C7;&#x7528;&#x7684;&#x662F;<code>&#x4EE4;&#x724C;&#x6876;&#x7B97;&#x6CD5;</code>&#xFF1B;</li><li><code>Nginx</code>&#x4E2D;&#x7684;&#x9650;&#x6D41;&#x6A21;&#x5757;&#xFF08; <code>ngx_http_limit_req_module</code> &#x6A21;&#x5757;&#xFF09;&#xFF0C;&#x91C7;&#x7528;&#x7684;&#x662F;<code>&#x6F0F;&#x6876;&#x7B97;&#x6CD5;</code>&#xFF1B;</li><li><code>Hystrix</code>&#x4E2D;&#x7684;&#x9650;&#x6D41;&#x7B56;&#x7565;&#xFF0C;&#x91C7;&#x7528;&#x7684;<code>&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;</code>&#xFF0C;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x662F;&#x4F7F;&#x7528;RxJava API&#xFF0C;&#x62BD;&#x8C61;&#x6A21;&#x62DF;&#x5B9E;&#x73B0;&#xFF1B;</li></ol></blockquote><p>&#x9650;&#x6D41;&#x662F;&#x9650;&#x5236;&#x7CFB;&#x7EDF;&#x7684;&#x8F93;&#x5165;&#x548C;&#x8F93;&#x51FA;&#x6D41;&#x91CF;&#xFF0C;&#x4EE5;&#x8FBE;&#x5230;&#x4FDD;&#x62A4;&#x7CFB;&#x7EDF;&#x7684;&#x76EE;&#x7684;&#xFF0C;&#x800C;&#x9650;&#x6D41;&#x7684;&#x5B9E;&#x73B0;&#x4E3B;&#x8981;&#x662F;&#x4F9D;&#x9760;&#x9650;&#x6D41;&#x7B97;&#x6CD5;&#xFF0C;&#x9650;&#x6D41;&#x7B97;&#x6CD5;&#x4E3B;&#x8981;&#x6709;4&#x79CD;&#xFF1A;</p><span id="more"></span><ul><li><strong>&#x56FA;&#x5B9A;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;&#xFF08;&#x8BA1;&#x6570;&#x5668;&#xFF09;</strong></li><li><strong>&#x6ED1;&#x52A8;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;</strong></li><li><strong>&#x4EE4;&#x724C;&#x6876;&#x7B97;&#x6CD5;</strong></li><li><strong>&#x6F0F;&#x6876;&#x7B97;&#x6CD5;</strong></li></ul><h3 id="1-&#x56FA;&#x5B9A;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;"><a href="#1-&#x56FA;&#x5B9A;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;" class="headerlink" title="1. &#x56FA;&#x5B9A;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;"></a>1. &#x56FA;&#x5B9A;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;</h3><p>&#x53C8;&#x79F0;&#x8BA1;&#x6570;&#x5668;&#x7B97;&#x6CD5;&#x3002;&#x56FA;&#x5B9A;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;&#x5C31;&#x662F;&#x7EDF;&#x8BA1;&#x8BB0;&#x5F55;&#x5355;&#x4F4D;&#x65F6;&#x95F4;&#x5185;&#x8FDB;&#x5165;&#x7CFB;&#x7EDF;&#x6216;&#x8005;&#x67D0;&#x4E00;&#x63A5;&#x53E3;&#x7684;&#x8BF7;&#x6C42;&#x6B21;&#x6570;&#xFF0C;&#x5728;&#x9650;&#x5B9A;&#x7684;&#x6B21;&#x6570;&#x5185;&#x7684;&#x8BF7;&#x6C42;&#x5219;&#x6B63;&#x5E38;&#x63A5;&#x6536;&#x5904;&#x7406;&#xFF0C;&#x8D85;&#x8FC7;&#x6B21;&#x6570;&#x7684;&#x8BF7;&#x6C42;&#x5219;&#x62D2;&#x7EDD;&#x6389;&#x6216;&#x8005;&#x6539;&#x4E3A;&#x5F02;&#x6B65;&#x5904;&#x7406;&#x7B49;&#x9650;&#x6D41;&#x63AA;&#x65BD;&#x3002;</p><p>&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x957F;&#x5EA6;&#x5982;&#x679C;&#x4E3A;1&#x5206;&#x949F;&#xFF0C;&#x5982;&#x56FE;&#x3002;</p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/11B007.%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1-%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95%E4%B8%8E%E5%AE%9E%E7%8E%B0/1.png"></p><p>&#x6B64;&#x7B97;&#x6CD5;&#x5728;&#x5355;&#x673A;&#x8FD8;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x73AF;&#x5883;&#x4E0B;&#x5B9E;&#x73B0;&#x90FD;&#x975E;&#x5E38;&#x7B80;&#x5355;&#xFF0C;&#x4F7F;&#x7528;redis&#x7684;incr&#x539F;&#x5B50;&#x81EA;&#x589E;&#x6027;&#x5373;&#x53EF;&#x8F7B;&#x677E;&#x5B9E;&#x73B0;&#x3002;</p><h4 id="&#x5355;&#x673A;&#x4F2A;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#x3002;"><a href="#&#x5355;&#x673A;&#x4F2A;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#x3002;" class="headerlink" title="&#x5355;&#x673A;&#x4F2A;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#x3002;"></a>&#x5355;&#x673A;&#x4F2A;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#x3002;</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Counter</span> {</span><br><span class="line">    <span class="keyword">public</span>       <span class="type">long</span> <span class="variable">timeStamp</span> <span class="operator">=</span> getNowTime();</span><br><span class="line">    <span class="keyword">public</span>       <span class="type">int</span>  <span class="variable">reqCount</span>  <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span>  <span class="variable">limit</span>     <span class="operator">=</span> <span class="number">100</span>; <span class="comment">// &#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x5185;&#x6700;&#x5927;&#x8BF7;&#x6C42;&#x6570;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">interval</span>  <span class="operator">=</span> <span class="number">1000</span>; <span class="comment">// &#x65F6;&#x95F4;&#x7A97;&#x53E3;ms</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">grant</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> getNowTime();</span><br><span class="line">        <span class="keyword">if</span> (now &lt; timeStamp + interval) {</span><br><span class="line">            <span class="comment">// &#x5728;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x5185;</span></span><br><span class="line">            reqCount++;</span><br><span class="line">            <span class="comment">// &#x5224;&#x65AD;&#x5F53;&#x524D;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x5185;&#x662F;&#x5426;&#x8D85;&#x8FC7;&#x6700;&#x5927;&#x8BF7;&#x6C42;&#x63A7;&#x5236;&#x6570;</span></span><br><span class="line">            <span class="keyword">return</span> reqCount &lt;= limit;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            timeStamp = now;</span><br><span class="line">            <span class="comment">// &#x8D85;&#x65F6;&#x540E;&#x91CD;&#x7F6E;</span></span><br><span class="line">            reqCount = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h4 id="&#x7B97;&#x6CD5;&#x7279;&#x70B9;"><a href="#&#x7B97;&#x6CD5;&#x7279;&#x70B9;" class="headerlink" title="&#x7B97;&#x6CD5;&#x7279;&#x70B9;"></a>&#x7B97;&#x6CD5;&#x7279;&#x70B9;</h4><ul><li><p>&#x5B9E;&#x73B0;&#x7B80;&#x5355;&#x3002;</p></li><li><p>&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x56FA;&#x5B9A;&#xFF0C;&#x6BCF;&#x4E2A;&#x7A97;&#x53E3;&#x5F00;&#x59CB;&#x65F6;&#x8BA1;&#x6570;&#x4E3A;&#x96F6;&#xFF0C;&#x8FD9;&#x6837;&#x540E;&#x9762;&#x7684;&#x8BF7;&#x6C42;&#x4E0D;&#x4F1A;&#x53D7;&#x5230;&#x4E4B;&#x524D;&#x7684;&#x5F71;&#x54CD;&#xFF0C;&#x505A;&#x5230;&#x4E86;&#x524D;&#x540E;&#x8BF7;&#x6C42;&#x9694;&#x79BB;&#x3002;</p></li><li><p>&#x56E0;&#x4E3A;&#x4E24;&#x4E2A;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x4E4B;&#x95F4;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x8054;&#x7CFB;&#xFF0C;&#x6240;&#x4EE5;&#x8C03;&#x7528;&#x8005;&#x53EF;&#x4EE5;&#x5728;&#x4E00;&#x4E2A;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7684;&#x7ED3;&#x675F;&#x5230;&#x4E0B;&#x4E00;&#x4E2A;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7684;&#x5F00;&#x59CB;&#x8FD9;&#x4E2A;&#x975E;&#x5E38;&#x77ED;&#x7684;&#x65F6;&#x95F4;&#x6BB5;&#x5185;&#x53D1;&#x8D77;&#x4E24;&#x500D;&#x4E8E;&#x9608;&#x503C;&#x7684;&#x8BF7;&#x6C42;&#x3002;&#x6240;&#x4EE5;&#x56FA;&#x5B9A;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;&#x65E0;&#x6CD5;&#x9650;&#x5236;&#x7A97;&#x53E3;&#x95F4;&#x7A81;&#x53D1;&#x6D41;&#x91CF;&#x3002;</p></li></ul><h3 id="2-&#x6ED1;&#x52A8;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;"><a href="#2-&#x6ED1;&#x52A8;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;" class="headerlink" title="2. &#x6ED1;&#x52A8;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;"></a>2. &#x6ED1;&#x52A8;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;</h3><p>&#x6ED1;&#x52A8;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;&#x5176;&#x5B9E;&#x662F;&#x56FA;&#x5B9A;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;&#x7684;&#x4F18;&#x5316;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x56FA;&#x5B9A;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;&#x65E0;&#x6CD5;&#x9650;&#x5236;&#x7A97;&#x53E3;&#x95F4;&#x7A81;&#x53D1;&#x6D41;&#x91CF;&#x7684;&#x7F3A;&#x70B9;&#x3002;<br>&#x4E0A;&#x9762;&#x7684;&#x8BA1;&#x6570;&#x5668;&#x7684;&#x5355;&#x4F4D;&#x65F6;&#x95F4;&#x662F;1&#x5206;&#x949F;&#xFF0C;&#x800C;&#x5728;&#x4F7F;&#x7528;&#x6ED1;&#x52A8;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#xFF0C;&#x53EF;&#x4EE5;&#x628A;1&#x5206;&#x949F;&#x5206;&#x6210;6&#x683C;&#xFF0C;&#x6BCF;&#x683C;&#x65F6;&#x95F4;&#x957F;&#x5EA6;&#x662F;10s&#xFF0C;&#x6BCF;&#x4E00;&#x683C;&#x53C8;&#x5404;&#x81EA;&#x7BA1;&#x7406;&#x4E00;&#x4E2A;&#x8BA1;&#x6570;&#x5668;&#xFF0C;&#x5355;&#x4F4D;&#x65F6;&#x95F4;&#x7528;&#x4E00;&#x4E2A;&#x957F;&#x5EA6;&#x4E3A;60s&#x7684;&#x7A97;&#x53E3;&#x63CF;&#x8FF0;&#x3002;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x8FDB;&#x5165;&#x7CFB;&#x7EDF;&#xFF0C;&#x5BF9;&#x5E94;&#x7684;&#x65F6;&#x95F4;&#x683C;&#x5B50;&#x7684;&#x8BA1;&#x6570;&#x5668;&#x4FBF;&#x4F1A;+1&#xFF0C;&#x800C;&#x6BCF;&#x8FC7;10s&#xFF0C;&#x8FD9;&#x4E2A;&#x7A97;&#x53E3;&#x4FBF;&#x4F1A;&#x5411;&#x53F3;&#x6ED1;&#x52A8;&#x4E00;&#x683C;&#x3002;&#x53EA;&#x8981;&#x7A97;&#x53E3;&#x5305;&#x62EC;&#x7684;&#x6240;&#x6709;&#x683C;&#x5B50;&#x7684;&#x8BA1;&#x6570;&#x5668;&#x603B;&#x548C;&#x8D85;&#x8FC7;&#x9650;&#x6D41;&#x4E0A;&#x9650;&#xFF0C;&#x4FBF;&#x4F1A;&#x6267;&#x884C;&#x9650;&#x6D41;&#x63AA;&#x65BD;&#x3002;</p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/11B007.%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1-%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95%E4%B8%8E%E5%AE%9E%E7%8E%B0/2.jpg"></p><p>&#x7531;&#x6B64;&#x53EF;&#x89C1;&#xFF0C;&#x5F53;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x7684;&#x683C;&#x5B50;&#x5212;&#x5206;&#x7684;&#x8D8A;&#x591A;&#xFF0C;&#x90A3;&#x4E48;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x7684;&#x6EDA;&#x52A8;&#x5C31;&#x8D8A;&#x5E73;&#x6ED1;&#xFF0C;&#x9650;&#x6D41;&#x7684;&#x7EDF;&#x8BA1;&#x5C31;&#x4F1A;&#x8D8A;&#x7CBE;&#x786E;&#x3002;</p><h4 id="&#x7B97;&#x6CD5;&#x7279;&#x70B9;-1"><a href="#&#x7B97;&#x6CD5;&#x7279;&#x70B9;-1" class="headerlink" title="&#x7B97;&#x6CD5;&#x7279;&#x70B9;"></a>&#x7B97;&#x6CD5;&#x7279;&#x70B9;</h4><p>&#x56E0;&#x4E3A;&#x7A97;&#x53E3;&#x987A;&#x5EF6;&#xFF0C;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x62B5;&#x5FA1;&#x7A97;&#x53E3;&#x95F4;&#x7A81;&#x53D1;&#x6D41;&#x91CF;(&#x5BF9;&#x6BD4;&#x56FA;&#x5B9A;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;)&#x3002;</p><p>&#x5047;&#x5982;&#x9650;&#x6D41;10&#x4E07;&#x6B21;/&#x5C0F;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x67D0;&#x4E2A;&#x8C03;&#x7528;&#x8005;&#x5728;&#x524D;10&#x5206;&#x949F;&#x8C03;&#x7528;&#x4E86;10&#x4E07;&#x6B21;&#x90A3;&#x4E48;&#x4ED6;&#x5FC5;&#x987B;&#x518D;&#x7B49;&#x5F85;1&#x5C0F;&#x65F6;&#x624D;&#x80FD;&#x53D1;&#x8D77;&#x4E0B;&#x4E00;&#x6B21;&#x6B63;&#x5E38;&#x8BF7;&#x6C42;&#x3002;&#x6240;&#x4EE5;&#x6CA1;&#x6709;&#x505A;&#x5230;&#x524D;&#x540E;&#x8BF7;&#x6C42;&#x9694;&#x79BB;&#x3002;</p><blockquote><p>&#x963F;&#x91CC;&#x5F00;&#x6E90;&#x7684;Sentinel&#xFF0C;&#x91C7;&#x7528;&#x7684;&#x662F;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x7B97;&#x6CD5;&#x8FDB;&#x884C;&#x9650;&#x6D41;</p></blockquote><h3 id="3-&#x6F0F;&#x6876;&#x7B97;&#x6CD5;-leaky-bucket"><a href="#3-&#x6F0F;&#x6876;&#x7B97;&#x6CD5;-leaky-bucket" class="headerlink" title="3. &#x6F0F;&#x6876;&#x7B97;&#x6CD5;(leaky bucket)"></a>3. &#x6F0F;&#x6876;&#x7B97;&#x6CD5;(leaky bucket)</h3><p>&#x6F0F;&#x6876;&#x7B97;&#x6CD5;&#x5176;&#x5B9E;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x53EF;&#x4EE5;&#x7C97;&#x7565;&#x7684;&#x8BA4;&#x4E3A;&#x5C31;&#x662F;&#x6CE8;&#x6C34;&#x6F0F;&#x6C34;&#x8FC7;&#x7A0B;&#xFF0C; ==&#x5F80;&#x6876;&#x4E2D;&#x4EE5;&#x4E00;&#x5B9A;&#x901F;&#x7387;&#x6D41;&#x51FA;&#x6C34;&#xFF0C;&#x4EE5;&#x4EFB;&#x610F;&#x901F;&#x7387;&#x6D41;&#x5165;&#x6C34;==&#xFF0C;&#x5F53;&#x6C34;&#x8D85;&#x8FC7;&#x6876;&#x6D41;&#x91CF;&#x5219;&#x4E22;&#x5F03;&#xFF0C;&#x56E0;&#x4E3A;&#x6876;&#x5BB9;&#x91CF;&#x662F;&#x4E0D;&#x53D8;&#x7684;&#xFF0C;&#x4FDD;&#x8BC1;&#x4E86;&#x6574;&#x4F53;&#x7684;&#x901F;&#x7387;&#x3002;&#x8FD9;&#x4E2A;==&#x4ECE;&#x6876;&#x5E95;&#x6D41;&#x51FA;&#x53BB;&#x7684;&#x6C34;&#x5C31;&#x662F;&#x7CFB;&#x7EDF;&#x6B63;&#x5E38;&#x5904;&#x7406;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x4ECE;&#x65C1;&#x8FB9;&#x6D41;&#x51FA;&#x53BB;&#x7684;&#x6C34;&#x5C31;&#x662F;&#x7CFB;&#x7EDF;&#x62D2;&#x7EDD;&#x6389;&#x7684;&#x8BF7;&#x6C42;==&#x3002;</p><h4 id="&#x5355;&#x673A;&#x4F2A;&#x4EE3;&#x7801;&#x5982;&#x4E0B;"><a href="#&#x5355;&#x673A;&#x4F2A;&#x4EE3;&#x7801;&#x5982;&#x4E0B;" class="headerlink" title="&#x5355;&#x673A;&#x4F2A;&#x4EE3;&#x7801;&#x5982;&#x4E0B;"></a>&#x5355;&#x673A;&#x4F2A;&#x4EE3;&#x7801;&#x5982;&#x4E0B;</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Leaky</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="variable">timeStamp</span> <span class="operator">=</span> getNowTime();</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> capacity; <span class="comment">// &#x6876;&#x7684;&#x5BB9;&#x91CF;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> rate; <span class="comment">// &#x6C34;&#x6F0F;&#x51FA;&#x7684;&#x901F;&#x5EA6;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> water; <span class="comment">// &#x5F53;&#x524D;&#x6C34;&#x91CF;(&#x5F53;&#x524D;&#x7D2F;&#x79EF;&#x8BF7;&#x6C42;&#x6570;)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">grant</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> getNowTime();</span><br><span class="line">        water = max(<span class="number">0</span>, water - (now - timeStamp) * rate); <span class="comment">// &#x5148;&#x6267;&#x884C;&#x6F0F;&#x6C34;&#xFF0C;&#x8BA1;&#x7B97;&#x5269;&#x4F59;&#x6C34;&#x91CF;</span></span><br><span class="line">        timeStamp = now;</span><br><span class="line">        <span class="keyword">if</span> ((water + <span class="number">1</span>) &lt; capacity) {</span><br><span class="line">            <span class="comment">// &#x5C1D;&#x8BD5;&#x52A0;&#x6C34;,&#x5E76;&#x4E14;&#x6C34;&#x8FD8;&#x672A;&#x6EE1;</span></span><br><span class="line">            water += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// &#x6C34;&#x6EE1;&#xFF0C;&#x62D2;&#x7EDD;&#x52A0;&#x6C34;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h4 id="&#x7B97;&#x6CD5;&#x7279;&#x70B9;-2"><a href="#&#x7B97;&#x6CD5;&#x7279;&#x70B9;-2" class="headerlink" title="&#x7B97;&#x6CD5;&#x7279;&#x70B9;"></a>&#x7B97;&#x6CD5;&#x7279;&#x70B9;</h4><p>&#x56E0;&#x4E3A;&#x6D41;&#x51FA;&#x7684;&#x901F;&#x5EA6;&#x662F;&#x4E00;&#x5B9A;&#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x62B5;&#x5FA1;&#x7A81;&#x53D1;&#x6D41;&#x91CF;&#xFF0C;&#x505A;&#x5230;&#x66F4;&#x52A0;&#x5E73;&#x6ED1;&#x7684;&#x9650;&#x6D41;&#xFF0C;&#x800C;&#x4E14;&#x4E0D;&#x5141;&#x8BB8;&#x6D41;&#x91CF;&#x7A81;&#x53D1;&#x3002;</p><h3 id="4-&#x4EE4;&#x724C;&#x6876;&#x7B97;&#x6CD5;-Token-Bucket"><a href="#4-&#x4EE4;&#x724C;&#x6876;&#x7B97;&#x6CD5;-Token-Bucket" class="headerlink" title="4. &#x4EE4;&#x724C;&#x6876;&#x7B97;&#x6CD5;(Token Bucket)"></a>4. &#x4EE4;&#x724C;&#x6876;&#x7B97;&#x6CD5;(Token Bucket)</h3><p>&#x4EE4;&#x724C;&#x6876;&#x7B97;&#x6CD5;&#x662F;&#x6BD4;&#x8F83;&#x5E38;&#x89C1;&#x7684;&#x9650;&#x6D41;&#x7B97;&#x6CD5;&#x4E4B;&#x4E00;&#xFF0C;Google&#x5F00;&#x6E90;&#x9879;&#x76EE;Guava&#x4E2D;&#x7684;RateLimiter&#x4F7F;&#x7528;&#x7684;&#x5C31;&#x662F;&#x4EE4;&#x724C;&#x6876;&#x7B97;&#x6CD5;&#x3002;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#xFF1A;</p><ol><li>&#x6240;&#x6709;&#x7684;&#x8BF7;&#x6C42;&#x5728;&#x5904;&#x7406;&#x4E4B;&#x524D;&#x90FD;&#x9700;&#x8981;&#x62FF;&#x5230;&#x4E00;&#x4E2A;&#x53EF;&#x7528;&#x7684;&#x4EE4;&#x724C;&#x624D;&#x4F1A;&#x88AB;&#x5904;&#x7406;&#x3002;</li><li>&#x6839;&#x636E;&#x9650;&#x6D41;&#x5927;&#x5C0F;&#xFF0C;&#x8BBE;&#x7F6E;&#x6309;&#x7167;&#x4E00;&#x5B9A;&#x7684;&#x901F;&#x7387;&#x5F80;&#x6876;&#x91CC;&#x6DFB;&#x52A0;&#x4EE4;&#x724C;&#x3002;</li><li>&#x6876;&#x8BBE;&#x7F6E;&#x6700;&#x5927;&#x7684;&#x653E;&#x7F6E;&#x4EE4;&#x724C;&#x9650;&#x5236;&#xFF0C;&#x5F53;&#x6876;&#x6EE1;&#x65F6;&#x3001;&#x65B0;&#x6DFB;&#x52A0;&#x7684;&#x4EE4;&#x724C;&#x5C31;&#x88AB;&#x4E22;&#x5F03;&#x6216;&#x8005;&#x62D2;&#x7EDD;&#x3002;</li><li>&#x8BF7;&#x6C42;&#x5230;&#x8FBE;&#x540E;&#x9996;&#x5148;&#x8981;&#x83B7;&#x53D6;&#x4EE4;&#x724C;&#x6876;&#x4E2D;&#x7684;&#x4EE4;&#x724C;&#xFF0C;&#x62FF;&#x7740;&#x4EE4;&#x724C;&#x624D;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x5176;&#x4ED6;&#x7684;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#xFF0C;&#x5904;&#x7406;&#x5B8C;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x4E4B;&#x540E;&#xFF0C;&#x5C06;&#x4EE4;&#x724C;&#x76F4;&#x63A5;&#x5220;&#x9664;&#x3002;</li></ol><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/11B007.%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1-%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95%E4%B8%8E%E5%AE%9E%E7%8E%B0/3.jpg"></p><p>&#x5355;&#x673A;&#x4F2A;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF0C;&#x5206;&#x5E03;&#x5F0F;&#x73AF;&#x5883;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;Redisson&#x3002;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TokenBucket</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="variable">timeStamp</span> <span class="operator">=</span> getNowTime();</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> capacity; <span class="comment">// &#x6876;&#x7684;&#x5BB9;&#x91CF;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> rate; <span class="comment">// &#x4EE4;&#x724C;&#x653E;&#x5165;&#x901F;&#x5EA6;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> tokens; <span class="comment">// &#x5F53;&#x524D;&#x4EE4;&#x724C;&#x6570;&#x91CF;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">grant</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> getNowTime();</span><br><span class="line">        <span class="comment">// &#x5148;&#x6DFB;&#x52A0;&#x4EE4;&#x724C;</span></span><br><span class="line">        tokens = min(capacity, tokens + (now - timeStamp) * rate);</span><br><span class="line">        timeStamp = now;</span><br><span class="line">        <span class="keyword">if</span> (tokens &lt; <span class="number">1</span>) {</span><br><span class="line">            <span class="comment">// &#x82E5;&#x6876;&#x4E2D;&#x6CA1;&#x6709;&#x4EE4;&#x724C;,&#x5219;&#x62D2;&#x7EDD;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// &#x8FD8;&#x6709;&#x4EE4;&#x724C;&#xFF0C;&#x9886;&#x53D6;&#x4EE4;&#x724C;</span></span><br><span class="line">            tokens -= <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h4 id="&#x7B97;&#x6CD5;&#x7279;&#x70B9;-3"><a href="#&#x7B97;&#x6CD5;&#x7279;&#x70B9;-3" class="headerlink" title="&#x7B97;&#x6CD5;&#x7279;&#x70B9;"></a>&#x7B97;&#x6CD5;&#x7279;&#x70B9;</h4><ol><li>&#x53EF;&#x4EE5;&#x62B5;&#x5FA1;&#x7A81;&#x53D1;&#x6D41;&#x91CF;&#xFF0C;&#x56E0;&#x4E3A;&#x6876;&#x5185;&#x7684;&#x4EE4;&#x724C;&#x6570;&#x4E0D;&#x4F1A;&#x8D85;&#x8FC7;&#x7ED9;&#x5B9A;&#x7684;&#x6700;&#x5927;&#x503C;</li><li>&#x53EF;&#x4EE5;&#x505A;&#x5230;&#x66F4;&#x52A0;&#x5E73;&#x6ED1;&#x7684;&#x9650;&#x6D41;&#xFF0C;&#x56E0;&#x4E3A;&#x4EE4;&#x724C;&#x662F;&#x5300;&#x901F;&#x653E;&#x5165;&#x7684;&#x3002;</li><li>&#x4EE4;&#x724C;&#x6876;&#x7B97;&#x6CD5;&#x5141;&#x8BB8;&#x6D41;&#x91CF;&#x4E00;&#x5B9A;&#x7A0B;&#x5EA6;&#x7684;&#x7A81;&#x53D1;&#x3002;&#xFF08;&#x76F8;&#x6BD4;&#x6F0F;&#x6876;&#x7B97;&#x6CD5;&#xFF09;</li></ol><p>&#x5728;&#x65F6;&#x95F4;&#x70B9;&#x5237;&#x65B0;&#x7684;&#x4E34;&#x754C;&#x70B9;&#x4E0A;&#xFF0C;&#x53EA;&#x8981;&#x5269;&#x4F59;token&#x8DB3;&#x591F;&#xFF0C;&#x4EE4;&#x724C;&#x6876;&#x7B97;&#x6CD5;&#x4F1A;&#x5141;&#x8BB8;&#x5BF9;&#x5E94;&#x6570;&#x91CF;&#x7684;&#x8BF7;&#x6C42;&#x901A;&#x8FC7;&#xFF0C;&#x800C;&#x540E;&#x5237;&#x65B0;&#x65F6;&#x95F4;&#x56E0;&#x4E3A;token&#x4E0D;&#x8DB3;&#xFF0C;&#x6D41;&#x91CF;&#x4E5F;&#x4F1A;&#x88AB;&#x9650;&#x5236;&#x5728;&#x5916;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x6BD4;&#x8F83;&#x597D;&#x7684;&#x63A7;&#x5236;&#x4E86;&#x77AC;&#x65F6;&#x6D41;&#x91CF;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x4EE4;&#x724C;&#x6876;&#x7B97;&#x6CD5;&#x4E5F;&#x88AB;&#x5E7F;&#x6CDB;&#x4F7F;&#x7528;&#x3002;</p><hr><blockquote><p><a href="https://blog.csdn.net/hustspy1990/article/details/77978329">https://blog.csdn.net/hustspy1990/article/details/77978329</a></p></blockquote><h3 id="Hystrix-&#x6ED1;&#x52A8;&#x7A97;&#x53E3;"><a href="#Hystrix-&#x6ED1;&#x52A8;&#x7A97;&#x53E3;" class="headerlink" title="Hystrix &#x6ED1;&#x52A8;&#x7A97;&#x53E3;"></a>Hystrix &#x6ED1;&#x52A8;&#x7A97;&#x53E3;</h3><p><code>Hystrix</code> &#x7194;&#x65AD;&#x903B;&#x8F91;&#x5224;&#x65AD;&#x91CC;&#xFF0C;&#x4F7F;&#x7528;&#x4E86;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x6765;&#x7EDF;&#x8BA1;&#x670D;&#x52A1;&#x8C03;&#x7528;&#x7684;&#x6210;&#x529F;&#x3001;&#x5931;&#x8D25;&#x91CF;&#x3002;<br>&#x5728; hystrix &#x91CC;&#xFF0C;&#x5927;&#x91CF;&#x4F7F;&#x7528;&#x4E86; RxJava &#x8FD9;&#x4E2A;&#x54CD;&#x5E94;&#x5F0F;&#x51FD;&#x6570;&#x7F16;&#x7A0B;&#x6846;&#x67B6;&#xFF0C;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x7684;&#x5B9E;&#x73B0;&#x4E5F;&#x662F;&#x4F7F;&#x7528;&#x4E86; RxJava &#x6846;&#x67B6;&#x3002;</p><h3 id="&#x6E90;&#x7801;&#x5206;&#x6790;"><a href="#&#x6E90;&#x7801;&#x5206;&#x6790;" class="headerlink" title="&#x6E90;&#x7801;&#x5206;&#x6790;"></a>&#x6E90;&#x7801;&#x5206;&#x6790;</h3><p>&#x6B64;&#x5904;&#x7565;</p><h3 id="&#x6A21;&#x62DF;Hystrix&#xFF0C;&#x624B;&#x5199;&#x4E00;&#x4E2A;&#x7B80;&#x6613;&#x7248;&#x672C;&#x7684;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x7EDF;&#x8BA1;"><a href="#&#x6A21;&#x62DF;Hystrix&#xFF0C;&#x624B;&#x5199;&#x4E00;&#x4E2A;&#x7B80;&#x6613;&#x7248;&#x672C;&#x7684;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x7EDF;&#x8BA1;" class="headerlink" title="&#x6A21;&#x62DF;Hystrix&#xFF0C;&#x624B;&#x5199;&#x4E00;&#x4E2A;&#x7B80;&#x6613;&#x7248;&#x672C;&#x7684;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x7EDF;&#x8BA1;"></a>&#x6A21;&#x62DF;Hystrix&#xFF0C;&#x624B;&#x5199;&#x4E00;&#x4E2A;&#x7B80;&#x6613;&#x7248;&#x672C;&#x7684;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x7EDF;&#x8BA1;</h3><p>&#x56FE;&#x89E3;&#xFF1A;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/11B007.%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1-%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95%E4%B8%8E%E5%AE%9E%E7%8E%B0/4.jpg"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RollingWindowTest</span> {</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Func2&lt;Integer, Integer, Integer&gt; INTEGER_SUM =</span><br><span class="line">(integer, integer2) -&gt; integer + integer2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Func1&lt;Observable&lt;Integer&gt;, Observable&lt;Integer&gt;&gt; WINDOW_SUM =  </span><br><span class="line">window -&gt; window.scan(<span class="number">0</span>, INTEGER_SUM).skip(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Func1&lt;Observable&lt;Integer&gt;, Observable&lt;Integer&gt;&gt; INNER_BUCKET_SUM =</span><br><span class="line">        integerObservable -&gt; integerObservable.reduce(<span class="number">0</span>, INTEGER_SUM);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">PublishSubject&lt;Integer&gt; publishSubject = PublishSubject.create();</span><br><span class="line">SerializedSubject&lt;Integer, Integer&gt; serializedSubject = publishSubject.toSerialized();</span><br><span class="line">serializedSubject</span><br><span class="line">.window(<span class="number">5</span>, TimeUnit.SECONDS)  <span class="comment">// 5&#x79D2;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;bucket</span></span><br><span class="line">.flatMap(INNER_BUCKET_SUM) <span class="comment">// &#x4E00;&#x4E2A;bucket&#x5185;&#x6570;&#x636E;&#x6C42;&#x548C;</span></span><br><span class="line">.window(<span class="number">3</span>, <span class="number">1</span>)     <span class="comment">// 3&#x4E2A;bucket&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x7A97;&#x53E3;&#xFF0C;&#x6ED1;&#x52A8;&#x6B65;&#x6570;&#x4E3A;1</span></span><br><span class="line">.flatMap(WINDOW_SUM)  <span class="comment">// &#x7A97;&#x53E3;&#x6570;&#x636E;&#x6C42;&#x548C;</span></span><br><span class="line">.subscribe(integer -&gt; <span class="comment">// &#x8F93;&#x51FA;&#x7EDF;&#x8BA1;&#x6570;&#x636E;&#x5230;&#x65E5;&#x5FD7;</span></span><br><span class="line">System.out.println(String.format(<span class="string">&quot;[%s] call ..... %s&quot;</span>, Thread.currentThread().getName(), integer)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// &#x7F13;&#x6162;&#x53D1;&#x9001;&#x6570;&#x636E;&#xFF0C;&#x89C2;&#x5BDF;&#x6548;&#x679C;</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; ++i) {</span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">30</span>) {</span><br><span class="line">                serializedSubject.onNext(<span class="number">1</span>);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                serializedSubject.onNext(<span class="number">2</span>);</span><br><span class="line">            }</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>&#x8F93;&#x51FA;&#xFF1A;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[RxComputationScheduler-1] call ..... 15</span><br><span class="line">[RxComputationScheduler-1] call ..... 15</span><br><span class="line">[RxComputationScheduler-1] call ..... 15</span><br><span class="line">[RxComputationScheduler-1] call ..... 15</span><br><span class="line">[RxComputationScheduler-1] call ..... 20</span><br><span class="line">[RxComputationScheduler-1] call ..... 25</span><br><span class="line">[RxComputationScheduler-1] call ..... 30</span><br><span class="line">[RxComputationScheduler-1] call ..... 30</span><br><span class="line">[RxComputationScheduler-1] call ..... 30</span><br><span class="line">[RxComputationScheduler-1] call ..... 30</span><br><span class="line">[RxComputationScheduler-1] call ..... 30</span><br><span class="line">[RxComputationScheduler-1] call ..... 30</span><br><span class="line">[RxComputationScheduler-1] call ..... 30</span><br><span class="line">[RxComputationScheduler-1] call ..... 30</span><br><span class="line">[RxComputationScheduler-1] call ..... 30</span><br><span class="line">[RxComputationScheduler-1] call ..... 30</span><br><span class="line">[RxComputationScheduler-1] call ..... 30</span><br><span class="line">[RxComputationScheduler-1] call ..... 30</span><br></pre></td></tr></table></figure><h3 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h3><p>&#x4E00;&#x4E2A;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x7EDF;&#x8BA1;&#x4E3B;&#x8981;&#x5206;&#x4E3A;&#x4E24;&#x6B65;&#xFF1A;</p><ol><li>bucket &#x7EDF;&#x8BA1;&#xFF0C;bucket &#x7684;&#x5927;&#x5C0F;&#x51B3;&#x5B9A;&#x4E86;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x6EDA;&#x52A8;&#x65F6;&#x95F4;&#x95F4;&#x9694;&#xFF1B;</li><li>window &#x7EDF;&#x8BA1;&#xFF0C;window &#x7684;&#x65F6;&#x957F;&#x51B3;&#x5B9A;&#x4E86;&#x5305;&#x542B;&#x7684; bucket &#x7684;&#x6570;&#x76EE;&#x3002;</li></ol><p>Hystrix &#x5B9E;&#x73B0;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x5229;&#x7528;&#x4E86; RxJava &#x8FD9;&#x4E2A;&#x54CD;&#x5E94;&#x5F0F;&#x51FD;&#x6570;&#x7F16;&#x7A0B;&#x6846;&#x67B6;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x5176;&#x4E2D;&#x7684;&#x51E0;&#x4E2A;&#x51FD;&#x6570;&#xFF1A;</p><ol><li>window&#xFF1A;&#x6839;&#x636E;&#x6307;&#x5B9A;&#x65F6;&#x95F4;&#x6216;&#x6307;&#x5B9A;&#x6570;&#x91CF;&#x5BF9;&#x6570;&#x636E;&#x6D41;&#x8FDB;&#x884C;&#x805A;&#x96C6;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E; 1 &#x5BF9; N &#x7684;&#x8F6C;&#x6362;&#xFF1B;</li><li>flatMap&#xFF1A;&#x5C06;&#x8F93;&#x5165;&#x6570;&#x636E;&#x6D41;&#xFF0C;&#x8F6C;&#x6362;&#x6210;&#x53E6;&#x4E00;&#x79CD;&#x683C;&#x5F0F;&#x7684;&#x6570;&#x636E;&#x6D41;&#xFF0C;&#x5728;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x7EDF;&#x8BA1;&#x4E2D;&#x8D77;&#x5230;&#x4E86;&#x6570;&#x636E;&#x6C42;&#x548C;&#x7684;&#x529F;&#x80FD;&#xFF08;&#x5F53;&#x7136;&#x5176;&#x529F;&#x80FD;&#x5E76;&#x4E0D;&#x9650;&#x4E8E;&#x6C42;&#x548C;&#xFF09;&#x3002;</li></ol><p>Hystrix &#x6700;&#x6838;&#x5FC3;&#x7684;&#x57FA;&#x7840;&#x7EC4;&#x4EF6;&#xFF0C;&#x5F53;&#x5C5E;&#x63D0;&#x4F9B;&#x89C2;&#x5BDF;&#x8005;&#x6A21;&#x5F0F;&#xFF08;&#x53D1;&#x5E03;-&#x8BA2;&#x9605;&#x6A21;&#x5F0F;&#xFF09;&#x7684; RxJava&#x3002;</p><hr><h3 id="&#x5176;&#x4ED6;&#x51E0;&#x4E2A;&#x9650;&#x6D41;&#x5B9E;&#x73B0;&#x65B9;&#x6848;"><a href="#&#x5176;&#x4ED6;&#x51E0;&#x4E2A;&#x9650;&#x6D41;&#x5B9E;&#x73B0;&#x65B9;&#x6848;" class="headerlink" title="&#x5176;&#x4ED6;&#x51E0;&#x4E2A;&#x9650;&#x6D41;&#x5B9E;&#x73B0;&#x65B9;&#x6848;"></a>&#x5176;&#x4ED6;&#x51E0;&#x4E2A;&#x9650;&#x6D41;&#x5B9E;&#x73B0;&#x65B9;&#x6848;</h3><blockquote><p>Redis + Lua &#x5206;&#x5E03;&#x5F0F; &#x9AD8;&#x5E76;&#x53D1;&#x9650;&#x6D41;: <a href="https://zhuanlan.zhihu.com/p/376651621">https://zhuanlan.zhihu.com/p/376651621</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.csdn.net/y277an/article/details/97074272&quot;&gt;https://blog.csdn.net/y277an/article/details/97074272&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://blog.csdn.net/hustspy1990/article/details/77978329&quot;&gt;https://blog.csdn.net/hustspy1990/article/details/77978329&lt;/a&gt;&lt;br&gt;RxJava&amp;#x8F85;&amp;#x52A9;&amp;#xFF1A;&lt;br&gt;&lt;a href=&quot;https://www.jianshu.com/p/5e93c9101dc5&quot;&gt;https://www.jianshu.com/p/5e93c9101dc5&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://www.jianshu.com/p/240f1c8ebf9d&quot;&gt;https://www.jianshu.com/p/240f1c8ebf9d&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;&amp;#x4E00;&amp;#x4E9B;&amp;#x5F00;&amp;#x6E90;&amp;#x6846;&amp;#x67B6;&amp;#x9650;&amp;#x6D41;&amp;#x7684;&amp;#x505A;&amp;#x6CD5;&amp;#xFF1A;&quot;&gt;&lt;a href=&quot;#&amp;#x4E00;&amp;#x4E9B;&amp;#x5F00;&amp;#x6E90;&amp;#x6846;&amp;#x67B6;&amp;#x9650;&amp;#x6D41;&amp;#x7684;&amp;#x505A;&amp;#x6CD5;&amp;#xFF1A;&quot; class=&quot;headerlink&quot; title=&quot;&amp;#x4E00;&amp;#x4E9B;&amp;#x5F00;&amp;#x6E90;&amp;#x6846;&amp;#x67B6;&amp;#x9650;&amp;#x6D41;&amp;#x7684;&amp;#x505A;&amp;#x6CD5;&amp;#xFF1A;&quot;&gt;&lt;/a&gt;&amp;#x4E00;&amp;#x4E9B;&amp;#x5F00;&amp;#x6E90;&amp;#x6846;&amp;#x67B6;&amp;#x9650;&amp;#x6D41;&amp;#x7684;&amp;#x505A;&amp;#x6CD5;&amp;#xFF1A;&lt;/h3&gt;&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;&amp;#x963F;&amp;#x91CC;&amp;#x5F00;&amp;#x6E90;&amp;#x7684;&lt;code&gt;Sentinel&lt;/code&gt;&amp;#xFF0C;&amp;#x91C7;&amp;#x7528;&amp;#x7684;&amp;#x662F;&lt;code&gt;&amp;#x6ED1;&amp;#x52A8;&amp;#x7A97;&amp;#x53E3;&amp;#x7B97;&amp;#x6CD5;&lt;/code&gt;&amp;#x8FDB;&amp;#x884C;&amp;#x9650;&amp;#x6D41;&amp;#xFF1B;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Guava RateLimiter&lt;/code&gt;&amp;#xFF0C;&amp;#x91C7;&amp;#x7528;&amp;#x7684;&amp;#x662F;&lt;code&gt;&amp;#x4EE4;&amp;#x724C;&amp;#x6876;&amp;#x7B97;&amp;#x6CD5;&lt;/code&gt;&amp;#xFF1B;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Nginx&lt;/code&gt;&amp;#x4E2D;&amp;#x7684;&amp;#x9650;&amp;#x6D41;&amp;#x6A21;&amp;#x5757;&amp;#xFF08; &lt;code&gt;ngx_http_limit_req_module&lt;/code&gt; &amp;#x6A21;&amp;#x5757;&amp;#xFF09;&amp;#xFF0C;&amp;#x91C7;&amp;#x7528;&amp;#x7684;&amp;#x662F;&lt;code&gt;&amp;#x6F0F;&amp;#x6876;&amp;#x7B97;&amp;#x6CD5;&lt;/code&gt;&amp;#xFF1B;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Hystrix&lt;/code&gt;&amp;#x4E2D;&amp;#x7684;&amp;#x9650;&amp;#x6D41;&amp;#x7B56;&amp;#x7565;&amp;#xFF0C;&amp;#x91C7;&amp;#x7528;&amp;#x7684;&lt;code&gt;&amp;#x6ED1;&amp;#x52A8;&amp;#x7A97;&amp;#x53E3;&amp;#x7B97;&amp;#x6CD5;&lt;/code&gt;&amp;#xFF0C;&amp;#x5177;&amp;#x4F53;&amp;#x5B9E;&amp;#x73B0;&amp;#x662F;&amp;#x4F7F;&amp;#x7528;RxJava API&amp;#xFF0C;&amp;#x62BD;&amp;#x8C61;&amp;#x6A21;&amp;#x62DF;&amp;#x5B9E;&amp;#x73B0;&amp;#xFF1B;&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;&amp;#x9650;&amp;#x6D41;&amp;#x662F;&amp;#x9650;&amp;#x5236;&amp;#x7CFB;&amp;#x7EDF;&amp;#x7684;&amp;#x8F93;&amp;#x5165;&amp;#x548C;&amp;#x8F93;&amp;#x51FA;&amp;#x6D41;&amp;#x91CF;&amp;#xFF0C;&amp;#x4EE5;&amp;#x8FBE;&amp;#x5230;&amp;#x4FDD;&amp;#x62A4;&amp;#x7CFB;&amp;#x7EDF;&amp;#x7684;&amp;#x76EE;&amp;#x7684;&amp;#xFF0C;&amp;#x800C;&amp;#x9650;&amp;#x6D41;&amp;#x7684;&amp;#x5B9E;&amp;#x73B0;&amp;#x4E3B;&amp;#x8981;&amp;#x662F;&amp;#x4F9D;&amp;#x9760;&amp;#x9650;&amp;#x6D41;&amp;#x7B97;&amp;#x6CD5;&amp;#xFF0C;&amp;#x9650;&amp;#x6D41;&amp;#x7B97;&amp;#x6CD5;&amp;#x4E3B;&amp;#x8981;&amp;#x6709;4&amp;#x79CD;&amp;#xFF1A;&lt;/p&gt;</summary>
    
    
    
    <category term="系统设计" scheme="http://example.com/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
    
    
    <category term="限流" scheme="http://example.com/tags/%E9%99%90%E6%B5%81/"/>
    
  </entry>
  
  <entry>
    <title>框架-[rxJava]-熟悉概念和操作符</title>
    <link href="http://example.com/2022/07/14/9H.001.%E6%A1%86%E6%9E%B6-[rxJava]-%E7%86%9F%E6%82%89%E6%A6%82%E5%BF%B5%E5%92%8C%E6%93%8D%E4%BD%9C%E7%AC%A6/"/>
    <id>http://example.com/2022/07/14/9H.001.%E6%A1%86%E6%9E%B6-[rxJava]-%E7%86%9F%E6%82%89%E6%A6%82%E5%BF%B5%E5%92%8C%E6%93%8D%E4%BD%9C%E7%AC%A6/</id>
    <published>2022-07-13T16:00:00.000Z</published>
    <updated>2022-07-15T03:45:10.101Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://www.jianshu.com/p/5e93c9101dc5">https://www.jianshu.com/p/5e93c9101dc5</a><br><a href="https://www.jianshu.com/p/240f1c8ebf9d">https://www.jianshu.com/p/240f1c8ebf9d</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://www.jianshu.com/p/5e93c9101dc5&quot;&gt;https://www.jianshu.com/p/5e93c9101dc5&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://www.jianshu.</summary>
      
    
    
    
    <category term="Framework-框架" scheme="http://example.com/categories/Framework-%E6%A1%86%E6%9E%B6/"/>
    
    
    <category term="rxJava" scheme="http://example.com/tags/rxJava/"/>
    
  </entry>
  
  <entry>
    <title>笔记-开发常用笔记</title>
    <link href="http://example.com/2022/07/13/15.003%20%E7%AC%94%E8%AE%B0-%E5%B8%B8%E7%94%A8%E4%B8%89%E6%96%B9%E5%B7%A5%E5%85%B7%E7%B1%BB%E7%94%A8%E6%B3%95%E8%AE%B0%E5%BD%95/"/>
    <id>http://example.com/2022/07/13/15.003%20%E7%AC%94%E8%AE%B0-%E5%B8%B8%E7%94%A8%E4%B8%89%E6%96%B9%E5%B7%A5%E5%85%B7%E7%B1%BB%E7%94%A8%E6%B3%95%E8%AE%B0%E5%BD%95/</id>
    <published>2022-07-12T16:00:00.000Z</published>
    <updated>2023-09-20T09:05:42.408Z</updated>
    
    <content type="html"><![CDATA[<p>&#x5F00;&#x53D1;&#x5E38;&#x7528;&#x7B14;&#x8BB0;&#x7EC6;&#x8282;</p><span id="more"></span><h3 id="1-&#x4F7F;&#x7528;httpclient&#x9759;&#x6001;&#x7C7B;&#xFF0C;&#x5199;&#x51FA;http&#x4E2D;&#x7684;&#x6240;&#x6709;content-type"><a href="#1-&#x4F7F;&#x7528;httpclient&#x9759;&#x6001;&#x7C7B;&#xFF0C;&#x5199;&#x51FA;http&#x4E2D;&#x7684;&#x6240;&#x6709;content-type" class="headerlink" title="1. &#x4F7F;&#x7528;httpclient&#x9759;&#x6001;&#x7C7B;&#xFF0C;&#x5199;&#x51FA;http&#x4E2D;&#x7684;&#x6240;&#x6709;content type:"></a>1. &#x4F7F;&#x7528;httpclient&#x9759;&#x6001;&#x7C7B;&#xFF0C;&#x5199;&#x51FA;http&#x4E2D;&#x7684;&#x6240;&#x6709;content type:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.apache.http.entity.ContentType&#x4E2D;,          ContentType.APPLICATION_JSON</span><br><span class="line">org.apache.http.protocol.HTTP.CONTENT_TYPE     Content-Type</span><br></pre></td></tr></table></figure><h3 id="2-&#x4F7F;&#x7528;httpclient&#x9759;&#x6001;&#x7C7B;&#xFF0C;&#x6307;&#x5B9A;response&#x7684;http-code&#xFF1A;"><a href="#2-&#x4F7F;&#x7528;httpclient&#x9759;&#x6001;&#x7C7B;&#xFF0C;&#x6307;&#x5B9A;response&#x7684;http-code&#xFF1A;" class="headerlink" title="2. &#x4F7F;&#x7528;httpclient&#x9759;&#x6001;&#x7C7B;&#xFF0C;&#x6307;&#x5B9A;response&#x7684;http code&#xFF1A;"></a>2. &#x4F7F;&#x7528;httpclient&#x9759;&#x6001;&#x7C7B;&#xFF0C;&#x6307;&#x5B9A;response&#x7684;http code&#xFF1A;</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">org.apache.http.HttpStatus&#xFF0C;&#x6BD4;&#x5982; HttpStatus.SC_UNAUTHORIZED</span><br><span class="line">&#x6216;&#x8005;&#x4F7F;&#x7528;&#x539F;&#x751F;servlet</span><br><span class="line">javax.servlet.http.HttpServletResponse.SC_OK</span><br></pre></td></tr></table></figure><h3 id="3-&#x4E0A;&#x9762;&#x4F7F;&#x7528;httpclient&#x5DE5;&#x5177;&#x7C7B;&#xFF0C;&#x6216;&#x8005;&#xFF0C;&#x4F7F;&#x7528;spring&#x81EA;&#x5E26;&#x7684;&#x4E24;&#x4E2A;&#x7C7B;"><a href="#3-&#x4E0A;&#x9762;&#x4F7F;&#x7528;httpclient&#x5DE5;&#x5177;&#x7C7B;&#xFF0C;&#x6216;&#x8005;&#xFF0C;&#x4F7F;&#x7528;spring&#x81EA;&#x5E26;&#x7684;&#x4E24;&#x4E2A;&#x7C7B;" class="headerlink" title="3. &#x4E0A;&#x9762;&#x4F7F;&#x7528;httpclient&#x5DE5;&#x5177;&#x7C7B;&#xFF0C;&#x6216;&#x8005;&#xFF0C;&#x4F7F;&#x7528;spring&#x81EA;&#x5E26;&#x7684;&#x4E24;&#x4E2A;&#x7C7B;"></a>3. &#x4E0A;&#x9762;&#x4F7F;&#x7528;httpclient&#x5DE5;&#x5177;&#x7C7B;&#xFF0C;&#x6216;&#x8005;&#xFF0C;&#x4F7F;&#x7528;spring&#x81EA;&#x5E26;&#x7684;&#x4E24;&#x4E2A;&#x7C7B;</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">application/json     org.springframework.http.MediaType.APPLICATION_JSON_VALUE</span><br><span class="line"><span class="number">200</span>                  org.springframework.http.HttpStatus.OK.value()</span><br></pre></td></tr></table></figure><p>&#x8FD8;&#x6709;&#x51E0;&#x4E2A;&#x5E38;&#x91CF;&#xFF1A;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">UTF_8</span> <span class="operator">=</span> org.apache.http.protocol.HTTP.UTF_8      </span><br><span class="line">java.nio.charset.<span class="type">Charset</span> <span class="variable">UTF_8</span> <span class="operator">=</span> java.nio.charset.Charset.forName(org.apache.http.protocol.HTTP.UTF_8)</span><br><span class="line">java.nio.charset.<span class="type">Charset</span> <span class="variable">UTF_8</span> <span class="operator">=</span> java.nio.charset.StandardCharsets.UTF_8</span><br></pre></td></tr></table></figure><h3 id="4-&#x4F7F;&#x7528;guava"><a href="#4-&#x4F7F;&#x7528;guava" class="headerlink" title="4. &#x4F7F;&#x7528;guava"></a>4. &#x4F7F;&#x7528;guava</h3><h4 id="&#x521B;&#x5EFA;list"><a href="#&#x521B;&#x5EFA;list" class="headerlink" title="&#x521B;&#x5EFA;list:"></a>&#x521B;&#x5EFA;list:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">List&lt;Integer&gt; list = com.google.common.collect.Lists.newArrayList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">List&lt;Integer&gt; emptyList = com.google.common.collect.Lists.newArrayList();</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">List&lt;String&gt; keyList = com.google.common.collect.Lists.newArrayListWithCapacity(paramMap.keySet().size());</span><br></pre></td></tr></table></figure><h4 id="&#x521B;&#x5EFA;map"><a href="#&#x521B;&#x5EFA;map" class="headerlink" title="&#x521B;&#x5EFA;map"></a>&#x521B;&#x5EFA;map</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">Map&lt;String, String&gt; parameterMap = Maps.newHashMap();</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">Map&lt;String, String&gt; concurrentHashMap = Maps.newConcurrentHashMap();</span><br></pre></td></tr></table></figure><h4 id="&#x4F7F;&#x7528;java-util-Collections&#x521B;&#x5EFA;map"><a href="#&#x4F7F;&#x7528;java-util-Collections&#x521B;&#x5EFA;map" class="headerlink" title="&#x4F7F;&#x7528;java.util.Collections&#x521B;&#x5EFA;map"></a>&#x4F7F;&#x7528;java.util.Collections&#x521B;&#x5EFA;map</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; paramsMap  = java.util.Collections.emptyMap();</span><br></pre></td></tr></table></figure><h4 id="&#x521B;&#x5EFA;Set"><a href="#&#x521B;&#x5EFA;Set" class="headerlink" title="&#x521B;&#x5EFA;Set"></a>&#x521B;&#x5EFA;Set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&#x521B;&#x5EFA;&#x7A7A;HashSet</span></span><br><span class="line">Set&lt;XXX&gt; set = Sets.newHashSet();</span><br><span class="line"><span class="comment">//&#x521B;&#x5EFA;HashSet&#x65F6;&#xFF0C;&#x653E;&#x7F6E;&#x5143;&#x7D20;</span></span><br><span class="line">Set&lt;String&gt; set = Sets.newHashSet(<span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>, <span class="string">&quot;cc&quot;</span>);</span><br><span class="line"><span class="comment">//&#x521B;&#x5EFA;&#x5E76;&#x53D1;set</span></span><br><span class="line">com.google.common.collect.Sets.newConcurrentHashSet();</span><br></pre></td></tr></table></figure><h4 id="&#x521B;&#x5EFA;&#x4E0D;&#x53EF;&#x53D8;&#x96C6;&#x5408;"><a href="#&#x521B;&#x5EFA;&#x4E0D;&#x53EF;&#x53D8;&#x96C6;&#x5408;" class="headerlink" title="&#x521B;&#x5EFA;&#x4E0D;&#x53EF;&#x53D8;&#x96C6;&#x5408;"></a>&#x521B;&#x5EFA;&#x4E0D;&#x53EF;&#x53D8;&#x96C6;&#x5408;</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">List&lt;String&gt; strs = ImmutableList.&lt;String&gt;of(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line"><span class="comment">//&#x6216;</span></span><br><span class="line">List&lt;String&gt; list = ImmutableList.of(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line"><span class="comment">//&#x521B;&#x5EFA;ImmutableMap&#x5199;&#x6CD5;1</span></span><br><span class="line">Map&lt;Integer, String&gt; map = ImmutableMap.&lt;Integer, String&gt;.of(<span class="number">11</span>, <span class="string">&quot;aa&quot;</span>);</span><br><span class="line"><span class="comment">//&#x521B;&#x5EFA;ImmutableMap&#x5199;&#x6CD5;2</span></span><br><span class="line">Map&lt;Integer, String&gt; map = ImmutableMap.&lt;Integer, String&gt;builder()</span><br><span class="line">  .put(<span class="number">1</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">  .put(<span class="number">2</span>, <span class="string">&quot;b&quot;</span>)</span><br><span class="line">  .put(<span class="number">3</span>, <span class="string">&quot;c&quot;</span>)</span><br><span class="line">  .build();</span><br><span class="line"><span class="comment">//&#x521B;&#x5EFA;ImmutableMap&#x5199;&#x6CD5;3</span></span><br><span class="line">Map&lt;Integer, String&gt; map = <span class="keyword">new</span> <span class="title class_">ImmutableMap</span>.Builder&lt;Integer, Integer&gt;()</span><br><span class="line">  .put(<span class="number">1</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">  .put(<span class="number">2</span>, <span class="string">&quot;b&quot;</span>)</span><br><span class="line">  .put(<span class="number">3</span>, <span class="string">&quot;c&quot;</span>)</span><br><span class="line">  .build();</span><br></pre></td></tr></table></figure><h3 id="5-&#x4F7F;&#x7528;apache-common-&#x4E2D;&#x7684;CollectionUtils&#x5224;&#x65AD;&#x96C6;&#x5408;&#x662F;&#x5426;&#x662F;&#x7A7A;&#xFF0C;&#x6BD4;&#x5982;&#x8FD9;&#x6837;&#xFF1A;"><a href="#5-&#x4F7F;&#x7528;apache-common-&#x4E2D;&#x7684;CollectionUtils&#x5224;&#x65AD;&#x96C6;&#x5408;&#x662F;&#x5426;&#x662F;&#x7A7A;&#xFF0C;&#x6BD4;&#x5982;&#x8FD9;&#x6837;&#xFF1A;" class="headerlink" title="5. &#x4F7F;&#x7528;apache common &#x4E2D;&#x7684;CollectionUtils&#x5224;&#x65AD;&#x96C6;&#x5408;&#x662F;&#x5426;&#x662F;&#x7A7A;&#xFF0C;&#x6BD4;&#x5982;&#x8FD9;&#x6837;&#xFF1A;"></a>5. &#x4F7F;&#x7528;apache common &#x4E2D;&#x7684;CollectionUtils&#x5224;&#x65AD;&#x96C6;&#x5408;&#x662F;&#x5426;&#x662F;&#x7A7A;&#xFF0C;&#x6BD4;&#x5982;&#x8FD9;&#x6837;&#xFF1A;</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CollectionUtils.isNotEmpty(keyList)</span><br></pre></td></tr></table></figure><h3 id="6-springframework&#x81EA;&#x5E26;&#x7684;&#x5DE5;&#x5177;&#x7C7B;&#xFF0C;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x6BD4;&#x5982;&#xFF1A;ObjectUtils&#x3001;ReflectionUtils&#x3001;BeanUtils&#x3001;StringUtils&#x3001;CollectionUtils"><a href="#6-springframework&#x81EA;&#x5E26;&#x7684;&#x5DE5;&#x5177;&#x7C7B;&#xFF0C;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x6BD4;&#x5982;&#xFF1A;ObjectUtils&#x3001;ReflectionUtils&#x3001;BeanUtils&#x3001;StringUtils&#x3001;CollectionUtils" class="headerlink" title="6. springframework&#x81EA;&#x5E26;&#x7684;&#x5DE5;&#x5177;&#x7C7B;&#xFF0C;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x6BD4;&#x5982;&#xFF1A;ObjectUtils&#x3001;ReflectionUtils&#x3001;BeanUtils&#x3001;StringUtils&#x3001;CollectionUtils"></a>6. springframework&#x81EA;&#x5E26;&#x7684;&#x5DE5;&#x5177;&#x7C7B;&#xFF0C;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x6BD4;&#x5982;&#xFF1A;<code>ObjectUtils</code>&#x3001;<code>ReflectionUtils</code>&#x3001;<code>BeanUtils</code>&#x3001;<code>StringUtils</code>&#x3001;<code>CollectionUtils</code></h3><p>(&#x4EE5;&#x540E;&#x770B;&#x5230;&#x65B0;&#x7684;&#x518D;&#x8BB0;&#x5F55;)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.util.ObjectUtils</span><br><span class="line">    <span class="title function_">containsElement</span><span class="params">(Object[] array, Object element)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">(Object[] array)</span></span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">org.springframework.util.ReflectionUtils</span><br><span class="line">    .makeAccessible(ctor)</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">org.springframework.beans.BeanUtils</span><br><span class="line">    .instantiateClass(initializerClass)</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">org.springframework.util.StringUtils</span><br><span class="line">    .trimWhitespace</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">org.springframework.util.StreamUtils</span><br><span class="line">    .copyToString</span><br><span class="line">&#x5982;&#xFF1A;</span><br><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> StreamUtils.copyToString(inputStream, java.nio.charset.Charset.forName(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">org.springframework.util.CollectionUtils</span><br><span class="line">    .isEmpty(Collection)</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">springframework&#x81EA;&#x5E26;&#x7684;&#x5E38;&#x91CF;&#x7C7B;&#xFF0C;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x6BD4;&#x5982;&#xFF1A;</span><br><span class="line">org.springframework.http.MediaType.APPLICATION_JSON_VALUE</span><br><span class="line">org.springframework.http.HttpStatus.OK.value()</span><br></pre></td></tr></table></figure><p><code>org.springframework.util</code> &#x5305;&#x4E0B;&#x7684;&#x5404;&#x79CD;Utils&#x5DE5;&#x5177;&#x7C7B;&#xFF1A;</p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/15.003%20%E7%AC%94%E8%AE%B0-%E5%B8%B8%E7%94%A8%E4%B8%89%E6%96%B9%E5%B7%A5%E5%85%B7%E7%B1%BB%E7%94%A8%E6%B3%95%E8%AE%B0%E5%BD%95/1.png"></p><h3 id="7-&#x5C06;&#x6587;&#x4EF6;&#x8F6C;&#x6362;&#x6210;byte"><a href="#7-&#x5C06;&#x6587;&#x4EF6;&#x8F6C;&#x6362;&#x6210;byte" class="headerlink" title="7. &#x5C06;&#x6587;&#x4EF6;&#x8F6C;&#x6362;&#x6210;byte[]"></a>7. &#x5C06;&#x6587;&#x4EF6;&#x8F6C;&#x6362;&#x6210;byte[]</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.commons.io.FileUtils.readFileToByteArray</span><br></pre></td></tr></table></figure><h3 id="8-apache-common&#x5305;&#x4E0B;&#x7684;&#x5E38;&#x91CF;"><a href="#8-apache-common&#x5305;&#x4E0B;&#x7684;&#x5E38;&#x91CF;" class="headerlink" title="8. apache common&#x5305;&#x4E0B;&#x7684;&#x5E38;&#x91CF;"></a>8. apache common&#x5305;&#x4E0B;&#x7684;&#x5E38;&#x91CF;</h3><p>&#x770B;&#x4E86;&#x4E0A;&#x9762;&#x51E0;&#x6761;&#xFF0C;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#xFF0C;apache common&#x5305;&#x4E0B;&#x7684;utils&#x4E5F;&#x662F;&#x5F88;&#x591A;&#xFF0C;&#x6BD4;&#x5982;&#xFF1A; <code>StringUtils</code> &#xFF0C; <code>IOUtils</code> &#xFF0C; <code>FileUtils</code> &#xFF0C; <code>CollectionUtils</code><br>&#x4E5F;&#x6709;&#x5F88;&#x591A;&#x9759;&#x6001;&#x5E38;&#x91CF;&#x7C7B;&#xFF0C;&#x6BD4;&#x5982;&#xFF1A;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">org.apache.http.entity.ContentType.APPLICATION_JSON</span><br><span class="line">org.apache.http.protocol.HTTP.CONTENT_TYPE</span><br><span class="line">org.apache.http.HttpStatus.SC_UNAUTHORIZED</span><br></pre></td></tr></table></figure><h3 id="9-&#x5728;&#x5199;service&#x4EE3;&#x7801;&#x65F6;&#xFF0C;&#x6709;&#x65F6;&#x5165;&#x53C2;&#x9700;&#x8981;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A;&#x7A7A;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;-org-springframework-util-Assert-&#x6BD4;&#x5982;&#xFF1A;"><a href="#9-&#x5728;&#x5199;service&#x4EE3;&#x7801;&#x65F6;&#xFF0C;&#x6709;&#x65F6;&#x5165;&#x53C2;&#x9700;&#x8981;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A;&#x7A7A;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;-org-springframework-util-Assert-&#x6BD4;&#x5982;&#xFF1A;" class="headerlink" title="9. &#x5728;&#x5199;service&#x4EE3;&#x7801;&#x65F6;&#xFF0C;&#x6709;&#x65F6;&#x5165;&#x53C2;&#x9700;&#x8981;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A;&#x7A7A;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; org.springframework.util.Assert;&#x6BD4;&#x5982;&#xFF1A;"></a>9. &#x5728;&#x5199;service&#x4EE3;&#x7801;&#x65F6;&#xFF0C;&#x6709;&#x65F6;&#x5165;&#x53C2;&#x9700;&#x8981;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A;&#x7A7A;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <code>org.springframework.util.Assert</code>;&#x6BD4;&#x5982;&#xFF1A;</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(value = TransactionConfigurer.CMC_TRANSACTION, propagation = Propagation.REQUIRED)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCellphone</span><span class="params">(<span class="meta">@NonNull</span> <span class="type">long</span> operatorId, <span class="meta">@NonNull</span> String cellphone)</span> {</span><br><span class="line">  Assert.notNull(operatorId, <span class="string">&quot; Operator Id should not be null&quot;</span>);</span><br><span class="line">  Assert.notNull(cellphone, <span class="string">&quot; cellphone should not be null&quot;</span>);</span><br><span class="line">  repo.updateCellphone(operatorId, cellphone);</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="10-org-apache-commons-lang3-StringUtils-&#x4E0B;&#x9762;&#x51E0;&#x4E2A;&#x5B9E;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#xFF1A;"><a href="#10-org-apache-commons-lang3-StringUtils-&#x4E0B;&#x9762;&#x51E0;&#x4E2A;&#x5B9E;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#xFF1A;" class="headerlink" title="10. org.apache.commons.lang3.StringUtils &#x4E0B;&#x9762;&#x51E0;&#x4E2A;&#x5B9E;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#xFF1A;"></a>10. <code>org.apache.commons.lang3.StringUtils</code> &#x4E0B;&#x9762;&#x51E0;&#x4E2A;&#x5B9E;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#xFF1A;</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">StringUtils.isAnyBlank(trusteeName_db, trusteeCard_db, trusteePhone_db, sugestAmount)</span><br><span class="line">StringUtils.equals(BraavosClient.SUCCESS_CODE, response.getCode())</span><br><span class="line">org.apache.commons.lang3.StringUtils.center(<span class="string">&quot;&#x89E3;&#x7801;&quot;</span>, <span class="number">60</span>, <span class="string">&quot;=&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="11-&#x68C0;&#x67E5;&#x679A;&#x4E3E;&#x662F;&#x5426;&#x5305;&#x542B;&#x7ED9;&#x5B9A;&#x7684;&#x5B57;&#x7B26;&#x4E32;"><a href="#11-&#x68C0;&#x67E5;&#x679A;&#x4E3E;&#x662F;&#x5426;&#x5305;&#x542B;&#x7ED9;&#x5B9A;&#x7684;&#x5B57;&#x7B26;&#x4E32;" class="headerlink" title="11. &#x68C0;&#x67E5;&#x679A;&#x4E3E;&#x662F;&#x5426;&#x5305;&#x542B;&#x7ED9;&#x5B9A;&#x7684;&#x5B57;&#x7B26;&#x4E32;"></a>11. &#x68C0;&#x67E5;&#x679A;&#x4E3E;&#x662F;&#x5426;&#x5305;&#x542B;&#x7ED9;&#x5B9A;&#x7684;&#x5B57;&#x7B26;&#x4E32;</h3><p>&#x6539;&#x7528;Apache commons lang3 lib</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EnumUtils.isValidEnum(MyEnum.class, myValue)</span><br></pre></td></tr></table></figure><h3 id="12-&#x5728;&#x4E00;&#x4E9B;&#x9700;&#x8981;&#x5728;URL&#x53C2;&#x6570;&#x663E;&#x793A;&#x7684;&#x53C2;&#x6570;&#x503C;&#xFF0C;&#x9700;&#x8981;&#x7528;&#x4EE5;&#x4E0B;&#x5DE5;&#x5177;&#x7C7B;&#x8FDB;&#x884C;&#x8F6C;&#x4E49;&#xFF0C;&#x5426;&#x5219;&#x4F1A;&#x51FA;&#x73B0;OSS&#x653B;&#x51FB;"><a href="#12-&#x5728;&#x4E00;&#x4E9B;&#x9700;&#x8981;&#x5728;URL&#x53C2;&#x6570;&#x663E;&#x793A;&#x7684;&#x53C2;&#x6570;&#x503C;&#xFF0C;&#x9700;&#x8981;&#x7528;&#x4EE5;&#x4E0B;&#x5DE5;&#x5177;&#x7C7B;&#x8FDB;&#x884C;&#x8F6C;&#x4E49;&#xFF0C;&#x5426;&#x5219;&#x4F1A;&#x51FA;&#x73B0;OSS&#x653B;&#x51FB;" class="headerlink" title="12. &#x5728;&#x4E00;&#x4E9B;&#x9700;&#x8981;&#x5728;URL&#x53C2;&#x6570;&#x663E;&#x793A;&#x7684;&#x53C2;&#x6570;&#x503C;&#xFF0C;&#x9700;&#x8981;&#x7528;&#x4EE5;&#x4E0B;&#x5DE5;&#x5177;&#x7C7B;&#x8FDB;&#x884C;&#x8F6C;&#x4E49;&#xFF0C;&#x5426;&#x5219;&#x4F1A;&#x51FA;&#x73B0;OSS&#x653B;&#x51FB;"></a>12. &#x5728;&#x4E00;&#x4E9B;&#x9700;&#x8981;&#x5728;URL&#x53C2;&#x6570;&#x663E;&#x793A;&#x7684;&#x53C2;&#x6570;&#x503C;&#xFF0C;&#x9700;&#x8981;&#x7528;&#x4EE5;&#x4E0B;&#x5DE5;&#x5177;&#x7C7B;&#x8FDB;&#x884C;&#x8F6C;&#x4E49;&#xFF0C;&#x5426;&#x5219;&#x4F1A;&#x51FA;&#x73B0;OSS&#x653B;&#x51FB;</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.apache.commons.text.StringEscapeUtils.escapeHtml4(input);</span><br><span class="line">org.apache.commons.text.StringEscapeUtils.escapeHtml3(input);</span><br><span class="line">org.apache.commons.text.StringEscapeUtils.escapeEcmaScript(input);</span><br><span class="line">org.apache.commons.lang.StringEscapeUtils.escapeSql(input);</span><br></pre></td></tr></table></figure><h3 id="13-spring&#x624B;&#x52A8;&#x6CE8;&#x5165;&#x51E0;&#x79CD;&#x65B9;&#x5F0F;"><a href="#13-spring&#x624B;&#x52A8;&#x6CE8;&#x5165;&#x51E0;&#x79CD;&#x65B9;&#x5F0F;" class="headerlink" title="13. spring&#x624B;&#x52A8;&#x6CE8;&#x5165;&#x51E0;&#x79CD;&#x65B9;&#x5F0F;"></a>13. spring&#x624B;&#x52A8;&#x6CE8;&#x5165;&#x51E0;&#x79CD;&#x65B9;&#x5F0F;</h3><ul><li><p>web&#x65B9;&#x5F0F;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// web&#x65B9;&#x5F0F;</span></span><br><span class="line"><span class="comment">// &#x5728;&#x670D;&#x52A1;&#x5668;&#x4E2D;&#xFF0C;servlet&#x4E2D;&#x6CE8;&#x5165;&#x4E00;&#x4E2A;bean</span></span><br><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> ContextLoader.getCurrentWebApplicationContext();</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> context.getBean(className);</span><br></pre></td></tr></table></figure></li><li><ol start="2"><li>&#x4F7F;&#x7528;ApplicationContextAware&#x63A5;&#x53E3;<br>TODO</li></ol></li></ul><h3 id="14-&#x52A0;&#x8F7D;&#x9879;&#x76EE;&#x4E2D;&#x6587;&#x4EF6;&#x8D44;&#x6E90;&#x7EDF;&#x4E00;&#x5199;&#x6CD5;"><a href="#14-&#x52A0;&#x8F7D;&#x9879;&#x76EE;&#x4E2D;&#x6587;&#x4EF6;&#x8D44;&#x6E90;&#x7EDF;&#x4E00;&#x5199;&#x6CD5;" class="headerlink" title="14. &#x52A0;&#x8F7D;&#x9879;&#x76EE;&#x4E2D;&#x6587;&#x4EF6;&#x8D44;&#x6E90;&#x7EDF;&#x4E00;&#x5199;&#x6CD5;.."></a>14. &#x52A0;&#x8F7D;&#x9879;&#x76EE;&#x4E2D;&#x6587;&#x4EF6;&#x8D44;&#x6E90;&#x7EDF;&#x4E00;&#x5199;&#x6CD5;..</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x9879;&#x76EE;&#x5DE5;&#x7A0B;</span><br><span class="line">  |-src/main/resources</span><br><span class="line">    |- image</span><br><span class="line">      |-test.png</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&#x6BD4;&#x5982;&#x60F3;&#x52A0;&#x8F7D; <code>parentDir=src/main/resources</code> <code>subDir=image</code> <code>fileName=test.png</code> &#x56FE;&#x7247;&#x6587;&#x4EF6;&#xFF0C;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#x5199;&#x6CD5;&#xFF0C;&#x5173;&#x952E;&#x662F;&#xFF1A;<br><code>inputStream = AS28Context.class.getClassLoader().getResourceAsStream(&quot;image/test.png&quot;);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> InputStream <span class="title function_">loadInputStream</span><span class="params">(String parentDir, String subDir, String fileName)</span> {</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        inputStream = AS28Context.class.getClassLoader().getResourceAsStream(subDir + <span class="string">&quot;/&quot;</span> + fileName);</span><br><span class="line">        <span class="keyword">if</span> (inputStream != <span class="literal">null</span>) {</span><br><span class="line">            log.info(<span class="string">&quot;    ---&gt;currentThread:class loader name={} retrieve fileName={} success&quot;</span>, AS28Context.class.getClassLoader().getClass().getName(), fileName);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        log.error(<span class="string">&quot;&#x52A0;&#x8F7D;&#x6587;&#x4EF6;&#x5F02;&#x5E38;&quot;</span>, e);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (inputStream == <span class="literal">null</span>) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s/%s/%s&quot;</span>, parentDir, subDir, fileName);</span><br><span class="line">        log.error(<span class="string">&quot;path={} cannot retrieve...&quot;</span>, path, fileName);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(String.format(<span class="string">&quot;%s &#x6587;&#x4EF6;&#x4E0D;&#x5B58;&#x5728;&quot;</span>, path));</span><br><span class="line">    }</span><br><span class="line">    log.info(<span class="string">&quot;fileName={} load inputstream success&quot;</span>, fileName);</span><br><span class="line">    <span class="keyword">return</span> inputStream;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="15-File&#x7C7B;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x521B;&#x5EFA;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x5E76;&#x5199;&#x5165;"><a href="#15-File&#x7C7B;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x521B;&#x5EFA;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x5E76;&#x5199;&#x5165;" class="headerlink" title="15. File&#x7C7B;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x521B;&#x5EFA;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x5E76;&#x5199;&#x5165;"></a>15. File&#x7C7B;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x521B;&#x5EFA;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x5E76;&#x5199;&#x5165;</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"><span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> File.createTempFile(<span class="string">&quot;test-&quot;</span>+timestamp, <span class="string">&quot;.txt&quot;</span>);</span><br><span class="line">file.deleteOnExit();</span><br><span class="line"></span><br><span class="line"><span class="type">Writer</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file));</span><br><span class="line">writer.write(<span class="string">&quot;abcdefghijklmnopqrstuvwxyz\n&quot;</span>);</span><br><span class="line">writer.write(<span class="string">&quot;01234567890112345678901234\n&quot;</span>);</span><br><span class="line">writer.write(<span class="string">&quot;!@#$%^&amp;*()-=[]{};&apos;:&apos;,.&lt;&gt;/?\n&quot;</span>);</span><br><span class="line">writer.write(<span class="string">&quot;01234567890112345678901234\n&quot;</span>);</span><br><span class="line">writer.write(<span class="string">&quot;abcdefghijklmnopqrstuvwxyz\n&quot;</span>);</span><br><span class="line">writer.write(<span class="string">&quot;timestamp=&quot;</span> + timestamp);</span><br><span class="line">writer.close();</span><br></pre></td></tr></table></figure><ol start="16"><li>apache-maven&#x4E0B;&#x7684;settings.xml&#x91CC;&#xFF0C;&#x589E;&#x52A0;<mirror>&#xFF1A;<br><code>&lt;mirrors&gt;</code>&#x6807;&#x7B7E;&#x91CC;&#xFF0C;&#x589E;&#x52A0;&#x4E0B;&#x9762;&#xFF1A;<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--&#x963F;&#x91CC;&#x4E91;&#x955C;&#x50CF;--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span>&#xA0;&#xA0;</span><br><span class="line">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span>&#xA0;&#xA0;</span><br><span class="line">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun&#xA0;maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span>&#xA0;&#xA0;</span><br><span class="line">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>&#xA0;&#xA0;</span><br><span class="line">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;<span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><br><span class="line">&#xA0; <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>springmaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>spring maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/libs-milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>ui<span class="tag">&lt;/<span class="name">id</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://uk.maven.org/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>ibiblio<span class="tag">&lt;/<span class="name">id</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://mirrors.ibiblio.org/pub/mirrors/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>jboss-public-repository-group<span class="tag">&lt;/<span class="name">id</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>JBoss Public Repository Group<span class="tag">&lt;/<span class="name">name</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repository.jboss.org/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&#x8BBF;&#x95EE;&#x6162;&#x7684;&#x7F51;&#x5740;&#x653E;&#x5165;&#x5230;&#x540E;&#x9762;--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>CN<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>OSChina Central<span class="tag">&lt;/<span class="name">name</span>&gt;</span>         </span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.oschina.net/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>net-cn<span class="tag">&lt;/<span class="name">id</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.net.cn/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>     </span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>JBossJBPM<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>JBossJBPM Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span>   </span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repository.jboss.org/nexus/content/repositories/releases/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure></mirror></li></ol><h3 id="16-controller&#x63A5;&#x53D7;&#x53C2;&#x6570;&#x7684;&#x51E0;&#x79CD;&#x7279;&#x522B;&#x65B9;&#x5F0F;&#x8BF4;&#x660E;"><a href="#16-controller&#x63A5;&#x53D7;&#x53C2;&#x6570;&#x7684;&#x51E0;&#x79CD;&#x7279;&#x522B;&#x65B9;&#x5F0F;&#x8BF4;&#x660E;" class="headerlink" title="16. controller&#x63A5;&#x53D7;&#x53C2;&#x6570;&#x7684;&#x51E0;&#x79CD;&#x7279;&#x522B;&#x65B9;&#x5F0F;&#x8BF4;&#x660E;"></a>16. controller&#x63A5;&#x53D7;&#x53C2;&#x6570;&#x7684;&#x51E0;&#x79CD;&#x7279;&#x522B;&#x65B9;&#x5F0F;&#x8BF4;&#x660E;</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestContrlloller</span></span><br><span class="line"><span class="meta">@RestMapping(&quot;/a&quot;)</span></span><br><span class="line"><span class="keyword">class</span>  <span class="title class_">A</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GettingtMapping(value=&quot;/test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">test</span><span class="params">(<span class="meta">@RequestParam(&quot;fileName&quot;)</span> String[] fileNames)</span> {</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>&#x5982;&#x679C;&#x5165;&#x53C2;&#x662F;String[]&#x6570;&#x7EC4;&#xFF0C;&#x6B64;&#x65F6;http url:  /a/test?<strong>fileName</strong>=a&amp;<strong>fileName</strong>=b &#xFF0C; http method:GET<br>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x5BF9;&#x4E8E;GET&#x8BF7;&#x6C42;&#xFF0C;&#x53EA;&#x8981;url&#x540E;&#x9762;&#x7684;&#x53C2;&#x6570;&#x540D;&#x79F0;&#x91CD;&#x590D;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#x3002;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#x8FD9;&#x4E2A;&#x6BD4;&#x8F83;&#x5947;&#x8469;&#xFF0C;&#x6765;&#x81EA;&#x4E00;&#x4F4D;&#x670B;&#x53CB;&#x7684;&#x5199;&#x6CD5;&#xFF0C;&#x5373;.xxx/5,4&#x8FD9;&#x6837;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;SpringMVC&#x7ADF;&#x7136;&#x4E5F;&#x662F;&#x652F;&#x6301;&#x7684;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@RequestMapping(value=&quot;array/{id}&quot;,method=RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">array2</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span>Long[] id)</span>{</span><br><span class="line">    System.out.println(id.length);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;array length:&quot;</span>+id.length+<span class="string">&quot;&quot;</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="17-spring-&#x9500;&#x6BC1;bean&#xFF0C;&#x521D;&#x59CB;&#x5316;bean2&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x51E0;&#x79CD;&#x65B9;&#x5F0F;"><a href="#17-spring-&#x9500;&#x6BC1;bean&#xFF0C;&#x521D;&#x59CB;&#x5316;bean2&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x51E0;&#x79CD;&#x65B9;&#x5F0F;" class="headerlink" title="17. spring &#x9500;&#x6BC1;bean&#xFF0C;&#x521D;&#x59CB;&#x5316;bean2&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x51E0;&#x79CD;&#x65B9;&#x5F0F;"></a>17. spring &#x9500;&#x6BC1;bean&#xFF0C;&#x521D;&#x59CB;&#x5316;bean2&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x51E0;&#x79CD;&#x65B9;&#x5F0F;</h3><ul><li><ol><li>&#x5728;<bean>&#x6807;&#x7B7E;&#x91CC;&#x9762;&#xFF0C;&#x4F7F;&#x7528;init-method&#x548C;destroy-method&#x5C5E;&#x6027;&#xFF0C;&#x6307;&#x5B9A;&#x7C7B;&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#x540D;</bean></li></ol></li><li><ol start="2"><li>&#x81EA;&#x5B9A;&#x4E49;&#x7684;bean&#x4E2D;&#xFF0C;&#x81EA;&#x5DF1; implements DisposableBean, InitializingBean&#xFF0C;&#x91CD;&#x5199;destroy()&#x548C;afterProperiesSet()&#x65B9;&#x6CD5;</li></ol></li><li><ol start="3"><li>&#x5728;&#x6307;&#x5B9A;&#x7684;&#x65B9;&#x6CD5;&#x4E0A;&#xFF0C;&#x52A0;&#x4E0A;@PostConstruct&#x6216;@PreDestroy&#x6CE8;&#x89E3;&#x6765;&#x5236;&#x5B9A;&#x8BE5;&#x65B9;&#x6CD5;&#x662F;&#x5728;&#x521D;&#x59CB;&#x5316;&#x4E4B;&#x540E;&#x8FD8;&#x662F;&#x9500;&#x6BC1;&#x4E4B;&#x524D;&#x8C03;&#x7528;&#x3002;</li></ol></li></ul><h3 id="18-toString&#xFF08;&#xFF09;&#x683C;&#x5F0F;&#x5316;&#x91CD;&#x5199;"><a href="#18-toString&#xFF08;&#xFF09;&#x683C;&#x5F0F;&#x5316;&#x91CD;&#x5199;" class="headerlink" title="18. toString&#xFF08;&#xFF09;&#x683C;&#x5F0F;&#x5316;&#x91CD;&#x5199;"></a>18. toString&#xFF08;&#xFF09;&#x683C;&#x5F0F;&#x5316;&#x91CD;&#x5199;</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> ToStringBuilder.reflectionToString(<span class="built_in">this</span>, ToStringStyle.MULTI_LINE_STYLE);</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>&#x9700;&#x8981;&#x5BFC;&#x5165;&#x5305;&#xFF1A;</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br></pre></td></tr></table></figure><h3 id="19-&#x5F97;&#x5230;&#x4E00;&#x4E2A;enum&#x7C7B;&#x7684;&#x6240;&#x6709;&#x53D8;&#x91CF;"><a href="#19-&#x5F97;&#x5230;&#x4E00;&#x4E2A;enum&#x7C7B;&#x7684;&#x6240;&#x6709;&#x53D8;&#x91CF;" class="headerlink" title="19. &#x5F97;&#x5230;&#x4E00;&#x4E2A;enum&#x7C7B;&#x7684;&#x6240;&#x6709;&#x53D8;&#x91CF;"></a>19. &#x5F97;&#x5230;&#x4E00;&#x4E2A;enum&#x7C7B;&#x7684;&#x6240;&#x6709;&#x53D8;&#x91CF;</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (DataType type : EnumSet.allOf(DataType.class))</span><br><span class="line">  codeLookup.put(type.code, type);</span><br></pre></td></tr></table></figure><h3 id="20-java-crc32&#x83B7;&#x5F97;&#x552F;&#x4E00;&#x503C;"><a href="#20-java-crc32&#x83B7;&#x5F97;&#x552F;&#x4E00;&#x503C;" class="headerlink" title="20. java crc32&#x83B7;&#x5F97;&#x552F;&#x4E00;&#x503C;"></a>20. java crc32&#x83B7;&#x5F97;&#x552F;&#x4E00;&#x503C;</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x53C2;&#x8003;&#xFF1A;http://blog.csdn.net/tbkken/article/details/8210952</span><br><span class="line">&#x4E4B;&#x524D;&#x5728;MySQL&#x6570;&#x636E;&#x5E93;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;CRC32&#x76F4;&#x63A5;&#x5BF9;&#x5B57;&#x7B26;&#x4E32;&#x8FDB;&#x884C;&#x7F16;&#x7801;&#xFF0C;&#x751F;&#x6210;&#x4E00;&#x4E2A;long&#x957F;&#x6574;&#x5F62;&#x7684;&#x552F;&#x4E00;&#x6027;ID&#xFF08;&#x867D;&#x7136;&#x79D1;&#x5B66;&#x8BC1;&#x660E;&#x4E0D;&#x7EDD;&#x5BF9;&#x552F;&#x4E00;&#xFF0C;&#x4F46;&#x662F;&#x8FD8;&#x662F;&#x53EF;&#x7528;&#x7684;&#xFF09;&#xFF0C;&#x6240;&#x4EE5;&#x6BCF;&#x6B21;&#x90FD;&#x901A;&#x8FC7;&#x6570;&#x636E;&#x5E93;&#x8C03;&#x7528;&#x6570;&#x636E;&#x5E93;&#x7684;crc32&#x51FD;&#x6570;&#x8FDB;&#x884C;&#x5B57;&#x7B26;&#x4E32;&#x7F16;&#x7801;&#x3002;&#x73B0;&#x5728;&#x53D1;&#x73B0;Java&#x4E2D;&#x4E5F;&#x6709;&#x73B0;&#x6210;&#x7684;&#x51FD;&#x6570;&#x53EF;&#x4EE5;&#x8C03;&#x7528;&#xFF0C;&#x8BE6;&#x7EC6;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</span><br><span class="line">CRC32 crc32 = new CRC32();</span><br><span class="line">crc32.update(&quot;abc&quot;.getBytes());</span><br><span class="line">System.out.println(crc32.getValue());</span><br><span class="line">&#x7ED3;&#x679C;&#xFF1A; 891568578</span><br><span class="line">&#x7ECF;&#x8FC7;&#x6D4B;&#x8BD5;&#xFF0C;&#x548C;MySQL&#x8FD4;&#x56DE;&#x7684;&#x503C;&#x4E00;&#x81F4;&#x3002;</span><br><span class="line"></span><br><span class="line">mysql&#x4E2D;&#xFF1A;</span><br><span class="line">SELECT CRC32(&apos;abc&apos;);</span><br><span class="line"> &#x8FD4;&#x56DE;&#xFF1A;</span><br><span class="line">891568578</span><br></pre></td></tr></table></figure><h3 id="21-mybatis-xml&#x4E2D;&#xFF0C;-sql&#x8BED;&#x53E5;&#x6709;&#x5173;&#x952E;&#x5B57;&#x7B26;&#xFF0C;&#x4E0D;&#x60F3;&#x8F6C;&#x4E49;&#xFF0C;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#xFF1A;"><a href="#21-mybatis-xml&#x4E2D;&#xFF0C;-sql&#x8BED;&#x53E5;&#x6709;&#x5173;&#x952E;&#x5B57;&#x7B26;&#xFF0C;&#x4E0D;&#x60F3;&#x8F6C;&#x4E49;&#xFF0C;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#xFF1A;" class="headerlink" title="21. mybatis xml&#x4E2D;&#xFF0C; sql&#x8BED;&#x53E5;&#x6709;&#x5173;&#x952E;&#x5B57;&#x7B26;&#xFF0C;&#x4E0D;&#x60F3;&#x8F6C;&#x4E49;&#xFF0C;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#xFF1A;"></a>21. mybatis xml&#x4E2D;&#xFF0C; sql&#x8BED;&#x53E5;&#x6709;&#x5173;&#x952E;&#x5B57;&#x7B26;&#xFF0C;&#x4E0D;&#x60F3;&#x8F6C;&#x4E49;&#xFF0C;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#xFF1A;</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;![CDATA[   sql  ]]&gt;</span><br></pre></td></tr></table></figure><h3 id="22-maven-settings-xml-&#x914D;&#x7F6E;-&#x963F;&#x91CC;&#x4E91;&#x955C;&#x50CF;"><a href="#22-maven-settings-xml-&#x914D;&#x7F6E;-&#x963F;&#x91CC;&#x4E91;&#x955C;&#x50CF;" class="headerlink" title="22. maven settings.xml &#x914D;&#x7F6E; &#x963F;&#x91CC;&#x4E91;&#x955C;&#x50CF;"></a>22. maven settings.xml &#x914D;&#x7F6E; &#x963F;&#x91CC;&#x4E91;&#x955C;&#x50CF;</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--&#x963F;&#x91CC;&#x4E91;&#x955C;&#x50CF;--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">mirror</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>          </span><br><span class="line"> <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">id</span>&gt;</span>springmaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">name</span>&gt;</span>spring maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/libs-milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirror</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>ui<span class="tag">&lt;/<span class="name">id</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://uk.maven.org/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>    </span><br><span class="line"> <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span>    </span><br><span class="line"> <span class="tag">&lt;<span class="name">mirror</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>ibiblio<span class="tag">&lt;/<span class="name">id</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://mirrors.ibiblio.org/pub/mirrors/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>    </span><br><span class="line"> <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">mirror</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>jboss-public-repository-group<span class="tag">&lt;/<span class="name">id</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>JBoss Public Repository Group<span class="tag">&lt;/<span class="name">name</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repository.jboss.org/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span>    </span><br><span class="line"> <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--&#x8BBF;&#x95EE;&#x6162;&#x7684;&#x7F51;&#x5740;&#x653E;&#x5165;&#x5230;&#x540E;&#x9762;--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirror</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>CN<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>OSChina Central<span class="tag">&lt;/<span class="name">name</span>&gt;</span>         </span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.oschina.net/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>    </span><br><span class="line"> <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">mirror</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>net-cn<span class="tag">&lt;/<span class="name">id</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.net.cn/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>     </span><br><span class="line"> <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">mirror</span>&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>JBossJBPM<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>JBossJBPM Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span>   </span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repository.jboss.org/nexus/content/repositories/releases/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="23"><a href="#23" class="headerlink" title="23."></a>23.</h3>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;#x5F00;&amp;#x53D1;&amp;#x5E38;&amp;#x7528;&amp;#x7B14;&amp;#x8BB0;&amp;#x7EC6;&amp;#x8282;&lt;/p&gt;</summary>
    
    
    
    <category term="笔记" scheme="http://example.com/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="三方工具类" scheme="http://example.com/tags/%E4%B8%89%E6%96%B9%E5%B7%A5%E5%85%B7%E7%B1%BB/"/>
    
  </entry>
  
  <entry>
    <title>中间件系列之redis-redis6.0多线程模型</title>
    <link href="http://example.com/2022/07/12/7A.001.%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%B3%BB%E5%88%97%E4%B9%8Bredis-redis6.0%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/"/>
    <id>http://example.com/2022/07/12/7A.001.%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%B3%BB%E5%88%97%E4%B9%8Bredis-redis6.0%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/</id>
    <published>2022-07-11T16:00:00.000Z</published>
    <updated>2023-09-20T09:05:42.464Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>redis6.0&#x591A;&#x7EBF;&#x7A0B;&#x662F;&#x4EC0;&#x4E48;</p></blockquote><span id="more"></span><p>redis6.0&#x5F15;&#x5165;&#x591A;&#x7EBF;&#x7A0B;IO&#xFF0C;&#x53EA;&#x662F;&#x7528;&#x6765;<strong>&#x5904;&#x7406;&#x7F51;&#x7EDC;&#x6570;&#x636E;&#x7684;&#x8BFB;&#x5199;&#x548C;&#x534F;&#x8BAE;&#x7684;&#x89E3;&#x6790;</strong>&#xFF0C;&#x800C;<strong>&#x6267;&#x884C;&#x547D;&#x4EE4;&#x4F9D;&#x65E7;&#x662F;&#x5355;&#x7EBF;&#x7A0B;</strong>&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x9700;&#x8981;&#x53BB;&#x8003;&#x8651;set/get&#x3001;&#x4E8B;&#x52A1;&#x3001;lua&#x7B49;&#x7684;&#x5E76;&#x53D1;&#x95EE;&#x9898;&#x3002;<br>&#x968F;&#x7740;&#x786C;&#x4EF6;&#x6027;&#x80FD;&#x63D0;&#x5347;&#xFF0C;Redis &#x7684;&#x6027;&#x80FD;&#x74F6;&#x9888;&#x53EF;&#x80FD;&#x51FA;&#x73B0;&#x7F51;&#x7EDC; IO &#x7684;&#x8BFB;&#x5199;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#xFF1A;<strong>&#x5355;&#x4E2A;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x7F51;&#x7EDC;&#x8BFB;&#x5199;&#x7684;&#x901F;&#x5EA6;&#x8DDF;&#x4E0D;&#x4E0A;&#x5E95;&#x5C42;&#x7F51;&#x7EDC;&#x786C;&#x4EF6;&#x7684;&#x901F;&#x5EA6;&#x3002;</strong><br>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;<strong>Redis &#x591A; IO &#x7EBF;&#x7A0B;&#x6A21;&#x578B;&#x53EA;&#x7528;&#x6765;&#x5904;&#x7406;&#x7F51;&#x7EDC;&#x8BFB;&#x5199;&#x8BF7;&#x6C42;&#xFF0C;&#x5BF9;&#x4E8E; Redis &#x7684;&#x8BFB;&#x5199;&#x547D;&#x4EE4;&#xFF0C;&#x4F9D;&#x7136;&#x662F;&#x5355;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x3002;</strong></p><p>&#x5F00;&#x542F;&#x591A;&#x7EBF;&#x7A0B;&#xFF1A;<br>&#x5728;Redis&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x6709;&#x8FD9;&#x6837;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#xFF1A;<code>io-threads-do-reads</code>&#x548C;<code>io-threads</code><br><code>io-threads-do-reads</code>&#x7684;&#x9ED8;&#x8BA4;&#x503C;&#x662F;no&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;Redis&#x5E76;&#x4E0D;&#x4F1A;&#x5F00;&#x542F;&#x591A;&#x7EBF;&#x7A0B;&#x6A21;&#x578B;&#x3002;&#x5982;&#x679C;&#x6211;&#x8981;&#x4F7F;&#x7528;Redis&#x7684;&#x591A;&#x7EBF;&#x7A0B;&#x6A21;&#x578B;&#xFF0C;&#x53EF;&#x4EE5;&#x5C06;&#x5728;redis.conf&#x6587;&#x4EF6;&#x4E2D;&#x5C06;&#x8BE5;&#x503C;&#x8BBE;&#x7F6E;&#x4E3A;true&#x3002;<br><code>io-threads</code>&#x662F;&#x7528;&#x6765;&#x914D;&#x7F6E;IO&#x7EBF;&#x7A0B;&#x7EC4;&#x7EBF;&#x7A0B;&#x6570;&#x3002;<br>&#x5B98;&#x65B9;&#x7684;&#x5EFA;&#x8BAE;&#x662F;&#xFF1A;&#x5982;&#x679C;&#x4F60;&#x7684;CPU&#x662F;4&#x6838;&#xFF0C;IO&#x7EBF;&#x7A0B;&#x7EC4;&#x4E00;&#x822C;&#x8BBE;&#x7F6E;&#x4E3A;2-3&#xFF1B;&#x5982;&#x679C;&#x4F60;&#x7684;CPU&#x662F;8&#x6838;&#xFF0C;IO&#x7EBF;&#x7A0B;&#x7EC4;&#x4E00;&#x822C;&#x8BBE;&#x7F6E;&#x4E3A;5-6&#x3002;</p><p>&#x4E3A;&#x4EC0;&#x4E48;&#x5B98;&#x65B9;&#x4F1A;&#x8FD9;&#x6837;&#x7684;&#x53BB;&#x5EFA;&#x8BAE;&#x5462;&#xFF1F;&#x90A3;&#x662F;&#x56E0;&#x4E3A;&#x5982;&#x679C;IO&#x7EBF;&#x7A0B;&#x8BBE;&#x7F6E;&#x592A;&#x591A;&#xFF0C;&#x90A3;&#x5728;&#x9AD8;&#x5E76;&#x53D1;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x7EBF;&#x7A0B;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#x4F1A;&#x6210;&#x4E3A;&#x65B0;&#x7684;&#x74F6;&#x9888;&#x3002;</p><hr><p>redis6.0 &#x591A;&#x7EBF;&#x7A0B;&#x6267;&#x884C;&#x6D41;&#x7A0B;&#xFF1A;&#xFF08;&#x672A;&#x7406;&#x89E3;&#xFF09;: <a href="https://www.cnblogs.com/jelly12345/p/15136912.html">https://www.cnblogs.com/jelly12345/p/15136912.html</a></p><p>(1).&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#xFF1A;</p><ol><li>&#x4E3B;&#x7EBF;&#x7A0B;&#x83B7;&#x53D6; socket &#x653E;&#x5165;&#x7B49;&#x5F85;&#x5217;&#x8868;</li><li>&#x5C06; socket &#x5206;&#x914D;&#x7ED9;&#x5404;&#x4E2A; IO &#x7EBF;&#x7A0B;&#xFF08;&#x5E76;&#x4E0D;&#x4F1A;&#x7B49;&#x5217;&#x8868;&#x6EE1;&#xFF09;</li><li>&#x4E3B;&#x7EBF;&#x7A0B;&#x963B;&#x585E;&#x7B49;&#x5F85; IO &#x7EBF;&#x7A0B;&#xFF08;&#x591A;&#x7EBF;&#x7A0B;&#xFF09;&#x8BFB;&#x53D6; socket &#x5B8C;&#x6BD5;&#xFF09;</li><li>&#x4E3B;&#x7EBF;&#x7A0B;&#x6267;&#x884C;&#x547D;&#x4EE4; - &#x5355;&#x7EBF;&#x7A0B;&#xFF08;&#x5982;&#x679C;&#x547D;&#x4EE4;&#x6CA1;&#x6709;&#x63A5;&#x6536;&#x5B8C;&#x6BD5;&#xFF0C;&#x4F1A;&#x7B49; IO &#x4E0B;&#x6B21;&#x7EE7;&#x7EED;&#xFF09;</li><li>&#x4E3B;&#x7EBF;&#x7A0B;&#x963B;&#x585E;&#x7B49;&#x5F85; IO &#x7EBF;&#x7A0B;&#xFF08;&#x591A;&#x7EBF;&#x7A0B;&#xFF09;&#x5C06;&#x6570;&#x636E;&#x56DE;&#x5199; socket &#x5B8C;&#x6BD5;&#xFF08;&#x4E00;&#x6B21;&#x6CA1;&#x5199;&#x5B8C;&#xFF0C;&#x4F1A;&#x7B49;&#x4E0B;&#x6B21;&#x518D;&#x5199;&#xFF09;</li><li>&#x89E3;&#x9664;&#x7ED1;&#x5B9A;&#xFF0C;&#x6E05;&#x7A7A;&#x7B49;&#x5F85;&#x961F;&#x5217;</li></ol><p>(2).&#x7279;&#x70B9;&#x5982;&#x4E0B;&#xFF1A;</p><ul><li><p>IO &#x7EBF;&#x7A0B;&#x8981;&#x4E48;&#x540C;&#x65F6;&#x5728;&#x8BFB; socket&#xFF0C;&#x8981;&#x4E48;&#x540C;&#x65F6;&#x5728;&#x5199;&#xFF0C;&#x4E0D;&#x4F1A;&#x540C;&#x65F6;&#x8BFB;&#x6216;&#x5199;</p></li><li><p>IO &#x7EBF;&#x7A0B;&#x53EA;&#x8D1F;&#x8D23;&#x8BFB;&#x5199; socket &#x89E3;&#x6790;&#x547D;&#x4EE4;&#xFF0C;&#x4E0D;&#x8D1F;&#x8D23;&#x547D;&#x4EE4;&#x5904;&#x7406;&#xFF08;&#x4E3B;&#x7EBF;&#x7A0B;&#x4E32;&#x884C;&#x6267;&#x884C;&#x547D;&#x4EE4;</p></li><li><p>IO &#x7EBF;&#x7A0B;&#x6570;&#x53EF;&#x81EA;&#x884C;&#x914D;&#x7F6E;</p></li></ul><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/7A.001.%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%B3%BB%E5%88%97%E4%B9%8Bredis-redis6.0%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/1.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/7A.001.%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%B3%BB%E5%88%97%E4%B9%8Bredis-redis6.0%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/2.png"></p><p><strong>&#x5F00;&#x542F;&#x591A;&#x7EBF;&#x7A0B;&#x540E;&#xFF0C;&#x662F;&#x5426;&#x4F1A;&#x5B58;&#x5728;&#x7EBF;&#x7A0B;&#x5E76;&#x53D1;&#x5B89;&#x5168;&#x95EE;&#x9898;&#xFF1F;</strong><br>&#x4ECE;&#x4E0A;&#x9762;&#x7684;&#x5B9E;&#x73B0;&#x673A;&#x5236;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;Redis&#x7684;&#x591A;&#x7EBF;&#x7A0B;&#x90E8;&#x5206;&#x53EA;&#x662F;&#x7528;&#x6765;&#x5904;&#x7406;&#x7F51;&#x7EDC;&#x6570;&#x636E;&#x7684;&#x8BFB;&#x5199;&#x548C;&#x534F;&#x8BAE;&#x89E3;&#x6790;&#xFF0C;&#x6267;&#x884C;&#x547D;&#x4EE4;&#x4ECD;&#x7136;&#x662F;&#x5355;&#x7EBF;&#x7A0B;&#x987A;&#x5E8F;&#x6267;&#x884C;&#x3002;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x4E0D;&#x9700;&#x8981;&#x53BB;&#x8003;&#x8651;&#x63A7;&#x5236; key&#x3001;lua&#x3001;&#x4E8B;&#x52A1;&#xFF0C;LPUSH/LPOP &#x7B49;&#x7B49;&#x7684;&#x5E76;&#x53D1;&#x53CA;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x95EE;&#x9898;&#x3002;</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;redis6.0&amp;#x591A;&amp;#x7EBF;&amp;#x7A0B;&amp;#x662F;&amp;#x4EC0;&amp;#x4E48;&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="中间件" scheme="http://example.com/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
    <category term="redis" scheme="http://example.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>中间件系列之redis-redis非常快的原因</title>
    <link href="http://example.com/2022/07/12/7A.002.%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%B3%BB%E5%88%97%E4%B9%8Bredis-redis%E9%9D%9E%E5%B8%B8%E5%BF%AB%E7%9A%84%E5%8E%9F%E5%9B%A0/"/>
    <id>http://example.com/2022/07/12/7A.002.%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%B3%BB%E5%88%97%E4%B9%8Bredis-redis%E9%9D%9E%E5%B8%B8%E5%BF%AB%E7%9A%84%E5%8E%9F%E5%9B%A0/</id>
    <published>2022-07-11T16:00:00.000Z</published>
    <updated>2023-09-20T09:05:42.465Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>redis&#x975E;&#x5E38;&#x5FEB;&#x7684;&#x539F;&#x56E0;</p></blockquote><ul><li><p>A. &#x7EAF;&#x5185;&#x5B58;&#x64CD;&#x4F5C;&#xFF0C;&#x907F;&#x514D;&#x5927;&#x91CF;&#x8BBF;&#x95EE;&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x51CF;&#x5C11;&#x76F4;&#x63A5;&#x8BFB;&#x53D6;&#x78C1;&#x76D8;&#x6570;&#x636E;&#xFF0C;redis&#x5C06;&#x6570;&#x636E;&#x50A8;&#x5B58;&#x5728;&#x5185;&#x5B58;&#x91CC;&#x9762;&#xFF0C;&#x8BFB;&#x5199;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#x90FD;&#x4E0D;&#x4F1A;&#x53D7;&#x5230;&#x786C;&#x76D8; I/O &#x901F;&#x5EA6;&#x7684;&#x9650;&#x5236;&#xFF0C;&#x6240;&#x4EE5;&#x901F;&#x5EA6;&#x5FEB;.</p></li><li><p>B. &#x5355;&#x7EBF;&#x7A0B;&#x64CD;&#x4F5C;&#xFF0C;&#x907F;&#x514D;&#x4E86;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#x548C;&#x7ADE;&#x4E89;&#x6761;&#x4EF6;&#xFF0C;&#x4E5F;&#x4E0D;&#x5B58;&#x5728;&#x591A;&#x8FDB;&#x7A0B;&#x6216;&#x8005;&#x591A;&#x7EBF;&#x7A0B;&#x5BFC;&#x81F4;&#x7684;&#x5207;&#x6362;&#x800C;&#x6D88;&#x8017;CPU&#xFF0C;&#x4E0D;&#x7528;&#x53BB;&#x8003;&#x8651;&#x5404;&#x79CD;&#x9501;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4E0D;&#x5B58;&#x5728;&#x52A0;&#x9501;&#x91CA;&#x653E;&#x9501;&#x64CD;&#x4F5C;&#xFF0C;&#x6CA1;&#x6709;&#x56E0;&#x4E3A;&#x53EF;&#x80FD;&#x51FA;&#x73B0;&#x6B7B;&#x9501;&#x800C;&#x5BFC;&#x81F4;&#x7684;&#x6027;&#x80FD;&#x6D88;&#x8017;.</p></li><li><p>C. &#x91C7;&#x7528;&#x4E86;<strong>&#x975E;&#x963B;&#x585E;I/O &#x591A;&#x8DEF;&#x590D;&#x7528;&#x673A;&#x5236;</strong>.</p></li></ul><span id="more"></span><p>&#x5BF9;&#x4E8E;&#x975E;&#x963B;&#x585E;IO &#x548C; &#x591A;&#x8DEF;&#x590D;&#x7528; &#x7684;&#x6BD4;&#x8F83;&#x5F62;&#x8C61;&#x7684;&#x89E3;&#x91CA;&#xFF1A;<br><a href="https://www.cnblogs.com/yaopengfei/p/13946966.html">https://www.cnblogs.com/yaopengfei/p/13946966.html</a></p><hr><p><strong>&#x4EC0;&#x4E48;&#x662F;&#x975E;&#x963B;&#x585E;IO&#xFF1F;</strong></p><p>&#x3000;&#x975E;&#x963B;&#x585E; IO &#x5728; Socket &#x5BF9;&#x8C61;&#x4E0A;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x9009;&#x9879;Non_Blocking &#xFF0C;&#x5F53;&#x8FD9;&#x4E2A;&#x9009;&#x9879;&#x6253;&#x5F00;&#x65F6;&#xFF0C;&#x8BFB;&#x5199;&#x65B9;&#x6CD5;&#x4E0D;&#x4F1A;&#x963B;&#x585E;&#xFF0C;&#x800C;&#x662F;&#x80FD;&#x8BFB;&#x591A;&#x5C11;&#x8BFB;&#x591A;&#x5C11;&#xFF0C;&#x80FD;&#x5199;&#x591A;&#x5C11;&#x5199;&#x591A;&#x5C11;&#x3002;</p><p>&#x3000;&#x80FD;&#x8BFB;&#x591A;&#x5C11;&#x53D6;&#x51B3;&#x4E8E;&#x5185;&#x6838;&#x4E3A; Socket &#x5206;&#x914D;&#x7684;&#x8BFB;&#x7F13;&#x51B2;&#x533A;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x80FD;&#x5199;&#x591A;&#x5C11;&#x53D6;&#x51B3;&#x4E8E;&#x5185;&#x6838;&#x4E3A; Socket &#x5206;&#x914D;&#x7684;&#x5199;&#x7F13;&#x51B2;&#x533A;&#x7684;&#x5269;&#x4F59;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#x3002;&#x8BFB;&#x65B9;&#x6CD5;&#x548C;&#x5199;&#x65B9;&#x6CD5;&#x90FD;&#x4F1A;&#x901A;&#x8FC7;&#x8FD4;&#x56DE;&#x503C;&#x6765;&#x544A;&#x77E5;&#x7A0B;&#x5E8F;&#x5B9E;&#x9645;&#x8BFB;&#x5199;&#x4E86;&#x591A;&#x5C11;&#x5B57;&#x8282;&#x6570;&#x636E;&#x3002;</p><p>&#x3000;&#x6709;&#x4E86;&#x975E;&#x963B;&#x585E; IO &#x610F;&#x5473;&#x7740;&#x7EBF;&#x7A0B;&#x5728;&#x8BFB;&#x5199; IO &#x65F6;&#x53EF;&#x4EE5;&#x4E0D;&#x5FC5;&#x518D;&#x963B;&#x585E;&#x4E86;&#xFF0C;&#x8BFB;&#x5199;&#x53EF;&#x4EE5;&#x77AC;&#x95F4;&#x5B8C;&#x6210;&#x7136;&#x540E;&#x7EBF;&#x7A0B;&#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x5E72;&#x522B;&#x7684;&#x4E8B;&#x4E86;&#x3002;</p><blockquote><p>&#x8865;&#x5145;&#x963B;&#x585E;IO&#x6982;&#x5FF5;&#xFF1A;</p></blockquote><p>&#x3000;&#x5F53;&#x6211;&#x4EEC;&#x8C03;&#x7528; Scoket &#x7684;&#x8BFB;&#x5199;&#x65B9;&#x6CD5;&#xFF0C;&#x9ED8;&#x8BA4;&#x5B83;&#x4EEC;&#x662F;&#x963B;&#x585E;&#x7684;&#x3002;</p><p>&#x3000;read() &#x65B9;&#x6CD5;&#x8981;&#x4F20;&#x9012;&#x8FDB;&#x53BB;&#x4E00;&#x4E2A;&#x53C2;&#x6570; n&#xFF0C;&#x8868;&#x793A;&#x8BFB;&#x53D6;&#x8FD9;&#x4E48;&#x591A;&#x5B57;&#x8282;&#x540E;&#x518D;&#x8FD4;&#x56DE;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x8BFB;&#x591F; n &#x5B57;&#x8282;&#x7EBF;&#x7A0B;&#x5C31;&#x4F1A;&#x963B;&#x585E;&#xFF0C;&#x76F4;&#x5230;&#x65B0;&#x7684;&#x6570;&#x636E;&#x5230;&#x6765;&#x6216;&#x8005;&#x8FDE;&#x63A5;&#x5173;&#x95ED;&#x4E86;&#xFF0C; read &#x65B9;&#x6CD5;&#x624D;&#x53EF;&#x4EE5;&#x8FD4;&#x56DE;&#xFF0C;&#x7EBF;&#x7A0B;&#x624D;&#x80FD;&#x7EE7;&#x7EED;&#x5904;&#x7406;&#x3002;</p><p>&#x3000;write() &#x65B9;&#x6CD5;&#x4F1A;&#x9996;&#x5148;&#x628A;&#x6570;&#x636E;&#x5199;&#x5230;&#x7CFB;&#x7EDF;&#x5185;&#x6838;&#x4E3A; Scoket &#x5206;&#x914D;&#x7684;&#x5199;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#xFF0C;&#x5F53;&#x5199;&#x7F13;&#x5B58;&#x533A;&#x6EE1;&#x6EA2;&#xFF0C;&#x5373;&#x5199;&#x7F13;&#x5B58;&#x533A;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x8FD8;&#x6CA1;&#x6709;&#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;&#xFF0C;&#x5C31;&#x6709;&#x65B0;&#x7684;&#x6570;&#x636E;&#x8981;&#x5199;&#x9053;&#x5199;&#x7F13;&#x5B58;&#x533A;&#x65F6;&#xFF0C;write() &#x65B9;&#x6CD5;&#x5C31;&#x4F1A;&#x963B;&#x585E;&#xFF0C;&#x76F4;&#x5230;&#x5199;&#x7F13;&#x5B58;&#x533A;&#x4E2D;&#x6709;&#x7A7A;&#x95F2;&#x7A7A;&#x95F4;&#x3002;</p><p><strong>&#x4EC0;&#x4E48;&#x662F;IO&#x591A;&#x8DEF;&#x590D;&#x7528;&#xFF1F;</strong></p><p>&#x80CC;&#x666F;&#xFF1A;</p><p>&#x3000;&#x975E;&#x963B;&#x585E; IO &#x6709;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x90A3;&#x5C31;&#x662F;&#x5355;&#x4E2A;&#x7EBF;&#x7A0B;&#x8981;&#x5904;&#x7406;&#x591A;&#x4E2A;&#x8BFB;&#x5199;&#x8BF7;&#x6C42;&#xFF0C;&#x5904;&#x7406;&#x67D0;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x7684;&#x8BFB;&#x6570;&#x636E;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x7ED3;&#x679C;&#x8BFB;&#x4E86;&#x4E00;&#x90E8;&#x5206;&#x5C31;&#x8FD4;&#x56DE;&#x4E86;&#xFF0C;&#x7EBF;&#x7A0B;&#x5982;&#x4F55;&#x77E5;&#x9053;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x624D;&#x5E94;&#x8BE5;&#x7EE7;&#x7EED;&#x8BFB;&#x6570;&#x636E;&#x3002;&#x5904;&#x7406;&#x5199;&#x8BF7;&#x6C42;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5982;&#x679C;&#x7F13;&#x51B2;&#x533A;&#x6EE1;&#x4E86;&#xFF0C;&#x5199;&#x4E0D;&#x5B8C;&#xFF0C;&#x5269;&#x4E0B;&#x7684;&#x6570;&#x636E;&#x4F55;&#x65F6;&#x624D;&#x5E94;&#x8BE5;&#x7EE7;&#x7EED;&#x5199;&#xFF1F;&#x5728;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x5904;&#x7406;&#x4EC0;&#x4E48;&#x8BF7;&#x6C42;&#xFF1F;redis &#x5355;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x591A;&#x4E2A;IO&#x8BF7;&#x6C42;&#x65F6;&#x5C31;&#x7528;&#x5230;&#x4E86;IO&#x591A;&#x8DEF;&#x590D;&#x7528;&#x6280;&#x672F;&#x3002;</p><p>&#x539F;&#x7406;&#xFF1A;</p><p>&#x3000;&#x5982;&#x4E0B;&#x56FE;&#xFF0C;redis &#x9700;&#x8981;&#x5904;&#x7406; 3 &#x4E2A; IO &#x8BF7;&#x6C42;&#xFF0C;&#x540C;&#x65F6;&#x628A; 3 &#x4E2A;&#x8BF7;&#x6C42;&#x7684;&#x7ED3;&#x679C;&#x8FD4;&#x56DE;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x6240;&#x4EE5;&#x603B;&#x5171;&#x9700;&#x8981;&#x5904;&#x7406; 6 &#x4E2A; IO &#x4E8B;&#x4EF6;&#xFF0C;&#x7531;&#x4E8E; redis &#x662F;&#x5355;&#x7EBF;&#x7A0B;&#x6A21;&#x578B;&#xFF0C;&#x540C;&#x4E00;&#x65F6;&#x95F4;&#x53EA;&#x80FD;&#x5904;&#x7406;&#x4E00;&#x4E2A; IO &#x4E8B;&#x4EF6;&#xFF0C;&#x4E8E;&#x662F; redis &#x9700;&#x8981;&#x5728;&#x5408;&#x9002;&#x7684;&#x65F6;&#x95F4;&#x6682;&#x505C;&#x5BF9;&#x67D0;&#x4E2A; IO &#x4E8B;&#x4EF6;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x8F6C;&#x800C;&#x53BB;&#x5904;&#x7406;&#x53E6;&#x4E00;&#x4E2A; IO &#x4E8B;&#x4EF6;&#xFF0C;&#x8FD9;&#x6837; redis &#x5C31;&#x597D;&#x6BD4;&#x4E00;&#x4E2A;&#x5F00;&#x5173;&#xFF0C;&#x5F53;&#x5F00;&#x5173;&#x62E8;&#x5230;&#x54EA;&#x4E2A; IO &#x4E8B;&#x4EF6;&#x8FD9;&#x4E2A;&#x7535;&#x8DEF;&#x4E0A;&#xFF0C;&#x5C31;&#x5904;&#x7406;&#x54EA;&#x4E2A; IO &#x4E8B;&#x4EF6;&#xFF0C;&#x5176;&#x4ED6; IO &#x4E8B;&#x4EF6;&#x5C31;&#x6682;&#x505C;&#x5904;&#x7406;&#x4E86;&#x3002;&#x8FD9;&#x5C31;&#x662F;IO&#x591A;&#x8DEF;&#x590D;&#x7528;&#x6280;&#x672F;&#x3002;</p><p>&#x3000;&#x4EE5;&#x4E0A;&#x662F;&#x5927;&#x81F4;&#x7684;&#x7406;&#x89E3;&#x4E0B; IO &#x591A;&#x8DEF;&#x590D;&#x7528;&#x6280;&#x672F;&#xFF0C;&#x5728;&#x7CFB;&#x7EDF;&#x5E95;&#x5C42;&#xFF0C;IO &#x591A;&#x8DEF;&#x590D;&#x7528;&#x6709; 3 &#x79CD;&#x5B9E;&#x73B0;&#x673A;&#x5236;&#xFF1A;select&#x3001;poll&#x3001;epoll&#x3002;</p><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/7A.002.%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%B3%BB%E5%88%97%E4%B9%8Bredis-redis%E9%9D%9E%E5%B8%B8%E5%BF%AB%E7%9A%84%E5%8E%9F%E5%9B%A0/1.png"></p><p><strong>&#x4EC0;&#x4E48;&#x662F;&#x6587;&#x4EF6;&#x5904;&#x7406;&#x5668;&#xFF1F;</strong></p><ul><li><p>A. Redis &#x57FA;&#x4E8E; Reactor &#x6A21;&#x5F0F;&#x5F00;&#x53D1;&#x4E86;&#x81EA;&#x5DF1;&#x7684;&#x7F51;&#x7EDC;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x5668;&#xFF1A; &#x8FD9;&#x4E2A;&#x5904;&#x7406;&#x5668;&#x88AB;&#x79F0;&#x4E3A;&#x6587;&#x4EF6;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x5668;&#xFF08;file event handler&#xFF09;</p></li><li><p>B. &#x6587;&#x4EF6;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x5668;&#x4F7F;&#x7528; I/O &#x591A;&#x8DEF;&#x590D;&#x7528;&#xFF08;multiplexing&#xFF09;&#x7A0B;&#x5E8F;&#x6765;&#x540C;&#x65F6;&#x76D1;&#x542C;&#x591A;&#x4E2A;&#x5957;&#x63A5;&#x5B57;&#xFF0C; &#x5E76;&#x6839;&#x636E;&#x5957;&#x63A5;&#x5B57;&#x76EE;&#x524D;&#x6267;&#x884C;&#x7684;&#x4EFB;&#x52A1;&#x6765;&#x4E3A;&#x5957;&#x63A5;&#x5B57;&#x5173;&#x8054;&#x4E0D;&#x540C;&#x7684;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x5668;&#x3002;</p></li><li><p>C. &#x5F53;&#x88AB;&#x76D1;&#x542C;&#x7684;&#x5957;&#x63A5;&#x5B57;&#x51C6;&#x5907;&#x597D;&#x6267;&#x884C;&#x8FDE;&#x63A5;&#x5E94;&#x7B54;&#xFF08;accept&#xFF09;&#x3001;&#x8BFB;&#x53D6;&#xFF08;read&#xFF09;&#x3001;&#x5199;&#x5165;&#xFF08;write&#xFF09;&#x3001;&#x5173;&#x95ED;&#xFF08;close&#xFF09;&#x7B49;&#x64CD;&#x4F5C;&#x65F6;&#xFF0C; &#x4E0E;&#x64CD;&#x4F5C;&#x76F8;&#x5BF9;&#x5E94;&#x7684;&#x6587;&#x4EF6;&#x4E8B;&#x4EF6;&#x5C31;&#x4F1A;&#x4EA7;&#x751F;&#xFF0C; &#x8FD9;&#x65F6;&#x6587;&#x4EF6;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x5668;&#x5C31;&#x4F1A;&#x8C03;&#x7528;&#x5957;&#x63A5;&#x5B57;&#x4E4B;&#x524D;&#x5173;&#x8054;&#x597D;&#x7684;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x5668;&#x6765;&#x5904;&#x7406;&#x8FD9;&#x4E9B;&#x4E8B;&#x4EF6;&#x3002;</p></li><li><p>D. &#x6587;&#x4EF6;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x5668;&#x4EE5;&#x5355;&#x7EBF;&#x7A0B;&#x65B9;&#x5F0F;&#x8FD0;&#x884C;&#xFF0C; &#x4F46;&#x901A;&#x8FC7;&#x4F7F;&#x7528; I/O &#x591A;&#x8DEF;&#x590D;&#x7528;&#x7A0B;&#x5E8F;&#x6765;&#x76D1;&#x542C;&#x591A;&#x4E2A;&#x5957;&#x63A5;&#x5B57;&#xFF0C; &#x6587;&#x4EF6;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x5668;&#x65E2;&#x5B9E;&#x73B0;&#x4E86;&#x9AD8;&#x6027;&#x80FD;&#x7684;&#x7F51;&#x7EDC;&#x901A;&#x4FE1;&#x6A21;&#x578B;&#xFF0C; &#x53C8;&#x53EF;&#x4EE5;&#x5F88;&#x597D;&#x5730;&#x4E0E; redis &#x670D;&#x52A1;&#x5668;&#x4E2D;&#x5176;&#x4ED6;&#x540C;&#x6837;&#x4EE5;&#x5355;&#x7EBF;&#x7A0B;&#x65B9;&#x5F0F;&#x8FD0;&#x884C;&#x7684;&#x6A21;&#x5757;&#x8FDB;&#x884C;&#x5BF9;&#x63A5;&#xFF0C; &#x8FD9;&#x4FDD;&#x6301;&#x4E86; Redis &#x5185;&#x90E8;&#x5355;&#x7EBF;&#x7A0B;&#x8BBE;&#x8BA1;&#x7684;&#x7B80;&#x5355;&#x6027;&#x3002;</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;redis&amp;#x975E;&amp;#x5E38;&amp;#x5FEB;&amp;#x7684;&amp;#x539F;&amp;#x56E0;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;A. &amp;#x7EAF;&amp;#x5185;&amp;#x5B58;&amp;#x64CD;&amp;#x4F5C;&amp;#xFF0C;&amp;#x907F;&amp;#x514D;&amp;#x5927;&amp;#x91CF;&amp;#x8BBF;&amp;#x95EE;&amp;#x6570;&amp;#x636E;&amp;#x5E93;&amp;#xFF0C;&amp;#x51CF;&amp;#x5C11;&amp;#x76F4;&amp;#x63A5;&amp;#x8BFB;&amp;#x53D6;&amp;#x78C1;&amp;#x76D8;&amp;#x6570;&amp;#x636E;&amp;#xFF0C;redis&amp;#x5C06;&amp;#x6570;&amp;#x636E;&amp;#x50A8;&amp;#x5B58;&amp;#x5728;&amp;#x5185;&amp;#x5B58;&amp;#x91CC;&amp;#x9762;&amp;#xFF0C;&amp;#x8BFB;&amp;#x5199;&amp;#x6570;&amp;#x636E;&amp;#x7684;&amp;#x65F6;&amp;#x5019;&amp;#x90FD;&amp;#x4E0D;&amp;#x4F1A;&amp;#x53D7;&amp;#x5230;&amp;#x786C;&amp;#x76D8; I/O &amp;#x901F;&amp;#x5EA6;&amp;#x7684;&amp;#x9650;&amp;#x5236;&amp;#xFF0C;&amp;#x6240;&amp;#x4EE5;&amp;#x901F;&amp;#x5EA6;&amp;#x5FEB;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;B. &amp;#x5355;&amp;#x7EBF;&amp;#x7A0B;&amp;#x64CD;&amp;#x4F5C;&amp;#xFF0C;&amp;#x907F;&amp;#x514D;&amp;#x4E86;&amp;#x4E0D;&amp;#x5FC5;&amp;#x8981;&amp;#x7684;&amp;#x4E0A;&amp;#x4E0B;&amp;#x6587;&amp;#x5207;&amp;#x6362;&amp;#x548C;&amp;#x7ADE;&amp;#x4E89;&amp;#x6761;&amp;#x4EF6;&amp;#xFF0C;&amp;#x4E5F;&amp;#x4E0D;&amp;#x5B58;&amp;#x5728;&amp;#x591A;&amp;#x8FDB;&amp;#x7A0B;&amp;#x6216;&amp;#x8005;&amp;#x591A;&amp;#x7EBF;&amp;#x7A0B;&amp;#x5BFC;&amp;#x81F4;&amp;#x7684;&amp;#x5207;&amp;#x6362;&amp;#x800C;&amp;#x6D88;&amp;#x8017;CPU&amp;#xFF0C;&amp;#x4E0D;&amp;#x7528;&amp;#x53BB;&amp;#x8003;&amp;#x8651;&amp;#x5404;&amp;#x79CD;&amp;#x9501;&amp;#x7684;&amp;#x95EE;&amp;#x9898;&amp;#xFF0C;&amp;#x4E0D;&amp;#x5B58;&amp;#x5728;&amp;#x52A0;&amp;#x9501;&amp;#x91CA;&amp;#x653E;&amp;#x9501;&amp;#x64CD;&amp;#x4F5C;&amp;#xFF0C;&amp;#x6CA1;&amp;#x6709;&amp;#x56E0;&amp;#x4E3A;&amp;#x53EF;&amp;#x80FD;&amp;#x51FA;&amp;#x73B0;&amp;#x6B7B;&amp;#x9501;&amp;#x800C;&amp;#x5BFC;&amp;#x81F4;&amp;#x7684;&amp;#x6027;&amp;#x80FD;&amp;#x6D88;&amp;#x8017;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;C. &amp;#x91C7;&amp;#x7528;&amp;#x4E86;&lt;strong&gt;&amp;#x975E;&amp;#x963B;&amp;#x585E;I/O &amp;#x591A;&amp;#x8DEF;&amp;#x590D;&amp;#x7528;&amp;#x673A;&amp;#x5236;&lt;/strong&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="中间件" scheme="http://example.com/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
    <category term="redis" scheme="http://example.com/tags/redis/"/>
    
  </entry>
  
</feed>
