<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="一个八股文拾荒者&lt;br&gt;- A collector who is focuced on asshole-Java." />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>Infrastructure-AWS系列.2.部署EKS-部署Java微服务(使用ALB Ingress Controller) |  xugang.xie&#39;s blog</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <link rel="alternate" href="/atom.xml" title="xugang.xie's blog" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-18.D002.Infrastructure-AWS系列.2.部署EKS-部署Java微服务(使用ALB Ingress Controller)"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Infrastructure-AWS系列.2.部署EKS-部署Java微服务(使用ALB Ingress Controller)
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/08/20/18.D002.Infrastructure-AWS%E7%B3%BB%E5%88%97.2.%E9%83%A8%E7%BD%B2EKS-%E9%83%A8%E7%BD%B2Java%E5%BE%AE%E6%9C%8D%E5%8A%A1(%E4%BD%BF%E7%94%A8ALB%20Ingress%20Controller)/" class="article-date">
  <time datetime="2023-08-19T16:00:00.000Z" itemprop="datePublished">2023-08-20</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Infrastructure/">Infrastructure</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">9.9k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">61 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x5728;AWS&#x91CC;"><a href="#&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x5728;AWS&#x91CC;" class="headerlink" title="&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x5728;AWS&#x91CC;"></a>&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x5728;AWS&#x91CC;</h2><p>1.&#x521B;&#x5EFA;EKS&#x96C6;&#x7FA4;&#xFF1B;<br>2.EKS&#x96C6;&#x7FA4;&#x91CC;&#x521B;&#x5EFA;&#x8282;&#x70B9;&#x7EC4;&#xFF1B;<br>3.EKS&#x96C6;&#x7FA4;&#x521B;&#x5EFA;&#x670D;&#x52A1;namespace&#xFF1B;<br>4.&#x521B;&#x5EFA;ECR&#xFF1B;<br>5.&#x521B;&#x5EFA;SSL/TLS&#x8BC1;&#x4E66;&#xFF0C;&#x5E76; &#x901A;&#x8FC7; CNAME &#x65B9;&#x5F0F;&#xFF0C;&#x57DF;&#x540D;&#x89E3;&#x6790;&#x7ED1;&#x5B9A;&#xFF1B;<br>6.&#x90E8;&#x7F72;ALB Ingress Controller</p>
<span id="more"></span>

<h2 id="&#x53C2;&#x8003;&#x8D44;&#x6599;&#xFF1A;"><a href="#&#x53C2;&#x8003;&#x8D44;&#x6599;&#xFF1A;" class="headerlink" title="&#x53C2;&#x8003;&#x8D44;&#x6599;&#xFF1A;"></a>&#x53C2;&#x8003;&#x8D44;&#x6599;&#xFF1A;</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/network-load-balancing.html">Amazon EKS &#x4E0A;&#x7684;&#x7F51;&#x7EDC;&#x8D1F;&#x8F7D;&#x5747;&#x8861;</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/alb-ingress.html">Amazon EKS &#x4E0A;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8D1F;&#x8F7D;&#x5747;&#x8861;</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/aws-load-balancer-controller.html">&#x5B89;&#x88C5; AWS Load Balancer Controller &#x9644;&#x52A0;&#x7EC4;&#x4EF6;</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/458454919">AWS EKS &#x96C6;&#x7FA4;&#x914D;&#x7F6E;ALB Ingress</a></li>
</ul>
<h2 id="1-&#x73AF;&#x5883;"><a href="#1-&#x73AF;&#x5883;" class="headerlink" title="1.&#x73AF;&#x5883;"></a>1.&#x73AF;&#x5883;</h2><p>&#x516C;&#x6709;&#x4E91;&#xFF1A;AWS Cloud<br>&#x9879;&#x76EE;&#x540D;&#x79F0;&#xFF1A;mta-swappie<br>&#x9879;&#x76EE;&#x73AF;&#x5883;&#xFF1A;uat<br>&#x533A;&#x57DF;&#xFF1A; &#x4E9A;&#x592A;&#x5730;&#x533A;(&#x9999;&#x6E2F;) ap-east-1</p>
<p>IAM &#x6839;&#x8D26;&#x6237;&#x767B;&#x5F55;&#xFF1A; ???<br>&#x8D26;&#x6237;ID&#xFF1A;???<br>&#x7528;&#x6237;&#x540D;&#xFF1A;???<br>&#x5BC6;&#x7801;&#xFF1A;   ???</p>
<p>&#x8DF3;&#x677F;&#x673A;&#xFF1A;<code>10.112.36.9</code></p>
<h2 id="2-&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x5B89;&#x88C5;&#x547D;&#x4EE4;&#x884C;"><a href="#2-&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x5B89;&#x88C5;&#x547D;&#x4EE4;&#x884C;" class="headerlink" title="2.&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x5B89;&#x88C5;&#x547D;&#x4EE4;&#x884C;"></a>2.&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x5B89;&#x88C5;&#x547D;&#x4EE4;&#x884C;</h2><h3 id="1-AWS-CLI"><a href="#1-AWS-CLI" class="headerlink" title="1.AWS CLI"></a>1.AWS CLI</h3><p>&#x7565;</p>
<p>&#x5982;&#x679C;&#x8DF3;&#x677F;&#x673A;&#x4E0A;&#x5DF2;&#x7ECF;&#x6709;&#x4E86;aws&#x914D;&#x7F6E;&#x4E86;&#x3002;&#x518D;&#x914D;&#x7F6E;&#x4E2A;&#x7528;&#x6237;&#xFF0C;<a target="_blank" rel="noopener" href="https://www.jibing57.com/2017/10/24/how-to-use-aws-cli-with-multi-user/">&#x8DF3;&#x677F;&#x673A;&#x4E0A;&#x914D;&#x7F6E;&#x591A;&#x7528;&#x6237;</a></p>
<h4 id="1-aws&#x8D26;&#x6237;&#x4E2D;&#x83B7;&#x53D6;accessID&#x548C;accessKey"><a href="#1-aws&#x8D26;&#x6237;&#x4E2D;&#x83B7;&#x53D6;accessID&#x548C;accessKey" class="headerlink" title="1.aws&#x8D26;&#x6237;&#x4E2D;&#x83B7;&#x53D6;accessID&#x548C;accessKey"></a>1.aws&#x8D26;&#x6237;&#x4E2D;&#x83B7;&#x53D6;accessID&#x548C;accessKey</h4><p>&#x8FDB;&#x5165;&#x53F3;&#x4E0A;&#x65B9;<code>&#x8D26;&#x6237;</code>&#xFF0C;&#x4E0B;&#x62C9;&#xFF0C;&#x627E;&#x5230;&#xFF1A;<code>Security Credentials</code>&#xFF0C;&#x70B9;&#x51FB;&#x8FDB;&#x5165;<br>&#x627E;&#x5230;<code>&#x8BBF;&#x95EE;&#x5BC6;&#x94A5;</code>&#xFF0C;&#x521B;&#x5EFA;&#x8BBF;&#x95EE;&#x5BC6;&#x94A5;&#xFF0C;&#x6700;&#x540E;&#x5F97;&#x5230; <code>ACCESS ID</code> &#x548C; <code>Access Key</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws_access_key_id = &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br><span class="line">aws_secret_access_key = &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br></pre></td></tr></table></figure>

<h4 id="2-&#x914D;&#x7F6E;"><a href="#2-&#x914D;&#x7F6E;" class="headerlink" title="2.&#x914D;&#x7F6E;"></a>2.&#x914D;&#x7F6E;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">su - gitlab-runner</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ~/.aws</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll</span></span><br><span class="line">-rw------- 1 gitlab-runner gitlab-runner  43 Jul 20 14:06 config</span><br><span class="line">-rw------- 1 gitlab-runner gitlab-runner 116 Jul 20 14:06 credentials</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">aws configure --profile devops</span></span><br><span class="line"></span><br><span class="line">&#x4EA4;&#x4E92;&#x5F0F;</span><br><span class="line">AWS Access Key ID [None]: &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br><span class="line">AWS Secret Access Key [None]: &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br><span class="line">Default region name [None]: ap-east-1</span><br><span class="line">Default output format [None]: json</span><br></pre></td></tr></table></figure>

<h4 id="3-&#x67E5;&#x8BE2;&#x547D;&#x4EE4;"><a href="#3-&#x67E5;&#x8BE2;&#x547D;&#x4EE4;" class="headerlink" title="3.&#x67E5;&#x8BE2;&#x547D;&#x4EE4;"></a>3.&#x67E5;&#x8BE2;&#x547D;&#x4EE4;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> ~/.aws/config</span></span><br><span class="line">[default]</span><br><span class="line">region = ap-east-1</span><br><span class="line">output = json</span><br><span class="line">[profile devops]</span><br><span class="line">region = ap-east-1</span><br><span class="line">output = json</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> ~/.aws/credentials</span></span><br><span class="line">[default]</span><br><span class="line">aws_access_key_id = &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br><span class="line">aws_secret_access_key = &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br><span class="line">[devops]</span><br><span class="line">aws_access_key_id = &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br><span class="line">aws_secret_access_key = &#x4E0D;&#x4FBF;&#x5C55;&#x793A;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">aws configure list</span></span><br><span class="line">      Name                    Value             Type    Location</span><br><span class="line">      ----                    -----             ----    --------</span><br><span class="line">   profile                &lt;not set&gt;             None    None</span><br><span class="line">access_key     ****************7NE7 shared-credentials-file    </span><br><span class="line">secret_key     ****************t3Sk shared-credentials-file    </span><br><span class="line">    region                ap-east-1      config-file    ~/.aws/confi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">aws configure list-profiles</span></span><br><span class="line">default</span><br><span class="line">devops</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">aws sts get-caller-identity --profile devops</span></span><br><span class="line">{</span><br><span class="line">    &quot;UserId&quot;: &quot;AIDAV64JZYENGH2XWUBGE&quot;,</span><br><span class="line">    &quot;Account&quot;: &quot;409921503514&quot;,</span><br><span class="line">    &quot;Arn&quot;: &quot;arn:aws:iam::409921503514:user/devops&quot;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>


<h3 id="2-&#x5B89;&#x88C5;-eksctl"><a href="#2-&#x5B89;&#x88C5;-eksctl" class="headerlink" title="2.&#x5B89;&#x88C5; eksctl"></a>2.&#x5B89;&#x88C5; eksctl</h3><h4 id="1-&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;root&#x7528;&#x6237;&#x64CD;&#x4F5C;&#xFF1A;"><a href="#1-&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;root&#x7528;&#x6237;&#x64CD;&#x4F5C;&#xFF1A;" class="headerlink" title="1.&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;root&#x7528;&#x6237;&#x64CD;&#x4F5C;&#xFF1A;"></a>1.&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;<code>root</code>&#x7528;&#x6237;&#x64CD;&#x4F5C;&#xFF1A;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install dpkg</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dpkg --print-architecture</span></span><br><span class="line">amd64</span><br><span class="line"></span><br><span class="line">&#x5728; /etc/sudoers &#x6587;&#x4EF6;&#x91CC;&#xFF0C;&#x589E;&#x52A0;&#x7528;&#x6237; gitlab-runner &#x7684; sudo &#x65E0;&#x5BC6;&#x7801;&#x6743;&#x9650;</span><br><span class="line">TODO</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;-gitlab-runner-&#x7528;&#x6237;&#x64CD;&#x4F5C;&#x5B89;&#x88C5;eksctl&#xFF1A;"><a href="#2-&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;-gitlab-runner-&#x7528;&#x6237;&#x64CD;&#x4F5C;&#x5B89;&#x88C5;eksctl&#xFF1A;" class="headerlink" title="2.&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5; gitlab-runner &#x7528;&#x6237;&#x64CD;&#x4F5C;&#x5B89;&#x88C5;eksctl&#xFF1A;"></a>2.&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5; <code>gitlab-runner</code> &#x7528;&#x6237;&#x64CD;&#x4F5C;&#x5B89;&#x88C5;eksctl&#xFF1A;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">su - gitlab-runner</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">for</span> ARM systems, <span class="built_in">set</span> ARCH to: `arm64`, `armv6` or `armv7`</span></span><br><span class="line">ARCH=amd64</span><br><span class="line">PLATFORM=$(uname -s)_$ARCH</span><br><span class="line"></span><br><span class="line">curl -sLO &quot;https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_$PLATFORM.tar.gz&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(Optional) Verify checksum</span></span><br><span class="line">curl -sL &quot;https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_checksums.txt&quot; | grep $PLATFORM | sha256sum --check</span><br><span class="line"></span><br><span class="line">tar -xzf eksctl_$PLATFORM.tar.gz -C /tmp &amp;&amp; rm eksctl_$PLATFORM.tar.gz</span><br><span class="line"></span><br><span class="line">sudo mv /tmp/eksctl /usr/local/bin</span><br></pre></td></tr></table></figure>

<p>&#x9A8C;&#x8BC1;&#xFF1A;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">eksctl version</span></span><br><span class="line">0.150.0-dev</span><br></pre></td></tr></table></figure>


<h3 id="3-&#x5B89;&#x88C5;Helm"><a href="#3-&#x5B89;&#x88C5;Helm" class="headerlink" title="3.&#x5B89;&#x88C5;Helm"></a>3.&#x5B89;&#x88C5;Helm</h3><p><a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/intro/install/">https://helm.sh/zh/docs/intro/install/</a><br><a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/intro/quickstart/">https://helm.sh/zh/docs/intro/quickstart/</a></p>
<p>1.&#x5728;&#x8DF3;&#x677F;&#x673A;&#x4E2D;&#x4EE5;<code>gitlab-runner</code>&#x7528;&#x6237;&#x64CD;&#x4F5C;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">su - gitlab-runner</span></span><br><span class="line"></span><br><span class="line">&#x4F7F;&#x7528;&#x811A;&#x672C;&#x5B89;&#x88C5;</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> 700 get_helm.sh</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./get_helm.sh</span></span><br><span class="line">Downloading https://get.helm.sh/helm-v3.12.2-linux-amd64.tar.gz</span><br><span class="line">Verifying checksum... Done.</span><br><span class="line">Preparing to install helm into /usr/local/bin</span><br><span class="line">helm installed into /usr/local/bin/helm</span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x679C;&#x60F3;&#x76F4;&#x63A5;&#x6267;&#x884C;&#x5B89;&#x88C5;&#xFF0C;&#x8FD0;&#x884C;curl <code>https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm get -h</span></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>


<h3 id="4-&#x5B89;&#x88C5;kubectl"><a href="#4-&#x5B89;&#x88C5;kubectl" class="headerlink" title="4.&#x5B89;&#x88C5;kubectl"></a>4.&#x5B89;&#x88C5;kubectl</h3><p>&#x7565;</p>
<h2 id="3-&#x521B;&#x5EFA;EKS&#x96C6;&#x7FA4;"><a href="#3-&#x521B;&#x5EFA;EKS&#x96C6;&#x7FA4;" class="headerlink" title="3.&#x521B;&#x5EFA;EKS&#x96C6;&#x7FA4;"></a>3.&#x521B;&#x5EFA;EKS&#x96C6;&#x7FA4;</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//&#x5217;&#x51FA;&#x96C6;&#x7FA4;</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">eksctl get cluster --profile devops</span></span><br><span class="line">NAME    REGION          EKSCTL CREATED</span><br><span class="line">uat-hk  ap-east-1       False</span><br><span class="line"></span><br><span class="line">//&#x5217;&#x51FA;&#x8282;&#x70B9;&#x7EC4;</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">eksctl get nodegroup --cluster=uat-hk --profile devops</span></span><br><span class="line">CLUSTER NODEGROUP       STATUS  CREATED                 MIN SIZE        MAX SIZE        DESIRED CAPACITY        INSTANCE TYPE   IMAGE ID        ASG NAME    TYPE</span><br><span class="line">uat-hk  uat-hk-node     ACTIVE  2023-07-24T07:27:09Z    1               2               1                       t3.xlarge       AL2_x86_64      eks-uat-hk-node-58c4c365-b840-0fef-5ab1-21d130c433a7 managed</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="1-eksctl-&#x547D;&#x4EE4;&#x521B;&#x5EFA;EKS"><a href="#1-eksctl-&#x547D;&#x4EE4;&#x521B;&#x5EFA;EKS" class="headerlink" title="1.eksctl &#x547D;&#x4EE4;&#x521B;&#x5EFA;EKS"></a><del>1.eksctl &#x547D;&#x4EE4;&#x521B;&#x5EFA;EKS</del></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">eksctl create cluster \</span></span><br><span class="line"><span class="language-bash">    --name uat-mta-hk \</span></span><br><span class="line"><span class="language-bash">    --version 1.27 \</span></span><br><span class="line"><span class="language-bash">    --nodes=1 \</span></span><br><span class="line"><span class="language-bash">    --node-type=t3.xlarge</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>&#x8BE5;&#x8FC7;&#x7A0B;&#x53EF;&#x80FD;&#x9700;&#x8981; 15 &#x5230; 20 &#x5206;&#x949F;&#x3002;&#x521B;&#x5EFA;&#x96C6;&#x7FA4;&#x540E;&#xFF0C;&#x76F8;&#x5E94;&#x7684; Kubernetes&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x4F1A;&#x6DFB;&#x52A0;&#x5230; <code>~/.kube/config</code></p>
<p>EKS&#x63A7;&#x5236;&#x53F0;&#x770B;&#x5230;&#xFF0C;&#x521B;&#x5EFA;&#x4E86;cluster-name=<code>uat-mta-hk</code>&#xFF0C;node-group-name=<code>ng-973757bd</code></p>
<p>&#x66F4;&#x6539; .kube/config &#x6587;&#x4EF6;&#xFF1A;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mv ~/.kube/config ~/.kube/config-uat-aws-mta-hk-xxg</span><br></pre></td></tr></table></figure>

<p>&#x76EE;&#x524D;&#x8FD9;&#x4E2A;&#x9879;&#x76EE;&#x7684;kubeconfig&#x6587;&#x4EF6;&#x76EE;&#x5F55;&#xFF1A;<code>/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg</code></p>
<p><strong>&#x4E0D;&#x7528;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x521B;&#x5EFA;&#xFF0C;&#x56E0;&#x4E3A;&#x6CA1;&#x6CD5;&#x6307;&#x5B9A;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#x7684;&#x4E86;VPC&#xFF1A;<code>vpc-0c087f9ee1ce8c561</code>&#xFF0C;&#x6539;&#x7528;&#x63A7;&#x5236;&#x53F0;&#x521B;&#x5EFA;&#xFF0C;&#x5982;&#x4E0B;</strong></p>
<h3 id="2-&#x63A7;&#x5236;&#x53F0;&#x521B;&#x5EFA;EKS"><a href="#2-&#x63A7;&#x5236;&#x53F0;&#x521B;&#x5EFA;EKS" class="headerlink" title="2.&#x63A7;&#x5236;&#x53F0;&#x521B;&#x5EFA;EKS"></a>2.&#x63A7;&#x5236;&#x53F0;&#x521B;&#x5EFA;EKS</h3><h4 id="1-&#x521B;&#x5EFA;&#x96C6;&#x7FA4;-uat-mta-xxg"><a href="#1-&#x521B;&#x5EFA;&#x96C6;&#x7FA4;-uat-mta-xxg" class="headerlink" title="1.&#x521B;&#x5EFA;&#x96C6;&#x7FA4;: uat-mta-xxg"></a>1.&#x521B;&#x5EFA;&#x96C6;&#x7FA4;: uat-mta-xxg</h4><ol>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.1.png"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.2.png"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.3.png"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.4.png"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.5.png"></p>
</li>
<li><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x914D;&#x7F6E;&#x96C6;&#x7FA4;&#xFF1A;</span><br><span class="line">    &#x540D;&#x79F0;: uat-mta-xxg</span><br><span class="line">    Kubernetes &#x7248;&#x672C;: 1.27</span><br><span class="line">    &#x96C6;&#x7FA4;&#x670D;&#x52A1;&#x89D2;&#x8272;: arn:aws:iam::409921503514:role/eks-operator</span><br><span class="line">&#x6307;&#x5B9A;&#x8054;&#x7F51;&#xFF1A;</span><br><span class="line">    &#x9ED8;&#x8BA4; VPC&#x3001;3&#x4E2A;&#x5B50;&#x7F51;&#x3001;IPv4 &#x3001;&#x516C;&#x7F51;</span><br><span class="line">&#x914D;&#x7F6E;&#x65E5;&#x5FD7;&#x8BB0;&#x5F55;&#xFF1A;</span><br><span class="line">    &#x90FD;&#x52FE;&#x9009;</span><br><span class="line">&#x9009;&#x62E9;&#x63D2;&#x4EF6;&#xFF1A;</span><br><span class="line">    &#x7528;&#x9ED8;&#x8BA4;&#x7684;3&#x4E2A;</span><br><span class="line">&#x914D;&#x7F6E;&#x9009;&#x5B9A;&#x7684;&#x63D2;&#x4EF6;&#x8BBE;&#x7F6E;&#xFF1A;</span><br><span class="line">    &#x7528;&#x9ED8;&#x8BA4;&#x7684;&#x7248;&#x672C;</span><br><span class="line">&#x67E5;&#x770B;&#x548C;&#x521B;&#x5EFA;</span><br><span class="line">    &#x6700;&#x540E;&#x70B9;&#x51FB;&#x521B;&#x5EFA;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.6.png"></p>
<p>6.1<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.6.1.png"></p>
<p>6.2<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.6.2.png"></p>
<ol start="7">
<li><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-cluster/create-eks-cluster.7.png"></li>
</ol>
<h4 id="2-&#x4E3A;&#x96C6;&#x7FA4;&#xFF1A;uat-mta-xxg&#xFF0C;&#x751F;&#x6210;-kube-x2F-config-&#x6587;&#x4EF6;"><a href="#2-&#x4E3A;&#x96C6;&#x7FA4;&#xFF1A;uat-mta-xxg&#xFF0C;&#x751F;&#x6210;-kube-x2F-config-&#x6587;&#x4EF6;" class="headerlink" title="2.&#x4E3A;&#x96C6;&#x7FA4;&#xFF1A;uat-mta-xxg&#xFF0C;&#x751F;&#x6210; .kube/config &#x6587;&#x4EF6;"></a>2.&#x4E3A;&#x96C6;&#x7FA4;&#xFF1A;uat-mta-xxg&#xFF0C;&#x751F;&#x6210; .kube/config &#x6587;&#x4EF6;</h4><blockquote>
<p>&#x56E0;&#x4E3A; <code>~/.aws/config</code> &#x91CC;&#x6709;&#x591A;&#x4E2A;&#x7528;&#x6237;&#xFF0C;&#x6240;&#x4EE5;&#x4F7F;&#x7528; <code>--profile devops</code> &#x6307;&#x5B9A;&#x4F7F;&#x7528;<code>devops</code>&#x7528;&#x6237;</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aws eks update-kubeconfig --region ap-east-1 --name uat-mta-xxg --profile devops</span></span><br><span class="line">Added new context arn:aws:eks:ap-east-1:409921503514:cluster/uat-mta-xxg to /home/gitlab-runner/.kube/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mv</span> ~/.kube/config ~/.kube/config-uat-aws-mta-hk-xxg</span></span><br></pre></td></tr></table></figure>

<h4 id="3-&#x4E3A;&#x96C6;&#x7FA4;-uat-mta-xxg-&#x521B;&#x5EFA;&#x8282;&#x70B9;&#x7EC4;-uta-mta-xxg-nodegroup"><a href="#3-&#x4E3A;&#x96C6;&#x7FA4;-uat-mta-xxg-&#x521B;&#x5EFA;&#x8282;&#x70B9;&#x7EC4;-uta-mta-xxg-nodegroup" class="headerlink" title="3.&#x4E3A;&#x96C6;&#x7FA4;: uat-mta-xxg &#x521B;&#x5EFA;&#x8282;&#x70B9;&#x7EC4;: uta-mta-xxg-nodegroup"></a>3.&#x4E3A;&#x96C6;&#x7FA4;: uat-mta-xxg &#x521B;&#x5EFA;&#x8282;&#x70B9;&#x7EC4;: uta-mta-xxg-nodegroup</h4><ol>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.1.png"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.2.png"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.3.png"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.4.png"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.5.png"></p>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.5.1.png"></p>
<ol start="6">
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.6.png"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.7.1.png"></p>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.7.png"></p>
<ol start="8">
<li><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.8.png"></li>
</ol>
<p>&#x540D;&#x79F0;: uta-mta-xxg-nodegroup<br>&#x8282;&#x70B9; IAM &#x89D2;&#x8272;: arn:aws:iam::409921503514:role/AmazonEKSNodeRole</p>
<ol start="9">
<li><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.9.png"></li>
</ol>
<p>EC2&#x8282;&#x70B9;&#x5217;&#x8868;&#x4E2D;&#xFF0C;&#x65B0;&#x589E;&#x4E86;&#x4E2A;&#x8282;&#x70B9;&#xFF1A;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/eks-node/create-eks-node.10.png"></p>
<h3 id="3-kubectl&#x521B;&#x5EFA;namespace"><a href="#3-kubectl&#x521B;&#x5EFA;namespace" class="headerlink" title="3.kubectl&#x521B;&#x5EFA;namespace"></a>3.kubectl&#x521B;&#x5EFA;namespace</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg create namespace java-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg get namespace</span></span><br><span class="line"></span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   121m</span><br><span class="line">java-service      Active   4s</span><br><span class="line">kube-node-lease   Active   121m</span><br><span class="line">kube-public       Active   121m</span><br><span class="line">kube-system       Active   121m</span><br></pre></td></tr></table></figure>

<h3 id="4-&#x914D;&#x7F6E;AWS-ECR"><a href="#4-&#x914D;&#x7F6E;AWS-ECR" class="headerlink" title="4. &#x914D;&#x7F6E;AWS ECR"></a>4. &#x914D;&#x7F6E;AWS ECR</h3><h4 id="1-&#x521B;&#x5EFA;-ECR"><a href="#1-&#x521B;&#x5EFA;-ECR" class="headerlink" title="1.&#x521B;&#x5EFA; ECR"></a>1.&#x521B;&#x5EFA; ECR</h4><p>Amazon ECR &#x2013;&gt; Repository &#x2013;&gt; &#x521B;&#x5EFA;&#x5B58;&#x50A8;&#x5E93;: <code>prod-swappie</code><br>URI: <code>409921503514.dkr.ecr.eu-central-1.amazonaws.com/prod-swappie</code></p>
<h4 id="2-&#x751F;&#x6210;docker-auth&#x6587;&#x4EF6;"><a href="#2-&#x751F;&#x6210;docker-auth&#x6587;&#x4EF6;" class="headerlink" title="2.&#x751F;&#x6210;docker auth&#x6587;&#x4EF6;"></a>2.&#x751F;&#x6210;docker auth&#x6587;&#x4EF6;</h4><p>&#x76EE;&#x5F55; <code>~/.docker/config.json</code> &#x4E0B;&#x7684;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#xFF0C;&#x4E0D;&#x7528;&#x4E3B;&#x52A8;&#x751F;&#x6210;&#xFF0C;CI&#x811A;&#x672C;&#x91CC;&#x4F7F;&#x7528;&#x547D;&#x4EE4;&#xFF1A;<code>aws ecr get-login-password --region ${region} --profile devops | docker --config=/home/gitlab-runner/awsdocker login --username AWS --password-stdin ${dockerRepo}</code>&#xFF0C;&#x4F1A;&#x5728;&#x76EE;&#x5F55; <code>/home/gitlab-runner/awsdocker</code> &#x4E0B;&#x751F;&#x4EA7;&#x4E2A;&#x4E34;&#x65F6;&#x7684;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x6587;&#x4EF6;&#xFF1A;config.json&#xFF0C;&#x6709;&#x6548;&#x671F;&#x4E3A;12&#x5C0F;&#x65F6;</p>
<p><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/cli/latest/reference/ecr/get-login-password.html">get-login-password &#x8BF4;&#x660E;</a></p>
<p>&#x9879;&#x76EE;&#x4E2D;&#x7684;&#x547D;&#x4EE4;&#x4E3A;&#xFF1A;<code>aws ecr get-login-password --region ap-east-1 --profile devops | docker --config=/home/gitlab-runner/awsdocker login --username AWS --password-stdin 409921503514.dkr.ecr.ap-east-1.amazonaws.com</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /home/gitlab-runner/awsdocker/config.json</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="5-&#x5B89;&#x88C5;groovy"><a href="#5-&#x5B89;&#x88C5;groovy" class="headerlink" title="5.&#x5B89;&#x88C5;groovy"></a>5.&#x5B89;&#x88C5;groovy</h3><p>&#x7565;</p>
<h3 id="6-kubectl-&#x521B;&#x5EFA;&#x7EC4;&#x4EF6;"><a href="#6-kubectl-&#x521B;&#x5EFA;&#x7EC4;&#x4EF6;" class="headerlink" title="6.kubectl &#x521B;&#x5EFA;&#x7EC4;&#x4EF6;"></a>6.kubectl &#x521B;&#x5EFA;&#x7EC4;&#x4EF6;</h3><h4 id="1-&#x57DF;&#x540D;&#x521B;&#x5EFA;SSL-x2F-TLS&#x8BC1;&#x4E66;"><a href="#1-&#x57DF;&#x540D;&#x521B;&#x5EFA;SSL-x2F-TLS&#x8BC1;&#x4E66;" class="headerlink" title="1.&#x57DF;&#x540D;&#x521B;&#x5EFA;SSL/TLS&#x8BC1;&#x4E66;"></a>1.&#x57DF;&#x540D;&#x521B;&#x5EFA;SSL/TLS&#x8BC1;&#x4E66;</h4><p>&#x57DF;&#x540D;&#xFF1A;<code>mta-api.xiexugang.top</code></p>
<ol>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/acm/acm.1.png"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/acm/acm.2.png"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/acm/acm.3.png"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/acm/acm.4.png"></p>
</li>
</ol>
<p>&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;ACM&#x8BC1;&#x4E66;&#x540E;&#xFF0C;&#x5F97;&#x5230;&#xFF1A;<br>CNAME&#x540D;&#x79F0;=<code>_0c526310858e7611864e9a61ebf63585.mta-api.xiexugang.top.</code><br>CNAME&#x503C;=<code>_d25211e083127004cc043f3801a5e63e.vlvttdkdcz.acm-validations.aws.</code></p>
<p>&#x8FDB;&#x5165;&#x8FD9;&#x4E2A;&#x57DF;&#x540D;&#x7684;&#x6258;&#x7BA1;&#x5546;&#x540E;&#x53F0;&#xFF0C;&#x521B;&#x5EFA;&#x4E00;&#x6761;CNAME&#x8BB0;&#x5F55;&#xFF1A;<br><code>_0c526310858e7611864e9a61ebf63585.mta-api.xiexugang.top</code> CNAME <code>_d25211e083127004cc043f3801a5e63e.vlvttdkdcz.acm-validations.aws.</code></p>
<ol>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/acm/acm.5.png"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/acm/acm.6.png"></p>
</li>
</ol>
<p>&#x7136;&#x540E;&#x8FC7;&#x4E00;&#x4F1A;&#x513F;&#xFF08;1&#x5206;&#x949F;&#x4EE5;&#x5185;&#xFF09;&#xFF0C;&#x8FDB;&#x5165;ACM&#x4E2D;&#xFF0C;&#x67E5;&#x770B;&#x72B6;&#x6001;&#xFF1A;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/acm/acm.7.png"></p>
<h4 id="2-service"><a href="#2-service" class="headerlink" title="2.service"></a>2.service</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-uat-aws-xxg</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service apply -f service-clusterip-swappie.yaml</span></span><br><span class="line"></span><br><span class="line">service/mta-swappie-service created</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/create-eks-service.1.png"></p>
<p><code>service-clusterip-swappie.yaml</code> &#x5185;&#x5BB9;&#xFF1A;</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span>  <span class="comment"># &#x7C7B;&#x578B;&#x4E3A; Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mta-swappie-service</span>  <span class="comment"># Service &#x7684;&#x540D;&#x79F0;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># &#x6807;&#x7B7E;&#x9009;&#x62E9;&#x5668;&#xFF0C;&#x4F1A;&#x548C;&#x4E0A;&#x9762;&#x521B;&#x5EFA;&#x7684; deployment.yaml &#x7684; pod &#x5173;&#x8054;&#x8D77;&#x6765;</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">  <span class="attr">clusterIP:</span>  <span class="comment"># service &#x7684; ip &#x5730;&#x5740;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5199;&#xFF0C;&#x9ED8;&#x8BA4;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;,&#x6CE8;&#x610F;&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x4E0D;&#x80FD;&#x5199;&#xFF0C;&#x6709;&#x4E2A;&#x8303;&#x56F4;&#x7684;&#xFF0C;&#x6211;&#x7684;&#x662F; 172.31.0.0/16</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span> <span class="comment"># &#x7C7B;&#x578B;&#x4E3A; Service &#x7684; ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span>  <span class="comment"># Service &#x7AEF;&#x53E3;&#xFF0C;&#x81EA;&#x5B9A;&#x4E49;</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span> <span class="comment"># pod &#x7AEF;&#x53E3;&#xFF0C;&#x4E0D;&#x5199;&#x9ED8;&#x8BA4;&#x662F; 80</span></span><br></pre></td></tr></table></figure>

<p>&#x622A;&#x6B62;&#x5230;&#x76EE;&#x524D;&#xFF0C;&#x5DF2;&#x7ECF;&#x521B;&#x5EFA;&#x4E86; <code>namespace</code>&#x3001;<code>service</code>&#x3001;<code>SSL/TLS</code>&#x8BC1;&#x4E66;&#x3001;&#x57DF;&#x540D;&#x9A8C;&#x8BC1;&#xFF0C; &#x5269;&#x4E0B;&#x7684;<code>ingressClass</code>&#x3001;<code>ingress</code>&#x3001;<code>deployment</code>&#x3001;<code>pod</code>&#x76EE;&#x524D;&#x8FD8;&#x4E0D;&#x80FD;&#x521B;&#x5EFA;&#xFF0C;&#x9700;&#x8981;&#x5148;&#x90E8;&#x7F72;&#x597D;&#xFF1A;  <code>AWS Application Loand Balance Ingress Controller</code></p>
<h3 id="7-&#x90E8;&#x7F72;-AWS-ALB-Ingress-Controller"><a href="#7-&#x90E8;&#x7F72;-AWS-ALB-Ingress-Controller" class="headerlink" title="7. &#x90E8;&#x7F72; AWS ALB Ingress Controller"></a>7. &#x90E8;&#x7F72; AWS ALB Ingress Controller</h3><p>&#x53C2;&#x8003;:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/458454919">AWS EKS &#x96C6;&#x7FA4;&#x914D;&#x7F6E; ALB Ingress</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/aws-load-balancer-controller.html">&#x5B89;&#x88C5; AWS Load Balancer Controller &#x9644;&#x52A0;&#x7EC4;&#x4EF6;</a></li>
</ul>
<p>&#x6B65;&#x9AA4;1&#xFF1A;&#x521B;&#x5EFA;&#x7B56;&#x7565;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/458454919">AWS EKS &#x96C6;&#x7FA4;&#x914D;&#x7F6E; ALB Ingress</a></p>
<h4 id="1-&#x547D;&#x4EE4;&#x884C;&#x521B;&#x5EFA;&#x7B56;&#x7565;&#xFF1A;AWSLoadBalancerControllerIAMPolicyXxg"><a href="#1-&#x547D;&#x4EE4;&#x884C;&#x521B;&#x5EFA;&#x7B56;&#x7565;&#xFF1A;AWSLoadBalancerControllerIAMPolicyXxg" class="headerlink" title="1.&#x547D;&#x4EE4;&#x884C;&#x521B;&#x5EFA;&#x7B56;&#x7565;&#xFF1A;AWSLoadBalancerControllerIAMPolicyXxg"></a>1.&#x547D;&#x4EE4;&#x884C;&#x521B;&#x5EFA;&#x7B56;&#x7565;&#xFF1A;<code>AWSLoadBalancerControllerIAMPolicyXxg</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-uat-aws-xxg</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy.json</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aws iam create-policy \</span></span><br><span class="line"><span class="language-bash">    --policy-name AWSLoadBalancerControllerIAMPolicyXxg \</span></span><br><span class="line"><span class="language-bash">    --policy-document file://iam_policy.json</span></span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    &quot;Policy&quot;: {</span><br><span class="line">        &quot;PolicyName&quot;: &quot;AWSLoadBalancerControllerIAMPolicyXxg&quot;,</span><br><span class="line">        &quot;PolicyId&quot;: &quot;ANPAV64JZYENIBHOWCHEH&quot;,</span><br><span class="line">        &quot;Arn&quot;: &quot;arn:aws:iam::409921503514:policy/AWSLoadBalancerControllerIAMPolicyXxg&quot;,</span><br><span class="line">        &quot;Path&quot;: &quot;/&quot;,</span><br><span class="line">        &quot;DefaultVersionId&quot;: &quot;v1&quot;,</span><br><span class="line">        &quot;AttachmentCount&quot;: 0,</span><br><span class="line">        &quot;PermissionsBoundaryUsageCount&quot;: 0,</span><br><span class="line">        &quot;IsAttachable&quot;: true,</span><br><span class="line">        &quot;CreateDate&quot;: &quot;2023-07-29T07:53:33+00:00&quot;,</span><br><span class="line">        &quot;UpdateDate&quot;: &quot;2023-07-29T07:53:33+00:00&quot;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/eks-strategy.1.png)</span><br><span class="line"></span><br><span class="line">&#x4E0B;&#x9762;2&#x3001;3&#x3001;4 &#x6B65;&#x9AA4;&#xFF0C;&#x90FD;&#x53C2;&#x8003;&#xFF1A;[&#x5B89;&#x88C5; AWS Load Balancer Controller &#x9644;&#x52A0;&#x7EC4;&#x4EF6;](https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/aws-load-balancer-controller.html)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### 2.&#x521B;&#x5EFA; OpenID Connect (OIDC) provider</span></span></span><br><span class="line"></span><br><span class="line">1.&#x5728; AWS &#x4E2D;&#x63A7;&#x53F0;&#x9009;&#x62E9;&#x201C;EKS&#x201D;&#xFF0C;&#x8FDB;&#x5165; EKS &#x754C;&#x9762;&#xFF0C;&#x5728; Clusters &#x4E2D;&#x9009;&#x62E9;&#x4E0A;&#x6B21;&#x521B;&#x5EFA;&#x7684;&#x201C;</span><br><span class="line">uat-mta-xxg&#x201D;&#xFF0C;&#x5728; Details &#x90E8;&#x5206;&#xFF0C;&#x590D;&#x5236;&#x201C;OpenID Connect provider URL&#x201D;&#x7684;&#x5185;&#x5BB9;&#x5907;&#x7528;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/openid.1.png)</span><br><span class="line"></span><br><span class="line">OpenID Connect &#x63D0;&#x4F9B;&#x5546; URL:</span><br><span class="line">`https://oidc.eks.ap-east-1.amazonaws.com/id/9AE0C77523D6402B3CEF7103A22C1F84`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.&#x5728; AWS &#x4E2D;&#x63A7;&#x53F0;&#x9009;&#x62E9;&#x201C;IAM&#x201D;&#xFF0C;&#x8FDB;&#x5165; IAM &#x754C;&#x9762;&#xFF0C;&#x5728;&#x5DE6;&#x8FB9;&#x9009;&#x62E9;&#x201C;Identity Providers&#x201D;&#xFF0C;&#x70B9;&#x51FB;&#x201C;Add Provider&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/openid.2.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.&#x5728;&#x201C;Provider URL&#x201D;&#x4E2D;&#xFF0C;&#x7C98;&#x8D34;&#x4E0A;&#x4E00;&#x6B65;&#x4E2D;&#x201C;OpenID Connect provider URL&#x201D;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x7136;&#x540E;&#x70B9;&#x51FB;&#x201C;Get thumbprint&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/openid.3.png)</span><br><span class="line"></span><br><span class="line">4.&#x5728;&#x201C;Audience&#x201D;&#x4E2D;&#x6DFB;&#x52A0;&#x201C;sts.amazonaws.com&#x201D;&#xFF0C;&#x7136;&#x540E;&#x70B9;&#x51FB;&#x201C;Add provider&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/openid.4.png)</span><br><span class="line"></span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/openid.5.png)</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### 3.&#x521B;&#x5EFA;IAM Role</span></span></span><br><span class="line">1.&#x5728; AWS &#x4E2D;&#x63A7;&#x53F0;&#x9009;&#x62E9;&#x201C;IAM&#x201D;&#xFF0C;&#x8FDB;&#x5165; IAM &#x754C;&#x9762;&#xFF0C;&#x5728;&#x5DE6;&#x8FB9;&#x9009;&#x62E9;&#x201C;Roles&#x201D;&#xFF0C;&#x70B9;&#x51FB;&#x201C;Create Role&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.1.png)</span><br><span class="line"></span><br><span class="line">2.&#x5728;&#x201C;Select type of trusted entity&#x201D;&#x90E8;&#x5206;&#x9009;&#x62E9;&#x201C;Web identity&#x201D;&#xFF0C;&#x5728;&#x201C;Identity provider&#x201D;&#x4E2D;&#x9009;&#x62E9; EKS &#x4E2D;&#x201C;OpenID Connect provider URL&#x201D;&#x4E00;&#x6837;&#x7684; Ip&#xFF0C;&#x5728;&#x201C;Audience&#x201D;&#x4E2D;&#x9009;&#x62E9;&#x201C;sts.amazonaws.com&#x201D;&#xFF0C;&#x70B9;&#x51FB;&#x201C;Next: Permissions&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.2.png)</span><br><span class="line"></span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.3.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.&#x641C;&#x7D22;&#x4E0A;&#x9762;&#x521B;&#x5EFA;&#x7684; Policy &#x201C;AWSLoadBalancerControllerIAMPolicyXxg&#x201D;&#xFF0C;&#x52FE;&#x9009;&#x540E;&#x70B9;&#x51FB;&#x201C;Next: Tags&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.4.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.`&#x6DFB;&#x52A0;&#x6807;&#x7B7E;`&#xFF0C;&#x8FD9;&#x91CC;&#x65E0;&#x9700;&#x6DFB;&#x52A0;&#x4EC0;&#x4E48;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x7528;&#x70B9;</span><br><span class="line"></span><br><span class="line">5.&#x6DFB;&#x52A0; Role &#x540D;&#x79F0; `AmazonEKSLoadBalancerControllerRoleXxg` &#xFF0C;&#x70B9;&#x51FB;&#x201C;Create Role&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.5.png)</span><br><span class="line"></span><br><span class="line">&#x5168;&#x89C8;&#x4E00;&#x4E0B;&#xFF1A;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.6.png)</span><br><span class="line"></span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.7.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6.Role &#x201C;AmazonEKSLoadBalancerControllerRoleXxg&#x201D;&#x521B;&#x5EFA;&#x597D;&#x540E;&#xFF0C;&#x70B9;&#x51FB;&#x8FDB;&#x5165;&#xFF0C;&#x9009;&#x62E9;&#x201C;Trust relationships&#x201D;&#xFF0C;&#x70B9;&#x51FB;&#x201C;Edit trust relationship&#x201D;</span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.8.png)</span><br><span class="line"></span><br><span class="line">7.&#x7136;&#x540E;&#x627E;&#x5230;&#x4E0B;&#x9762;&#x5185;&#x5BB9;&#xFF0C;&#x5E76;&#x66FF;&#x6362;&#xFF1A;</span><br></pre></td></tr></table></figure>
<p>&#x539F;&#x59CB;&#x5185;&#x5BB9;&#xFF1A;oidc.eks.ap-east-1.amazonaws.com/id/9AE0C77523D6402B3CEF7103A22C1F84:aud&#x201D;: &#x201C;sts.amazonaws.com&#x201D;</p>
<p>&#x66FF;&#x6362;&#x6210;&#x4E3A;<br>oidc.eks.ap-east-1.amazonaws.com/id/9AE0C77523D6402B3CEF7103A22C1F84:sub&#x201D;: &#x201C;system:serviceaccount:kube-system:aws-load-balancer-controller&#x201D;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.9.png)</span><br><span class="line"></span><br><span class="line">![](https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/role.10.png)</span><br><span class="line"></span><br><span class="line">&#x89D2;&#x8272;--AmazonEKSLoadBalancerControllerRoleXxg--&#x4FE1;&#x4EFB;&#x5173;&#x7CFB;&#x91CC;&#x7684; &#x53EF;&#x4FE1;&#x5B9E;&#x4F53; &#x5B8C;&#x6574;&#x5185;&#x5BB9;&#xFF1A;</span><br><span class="line">```json</span><br><span class="line">{</span><br><span class="line">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">    &quot;Statement&quot;: [</span><br><span class="line">        {</span><br><span class="line">            &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line">            &quot;Principal&quot;: {</span><br><span class="line">                &quot;Federated&quot;: &quot;arn:aws:iam::409921503514:oidc-provider/oidc.eks.ap-east-1.amazonaws.com/id/9AE0C77523D6402B3CEF7103A22C1F84&quot;</span><br><span class="line">            },</span><br><span class="line">            &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;,</span><br><span class="line">            &quot;Condition&quot;: {</span><br><span class="line">                &quot;StringEquals&quot;: {</span><br><span class="line">                    &quot;oidc.eks.ap-east-1.amazonaws.com/id/9AE0C77523D6402B3CEF7103A22C1F84:sub&quot;: &quot;system:serviceaccount:kube-system:aws-load-balancer-controller&quot;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="4-&#x521B;&#x5EFA;iamserviceaccount"><a href="#4-&#x521B;&#x5EFA;iamserviceaccount" class="headerlink" title="4.&#x521B;&#x5EFA;iamserviceaccount"></a>4.&#x521B;&#x5EFA;iamserviceaccount</h4><p>1.&#x65B9;&#x5F0F;1&#xFF1A;&#x58F0;&#x660E;yaml&#x5E76;apply</p>
<p>&#x521B;&#x5EFA;<code>aws-load-balancer-controller-service-account.yaml</code>,&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">eks.amazonaws.com/role-arn:</span> <span class="string">arn:aws:iam::409921503514:role/AmazonEKSLoadBalancerControllerRoleXxg</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-uat-aws-xxg</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg apply -f aws-load-balancer-controller-service-account.yaml</span></span><br><span class="line"></span><br><span class="line">serviceaccount/aws-load-balancer-controller created</span><br></pre></td></tr></table></figure>

<p>&#x67E5;&#x770B;&#x521B;&#x5EFA;&#x7684; Serivce account &#x8BE6;&#x60C5;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg describe serviceaccount/aws-load-balancer-controller -n kube-system</span></span><br><span class="line"></span><br><span class="line">Name:                aws-load-balancer-controller</span><br><span class="line">Namespace:           kube-system</span><br><span class="line">Labels:              app.kubernetes.io/component=controller</span><br><span class="line">                     app.kubernetes.io/name=aws-load-balancer-controller</span><br><span class="line">Annotations:         eks.amazonaws.com/role-arn: arn:aws:iam::409921503514:role/AmazonEKSLoadBalancerControllerRoleXxg</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>2.&#x65B9;&#x5F0F;2&#xFF1A;eksctl&#x547D;&#x4EE4;&#x521B;&#x5EFA;&#xFF1A;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">eksctl create iamserviceaccount \</span></span><br><span class="line"><span class="language-bash">    --cluster=uat-mta-xxg \</span></span><br><span class="line"><span class="language-bash">    --namespace=kube-system \</span></span><br><span class="line"><span class="language-bash">    --name=aws-load-balancer-controller \</span></span><br><span class="line"><span class="language-bash">    --role-name AmazonEKSLoadBalancerControllerRoleXxg \</span></span><br><span class="line"><span class="language-bash">    --attach-policy-arn=arn:aws:iam::409921503514:policy/AWSLoadBalancerControllerIAMPolicyXxg \</span></span><br><span class="line"><span class="language-bash">    --approve</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>3.&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7528;&#x4E0B;&#x5217;&#x547D;&#x4EE4;&#x67E5;&#x770B;&#x662F;&#x5426;&#x5B58;&#x5728;&#x8001;&#x7684; AWS ALB Ingress Controller<br>&#x6309;&#x5B98;&#x65B9;&#x6587;&#x6863;&#x8BF4;&#x6CD5;&#xFF0C;&#x5728;&#x90E8;&#x7F72; AWS Load Balancer Controller &#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x5148;&#x628A;&#x8001;&#x7684; AWS ALB Ingress Controller &#x5220;&#x9664;&#x3002;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg get deployment -n kube-system alb-ingress-controller</span></span><br><span class="line"></span><br><span class="line">Error from server (NotFound): deployments.apps &quot;alb-ingress-controller&quot; not found</span><br></pre></td></tr></table></figure>

<p>&#x4EE5;&#x4E0A;&#x7ED3;&#x679C;&#x663E;&#x793A;&#x4E0D;&#x5B58;&#x5728;<br>&#x8BF4;&#x660E;&#xFF1A;&#x5982;&#x679C;&#x771F;&#x6709;&#x8001;&#x7684; AWS ALB Ingress Controller&#xFF0C;&#x53C2;&#x8003; <code>10. &#x5378;&#x8F7D; alb ingress controller</code></p>
<h4 id="5-&#x90E8;&#x7F72;-cert-manager&#xFF0C;-&#x5C06;&#x8BC1;&#x4E66;&#x914D;&#x7F6E;&#x6CE8;&#x5165;&#x5230;-webhook-&#x4E2D;"><a href="#5-&#x90E8;&#x7F72;-cert-manager&#xFF0C;-&#x5C06;&#x8BC1;&#x4E66;&#x914D;&#x7F6E;&#x6CE8;&#x5165;&#x5230;-webhook-&#x4E2D;" class="headerlink" title="5.&#x90E8;&#x7F72; cert-manager&#xFF0C; &#x5C06;&#x8BC1;&#x4E66;&#x914D;&#x7F6E;&#x6CE8;&#x5165;&#x5230; webhook &#x4E2D;"></a>5.&#x90E8;&#x7F72; cert-manager&#xFF0C; &#x5C06;&#x8BC1;&#x4E66;&#x914D;&#x7F6E;&#x6CE8;&#x5165;&#x5230; webhook &#x4E2D;</h4><blockquote>
<p>&#x6CE8;&#x610F;&#xFF1A;cert-manager.yaml &#x6587;&#x4EF6;&#x7248;&#x672C;&#x662F;&#xFF1A;v1.5.4&#xFF0C;&#x800C;&#x4E0D;&#x662F;v1.1.1&#xFF0C;&#x5426;&#x5219;&#x540E;&#x9762;&#x5728;&#x6267;&#x884C;v2_4_7_full.yaml&#x65F6;&#xFF0C;&#x4F1A;&#x62A5;&#x9519;</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg \</span></span><br><span class="line"><span class="language-bash">    apply \</span></span><br><span class="line"><span class="language-bash">    --validate=<span class="literal">false</span> \</span></span><br><span class="line"><span class="language-bash">    -f https://github.com/jetstack/cert-manager/releases/download/v1.5.4/cert-manager.yaml</span></span><br><span class="line"></span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/certificaterequests.cert-manager.io configured</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/certificates.cert-manager.io configured</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/challenges.acme.cert-manager.io configured</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterissuers.cert-manager.io configured</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/issuers.cert-manager.io configured</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/orders.acme.cert-manager.io configured</span><br><span class="line">namespace/cert-manager unchanged</span><br><span class="line">serviceaccount/cert-manager-cainjector configured</span><br><span class="line">serviceaccount/cert-manager configured</span><br><span class="line">serviceaccount/cert-manager-webhook configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-cainjector configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-issuers configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-clusterissuers configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-certificates configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-orders configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-challenges configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-ingress-shim configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-view configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-edit configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-approve:cert-manager-io created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-controller-certificatesigningrequests created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cert-manager-webhook:subjectaccessreviews created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-cainjector configured</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-issuers configured</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-clusterissuers configured</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-certificates configured</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-orders configured</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-challenges configured</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-ingress-shim configured</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-approve:cert-manager-io created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-certificatesigningrequests created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-webhook:subjectaccessreviews created</span><br><span class="line">role.rbac.authorization.k8s.io/cert-manager-cainjector:leaderelection configured</span><br><span class="line">role.rbac.authorization.k8s.io/cert-manager:leaderelection configured</span><br><span class="line">role.rbac.authorization.k8s.io/cert-manager-webhook:dynamic-serving configured</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/cert-manager-cainjector:leaderelection configured</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/cert-manager:leaderelection configured</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/cert-manager-webhook:dynamic-serving configured</span><br><span class="line">service/cert-manager configured</span><br><span class="line">service/cert-manager-webhook configured</span><br><span class="line">deployment.apps/cert-manager-cainjector configured</span><br><span class="line">deployment.apps/cert-manager configured</span><br><span class="line">deployment.apps/cert-manager-webhook configured</span><br><span class="line">mutatingwebhookconfiguration.admissionregistration.k8s.io/cert-manager-webhook configured</span><br><span class="line">validatingwebhookconfiguration.admissionregistration.k8s.io/cert-manager-webhook configured</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&#x6216;&#x8005;&#xFF0C;&#x4E0B;&#x8F7D;&#x4E0B;&#x6765;&#xFF0C;&#x518D;apply</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://github.com/jetstack/cert-manager/releases/download/v1.5.4/cert-manager.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg apply -f cert-manager.yaml</span></span><br></pre></td></tr></table></figure>


<h4 id="6-&#x5B89;&#x88C5;-aws-load-balancer-controller&#xFF1A;"><a href="#6-&#x5B89;&#x88C5;-aws-load-balancer-controller&#xFF1A;" class="headerlink" title="6.&#x5B89;&#x88C5; aws-load-balancer-controller&#xFF1A;"></a>6.&#x5B89;&#x88C5; aws-load-balancer-controller&#xFF1A;</h4><p>&#x8FD9;&#x91CC;&#x8981;&#x53C2;&#x8003;&#xFF1A;<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/aws-load-balancer-controller.html">&#x5B89;&#x88C5; AWS Load Balancer Controller &#x9644;&#x52A0;&#x7EC4;&#x4EF6;</a></p>
<p>1.&#x4E0B;&#x8F7D;v2.4.7/v2_4_7_full.yaml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-uat-aws-xxg</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl -Lo v2_4_7_full.yaml https://github.com/kubernetes-sigs/aws-load-balancer-controller/releases/download/v2.4.7/v2_4_7_full.yaml</span></span><br></pre></td></tr></table></figure>

<p>2.&#x5982;&#x679C;&#x60A8;&#x5DF2;&#x4E0B;&#x8F7D; <code>v2_4_7_full.yaml</code> &#x6587;&#x4EF6;&#xFF0C;&#x8BF7;&#x8FD0;&#x884C;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x4EE5;&#x5220;&#x9664;&#x6E05;&#x5355;&#x4E2D;&#x7684; ServiceAccount &#x90E8;&#x5206;&#xFF08;&#x7B2C;561~569&#x884C;&#xFF09;&#x3002;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i.bak -e &apos;561,569d&apos; ./v2_4_7_full.yaml</span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x679C;&#x60A8;&#x5DF2;&#x4E0B;&#x8F7D;&#x5176;&#x4ED6;&#x6587;&#x4EF6;&#x7248;&#x672C;&#xFF0C;&#x8BF7;&#x5728;&#x7F16;&#x8F91;&#x5668;&#x4E2D;&#x6253;&#x5F00;&#x6B64;&#x6587;&#x4EF6;&#xFF0C;&#x7136;&#x540E;&#x5220;&#x9664;&#x4EE5;&#x4E0B;&#x884C;&#x3002;</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<p>3.&#x8BF7;&#x5C06; <code>my-cluster</code> &#x66FF;&#x6362;&#x4E3A;&#x60A8;&#x7684;&#x96C6;&#x7FA4;&#x540D;&#x79F0;&#xFF0C;&#x5C06;&#x6587;&#x4EF6;&#x7684; Deployment spec &#x90E8;&#x5206;&#x4E2D;&#x7684; your-cluster-name &#x66FF;&#x6362;&#x4E3A;&#x60A8;&#x7684;&#x96C6;&#x7FA4;&#x540D;&#x79F0;&#x3002;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i.bak -e &apos;s|your-cluster-name|uat-hk|&apos; ./v2_4_7_full.yaml</span><br><span class="line"></span><br><span class="line">sed -i.bak -e &apos;s|your-cluster-name|uat-mta-xxg|&apos; ./v2_4_7_full.yaml</span><br></pre></td></tr></table></figure>

<p>4.&#x5E94;&#x7528;&#x5E76;&#x751F;&#x6548;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg apply -f v2_4_7_full.yaml</span></span><br><span class="line"></span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ingressclassparams.elbv2.k8s.aws unchanged</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/targetgroupbindings.elbv2.k8s.aws unchanged</span><br><span class="line">role.rbac.authorization.k8s.io/aws-load-balancer-controller-leader-election-role unchanged</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/aws-load-balancer-controller-role configured</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/aws-load-balancer-controller-leader-election-rolebinding unchanged</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/aws-load-balancer-controller-rolebinding unchanged</span><br><span class="line">service/aws-load-balancer-webhook-service unchanged</span><br><span class="line">deployment.apps/aws-load-balancer-controller created</span><br><span class="line">certificate.cert-manager.io/aws-load-balancer-serving-cert created</span><br><span class="line">issuer.cert-manager.io/aws-load-balancer-selfsigned-issuer created</span><br><span class="line">mutatingwebhookconfiguration.admissionregistration.k8s.io/aws-load-balancer-webhook configured</span><br><span class="line">validatingwebhookconfiguration.admissionregistration.k8s.io/aws-load-balancer-webhook configured</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="7-&#x5B89;&#x88C5;ingressClass"><a href="#7-&#x5B89;&#x88C5;ingressClass" class="headerlink" title="7.&#x5B89;&#x88C5;ingressClass"></a>7.&#x5B89;&#x88C5;ingressClass</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl -Lo v2_4_7_ingclass.yaml https://github.com/kubernetes-sigs/aws-load-balancer-controller/releases/download/v2.4.7/v2_4_7_ingclass.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg apply -f v2_4_7_ingclass.yaml</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&#x6216;&#x8005;&#xFF0C;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#x81EA;&#x5DF1;&#x5B9A;&#x4E49;&#x7684;&#x7B80;&#x5316;&#x7248;&#x7684;ingressClass&#xFF0C;&#x4E0D;&#x5EFA;&#x8BAE;:<br><code>ingress-class-alb.yaml</code> &#x5185;&#x5BB9;&#xFF1A;</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">controller:</span> <span class="string">ingress.k8s.aws/alb</span></span><br></pre></td></tr></table></figure>

<h4 id="8-&#x9A8C;&#x8BC1;&#x63A7;&#x5236;&#x5668;&#x662F;&#x5426;&#x5DF2;&#x5B89;&#x88C5;"><a href="#8-&#x9A8C;&#x8BC1;&#x63A7;&#x5236;&#x5668;&#x662F;&#x5426;&#x5DF2;&#x5B89;&#x88C5;" class="headerlink" title="8.&#x9A8C;&#x8BC1;&#x63A7;&#x5236;&#x5668;&#x662F;&#x5426;&#x5DF2;&#x5B89;&#x88C5;"></a>8.&#x9A8C;&#x8BC1;&#x63A7;&#x5236;&#x5668;&#x662F;&#x5426;&#x5DF2;&#x5B89;&#x88C5;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n kube-system get deployment/aws-load-balancer-controller</span></span><br><span class="line"></span><br><span class="line">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">aws-load-balancer-controller   0/1     0            0           12m</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/alb.2.png"></p>
<h4 id="8-1-EKS-&#x8282;&#x70B9;&#x6240;&#x5728;&#x7684;3&#x4E2A;&#x5B50;&#x7F51;&#xFF0C;&#x5206;&#x522B;&#x6253;&#x6807;&#x7B7E;"><a href="#8-1-EKS-&#x8282;&#x70B9;&#x6240;&#x5728;&#x7684;3&#x4E2A;&#x5B50;&#x7F51;&#xFF0C;&#x5206;&#x522B;&#x6253;&#x6807;&#x7B7E;" class="headerlink" title="8.1 EKS &#x8282;&#x70B9;&#x6240;&#x5728;&#x7684;3&#x4E2A;&#x5B50;&#x7F51;&#xFF0C;&#x5206;&#x522B;&#x6253;&#x6807;&#x7B7E;"></a>8.1 EKS &#x8282;&#x70B9;&#x6240;&#x5728;&#x7684;3&#x4E2A;&#x5B50;&#x7F51;&#xFF0C;&#x5206;&#x522B;&#x6253;&#x6807;&#x7B7E;</h4><p>EKS &#x8282;&#x70B9;&#x6240;&#x5728;&#x7684;3&#x4E2A;&#x5B50;&#x7F51;&#xFF0C;&#x90FD;&#x8981;&#x5206;&#x522B;&#x8FDB;&#x5165;&#x6807;&#x7B7E;&#xFF0C;&#x6DFB;&#x52A0;&#x6807;&#x7B7E;&#xFF1A;&#x952E;<code>kubernetes.io/role/elb</code> &#x503C;<code>1</code>&#xFF0C;&#x5426;&#x5219;ingress&#x4F1A;&#x521B;&#x5EFA;&#x5931;&#x8D25;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ingress&#x91CC;&#x7684;&#x62A5;&#x9519;&#xFF1A;</span><br><span class="line">Failed build model due to couldn&apos;t auto-discover subnets: unable to discover at least one subnet</span><br><span class="line"></span><br><span class="line">failed load groupID due to invalid ingress class: IngressClass.networking.k8s.io &quot;alb&quot; not found</span><br></pre></td></tr></table></figure>

<h4 id="9-&#x5B89;&#x88C5;ingress&#x5E76;&#x751F;&#x6548;"><a href="#9-&#x5B89;&#x88C5;ingress&#x5E76;&#x751F;&#x6548;" class="headerlink" title="9.&#x5B89;&#x88C5;ingress&#x5E76;&#x751F;&#x6548;"></a>9.&#x5B89;&#x88C5;ingress&#x5E76;&#x751F;&#x6548;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg apply -f ingress-uat.yaml</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ingress-uat.yaml &#x5185;&#x5BB9;:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mta-swappie-backend-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># Ingress Core Settings</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/scheme:</span> <span class="string">&apos;internet-facing&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/target-type:</span> <span class="string">&apos;ip&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/load-balancer-attributes:</span> <span class="string">idle_timeout.timeout_seconds=400</span></span><br><span class="line">    <span class="comment"># Health Check Settings</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/healthcheck-protocol:</span> <span class="string">&apos;HTTP&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/healthcheck-path:</span> <span class="string">&apos;/mta-swappie-service/health/check&apos;</span></span><br><span class="line">    <span class="comment">## SSL Settings</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/listen-ports:</span> <span class="string">&apos;[{&quot;HTTP&quot;: 80}, {&quot;HTTPS&quot;: 443}]&apos;</span></span><br><span class="line">    <span class="comment"># alb.ingress.kubernetes.io/certificate-arn: &apos;arn:aws:acm:eu-central-1:409921503514:certificate/7f065637-1580-47e0-8d1e-0f4340ab83d4&apos;</span></span><br><span class="line">    <span class="comment"># redirect all HTTP to HTTPS</span></span><br><span class="line">    <span class="comment"># alb.ingress.kubernetes.io/actions.ssl-redirect: &apos;{&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;: { &quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;}}&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&apos;443&apos;</span>    </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">alb</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span>  <span class="string">mta-api.xiexugang.top</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/mta-swappie-service</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>ingress &#x7684;&#x51E0;&#x4E2A;&#x6CE8;&#x89E3;&#x914D;&#x7F6E;&#xFF0C;&#x53C2;&#x8003;&#x81EA;&#xFF1A;<a target="_blank" rel="noopener" href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/ingress/annotations/"></a></p>
<ul>
<li><p>ingress &#x8D85;&#x65F6;&#x914D;&#x7F6E;&#x6CE8;&#x89E3;&#xFF1A;<br><code>alb.ingress.kubernetes.io/load-balancer-attributes: idle_timeout.timeout_seconds=400</code></p>
</li>
<li><p>http&#x91CD;&#x5B9A;&#x5411;&#x5230;https<br><code>alb.ingress.kubernetes.io/ssl-redirect: &apos;443&apos;</code></p>
</li>
</ul>
<h4 id="10-&#x6267;&#x884C;gitlab&#x4E2D;&#x7684;pipeline"><a href="#10-&#x6267;&#x884C;gitlab&#x4E2D;&#x7684;pipeline" class="headerlink" title="10.&#x6267;&#x884C;gitlab&#x4E2D;&#x7684;pipeline"></a>10.&#x6267;&#x884C;gitlab&#x4E2D;&#x7684;pipeline</h4><p>gitlab&#x4E2D;&#x7684;pipeline&#xFF0C;&#x4ECE;&#x800C;&#x80FD;&#x521B;&#x5EFA; deployment</p>
<h4 id="11-&#x5230;-EC2-gt-Load-balancers-&#x91CC;&#x770B;&#x770B;&#xFF0C;&#x4F1A;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x751F;&#x6210;-ALB-Ingress-Controller"><a href="#11-&#x5230;-EC2-gt-Load-balancers-&#x91CC;&#x770B;&#x770B;&#xFF0C;&#x4F1A;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x751F;&#x6210;-ALB-Ingress-Controller" class="headerlink" title="11.&#x5230; EC2 --&gt; Load balancers &#x91CC;&#x770B;&#x770B;&#xFF0C;&#x4F1A;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x751F;&#x6210; ALB Ingress Controller:"></a>11.&#x5230; <code>EC2 --&gt; Load balancers</code> &#x91CC;&#x770B;&#x770B;&#xFF0C;&#x4F1A;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x751F;&#x6210; ALB Ingress Controller:</h4><p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/alb.3.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/alb.4.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/alb.5.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/alb.6.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/alb.7.png"></p>
<blockquote>
<p>&#x8FD9;&#x91CC;&#x6709;&#x4E2A;&#x5751;:<br>&#x5230;&#x5173;&#x8054;&#x7684;<code>Target Group</code>&#x4E2D;&#xFF0C;&#x770B;&#x4E0B; <code>Registered targets</code>&#xFF0C;Zone&#x662F; <code>ap-east-1c</code> &#x7684;&#xFF0C;&#x7136;&#x800C;ALB&#x4E2D;&#x7684;&#x53EF;&#x7528;&#x533A;&#x53EA;&#x6709; <code>ap-east-1a</code> &#x548C; <code>ap-east-1b</code> &#xFF0C;&#x6CA1;&#x6709; <code>ap-east-1c</code></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.1.png"></p>
<p>&#x5230;ALB&#x4E2D;&#xFF0C;&#x624B;&#x52A8;&#x6DFB;&#x52A0;&#x4E0B;&#xFF0C;&#x5426;&#x5219;&#x548C;&#x8FD9;&#x4E2A;LB&#x5173;&#x8054;&#x7684;Target Group&#x4E0B;&#x7684; Health checks &#x4F1A;&#x5931;&#x8D25;</p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.2.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.3.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.4.png"></p>
<p>&#x6DFB;&#x52A0;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x518D;&#x5230;&#x5173;&#x8054;&#x7684;Target Group&#x4E2D;&#xFF0C;&#x4FEE;&#x6539;&#x4E0B; Health Checks&#x7684;Path<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.6.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.7.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.8.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/targetgroup.9.png"></p>
<h4 id="12-&#x914D;&#x7F6E;&#x4E8C;&#x7EA7;&#x57DF;&#x540D;CNAME&#x5230;ALB&#x7684;&#x57DF;&#x540D;"><a href="#12-&#x914D;&#x7F6E;&#x4E8C;&#x7EA7;&#x57DF;&#x540D;CNAME&#x5230;ALB&#x7684;&#x57DF;&#x540D;" class="headerlink" title="12.&#x914D;&#x7F6E;&#x4E8C;&#x7EA7;&#x57DF;&#x540D;CNAME&#x5230;ALB&#x7684;&#x57DF;&#x540D;"></a>12.&#x914D;&#x7F6E;&#x4E8C;&#x7EA7;&#x57DF;&#x540D;CNAME&#x5230;ALB&#x7684;&#x57DF;&#x540D;</h4><p>&#x4E8C;&#x7EA7;&#x57DF;&#x540D;&#xFF1A;<code>mta-api.xiexugang.top</code><br>ALB&#x7684;&#x57DF;&#x540D;: <code>k8s-javaserv-mtaswapp-591beea7f0-1776529407.ap-east-1.elb.amazonaws.com</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/alb.domain.bind.1.png"></p>
<h4 id="13-&#x63A5;&#x53E3;&#x8C03;&#x7528;&#x9A8C;&#x8BC1;"><a href="#13-&#x63A5;&#x53E3;&#x8C03;&#x7528;&#x9A8C;&#x8BC1;" class="headerlink" title="13.&#x63A5;&#x53E3;&#x8C03;&#x7528;&#x9A8C;&#x8BC1;"></a>13.&#x63A5;&#x53E3;&#x8C03;&#x7528;&#x9A8C;&#x8BC1;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ping mta-api.xiexugang.top</span><br><span class="line"></span><br><span class="line">Pinging k8s-javaserv-mtaswapp-591beea7f0-1776529407.ap-east-1.elb.amazonaws.com [18.166.5.81] with 32 bytes of data:</span><br><span class="line">Reply from 18.166.5.81: bytes=32 time=38ms TTL=239</span><br><span class="line">Reply from 18.166.5.81: bytes=32 time=36ms TTL=239</span><br><span class="line">Reply from 18.166.5.81: bytes=32 time=35ms TTL=239</span><br><span class="line">Reply from 18.166.5.81: bytes=32 time=35ms TTL=239</span><br><span class="line"></span><br><span class="line">Ping statistics for 18.166.5.81:</span><br><span class="line">    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),</span><br><span class="line">Approximate round trip times in milli-seconds:</span><br><span class="line">    Minimum = 35ms, Maximum = 38ms, Average = 36ms</span><br></pre></td></tr></table></figure>

<p>&#x6D4F;&#x89C8;&#x5668;&#x91CC;&#x8F93;&#x5165;&#xFF1A;<code>https://mta-api.xiexugang.top/mta-swappie-service/health/check</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/18.D002.Infrastructure-AWS.2.2.%E9%83%A8%E7%BD%B2EKS-%E4%BD%BF%E7%94%A8ALB-Ingress-Controller/aws-uat-deploy-eks/alb/api-test.png"></p>
<h4 id="14-&#x5B89;&#x88C5;cloudwatch-logs&#x4EE3;&#x7406;"><a href="#14-&#x5B89;&#x88C5;cloudwatch-logs&#x4EE3;&#x7406;" class="headerlink" title="14.&#x5B89;&#x88C5;cloudwatch logs&#x4EE3;&#x7406;"></a>14.&#x5B89;&#x88C5;cloudwatch logs&#x4EE3;&#x7406;</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/236ead86096f">AWS &#x4F7F;&#x7528; CloudWatch Logs &#x6536;&#x96C6;&#x65E5;&#x5FD7;</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AmazonCloudWatch/latest/logs/QuickStartEC2Instance.html">&#x5FEB;&#x901F;&#x5165;&#x95E8;&#xFF1A;&#x5728;&#x8FD0;&#x884C;&#x7684; EC2 Linux &#x5B9E;&#x4F8B;&#x4E0A;&#x5B89;&#x88C5;&#x548C;&#x914D;&#x7F6E; CloudWatch Logs &#x4EE3;&#x7406;</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AmazonCloudWatch/latest/logs/AgentReference.html">CloudWatch Logs &#x4EE3;&#x7406;&#x53C2;&#x8003;</a></li>
</ul>
<h5 id="1-&#x524D;&#x63D0;&#xFF1A;"><a href="#1-&#x524D;&#x63D0;&#xFF1A;" class="headerlink" title="1.&#x524D;&#x63D0;&#xFF1A;"></a>1.&#x524D;&#x63D0;&#xFF1A;</h5><p>&#x76EE;&#x524D;k8s&#x96C6;&#x7FA4;&#x4E2D;&#x6709;2&#x4E2A;&#x8282;&#x70B9;&#xFF1A;<code>i-04ccf53f8f5138168</code> &#x548C; <code>i-0f332710992b9de95</code>&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x8282;&#x70B9;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x7684;&#x516C;&#x94A5;&#x6587;&#x4EF6;&#x90FD;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#xFF1A;<code>eks-node-rsa-pair.pem</code></p>
<p>i-04ccf53f8f5138168 &#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x547D;&#x4EE4;&#xFF1A;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i &quot;eks-node-rsa-pair.pem&quot; ec2-user@ec2-35-158-45-195.eu-central-1.compute.amazonaws.com</span><br></pre></td></tr></table></figure>

<p>i-0f332710992b9de95 &#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x547D;&#x4EE4;&#xFF1A;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i &quot;eks-node-rsa-pair.pem&quot; ec2-user@ec2-3-122-95-149.eu-central-1.compute.amazonaws.com</span><br></pre></td></tr></table></figure>


<h5 id="1-&#x5206;&#x522B;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x4E0A;&#x9762;2&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x6267;&#x884C;&#x5982;&#x4E0B;&#x547D;&#x4EE4;"><a href="#1-&#x5206;&#x522B;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x4E0A;&#x9762;2&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x6267;&#x884C;&#x5982;&#x4E0B;&#x547D;&#x4EE4;" class="headerlink" title="1.&#x5206;&#x522B;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x4E0A;&#x9762;2&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x6267;&#x884C;&#x5982;&#x4E0B;&#x547D;&#x4EE4;"></a>1.&#x5206;&#x522B;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x4E0A;&#x9762;2&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x6267;&#x884C;&#x5982;&#x4E0B;&#x547D;&#x4EE4;</h5><h5 id="2-&#x4EE5;&#x8FDC;&#x7A0B;&#x767B;&#x5F55;&#xFF1A;i-04ccf53f8f5138168-&#x4E3A;&#x4F8B;&#xFF1A;"><a href="#2-&#x4EE5;&#x8FDC;&#x7A0B;&#x767B;&#x5F55;&#xFF1A;i-04ccf53f8f5138168-&#x4E3A;&#x4F8B;&#xFF1A;" class="headerlink" title="2.&#x4EE5;&#x8FDC;&#x7A0B;&#x767B;&#x5F55;&#xFF1A;i-04ccf53f8f5138168  &#x4E3A;&#x4F8B;&#xFF1A;"></a>2.&#x4EE5;&#x8FDC;&#x7A0B;&#x767B;&#x5F55;&#xFF1A;i-04ccf53f8f5138168  &#x4E3A;&#x4F8B;&#xFF1A;</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo -i</span><br><span class="line">yum update -y</span><br></pre></td></tr></table></figure>
<p>&#x7F16;&#x8F91;&#xFF1A; <code>/etc/awslogs/awslogs.conf</code><br>&#x53BB;&#x9664;&#x6700;&#x540E;&#x90E8;&#x5206;&#x7684; [/var/logs/??]&#x90E8;&#x5206;&#xFF0C;&#x52A0;&#x4E0A;&#x5982;&#x4E0B;:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[logstream/request]</span><br><span class="line">datetime_format = %b %d %H:%M:%S</span><br><span class="line">file = /var/log/ahs-pods/mount/containers/mta-swappie-service/request/info.log</span><br><span class="line">buffer_duration = 5000</span><br><span class="line">log_stream_name = mta_swappie_service_prod_request_{instance_id}</span><br><span class="line">initial_position = start_of_file</span><br><span class="line">log_group_name = mta-swappie-service-request-log</span><br><span class="line">multi_line_start_pattern = {datetime_format}</span><br><span class="line">time_zone = UTC</span><br><span class="line">encoding = utf_8</span><br><span class="line"></span><br><span class="line">[logstream/info]</span><br><span class="line">datetime_format = %b %d %H:%M:%S</span><br><span class="line">file = /var/log/ahs-pods/mount/containers/mta-swappie-service/info/info.log</span><br><span class="line">buffer_duration = 5000</span><br><span class="line">log_stream_name = mta_swappie_service_prod_info_{instance_id}</span><br><span class="line">initial_position = start_of_file</span><br><span class="line">log_group_name = mta-swappie-service-info-log</span><br><span class="line">time_zone = UTC</span><br><span class="line">encoding = utf_8</span><br><span class="line"></span><br><span class="line">[logstream/warn]</span><br><span class="line">datetime_format = %b %d %H:%M:%S</span><br><span class="line">file = /var/log/ahs-pods/mount/containers/mta-swappie-service/warn/info.log</span><br><span class="line">buffer_duration = 5000</span><br><span class="line">log_stream_name = mta_swappie_service_prod_warn_{instance_id}</span><br><span class="line">initial_position = start_of_file</span><br><span class="line">log_group_name = mta-swappie-service-warn-log</span><br><span class="line">time_zone = UTC</span><br><span class="line">encoding = utf_8</span><br><span class="line"></span><br><span class="line">[logstream/error]</span><br><span class="line">datetime_format = %b %d %H:%M:%S</span><br><span class="line">file = /var/log/ahs-pods/mount/containers/mta-swappie-service/error/error.log</span><br><span class="line">buffer_duration = 5000</span><br><span class="line">log_stream_name = mta_swappie_service_prod_error_{instance_id}</span><br><span class="line">initial_position = start_of_file</span><br><span class="line">log_group_name = mta-swappie-service-error-log</span><br><span class="line">time_zone = UTC</span><br><span class="line">encoding = utf_8</span><br></pre></td></tr></table></figure>

<p>:wq &#x4FDD;&#x5B58;</p>
<p>&#x7F16;&#x8F91;&#xFF1A; <code>/etc/awslogs/awscli.conf</code><br><code>region = us-east-1</code> &#x6539;&#x6210;&#xFF1A; <code>region = eu-central-1</code></p>
<p>:wq &#x4FDD;&#x5B58;</p>
<p>&#x8BBE;&#x7F6E;&#x6210;&#x5F00;&#x673A;&#x542F;&#x542F;&#x52A8;&#xFF1A;<br><code>systemctl enable awslogsd.service</code></p>
<p>&#x542F;&#x52A8;&#xFF1A;<br><code>systemctl start awslogsd</code></p>
<p>&#x67E5;&#x770B;&#xFF1A;<br><code>systemctl status awslogsd</code></p>
<p>&#x5B9E;&#x65F6;&#x5237;&#x5C4F;&#x67E5;&#x770B;:<br><code>tail -fn 800 /var/log/awslogs.log</code></p>
<h5 id="3-&#x8282;&#x70B9;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;&#x3001;&#x5BB9;&#x5668;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;-&#x7684;&#x6302;&#x8F7D;&#x6620;&#x5C04;&#x5173;&#x7CFB;"><a href="#3-&#x8282;&#x70B9;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;&#x3001;&#x5BB9;&#x5668;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;-&#x7684;&#x6302;&#x8F7D;&#x6620;&#x5C04;&#x5173;&#x7CFB;" class="headerlink" title="3.&#x8282;&#x70B9;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;&#x3001;&#x5BB9;&#x5668;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84; &#x7684;&#x6302;&#x8F7D;&#x6620;&#x5C04;&#x5173;&#x7CFB;"></a>3.&#x8282;&#x70B9;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;&#x3001;&#x5BB9;&#x5668;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84; &#x7684;&#x6302;&#x8F7D;&#x6620;&#x5C04;&#x5173;&#x7CFB;</h5><p>k8s&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x8FD0;&#x884C;&#x5728;&#x8282;&#x70B9;&#x6C60;&#x91CC;&#x7684;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x4E0A;&#x7684;&#xFF0C;&#x6BCF;&#x4E2A;&#x7269;&#x7406;/&#x4E91;&#x8282;&#x70B9;&#x4E0A;&#xFF0C;&#x6709;&#x4E00;&#x4E2A;&#x8DEF;&#x5F84;&#xFF1A;<br><code>/var/log/ahs-pods/mount</code>(mta-swappie-service.yaml&#x4E2D;&#x6709;&#x5B9A;&#x4E49;)&#xFF0C;&#x8FD9;&#x4E2A;&#x8DEF;&#x5F84;&#x4E0B;&#x6302;&#x8F7D;&#x4E86;&#x5BB9;&#x5668;&#x91CC;&#x7684;&#x5E94;&#x7528;&#x670D;&#x52A1;&#x65E5;&#x5FD7;&#x6587;&#x4EF6;&#xFF1A;<code>/var/log/containers/mta-swappie-service</code>(&#x5DE5;&#x7A0B;:mta-swappie-package&#x4E0B;&#x7684;logback-spring.xml&#x91CC;&#x6709;&#x5199;&#x8BE5;&#x8DEF;&#x5F84;)</p>
<table>
<thead>
<tr>
<th>deployment.yaml&#x4E2D;&#x5B9A;&#x4E49;&#x7684;business&#x8DEF;&#x5F84;</th>
<th>&#x6620;&#x5C04;</th>
<th>&#x5E94;&#x7528;&#x4E2D;&#x7684;logback.xml&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;</th>
</tr>
</thead>
<tbody><tr>
<td>/var/log/ahs-pods/mount</td>
<td>&#x2192;&#x2192;</td>
<td>/var/log/containers</td>
</tr>
</tbody></table>
<p>&#x5BBF;&#x4E3B;&#x673A;&#x91CC;&#x7684;<code>/var/log/containers/ahs-pods/mount</code> &#x7B49;&#x540C;&#x4E8E;&#x5BB9;&#x5668;&#x91CC;&#x7684;<code>/var/log/containers</code>&#xFF0C;<br>&#x8FD9;&#x79CD;&#x6302;&#x8F7D;&#x6620;&#x5C04;&#xFF0C;&#x5728;deployment&#x4E2D;&#x7684;&#x5B9A;&#x4E49;&#x5173;&#x7CFB;&#xFF0C;&#x5982;&#x4E0B;&#x5173;&#x952E;&#x90E8;&#x5206;&#xFF1A;</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">          <span class="string">...</span></span><br><span class="line">          <span class="string">...</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/log/containers</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/log/containers/ahs-pods/mount</span></span><br></pre></td></tr></table></figure>

<h4 id="15-&#x5378;&#x8F7D;-alb-ingress-controller"><a href="#15-&#x5378;&#x8F7D;-alb-ingress-controller" class="headerlink" title="15. &#x5378;&#x8F7D; alb ingress controller"></a>15. &#x5378;&#x8F7D; alb ingress controller</h4><blockquote>
<p>&#x5982;&#x679C;&#x4E0A;&#x9762;&#x6700;&#x540E;&#x521B;&#x5EFA;ingress&#x7684;&#x65F6;&#x5019;&#x62A5;&#x9519;&#xFF0C;&#x53EF;&#x4EE5;&#x6309;&#x4E0B;&#x9762;&#x6B65;&#x9AA4;&#x5220;&#x9664;&#x5404;&#x4E2A;&#x7EC4;&#x4EF6;&#xFF0C;&#x7136;&#x540E;&#x91CD;&#x65B0;&#x8D70;&#x4E0A;&#x9762;&#x7684;&#x521B;&#x5EFA;&#x6D41;&#x7A0B;&#xFF0C;&#x5220;&#x9664;&#x987A;&#x5E8F;: ingress &#x2013;&gt; ingressClass &#x2013;&gt; deployment</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//&#x5220;&#x9664; Ingress</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get ingress</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service delete ingress/mta-swappie-backend-ingress</span><br><span class="line"></span><br><span class="line">//&#x5220;&#x9664; IngressClassParams</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg get IngressClassParams</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg delete IngressClassParams/alb</span><br><span class="line"></span><br><span class="line">//&#x5220;&#x9664; IngressClass</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg get ingressClass</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg delete ingressClass/alb</span><br><span class="line"></span><br><span class="line">//&#x5220;&#x9664; deployment/aws-load-balancer-controller</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n kube-system get deployment/aws-load-balancer-controller</span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n kube-system delete deployment/aws-load-balancer-controller</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="16-&#x5176;&#x4ED6;"><a href="#16-&#x5176;&#x4ED6;" class="headerlink" title="16.&#x5176;&#x4ED6;"></a>16.&#x5176;&#x4ED6;</h4><p>1.&#x8FDB;&#x5165;&#x5BB9;&#x5668;&#x5185;&#x90E8;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <code>-- /bin/bash</code> &#x6216; <code>-- sh</code>&#xFF0C;&#x611F;&#x89C9;&#x7528;<code>-- /bin/bash</code> &#x66F4;&#x597D;&#xFF0C;&#x56E0;&#x4E3A;&#x5728;&#x5BB9;&#x5668;&#x5185;&#x90E8;&#x6709;&#x8DEF;&#x5F84;&#x63D0;&#x793A;&#xFF0C;&#x548C;&#x81EA;&#x52A8;&#x8865;&#x5168;&#xFF0C;&#x7136;&#x800C;sh &#x90FD;&#x6CA1;&#x6709;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service exec -it mta-swappie-service-7d58f94788-kgqhw -- sh</span><br><span class="line">#</span><br></pre></td></tr></table></figure>

<p>&#x548C;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service exec -it mta-swappie-service-7d58f94788-kgqhw -- /bin/bash</span><br><span class="line">root@mta-swappie-service-7d58f94788-kgqhw:/usr/src/myapp#</span><br></pre></td></tr></table></figure>

<h2 id="&#x9006;&#x5411;&#x6D41;&#x7A0B;"><a href="#&#x9006;&#x5411;&#x6D41;&#x7A0B;" class="headerlink" title="&#x9006;&#x5411;&#x6D41;&#x7A0B;"></a>&#x9006;&#x5411;&#x6D41;&#x7A0B;</h2><h3 id="1-&#x5220;&#x9664;EKS&#x96C6;&#x7FA4;&#xFF1A;"><a href="#1-&#x5220;&#x9664;EKS&#x96C6;&#x7FA4;&#xFF1A;" class="headerlink" title="1.&#x5220;&#x9664;EKS&#x96C6;&#x7FA4;&#xFF1A;"></a>1.&#x5220;&#x9664;EKS&#x96C6;&#x7FA4;&#xFF1A;</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg get namespace</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg get nodes</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get service</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get ingressClass</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get ingress</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get deployment</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get events</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service describe deployment/mta-swappie-service</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg get svc --all-namespaces</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get deployment</span><br><span class="line">&#x5220;&#x9664;deployment/mta-swappie-service:</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service delete deployment/mta-swappie-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n kube-system delete deployment/aws-load-balancer-controller</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n cert-manager delete deployment/cert-manager</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n cert-manager delete deployment/cert-manager-cainjector</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n cert-manager delete deployment/cert-manager-webhook</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get service</span><br><span class="line">&#x5220;&#x9664;service/mta-sawppie-service:</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service delete service/mta-swappie-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n kube-system delete service/aws-load-balancer-webhook-service</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n cert-manager delete service/cert-manager</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n cert-manager delete service/cert-manager-webhook</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get ingressClass</span><br><span class="line">&#x5220;&#x9664; ingressClass/alb</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service delete ingressClass/alb</span></span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service get ingress</span><br><span class="line">&#x5220;&#x9664;ingress/mta-xx-backend-ingress</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl --kubeconfig=/home/gitlab-runner/.kube/config-uat-aws-mta-hk-xxg -n java-service delete ingress/mta-xx-backend-ingress</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">eksctl delete cluster --name uat-mta-xxg</span></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>


<h2 id="&#x51E0;&#x4E2A;&#x7EC4;&#x4EF6;&#x5BF9;&#x5E94;&#x7684;yaml&#x7533;&#x660E;"><a href="#&#x51E0;&#x4E2A;&#x7EC4;&#x4EF6;&#x5BF9;&#x5E94;&#x7684;yaml&#x7533;&#x660E;" class="headerlink" title="&#x51E0;&#x4E2A;&#x7EC4;&#x4EF6;&#x5BF9;&#x5E94;&#x7684;yaml&#x7533;&#x660E;"></a>&#x51E0;&#x4E2A;&#x7EC4;&#x4EF6;&#x5BF9;&#x5E94;&#x7684;yaml&#x7533;&#x660E;</h2><h3 id="1-Dockerfile-template-MultiEnv-&#x5185;&#x5BB9;&#xFF1A;"><a href="#1-Dockerfile-template-MultiEnv-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="1. Dockerfile-template-MultiEnv &#x5185;&#x5BB9;&#xFF1A;"></a>1. <code>Dockerfile-template-MultiEnv</code> &#x5185;&#x5BB9;&#xFF1A;</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>u332-jre-bullseye</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/src/myapp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./<span class="variable">$package_path</span>/target/<span class="variable">$service_jar</span> /usr/src/myapp/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./<span class="variable">$package_path</span>/target/transmittable-thread-local-2.10.2.jar /usr/src/myapp/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./<span class="variable">$package_path</span>/target/start_jar.sh /usr/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/timezone &amp;&amp; <span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># specify the procps version so that Docker can cache it</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> DEBIAN_FRONTEND=noninteractive apt-get update &amp;&amp; apt-get install -y procps=2:3.3.17-5 &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/usr/bin/start_jar.sh&quot;</span>, <span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;-Dspring.profiles.active=<span class="variable">$active_env</span>&quot;</span> ,<span class="string">&quot;<span class="variable">$service_jar</span>&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h4 id="&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;"><a href="#&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;"></a>&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;</h4><p>&#x8DEF;&#x5F84;&#xFF1A; <code>/home/gitlab-runner/builds/vzxoq1eW/0/Creative/mta-swappie-package/mta-swappie-service/target/Dockerfile</code></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>u332-jre-bullseye</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/src/myapp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./mta-swappie-service/target/mta-swappie-service.jar /usr/src/myapp/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./mta-swappie-service/target/transmittable-thread-local-2.10.2.jar /usr/src/myapp/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./mta-swappie-service/target/start_jar.sh /usr/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/timezone &amp;&amp; <span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># specify the procps version so that Docker can cache it</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> DEBIAN_FRONTEND=noninteractive apt-get update &amp;&amp; apt-get install -y procps=2:3.3.17-5 &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/usr/bin/start_jar.sh&quot;</span>, <span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;-Dspring.profiles.active=uat&quot;</span> ,<span class="string">&quot;mta-swappie-service.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="2-service-clusterip-swappie-yaml-&#x5185;&#x5BB9;&#xFF1A;"><a href="#2-service-clusterip-swappie-yaml-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="2. service-clusterip-swappie.yaml &#x5185;&#x5BB9;&#xFF1A;"></a>2. <code>service-clusterip-swappie.yaml</code> &#x5185;&#x5BB9;&#xFF1A;</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span>  <span class="comment"># &#x7C7B;&#x578B;&#x4E3A; Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mta-swappie-service</span>  <span class="comment"># Service &#x7684;&#x540D;&#x79F0;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># &#x6807;&#x7B7E;&#x9009;&#x62E9;&#x5668;&#xFF0C;&#x4F1A;&#x548C;&#x4E0A;&#x9762;&#x521B;&#x5EFA;&#x7684; deployment.yaml &#x7684; pod &#x5173;&#x8054;&#x8D77;&#x6765;</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">  <span class="attr">clusterIP:</span>  <span class="comment"># service &#x7684; ip &#x5730;&#x5740;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5199;&#xFF0C;&#x9ED8;&#x8BA4;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;,&#x6CE8;&#x610F;&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x4E0D;&#x80FD;&#x5199;&#xFF0C;&#x6709;&#x4E2A;&#x8303;&#x56F4;&#x7684;&#xFF0C;&#x6211;&#x7684;&#x662F; 172.31.0.0/16</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span> <span class="comment"># &#x7C7B;&#x578B;&#x4E3A; Service &#x7684; ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span>  <span class="comment"># Service &#x7AEF;&#x53E3;&#xFF0C;&#x81EA;&#x5B9A;&#x4E49;</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span> <span class="comment"># pod &#x7AEF;&#x53E3;&#xFF0C;&#x4E0D;&#x5199;&#x9ED8;&#x8BA4;&#x662F; 80</span></span><br></pre></td></tr></table></figure>


<h3 id="3-ingress-class-alb-yaml-&#x5185;&#x5BB9;&#xFF1A;"><a href="#3-ingress-class-alb-yaml-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="3.ingress-class-alb.yaml &#x5185;&#x5BB9;&#xFF1A;"></a>3.<code>ingress-class-alb.yaml</code> &#x5185;&#x5BB9;&#xFF1A;</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">controller:</span> <span class="string">ingress.k8s.aws/alb</span></span><br></pre></td></tr></table></figure>

<p>&#x6216;&#x8005;&#x7528;&#x7F51;&#x4E0A;&#x7684;<code>v2_4_7_ingclass.yaml</code>&#x5185;&#x5BB9;&#xFF1A;</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">elbv2.k8s.aws/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressClassParams</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alb</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">aws-load-balancer-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">controller:</span> <span class="string">ingress.k8s.aws/alb</span></span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">apiGroup:</span> <span class="string">elbv2.k8s.aws</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">IngressClassParams</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">alb</span></span><br></pre></td></tr></table></figure>

<h3 id="4-ingress-uat-yaml-&#x5185;&#x5BB9;&#xFF1A;"><a href="#4-ingress-uat-yaml-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="4.ingress-uat.yaml &#x5185;&#x5BB9;&#xFF1A;"></a>4.<code>ingress-uat.yaml</code> &#x5185;&#x5BB9;&#xFF1A;</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mta-swappie-backend-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># Ingress Core Settings</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/scheme:</span> <span class="string">&apos;internet-facing&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/target-type:</span> <span class="string">&apos;ip&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/load-balancer-attributes:</span> <span class="string">idle_timeout.timeout_seconds=400</span></span><br><span class="line">    <span class="comment"># Health Check Settings</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/healthcheck-protocol:</span> <span class="string">&apos;HTTP&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/healthcheck-path:</span> <span class="string">&apos;/mta-swappie-service/health/check&apos;</span></span><br><span class="line">    <span class="comment">## SSL Settings</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/listen-ports:</span> <span class="string">&apos;[{&quot;HTTP&quot;: 80}, {&quot;HTTPS&quot;: 443}]&apos;</span></span><br><span class="line">    <span class="comment"># alb.ingress.kubernetes.io/certificate-arn: &apos;arn:aws:acm:eu-central-1:409921503514:certificate/7f065637-1580-47e0-8d1e-0f4340ab83d4&apos;</span></span><br><span class="line">    <span class="comment"># redirect all HTTP to HTTPS</span></span><br><span class="line">    <span class="comment"># alb.ingress.kubernetes.io/actions.ssl-redirect: &apos;{&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;: { &quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;}}&apos;</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&apos;443&apos;</span>    </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">alb</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span>  <span class="string">mta-api.xiexugang.top</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/mta-swappie-service</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<h3 id="5-deployment-template-uat-yaml-&#x5185;&#x5BB9;&#xFF1A;"><a href="#5-deployment-template-uat-yaml-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="5.deployment-template-uat.yaml &#x5185;&#x5BB9;&#xFF1A;"></a>5.<code>deployment-template-uat.yaml</code> &#x5185;&#x5BB9;&#xFF1A;</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">$service_name</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="string">$kube_replicas</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">50</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span><span class="string">%</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">$service_name</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">$service_name</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">$version</span></span><br><span class="line">        <span class="attr">release:</span> <span class="string">normal</span></span><br><span class="line">        <span class="attr">updatedTimestamp:</span> <span class="string">&quot;$timestamp&quot;</span></span><br><span class="line">        <span class="attr">language:</span> <span class="string">java</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">podAffinityTerm:</span>      </span><br><span class="line">              <span class="attr">labelSelector:</span></span><br><span class="line">                <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">$service_name</span></span><br><span class="line">              <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">$service_name</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">$image</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">lifecycle:</span></span><br><span class="line">            <span class="attr">preStop:</span></span><br><span class="line">              <span class="attr">exec:</span></span><br><span class="line">                <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-ce&quot;</span>, <span class="string">&quot;tail -f /dev/null&quot;</span>]</span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">18080</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">28080</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_IP</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_PORT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ENV</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;uat&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PINPOINT_OPTS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;-Xmx2048M -Xms2048M -XX:+PrintHeapAtGC -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:/var/log/$service_name-gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/$service_name.dump -javaagent:/usr/src/myapp/transmittable-thread-local-2.10.2.jar&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CATALINA_OPTS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;-XX:+PrintHeapAtGC -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:/var/log/$service_name-gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/$service_name.dump -javaagent:/usr/local/tomcat/transmittable-thread-local-2.10.2.jar&quot;</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">3000m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">3072M</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">300m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">3072M</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">$health_check</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">$health_check</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">200</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/log/ahs-pods/mount</span></span><br></pre></td></tr></table></figure>




<h4 id="&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;-1"><a href="#&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;-1" class="headerlink" title="&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;"></a>&#x67D0;&#x6B21;CI&#x6784;&#x5EFA;&#x540E;&#x7684;&#x5185;&#x5BB9;&#xFF1A;</h4><p>&#x8DEF;&#x5F84;&#xFF1A;<code>/home/gitlab-runner/builds/vzxoq1eW/0/Creative/mta-swappie-package/mta-swappie-service/target/deployment.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">java-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">50</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span><span class="string">%</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">20230731_094602.gcp</span></span><br><span class="line">        <span class="attr">release:</span> <span class="string">normal</span></span><br><span class="line">        <span class="attr">updatedTimestamp:</span> <span class="string">&quot;2023463194627&quot;</span></span><br><span class="line">        <span class="attr">language:</span> <span class="string">java</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">podAffinityTerm:</span>      </span><br><span class="line">              <span class="attr">labelSelector:</span></span><br><span class="line">                <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">mta-swappie-service</span></span><br><span class="line">              <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mta-swappie-service</span></span><br><span class="line">          <span class="attr">image:</span> <span class="number">409921503514.</span><span class="string">dkr.ecr.ap-east-1.amazonaws.com/uat-swappie:20230731_094602</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">lifecycle:</span></span><br><span class="line">            <span class="attr">preStop:</span></span><br><span class="line">              <span class="attr">exec:</span></span><br><span class="line">                <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-ce&quot;</span>, <span class="string">&quot;tail -f /dev/null&quot;</span>]</span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">18080</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">28080</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_IP</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_PORT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ENV</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;uat&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PINPOINT_OPTS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;-Xmx2048M -Xms2048M -XX:+PrintHeapAtGC -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:/var/log/mta-swappie-service-gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/mta-swappie-service.dump -javaagent:/usr/src/myapp/transmittable-thread-local-2.10.2.jar&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CATALINA_OPTS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;-XX:+PrintHeapAtGC -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:/var/log/mta-swappie-service-gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/mta-swappie-service.dump -javaagent:/usr/local/tomcat/transmittable-thread-local-2.10.2.jar&quot;</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">3000m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">3072M</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">300m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">3072M</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/mta-swappie-service/health/check</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/mta-swappie-service/health/check</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">200</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">business-log</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/log/ahs-pods/mount</span></span><br></pre></td></tr></table></figure>

<h4 id="deployment&#x91CC;&#x7684;&#x8DEF;&#x5F84;&#x8BF4;&#x660E;&#xFF1A;"><a href="#deployment&#x91CC;&#x7684;&#x8DEF;&#x5F84;&#x8BF4;&#x660E;&#xFF1A;" class="headerlink" title="deployment&#x91CC;&#x7684;&#x8DEF;&#x5F84;&#x8BF4;&#x660E;&#xFF1A;"></a>deployment&#x91CC;&#x7684;&#x8DEF;&#x5F84;&#x8BF4;&#x660E;&#xFF1A;</h4><p>deployment&#x91CC;&#x6700;&#x540E;&#x4E00;&#x884C; <code>path: /var/log/ahs-pods/mount</code>&#xFF0C;&#x8FD9;&#x4E2A;&#x8DEF;&#x5F84;&#x662F;&#x5BBF;&#x4E3B;&#x673A;&#x8282;&#x70B9;&#x91CC;&#x7684;&#x8DEF;&#x5F84;&#xFF0C;&#x4ED6;&#x662F;&#x6620;&#x5C04;&#x4E86;pod&#x91CC;&#x7684;&#x5BB9;&#x5668;&#x91CC;&#x7684;&#x8DEF;&#x5F84;&#xFF08;&#x6362;&#x8A00;&#x4E4B;&#xFF0C;&#x5C06;&#x5BB9;&#x5668;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x8DEF;&#x5F84;&#xFF0C;&#x6620;&#x5C04;&#x5230;&#x4E86;&#x5BBF;&#x4E3B;&#x673A;&#x8FD9;&#x4E2A;&#x8DEF;&#x5F84;&#x91CC;&#x4E86;&#xFF09;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x6392;&#x67E5;pod&#x542F;&#x52A8;&#x5931;&#x8D25;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x65E0;&#x6CD5;&#x8FDB;&#x5165;&#x5BB9;&#x5668;&#xFF0C;&#x6B64;&#x65F6;&#x5230;&#x5BBF;&#x4E3B;&#x673A;&#x7684;&#x8FD9;&#x4E2A;&#x76EE;&#x5F55;&#x4E0B;&#x770B;&#xFF0C;&#x662F;&#x6700;&#x65B9;&#x4FBF;&#x7684;&#x4E86;&#x3002;</p>
<h4 id="&#x6587;&#x4EF6;&#x4E00;&#x89C8;&#xFF1A;"><a href="#&#x6587;&#x4EF6;&#x4E00;&#x89C8;&#xFF1A;" class="headerlink" title="&#x6587;&#x4EF6;&#x4E00;&#x89C8;&#xFF1A;"></a>&#x6587;&#x4EF6;&#x4E00;&#x89C8;&#xFF1A;</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /home/gitlab-runner/dockerize/deployment-uat-aws-xxg</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[gitlab-runner@iZj6cc75gbmdwcpi6dy9yeZ deployment-uat-aws-xxg]$ ll</span></span><br><span class="line">total 964</span><br><span class="line">-rw-r--r-- 1 root root    336 Jul 29 19:37 aws-load-balancer-controller-service-account.yaml</span><br><span class="line">-rw-r--r-- 1 root root   2989 Jul 28 15:34 deployment-template-uat.yaml</span><br><span class="line">-rw-r--r-- 1 root root    659 Jul 28 16:57 Dockerfile-template-MultiEnv</span><br><span class="line">-rw-r--r-- 1 root root   8386 Jul 29 15:51 iam_policy.json</span><br><span class="line">-rw-r--r-- 1 root root    114 Jul 29 18:17 ingress-class-alb.yaml</span><br><span class="line">-rw-r--r-- 1 root root   1131 Jul 31 10:08 ingress-uat.yaml</span><br><span class="line">-rw-r--r-- 1 root root    659 Jul 28 13:47 service-clusterip-cruiser.yaml</span><br><span class="line">-rw-r--r-- 1 root root    665 Jul 28 13:47 service-clusterip-docomo.yaml</span><br><span class="line">-rw-r--r-- 1 root root    571 Jul 28 13:47 service-clusterip-swappie.yaml</span><br><span class="line">-rwxr-xr-x 1 root root    991 Jul 28 17:23 start_jar.sh</span><br><span class="line">-rw-r--r-- 1 root root 857936 Jul 28 17:23 transmittable-thread-local-2.10.2.jar</span><br><span class="line">-rw-r--r-- 1 root root  33643 Jul 29 17:52 v2_4_7_full.yaml</span><br><span class="line">-rw-r--r-- 1 root root  33649 Jul 29 17:51 v2_4_7_full.yaml.bak</span><br><span class="line">-rw-r--r-- 1 root root    418 Jul 29 18:20 v2_4_7_ingclass.yaml</span><br></pre></td></tr></table></figure>

<h3 id="6-aws-deploy-&#x5185;&#x5BB9;&#xFF1A;"><a href="#6-aws-deploy-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="6.aws_deploy &#x5185;&#x5BB9;&#xFF1A;"></a>6.<code>aws_deploy</code> &#x5185;&#x5BB9;&#xFF1A;</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">aws_deploy</span> {</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> main(args) {</span><br><span class="line"></span><br><span class="line">		println(<span class="string">&quot;=========================1.print args:========================&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> (args != <span class="literal">null</span> &amp;&amp; args.length &gt; <span class="number">0</span>) {</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">def</span> i = <span class="number">0</span>; i &lt; args.length; i++) {</span><br><span class="line">				println <span class="string">&quot;i=${i}, value=${args[i]}&quot;</span></span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">def</span> serviceName = args[<span class="number">0</span>]</span><br><span class="line">		<span class="keyword">def</span> env = args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">		<span class="keyword">def</span> currentDir = <span class="string">&quot;pwd&quot;</span>.execute().text</span><br><span class="line">		println(<span class="string">&quot;currentDir=${currentDir}&quot;</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">def</span> dockerizeDir = <span class="string">&quot;/home/gitlab-runner/dockerize/deployment-prod-aws-europe&quot;</span></span><br><span class="line">		<span class="keyword">def</span> dockerFileName = <span class="string">&quot;Dockerfile-template-MultiEnv&quot;</span></span><br><span class="line">		<span class="keyword">def</span> k8sDeployFileName = <span class="string">&quot;deployment-template-prod.yaml&quot;</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">def</span> kubeConfig = System.getenv(<span class="string">&quot;KUBE_CONFIG&quot;</span>)</span><br><span class="line">		<span class="keyword">def</span> region = System.getenv(<span class="string">&quot;REGION&quot;</span>)</span><br><span class="line">		<span class="keyword">def</span> kubeReplicas = System.getenv(<span class="string">&quot;KUBE_REPLICAS&quot;</span>)</span><br><span class="line">		<span class="keyword">def</span> healthCheck = System.getenv(<span class="string">&quot;HEALTH_CHECK&quot;</span>)</span><br><span class="line">		<span class="keyword">def</span> dockerRepo = System.getenv(<span class="string">&quot;DOCKER_REPO&quot;</span>)</span><br><span class="line">		<span class="keyword">def</span> dockerRepository = System.getenv(<span class="string">&quot;DOCKER_REPOSITORY&quot;</span>)</span><br><span class="line"></span><br><span class="line">		println(<span class="string">&quot;========================2.print env variables from .gitlab-ci.yml list:========================&quot;</span>)</span><br><span class="line">		println(<span class="string">&quot;env REGION=${region}&quot;</span>)</span><br><span class="line">		println(<span class="string">&quot;env KUBE_REPLICAS=${kubeReplicas}&quot;</span>)</span><br><span class="line">		println(<span class="string">&quot;env HEALTH_CHECK=${healthCheck}&quot;</span>)</span><br><span class="line">		println(<span class="string">&quot;env DOCKER_REPO=${dockerRepo}&quot;</span>)</span><br><span class="line">		println(<span class="string">&quot;env DOCKER_REPOSITORY=${dockerRepository}&quot;</span>)</span><br><span class="line"></span><br><span class="line">		println(<span class="string">&quot;========================3.mvn package========================&quot;</span>)</span><br><span class="line">		runCommandResult(<span class="string">&quot;mvn -e -DskipTests=true clean package&quot;</span>)</span><br><span class="line"></span><br><span class="line">		println(<span class="string">&quot;========================4.create Dockerfile========================&quot;</span>)</span><br><span class="line">		File dockerFile = <span class="keyword">new</span> File(<span class="string">&quot;${dockerizeDir}/${dockerFileName}&quot;</span>)</span><br><span class="line">		<span class="keyword">def</span> dockerFileTempleteContent = dockerFile.text</span><br><span class="line">		println(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;dockerFileTempleteContent=\n${dockerFileTempleteContent}&quot;</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">def</span> serviceJar = serviceName + <span class="string">&quot;.jar&quot;</span></span><br><span class="line">		<span class="keyword">def</span> lastDockerFileTempleteContent = dockerFileTempleteContent.replaceAll(<span class="string">&quot;\\\$package_path&quot;</span>, serviceName)</span><br><span class="line">								.replaceAll(<span class="string">&quot;\\\$service_jar&quot;</span>, serviceJar)</span><br><span class="line">								.replaceAll(<span class="string">&quot;\\\$active_env&quot;</span>, env)</span><br><span class="line">		println(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;lastDockerFileTempleteContent=\n${lastDockerFileTempleteContent}&quot;</span>)</span><br><span class="line"></span><br><span class="line">		<span class="comment">//&#x5F53;&#x524D;&#x76EE;&#x5F55;&#x5728;: /home/gitlab-runner/builds/vzxoq1eW/0/Creative/mta-swappie-package</span></span><br><span class="line">		File lastDockerFile = <span class="keyword">new</span> File(<span class="string">&quot;./${serviceName}/target/Dockerfile&quot;</span>)</span><br><span class="line">		lastDockerFile.write(lastDockerFileTempleteContent)</span><br><span class="line"></span><br><span class="line">		println(<span class="string">&quot;========================5.docker build image========================&quot;</span>)</span><br><span class="line">		runCommandResult(<span class="string">&quot;sudo cp ${dockerizeDir}/start_jar.sh ./${serviceName}/target/&quot;</span>)</span><br><span class="line">		runCommandResult(<span class="string">&quot;sudo cp ${dockerizeDir}/transmittable-thread-local-2.10.2.jar ./${serviceName}/target/&quot;</span>)</span><br><span class="line"></span><br><span class="line">		runCommandResult(<span class="string">&quot;docker --version&quot;</span>)</span><br><span class="line">		<span class="keyword">def</span> dockerTag = ymdhms()</span><br><span class="line">		<span class="keyword">def</span> dockerImage = dockerRepository + <span class="string">&quot;:&quot;</span> + dockerTag</span><br><span class="line">		println(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;docker build -f ./${serviceName}/target/Dockerfile -t ${dockerImage} .&quot;</span>)</span><br><span class="line">		runCommandResult(<span class="string">&quot;docker build -f ./${serviceName}/target/Dockerfile -t ${dockerImage} .&quot;</span>)</span><br><span class="line"></span><br><span class="line">		println(<span class="string">&quot;========================6.docker push image========================&quot;</span>)</span><br><span class="line">		<span class="comment">// https://docs.aws.amazon.com/zh_cn/AmazonECR/latest/userguide/registry_auth.html</span></span><br><span class="line">		<span class="comment">// docker login -u AWS -p &lt;password&gt; &lt;aws_account_id&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com  &#x4E0D;&#x77E5;&#x9053;&#x5BC6;&#x7801;</span></span><br><span class="line">		<span class="comment">// https://docs.aws.amazon.com/zh_tw/AmazonECR/latest/userguide/getting-started-cli.html</span></span><br><span class="line">		<span class="comment">// aws ecr get-login-password --region region | docker login --username AWS --password-stdin aws_account_id.dkr.ecr.region.amazonaws.com</span></span><br><span class="line">		<span class="comment">// &#x4E0A;&#x9762;&#x8FD9;&#x6761;&#x547D;&#x4EE4;&#xFF0C;&#x4F1A;&#x5728;&#x76EE;&#x5F55; ~/.docker/ &#x4E0B;&#x751F;&#x4EA7;&#x4E2A;&#x4E34;&#x65F6;&#x7684;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x6587;&#x4EF6;&#xFF1A;config.json&#xFF0C;&#x6709;&#x6548;&#x671F;&#x4E3A;12&#x5C0F;&#x65F6;</span></span><br><span class="line">		runPipeline(<span class="string">&quot;aws ecr get-login-password --region ${region} --profile devops | docker --config=/home/gitlab-runner/awsdocker login --username AWS --password-stdin ${dockerRepo}&quot;</span>)</span><br><span class="line">		println(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;docker --config=/home/gitlab-runner/awsdocker push ${dockerImage}&quot;</span>)</span><br><span class="line">		runCommandResult(<span class="string">&quot;docker --config=/home/gitlab-runner/awsdocker push ${dockerImage}&quot;</span>)</span><br><span class="line"></span><br><span class="line">		println(<span class="string">&quot;========================7.create deployment.yaml========================&quot;</span>)</span><br><span class="line">		File k8sDeploymentFile = <span class="keyword">new</span> File(<span class="string">&quot;${dockerizeDir}/${k8sDeployFileName}&quot;</span>)</span><br><span class="line">		<span class="keyword">def</span> k8sDeploymentFileContent = k8sDeploymentFile.text</span><br><span class="line"></span><br><span class="line">		<span class="keyword">def</span> lastK8sDeploymentFileContent = k8sDeploymentFileContent</span><br><span class="line">				.replaceAll(<span class="string">&quot;\\\$service_name&quot;</span>, serviceName)</span><br><span class="line">				.replaceAll(<span class="string">&quot;\\\$timestamp&quot;</span>, <span class="keyword">new</span> Date().format(<span class="string">&quot;YmdHms&quot;</span>))</span><br><span class="line">				.replaceAll(<span class="string">&quot;\\\$image&quot;</span>, dockerImage)</span><br><span class="line">				.replaceAll(<span class="string">&quot;\\\$version&quot;</span>, dockerTag+<span class="string">&quot;.gcp&quot;</span>)</span><br><span class="line">				.replaceAll(<span class="string">&quot;\\\$service-context&quot;</span>, serviceName)</span><br><span class="line">				.replaceAll(<span class="string">&quot;\\\$health_check&quot;</span>, healthCheck)</span><br><span class="line">				.replaceAll(<span class="string">&quot;\\\$kube_replicas&quot;</span>, kubeReplicas)</span><br><span class="line">		File lastK8sDeploymentFile = <span class="keyword">new</span> File(<span class="string">&quot;./${serviceName}/target/deployment.yaml&quot;</span>)</span><br><span class="line">		lastK8sDeploymentFile.write(lastK8sDeploymentFileContent)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// kubectl --kubeconfig=/home/gitlab-runner/.kube/config-aws-prod-europe get namespaces</span></span><br><span class="line">		<span class="comment">// kubectl --kubeconfig=/home/gitlab-runner/.kube/config-aws-prod-europe get nodes</span></span><br><span class="line">		<span class="comment">// kubectl --kubeconfig=/home/gitlab-runner/.kube/config-aws-prod-europe -n java-service get service</span></span><br><span class="line">		<span class="comment">// kubectl --kubeconfig=/home/gitlab-runner/.kube/config-aws-prod-europe -n java-service get ingress</span></span><br><span class="line">		<span class="comment">// kubectl --kubeconfig=/home/gitlab-runner/.kube/config-aws-prod-europe -n java-service get deployment</span></span><br><span class="line"></span><br><span class="line">		println(<span class="string">&quot;========================8.EKS list nodes========================&quot;</span>)</span><br><span class="line">		println(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;kubectl get nodes --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line">		runCommand(<span class="string">&quot;kubectl get nodes --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line"></span><br><span class="line">		println(<span class="string">&quot;========================9.EKS list pods========================&quot;</span>)</span><br><span class="line">		println(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line">		runCommand(<span class="string">&quot;kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line"></span><br><span class="line">		println(<span class="string">&quot;========================10.EKS apply deployment========================&quot;</span>)</span><br><span class="line">		println(<span class="string">&quot;\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;kubectl apply -f ./${serviceName}/target/deployment.yaml --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>)</span><br><span class="line">		<span class="keyword">def</span> k1 = <span class="string">&quot;kubectl apply -f ./${serviceName}/target/deployment.yaml --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}&quot;</span>.execute().text</span><br><span class="line">		runCommand(<span class="string">&quot;echo 3_____${k1}&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> (k1.contains(<span class="string">&quot;configured&quot;</span>)) {</span><br><span class="line">			println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;EKS deployment configured!&quot;</span>)</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		println(<span class="string">&quot;========================11.EKS detect pods status: ContainerCreating========================&quot;</span>)</span><br><span class="line">		<span class="comment">//&#x67E5;&#x770B;k8s&#x72B6;&#x6001;</span></span><br><span class="line">		runCommand(<span class="string">&quot;date&quot;</span>)</span><br><span class="line">		println(<span class="string">&quot;4__Detect ContainerCreating==&gt; kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}  | grep ${serviceName}  | grep ContainerCreating -c&quot;</span>)</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">def</span> index = <span class="number">1</span>; index &lt;= <span class="number">10</span>; index++) {</span><br><span class="line">			<span class="keyword">def</span> podStatus = runPipeline(<span class="string">&quot;kubectl get pods -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig}  | grep ${serviceName}  | grep ContainerCreating -c \n&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> (podStatus.equals(<span class="string">&quot;1&quot;</span>)) {</span><br><span class="line">				println(<span class="string">&quot;&#x5BB9;&#x5668;&#x6B63;&#x5728;&#x521B;&#x5EFA;&#x4E2D;...\n&quot;</span>)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			}</span><br><span class="line">			sleep(<span class="number">1000</span>L)</span><br><span class="line">		}</span><br><span class="line">		runCommand(<span class="string">&quot;date&quot;</span>)</span><br><span class="line"></span><br><span class="line">		println(<span class="string">&quot;========================12.EKS detect deployment status: successfully========================&quot;</span>)</span><br><span class="line">		runCommand(<span class="string">&quot;date&quot;</span>)</span><br><span class="line">		println(<span class="string">&quot;6__Detect successfully==&gt; kubectl rollout status deployment/${serviceName}  -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig} | grep successfully -c&quot;</span>)</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">def</span> index = <span class="number">1</span>; index &lt;= <span class="number">10</span>; index++) {</span><br><span class="line">			<span class="keyword">def</span> deploymentStatus = runPipeline(<span class="string">&quot;kubectl rollout status deployment/${serviceName}  -n java-service --kubeconfig=/home/gitlab-runner/.kube/${kubeConfig} | grep successfully -c \n&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> (deploymentStatus.equals(<span class="string">&quot;1&quot;</span>)) {</span><br><span class="line">				println(<span class="string">&quot;&#x53D1;&#x5E03;&#x6210;&#x529F;!\n&quot;</span>)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			}</span><br><span class="line">			sleep(<span class="number">1000</span>L)</span><br><span class="line">		}</span><br><span class="line">		runCommand(<span class="string">&quot;date&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">//&#x666E;&#x901A;shell&#x547D;&#x4EE4;&#xFF0C;&#x6CA1;&#x6709;&#x7BA1;&#x9053;</span></span><br><span class="line">	<span class="keyword">def</span> <span class="keyword">static</span> runCommand(<span class="keyword">def</span> command) {</span><br><span class="line">		println command.execute().text</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">//&#x666E;&#x901A;shell&#x547D;&#x4EE4;&#xFF0C;&#x6CA1;&#x6709;&#x7BA1;&#x9053;</span></span><br><span class="line">	<span class="keyword">def</span> <span class="keyword">static</span> runCommandResult(<span class="keyword">def</span> command) {</span><br><span class="line">		<span class="keyword">def</span> info  = <span class="keyword">new</span> StringBuilder()</span><br><span class="line">		<span class="keyword">def</span> error = <span class="keyword">new</span> StringBuilder()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">def</span> proc = command.execute()	<span class="comment">// Call *execute* on the string</span></span><br><span class="line">		proc.consumeProcessOutput(info, error)</span><br><span class="line">		proc.waitFor()					<span class="comment">// Wait for the command to finish</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!error.toString().equals(<span class="string">&quot;&quot;</span>)) {</span><br><span class="line">			println <span class="string">&quot;Command[ ${command} ] &gt;&gt;error: ${error.toString()}&quot;</span></span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		println <span class="string">&quot;Command[ ${command} ] &gt;&gt;result: ${info.toString()}&quot;</span></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">//&#x6709;&#x7BA1;&#x9053;&#x7684;shell&#x547D;&#x4EE4;</span></span><br><span class="line">	<span class="keyword">def</span> <span class="keyword">static</span> runPipeline(<span class="keyword">def</span> command) {</span><br><span class="line">		Runtime rt = Runtime.getRuntime()</span><br><span class="line">		String[] commands = [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, command]</span><br><span class="line">		Process proc = rt.exec(commands)</span><br><span class="line"></span><br><span class="line">		BufferedReader stdInput = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span></span><br><span class="line">			InputStreamReader(proc.getInputStream()))</span><br><span class="line"></span><br><span class="line">		BufferedReader stdError = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span></span><br><span class="line">			InputStreamReader(proc.getErrorStream()))</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Read the output from the command</span></span><br><span class="line">		println(<span class="string">&quot;Here is the standard output of the command:\n&quot;</span>)</span><br><span class="line">		<span class="keyword">def</span> infoBuilder = <span class="keyword">new</span> StringBuilder()</span><br><span class="line">		<span class="keyword">def</span> infostr = <span class="literal">null</span></span><br><span class="line">		<span class="keyword">while</span> ((infostr = stdInput.readLine()) != <span class="literal">null</span>) {</span><br><span class="line">			infoBuilder.append(infostr)</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (!infoBuilder.toString().equals(<span class="string">&quot;&quot;</span>)) {</span><br><span class="line">			<span class="comment">//println &quot;AAAAAAAAAA&quot;</span></span><br><span class="line">			<span class="keyword">return</span> infoBuilder.toString()</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Read any errors from the attempted command</span></span><br><span class="line">		println(<span class="string">&quot;Here is the standard error of the command (if any):\n&quot;</span>);</span><br><span class="line">		<span class="keyword">def</span> errorBuilder = <span class="keyword">new</span> StringBuilder()</span><br><span class="line">		<span class="keyword">def</span> errorstr = <span class="literal">null</span></span><br><span class="line">		<span class="keyword">while</span> ((errorstr = stdError.readLine()) != <span class="literal">null</span>) {</span><br><span class="line">			errorBuilder.append(errorstr)</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (!errorBuilder.toString().equals(<span class="string">&quot;&quot;</span>)) {</span><br><span class="line">			<span class="comment">//println &quot;BBBBBBBBBB&quot;</span></span><br><span class="line">			<span class="keyword">return</span> errorBuilder.toString()</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="keyword">static</span> ymdhms() {</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Date().format(<span class="string">&quot;yyyyMMdd_HHmmss&quot;</span>)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="7-gitlab-ci-yml-&#x5185;&#x5BB9;&#xFF1A;"><a href="#7-gitlab-ci-yml-&#x5185;&#x5BB9;&#xFF1A;" class="headerlink" title="7..gitlab-ci.yml &#x5185;&#x5BB9;&#xFF1A;"></a>7.<code>.gitlab-ci.yml</code> &#x5185;&#x5BB9;&#xFF1A;</h3><p>&#x76EE;&#x524D;&#x8D77;&#x4F5C;&#x7528;&#x7684; stage=<code>deploy-aws-uat-xxg</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start check environment&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">whoami</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pwd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">java</span> <span class="string">-version</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">groovy</span> <span class="string">-version</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">aws</span> <span class="string">--version</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">eksctl</span> <span class="string">version</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">version</span> <span class="string">--client</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-gcp-uat:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">KUBE_CONFIG:</span> <span class="string">&quot;config-uat-asia&quot;</span> <span class="comment">#&#x4F7F;&#x7528;kubeconfig&#x6587;&#x4EF6;&#x540D;</span></span><br><span class="line">    <span class="attr">KUBE_SERVICE_ACCOUNT:</span> <span class="string">&quot;creative-cicd-uat-asia@atrenew-docomo-uat.iam.gserviceaccount.com&quot;</span> <span class="comment">#&#x4F7F;&#x7528;serviceaccount&#x8D26;&#x6237;</span></span><br><span class="line">    <span class="attr">KUBE_REPLICAS:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">HEALTH_CHECK:</span> <span class="string">&quot;/mta-swappie-service/actuator/health&quot;</span>  <span class="comment">#healthCheck&#x8DEF;&#x5F84;&#xFF0C;&#x6CE8;&#x610F;&#x5E26;&#x4E0A;contextPath</span></span><br><span class="line">    <span class="attr">DOCKER_REPOSITORY:</span> <span class="string">&quot;asia-northeast1-docker.pkg.dev/atrenew-docomo-uat/uat/&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start deploy &quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">gcp_creative_package</span>  <span class="string">mta-swappie-service</span> <span class="string">uat</span> <span class="comment">#&#x53C2;&#x6570;1.serviceName&#xFF08;&#x5305;&#x540D;&#xFF09; 2.&#x73AF;&#x5883;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;deploy success&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">uat</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hk-aliyun</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-gcp-prod:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">KUBE_CONFIG:</span> <span class="string">&quot;config-prod-europe&quot;</span> <span class="comment">#&#x4F7F;&#x7528;kubeconfig&#x6587;&#x4EF6;&#x540D;</span></span><br><span class="line">    <span class="attr">KUBE_SERVICE_ACCOUNT:</span> <span class="string">&quot;creative-cicd-prod-asia@atrenew-japan-docomo.iam.gserviceaccount.com&quot;</span> <span class="comment">#&#x4F7F;&#x7528;serviceaccount&#x8D26;&#x6237;</span></span><br><span class="line">    <span class="attr">KUBE_REPLICAS:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">HEALTH_CHECK:</span> <span class="string">&quot;/mta-swappie-service/actuator/health&quot;</span>  <span class="comment">#healthCheck&#x8DEF;&#x5F84;&#xFF0C;&#x6CE8;&#x610F;&#x5E26;&#x4E0A;</span></span><br><span class="line">    <span class="attr">DOCKER_REPOSITORY:</span> <span class="string">&quot;asia-northeast1-docker.pkg.dev/atrenew-japan-docomo/asia-prod-java/swappie/&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start deploy &quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">gcp_creative_package</span>  <span class="string">mta-swappie-service</span> <span class="string">prod</span> <span class="comment">#&#x53C2;&#x6570;1.serviceName&#xFF08;&#x5305;&#x540D;&#xFF09; 2.&#x73AF;&#x5883;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hk-aliyun</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-aws-uat:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">KUBE_CONFIG:</span> <span class="string">&quot;config-uat-aws-hk&quot;</span> <span class="comment">#&#x4F7F;&#x7528;kubeconfig&#x6587;&#x4EF6;&#x540D;</span></span><br><span class="line">    <span class="attr">REGION:</span> <span class="string">&quot;ap-east-1&quot;</span> <span class="comment">#&#x533A;&#x57DF;</span></span><br><span class="line">    <span class="attr">KUBE_REPLICAS:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">HEALTH_CHECK:</span> <span class="string">&quot;/mta-swappie-service/mta/web/health/check&quot;</span>  <span class="comment">#healthCheck&#x8DEF;&#x5F84;&#xFF0C;&#x6CE8;&#x610F;&#x5E26;&#x4E0A;contextPath</span></span><br><span class="line">    <span class="attr">DOCKER_REPO:</span> <span class="string">&quot;409921503514.dkr.ecr.ap-east-1.amazonaws.com&quot;</span></span><br><span class="line">    <span class="attr">DOCKER_REPOSITORY:</span> <span class="string">&quot;$DOCKER_REPO/uat-swappie&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start deploy &quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">aws_creative_package</span>  <span class="string">mta-swappie-service</span> <span class="string">uat</span> <span class="comment">#&#x53C2;&#x6570;1.serviceName&#xFF08;&#x5305;&#x540D;&#xFF09; 2.&#x73AF;&#x5883;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;deploy success&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">uat-aws</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hk-aliyun</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-aws-uat-xxg:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">KUBE_CONFIG:</span> <span class="string">&quot;config-uat-aws-mta-hk-xxg&quot;</span> <span class="comment">#&#x4F7F;&#x7528;kubeconfig&#x6587;&#x4EF6;&#x540D;</span></span><br><span class="line">    <span class="attr">REGION:</span> <span class="string">&quot;ap-east-1&quot;</span> <span class="comment">#&#x533A;&#x57DF;</span></span><br><span class="line">    <span class="attr">KUBE_REPLICAS:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">HEALTH_CHECK:</span> <span class="string">&quot;/mta-swappie-service/mta/web/health/check&quot;</span>  <span class="comment">#healthCheck&#x8DEF;&#x5F84;&#xFF0C;&#x6CE8;&#x610F;&#x5E26;&#x4E0A;contextPath</span></span><br><span class="line">    <span class="attr">DOCKER_REPO:</span> <span class="string">&quot;409921503514.dkr.ecr.ap-east-1.amazonaws.com&quot;</span></span><br><span class="line">    <span class="attr">DOCKER_REPOSITORY:</span> <span class="string">&quot;$DOCKER_REPO/uat-swappie&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start deploy &quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">groovy</span> <span class="string">./aws_deploy.groovy</span> <span class="string">mta-swappie-service</span> <span class="string">uat</span> <span class="comment">#&#x53C2;&#x6570;1.serviceName&#xFF08;&#x5305;&#x540D;&#xFF09; 2.&#x73AF;&#x5883;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;deploy success&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">uat-awsxxg</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hk-aliyun</span>    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-aws-prod:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">KUBE_CONFIG:</span> <span class="string">&quot;config-aws-prod-europe&quot;</span> <span class="comment">#&#x4F7F;&#x7528;kubeconfig&#x6587;&#x4EF6;&#x540D;</span></span><br><span class="line">    <span class="attr">REGION:</span> <span class="string">&quot;eu-central-1&quot;</span> <span class="comment">#&#x533A;&#x57DF;</span></span><br><span class="line">    <span class="attr">KUBE_REPLICAS:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">HEALTH_CHECK:</span> <span class="string">&quot;/mta-swappie-service/mta/web/health/check&quot;</span>  <span class="comment">#healthCheck&#x8DEF;&#x5F84;&#xFF0C;&#x6CE8;&#x610F;&#x5E26;&#x4E0A;contextPath</span></span><br><span class="line">    <span class="attr">DOCKER_REPO:</span> <span class="string">&quot;409921503514.dkr.ecr.eu-central-1.amazonaws.com&quot;</span></span><br><span class="line">    <span class="attr">DOCKER_REPOSITORY:</span> <span class="string">&quot;$DOCKER_REPO/prod-swappie&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;start deploy&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">groovy</span> <span class="string">./aws_deploy.groovy</span> <span class="string">mta-swappie-service</span> <span class="string">prod</span> <span class="comment">#&#x53C2;&#x6570;1.serviceName&#xFF08;&#x5305;&#x540D;&#xFF09; 2.&#x73AF;&#x5883;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;deploy success&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main-aws</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hk-aliyun</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS-EC2/" rel="tag">AWS-EC2</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
    
      <a href="/2023/07/21/18.D001.Infrastructure-AWS%E7%B3%BB%E5%88%97.1.%E5%88%9B%E5%BB%BARDS%E3%80%81ElasticCache/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">Infrastructure-AWS系列.1.创建EC2实例、LB、RDS、ElastiCache</div>
      </a>
    
  </nav>

  
   
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2023
        <i class="ri-heart-fill heart_icon"></i> xugang.xie
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="xugang.xie&#39;s blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>