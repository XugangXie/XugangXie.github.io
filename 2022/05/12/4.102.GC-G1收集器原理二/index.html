<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="一个八股文拾荒者&lt;br&gt;- A collector who is focuced on asshole-Java." />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>GC-G1收集器原理二 |  xugang.xie&#39;s blog</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <link rel="alternate" href="/atom.xml" title="xugang.xie's blog" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-4.102.GC-G1收集器原理二"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  GC-G1收集器原理二
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/05/12/4.102.GC-G1%E6%94%B6%E9%9B%86%E5%99%A8%E5%8E%9F%E7%90%86%E4%BA%8C/" class="article-date">
  <time datetime="2022-05-11T16:00:00.000Z" itemprop="datePublished">2022-05-12</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/GC/">GC</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">6.8k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">42 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/4.102.GC-G1%E6%94%B6%E9%9B%86%E5%99%A8%E5%8E%9F%E7%90%86%E4%BA%8C/1.jpg"></p>
<span id="more"></span>

<p>&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x5C31;&#x6DF1;&#x5165;&#x4E86;&#x89E3;&#x4E00;&#x4E0B;&#x5F53;&#x524D;Java GC&#x6536;&#x96C6;&#x5668;&#x4E2D;&#x7684;&#x6700;&#x65B0;&#x6D41;&#x884C;&#x7684;&#x4EE3;&#x8868;&#x4F5C;&#xFF1A;G1&#x6536;&#x96C6;&#x5668;(Garbage-First Garbage Collector)</p>
<p>G1&#x6536;&#x96C6;&#x5668;&#x662F;&#x4E00;&#x6B3E;&#x5728;server&#x7AEF;&#x8FD0;&#x884C;&#x7684;&#x5783;&#x573E;&#x6536;&#x96C6;&#x5668;&#xFF0C;&#x4E13;&#x95E8;&#x9488;&#x5BF9;&#x4E8E;&#x62E5;&#x6709;&#x591A;&#x6838;&#x5904;&#x7406;&#x5668;&#x548C;&#x5927;&#x5185;&#x5B58;&#x7684;&#x673A;&#x5668;&#xFF0C;&#x5728;JDK 7u4&#x7248;&#x672C;&#x53D1;&#x884C;&#x65F6;&#x88AB;&#x6B63;&#x5F0F;&#x63A8;&#x51FA;&#xFF0C;&#x5728;JDK9&#x4E2D;&#x66F4;&#x88AB;&#x6307;&#x5B9A;&#x4E3A;&#x5B98;&#x65B9;GC&#x6536;&#x96C6;&#x5668;&#x3002;&#x5B83;&#x6EE1;&#x8DB3;&#x9AD8;&#x541E;&#x5410;&#x91CF;&#x7684;&#x540C;&#x65F6;&#x6EE1;&#x8DB3;GC&#x505C;&#x987F;&#x7684;&#x65F6;&#x95F4;&#x5C3D;&#x53EF;&#x80FD;&#x77ED;&#x3002;G1&#x6536;&#x96C6;&#x5668;&#x4E13;&#x95E8;&#x9488;&#x5BF9;&#x4EE5;&#x4E0B;&#x5E94;&#x7528;&#x573A;&#x666F;&#x8BBE;&#x8BA1;</p>
<ul>
<li>&#x53EF;&#x4EE5;&#x50CF;CMS&#x6536;&#x96C6;&#x5668;&#x4E00;&#x6837;&#x53EF;&#x4EE5;&#x548C;&#x5E94;&#x7528;&#x5E76;&#x53D1;&#x8FD0;&#x884C;</li>
<li>&#x538B;&#x7F29;&#x7A7A;&#x95F2;&#x7684;&#x5185;&#x5B58;&#x788E;&#x7247;&#xFF0C;&#x5374;&#x4E0D;&#x9700;&#x8981;&#x5197;&#x957F;&#x7684;GC&#x505C;&#x987F;</li>
<li>&#x5BF9;GC&#x505C;&#x987F;&#x53EF;&#x4EE5;&#x505A;&#x66F4;&#x597D;&#x7684;&#x9884;&#x6D4B;</li>
<li>&#x4E0D;&#x60F3;&#x727A;&#x7272;&#x5927;&#x91CF;&#x7684;&#x541E;&#x5410;&#x91CF;&#x6027;&#x80FD;</li>
<li>&#x4E0D;&#x9700;&#x8981;&#x66F4;&#x5927;&#x7684;Java Heap</li>
</ul>
<blockquote>
<p>Can operate concurrently with applications threads like the CMS collector.<br>Compact free space without lengthy GC induced pause times.<br>Need more predictable GC pause durations.<br>Do not want to sacrifice a lot of throughput performance.<br>Do not require a much larger Java heap.</p>
</blockquote>
<p>G1&#x4ECE;&#x957F;&#x671F;&#x8BA1;&#x5212;&#x6765;&#x770B;&#x662F;&#x4EE5;&#x53D6;&#x4EE3;CMS&#x4E3A;&#x76EE;&#x6807;&#x3002;&#x4E0E;CMS&#x76F8;&#x6BD4;&#x6709;&#x51E0;&#x4E2A;&#x4E0D;&#x540C;&#x70B9;&#x4F7F;&#x5F97;G1&#x6210;&#x4E3A;GC&#x7684;&#x66F4;&#x597D;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x3002;&#x7B2C;&#x4E00;&#x70B9;&#xFF1A;G1&#x4F1A;&#x538B;&#x7F29;&#x7A7A;&#x95F2;&#x5185;&#x5B58;&#x4F7F;&#x4E4B;&#x8DB3;&#x591F;&#x7D27;&#x51D1;&#xFF0C;&#x505A;&#x6CD5;&#x662F;&#x7528;regions&#x4EE3;&#x66FF;&#x7EC6;&#x7C92;&#x5EA6;&#x7684;&#x7A7A;&#x95F2;&#x5217;&#x8868;&#x8FDB;&#x884C;&#x5206;&#x914D;&#xFF0C;&#x51CF;&#x5C11;&#x5185;&#x5B58;&#x788E;&#x7247;&#x7684;&#x4EA7;&#x751F;&#x3002;&#x7B2C;&#x4E8C;&#x70B9;&#xFF1A;G1&#x7684;STW&#x66F4;&#x53EF;&#x63A7;&#xFF0C;G1&#x5728;&#x505C;&#x987F;&#x65F6;&#x95F4;&#x4E0A;&#x6DFB;&#x52A0;&#x4E86;&#x9884;&#x6D4B;&#x673A;&#x5236;&#xFF0C;&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x671F;&#x671B;&#x505C;&#x987F;&#x65F6;&#x95F4;&#x3002;</p>
<blockquote>
<p>G1 is planned as the long term replacement for the Concurrent Mark-Sweep Collector (CMS). Comparing G1 with CMS, there are differences that make G1 a better solution. One difference is that G1 is a compacting collector. G1 compacts sufficiently to completely avoid the use of fine-grained free lists for allocation, and instead relies on regions. This considerably simplifies parts of the collector, and mostly eliminates potential fragmentation issues. Also, G1 offers more predictable garbage collection pauses than the CMS collector, and allows users to specify desired pause targets.</p>
</blockquote>
<h2 id="&#x6982;&#x89C8;"><a href="#&#x6982;&#x89C8;" class="headerlink" title="&#x6982;&#x89C8;"></a>&#x6982;&#x89C8;</h2><p>&#x5728;&#x4F20;&#x7EDF;&#x7684;GC&#x6536;&#x96C6;&#x5668;(serial,parallel,CMS)&#x65E0;&#x4E00;&#x4E0D;&#x4F8B;&#x5916;&#x90FD;&#x628A;heap&#x5206;&#x6210;&#x56FA;&#x5B9A;&#x5927;&#x5C0F;&#x8FDE;&#x7EED;&#x7684;&#x4E09;&#x4E2A;&#x7A7A;&#x95F4;&#xFF1A;young generation, old generation, and permanent generation</p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/4.102.GC-G1%E6%94%B6%E9%9B%86%E5%99%A8%E5%8E%9F%E7%90%86%E4%BA%8C/2.png"></p>
<p>&#x4F46;G1&#x5374;&#x72EC;&#x8F9F;&#x8E4A;&#x5F84;&#xFF0C;&#x91C7;&#x7528;&#x4E86;&#x4E00;&#x79CD;&#x5168;&#x65B0;&#x7684;&#x5185;&#x5B58;&#x5E03;&#x5C40;</p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/4.102.GC-G1%E6%94%B6%E9%9B%86%E5%99%A8%E5%8E%9F%E7%90%86%E4%BA%8C/3.jpg"></p>
<p>&#x5728;G1&#x4E2D;&#x5806;&#x88AB;&#x5206;&#x6210;&#x4E00;&#x5757;&#x5757;&#x5927;&#x5C0F;&#x76F8;&#x7B49;&#x7684;heap region&#xFF0C;&#x4E00;&#x822C;&#x6709;2000&#x591A;&#x5757;&#xFF0C;&#x8FD9;&#x4E9B;region&#x5728;&#x903B;&#x8F91;&#x4E0A;&#x662F;&#x8FDE;&#x7EED;&#x7684;&#x3002;&#x6BCF;&#x5757;region&#x90FD;&#x4F1A;&#x88AB;&#x6253;&#x552F;&#x4E00;&#x7684;&#x5206;&#x4EE3;&#x6807;&#x5FD7;(eden,survivor,old)&#x3002;&#x5728;&#x903B;&#x8F91;&#x4E0A;&#xFF0C;eden regions&#x6784;&#x6210;Eden&#x7A7A;&#x95F4;&#xFF0C;survivor regions&#x6784;&#x6210;Survivor&#x7A7A;&#x95F4;&#xFF0C;old regions&#x6784;&#x6210;&#x4E86;old &#x7A7A;&#x95F4;&#x3002;</p>
<p>&#x901A;&#x8FC7;&#x547D;&#x4EE4;&#x884C;&#x53C2;&#x6570;-XX:NewRatio=n&#x6765;&#x914D;&#x7F6E;&#x65B0;&#x751F;&#x4EE3;&#x4E0E;&#x8001;&#x5E74;&#x4EE3;&#x7684;&#x6BD4;&#x4F8B;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;2&#xFF0C;&#x5373;&#x6BD4;&#x4F8B;&#x4E3A;2:1&#xFF1B;-XX:SurvivorRatio=n&#x5219;&#x53EF;&#x4EE5;&#x914D;&#x7F6E;Eden&#x4E0E;Survivor&#x7684;&#x6BD4;&#x4F8B;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;8&#x3002;</p>
<p>GC&#x65F6;G1&#x7684;&#x8FD0;&#x884C;&#x65B9;&#x5F0F;&#x4E0E;CMS&#x65B9;&#x5F0F;&#x7C7B;&#x4F3C;&#xFF0C;&#x4F1A;&#x6709;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x5E76;&#x53D1;&#x6807;&#x8BB0;(concurrent global marking phase)&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x53BB;&#x786E;&#x5B9A;&#x5806;&#x91CC;&#x5BF9;&#x8C61;&#x7684;&#x7684;&#x5B58;&#x6D3B;&#x60C5;&#x51B5;&#x3002;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x5B8C;&#x6210;&#x4E4B;&#x540E;&#xFF0C;G1&#x77E5;&#x9053;&#x54EA;&#x4E9B;regions&#x7A7A;&#x95F2;&#x7A7A;&#x95F4;&#x591A;(&#x53EF;&#x56DE;&#x6536;&#x5BF9;&#x8C61;&#x591A;),&#x4F18;&#x5148;&#x56DE;&#x6536;&#x8FD9;&#x4E9B;&#x7A7A;&#x7684;regions&#xFF0C;&#x91CA;&#x653E;&#x51FA;&#x5927;&#x91CF;&#x7684;&#x7A7A;&#x95F2;&#x7A7A;&#x95F4;&#x3002;&#x8FD9;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x79CD;&#x5783;&#x573E;&#x56DE;&#x6536;&#x65B9;&#x5F0F;&#x53EB;G1&#x7684;&#x539F;&#x56E0;(Garbage-First)&#x3002;</p>
<p>G1&#x5C06;&#x5176;&#x6536;&#x96C6;&#x548C;&#x538B;&#x7F29;&#x6D3B;&#x52A8;&#x96C6;&#x4E2D;&#x5728;&#x5806;&#x4E2D;&#x53EF;&#x80FD;&#x5145;&#x6EE1;&#x53EF;&#x56DE;&#x6536;&#x5BF9;&#x8C61;(&#x5373;&#x5783;&#x573E;)&#x7684;&#x533A;&#x57DF;&#xFF0C;&#x4F7F;&#x7528;&#x6682;&#x505C;&#x9884;&#x6D4B;&#x6A21;&#x578B;&#x6765;&#x6EE1;&#x8DB3;&#x7528;&#x6237;&#x5B9A;&#x4E49;&#x7684;&#x6682;&#x505C;&#x65F6;&#x95F4;&#x76EE;&#x6807;&#xFF0C;&#x5E76;&#x6839;&#x636E;&#x6307;&#x5B9A;&#x7684;&#x6682;&#x505C;&#x65F6;&#x95F4;&#x76EE;&#x6807;&#x9009;&#x62E9;&#x8981;&#x6536;&#x96C6;&#x7684;&#x533A;&#x57DF;&#x6570;&#x91CF;&#x3002;</p>
<p>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;G1&#x4E0D;&#x662F;&#x5B9E;&#x65F6;&#x6536;&#x96C6;&#x5668;&#x3002;&#x5B83;&#x80FD;&#x591F;&#x4EE5;&#x8F83;&#x9AD8;&#x7684;&#x6982;&#x7387;&#x6EE1;&#x8DB3;&#x8BBE;&#x5B9A;&#x7684;&#x6682;&#x505C;&#x65F6;&#x95F4;&#x76EE;&#x6807;&#xFF0C;&#x4F46;&#x4E0D;&#x662F;&#x7EDD;&#x5BF9;&#x786E;&#x5B9A;&#x7684;&#x3002;&#x6839;&#x636E;&#x4EE5;&#x524D;&#x6536;&#x96C6;&#x7684;&#x6570;&#x636E;&#xFF0C;G1&#x4F30;&#x7B97;&#x51FA;&#x5728;&#x7528;&#x6237;&#x6307;&#x5B9A;&#x7684;&#x76EE;&#x6807;&#x65F6;&#x95F4;&#x5185;&#x53EF;&#x4EE5;&#x6536;&#x96C6;&#x591A;&#x5C11;&#x4E2A;&#x533A;&#x57DF;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x6536;&#x96C6;&#x5668;&#x5BF9;&#x4E8E;&#x6536;&#x96C6;&#x533A;&#x57DF;&#x7684;&#x6210;&#x672C;&#x6709;&#x4E00;&#x4E2A;&#x76F8;&#x5F53;&#x51C6;&#x786E;&#x7684;&#x6A21;&#x578B;&#xFF0C;&#x5B83;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x6A21;&#x578B;&#x6765;&#x786E;&#x5B9A;&#x5728;&#x6682;&#x505C;&#x65F6;&#x95F4;&#x76EE;&#x6807;&#x5185;&#x6536;&#x96C6;&#x54EA;&#x4E9B;&#x533A;&#x57DF;&#x548C;&#x6536;&#x96C6;&#x591A;&#x5C11;&#x533A;&#x57DF;&#x3002;</p>
<blockquote>
<p>It is important to note that G1 is not a real-time collector. It meets the set pause time target with high probability but not absolute certainty. Based on data from previous collections, G1 does an estimate of how many regions can be collected within the user specified target time. Thus, the collector has a reasonably accurate model of the cost of collecting the regions, and it uses this model to determine which and how many regions to collect while staying within the pause time target.</p>
</blockquote>
<h3 id="G1&#x4E2D;&#x7684;Region"><a href="#G1&#x4E2D;&#x7684;Region" class="headerlink" title="G1&#x4E2D;&#x7684;Region"></a>G1&#x4E2D;&#x7684;Region</h3><p>G1&#x4E2D;&#x6BCF;&#x4E2A;Region&#x5927;&#x5C0F;&#x662F;&#x56FA;&#x5B9A;&#x76F8;&#x7B49;&#x7684;&#xFF0C;Region&#x7684;&#x5927;&#x5C0F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x53C2;&#x6570;-XX:G1HeapRegionSize&#x8BBE;&#x5B9A;&#xFF0C;&#x53D6;&#x503C;&#x8303;&#x56F4;&#x4ECE;1M&#x5230;32M&#xFF0C;&#x4E14;&#x662F;2&#x7684;&#x6307;&#x6570;&#x3002;&#x5982;&#x679C;&#x4E0D;&#x8BBE;&#x5B9A;&#xFF0C;&#x90A3;&#x4E48;G1&#x4F1A;&#x6839;&#x636E;Heap&#x5927;&#x5C0F;&#x81EA;&#x52A8;&#x51B3;&#x5B9A;&#x3002;</p>
<p>&#x51B3;&#x5B9A;&#x903B;&#x8F91;:</p>
<p>size =&#xFF08;&#x5806;&#x6700;&#x5C0F;&#x503C;+&#x5806;&#x6700;&#x5927;&#x503C;&#xFF09;/ TARGET_REGION_NUMBER(2048) &#xFF0C;&#x7136;&#x540E;size&#x53D6;&#x6700;&#x9760;&#x8FD1;2&#x7684;&#x5E42;&#x6B21;&#x6570;&#x503C;&#xFF0C; &#x5E76;&#x5C06;size&#x63A7;&#x5236;&#x5728;[1M,32M]&#x4E4B;&#x95F4;&#x3002;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x5982;&#x4E0B;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// share/vm/gc_implementation/g1/heapRegion.cpp</span></span><br><span class="line"><span class="comment">// Minimum region size; we won&apos;t go lower than that.</span></span><br><span class="line"><span class="comment">// We might want to decrease this in the future, to deal with small</span></span><br><span class="line"><span class="comment">// heaps a bit more efficiently.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIN_REGION_SIZE  (      1024 * 1024 )</span></span><br><span class="line"><span class="comment">// Maximum region size; we don&apos;t go higher than that. There&apos;s a good</span></span><br><span class="line"><span class="comment">// reason for having an upper bound. We don&apos;t want regions to get too</span></span><br><span class="line"><span class="comment">// large, otherwise cleanup&apos;s effectiveness would decrease as there</span></span><br><span class="line"><span class="comment">// will be fewer opportunities to find totally empty regions after</span></span><br><span class="line"><span class="comment">// marking.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_REGION_SIZE  ( 32 * 1024 * 1024 )</span></span><br><span class="line"><span class="comment">// The automatic region size calculation will try to have around this</span></span><br><span class="line"><span class="comment">// many regions in the heap (based on the min heap size).</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TARGET_REGION_NUMBER          2048</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HeapRegion::setup_heap_region_size</span><span class="params">(<span class="type">size_t</span> initial_heap_size, <span class="type">size_t</span> max_heap_size)</span> </span>{</span><br><span class="line">  uintx region_size = G1HeapRegionSize;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">FLAG_IS_DEFAULT</span>(G1HeapRegionSize)) {</span><br><span class="line">    <span class="type">size_t</span> average_heap_size = (initial_heap_size + max_heap_size) / <span class="number">2</span>;</span><br><span class="line">    region_size = <span class="built_in">MAX2</span>(average_heap_size / TARGET_REGION_NUMBER,</span><br><span class="line">                       (uintx) MIN_REGION_SIZE);</span><br><span class="line">  }</span><br><span class="line">  <span class="type">int</span> region_size_log = <span class="built_in">log2_long</span>((jlong) region_size);</span><br><span class="line">  <span class="comment">// Recalculate the region size to make sure it&apos;s a power of</span></span><br><span class="line">  <span class="comment">// 2. This means that region_size is the largest power of 2 that&apos;s</span></span><br><span class="line">  <span class="comment">// &lt;= what we&apos;ve calculated so far.</span></span><br><span class="line">  region_size = ((uintx)<span class="number">1</span> &lt;&lt; region_size_log);</span><br><span class="line">  <span class="comment">// Now make sure that we don&apos;t go over or under our limits.</span></span><br><span class="line">  <span class="keyword">if</span> (region_size &lt; MIN_REGION_SIZE) {</span><br><span class="line">    region_size = MIN_REGION_SIZE;</span><br><span class="line">  } <span class="keyword">else</span> <span class="keyword">if</span> (region_size &gt; MAX_REGION_SIZE) {</span><br><span class="line">    region_size = MAX_REGION_SIZE;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="G1&#x4E2D;&#x7684;GC&#x6536;&#x96C6;"><a href="#G1&#x4E2D;&#x7684;GC&#x6536;&#x96C6;" class="headerlink" title="G1&#x4E2D;&#x7684;GC&#x6536;&#x96C6;"></a>G1&#x4E2D;&#x7684;GC&#x6536;&#x96C6;</h3><p>G1&#x4FDD;&#x7559;&#x4E86;YGC&#x5E76;&#x52A0;&#x4E0A;&#x4E86;&#x4E00;&#x79CD;&#x5168;&#x65B0;&#x7684;MIXGC&#x7528;&#x4E8E;&#x6536;&#x96C6;&#x8001;&#x5E74;&#x4EE3;&#x3002;G1&#x4E2D;&#x6CA1;&#x6709;Full GC&#xFF0C;G1&#x4E2D;&#x7684;Full GC&#x662F;&#x91C7;&#x7528;serial old Full GC&#x3002;</p>
<h4 id="YGC"><a href="#YGC" class="headerlink" title="YGC"></a>YGC</h4><p>&#x5F53;Eden&#x7A7A;&#x95F4;&#x88AB;&#x5360;&#x6EE1;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x4F1A;&#x89E6;&#x53D1;YGC&#x3002;&#x5728;G1&#x4E2D;YGC&#x4F9D;&#x7136;&#x91C7;&#x7528;&#x590D;&#x5236;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x5230;survivor&#x7A7A;&#x95F4;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5F53;&#x5BF9;&#x8C61;&#x7684;&#x5B58;&#x6D3B;&#x5E74;&#x9F84;&#x6EE1;&#x8DB3;&#x664B;&#x5347;&#x6761;&#x4EF6;&#x65F6;&#xFF0C;&#x628A;&#x5BF9;&#x8C61;&#x63D0;&#x5347;&#x5230;old generation regions(&#x8001;&#x5E74;&#x4EE3;)&#x3002;</p>
<p>G1&#x63A7;&#x5236;YGC&#x5F00;&#x9500;&#x7684;&#x624B;&#x6BB5;&#x662F;&#x52A8;&#x6001;&#x6539;&#x53D8;young region&#x7684;&#x4E2A;&#x6570;&#xFF0C;YGC&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x4F9D;&#x7136;&#x4F1A;STW(stop the world &#x5E94;&#x7528;&#x505C;&#x987F;)&#xFF0C;&#x5E76;&#x91C7;&#x7528;&#x591A;&#x7EBF;&#x7A0B;&#x5E76;&#x53D1;&#x590D;&#x5236;&#x5BF9;&#x8C61;&#xFF0C;&#x51CF;&#x5C11;GC&#x505C;&#x987F;&#x65F6;&#x95F4;&#x3002;</p>
<p>YGC&#x5F00;&#x59CB;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/4.102.GC-G1%E6%94%B6%E9%9B%86%E5%99%A8%E5%8E%9F%E7%90%86%E4%BA%8C/4.jpg"></p>
<p>YGC&#x7ED3;&#x675F;<br><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/4.102.GC-G1%E6%94%B6%E9%9B%86%E5%99%A8%E5%8E%9F%E7%90%86%E4%BA%8C/5.png"></p>
<p>&#x6211;&#x4EEC;&#x4ECE;&#x56FE;&#x4E2D;&#x770B;&#x5230;Eden&#x533A;&#x4E2D;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x88AB;&#x590D;&#x5236;&#x5230;&#x65B0;&#x7684;Survior&#x533A;&#x3002;</p>
<h3 id="YGC&#x662F;&#x5426;&#x9700;&#x8981;&#x626B;&#x63CF;&#x6574;&#x4E2A;&#x8001;&#x5E74;&#x4EE3;&#xFF1F;"><a href="#YGC&#x662F;&#x5426;&#x9700;&#x8981;&#x626B;&#x63CF;&#x6574;&#x4E2A;&#x8001;&#x5E74;&#x4EE3;&#xFF1F;" class="headerlink" title="YGC&#x662F;&#x5426;&#x9700;&#x8981;&#x626B;&#x63CF;&#x6574;&#x4E2A;&#x8001;&#x5E74;&#x4EE3;&#xFF1F;"></a>YGC&#x662F;&#x5426;&#x9700;&#x8981;&#x626B;&#x63CF;&#x6574;&#x4E2A;&#x8001;&#x5E74;&#x4EE3;&#xFF1F;</h3><p>&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x5224;&#x65AD;&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x5B58;&#x6D3B;&#x9700;&#x8981;&#x4ECE;GC ROOTS&#x7ED3;&#x70B9;&#x51FA;&#x53D1;&#xFF0C;&#x4ECE;GC ROOTS&#x7ED3;&#x70B9;&#x53EF;&#x8FBE;&#x7684;&#x5BF9;&#x8C61;&#x5C31;&#x662F;&#x5B58;&#x6D3B;&#x7684;&#x3002;&#x5728;YGC&#x65F6;&#xFF0C;&#x8001;&#x5E74;&#x4EE3;&#x4E2D;&#x7684;&#x5BF9;&#x8C61;&#x662F;&#x4E0D;&#x56DE;&#x6536;&#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x610F;&#x5473;&#x7740;GC ROOTS&#x91CC;&#x9762;&#x5E94;&#x5305;&#x542B;&#x4E86;&#x8001;&#x5E74;&#x4EE3;&#x4E2D;&#x7684;&#x5BF9;&#x8C61;&#x3002;<strong>&#x4F46;&#x626B;&#x63CF;&#x6574;&#x4E2A;&#x8001;&#x5E74;&#x4EE3;&#x4F1A;&#x5F88;&#x8017;&#x8D39;&#x65F6;&#x95F4;&#xFF0C;&#x52BF;&#x5FC5;&#x5F71;&#x54CD;&#x6574;&#x4E2A;GC&#x7684;&#x6027;&#x80FD;</strong>&#xFF01;&#x3002;&#x6240;&#x4EE5;&#x5728;CMS&#x4E2D;&#x4F7F;&#x7528;&#x4E86;Card Table&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x91CC;&#x9762;&#x8BB0;&#x5F55;&#x4E86;&#x8001;&#x5E74;&#x4EE3;&#x5BF9;&#x8C61;&#x5230;&#x65B0;&#x751F;&#x4EE3;&#x5F15;&#x7528;&#x3002;<strong>Card Table&#x7684;&#x7ED3;&#x6784;&#x662F;&#x4E00;&#x4E2A;&#x8FDE;&#x7EED;&#x7684;byte[]&#x6570;&#x7EC4;&#xFF0C;&#x626B;&#x63CF;Card Table&#x7684;&#x65F6;&#x95F4;&#x6BD4;&#x626B;&#x63CF;&#x6574;&#x4E2A;&#x8001;&#x5E74;&#x4EE3;&#x7684;&#x4EE3;&#x4EF7;&#x8981;&#x5C0F;&#x5F88;&#x591A;&#xFF01;G1&#x4E5F;&#x53C2;&#x7167;&#x4E86;&#x8FD9;&#x4E2A;&#x601D;&#x8DEF;&#xFF0C;&#x4E0D;&#x8FC7;&#x91C7;&#x7528;&#x4E86;&#x4E00;&#x79CD;&#x65B0;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784; Remembered Set &#x7B80;&#x79F0;Rset</strong>&#x3002;<br>RSet&#x8BB0;&#x5F55;&#x4E86;&#x5176;&#x4ED6;Region&#x4E2D;&#x7684;&#x5BF9;&#x8C61;&#x5F15;&#x7528;&#x672C;Region&#x4E2D;&#x5BF9;&#x8C61;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x5C5E;&#x4E8E;points-into&#x7ED3;&#x6784;&#xFF08;&#x8C01;&#x5F15;&#x7528;&#x4E86;&#x6211;&#x7684;&#x5BF9;&#x8C61;&#xFF09;&#x3002;&#x800C;Card Table&#x5219;&#x662F;&#x4E00;&#x79CD;points-out&#xFF08;&#x6211;&#x5F15;&#x7528;&#x4E86;&#x8C01;&#x7684;&#x5BF9;&#x8C61;&#xFF09;&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x6BCF;&#x4E2A;Card &#x8986;&#x76D6;&#x4E00;&#x5B9A;&#x8303;&#x56F4;&#x7684;Heap&#xFF08;&#x4E00;&#x822C;&#x4E3A;512Bytes&#xFF09;&#x3002;G1&#x7684;RSet&#x662F;&#x5728;Card Table&#x7684;&#x57FA;&#x7840;&#x4E0A;&#x5B9E;&#x73B0;&#x7684;&#xFF1A;&#x6BCF;&#x4E2A;Region&#x4F1A;&#x8BB0;&#x5F55;&#x4E0B;&#x522B;&#x7684;Region&#x6709;&#x6307;&#x5411;&#x81EA;&#x5DF1;&#x7684;&#x6307;&#x9488;&#xFF0C;&#x5E76;&#x6807;&#x8BB0;&#x8FD9;&#x4E9B;&#x6307;&#x9488;&#x5206;&#x522B;&#x5728;&#x54EA;&#x4E9B;Card&#x7684;&#x8303;&#x56F4;&#x5185;&#x3002; &#x8FD9;&#x4E2A;RSet&#x5176;&#x5B9E;&#x662F;&#x4E00;&#x4E2A;Hash Table&#xFF0C;Key&#x662F;&#x522B;&#x7684;Region&#x7684;&#x8D77;&#x59CB;&#x5730;&#x5740;&#xFF0C;Value&#x662F;&#x4E00;&#x4E2A;&#x96C6;&#x5408;&#xFF0C;&#x91CC;&#x9762;&#x7684;&#x5143;&#x7D20;&#x662F;Card Table&#x7684;Index&#x3002;<strong>&#x6BCF;&#x4E2A;Region&#x90FD;&#x6709;&#x4E00;&#x4E2A;&#x5BF9;&#x5E94;&#x7684;Rset</strong>&#x3002;</p>
<p><img src="https://cdn.jsdelivr.net/gh/XugangXie/xxg-img-repo@main/4.102.GC-G1%E6%94%B6%E9%9B%86%E5%99%A8%E5%8E%9F%E7%90%86%E4%BA%8C/6.jpg"></p>
<p>RSet&#x7A76;&#x7ADF;&#x662F;&#x600E;&#x4E48;&#x8F85;&#x52A9;GC&#x7684;&#x5462;&#xFF1F;&#x5728;&#x505A;YGC&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x9009;&#x5B9A;young generation region&#x7684;RSet&#x4F5C;&#x4E3A;&#x6839;&#x96C6;&#xFF0C;&#x8FD9;&#x4E9B;RSet&#x8BB0;&#x5F55;&#x4E86;old-&gt;young&#x7684;&#x8DE8;&#x4EE3;&#x5F15;&#x7528;&#xFF0C;&#x907F;&#x514D;&#x4E86;&#x626B;&#x63CF;&#x6574;&#x4E2A;old generation&#x3002; &#x800C;mixed gc&#x7684;&#x65F6;&#x5019;&#xFF0C;old generation&#x4E2D;&#x8BB0;&#x5F55;&#x4E86;old-&gt;old&#x7684;RSet&#xFF0C;young-&gt;old&#x7684;&#x5F15;&#x7528;&#x7531;&#x626B;&#x63CF;&#x5168;&#x90E8;young generation region&#x5F97;&#x5230;&#xFF0C;&#x8FD9;&#x6837;&#x4E5F;&#x4E0D;&#x7528;&#x626B;&#x63CF;&#x5168;&#x90E8;old generation region&#x3002;&#x6240;&#x4EE5;RSet&#x7684;&#x5F15;&#x5165;&#x5927;&#x5927;&#x51CF;&#x5C11;&#x4E86;GC&#x7684;&#x5DE5;&#x4F5C;&#x91CF;&#x3002;</p>
<p><strong>&#x6240;&#x4EE5;G1&#x4E2D;YGC&#x4E0D;&#x9700;&#x8981;&#x626B;&#x63CF;&#x6574;&#x4E2A;&#x8001;&#x5E74;&#x4EE3;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x626B;&#x63CF;Rset&#x5C31;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x8001;&#x5E74;&#x4EE3;&#x5F15;&#x7528;&#x4E86;&#x54EA;&#x4E9B;&#x65B0;&#x751F;&#x4EE3;&#x4E2D;&#x7684;&#x5BF9;&#x8C61;&#x3002;</strong></p>
<h4 id="MIXGC"><a href="#MIXGC" class="headerlink" title="MIXGC"></a>MIXGC</h4><p>G1&#x4E2D;&#x7684;MIXGC&#x9009;&#x5B9A;&#x6240;&#x6709;&#x65B0;&#x751F;&#x4EE3;&#x91CC;&#x7684;Region&#xFF0C;&#x5916;&#x52A0;&#x6839;&#x636E;global concurrent marking&#x7EDF;&#x8BA1;&#x5F97;&#x51FA;&#x6536;&#x96C6;&#x6536;&#x76CA;&#x9AD8;&#x7684;&#x82E5;&#x5E72;&#x8001;&#x5E74;&#x4EE3;Region&#xFF0C;&#x5728;&#x7528;&#x6237;&#x6307;&#x5B9A;&#x7684;&#x5F00;&#x9500;&#x76EE;&#x6807;&#x8303;&#x56F4;&#x5185;&#x5C3D;&#x53EF;&#x80FD;&#x9009;&#x62E9;&#x6536;&#x76CA;&#x9AD8;&#x7684;&#x8001;&#x5E74;&#x4EE3;Region&#x8FDB;&#x884C;&#x56DE;&#x6536;&#x3002;&#x6240;&#x4EE5;MIXGC&#x56DE;&#x6536;&#x7684;&#x5185;&#x5B58;&#x533A;&#x57DF;&#x662F;&#x65B0;&#x751F;&#x4EE3;+&#x8001;&#x5E74;&#x4EE3;&#x3002;</p>
<p>&#x5728;&#x4ECB;&#x7ECD;MIXGC&#x4E4B;&#x524D;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5148;&#x4E86;&#x89E3;global concurrent marking&#xFF0C;&#x5168;&#x5C40;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x3002;&#x56E0;&#x4E3A;&#x8001;&#x5E74;&#x4EE3;&#x56DE;&#x6536;&#x8981;&#x4F9D;&#x8D56;&#x8BE5;&#x8FC7;&#x7A0B;&#x3002;</p>
<h4 id="&#x5168;&#x5C40;&#x5E76;&#x53D1;&#x6807;&#x8BB0;"><a href="#&#x5168;&#x5C40;&#x5E76;&#x53D1;&#x6807;&#x8BB0;" class="headerlink" title="&#x5168;&#x5C40;&#x5E76;&#x53D1;&#x6807;&#x8BB0;"></a>&#x5168;&#x5C40;&#x5E76;&#x53D1;&#x6807;&#x8BB0;</h4><p>&#x5168;&#x5C40;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x8FC7;&#x7A0B;&#x5206;&#x4E3A;&#x4E94;&#x4E2A;&#x9636;&#x6BB5;</p>
<p>(1) Initial Mark&#x521D;&#x59CB;&#x6807;&#x8BB0; STW<br>Initial Mark&#x521D;&#x59CB;&#x6807;&#x8BB0;&#x662F;&#x4E00;&#x4E2A;STW&#x4E8B;&#x4EF6;&#xFF0C;&#x5176;&#x5B8C;&#x6210;&#x5DE5;&#x4F5C;&#x662F;&#x6807;&#x8BB0;GC ROOTS &#x76F4;&#x63A5;&#x53EF;&#x8FBE;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x5E76;&#x5C06;&#x5B83;&#x4EEC;&#x7684;&#x5B57;&#x6BB5;&#x538B;&#x5165;&#x626B;&#x63CF;&#x6808;&#xFF08;marking stack&#xFF09;&#x4E2D;&#x7B49;&#x5230;&#x540E;&#x7EED;&#x626B;&#x63CF;&#x3002;G1&#x4F7F;&#x7528;&#x5916;&#x90E8;&#x7684;bitmap&#x6765;&#x8BB0;&#x5F55;mark&#x4FE1;&#x606F;&#xFF0C;&#x800C;&#x4E0D;&#x4F7F;&#x7528;&#x5BF9;&#x8C61;&#x5934;&#x7684;mark word&#x91CC;&#x7684;mark bit&#x3002;&#x56E0;&#x4E3A; STW&#xFF0C;&#x6240;&#x4EE5;&#x901A;&#x5E38;YGC&#x7684;&#x65F6;&#x5019;&#x501F;&#x7528;YGC&#x7684;STW&#x987A;&#x4FBF;&#x542F;&#x52A8;Initial Mark&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x542F;&#x52A8;&#x5168;&#x5C40;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#xFF0C;&#x5168;&#x5C40;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x4E0E;YGC&#x5728;&#x903B;&#x8F91;&#x4E0A;&#x72EC;&#x7ACB;&#x3002;</p>
<blockquote>
<p>(1) Initial Mark<br>(Stop the World Event)This is a stop the world event. With G1, it is piggybacked on a normal young GC. Mark survivor regions (root regions) which may have references to objects in old generation.</p>
</blockquote>
<p>(2)Root Region Scanning &#x6839;&#x533A;&#x57DF;&#x626B;&#x63CF;<br>&#x6839;&#x533A;&#x57DF;&#x626B;&#x63CF;&#x662F;&#x4ECE;Survior&#x533A;&#x7684;&#x5BF9;&#x8C61;&#x51FA;&#x53D1;&#xFF0C;&#x6807;&#x8BB0;&#x88AB;&#x5F15;&#x7528;&#x5230;&#x8001;&#x5E74;&#x4EE3;&#x4E2D;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x628A;&#x5B83;&#x4EEC;&#x7684;&#x5B57;&#x6BB5;&#x5728;&#x538B;&#x5165;&#x626B;&#x63CF;&#x6808;&#xFF08;marking stack&#xFF09;&#x4E2D;&#x7B49;&#x5230;&#x540E;&#x7EED;&#x626B;&#x63CF;&#x3002;&#x4E0E;Initial Mark&#x4E0D;&#x4E00;&#x6837;&#x7684;&#x662F;&#xFF0C;Root Region Scanning&#x4E0D;&#x9700;&#x8981;STW&#x4E0E;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x662F;&#x5E76;&#x53D1;&#x8FD0;&#x884C;&#x3002;Root Region Scanning&#x5FC5;&#x987B;&#x5728;YGC&#x5F00;&#x59CB;&#x524D;&#x5B8C;&#x6210;&#x3002;</p>
<blockquote>
<p>(2) Root Region Scanning<br>Scan survivor regions for references into the old generation. This happens while the application continues to run. The phase must be completed before a young GC can occur.</p>
</blockquote>
<p>(3)Concurrent Marking &#x5E76;&#x53D1;&#x6807;&#x8BB0;<br>&#x4E0D;&#x9700;&#x8981;STW&#x3002;&#x4E0D;&#x65AD;&#x4ECE;&#x626B;&#x63CF;&#x6808;&#x53D6;&#x51FA;&#x5F15;&#x7528;&#x9012;&#x5F52;&#x626B;&#x63CF;&#x6574;&#x4E2A;&#x5806;&#x91CC;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x6BCF;&#x626B;&#x63CF;&#x5230;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x5C31;&#x4F1A;&#x5BF9;&#x5176;&#x6807;&#x8BB0;&#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x5B57;&#x6BB5;&#x538B;&#x5165;&#x626B;&#x63CF;&#x6808;&#x3002;&#x91CD;&#x590D;&#x626B;&#x63CF;&#x8FC7;&#x7A0B;&#x76F4;&#x5230;&#x626B;&#x63CF;&#x6808;&#x6E05;&#x7A7A;&#x3002;&#x8FC7;&#x7A0B;&#x4E2D;&#x8FD8;&#x4F1A;&#x626B;&#x63CF;SATB write barrier&#x6240;&#x8BB0;&#x5F55;&#x4E0B;&#x7684;&#x5F15;&#x7528;&#x3002;Concurrent Marking &#x53EF;&#x4EE5;&#x88AB;YGC&#x4E2D;&#x65AD;</p>
<blockquote>
<p>(3) Concurrent Marking<br>Find live objects over the entire heap. This happens while the application is running. This phase can be interrupted by young generation garbage collections.</p>
</blockquote>
<p>(4)Remark &#x6700;&#x7EC8;&#x6807;&#x8BB0; STW<br>STW&#x64CD;&#x4F5C;&#x3002;&#x5728;&#x5B8C;&#x6210;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x540E;&#xFF0C;&#x6BCF;&#x4E2A;Java&#x7EBF;&#x7A0B;&#x8FD8;&#x4F1A;&#x6709;&#x4E00;&#x4E9B;&#x5269;&#x4E0B;&#x7684;SATB write barrier&#x8BB0;&#x5F55;&#x7684;&#x5F15;&#x7528;&#x5C1A;&#x672A;&#x5904;&#x7406;&#x3002;&#x8FD9;&#x4E2A;&#x9636;&#x6BB5;&#x5C31;&#x8D1F;&#x8D23;&#x628A;&#x5269;&#x4E0B;&#x7684;&#x5F15;&#x7528;&#x5904;&#x7406;&#x5B8C;&#x3002;&#x540C;&#x65F6;&#x8FD9;&#x4E2A;&#x9636;&#x6BB5;&#x4E5F;&#x8FDB;&#x884C;&#x5F31;&#x5F15;&#x7528;&#x5904;&#x7406;&#xFF08;reference processing&#xFF09;&#x3002;&#x6CE8;&#x610F;&#x8FD9;&#x4E2A;&#x6682;&#x505C;&#x4E0E;CMS&#x7684;remark&#x6709;&#x4E00;&#x4E2A;&#x672C;&#x8D28;&#x4E0A;&#x7684;&#x533A;&#x522B;&#xFF0C;&#x90A3;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x6682;&#x505C;&#x53EA;&#x9700;&#x8981;&#x626B;&#x63CF;SATB buffer&#xFF0C;&#x800C;CMS&#x7684;remark&#x9700;&#x8981;&#x91CD;&#x65B0;&#x626B;&#x63CF;mod-union table&#x91CC;&#x7684;dirty card&#x5916;&#x52A0;&#x6574;&#x4E2A;&#x6839;&#x96C6;&#x5408;&#xFF0C;&#x800C;&#x6B64;&#x65F6;&#x6574;&#x4E2A;young gen&#xFF08;&#x4E0D;&#x7BA1;&#x5BF9;&#x8C61;&#x6B7B;&#x6D3B;&#xFF09;&#x90FD;&#x4F1A;&#x88AB;&#x5F53;&#x4F5C;&#x6839;&#x96C6;&#x5408;&#x7684;&#x4E00;&#x90E8;&#x5206;&#xFF0C;&#x56E0;&#x800C;CMS remark&#x6709;&#x53EF;&#x80FD;&#x4F1A;&#x975E;&#x5E38;&#x6162;&#x3002;</p>
<blockquote>
<p>(4) Remark<br>Completes the marking of live object in the heap. Uses an algorithm called snapshot-at-the-beginning (SATB) which is much faster than what was used in the CMS collector.</p>
</blockquote>
<p>(5)Cleanup &#x6E05;&#x9664; STW AND Concurrent<br>STW&#x64CD;&#x4F5C;&#xFF0C;&#x6E05;&#x70B9;&#x51FA;&#x6709;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x7684;Region&#x548C;&#x6CA1;&#x6709;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x7684;Region(Empty Region)</p>
<p>STW&#x64CD;&#x4F5C;&#xFF0C;&#x66F4;&#x65B0;Rset</p>
<p>Concurrent&#x64CD;&#x4F5C;&#xFF0C;&#x628A;Empty Region&#x6536;&#x96C6;&#x8D77;&#x6765;&#x5230;&#x53EF;&#x5206;&#x914D;Region&#x961F;&#x5217;&#x3002;</p>
<blockquote>
<p>(5) Cleanup<br>Performs accounting on live objects and completely free regions. (Stop the world)<br>Scrubs the Remembered Sets. (Stop the world)<br>Reset the empty regions and return them to the free list. (Concurrent)</p>
</blockquote>
<p><strong>&#x7ECF;&#x8FC7;global concurrent marking&#xFF0C;collector&#x5C31;&#x77E5;&#x9053;&#x54EA;&#x4E9B;Region&#x6709;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x5E76;&#x5C06;&#x90A3;&#x4E9B;&#x5B8C;&#x5168;&#x53EF;&#x56DE;&#x6536;&#x7684;Region(&#x6CA1;&#x6709;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;)&#x6536;&#x96C6;&#x8D77;&#x6765;&#x52A0;&#x5165;&#x5230;&#x53EF;&#x5206;&#x914D;Region&#x961F;&#x5217;&#xFF0C;&#x5B9E;&#x73B0;&#x5BF9;&#x8BE5;&#x90E8;&#x5206;&#x5185;&#x5B58;&#x7684;&#x56DE;&#x6536;&#x3002;&#x5BF9;&#x4E8E;&#x6709;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x7684;Region&#xFF0C;G1&#x4F1A;&#x6839;&#x636E;&#x7EDF;&#x8BA1;&#x6A21;&#x578B;&#x627E;&#x5904;&#x6536;&#x76CA;&#x6700;&#x9AD8;&#x3001;&#x5F00;&#x9500;&#x4E0D;&#x8D85;&#x8FC7;&#x7528;&#x6237;&#x6307;&#x5B9A;&#x7684;&#x4E0A;&#x9650;&#x7684;&#x82E5;&#x5E72;Region&#x8FDB;&#x884C;&#x5BF9;&#x8C61;&#x56DE;&#x6536;&#x3002;&#x8FD9;&#x4E9B;&#x9009;&#x4E2D;&#x88AB;&#x56DE;&#x6536;&#x7684;Region&#x7EC4;&#x6210;&#x7684;&#x96C6;&#x5408;&#x5C31;&#x53EB;&#x505A;collection set &#x7B80;&#x79F0;Cset&#xFF01;</strong></p>
<p><strong>&#x5728;MIXGC&#x4E2D;&#x7684;Cset&#x662F;&#x9009;&#x5B9A;&#x6240;&#x6709;young gen&#x91CC;&#x7684;region&#xFF0C;&#x5916;&#x52A0;&#x6839;&#x636E;global concurrent marking&#x7EDF;&#x8BA1;&#x5F97;&#x51FA;&#x6536;&#x96C6;&#x6536;&#x76CA;&#x9AD8;&#x7684;&#x82E5;&#x5E72;old gen region&#x3002;</strong></p>
<p><strong>&#x5728;YGC&#x4E2D;&#x7684;Cset&#x662F;&#x9009;&#x5B9A;&#x6240;&#x6709;young gen&#x91CC;&#x7684;region&#x3002;&#x901A;&#x8FC7;&#x63A7;&#x5236;young gen&#x7684;region&#x4E2A;&#x6570;&#x6765;&#x63A7;&#x5236;young GC&#x7684;&#x5F00;&#x9500;&#x3002;</strong></p>
<p><strong>YGC&#x4E0E;MIXGC&#x90FD;&#x662F;&#x91C7;&#x7528;&#x591A;&#x7EBF;&#x7A0B;&#x590D;&#x5236;&#x6E05;&#x9664;&#xFF0C;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x4F1A;STW&#x3002; G1&#x7684;&#x4F4E;&#x5EF6;&#x8FDF;&#x539F;&#x7406;&#x5728;&#x4E8E;&#x5176;&#x56DE;&#x6536;&#x7684;&#x533A;&#x57DF;&#x53D8;&#x5F97;&#x7CBE;&#x786E;&#x5E76;&#x4E14;&#x8303;&#x56F4;&#x53D8;&#x5C0F;&#x4E86;&#x3002;</strong></p>
<h3 id="STAB"><a href="#STAB" class="headerlink" title="STAB"></a>STAB</h3><p>&#x4E0A;&#x9762;global concurrent marking&#x63D0;&#x5230;&#x4E86;STAB&#x7B97;&#x6CD5;&#xFF0C;&#x90A3;&#x8FD9;&#x4E2A;STAB&#x5230;&#x5E95;&#x4E3A;&#x4F55;&#x7269;&#xFF1F;STAB&#x5168;&#x79F0;&#x4E3A;snapshot-at-the-beginning&#xFF0C;&#x5176;&#x76EE;&#x7684;&#x662F;&#x4E86;&#x7EF4;&#x6301;&#x5E76;&#x53D1;GC&#x7684;&#x6B63;&#x786E;&#x6027;&#x3002;<strong>GC&#x7684;&#x6B63;&#x786E;&#x6027;&#x662F;&#x4FDD;&#x8BC1;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x4E0D;&#x88AB;&#x56DE;&#x6536;&#xFF0C;&#x6362;&#x53E5;&#x8BDD;&#x6765;&#x8BF4;&#x5C31;&#x662F;&#x4FDD;&#x8BC1;&#x56DE;&#x6536;&#x7684;&#x90FD;&#x662F;&#x5783;&#x573E;</strong>&#x3002;&#x5982;&#x679C;&#x6807;&#x8BB0;&#x8FC7;&#x7A0B;&#x662F;STW&#x7684;&#x8BDD;&#xFF0C;&#x90A3;GC&#x7684;&#x6B63;&#x786E;&#x6027;&#x662F;&#x4E00;&#x5B9A;&#x80FD;&#x4FDD;&#x8BC1;&#x7684;&#x3002;&#x4F46;&#x5982;&#x679C;&#x4E00;&#x8FB9;&#x6807;&#x8BB0;&#xFF0C;&#x4E00;&#x8FB9;&#x5E94;&#x7528;&#x5728;&#x53D8;&#x66F4;&#x5806;&#x91CC;&#x9762;&#x5BF9;&#x8C61;&#x7684;&#x5F15;&#x7528;&#xFF0C;&#x90A3;&#x4E48;&#x6807;&#x8BB0;&#x7684;&#x6B63;&#x786E;&#x6027;&#x5C31;&#x4E0D;&#x4E00;&#x5B9A;&#x80FD;&#x4FDD;&#x8BC1;&#x4E86;&#x3002;</p>
<p><strong>&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;STAB&#x7684;&#x505A;&#x6CD5;&#x5728;GC&#x5F00;&#x59CB;&#x65F6;&#x5BF9;&#x5185;&#x5B58;&#x8FDB;&#x884C;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x56FE;&#x7684;&#x903B;&#x8F91;&#x5FEB;&#x7167;(snapshot)&#xFF0C;&#x901A;&#x8FC7;GC Roots tracing &#x53C2;&#x7167;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x53EA;&#x8981;&#x88AB;&#x5FEB;&#x7167;&#x5230;&#x5BF9;&#x8C61;&#x662F;&#x6D3B;&#x7684;&#xFF0C;&#x90A3;&#x5728;&#x6574;&#x4E2A;GC&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x5BF9;&#x8C61;&#x5C31;&#x88AB;&#x8BA4;&#x5B9A;&#x7684;&#x662F;&#x6D3B;&#x7684;&#xFF0C;&#x5373;&#x4F7F;&#x8BE5;&#x5BF9;&#x8C61;&#x7684;&#x5F15;&#x7528;&#x7A0D;&#x540E;&#x88AB;&#x4FEE;&#x6539;&#x6216;&#x8005;&#x5220;&#x9664;&#x3002;&#x540C;&#x65F6;&#x65B0;&#x5206;&#x914D;&#x7684;&#x5BF9;&#x8C61;&#x4E5F;&#x4F1A;&#x88AB;&#x8BA4;&#x4E3A;&#x662F;&#x6D3B;&#x7684;&#xFF0C;&#x9664;&#x6B64;&#x4E4B;&#x5916;&#x5176;&#x5B83;&#x4E0D;&#x53EF;&#x8FBE;&#x7684;&#x5BF9;&#x8C61;&#x5C31;&#x88AB;&#x8BA4;&#x4E3A;&#x662F;&#x6B7B;&#x6389;&#x4E86;&#x3002;&#x8FD9;&#x6837;STAB&#x5C31;&#x4FDD;&#x8BC1;&#x4E86;&#x771F;&#x6B63;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x4E0D;&#x4F1A;&#x88AB;GC&#x8BEF;&#x56DE;&#x6536;&#xFF0C;&#x4F46;&#x540C;&#x65F6;&#x4E5F;&#x9020;&#x6210;&#x4E86;&#x67D0;&#x4E9B;&#x53EF;&#x4EE5;&#x88AB;&#x56DE;&#x6536;&#x7684;&#x5BF9;&#x8C61;&#x9003;&#x8FC7;&#x4E86;GC&#xFF0C;&#x5BFC;&#x81F4;&#x4E86;&#x5185;&#x5B58;&#x91CC;&#x9762;&#x5B58;&#x5728;&#x6D6E;&#x52A8;&#x7684;&#x5783;&#x573E;(float garbage)&#x3002;</strong></p>
<p>STAB&#x5177;&#x4F53;&#x7EC6;&#x8282;&#xFF1A;</p>
<p>&#x6BCF;&#x4E2A;Region&#x4E2D;&#x90FD;&#x6709;&#x90A3;&#x4E48;&#x51E0;&#x4E2A;&#x6307;&#x9488;</p>
<p>|&lt;&#x2013; (1) &#x2013;&gt;|&lt;&#x2013; (2) &#x2013;&gt;|&lt;&#x2013; (3) &#x2013;&gt;|&lt;&#x2013; (4) &#x2013;&gt;|<br>bottom prevTAMS nextTAMS top end</p>
<p>&#x5176;&#x4E2D;top&#x662F;&#x8BE5;region&#x7684;&#x5F53;&#x524D;&#x5206;&#x914D;&#x6307;&#x9488;&#xFF0C;[bottom, top)&#x662F;&#x5F53;&#x524D;&#x8BE5;region&#x5DF2;&#x7528;&#xFF08;used&#xFF09;&#x7684;&#x90E8;&#x5206;&#xFF0C;[top, end)&#x662F;&#x5C1A;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x53EF;&#x5206;&#x914D;&#x7A7A;&#x95F4;&#xFF08;unused&#xFF09;&#x3002;</p>
<p>(1): [bottom, prevTAMS): &#x8FD9;&#x90E8;&#x5206;&#x91CC;&#x7684;&#x5BF9;&#x8C61;&#x5B58;&#x6D3B;&#x4FE1;&#x606F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;prevBitmap&#x6765;&#x5F97;&#x77E5;</p>
<p>(2): [prevTAMS, nextTAMS): &#x8FD9;&#x90E8;&#x5206;&#x91CC;&#x7684;&#x5BF9;&#x8C61;&#x5728;&#x7B2C;n-1&#x8F6E;concurrent marking&#x662F;&#x9690;&#x5F0F;&#x5B58;&#x6D3B;&#x7684;</p>
<p>(3): [nextTAMS, top): &#x8FD9;&#x90E8;&#x5206;&#x91CC;&#x7684;&#x5BF9;&#x8C61;&#x5728;&#x7B2C;n&#x8F6E;concurrent marking&#x662F;&#x9690;&#x5F0F;&#x5B58;&#x6D3B;&#x7684;</p>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x7528;prevTAMS&#x548C;nextTAMS&#x4E24;&#x4E2A;&#x6307;&#x9488;&#xFF1F;</p>
<p>&#x56E0;&#x4E3A;G1&#x7684;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x7684;&#x8FC7;&#x7A0B;&#x7528;&#x4E86;&#x4E24;&#x4E2A;bitmap&#xFF1A;</p>
<p>&#x4E00;&#x4E2A;prevBitmap&#x8BB0;&#x5F55;&#x7B2C;n-1&#x8F6E;concurrent mark&#x6240;&#x5F97;&#x7684;&#x5BF9;&#x8C61;&#x5B58;&#x6D3B;&#x72B6;&#x6001;&#x3002;&#x7531;&#x4E8E;&#x7B2C;n&#xFF0D;1&#x8F6E;concurrent marking&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;&#xFF0C;&#x8FD9;&#x4E2A;bitmap&#x7684;&#x4FE1;&#x606F;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x4E00;&#x4E2A;nextBitmap&#x8BB0;&#x5F55;&#x7B2C;n&#x8F6E;concurrent mark&#x7684;&#x7ED3;&#x679C;&#x3002;&#x8FD9;&#x4E2A;bitmap&#x662F;&#x5F53;&#x524D;&#x5C06;&#x8981;&#x6216;&#x6B63;&#x5728;&#x8FDB;&#x884C;&#x7684;concurrent mark&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x5C1A;&#x672A;&#x5B8C;&#x6210;&#xFF0C;&#x6240;&#x4EE5;&#x8FD8;&#x4E0D;&#x80FD;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x6240;&#x4EE5;Region&#x4F1A;&#x540C;&#x65F6;&#x5B58;&#x5728;prevTAMS&#x548C;nextTAMS&#x4E24;&#x4E2A;&#x6307;&#x9488;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x6307;&#x9488;&#x662F;&#x5728; Initial Mark&#x9636;&#x6BB5;&#x5C31;&#x4F1A;&#x8BBE;&#x7F6E;&#x597D;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5F88;&#x5BB9;&#x6613;&#x77E5;&#x9053;&#x54EA;&#x4E9B;&#x5BF9;&#x8C61;&#x5728;&#x4E00;&#x6B21;GC&#x5F00;&#x59CB;&#x4E4B;&#x540E;&#x65B0;&#x5206;&#x914D;&#x7684;&#xFF1A;&#x5728;TAMS&#x4EE5;&#x4E0A;&#x7684;&#x5BF9;&#x8C61;&#x5C31;&#x662F;&#x65B0;&#x5206;&#x914D;&#x7684;&#xFF0C;&#x56E0;&#x800C;&#x88AB;&#x89C6;&#x4E3A;&#x9690;&#x5F0F;marked&#xFF0C;&#x6807;&#x8BB0;&#x4E3A;&#x5B58;&#x6D3B;&#x3002;</p>
<p>&#x5207;&#x6362;&#x5230;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x573A;&#x666F;&#xFF1A;&#x5982;&#x679C;&#x5728;&#x6807;&#x8BB0;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;mark&#x4E86;&#x67D0;&#x4E2A;&#x5BF9;&#x8C61;&#x4F46;&#x5BF9;&#x8C61;&#x4E2D;&#x67D0;&#x4E9B;&#x5F15;&#x7528;&#x8FD9;&#x5B57;&#x6BB5;&#x8FD8;&#x6CA1;&#x6709;&#x88AB;mark&#x5230;,&#x6B64;&#x65F6;&#x5E94;&#x7528;&#x5E76;&#x53D1;&#x4FEE;&#x6539;&#x5F15;&#x7528;&#x5B57;&#x6BB5;&#x7684;&#x503C;&#xFF0C;&#x90A3;collecotr&#x5C31;&#x62FF;&#x4E0D;&#x5230;&#x5B8C;&#x6574;&#x7684;&#x5FEB;&#x7167;&#x4E86;&#xFF0C;&#x8FD9;&#x4E0D;&#x7B26;&#x5408;STAB&#x7684;&#x8BBE;&#x60F3;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x5C31;&#x6709;&#x4E86;SATB write barrier&#x3002;G1 GC&#x5177;&#x4F53;&#x4F7F;&#x7528;&#x7684;&#x662F;Yuasa&#x5F0F;&#x7684;SATB write barrier&#x7684;&#x53D8;&#x79CD;&#x3002;</p>
<p>Write barrier&#x662F;&#x5BF9;&#x201C;&#x5BF9;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#x5B57;&#x6BB5;&#x8D4B;&#x503C;&#x201D;&#x8FD9;&#x4E2A;&#x52A8;&#x4F5C;&#x7684;&#x73AF;&#x5207;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x8D4B;&#x503C;&#x7684;&#x524D;&#x540E;&#x90FD;&#x5728;barrier&#x8986;&#x76D6;&#x7684;&#x8303;&#x7574;&#x5185;&#x3002;&#x5728;&#x8D4B;&#x503C;&#x524D;&#x7684;&#x90E8;&#x5206;&#x7684;write barrier&#x53EB;&#x505A;pre-write barrier&#xFF0C;&#x5728;&#x8D4B;&#x503C;&#x540E;&#x7684;&#x5219;&#x53EB;&#x505A;post-write barrier&#x3002;</p>
<p>&#x5728;HotSpot VM&#x91CC;&#xFF0C;&#x5728;&#x5F15;&#x5165;G1 GC&#x4E4B;&#x524D;&#xFF0C;&#x5176;&#x5B83;GC&#x90FD;&#x53EA;&#x7528;&#x4E86;post-write barrier&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x5728;&#x6E90;&#x7801;&#x91CC;&#x6CA1;&#x6709;&#x7279;&#x522B;&#x7684;&#x524D;&#x540E;&#x7F00;&#xFF1B;&#x800C;G1 GC&#x7279;&#x6709;&#x7684;pre-write barrier&#x5219;&#x5728;&#x6E90;&#x7801;&#x91CC;&#x6709;_pre&#x7684;&#x540E;&#x7F00;&#xFF0C;&#x53EF;&#x4EE5;&#x7559;&#x610F;&#x4E00;&#x4E0B;&#x3002;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">oop_field_store</span><span class="params">(oop* field, oop value)</span> </span>{</span><br><span class="line">  <span class="built_in">pre_write_barrier</span>(field);</span><br><span class="line">  *field = value; <span class="comment">// the actual store</span></span><br><span class="line">  <span class="built_in">post_write_barrier</span>(field, value);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="1&#x3001;Pre-x2F-Post-write-barrier&#x4E0E;SATB&#x7684;&#x5173;&#x7CFB;"><a href="#1&#x3001;Pre-x2F-Post-write-barrier&#x4E0E;SATB&#x7684;&#x5173;&#x7CFB;" class="headerlink" title="1&#x3001;Pre/Post-write barrier&#x4E0E;SATB&#x7684;&#x5173;&#x7CFB;"></a>1&#x3001;Pre/Post-write barrier&#x4E0E;SATB&#x7684;&#x5173;&#x7CFB;</h3><p>&#x9762;&#x63D0;&#x5230;SATB&#x8981;&#x7EF4;&#x6301;&#x201C;&#x5728;GC&#x5F00;&#x59CB;&#x65F6;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x201D;&#x7684;&#x72B6;&#x6001;&#x8FD9;&#x4E2A;&#x903B;&#x8F91;snapshot&#x3002;&#x9664;&#x4E86;&#x4ECE;root&#x51FA;&#x53D1;&#x628A;&#x6574;&#x4E2A;&#x5BF9;&#x8C61;&#x56FE;mark&#x4E0B;&#x6765;&#x4E4B;&#x5916;&#xFF0C;&#x5176;&#x5B9E;&#x53EA;&#x9700;&#x8981;&#x7528;pre-write barrier&#x628A;&#x6BCF;&#x6B21;&#x5F15;&#x7528;&#x5173;&#x7CFB;&#x53D8;&#x5316;&#x65F6;&#x65E7;&#x7684;&#x5F15;&#x7528;&#x503C;&#x8BB0;&#x4E0B;&#x6765;&#x5C31;&#x597D;&#x4E86;&#x3002;&#x8FD9;&#x6837;&#xFF0C;&#x7B49;concurrent marker&#x5230;&#x8FBE;&#x67D0;&#x4E2A;&#x5BF9;&#x8C61;&#x65F6;&#xFF0C;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x7684;&#x6240;&#x6709;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#x5B57;&#x6BB5;&#x7684;&#x53D8;&#x5316;&#x5168;&#x90FD;&#x6709;&#x8BB0;&#x5F55;&#x5728;&#x6848;&#xFF0C;&#x5C31;&#x4E0D;&#x4F1A;&#x6F0F;&#x6389;&#x4EFB;&#x4F55;&#x5728;snapshot&#x91CC;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x5F88;&#x53EF;&#x80FD;&#x6709;&#x5BF9;&#x8C61;&#x5728;snapshot&#x4E2D;&#x662F;&#x6D3B;&#x7684;&#xFF0C;&#x4F46;&#x968F;&#x7740;&#x5E76;&#x53D1;GC&#x7684;&#x8FDB;&#x884C;&#x5B83;&#x53EF;&#x80FD;&#x672C;&#x6765;&#x5DF2;&#x7ECF;&#x6B7B;&#x4E86;&#xFF0C;&#x4F46;SATB&#x8FD8;&#x662F;&#x4F1A;&#x8BA9;&#x5B83;&#x6D3B;&#x8FC7;&#x8FD9;&#x6B21;GC&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x5728;G1 GC&#x91CC;&#xFF0C;&#x6574;&#x4E2A;write barrier+oop_field_store&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">oop_field_store</span><span class="params">(oop* field, oop new_value)</span> </span>{</span><br><span class="line">  <span class="built_in">pre_write_barrier</span>(field);             <span class="comment">// pre-write barrier: for maintaining SATB invariant</span></span><br><span class="line">  *field = new_value;                   <span class="comment">// the actual store</span></span><br><span class="line">  <span class="built_in">post_write_barrier</span>(field, new_value); <span class="comment">// post-write barrier: for tracking cross-region reference</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6309;&#x7167;Yuasa&#x5F0F;SATB barrier&#x7684;&#x8BBE;&#x8BA1;&#xFF0C;pre-write barrier&#x91CC;&#x9762;&#x7684;&#x62BD;&#x8C61;&#x903B;&#x8F91;&#x5E94;&#x5F53;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">pre_write_barrier</span><span class="params">(oop* field)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> ($gc_phase == GC_CONCURRENT_MARK) { <span class="comment">// SATB invariant only maintained during concurrent marking</span></span><br><span class="line">    oop old_value = *field;</span><br><span class="line">    <span class="keyword">if</span> (old_value != null &amp;&amp; !<span class="built_in">is_marked</span>(old_value)) {</span><br><span class="line">      <span class="built_in">mark_object</span>(old_value);</span><br><span class="line">      $mark_stack-&gt;<span class="built_in">push</span>(old_value); <span class="comment">// scan all of old_value&apos;s fields later</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x6BD4;&#x539F;&#x672C;&#x7684;Yuasa&#x5F0F;&#x8BBE;&#x8BA1;&#x5C11;&#x4E86;&#x4E9B;&#x4E1C;&#x897F;&#xFF1A;&#x6CA1;&#x6709;&#x68C0;&#x67E5;&#x76EE;&#x6807;&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x5DF2;&#x7ECF;mark&#xFF0C;&#x4E5F;&#x4E0D;&#x53BB;&#x5BF9;&#x76EE;&#x6807;&#x5BF9;&#x8C61;&#x505A;mark&#x548C;&#x626B;&#x63CF;&#x5B83;&#x7684;&#x5B57;&#x6BB5;&#x3002;&#x5B9E;&#x9645;&#x4E0A;&#x8BE5;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x8FD8;&#x662F;&#x5F97;&#x505A;&#xFF0C;&#x53EA;&#x662F;&#x4E0D;&#x5728;&#x8FD9;&#x91CC;&#x505A;&#x800C;&#x5DF2;&#x3002;&#x90A3;&#x653E;&#x5728;&#x90A3;&#x91CC;&#x505A;&#x5462;&#x653E;&#x5230;&#x4E86;&#x540E;&#x9762;&#x7684;logging barrier&#xFF0C;&#x8FD9;&#x4E2A;&#x540E;&#x9762;&#x8BB2;&#x5230;&#x3002;</p>
<p>Pre-write barrier&#x7684;&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x6709;&#x597D;&#x51E0;&#x4E2A;&#x7248;&#x672C;&#xFF0C;&#x5176;&#x4E2D;&#x6700;&#x7B80;&#x5355;&#x660E;&#x767D;&#x7684;&#x7248;&#x672C;&#x662F;&#xFF1A;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This notes that we don&apos;t need to access any BarrierSet data</span></span><br><span class="line"><span class="comment">// structures, so this can be called from a static context.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">write_ref_field_pre_static</span><span class="params">(T* field, oop newVal)</span> </span>{</span><br><span class="line">  T heap_oop = oopDesc::<span class="built_in">load_heap_oop</span>(field);</span><br><span class="line">  <span class="keyword">if</span> (!oopDesc::<span class="built_in">is_null</span>(heap_oop)) {</span><br><span class="line">    <span class="built_in">enqueue</span>(oopDesc::<span class="built_in">decode_heap_oop</span>(heap_oop));</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>enqueue&#x52A8;&#x4F5C;&#x7684;&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x5219;&#x5728;G1SATBCardTableModRefBS::enqueue(oop pre_val)&#x3002;</p>
<p>&#x5B83;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x662F;&#x5426;&#x5728;concurrent marking phase&#x7528;&#x7684;&#x662F;&#xFF1A;<br><code>JavaThread::satb_mark_queue_set().is_active()</code></p>
<h4 id="2&#x3001;logging-write-barrier"><a href="#2&#x3001;logging-write-barrier" class="headerlink" title="2&#x3001;logging write barrier"></a>2&#x3001;logging write barrier</h4><p>&#x4E3A;&#x4E86;&#x5C3D;&#x91CF;&#x51CF;&#x5C11;write barrier&#x5BF9;&#x5E94;&#x7528;mutator&#x6027;&#x80FD;&#x7684;&#x5F71;&#x54CD;&#xFF0C;G1&#x5C06;&#x4E00;&#x90E8;&#x5206;&#x539F;&#x672C;&#x8981;&#x5728;barrier&#x91CC;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x632A;&#x5230;&#x522B;&#x7684;&#x7EBF;&#x7A0B;&#x4E0A;&#x5E76;&#x53D1;&#x6267;&#x884C;&#x3002;<br>&#x5B9E;&#x73B0;&#x8FD9;&#x79CD;&#x5206;&#x79BB;&#x7684;&#x65B9;&#x5F0F;&#x5C31;&#x662F;&#x901A;&#x8FC7;logging&#x5F62;&#x5F0F;&#x7684;write barrier&#xFF1A;mutator&#x53EA;&#x5728;barrier&#x91CC;&#x628A;&#x8981;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x7684;&#x4FE1;&#x606F;&#x8BB0;&#xFF08;log&#xFF09;&#x5230;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#x91CC;&#xFF0C;&#x7136;&#x540E;&#x53E6;&#x5916;&#x7684;&#x7EBF;&#x7A0B;&#x4ECE;&#x961F;&#x5217;&#x91CC;&#x53D6;&#x51FA;&#x4FE1;&#x606F;&#x6279;&#x91CF;&#x5B8C;&#x6210;&#x5269;&#x4F59;&#x7684;&#x52A8;&#x4F5C;&#x3002;</p>
<p>&#x4EE5;SATB write barrier&#x4E3A;&#x4F8B;&#xFF0C;&#x6BCF;&#x4E2A;Java&#x7EBF;&#x7A0B;&#x6709;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x7684;&#x3001;&#x5B9A;&#x957F;&#x7684;SATBMarkQueue&#xFF0C;mutator&#x5728;barrier&#x91CC;&#x53EA;&#x628A;old_value&#x538B;&#x5165;&#x8BE5;&#x961F;&#x5217;&#x4E2D;&#x3002;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#x6EE1;&#x4E86;&#x4E4B;&#x540E;&#xFF0C;&#x5B83;&#x5C31;&#x4F1A;&#x88AB;&#x52A0;&#x5230;&#x5168;&#x5C40;&#x7684;SATB&#x961F;&#x5217;&#x96C6;&#x5408;SATBMarkQueueSet&#x91CC;&#x7B49;&#x5F85;&#x5904;&#x7406;&#xFF0C;&#x7136;&#x540E;&#x7ED9;&#x5BF9;&#x5E94;&#x7684;Java&#x7EBF;&#x7A0B;&#x6362;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x3001;&#x5E72;&#x51C0;&#x7684;&#x961F;&#x5217;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x4E0B;&#x53BB;&#x3002;</p>
<p>&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#xFF08;concurrent marker&#xFF09;&#x4F1A;&#x5B9A;&#x671F;&#x68C0;&#x67E5;&#x5168;&#x5C40;SATB&#x961F;&#x5217;&#x96C6;&#x5408;&#x7684;&#x5927;&#x5C0F;&#x3002;&#x5F53;&#x5168;&#x5C40;&#x96C6;&#x5408;&#x4E2D;&#x961F;&#x5217;&#x6570;&#x91CF;&#x8D85;&#x8FC7;&#x4E00;&#x5B9A;&#x9608;&#x503C;&#x540E;&#xFF0C;concurrent marker&#x5C31;&#x4F1A;&#x5904;&#x7406;&#x96C6;&#x5408;&#x91CC;&#x7684;&#x6240;&#x6709;&#x961F;&#x5217;&#xFF1A;&#x628A;&#x961F;&#x5217;&#x91CC;&#x8BB0;&#x5F55;&#x7684;&#x6BCF;&#x4E2A;oop&#x90FD;&#x6807;&#x8BB0;&#x4E0A;&#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x5F15;&#x7528;&#x5B57;&#x6BB5;&#x538B;&#x5230;&#x6807;&#x8BB0;&#x6808;&#xFF08;marking stack&#xFF09;&#x4E0A;&#x7B49;&#x540E;&#x9762;&#x505A;&#x8FDB;&#x4E00;&#x6B65;&#x6807;&#x8BB0;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x6574;&#x4E2A;STAB&#x8FC7;&#x7A0B;&#x8BB2;&#x5B8C;&#x3002;</p>
<h3 id="G1&#x547D;&#x4EE4;&#x884C;&#x9009;&#x9879;&#x4E0E;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;"><a href="#G1&#x547D;&#x4EE4;&#x884C;&#x9009;&#x9879;&#x4E0E;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;" class="headerlink" title="G1&#x547D;&#x4EE4;&#x884C;&#x9009;&#x9879;&#x4E0E;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;"></a>G1&#x547D;&#x4EE4;&#x884C;&#x9009;&#x9879;&#x4E0E;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;</h3><h4 id="1&#x3001;&#x547D;&#x4EE4;&#x884C;&#x9009;&#x9879;"><a href="#1&#x3001;&#x547D;&#x4EE4;&#x884C;&#x9009;&#x9879;" class="headerlink" title="1&#x3001;&#x547D;&#x4EE4;&#x884C;&#x9009;&#x9879;"></a>1&#x3001;&#x547D;&#x4EE4;&#x884C;&#x9009;&#x9879;</h4><p><code>-XX:+UseG1GC</code> &#x544A;&#x8BC9;JVM&#x4F7F;&#x7528;G1&#x6536;&#x96C6;&#x5668;</p>
<p><strong>-XX:MaxGCPauseMillis=200</strong> &#x8BBE;&#x7F6E;&#x6700;&#x5927;GC&#x76EE;&#x6807;&#x6700;&#x5927;&#x505C;&#x987F;&#x65F6;&#x95F4;&#x4E3A;200ms&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x8F6F;&#x6307;&#x6807;&#x3002;JVM&#x4F1A;&#x6700;&#x5927;&#x52AA;&#x529B;&#x53BB;&#x8FBE;&#x5230;&#x5B83;&#xFF0C;&#x56E0;&#x6B64;&#x6709;&#x65F6;&#x505C;&#x987F;&#x65F6;&#x95F4;&#x4F1A;&#x8FBE;&#x4E0D;&#x5230;&#x8BBE;&#x7F6E;&#x76EE;&#x6807;&#x3002;G1&#x914D;&#x7F6E;&#x662F;200ms</p>
<p><strong>-XX:InitiatingHeapOccupancyPercent=45</strong> &#x542F;&#x52A8;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x6807;&#x8BB0;&#x767E;&#x5206;&#x6BD4;&#xFF0C;&#x5F53;&#x6574;&#x5806;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x91CF;&#x8FBE;&#x5230;&#x767E;&#x5206;&#x6BD4;&#x65F6;&#xFF0C;G1&#x4F7F;&#x7528;&#x5B83;&#x6765;&#x89E6;&#x53D1;&#x4E00;&#x4E2A;&#x57FA;&#x4E8E;&#x6574;&#x4E2A;&#x5806;&#x7684;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x5FAA;&#x73AF;&#xFF0C;&#x800C;&#x4E0D;&#x4EC5;&#x4EC5;&#x662F;&#x4E00;&#x4E2A;&#x4EE3;&#x3002;&#x9ED8;&#x5FF5;&#x503C;&#x662F;45%</p>
<h4 id="2&#x3001;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;"><a href="#2&#x3001;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;" class="headerlink" title="2&#x3001;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;"></a>2&#x3001;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;</h4><p>&#x4E0B;&#x9762;&#x6709;&#x51E0;&#x4E2A;&#x5173;&#x4E8E;&#x4F7F;&#x7528;G1&#x7684;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;</p>
<p><strong>&#x4E0D;&#x8981;&#x8BBE;&#x7F6E;Young Generation&#x5927;&#x5C0F;</strong></p>
<p>&#x56E0;&#x4E3A;&#x663E;&#x5F0F;&#x901A;&#x8FC7;-Xmn&#x8BBE;&#x7F6E;young generation&#x5927;&#x5C0F;&#x5C06;&#x4F1A;&#x5E72;&#x9884;G1&#x6536;&#x96C6;&#x5668;&#x7684;&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;</p>
<ul>
<li>G1&#x5C06;&#x4E0D;&#x518D;&#x5C0A;&#x91CD;&#x8BBE;&#x5B9A;&#x7684;pause time,&#x672C;&#x8D28;&#x6765;&#x8BF4;&#x662F;&#x56E0;&#x4E3A;&#x8BBE;&#x7F6E;young generation&#x5927;&#x5C0F;&#x4F7F;&#x5F97;&#x8BBE;&#x5B9A;&#x7684;pause time&#x76EE;&#x6807;&#x5931;&#x6548;&#x3002;</li>
<li>G1&#x4E0D;&#x518D;&#x80FD;&#x591F;&#x6839;&#x636E;&#x9700;&#x8981;&#x6269;&#x5C55;&#x548C;&#x6536;&#x7F29;young generation&#x7684;&#x7A7A;&#x95F4;&#x3002;&#x7531;&#x4E8E;&#x5927;&#x5C0F;&#x662F;&#x56FA;&#x5B9A;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x80FD;&#x66F4;&#x6539;&#x5927;&#x5C0F;&#x3002;</li>
</ul>
<p><strong>&#x54CD;&#x5E94;&#x65F6;&#x95F4;&#x6307;&#x6807;</strong><br>&#x4E0D;&#x8981;&#x4F7F;&#x7528;&#x5E73;&#x5747;&#x54CD;&#x5E94;&#x65F6;&#x95F4;(ART)&#x4F5C;&#x4E3A;&#x6307;&#x6807;&#x6765;&#x8BBE;&#x7F6E;XX:MaxGCPauseMillis=<N>&#xFF0C;&#x800C;&#x8981;&#x8003;&#x8651;&#x8BBE;&#x7F6E;90%&#x4EE5;&#x4E0A;&#x65F6;&#x95F4;&#x90FD;&#x80FD;&#x8FBE;&#x5230;&#x76EE;&#x6807;&#x7684;&#x503C;&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;90%&#x53D1;&#x51FA;&#x8BF7;&#x6C42;&#x7684;&#x7528;&#x6237;&#x4E0D;&#x4F1A;&#x7ECF;&#x5386;&#x9AD8;&#x4E8E;&#x76EE;&#x6807;&#x7684;&#x54CD;&#x5E94;&#x65F6;&#x95F4;&#x3002;&#x8BB0;&#x4F4F;&#xFF0C;&#x6682;&#x505C;&#x65F6;&#x95F4;&#x662F;&#x4E00;&#x4E2A;&#x76EE;&#x6807;&#xFF0C;&#x5E76;&#x4E0D;&#x80FD;&#x4FDD;&#x8BC1;&#x603B;&#x80FD;&#x8FBE;&#x5230;&#x3002;</N></p>
<p><strong>&#x4EC0;&#x4E48;&#x662F;Evacuation Failure</strong><br>&#x5F53;JVM&#x5728;GC&#x671F;&#x95F4;&#x590D;&#x5236;&#x5BF9;&#x8C61;&#x5230;Survior&#x533A;&#x6216;&#x6216;&#x8005;&#x63D0;&#x5347;&#x5BF9;&#x8C61;&#x65F6;&#xFF0C;&#x5806;&#x7A7A;&#x95F4;&#x88AB;&#x8017;&#x5C3D;&#xFF0C;&#x5806;&#x533A;&#x57DF;&#x5347;&#x7EA7;&#x5931;&#x8D25;&#x3002;&#x5806;&#x65E0;&#x6CD5;&#x6269;&#x5C55;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x5DF2;&#x7ECF;&#x5904;&#x4E8E;&#x6700;&#x5927;&#x503C;&#x3002;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x5728;-XX:+PrintGCDetails&#x5C06;&#x4F1A;&#x4EE5;TO&#x7A7A;&#x95F4;&#x6EA2;&#x51FA;<code>(to-space overflow)</code>&#x7684;&#x5F62;&#x5F0F;&#x8868;&#x793A;&#x3002;&#x4EE3;&#x4EF7;&#x662F;&#x5341;&#x5206;&#x6602;&#x8D35;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;</p>
<ul>
<li>GC&#x4ECD;&#x7136;&#x9700;&#x8981;&#x7EE7;&#x7EED;&#xFF0C;&#x6240;&#x4EE5;&#x5FC5;&#x987B;&#x91CA;&#x653E;&#x7A7A;&#x95F4;</li>
<li>&#x672A;&#x6210;&#x529F;&#x590D;&#x5236;&#x7684;&#x5BF9;&#x8C61;&#x5FC5;&#x987B;&#x5728;&#x9002;&#x5F53;&#x7684;&#x4F4D;&#x7F6E;&#x4FDD;&#x7559;</li>
<li>&#x5BF9;CSet&#x4E2D;&#x533A;&#x57DF;&#x7684;rset&#x7684;&#x4EFB;&#x4F55;&#x66F4;&#x65B0;&#x90FD;&#x5FC5;&#x987B;&#x91CD;&#x65B0;&#x751F;&#x6210;</li>
<li>&#x6240;&#x6709;&#x8FD9;&#x4E9B;&#x6B65;&#x9AA4;&#x90FD;&#x5F88;&#x6602;&#x8D35;&#x3002;</li>
</ul>
<p><strong>&#x5982;&#x4F55;&#x907F;&#x514D;Evacuation Failure</strong></p>
<p>&#x4E3A;&#x4E86;&#x907F;&#x514D;Evacuation Failure&#xFF0C;&#x8003;&#x8651;&#x4EE5;&#x4E0B;&#x9009;&#x9879;&#x3002;</p>
<ul>
<li>&#x589E;&#x5927;&#x5806;&#xFF08;&#x5185;&#x5B58;)&#x5927;&#x5C0F;<ul>
<li>&#x589E;&#x5927;-XX:G1ReservePercent=n&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;10</li>
<li>G1&#x4F1A;&#x9884;&#x7559;&#x4E00;&#x90E8;&#x5206;&#x5185;&#x5B58;&#xFF0C;&#x5236;&#x9020;&#x4E00;&#x4E2A;&#x5047;&#x5929;&#x82B1;&#x677F;&#xFF0C;&#x5F53;&#x771F;&#x6B63;Evacuation Failure&#x65F6;&#x8FD8;&#x6709;&#x5185;&#x5B58;&#x53EF;&#x7528;&#x3002;</li>
</ul>
</li>
<li>&#x65E9;&#x70B9;&#x542F;&#x52A8;&#x6807;&#x8BB0;&#x5468;&#x671F;</li>
<li>&#x589E;&#x5927;&#x5E76;&#x884C;&#x6807;&#x8BB0;&#x7684;&#x7EBF;&#x7A0B;&#x6570;&#xFF0C;&#x4F7F;&#x7528;-XX:ConcGCThreads=n&#x9009;&#x9879;&#x3002;</li>
</ul>
<p><strong>&#x5B8C;&#x6574;&#x7684;G1 GC&#x5F00;&#x5173;&#x5217;&#x8868;</strong></p>
<ul>
<li>-XX:+UseG1GC &#x4F7F;&#x7528;G1 GC&#x3002;</li>
<li>-XX:MaxGCPauseMillis=n &#x8BBE;&#x7F6E;&#x6700;&#x5927;GC&#x505C;&#x987F;&#x65F6;&#x95F4;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x8F6F;&#x76EE;&#x6807;&#xFF0C;JVM&#x4F1A;&#x5C3D;&#x6700;&#x5927;&#x52AA;&#x529B;&#x53BB;&#x8FBE;&#x5230;&#x5B83;&#x3002;</li>
<li>-XX:InitiatingHeapOccupancyPercent=n &#x542F;&#x52A8;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x5FAA;&#x73AF;&#x7684;&#x5806;&#x5360;&#x7528;&#x7387;&#x7684;&#x767E;&#x5206;&#x6BD4;&#xFF0C;&#x5F53;&#x6574;&#x4E2A;&#x5806;&#x7684;&#x5360;&#x7528;&#x8FBE;&#x5230;&#x6BD4;&#x4F8B;&#x65F6;&#xFF0C;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x5FAA;&#x73AF;&#xFF0C;0&#x4EE3;&#x8868;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x4E00;&#x76F4;&#x8FD0;&#x884C;&#x3002;&#x9ED8;&#x8BA4;&#x503C;&#x662F;45%&#x3002;</li>
<li>-XX:NewRatio=n &#x65B0;&#x751F;&#x4EE3;&#x548C;&#x8001;&#x5E74;&#x4EE3;&#x5927;&#x5C0F;&#x7684;&#x6BD4;&#x4F8B;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;2&#x3002;</li>
<li>-XX:SurvivorRatio=n eden&#x548C;survivor&#x533A;&#x57DF;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#x7684;&#x6BD4;&#x4F8B;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;8&#x3002;</li>
<li>-XX:MaxTenuringThreshold=n &#x664B;&#x5347;&#x7684;&#x9608;&#x503C;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;15&#xFF08;&#x4E00;&#x4E2A;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x7ECF;&#x5386;&#x591A;&#x5C11;&#x6B21;GC&#x5468;&#x671F;&#x4E4B;&#x540E;&#x664B;&#x5347;&#x5230;&#x8001;&#x5E74;&#x4EE3;)&#x3002;</li>
<li>-XX:ParallelGCThreads=n &#x8BBE;&#x7F6E;GC&#x5E76;&#x53D1;&#x9636;&#x6BB5;&#x7684;&#x7EBF;&#x7A0B;&#x6570;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x4E0E;JVM&#x8FD0;&#x884C;&#x5E73;&#x53F0;&#x76F8;&#x5173;&#x3002;</li>
<li>-XX:ConcGCThreads=n &#x8BBE;&#x7F6E;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x7684;&#x7EBF;&#x7A0B;&#x6570;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x4E0E;JVM&#x8FD0;&#x884C;&#x5E73;&#x53F0;&#x76F8;&#x5173;&#x3002;</li>
<li>-XX:G1ReservePercent=n &#x8BBE;&#x7F6E;&#x4FDD;&#x7559;java&#x5806;&#x5927;&#x5C0F;&#x6BD4;&#x4F8B;&#xFF0C;&#x7528;&#x4E8E;&#x9632;&#x6B62;&#x664B;&#x5347;&#x5931;&#x8D25;/Evacuation Failure,&#x9ED8;&#x8BA4;&#x503C;&#x662F;10%&#x3002;</li>
<li>-XX:G1HeapRegionSize=n &#x8BBE;&#x7F6E;Region&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;&#x6839;&#x636E;&#x5806;&#x7684;&#x5927;&#x5C0F;&#x52A8;&#x6001;&#x51B3;&#x5B9A;&#xFF0C;&#x5927;&#x5C0F;&#x8303;&#x56F4;&#x662F;[1M,32M]</li>
</ul>
<h4 id="&#x4F7F;&#x7528;G1&#x8BB0;&#x5F55;GC"><a href="#&#x4F7F;&#x7528;G1&#x8BB0;&#x5F55;GC" class="headerlink" title="&#x4F7F;&#x7528;G1&#x8BB0;&#x5F55;GC"></a>&#x4F7F;&#x7528;G1&#x8BB0;&#x5F55;GC</h4><p>&#x8FD9;&#x91CC;&#x7B80;&#x8981;&#x4ECB;&#x7ECD;&#x53EF;&#x4EE5;&#x7528;&#x6765;&#x6536;&#x96C6;GC&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#x7684;&#x76F8;&#x5173;&#x914D;&#x7F6E;&#x5F00;&#x5173;&#x3002;</p>
<p><strong>1&#x3001;&#x65E5;&#x5FD7;&#x8BE6;&#x7EC6;&#x7EA7;&#x522B;</strong></p>
<p><strong>(1) -verbosegc(&#x76F8;&#x5F53;&#x4E8E;-XX:+PrintGC)</strong> &#x5C06;&#x65E5;&#x5FD7;&#x7684;&#x8BE6;&#x7EC6;&#x7EA7;&#x522B;&#x8BBE;&#x7F6E;&#x4E3A;&#x8BE6;&#x7EC6;&#x3002;</p>
<p>&#x6837;&#x4F8B;&#x8F93;&#x51FA;</p>
<blockquote>
<p>[GC pause (G1 Humongous Allocation) (young) (initial-mark) 24M- &gt;21M(64M), 0.2349730 secs]<br>[GC pause (G1 Evacuation Pause) (mixed) 66M-&gt;21M(236M), 0.1625268 secs]</p>
</blockquote>
<p>(2) <strong>-XX:+PrintGCDetails</strong> &#x5C06;&#x7EC6;&#x8282;&#x7EA7;&#x522B;&#x8BBE;&#x7F6E;&#x4E3A;&#x66F4;&#x7CBE;&#x7EC6;&#x3002;&#x9009;&#x9879;&#x663E;&#x793A;&#x4EE5;&#x4E0B;&#x4FE1;&#x606F;:</p>
<p>&#x663E;&#x793A;&#x6BCF;&#x4E2A;&#x9636;&#x6BB5;&#x7684;&#x5E73;&#x5747;&#x65F6;&#x95F4;&#x3001;&#x6700;&#x5C0F;&#x65F6;&#x95F4;&#x548C;&#x6700;&#x5927;&#x65F6;&#x95F4;&#x3002;</p>
<p>&#x6839;&#x626B;&#x63CF;&#x3001;RSet&#x66F4;&#x65B0;(&#x5E26;&#x6709;&#x5DF2;&#x5904;&#x7406;&#x7F13;&#x51B2;&#x533A;&#x4FE1;&#x606F;)&#x3001;RSet&#x626B;&#x63CF;&#x3001;&#x5BF9;&#x8C61;&#x590D;&#x5236;&#x3001;&#x7EC8;&#x6B62;(&#x5E26;&#x6709;&#x5C1D;&#x8BD5;&#x6B21;&#x6570;)&#x3002;</p>
<p>&#x8FD8;&#x663E;&#x793A;&#x201C;&#x5176;&#x4ED6;&#x201D;&#x65F6;&#x95F4;&#xFF0C;&#x5982;&#x9009;&#x62E9;CSet&#x6240;&#x82B1;&#x8D39;&#x7684;&#x65F6;&#x95F4;&#x3001;&#x5F15;&#x7528;&#x5904;&#x7406;&#x65F6;&#x95F4;&#x3001;&#x5F15;&#x7528;&#x6392;&#x961F;&#x65F6;&#x95F4;&#x548C;&#x91CA;&#x653E;CSet&#x65F6;&#x95F4;&#x3002;</p>
<p>&#x663E;&#x793A;Eden&#x3001;Survivor&#x7A7A;&#x95F4;&#x548C;&#x603B;&#x5806;&#x5360;&#x7528;&#x7387;&#x3002;</p>
<p>&#x6837;&#x4F8B;&#x8F93;&#x51FA;</p>
<blockquote>
<p>[Ext Root Scanning (ms): Avg: 1.7 Min: 0.0 Max: 3.7 Diff: 3.7]<br>[Eden: 818M(818M)-&gt;0B(714M) Survivors: 0B-&gt;104M Heap: 836M(4096M)-&gt;409M(4096M)]</p>
</blockquote>
<p>(3)<strong>-XX:+UnlockExperimentalVMOptions -XX:G1LogLevel=finest</strong> &#x7EC6;&#x8282;&#x7EA7;&#x522B;&#x6700;&#x4E3A;&#x7CBE;&#x7EC6;&#x3002;&#x7CBE;&#x7EC6;&#x5230;&#x5355;&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x4FE1;&#x606F;</p>
<p>&#x6837;&#x4F8B;&#x8F93;&#x51FA;</p>
<blockquote>
<p>[Ext Root Scanning (ms): 2.1 2.4 2.0 0.0<br>Avg: 1.6 Min: 0.0 Max: 2.4 Diff: 2.3]<br>[Update RS (ms): 0.4 0.2 0.4 0.0<br>Avg: 0.2 Min: 0.0 Max: 0.4 Diff: 0.4]<br>[Processed Buffers : 5 1 10 0<br>Sum: 16, Avg: 4, Min: 0, Max: 10, Diff: 10]</p>
</blockquote>
<p><strong>2&#x3001;&#x65F6;&#x95F4;&#x6253;&#x5370;</strong></p>
<p>&#x8FD9;&#x91CC;&#x6709;&#x4E24;&#x4E2A;&#x5173;&#x4E8E;&#x65F6;&#x95F4;&#x7684;&#x5F00;&#x5173;</p>
<p><strong>(1) -XX:+PrintGCTimeStamps</strong> - &#x663E;&#x793A;JVM&#x542F;&#x52A8;&#x540E;&#x7ECF;&#x8FC7;&#x7684;&#x65F6;&#x95F4;&#x3002;</p>
<p>&#x6837;&#x4F8B;&#x8F93;&#x51FA;</p>
<blockquote>
<p>1.729: [GC pause (young) 46M-&gt;35M(1332M), 0.0310029 secs]</p>
</blockquote>
<p>(2) <strong>-XX:+PrintGCDateStamps</strong> - &#x4E3A;&#x6BCF;&#x4E2A;&#x6761;&#x76EE;&#x6DFB;&#x52A0;&#x65E5;&#x671F;&#x524D;&#x7F00;&#x3002;</p>
<p>&#x6837;&#x4F8B;&#x8F93;&#x51FA;</p>
<blockquote>
<p>2012-05-02T11:16:32.057+0200: [GC pause (young) 46M-&gt;35M(1332M), 0.0317225 secs]</p>
</blockquote>
<h3 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h3><p>&#x5728;&#x6587;&#x7AE0;&#x4ECB;&#x7ECD;&#x4E86;&#x5F88;&#x591A;&#x5173;&#x4E8E;G1&#x7684;&#x4E00;&#x4E9B;&#x539F;&#x7406;&#x548C;&#x6982;&#x5FF5;</p>
<p>&#x6700;&#x540E;&#x7B80;&#x5355;&#x5F52;&#x7EB3;&#x4E00;&#x4E0B;&#xFF1A;</p>
<ul>
<li>G1&#x628A;&#x5185;&#x5B58;&#x5206;&#x6210;&#x4E00;&#x5757;&#x5757;&#x7684;Region&#xFF0C;&#x6BCF;&#x5757;&#x7684;Region&#x7684;&#x5927;&#x5C0F;&#x90FD;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;</li>
<li>G1&#x4FDD;&#x7559;&#x4E86;YGC&#x5E76;&#x52A0;&#x4E0A;&#x4E86;&#x4E00;&#x79CD;&#x5168;&#x65B0;&#x7684;MIXGC&#x7528;&#x4E8E;&#x6536;&#x96C6;&#x8001;&#x5E74;&#x4EE3;&#x3002;G1&#x4E2D;&#x6CA1;&#x6709;Full GC&#xFF0C;G1&#x4E2D;&#x7684;Full GC&#x662F;&#x91C7;&#x7528;serial old Full GC&#x3002;&#x5728;MIXGC&#x4E2D;&#x7684;Cset&#x662F;&#x9009;&#x5B9A;&#x6240;&#x6709;young gen&#x91CC;&#x7684;region&#xFF0C;&#x5916;&#x52A0;&#x6839;&#x636E;global concurrent marking&#x7EDF;&#x8BA1;&#x5F97;&#x51FA;&#x6536;&#x96C6;&#x6536;&#x76CA;&#x9AD8;&#x7684;&#x82E5;&#x5E72;old gen region&#x3002;&#x5728;YGC&#x4E2D;&#x7684;Cset&#x662F;&#x9009;&#x5B9A;&#x6240;&#x6709;young gen&#x91CC;&#x7684;region&#x3002;&#x901A;&#x8FC7;&#x63A7;&#x5236;young gen&#x7684;region&#x4E2A;&#x6570;&#x6765;&#x63A7;&#x5236;young GC&#x7684;&#x5F00;&#x9500;&#x3002;YGC&#x4E0E;MIXGC&#x90FD;&#x662F;&#x91C7;&#x7528;&#x591A;&#x7EBF;&#x7A0B;&#x590D;&#x5236;&#x6E05;&#x9664;&#xFF0C;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x4F1A;STW&#x3002;</li>
<li>G1&#x7684;&#x4F4E;&#x5EF6;&#x8FDF;&#x539F;&#x7406;&#x5728;&#x4E8E;&#x5176;&#x56DE;&#x6536;&#x7684;&#x533A;&#x57DF;&#x53D8;&#x5F97;&#x7CBE;&#x786E;&#x5E76;&#x4E14;&#x8303;&#x56F4;&#x53D8;&#x5C0F;&#x4E86;&#x3002;</li>
<li>&#x5168;&#x5C40;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x5206;&#x7684;&#x4E94;&#x4E2A;&#x9636;&#x6BB5;&#x3002;</li>
<li>&#x7528;STAB&#x6765;&#x7EF4;&#x6301;&#x5E76;&#x53D1;GC&#x7684;&#x51C6;&#x786E;&#x6027;&#x3002;</li>
<li>&#x4F7F;&#x7528;G1&#x7684;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;</li>
<li>G1 GC&#x65E5;&#x5FD7;&#x6253;&#x5370;</li>
</ul>
<h3 id="&#x53C2;&#x8003;&#xFF1A;"><a href="#&#x53C2;&#x8003;&#xFF1A;" class="headerlink" title="&#x53C2;&#x8003;&#xFF1A;"></a>&#x53C2;&#x8003;&#xFF1A;</h3><ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/52841787">G1 &#x6536;&#x96C6;&#x5668;&#x539F;&#x7406;&#x7406;&#x89E3;&#x4E0E;&#x5206;&#x6790;</a></li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/G1/" rel="tag">G1</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2022/05/12/4.008.GC-Shenadoah%E6%94%B6%E9%9B%86%E5%99%A8/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            GC-Shenadoah收集器
          
        </div>
      </a>
    
    
      <a href="/2022/05/12/4.101.GC-G1%E6%94%B6%E9%9B%86%E5%99%A8%E5%8E%9F%E7%90%86%E4%B8%80/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">GC-G1收集器原理原理一</div>
      </a>
    
  </nav>

  
   
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2023
        <i class="ri-heart-fill heart_icon"></i> xugang.xie
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="xugang.xie&#39;s blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>