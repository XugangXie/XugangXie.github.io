<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="一个八股文拾荒者&lt;br&gt;- A collector who is focuced on asshole-Java." />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>框架-SpringCloud-Gateway-throwable系列-Spring Cloud Gateway-ServerWebExchange核心方法与请求或者响应内容的修改 |  xugang.xie&#39;s blog</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <link rel="alternate" href="/atom.xml" title="xugang.xie's blog" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-9G5.009.框架-SpringCloud-Gateway-throwable系列-Spring Cloud Gateway-ServerWebExchange核心方法与请求或者响应内容的修改"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  框架-SpringCloud-Gateway-throwable系列-Spring Cloud Gateway-ServerWebExchange核心方法与请求或者响应内容的修改
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2021/09/01/9G5.009.%E6%A1%86%E6%9E%B6-SpringCloud-Gateway-throwable%E7%B3%BB%E5%88%97-Spring%20Cloud%20Gateway-ServerWebExchange%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95%E4%B8%8E%E8%AF%B7%E6%B1%82%E6%88%96%E8%80%85%E5%93%8D%E5%BA%94%E5%86%85%E5%AE%B9%E7%9A%84%E4%BF%AE%E6%94%B9/" class="article-date">
  <time datetime="2021-08-31T16:00:00.000Z" itemprop="datePublished">2021-09-01</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Framework-%E6%A1%86%E6%9E%B6/">Framework-框架</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">9.8k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">60 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p><img src="/2021/09/01/9G5.009.%E6%A1%86%E6%9E%B6-SpringCloud-Gateway-throwable%E7%B3%BB%E5%88%97-Spring%20Cloud%20Gateway-ServerWebExchange%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95%E4%B8%8E%E8%AF%B7%E6%B1%82%E6%88%96%E8%80%85%E5%93%8D%E5%BA%94%E5%86%85%E5%AE%B9%E7%9A%84%E4%BF%AE%E6%94%B9/spring-cloud-logo.png"></p>
<span id="more"></span>
<h1 id="&#x524D;&#x63D0;"><a href="#&#x524D;&#x63D0;" class="headerlink" title="&#x524D;&#x63D0;"></a>&#x524D;&#x63D0;</h1><p>&#x672C;&#x6587;&#x7F16;&#x5199;&#x7684;&#x65F6;&#x5019;&#x4F7F;&#x7528;&#x7684;Spring Cloud Gateway&#x7248;&#x672C;&#x4E3A;&#x5F53;&#x65F6;&#x6700;&#x65B0;&#x7684;&#x7248;&#x672C;Greenwich.SR1&#x3002;<br>&#x6211;&#x4EEC;&#x5728;&#x4F7F;&#x7528;Spring Cloud Gateway&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6CE8;&#x610F;&#x5230;&#x8FC7;&#x6EE4;&#x5668;&#xFF08;&#x5305;&#x62EC;GatewayFilter&#x3001;GlobalFilter&#x548C;&#x8FC7;&#x6EE4;&#x5668;&#x94FE;GatewayFilterChain&#xFF09;&#xFF0C;&#x90FD;&#x4F9D;&#x8D56;&#x5230;ServerWebExchange&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GlobalFilter</span> {</span><br><span class="line"></span><br><span class="line">    Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GatewayFilter</span> <span class="keyword">extends</span> <span class="title class_">ShortcutConfigurable</span> {</span><br><span class="line"></span><br><span class="line">	Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GatewayFilterChain</span> {</span><br><span class="line"></span><br><span class="line">    Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange)</span>;</span><br><span class="line">}    </span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7684;&#x8BBE;&#x8BA1;&#x548C;Servlet&#x4E2D;&#x7684;Filter&#x662F;&#x76F8;&#x4F3C;&#x7684;&#xFF0C;&#x5F53;&#x524D;&#x8FC7;&#x6EE4;&#x5668;&#x53EF;&#x4EE5;&#x51B3;&#x5B9A;&#x662F;&#x5426;&#x6267;&#x884C;&#x4E0B;&#x4E00;&#x4E2A;&#x8FC7;&#x6EE4;&#x5668;&#x7684;&#x903B;&#x8F91;&#xFF0C;&#x7531;GatewayFilterChain#filter()&#x662F;&#x5426;&#x88AB;&#x8C03;&#x7528;&#x6765;&#x51B3;&#x5B9A;&#x3002;&#x800C;ServerWebExchange&#x5C31;&#x76F8;&#x5F53;&#x4E8E;&#x5F53;&#x524D;&#x8BF7;&#x6C42;&#x548C;&#x54CD;&#x5E94;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x3002;ServerWebExchange&#x5B9E;&#x4F8B;&#x4E0D;&#x5355;&#x5B58;&#x50A8;&#x4E86;Request&#x548C;Response&#x5BF9;&#x8C61;&#xFF0C;&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E9B;&#x6269;&#x5C55;&#x65B9;&#x6CD5;&#xFF0C;&#x5982;&#x679C;&#x60F3;&#x5B9E;&#x73B0;&#x6539;&#x9020;&#x8BF7;&#x6C42;&#x53C2;&#x6570;&#x6216;&#x8005;&#x54CD;&#x5E94;&#x53C2;&#x6570;&#xFF0C;&#x5C31;&#x5FC5;&#x987B;&#x6DF1;&#x5165;&#x4E86;&#x89E3;ServerWebExchange&#x3002;</p>
<h1 id="&#x7406;&#x89E3;ServerWebExchange"><a href="#&#x7406;&#x89E3;ServerWebExchange" class="headerlink" title="&#x7406;&#x89E3;ServerWebExchange"></a>&#x7406;&#x89E3;ServerWebExchange</h1><p>&#x5148;&#x770B;ServerWebExchange&#x7684;&#x6CE8;&#x91CA;&#xFF1A;</p>
<blockquote>
<p>Contract for an HTTP request-response interaction. Provides access to the HTTP request and response and also exposes additional server-side processing related properties and features such as request attributes.</p>
</blockquote>
<p>&#x7FFB;&#x8BD1;&#x4E00;&#x4E0B;&#x5927;&#x6982;&#x662F;&#xFF1A;</p>
<blockquote>
<p>ServerWebExchange&#x662F;&#x4E00;&#x4E2A;HTTP&#x8BF7;&#x6C42;-&#x54CD;&#x5E94;&#x4EA4;&#x4E92;&#x7684;&#x5951;&#x7EA6;&#x3002;&#x63D0;&#x4F9B;&#x5BF9;HTTP&#x8BF7;&#x6C42;&#x548C;&#x54CD;&#x5E94;&#x7684;&#x8BBF;&#x95EE;&#xFF0C;&#x5E76;&#x516C;&#x5F00;&#x989D;&#x5916;&#x7684;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5904;&#x7406;&#x76F8;&#x5173;&#x5C5E;&#x6027;&#x548C;&#x7279;&#x6027;&#xFF0C;&#x5982;&#x8BF7;&#x6C42;&#x5C5E;&#x6027;&#x3002;</p>
</blockquote>
<p>&#x5176;&#x5B9E;&#xFF0C;ServerWebExchange&#x547D;&#x540D;&#x4E3A;&#x670D;&#x52A1;&#x7F51;&#x7EDC;&#x4EA4;&#x6362;&#x5668;&#xFF0C;&#x5B58;&#x653E;&#x7740;&#x91CD;&#x8981;&#x7684;&#x8BF7;&#x6C42;-&#x54CD;&#x5E94;&#x5C5E;&#x6027;&#x3001;&#x8BF7;&#x6C42;&#x5B9E;&#x4F8B;&#x548C;&#x54CD;&#x5E94;&#x5B9E;&#x4F8B;&#x7B49;&#x7B49;&#xFF0C;&#x6709;&#x70B9;&#x50CF;Context&#x7684;&#x89D2;&#x8272;&#x3002;</p>
<h2 id="ServerWebExchange&#x63A5;&#x53E3;"><a href="#ServerWebExchange&#x63A5;&#x53E3;" class="headerlink" title="ServerWebExchange&#x63A5;&#x53E3;"></a>ServerWebExchange&#x63A5;&#x53E3;</h2><p>ServerWebExchange&#x63A5;&#x53E3;&#x7684;&#x6240;&#x6709;&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ServerWebExchange</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x65E5;&#x5FD7;&#x524D;&#x7F00;&#x5C5E;&#x6027;&#x7684;KEY&#xFF0C;&#x503C;&#x4E3A;org.springframework.web.server.ServerWebExchange.LOG_ID</span></span><br><span class="line">    <span class="comment">// &#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A; attributes.set(&quot;org.springframework.web.server.ServerWebExchange.LOG_ID&quot;,&quot;&#x65E5;&#x5FD7;&#x524D;&#x7F00;&#x7684;&#x5177;&#x4F53;&#x503C;&quot;);</span></span><br><span class="line">    <span class="comment">// &#x4F5C;&#x7528;&#x662F;&#x6253;&#x5370;&#x65E5;&#x5FD7;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x62FC;&#x63A5;&#x8FD9;&#x4E2A;KEY&#x5BF9;&#x996E;&#x7684;&#x524D;&#x7F00;&#x503C;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A;&quot;&quot;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">LOG_ID_ATTRIBUTE</span> <span class="operator">=</span> ServerWebExchange.class.getName() + <span class="string">&quot;.LOG_ID&quot;</span>;</span><br><span class="line">    String <span class="title function_">getLogPrefix</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x83B7;&#x53D6;ServerHttpRequest&#x5BF9;&#x8C61;</span></span><br><span class="line">    ServerHttpRequest <span class="title function_">getRequest</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x83B7;&#x53D6;ServerHttpResponse&#x5BF9;&#x8C61;</span></span><br><span class="line">    ServerHttpResponse <span class="title function_">getResponse</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8FD4;&#x56DE;&#x5F53;&#x524D;exchange&#x7684;&#x8BF7;&#x6C42;&#x5C5E;&#x6027;&#xFF0C;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x662F;&#x4E00;&#x4E2A;&#x53EF;&#x53D8;&#x7684;Map</span></span><br><span class="line">    Map&lt;String, Object&gt; <span class="title function_">getAttributes</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x6839;&#x636E;KEY&#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x5C5E;&#x6027;</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">default</span> &lt;T&gt; T <span class="title function_">getAttribute</span><span class="params">(String name)</span> {</span><br><span class="line">        <span class="keyword">return</span> (T) getAttributes().get(name);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x6839;&#x636E;KEY&#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x5C5E;&#x6027;&#xFF0C;&#x505A;&#x4E86;&#x975E;&#x7A7A;&#x5224;&#x65AD;</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">default</span> &lt;T&gt; T <span class="title function_">getRequiredAttribute</span><span class="params">(String name)</span> {</span><br><span class="line">        <span class="type">T</span> <span class="variable">value</span> <span class="operator">=</span> getAttribute(name);</span><br><span class="line">        Assert.notNull(value, () -&gt; <span class="string">&quot;Required attribute &apos;&quot;</span> + name + <span class="string">&quot;&apos; is missing&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">     <span class="comment">// &#x6839;&#x636E;KEY&#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x5C5E;&#x6027;&#xFF0C;&#x9700;&#x8981;&#x63D0;&#x4F9B;&#x9ED8;&#x8BA4;&#x503C;</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">default</span> &lt;T&gt; T <span class="title function_">getAttributeOrDefault</span><span class="params">(String name, T defaultValue)</span> {</span><br><span class="line">        <span class="keyword">return</span> (T) getAttributes().getOrDefault(name, defaultValue);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8FD4;&#x56DE;&#x5F53;&#x524D;&#x8BF7;&#x6C42;&#x7684;&#x7F51;&#x7EDC;&#x4F1A;&#x8BDD;</span></span><br><span class="line">    Mono&lt;WebSession&gt; <span class="title function_">getSession</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8FD4;&#x56DE;&#x5F53;&#x524D;&#x8BF7;&#x6C42;&#x7684;&#x8BA4;&#x8BC1;&#x7528;&#x6237;&#xFF0C;&#x5982;&#x679C;&#x5B58;&#x5728;&#x7684;&#x8BDD;</span></span><br><span class="line">    &lt;T <span class="keyword">extends</span> <span class="title class_">Principal</span>&gt; Mono&lt;T&gt; <span class="title function_">getPrincipal</span><span class="params">()</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8FD4;&#x56DE;&#x8BF7;&#x6C42;&#x7684;&#x8868;&#x5355;&#x6570;&#x636E;&#x6216;&#x8005;&#x4E00;&#x4E2A;&#x7A7A;&#x7684;Map&#xFF0C;&#x53EA;&#x6709;Content-Type&#x4E3A;application/x-www-form-urlencoded&#x7684;&#x65F6;&#x5019;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x624D;&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x975E;&#x7A7A;&#x7684;Map -- &#x8FD9;&#x4E2A;&#x4E00;&#x822C;&#x662F;&#x8868;&#x5355;&#x6570;&#x636E;&#x63D0;&#x4EA4;&#x7528;&#x5230;</span></span><br><span class="line">    Mono&lt;MultiValueMap&lt;String, String&gt;&gt; <span class="title function_">getFormData</span><span class="params">()</span>;   </span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8FD4;&#x56DE;multipart&#x8BF7;&#x6C42;&#x7684;part&#x6570;&#x636E;&#x6216;&#x8005;&#x4E00;&#x4E2A;&#x7A7A;&#x7684;Map&#xFF0C;&#x53EA;&#x6709;Content-Type&#x4E3A;multipart/form-data&#x7684;&#x65F6;&#x5019;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x624D;&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x975E;&#x7A7A;&#x7684;Map  -- &#x8FD9;&#x4E2A;&#x4E00;&#x822C;&#x662F;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x7528;&#x5230;</span></span><br><span class="line">    Mono&lt;MultiValueMap&lt;String, Part&gt;&gt; <span class="title function_">getMultipartData</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8FD4;&#x56DE;Spring&#x7684;&#x4E0A;&#x4E0B;&#x6587;</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    ApplicationContext <span class="title function_">getApplicationContext</span><span class="params">()</span>;   </span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8FD9;&#x51E0;&#x4E2A;&#x65B9;&#x6CD5;&#x548C;lastModified&#x5C5E;&#x6027;&#x76F8;&#x5173;</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isNotModified</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">checkNotModified</span><span class="params">(Instant lastModified)</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">checkNotModified</span><span class="params">(String etag)</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">checkNotModified</span><span class="params">(<span class="meta">@Nullable</span> String etag, Instant lastModified)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// URL&#x8F6C;&#x6362;</span></span><br><span class="line">    String <span class="title function_">transformUrl</span><span class="params">(String url)</span>;    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// URL&#x8F6C;&#x6362;&#x6620;&#x5C04;</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addUrlTransformer</span><span class="params">(Function&lt;String, String&gt; transformer)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x6CE8;&#x610F;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x65B9;&#x6CD5;&#x540D;&#x662F;&#xFF1A;&#x6539;&#x53D8;&#xFF0C;&#x8FD9;&#x4E2A;&#x662F;&#x4FEE;&#x6539;ServerWebExchange&#x5C5E;&#x6027;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD4;&#x56DE;&#x7684;&#x662F;&#x4E00;&#x4E2A;Builder&#x5B9E;&#x4F8B;&#xFF0C;Builder&#x662F;ServerWebExchange&#x7684;&#x5185;&#x90E8;&#x7C7B;</span></span><br><span class="line">    <span class="keyword">default</span> Builder <span class="title function_">mutate</span><span class="params">()</span> {</span><br><span class="line">	     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultServerWebExchangeBuilder</span>(<span class="built_in">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Builder</span> {      </span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#x8986;&#x76D6;ServerHttpRequest</span></span><br><span class="line">        Builder <span class="title function_">request</span><span class="params">(Consumer&lt;ServerHttpRequest.Builder&gt; requestBuilderConsumer)</span>;</span><br><span class="line">        Builder <span class="title function_">request</span><span class="params">(ServerHttpRequest request)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#x8986;&#x76D6;ServerHttpResponse</span></span><br><span class="line">        Builder <span class="title function_">response</span><span class="params">(ServerHttpResponse response)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#x8986;&#x76D6;&#x5F53;&#x524D;&#x8BF7;&#x6C42;&#x7684;&#x8BA4;&#x8BC1;&#x7528;&#x6237;</span></span><br><span class="line">        Builder <span class="title function_">principal</span><span class="params">(Mono&lt;Principal&gt; principalMono)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#x6784;&#x5EFA;&#x65B0;&#x7684;ServerWebExchange&#x5B9E;&#x4F8B;</span></span><br><span class="line">        ServerWebExchange <span class="title function_">build</span><span class="params">()</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6CE8;&#x610F;&#x5230;ServerWebExchange#mutate()&#x65B9;&#x6CD5;&#xFF0C;ServerWebExchange&#x5B9E;&#x4F8B;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x4E0D;&#x53EF;&#x53D8;&#x5B9E;&#x4F8B;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x4FEE;&#x6539;&#x5B83;&#xFF0C;&#x9700;&#x8981;&#x901A;&#x8FC7;mutate()&#x65B9;&#x6CD5;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x4F8B;&#x5982;&#x8FD9;&#x6837;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {</span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="comment">// &#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x4FEE;&#x6539;ServerHttpRequest&#x5B9E;&#x4F8B;</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">newRequest</span> <span class="operator">=</span> ...</span><br><span class="line">        <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">        <span class="comment">// &#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x4FEE;&#x6539;ServerHttpResponse&#x5B9E;&#x4F8B;</span></span><br><span class="line">        <span class="type">ServerHttpResponse</span> <span class="variable">newResponse</span> <span class="operator">=</span> ...</span><br><span class="line">        <span class="comment">// &#x6784;&#x5EFA;&#x65B0;&#x7684;ServerWebExchange&#x5B9E;&#x4F8B;</span></span><br><span class="line">        <span class="type">ServerWebExchange</span> <span class="variable">newExchange</span> <span class="operator">=</span> exchange.mutate().request(newRequest).response(newResponse).build();</span><br><span class="line">        <span class="keyword">return</span> chain.filter(newExchange);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="ServerHttpRequest&#x63A5;&#x53E3;"><a href="#ServerHttpRequest&#x63A5;&#x53E3;" class="headerlink" title="ServerHttpRequest&#x63A5;&#x53E3;"></a>ServerHttpRequest&#x63A5;&#x53E3;</h2><p>ServerHttpRequest&#x5B9E;&#x4F8B;&#x662F;&#x7528;&#x4E8E;&#x627F;&#x8F7D;&#x8BF7;&#x6C42;&#x76F8;&#x5173;&#x7684;&#x5C5E;&#x6027;&#x548C;&#x8BF7;&#x6C42;&#x4F53;&#xFF0C;Spring Cloud Gateway&#x4E2D;&#x5E95;&#x5C42;&#x4F7F;&#x7528;Netty&#x5904;&#x7406;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#xFF0C;&#x901A;&#x8FC7;&#x8FFD;&#x6EAF;&#x6E90;&#x7801;&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE;ReactorHttpHandlerAdapter&#x4E2D;&#x5F97;&#x77E5;ServerWebExchange&#x5B9E;&#x4F8B;&#x4E2D;&#x6301;&#x6709;&#x7684;ServerHttpRequest&#x5B9E;&#x4F8B;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x662F;ReactorServerHttpRequest&#x3002;&#x4E4B;&#x6240;&#x4EE5;&#x5217;&#x51FA;&#x8FD9;&#x4E9B;&#x5B9E;&#x4F8B;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x662F;&#x56E0;&#x4E3A;&#x8FD9;&#x6837;&#x6BD4;&#x8F83;&#x5BB9;&#x6613;&#x7406;&#x6E05;&#x4E00;&#x4E9B;&#x9690;&#x542B;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;</p>
<ul>
<li>ReactorServerHttpRequest&#x7684;&#x7236;&#x7C7B;AbstractServerHttpRequest&#x4E2D;&#x521D;&#x59CB;&#x5316;&#x5185;&#x90E8;&#x5C5E;&#x6027;headers&#x7684;&#x65F6;&#x5019;&#x628A;&#x8BF7;&#x6C42;&#x7684;HTTP&#x5934;&#x90E8;&#x5C01;&#x88C5;&#x4E3A;&#x53EA;&#x8BFB;&#x7684;&#x5B9E;&#x4F8B;&#xFF1A;<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AbstractServerHttpRequest</span><span class="params">(URI uri, <span class="meta">@Nullable</span> String contextPath, HttpHeaders headers)</span> {</span><br><span class="line">	<span class="built_in">this</span>.uri = uri;</span><br><span class="line">	<span class="built_in">this</span>.path = RequestPath.parse(uri, contextPath);</span><br><span class="line">	<span class="built_in">this</span>.headers = HttpHeaders.readOnlyHttpHeaders(headers);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// HttpHeaders&#x7C7B;&#x4E2D;&#x7684;readOnlyHttpHeaders&#x65B9;&#x6CD5;&#xFF0C;&#x5176;&#x4E2D;ReadOnlyHttpHeaders&#x5C4F;&#x853D;&#x4E86;&#x6240;&#x6709;&#x4FEE;&#x6539;&#x8BF7;&#x6C42;&#x5934;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x76F4;&#x63A5;&#x629B;&#x51FA;UnsupportedOperationException</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> HttpHeaders <span class="title function_">readOnlyHttpHeaders</span><span class="params">(HttpHeaders headers)</span> {</span><br><span class="line">	Assert.notNull(headers, <span class="string">&quot;HttpHeaders must not be null&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (headers <span class="keyword">instanceof</span> ReadOnlyHttpHeaders) {</span><br><span class="line">		<span class="keyword">return</span> headers;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span> {</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReadOnlyHttpHeaders</span>(headers);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
&#x6240;&#x4EE5;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x4ECE;ServerHttpRequest&#x5B9E;&#x4F8B;&#x4E2D;&#x76F4;&#x63A5;&#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x5934;HttpHeaders&#x5B9E;&#x4F8B;&#x5E76;&#x4E14;&#x8FDB;&#x884C;&#x4FEE;&#x6539;&#x3002;</li>
</ul>
<p>ServerHttpRequest&#x63A5;&#x53E3;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HttpMessage</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x5934;&#xFF0C;&#x76EE;&#x524D;&#x7684;&#x5B9E;&#x73B0;&#x4E2D;&#x8FD4;&#x56DE;&#x7684;&#x662F;ReadOnlyHttpHeaders&#x5B9E;&#x4F8B;&#xFF0C;&#x53EA;&#x8BFB;</span></span><br><span class="line">    HttpHeaders <span class="title function_">getHeaders</span><span class="params">()</span>;</span><br><span class="line">}    </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ReactiveHttpInputMessage</span> <span class="keyword">extends</span> <span class="title class_">HttpMessage</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8FD4;&#x56DE;&#x8BF7;&#x6C42;&#x4F53;&#x7684;Flux&#x5C01;&#x88C5;</span></span><br><span class="line">    Flux&lt;DataBuffer&gt; <span class="title function_">getBody</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HttpRequest</span> <span class="keyword">extends</span> <span class="title class_">HttpMessage</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8FD4;&#x56DE;HTTP&#x8BF7;&#x6C42;&#x65B9;&#x6CD5;&#xFF0C;&#x89E3;&#x6790;&#x4E3A;HttpMethod&#x5B9E;&#x4F8B;</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">default</span> HttpMethod <span class="title function_">getMethod</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> HttpMethod.resolve(getMethodValue());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8FD4;&#x56DE;HTTP&#x8BF7;&#x6C42;&#x65B9;&#x6CD5;&#xFF0C;&#x5B57;&#x7B26;&#x4E32;</span></span><br><span class="line">    String <span class="title function_">getMethodValue</span><span class="params">()</span>;    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8BF7;&#x6C42;&#x7684;URI</span></span><br><span class="line">    URI <span class="title function_">getURI</span><span class="params">()</span>;</span><br><span class="line">}    </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ServerHttpRequest</span> <span class="keyword">extends</span> <span class="title class_">HttpRequest</span>, ReactiveHttpInputMessage {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8FDE;&#x63A5;&#x7684;&#x552F;&#x4E00;&#x6807;&#x8BC6;&#x6216;&#x8005;&#x7528;&#x4E8E;&#x65E5;&#x5FD7;&#x5904;&#x7406;&#x6807;&#x8BC6;</span></span><br><span class="line">    String <span class="title function_">getId</span><span class="params">()</span>;   </span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x8DEF;&#x5F84;&#xFF0C;&#x5C01;&#x88C5;&#x4E3A;RequestPath&#x5BF9;&#x8C61;</span></span><br><span class="line">    RequestPath <span class="title function_">getPath</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8FD4;&#x56DE;&#x67E5;&#x8BE2;&#x53C2;&#x6570;&#xFF0C;&#x662F;&#x53EA;&#x8BFB;&#x7684;MultiValueMap&#x5B9E;&#x4F8B;</span></span><br><span class="line">    MultiValueMap&lt;String, String&gt; <span class="title function_">getQueryParams</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8FD4;&#x56DE;Cookie&#x96C6;&#x5408;&#xFF0C;&#x662F;&#x53EA;&#x8BFB;&#x7684;MultiValueMap&#x5B9E;&#x4F8B;</span></span><br><span class="line">    MultiValueMap&lt;String, HttpCookie&gt; <span class="title function_">getCookies</span><span class="params">()</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8FDC;&#x7A0B;&#x670D;&#x52A1;&#x5668;&#x5730;&#x5740;&#x4FE1;&#x606F;</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">default</span> InetSocketAddress <span class="title function_">getRemoteAddress</span><span class="params">()</span> {</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SSL&#x4F1A;&#x8BDD;&#x5B9E;&#x73B0;&#x7684;&#x76F8;&#x5173;&#x4FE1;&#x606F;</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">default</span> SslInfo <span class="title function_">getSslInfo</span><span class="params">()</span> {</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x4FEE;&#x6539;&#x8BF7;&#x6C42;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x5EFA;&#x9020;&#x5668;&#x5B9E;&#x4F8B;Builder&#xFF0C;Builder&#x662F;&#x5185;&#x90E8;&#x7C7B;</span></span><br><span class="line">    <span class="keyword">default</span> ServerHttpRequest.Builder <span class="title function_">mutate</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultServerHttpRequestBuilder</span>(<span class="built_in">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Builder</span> {</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#x8986;&#x76D6;&#x8BF7;&#x6C42;&#x65B9;&#x6CD5;</span></span><br><span class="line">        Builder <span class="title function_">method</span><span class="params">(HttpMethod httpMethod)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#x8986;&#x76D6;&#x8BF7;&#x6C42;&#x7684;URI&#x3001;&#x8BF7;&#x6C42;&#x8DEF;&#x5F84;&#x6216;&#x8005;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x8FD9;&#x4E09;&#x8005;&#x76F8;&#x4E92;&#x6709;&#x5236;&#x7EA6;&#x5173;&#x7CFB;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x53C2;&#x8003;API&#x6CE8;&#x91CA;</span></span><br><span class="line">        Builder <span class="title function_">uri</span><span class="params">(URI uri)</span>;</span><br><span class="line">        Builder <span class="title function_">path</span><span class="params">(String path)</span>;</span><br><span class="line">        Builder <span class="title function_">contextPath</span><span class="params">(String contextPath)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#x8986;&#x76D6;&#x8BF7;&#x6C42;&#x5934;</span></span><br><span class="line">        Builder <span class="title function_">header</span><span class="params">(String key, String value)</span>;</span><br><span class="line">        Builder <span class="title function_">headers</span><span class="params">(Consumer&lt;HttpHeaders&gt; headersConsumer)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#x8986;&#x76D6;SslInfo</span></span><br><span class="line">        Builder <span class="title function_">sslInfo</span><span class="params">(SslInfo sslInfo)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#x6784;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;ServerHttpRequest&#x5B9E;&#x4F8B;</span></span><br><span class="line">        ServerHttpRequest <span class="title function_">build</span><span class="params">()</span>;</span><br><span class="line">    }         </span><br><span class="line">}    </span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x679C;&#x8981;&#x4FEE;&#x6539;ServerHttpRequest&#x5B9E;&#x4F8B;&#xFF0C;&#x90A3;&#x4E48;&#x9700;&#x8981;&#x8FD9;&#x6837;&#x505A;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line"><span class="type">ServerHttpRequest</span> <span class="variable">newRequest</span> <span class="operator">=</span> request.mutate().headers(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>).path(<span class="string">&quot;/myPath&quot;</span>).build();</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x6700;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF1A;ServerHttpRequest&#x6216;&#x8005;&#x8BF4;HttpMessage&#x63A5;&#x53E3;&#x63D0;&#x4F9B;&#x7684;&#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x5934;&#x65B9;&#x6CD5;HttpHeaders getHeaders();&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x662F;&#x4E00;&#x4E2A;&#x53EA;&#x8BFB;&#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x5177;&#x4F53;&#x662F;ReadOnlyHttpHeaders&#x7C7B;&#x578B;&#xFF0C;&#x8FD9;&#x91CC;&#x63D0;&#x591A;&#x4E00;&#x6B21;&#xFF0C;&#x7B14;&#x8005;&#x5199;&#x8FD9;&#x7BC7;&#x535A;&#x6587;&#x65F6;&#x5019;&#x4F7F;&#x7528;&#x7684;Spring Cloud Gateway&#x7248;&#x672C;&#x4E3A;Greenwich.SR1&#x3002;</p>
<h2 id="ServerHttpResponse&#x63A5;&#x53E3;"><a href="#ServerHttpResponse&#x63A5;&#x53E3;" class="headerlink" title="ServerHttpResponse&#x63A5;&#x53E3;"></a>ServerHttpResponse&#x63A5;&#x53E3;</h2><p>ServerHttpResponse&#x5B9E;&#x4F8B;&#x662F;&#x7528;&#x4E8E;&#x627F;&#x8F7D;&#x54CD;&#x5E94;&#x76F8;&#x5173;&#x7684;&#x5C5E;&#x6027;&#x548C;&#x54CD;&#x5E94;&#x4F53;&#xFF0C;Spring Cloud Gateway&#x4E2D;&#x5E95;&#x5C42;&#x4F7F;&#x7528;Netty&#x5904;&#x7406;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#xFF0C;&#x901A;&#x8FC7;&#x8FFD;&#x6EAF;&#x6E90;&#x7801;&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE;ReactorHttpHandlerAdapter&#x4E2D;&#x5F97;&#x77E5;ServerWebExchange&#x5B9E;&#x4F8B;&#x4E2D;&#x6301;&#x6709;&#x7684;ServerHttpResponse&#x5B9E;&#x4F8B;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x662F;ReactorServerHttpResponse&#x3002;&#x4E4B;&#x6240;&#x4EE5;&#x5217;&#x51FA;&#x8FD9;&#x4E9B;&#x5B9E;&#x4F8B;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x662F;&#x56E0;&#x4E3A;&#x8FD9;&#x6837;&#x6BD4;&#x8F83;&#x5BB9;&#x6613;&#x7406;&#x6E05;&#x4E00;&#x4E9B;&#x9690;&#x542B;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReactorServerHttpResponse&#x7684;&#x7236;&#x7C7B;</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AbstractServerHttpResponse</span><span class="params">(DataBufferFactory dataBufferFactory, HttpHeaders headers)</span> {</span><br><span class="line">	Assert.notNull(dataBufferFactory, <span class="string">&quot;DataBufferFactory must not be null&quot;</span>);</span><br><span class="line">	Assert.notNull(headers, <span class="string">&quot;HttpHeaders must not be null&quot;</span>);</span><br><span class="line">	<span class="built_in">this</span>.dataBufferFactory = dataBufferFactory;</span><br><span class="line">	<span class="built_in">this</span>.headers = headers;</span><br><span class="line">	<span class="built_in">this</span>.cookies = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ReactorServerHttpResponse</span><span class="params">(HttpServerResponse response, DataBufferFactory bufferFactory)</span> {</span><br><span class="line">	<span class="built_in">super</span>(bufferFactory, <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>(<span class="keyword">new</span> <span class="title class_">NettyHeadersAdapter</span>(response.responseHeaders())));</span><br><span class="line">	Assert.notNull(response, <span class="string">&quot;HttpServerResponse must not be null&quot;</span>);</span><br><span class="line">	<span class="built_in">this</span>.response = response;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x53EF;&#x77E5;ReactorServerHttpResponse&#x6784;&#x9020;&#x51FD;&#x6570;&#x521D;&#x59CB;&#x5316;&#x5B9E;&#x4F8B;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5B58;&#x653E;&#x54CD;&#x5E94;Header&#x7684;&#x662F;HttpHeaders&#x5B9E;&#x4F8B;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x54CD;&#x5E94;Header&#x662F;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4FEE;&#x6539;&#x7684;&#x3002;</p>
<p>ServerHttpResponse&#x63A5;&#x53E3;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HttpMessage</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x83B7;&#x53D6;&#x54CD;&#x5E94;Header&#xFF0C;&#x76EE;&#x524D;&#x7684;&#x5B9E;&#x73B0;&#x4E2D;&#x8FD4;&#x56DE;&#x7684;&#x662F;HttpHeaders&#x5B9E;&#x4F8B;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4FEE;&#x6539;</span></span><br><span class="line">    HttpHeaders <span class="title function_">getHeaders</span><span class="params">()</span>;</span><br><span class="line">}  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ReactiveHttpOutputMessage</span> <span class="keyword">extends</span> <span class="title class_">HttpMessage</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x83B7;&#x53D6;DataBufferFactory&#x5B9E;&#x4F8B;&#xFF0C;&#x7528;&#x4E8E;&#x5305;&#x88C5;&#x6216;&#x8005;&#x751F;&#x6210;&#x6570;&#x636E;&#x7F13;&#x51B2;&#x533A;DataBuffer&#x5B9E;&#x4F8B;(&#x521B;&#x5EFA;&#x54CD;&#x5E94;&#x4F53;)</span></span><br><span class="line">    DataBufferFactory <span class="title function_">bufferFactory</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x6CE8;&#x518C;&#x4E00;&#x4E2A;&#x52A8;&#x4F5C;&#xFF0C;&#x5728;HttpOutputMessage&#x63D0;&#x4EA4;&#x4E4B;&#x524D;&#x6B64;&#x52A8;&#x4F5C;&#x4F1A;&#x8FDB;&#x884C;&#x56DE;&#x8C03;</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">beforeCommit</span><span class="params">(Supplier&lt;? extends Mono&lt;Void&gt;&gt; action)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x5224;&#x65AD;HttpOutputMessage&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x63D0;&#x4EA4;</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCommitted</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x5199;&#x5165;&#x6D88;&#x606F;&#x4F53;&#x5230;HTTP&#x534F;&#x8BAE;&#x5C42;</span></span><br><span class="line">    Mono&lt;Void&gt; <span class="title function_">writeWith</span><span class="params">(Publisher&lt;? extends DataBuffer&gt; body)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x5199;&#x5165;&#x6D88;&#x606F;&#x4F53;&#x5230;HTTP&#x534F;&#x8BAE;&#x5C42;&#x5E76;&#x4E14;&#x5237;&#x65B0;&#x7F13;&#x51B2;&#x533A;</span></span><br><span class="line">    Mono&lt;Void&gt; <span class="title function_">writeAndFlushWith</span><span class="params">(Publisher&lt;? extends Publisher&lt;? extends DataBuffer&gt;&gt; body)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x6307;&#x660E;&#x6D88;&#x606F;&#x5904;&#x7406;&#x5DF2;&#x7ECF;&#x7ED3;&#x675F;&#xFF0C;&#x4E00;&#x822C;&#x5728;&#x6D88;&#x606F;&#x5904;&#x7406;&#x7ED3;&#x675F;&#x81EA;&#x52A8;&#x8C03;&#x7528;&#x6B64;&#x65B9;&#x6CD5;&#xFF0C;&#x591A;&#x6B21;&#x8C03;&#x7528;&#x4E0D;&#x4F1A;&#x4EA7;&#x751F;&#x526F;&#x4F5C;&#x7528;</span></span><br><span class="line">    Mono&lt;Void&gt; <span class="title function_">setComplete</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ServerHttpResponse</span> <span class="keyword">extends</span> <span class="title class_">ReactiveHttpOutputMessage</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x8BBE;&#x7F6E;&#x54CD;&#x5E94;&#x72B6;&#x6001;&#x7801;</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">setStatusCode</span><span class="params">(<span class="meta">@Nullable</span> HttpStatus status)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x83B7;&#x53D6;&#x54CD;&#x5E94;&#x72B6;&#x6001;&#x7801;</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    HttpStatus <span class="title function_">getStatusCode</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x83B7;&#x53D6;&#x54CD;&#x5E94;Cookie&#xFF0C;&#x5C01;&#x88C5;&#x4E3A;MultiValueMap&#x5B9E;&#x4F8B;&#xFF0C;&#x53EF;&#x4EE5;&#x4FEE;&#x6539;</span></span><br><span class="line">    MultiValueMap&lt;String, ResponseCookie&gt; <span class="title function_">getCookies</span><span class="params">()</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x6DFB;&#x52A0;&#x54CD;&#x5E94;Cookie</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addCookie</span><span class="params">(ResponseCookie cookie)</span>;  </span><br><span class="line">}    </span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x9664;&#x4E86;&#x54CD;&#x5E94;&#x4F53;&#x6BD4;&#x8F83;&#x96BE;&#x4FEE;&#x6539;&#x4E4B;&#x5916;&#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x5C5E;&#x6027;&#x90FD;&#x662F;&#x53EF;&#x53D8;&#x7684;&#x3002;</p>
<h2 id="ServerWebExchangeUtils&#x548C;&#x4E0A;&#x4E0B;&#x6587;&#x5C5E;&#x6027;"><a href="#ServerWebExchangeUtils&#x548C;&#x4E0A;&#x4E0B;&#x6587;&#x5C5E;&#x6027;" class="headerlink" title="ServerWebExchangeUtils&#x548C;&#x4E0A;&#x4E0B;&#x6587;&#x5C5E;&#x6027;"></a>ServerWebExchangeUtils&#x548C;&#x4E0A;&#x4E0B;&#x6587;&#x5C5E;&#x6027;</h2><p>ServerWebExchangeUtils&#x91CC;&#x9762;&#x5B58;&#x653E;&#x4E86;&#x5F88;&#x591A;&#x9759;&#x6001;&#x516C;&#x6709;&#x7684;&#x5B57;&#x7B26;&#x4E32;KEY&#x503C;(&#x8FD9;&#x4E9B;&#x5B57;&#x7B26;&#x4E32;KEY&#x7684;&#x5B9E;&#x9645;&#x503C;&#x662F;org.springframework.cloud.gateway.support.ServerWebExchangeUtils. + &#x4E0B;&#x9762;&#x4EFB;&#x610F;&#x7684;&#x9759;&#x6001;&#x516C;&#x6709;KEY)&#xFF0C;&#x8FD9;&#x4E9B;&#x5B57;&#x7B26;&#x4E32;KEY&#x503C;&#x4E00;&#x822C;&#x662F;&#x7528;&#x4E8E;ServerWebExchange&#x7684;&#x5C5E;&#x6027;(Attribute&#xFF0C;&#x89C1;&#x4E0A;&#x6587;&#x7684;ServerWebExchange#getAttributes()&#x65B9;&#x6CD5;)&#x7684;KEY&#xFF0C;&#x8FD9;&#x4E9B;&#x5C5E;&#x6027;&#x503C;&#x90FD;&#x662F;&#x6709;&#x7279;&#x6B8A;&#x7684;&#x542B;&#x4E49;&#xFF0C;&#x5728;&#x4F7F;&#x7528;&#x8FC7;&#x6EE4;&#x5668;&#x7684;&#x65F6;&#x5019;&#x5982;&#x679C;&#x65F6;&#x673A;&#x9002;&#x5F53;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x53D6;&#x51FA;&#x6765;&#x4F7F;&#x7528;&#xFF0C;&#x4E0B;&#x9762;&#x9010;&#x4E2A;&#x5206;&#x6790;&#x3002;</p>
<ul>
<li><code>PRESERVE_HOST_HEADER_ATTRIBUTE</code> &#xFF1A;&#x662F;&#x5426;&#x4FDD;&#x5B58;Host&#x5C5E;&#x6027;&#xFF0C;&#x503C;&#x662F;&#x5E03;&#x5C14;&#x503C;&#x7C7B;&#x578B;&#xFF0C;&#x5199;&#x5165;&#x4F4D;&#x7F6E;&#x662F;PreserveHostHeaderGatewayFilterFactory&#xFF0C;&#x4F7F;&#x7528;&#x7684;&#x4F4D;&#x7F6E;&#x662F;NettyRoutingFilter&#xFF0C;&#x4F5C;&#x7528;&#x662F;&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E3A;true&#xFF0C;HTTP&#x8BF7;&#x6C42;&#x5934;&#x4E2D;&#x7684;Host&#x5C5E;&#x6027;&#x4F1A;&#x5199;&#x5230;&#x5E95;&#x5C42;Reactor-Netty&#x7684;&#x8BF7;&#x6C42;Header&#x5C5E;&#x6027;&#x4E2D;&#x3002;</li>
<li><code>CLIENT_RESPONSE_ATTR</code> &#xFF1A;&#x4FDD;&#x5B58;&#x5E95;&#x5C42;Reactor-Netty&#x7684;&#x54CD;&#x5E94;&#x5BF9;&#x8C61;&#xFF0C;&#x7C7B;&#x578B;&#x662F;reactor.netty.http.client.HttpClientResponse&#x3002;</li>
<li><code>CLIENT_RESPONSE_CONN_ATTR</code> &#xFF1A;&#x4FDD;&#x5B58;&#x5E95;&#x5C42;Reactor-Netty&#x7684;&#x8FDE;&#x63A5;&#x5BF9;&#x8C61;&#xFF0C;&#x7C7B;&#x578B;&#x662F;reactor.netty.Connection&#x3002;</li>
<li><code>URI_TEMPLATE_VARIABLES_ATTRIBUTE</code> &#xFF1A;PathRoutePredicateFactory&#x89E3;&#x6790;&#x8DEF;&#x5F84;&#x53C2;&#x6570;&#x5B8C;&#x6210;&#x4E4B;&#x540E;&#xFF0C;&#x628A;&#x89E3;&#x6790;&#x5B8C;&#x6210;&#x540E;&#x7684;&#x5360;&#x4F4D;&#x7B26;KEY-&#x8DEF;&#x5F84;Path&#x6620;&#x5C04;&#x5B58;&#x653E;&#x5728;ServerWebExchange&#x7684;&#x5C5E;&#x6027;&#x4E2D;&#xFF0C;KEY&#x5C31;&#x662F;URI_TEMPLATE_VARIABLES_ATTRIBUTE&#x3002;</li>
<li><code>CLIENT_RESPONSE_HEADER_NAMES</code> &#xFF1A;&#x4FDD;&#x5B58;&#x5E95;&#x5C42;Reactor-Netty&#x7684;&#x54CD;&#x5E94;Header&#x7684;&#x540D;&#x79F0;&#x96C6;&#x5408;&#x3002;</li>
<li><code>GATEWAY_ROUTE_ATTR</code> &#xFF1A;&#x7528;&#x4E8E;&#x5B58;&#x653E;RoutePredicateHandlerMapping&#x4E2D;&#x5339;&#x914D;&#x51FA;&#x6765;&#x7684;&#x5177;&#x4F53;&#x7684;&#x8DEF;&#x7531;(org.springframework.cloud.gateway.route.Route)&#x5B9E;&#x4F8B;&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x8DEF;&#x7531;&#x5B9E;&#x4F8B;&#x53EF;&#x4EE5;&#x5F97;&#x77E5;&#x5F53;&#x524D;&#x8BF7;&#x6C42;&#x4F1A;&#x8DEF;&#x7531;&#x5230;&#x4E0B;&#x6E38;&#x54EA;&#x4E2A;&#x670D;&#x52A1;&#x3002;</li>
<li><code>GATEWAY_REQUEST_URL_ATTR</code> &#xFF1A;java.net.URI&#x7C7B;&#x578B;&#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x8FD9;&#x4E2A;&#x5B9E;&#x4F8B;&#x4EE3;&#x8868;&#x76F4;&#x63A5;&#x8BF7;&#x6C42;&#x6216;&#x8005;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x5904;&#x7406;&#x4E4B;&#x540E;&#x9700;&#x8981;&#x8BF7;&#x6C42;&#x5230;&#x4E0B;&#x6E38;&#x670D;&#x52A1;&#x7684;&#x771F;&#x5B9E;URI&#x3002;</li>
<li><code>GATEWAY_ORIGINAL_REQUEST_URL_ATTR</code> &#xFF1A;java.net.URI&#x7C7B;&#x578B;&#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x9700;&#x8981;&#x91CD;&#x5199;&#x8BF7;&#x6C42;URI&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4FDD;&#x5B58;&#x539F;&#x59CB;&#x7684;&#x8BF7;&#x6C42;URI&#x3002;</li>
<li><code>GATEWAY_HANDLER_MAPPER_ATTR</code> &#xFF1A;&#x4FDD;&#x5B58;&#x5F53;&#x524D;&#x4F7F;&#x7528;&#x7684;HandlerMapping&#x5177;&#x4F53;&#x5B9E;&#x4F8B;&#x7684;&#x7C7B;&#x578B;&#x7B80;&#x79F0;(&#x4E00;&#x822C;&#x662F;&#x5B57;&#x7B26;&#x4E32;&#x201D;RoutePredicateHandlerMapping&#x201D;)&#x3002;</li>
<li><code>GATEWAY_SCHEME_PREFIX_ATTR</code> &#xFF1A;&#x786E;&#x5B9A;&#x76EE;&#x6807;&#x8DEF;&#x7531;URI&#x4E2D;&#x5982;&#x679C;&#x5B58;&#x5728;schemeSpecificPart&#x5C5E;&#x6027;&#xFF0C;&#x5219;&#x4FDD;&#x5B58;&#x8BE5;URI&#x7684;scheme&#x5728;&#x6B64;&#x5C5E;&#x6027;&#x4E2D;&#xFF0C;&#x8DEF;&#x7531;URI&#x4F1A;&#x88AB;&#x91CD;&#x65B0;&#x6784;&#x9020;&#xFF0C;&#x89C1;RouteToRequestUrlFilter&#x3002;</li>
<li><code>GATEWAY_PREDICATE_ROUTE_ATTR</code> &#xFF1A;&#x7528;&#x4E8E;&#x5B58;&#x653E;RoutePredicateHandlerMapping&#x4E2D;&#x5339;&#x914D;&#x51FA;&#x6765;&#x7684;&#x5177;&#x4F53;&#x7684;&#x8DEF;&#x7531;(org.springframework.cloud.gateway.route.Route)&#x5B9E;&#x4F8B;&#x7684;ID&#x3002;</li>
<li>WEIGHT_ATTR&#xFF1A;&#x5B9E;&#x9A8C;&#x6027;&#x529F;&#x80FD;(&#x6B64;&#x7248;&#x672C;&#x8FD8;&#x4E0D;&#x5EFA;&#x8BAE;&#x5728;&#x6B63;&#x5F0F;&#x7248;&#x672C;&#x4F7F;&#x7528;)&#x5B58;&#x653E;&#x5206;&#x7EC4;&#x6743;&#x91CD;&#x76F8;&#x5173;&#x5C5E;&#x6027;&#xFF0C;&#x89C1;WeightCalculatorWebFilter&#x3002;</li>
<li><code>ORIGINAL_RESPONSE_CONTENT_TYPE_ATTR</code> &#xFF1A;&#x5B58;&#x653E;&#x54CD;&#x5E94;Header&#x4E2D;&#x7684;ContentType&#x7684;&#x503C;&#x3002;</li>
<li><code>HYSTRIX_EXECUTION_EXCEPTION_ATTR</code> &#xFF1A;Throwable&#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x5B58;&#x653E;&#x7684;&#x662F;Hystrix&#x6267;&#x884C;&#x5F02;&#x5E38;&#x65F6;&#x5019;&#x7684;&#x5F02;&#x5E38;&#x5B9E;&#x4F8B;&#xFF0C;&#x89C1;HystrixGatewayFilterFactory&#x3002;</li>
<li><code>GATEWAY_ALREADY_ROUTED_ATTR</code> &#xFF1A;&#x5E03;&#x5C14;&#x503C;&#xFF0C;&#x7528;&#x4E8E;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x8FDB;&#x884C;&#x4E86;&#x8DEF;&#x7531;&#xFF0C;&#x89C1;NettyRoutingFilter&#x3002;</li>
<li><code>GATEWAY_ALREADY_PREFIXED_ATTR</code> &#xFF1A;&#x5E03;&#x5C14;&#x503C;&#xFF0C;&#x7528;&#x4E8E;&#x5224;&#x65AD;&#x8BF7;&#x6C42;&#x8DEF;&#x5F84;&#x662F;&#x5426;&#x88AB;&#x6DFB;&#x52A0;&#x4E86;&#x524D;&#x7F6E;&#x90E8;&#x5206;&#xFF0C;&#x89C1;PrefixPathGatewayFilterFactory&#x3002;</li>
</ul>
<p>ServerWebExchangeUtils&#x63D0;&#x4F9B;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x5C5E;&#x6027;&#x7528;&#x4E8E;Spring Cloud Gateway&#x7684;ServerWebExchange&#x7EC4;&#x4EF6;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x548C;&#x54CD;&#x5E94;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5185;&#x90E8;&#x4E00;&#x4E9B;&#x91CD;&#x8981;&#x5B9E;&#x4F8B;&#x6216;&#x8005;&#x6807;&#x8BC6;&#x5C5E;&#x6027;&#x7684;&#x5B89;&#x5168;&#x4F20;&#x8F93;&#x548C;&#x4F7F;&#x7528;&#xFF0C;&#x4F7F;&#x7528;&#x5B83;&#x4EEC;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x4E00;&#x5B9A;&#x7684;&#x98CE;&#x9669;&#xFF0C;&#x56E0;&#x4E3A;&#x6CA1;&#x6709;&#x4EBA;&#x53EF;&#x4EE5;&#x786E;&#x5B9A;&#x5728;&#x7248;&#x672C;&#x5347;&#x7EA7;&#x4E4B;&#x540E;&#xFF0C;&#x539F;&#x6709;&#x7684;&#x5C5E;&#x6027;KEY&#x6216;&#x8005;VALUE&#x662F;&#x5426;&#x4F1A;&#x53D1;&#x751F;&#x6539;&#x53D8;&#xFF0C;&#x5982;&#x679C;&#x8BC4;&#x4F30;&#x8FC7;&#x98CE;&#x9669;&#x6216;&#x8005;&#x89C4;&#x907F;&#x4E86;&#x98CE;&#x9669;&#x4E4B;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x5B89;&#x5FC3;&#x4F7F;&#x7528;&#x3002;&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x5728;&#x505A;&#x8BF7;&#x6C42;&#x548C;&#x54CD;&#x5E94;&#x65E5;&#x5FD7;(&#x7C7B;&#x4F3C;Nginx&#x7684;Access Log)&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EF;&#x4EE5;&#x4F9D;&#x8D56;&#x5230;GATEWAY_ROUTE_ATTR&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x8981;&#x6253;&#x5370;&#x8DEF;&#x7531;&#x7684;&#x76EE;&#x6807;&#x4FE1;&#x606F;&#x3002;&#x4E3E;&#x4E2A;&#x7B80;&#x5355;&#x4F8B;&#x5B50;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessLogFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {</span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> request.getPath().pathWithinApplication().value();</span><br><span class="line">        <span class="type">HttpMethod</span> <span class="variable">method</span> <span class="operator">=</span> request.getMethod();</span><br><span class="line">        <span class="comment">// &#x83B7;&#x53D6;&#x8DEF;&#x7531;&#x7684;&#x76EE;&#x6807;URI</span></span><br><span class="line">        <span class="type">URI</span> <span class="variable">targetUri</span> <span class="operator">=</span> exchange.getAttribute(ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR);</span><br><span class="line">        <span class="type">InetSocketAddress</span> <span class="variable">remoteAddress</span> <span class="operator">=</span> request.getRemoteAddress();</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange.mutate().build()).then(Mono.fromRunnable(() -&gt; {</span><br><span class="line">            <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">            <span class="type">HttpStatus</span> <span class="variable">statusCode</span> <span class="operator">=</span> response.getStatusCode();</span><br><span class="line">            log.info(<span class="string">&quot;&#x8BF7;&#x6C42;&#x8DEF;&#x5F84;:{},&#x5BA2;&#x6237;&#x7AEF;&#x8FDC;&#x7A0B;IP&#x5730;&#x5740;:{},&#x8BF7;&#x6C42;&#x65B9;&#x6CD5;:{},&#x76EE;&#x6807;URI:{},&#x54CD;&#x5E94;&#x7801;:{}&quot;</span>,</span><br><span class="line">                    path, remoteAddress, method, targetUri, statusCode);</span><br><span class="line">        }));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h1 id="&#x4FEE;&#x6539;&#x8BF7;&#x6C42;&#x4F53;"><a href="#&#x4FEE;&#x6539;&#x8BF7;&#x6C42;&#x4F53;" class="headerlink" title="&#x4FEE;&#x6539;&#x8BF7;&#x6C42;&#x4F53;"></a>&#x4FEE;&#x6539;&#x8BF7;&#x6C42;&#x4F53;</h1><p>&#x4FEE;&#x6539;&#x8BF7;&#x6C42;&#x4F53;&#x662F;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x5E38;&#x89C1;&#x7684;&#x9700;&#x6C42;&#x3002;&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x4F7F;&#x7528;Spring Cloud Gateway&#x5B9E;&#x73B0;&#x7F51;&#x5173;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8981;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x529F;&#x80FD;&#xFF1A;&#x628A;&#x5B58;&#x653E;&#x5728;&#x8BF7;&#x6C42;&#x5934;&#x4E2D;&#x7684;JWT&#x89E3;&#x6790;&#x540E;&#xFF0C;&#x63D0;&#x53D6;&#x91CC;&#x9762;&#x7684;&#x7528;&#x6237;ID&#xFF0C;&#x7136;&#x540E;&#x5199;&#x5165;&#x5230;&#x8BF7;&#x6C42;&#x4F53;&#x4E2D;&#x3002;&#x6211;&#x4EEC;&#x7B80;&#x5316;&#x8FD9;&#x4E2A;&#x573A;&#x666F;&#xFF0C;&#x5047;&#x8BBE;&#x6211;&#x4EEC;&#x628A;userId&#x660E;&#x6587;&#x5B58;&#x653E;&#x5728;&#x8BF7;&#x6C42;&#x5934;&#x4E2D;&#x7684;accessToken&#x4E2D;&#xFF0C;&#x8BF7;&#x6C42;&#x4F53;&#x662F;&#x4E00;&#x4E2A;JSON&#x7ED3;&#x6784;&#xFF1A;</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">&quot;serialNumber&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#x8BF7;&#x6C42;&#x6D41;&#x6C34;&#x53F7;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;payload&quot;</span> <span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="comment">// ... &#x8FD9;&#x91CC;&#x662F;&#x6709;&#x6548;&#x8F7D;&#x8377;&#xFF0C;&#x5B58;&#x653E;&#x5177;&#x4F53;&#x7684;&#x6570;&#x636E;</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x4EEC;&#x9700;&#x8981;&#x63D0;&#x53D6;accessToken&#xFF0C;&#x4E5F;&#x5C31;&#x662F;userId&#x63D2;&#x5165;&#x5230;&#x8BF7;&#x6C42;&#x4F53;JSON&#x4E2D;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#x7528;&#x6237;ID&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;serialNumber&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#x8BF7;&#x6C42;&#x6D41;&#x6C34;&#x53F7;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;payload&quot;</span> <span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="comment">// ... &#x8FD9;&#x91CC;&#x662F;&#x6709;&#x6548;&#x8F7D;&#x8377;&#xFF0C;&#x5B58;&#x653E;&#x5177;&#x4F53;&#x7684;&#x6570;&#x636E;</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x4E3A;&#x4E86;&#x7B80;&#x5316;&#x8BBE;&#x8BA1;&#xFF0C;&#x7528;&#x5168;&#x5C40;&#x8FC7;&#x6EE4;&#x5668;GlobalFilter&#x5B9E;&#x73B0;&#xFF0C;&#x5B9E;&#x9645;&#x9700;&#x8981;&#x7ED3;&#x5408;&#x5177;&#x4F53;&#x573A;&#x666F;&#x8003;&#x8651;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModifyRequestBodyGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">DataBufferFactory</span> <span class="variable">dataBufferFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyDataBufferFactory</span>(ByteBufAllocator.DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {</span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">accessToken</span> <span class="operator">=</span> request.getHeaders().getFirst(<span class="string">&quot;accessToken&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasLength(accessToken)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;accessToken&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// &#x65B0;&#x5EFA;&#x4E00;&#x4E2A;ServerHttpRequest&#x88C5;&#x9970;&#x5668;,&#x8986;&#x76D6;&#x9700;&#x8981;&#x88C5;&#x9970;&#x7684;&#x65B9;&#x6CD5;</span></span><br><span class="line">        <span class="type">ServerHttpRequestDecorator</span> <span class="variable">decorator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerHttpRequestDecorator</span>(request) {</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Flux&lt;DataBuffer&gt; <span class="title function_">getBody</span><span class="params">()</span> {</span><br><span class="line">                Flux&lt;DataBuffer&gt; body = <span class="built_in">super</span>.getBody();</span><br><span class="line">                <span class="type">InputStreamHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamHolder</span>();</span><br><span class="line">                body.subscribe(buffer -&gt; holder.inputStream = buffer.asInputStream());</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != holder.inputStream) {</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        <span class="comment">// &#x89E3;&#x6790;JSON&#x7684;&#x8282;&#x70B9;</span></span><br><span class="line">                        <span class="type">JsonNode</span> <span class="variable">jsonNode</span> <span class="operator">=</span> objectMapper.readTree(holder.inputStream);</span><br><span class="line">                        Assert.isTrue(jsonNode <span class="keyword">instanceof</span> ObjectNode, <span class="string">&quot;JSON&#x683C;&#x5F0F;&#x5F02;&#x5E38;&quot;</span>);</span><br><span class="line">                        <span class="type">ObjectNode</span> <span class="variable">objectNode</span> <span class="operator">=</span> (ObjectNode) jsonNode;</span><br><span class="line">                        <span class="comment">// JSON&#x8282;&#x70B9;&#x6700;&#x5916;&#x5C42;&#x5199;&#x5165;&#x65B0;&#x7684;&#x5C5E;&#x6027;</span></span><br><span class="line">                        objectNode.put(<span class="string">&quot;userId&quot;</span>, accessToken);</span><br><span class="line">                        <span class="type">DataBuffer</span> <span class="variable">dataBuffer</span> <span class="operator">=</span> dataBufferFactory.allocateBuffer();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> objectNode.toString();</span><br><span class="line">                        log.info(<span class="string">&quot;&#x6700;&#x7EC8;&#x7684;JSON&#x6570;&#x636E;&#x4E3A;:{}&quot;</span>, json);</span><br><span class="line">                        dataBuffer.write(json.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">                        <span class="keyword">return</span> Flux.just(dataBuffer);</span><br><span class="line">                    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.getBody();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">        <span class="comment">// &#x4F7F;&#x7528;&#x4FEE;&#x6539;&#x540E;&#x7684;ServerHttpRequestDecorator&#x91CD;&#x65B0;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x65B0;&#x7684;ServerWebExchange</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange.mutate().request(decorator).build());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">InputStreamHolder</span> {</span><br><span class="line"></span><br><span class="line">        InputStream inputStream;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6D4B;&#x8BD5;&#x4E00;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// HTTP</span><br><span class="line">POST /order/json HTTP/1.1</span><br><span class="line">Host: localhost:9090</span><br><span class="line">Content-Type: application/json</span><br><span class="line">accessToken: 10086</span><br><span class="line">Accept: */*</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Host: localhost:9090</span><br><span class="line">accept-encoding: gzip, deflate</span><br><span class="line">content-length: 94</span><br><span class="line">Connection: keep-alive</span><br><span class="line">cache-control: no-cache</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    &quot;serialNumber&quot;: &quot;&#x8BF7;&#x6C42;&#x6D41;&#x6C34;&#x53F7;&quot;,</span><br><span class="line">    &quot;payload&quot;: {</span><br><span class="line">        &quot;name&quot;: &quot;doge&quot;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// &#x65E5;&#x5FD7;&#x8F93;&#x51FA;</span><br><span class="line">&#x6700;&#x7EC8;&#x7684;JSON&#x6570;&#x636E;&#x4E3A;:{&quot;serialNumber&quot;:&quot;&#x8BF7;&#x6C42;&#x6D41;&#x6C34;&#x53F7;&quot;,&quot;payload&quot;:{&quot;name&quot;:&quot;doge&quot;},&quot;userId&quot;:&quot;10086&quot;}</span><br></pre></td></tr></table></figure>

<p>&#x6700;&#x91CD;&#x8981;&#x7684;&#x662F;&#x7528;&#x5230;&#x4E86;ServerHttpRequest&#x88C5;&#x9970;&#x5668;ServerHttpRequestDecorator&#xFF0C;&#x4E3B;&#x8981;&#x8986;&#x76D6;&#x5BF9;&#x5E94;&#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x4F53;&#x6570;&#x636E;&#x7F13;&#x51B2;&#x533A;&#x7684;&#x65B9;&#x6CD5;&#x5373;&#x53EF;&#xFF0C;&#x81F3;&#x4E8E;&#x600E;&#x4E48;&#x5904;&#x7406;&#x5176;&#x4ED6;&#x903B;&#x8F91;&#x9700;&#x8981;&#x81EA;&#x884C;&#x8003;&#x8651;&#xFF0C;&#x8FD9;&#x91CC;&#x53EA;&#x662F;&#x505A;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x793A;&#x8303;&#x3002;&#x4E00;&#x822C;&#x7684;&#x4EE3;&#x7801;&#x903B;&#x8F91;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line"><span class="type">ServerHttpRequestDecorator</span> <span class="variable">requestDecorator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerHttpRequestDecorator</span>(request) {</span><br><span class="line"></span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> Flux&lt;DataBuffer&gt; <span class="title function_">getBody</span><span class="params">()</span> {</span><br><span class="line">         <span class="comment">// &#x62FF;&#x5230;&#x627F;&#x8F7D;&#x539F;&#x59CB;&#x8BF7;&#x6C42;&#x4F53;&#x7684;Flux</span></span><br><span class="line">         Flux&lt;DataBuffer&gt; body = <span class="built_in">super</span>.getBody();</span><br><span class="line">         <span class="comment">// &#x8FD9;&#x91CC;&#x901A;&#x8FC7;&#x81EA;&#x5B9A;&#x4E49;&#x65B9;&#x5F0F;&#x751F;&#x6210;&#x65B0;&#x7684;&#x627F;&#x8F7D;&#x8BF7;&#x6C42;&#x4F53;&#x7684;Flux</span></span><br><span class="line">         Flux&lt;DataBuffer&gt; newBody = ...</span><br><span class="line">         <span class="keyword">return</span> newBody;</span><br><span class="line">     }            </span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> chain.filter(exchange.mutate().request(requestDecorator).build());</span><br></pre></td></tr></table></figure>

<h1 id="&#x4FEE;&#x6539;&#x54CD;&#x5E94;&#x4F53;"><a href="#&#x4FEE;&#x6539;&#x54CD;&#x5E94;&#x4F53;" class="headerlink" title="&#x4FEE;&#x6539;&#x54CD;&#x5E94;&#x4F53;"></a>&#x4FEE;&#x6539;&#x54CD;&#x5E94;&#x4F53;</h1><p>&#x4FEE;&#x6539;&#x54CD;&#x5E94;&#x4F53;&#x7684;&#x9700;&#x6C42;&#x4E5F;&#x662F;&#x6BD4;&#x8F83;&#x5E38;&#x89C1;&#x7684;&#xFF0C;&#x5177;&#x4F53;&#x7684;&#x505A;&#x6CD5;&#x548C;&#x4FEE;&#x6539;&#x8BF7;&#x6C42;&#x4F53;&#x5DEE;&#x4E0D;&#x591A;&#x3002;&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x5B9E;&#x73B0;&#x4E0B;&#x9762;&#x7684;&#x529F;&#x80FD;&#xFF1A;&#x7B2C;&#x4E09;&#x65B9;&#x670D;&#x52A1;&#x8BF7;&#x6C42;&#x7ECF;&#x8FC7;&#x7F51;&#x5173;&#xFF0C;&#x539F;&#x59CB;&#x62A5;&#x6587;&#x662F;&#x5BC6;&#x6587;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5728;&#x7F51;&#x5173;&#x5B9E;&#x73B0;&#x5BC6;&#x6587;&#x89E3;&#x5BC6;&#xFF0C;&#x7136;&#x540E;&#x628A;&#x89E3;&#x5BC6;&#x540E;&#x7684;&#x660E;&#x6587;&#x8DEF;&#x7531;&#x5230;&#x4E0B;&#x6E38;&#x670D;&#x52A1;&#xFF0C;&#x4E0B;&#x6E38;&#x670D;&#x52A1;&#x5904;&#x7406;&#x6210;&#x529F;&#x54CD;&#x5E94;&#x660E;&#x6587;&#xFF0C;&#x9700;&#x8981;&#x5728;&#x7F51;&#x5173;&#x628A;&#x660E;&#x6587;&#x52A0;&#x5BC6;&#x6210;&#x5BC6;&#x6587;&#x518D;&#x8FD4;&#x56DE;&#x5230;&#x7B2C;&#x4E09;&#x65B9;&#x670D;&#x52A1;&#x3002;&#x73B0;&#x5728;&#x7B80;&#x5316;&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#xFF0C;&#x7528;AES&#x52A0;&#x5BC6;&#x7B97;&#x6CD5;&#xFF0C;&#x7EDF;&#x4E00;&#x5BC6;&#x7801;&#x4E3A;&#x5B57;&#x7B26;&#x4E32;&#x201D;throwable&#x201D;&#xFF0C;&#x5047;&#x8BBE;&#x8BF7;&#x6C42;&#x62A5;&#x6587;&#x548C;&#x54CD;&#x5E94;&#x62A5;&#x6587;&#x660E;&#x6587;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#x8BF7;&#x6C42;&#x5BC6;&#x6587;</span></span><br><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">&quot;serialNumber&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#x8BF7;&#x6C42;&#x6D41;&#x6C34;&#x53F7;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;payload&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&#x52A0;&#x5BC6;&#x540E;&#x7684;&#x8BF7;&#x6C42;&#x6D88;&#x606F;&#x8F7D;&#x8377;&quot;</span></span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &#x8BF7;&#x6C42;&#x660E;&#x6587;&#xFF08;&#x4EC5;&#x4EC5;&#x4F5C;&#x4E3A;&#x63D0;&#x793A;&#xFF09;</span></span><br><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">&quot;serialNumber&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#x8BF7;&#x6C42;&#x6D41;&#x6C34;&#x53F7;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;payload&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;{\&quot;name:\&quot;:\&quot;doge\&quot;}&quot;</span></span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &#x54CD;&#x5E94;&#x5BC6;&#x6587;</span></span><br><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;ok&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;payload&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&#x52A0;&#x5BC6;&#x540E;&#x7684;&#x54CD;&#x5E94;&#x6D88;&#x606F;&#x8F7D;&#x8377;&quot;</span></span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &#x54CD;&#x5E94;&#x660E;&#x6587;&#xFF08;&#x4EC5;&#x4EC5;&#x4F5C;&#x4E3A;&#x63D0;&#x793A;&#xFF09;</span></span><br><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;ok&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;payload&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;{\&quot;name:\&quot;:\&quot;doge\&quot;,\&quot;age\&quot;:26}&quot;</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure>

<p>&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x4E00;&#x4E9B;&#x52A0;&#x89E3;&#x5BC6;&#x6216;&#x8005;&#x7F16;&#x7801;&#x89E3;&#x7801;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x9700;&#x8981;&#x5F15;&#x5165;Apache&#x7684;commons-codec&#x7C7B;&#x5E93;&#xFF1A;</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x8FC7;&#x6EE4;&#x5668;&#x4E13;&#x95E8;&#x5904;&#x7406;&#x52A0;&#x89E3;&#x5BC6;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x6700;&#x597D;&#x7ED3;&#x5408;&#x771F;&#x5B9E;&#x7684;&#x573A;&#x666F;&#x51B3;&#x5B9A;&#x662F;&#x5426;&#x9002;&#x5408;&#x5168;&#x5C40;&#x8FC7;&#x6EE4;&#x5668;&#xFF0C;&#x8FD9;&#x91CC;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x793A;&#x4F8B;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AES&#x52A0;&#x89E3;&#x5BC6;&#x5DE5;&#x5177;&#x7C7B;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">AesUtils</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x5355;&#x4F8B;</span></span><br><span class="line">    X;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;throwable&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_ALGORITHM</span> <span class="operator">=</span> <span class="string">&quot;AES&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SECURE_RANDOM_ALGORITHM</span> <span class="operator">=</span> <span class="string">&quot;SHA1PRNG&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_CIPHER_ALGORITHM</span> <span class="operator">=</span> <span class="string">&quot;AES/ECB/PKCS5Padding&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encrypt</span><span class="params">(String content)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(DEFAULT_CIPHER_ALGORITHM);</span><br><span class="line">            cipher.init(Cipher.ENCRYPT_MODE, provideSecretKey());</span><br><span class="line">            <span class="keyword">return</span> Hex.encodeHexString(cipher.doFinal(content.getBytes(StandardCharsets.UTF_8)));</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] decrypt(String content) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(DEFAULT_CIPHER_ALGORITHM);</span><br><span class="line">            cipher.init(Cipher.DECRYPT_MODE, provideSecretKey());</span><br><span class="line">            <span class="keyword">return</span> cipher.doFinal(Hex.decodeHex(content));</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SecretKey <span class="title function_">provideSecretKey</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">KeyGenerator</span> <span class="variable">keyGen</span> <span class="operator">=</span> KeyGenerator.getInstance(KEY_ALGORITHM);</span><br><span class="line">            <span class="type">SecureRandom</span> <span class="variable">secureRandom</span> <span class="operator">=</span> SecureRandom.getInstance(SECURE_RANDOM_ALGORITHM);</span><br><span class="line">            secureRandom.setSeed(PASSWORD.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            keyGen.init(<span class="number">128</span>, secureRandom);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(keyGen.generateKey().getEncoded(), KEY_ALGORITHM);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// EncryptionGlobalFilter</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EncryptionGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">2</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {</span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">        <span class="type">DataBufferFactory</span> <span class="variable">bufferFactory</span> <span class="operator">=</span> exchange.getResponse().bufferFactory();</span><br><span class="line">        <span class="type">ServerHttpRequestDecorator</span> <span class="variable">requestDecorator</span> <span class="operator">=</span> processRequest(request, bufferFactory);</span><br><span class="line">        <span class="type">ServerHttpResponseDecorator</span> <span class="variable">responseDecorator</span> <span class="operator">=</span> processResponse(response, bufferFactory);</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange.mutate().request(requestDecorator).response(responseDecorator).build());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServerHttpRequestDecorator <span class="title function_">processRequest</span><span class="params">(ServerHttpRequest request, DataBufferFactory bufferFactory)</span> {</span><br><span class="line">        Flux&lt;DataBuffer&gt; body = request.getBody();</span><br><span class="line">        <span class="type">DataBufferHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataBufferHolder</span>();</span><br><span class="line">        body.subscribe(dataBuffer -&gt; {</span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> dataBuffer.readableByteCount();</span><br><span class="line">            holder.length = len;</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[len];</span><br><span class="line">            dataBuffer.read(bytes);</span><br><span class="line">            DataBufferUtils.release(dataBuffer);</span><br><span class="line">            <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes, StandardCharsets.UTF_8);</span><br><span class="line">            <span class="type">JsonNode</span> <span class="variable">jsonNode</span> <span class="operator">=</span> readNode(text);</span><br><span class="line">            <span class="type">JsonNode</span> <span class="variable">payload</span> <span class="operator">=</span> jsonNode.get(<span class="string">&quot;payload&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">payloadText</span> <span class="operator">=</span> payload.asText();</span><br><span class="line">            <span class="type">byte</span>[] content = AesUtils.X.decrypt(payloadText);</span><br><span class="line">            <span class="type">String</span> <span class="variable">requestBody</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(content, StandardCharsets.UTF_8);</span><br><span class="line">            log.info(<span class="string">&quot;&#x4FEE;&#x6539;&#x8BF7;&#x6C42;&#x4F53;payload,&#x4FEE;&#x6539;&#x524D;:{},&#x4FEE;&#x6539;&#x540E;:{}&quot;</span>, payloadText, requestBody);</span><br><span class="line">            rewritePayloadNode(requestBody, jsonNode);</span><br><span class="line">            <span class="type">DataBuffer</span> <span class="variable">data</span> <span class="operator">=</span> bufferFactory.allocateBuffer();</span><br><span class="line">            data.write(jsonNode.toString().getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            holder.dataBuffer = data;</span><br><span class="line">        });</span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.putAll(request.getHeaders());</span><br><span class="line">        headers.remove(HttpHeaders.CONTENT_LENGTH);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerHttpRequestDecorator</span>(request) {</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> HttpHeaders <span class="title function_">getHeaders</span><span class="params">()</span> {</span><br><span class="line">                <span class="type">int</span> <span class="variable">contentLength</span> <span class="operator">=</span> holder.length;</span><br><span class="line">                <span class="keyword">if</span> (contentLength &gt; <span class="number">0</span>) {</span><br><span class="line">                    headers.setContentLength(contentLength);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    headers.set(HttpHeaders.TRANSFER_ENCODING, <span class="string">&quot;chunked&quot;</span>);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">return</span> headers;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Flux&lt;DataBuffer&gt; <span class="title function_">getBody</span><span class="params">()</span> {</span><br><span class="line">                <span class="keyword">return</span> Flux.just(holder.dataBuffer);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServerHttpResponseDecorator <span class="title function_">processResponse</span><span class="params">(ServerHttpResponse response, DataBufferFactory bufferFactory)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerHttpResponseDecorator</span>(response) {</span><br><span class="line"></span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">writeWith</span><span class="params">(Publisher&lt;? extends DataBuffer&gt; body)</span> {</span><br><span class="line">                <span class="keyword">if</span> (body <span class="keyword">instanceof</span> Flux) {</span><br><span class="line">                    Flux&lt;? <span class="keyword">extends</span> <span class="title class_">DataBuffer</span>&gt; flux = (Flux&lt;? <span class="keyword">extends</span> <span class="title class_">DataBuffer</span>&gt;) body;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.writeWith(flux.map(buffer -&gt; {</span><br><span class="line">                        <span class="type">CharBuffer</span> <span class="variable">charBuffer</span> <span class="operator">=</span> StandardCharsets.UTF_8.decode(buffer.asByteBuffer());</span><br><span class="line">                        DataBufferUtils.release(buffer);</span><br><span class="line">                        <span class="type">JsonNode</span> <span class="variable">jsonNode</span> <span class="operator">=</span> readNode(charBuffer.toString());</span><br><span class="line">                        <span class="type">JsonNode</span> <span class="variable">payload</span> <span class="operator">=</span> jsonNode.get(<span class="string">&quot;payload&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> payload.toString();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> AesUtils.X.encrypt(text);</span><br><span class="line">                        log.info(<span class="string">&quot;&#x4FEE;&#x6539;&#x54CD;&#x5E94;&#x4F53;payload,&#x4FEE;&#x6539;&#x524D;:{},&#x4FEE;&#x6539;&#x540E;:{}&quot;</span>, text, content);</span><br><span class="line">                        setPayloadTextNode(content, jsonNode);</span><br><span class="line">                        <span class="keyword">return</span> bufferFactory.wrap(jsonNode.toString().getBytes(StandardCharsets.UTF_8));</span><br><span class="line">                    }));</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.writeWith(body);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rewritePayloadNode</span><span class="params">(String text, JsonNode root)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">JsonNode</span> <span class="variable">node</span> <span class="operator">=</span> objectMapper.readTree(text);</span><br><span class="line">            <span class="type">ObjectNode</span> <span class="variable">objectNode</span> <span class="operator">=</span> (ObjectNode) root;</span><br><span class="line">            objectNode.set(<span class="string">&quot;payload&quot;</span>, node);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setPayloadTextNode</span><span class="params">(String text, JsonNode root)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">ObjectNode</span> <span class="variable">objectNode</span> <span class="operator">=</span> (ObjectNode) root;</span><br><span class="line">            objectNode.set(<span class="string">&quot;payload&quot;</span>, <span class="keyword">new</span> <span class="title class_">TextNode</span>(text));</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JsonNode <span class="title function_">readNode</span><span class="params">(String in)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">return</span> objectMapper.readTree(in);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">DataBufferHolder</span> {</span><br><span class="line"></span><br><span class="line">        DataBuffer dataBuffer;</span><br><span class="line">        <span class="type">int</span> length;</span><br><span class="line">    }</span><br><span class="line">}  </span><br></pre></td></tr></table></figure>

<p>&#x5148;&#x51C6;&#x5907;&#x4E00;&#x4EFD;&#x5BC6;&#x6587;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; json = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">8</span>);</span><br><span class="line">json.put(<span class="string">&quot;serialNumber&quot;</span>, <span class="string">&quot;&#x8BF7;&#x6C42;&#x6D41;&#x6C34;&#x53F7;&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="string">&quot;{\&quot;name\&quot;: \&quot;doge\&quot;}&quot;</span>;</span><br><span class="line">json.put(<span class="string">&quot;payload&quot;</span>, AesUtils.X.encrypt(content));</span><br><span class="line">System.out.println(<span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(json));</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#x8F93;&#x51FA;</span></span><br><span class="line">{<span class="string">&quot;serialNumber&quot;</span>:<span class="string">&quot;&#x8BF7;&#x6C42;&#x6D41;&#x6C34;&#x53F7;&quot;</span>,<span class="string">&quot;payload&quot;</span>:<span class="string">&quot;144e3dc734743f5709f1adf857bca473da683246fd612f86ac70edeb5f2d2729&quot;</span>}</span><br></pre></td></tr></table></figure>

<p>&#x6A21;&#x62DF;&#x8BF7;&#x6C42;&#xFF1A;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST /order/json HTTP/1.1</span><br><span class="line">Host: localhost:9090</span><br><span class="line">accessToken: 10086</span><br><span class="line">Content-Type: application/json</span><br><span class="line">User-Agent: PostmanRuntime/7.13.0</span><br><span class="line">Accept: */*</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Postman-Token: bda07fc3-ea1a-478c-b4d7-754fe6f37200,634734d9-feed-4fc9-ba20-7618bd986e1c</span><br><span class="line">Host: localhost:9090</span><br><span class="line">cookie: customCookieName=customCookieValue</span><br><span class="line">accept-encoding: gzip, deflate</span><br><span class="line">content-length: 104</span><br><span class="line">Connection: keep-alive</span><br><span class="line">cache-control: no-cache</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    &quot;serialNumber&quot;: &quot;&#x8BF7;&#x6C42;&#x6D41;&#x6C34;&#x53F7;&quot;,</span><br><span class="line">    &quot;payload&quot;: &quot;FE49xzR0P1cJ8a34V7ykc9poMkb9YS+GrHDt618tJyk=&quot;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// &#x54CD;&#x5E94;&#x7ED3;&#x679C;</span><br><span class="line">{</span><br><span class="line">    &quot;serialNumber&quot;: &quot;&#x8BF7;&#x6C42;&#x6D41;&#x6C34;&#x53F7;&quot;,</span><br><span class="line">    &quot;payload&quot;: &quot;oo/K1igg2t/S8EExkBVGWOfI1gAh5pBpZ0wyjNPW6e8=&quot;   # &lt;--- &#x89E3;&#x5BC6;&#x540E;&#xFF1A;{&quot;name&quot;:&quot;doge&quot;,&quot;age&quot;:26}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x9047;&#x5230;&#x7684;&#x95EE;&#x9898;&#xFF1A;</p>
<ul>
<li>&#x5FC5;&#x987B;&#x5B9E;&#x73B0;Ordered&#x63A5;&#x53E3;&#xFF0C;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x5C0F;&#x4E8E;-1&#x7684;order&#x503C;&#xFF0C;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;NettyWriteResponseFilter&#x7684;order&#x503C;&#x4E3A;-1&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8986;&#x76D6;&#x8FD4;&#x56DE;&#x54CD;&#x5E94;&#x4F53;&#x7684;&#x903B;&#x8F91;&#xFF0C;&#x81EA;&#x5B9A;&#x4E49;&#x7684;GlobalFilter&#x5FC5;&#x987B;&#x6BD4;NettyWriteResponseFilter&#x4F18;&#x5148;&#x6267;&#x884C;&#x3002;</li>
<li>&#x7F51;&#x5173;&#x6BCF;&#x6B21;&#x91CD;&#x542F;&#x4E4B;&#x540E;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x603B;&#x662F;&#x65E0;&#x6CD5;&#x4ECE;&#x539F;&#x59CB;&#x7684;ServerHttpRequest&#x8BFB;&#x53D6;&#x5230;&#x6709;&#x6548;&#x7684;Body&#xFF0C;&#x51C6;&#x786E;&#x6765;&#x8BF4;&#x51FA;&#x73B0;&#x7684;&#x73B0;&#x8C61;&#x662F;NettyRoutingFilter&#x8C03;&#x7528;ServerHttpRequest#getBody()&#x7684;&#x65F6;&#x5019;&#x83B7;&#x53D6;&#x5230;&#x4E00;&#x4E2A;&#x7A7A;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5BFC;&#x81F4;&#x7A7A;&#x6307;&#x9488;&#xFF1B;&#x5947;&#x602A;&#x7684;&#x662F;&#x4ECE;&#x7B2C;&#x4E8C;&#x4E2A;&#x8BF7;&#x6C42;&#x5F00;&#x59CB;&#x5C31;&#x80FD;&#x6B63;&#x5E38;&#x8C03;&#x7528;&#x3002;&#x7B14;&#x8005;&#x628A;Spring Cloud Gateway&#x7684;&#x7248;&#x672C;&#x964D;&#x4F4E;&#x5230;Finchley.SR3&#xFF0C;Spring Boot&#x7684;&#x7248;&#x672C;&#x964D;&#x4F4E;&#x5230;2.0.8.RELEASE&#xFF0C;&#x95EE;&#x9898;&#x4E0D;&#x518D;&#x51FA;&#x73B0;&#xFF0C;&#x521D;&#x6B65;&#x786E;&#x5B9A;&#x662F;Spring Cloud Gateway&#x7248;&#x672C;&#x5347;&#x7EA7;&#x5BFC;&#x81F4;&#x7684;&#x517C;&#x5BB9;&#x6027;&#x95EE;&#x9898;&#x6216;&#x8005;&#x662F;BUG&#x3002;</li>
</ul>
<p>&#x6700;&#x91CD;&#x8981;&#x7684;&#x662F;&#x7528;&#x5230;&#x4E86;ServerHttpResponse&#x88C5;&#x9970;&#x5668;ServerHttpResponseDecorator&#xFF0C;&#x4E3B;&#x8981;&#x8986;&#x76D6;&#x5199;&#x5165;&#x54CD;&#x5E94;&#x4F53;&#x6570;&#x636E;&#x7F13;&#x51B2;&#x533A;&#x7684;&#x90E8;&#x5206;&#xFF0C;&#x81F3;&#x4E8E;&#x600E;&#x4E48;&#x5904;&#x7406;&#x5176;&#x4ED6;&#x903B;&#x8F91;&#x9700;&#x8981;&#x81EA;&#x884C;&#x8003;&#x8651;&#xFF0C;&#x8FD9;&#x91CC;&#x53EA;&#x662F;&#x505A;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x793A;&#x8303;&#x3002;&#x4E00;&#x822C;&#x7684;&#x4EE3;&#x7801;&#x903B;&#x8F91;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line"><span class="type">ServerHttpResponseDecorator</span> <span class="variable">responseDecorator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerHttpResponseDecorator</span>(response) {</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">writeWith</span><span class="params">(Publisher&lt;? extends DataBuffer&gt; body)</span> {</span><br><span class="line">                <span class="keyword">if</span> (body <span class="keyword">instanceof</span> Flux) {</span><br><span class="line">                    Flux&lt;? <span class="keyword">extends</span> <span class="title class_">DataBuffer</span>&gt; flux = (Flux&lt;? <span class="keyword">extends</span> <span class="title class_">DataBuffer</span>&gt;) body;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.writeWith(flux.map(buffer -&gt; {</span><br><span class="line">                        <span class="comment">// buffer&#x5C31;&#x662F;&#x539F;&#x59CB;&#x7684;&#x54CD;&#x5E94;&#x6570;&#x636E;&#x7684;&#x7F13;&#x51B2;&#x533A;</span></span><br><span class="line">                        <span class="comment">// &#x4E0B;&#x9762;&#x5904;&#x7406;&#x5B8C;&#x6BD5;&#x4E4B;&#x540E;&#x8FD4;&#x56DE;&#x65B0;&#x7684;&#x54CD;&#x5E94;&#x6570;&#x636E;&#x7684;&#x7F13;&#x51B2;&#x533A;&#x5373;&#x53EF;</span></span><br><span class="line">                        <span class="keyword">return</span> bufferFactory.wrap(...);</span><br><span class="line">                    }));</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.writeWith(body);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"><span class="keyword">return</span> chain.filter(exchange.mutate().response(responseDecorator).build());</span><br></pre></td></tr></table></figure>

<h1 id="&#x8BF7;&#x6C42;&#x4F53;&#x6216;&#x8005;&#x54CD;&#x5E94;&#x4F53;&#x62A5;&#x6587;&#x8FC7;&#x5927;&#x7684;&#x95EE;&#x9898;"><a href="#&#x8BF7;&#x6C42;&#x4F53;&#x6216;&#x8005;&#x54CD;&#x5E94;&#x4F53;&#x62A5;&#x6587;&#x8FC7;&#x5927;&#x7684;&#x95EE;&#x9898;" class="headerlink" title="&#x8BF7;&#x6C42;&#x4F53;&#x6216;&#x8005;&#x54CD;&#x5E94;&#x4F53;&#x62A5;&#x6587;&#x8FC7;&#x5927;&#x7684;&#x95EE;&#x9898;"></a>&#x8BF7;&#x6C42;&#x4F53;&#x6216;&#x8005;&#x54CD;&#x5E94;&#x4F53;&#x62A5;&#x6587;&#x8FC7;&#x5927;&#x7684;&#x95EE;&#x9898;</h1><p>&#x6709;&#x70ED;&#x5FC3;&#x7684;&#x540C;&#x5B66;&#x544A;&#x8BC9;&#x7B14;&#x8005;&#xFF0C;&#x5982;&#x679C;&#x8BF7;&#x6C42;&#x62A5;&#x6587;&#x8FC7;&#x5927;&#x6216;&#x8005;&#x54CD;&#x5E94;&#x62A5;&#x6587;&#x8FC7;&#x5927;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x524D;&#x9762;&#x4E24;&#x8282;&#x7684;&#x4FEE;&#x6539;&#x8BF7;&#x6C42;&#x548C;&#x54CD;&#x5E94;&#x62A5;&#x6587;&#x7684;&#x65B9;&#x6CD5;&#x4F1A;&#x51FA;&#x73B0;&#x95EE;&#x9898;&#xFF0C;&#x8FD9;&#x91CC;&#x5C1D;&#x8BD5;&#x91CD;&#x73B0;&#x4E00;&#x4E0B;&#x9047;&#x5230;&#x7684;&#x5177;&#x4F53;&#x95EE;&#x9898;&#x3002;&#x5148;&#x628A;&#x8BF7;&#x6C42;&#x62A5;&#x6587;&#x5C1D;&#x8BD5;&#x52A0;&#x957F;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; json = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">8</span>);</span><br><span class="line">json.put(<span class="string">&quot;serialNumber&quot;</span>, <span class="string">&quot;&#x8BF7;&#x6C42;&#x6D41;&#x6C34;&#x53F7;&quot;</span>);</span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) {</span><br><span class="line">    builder.append(<span class="string">&quot;doge&quot;</span>);</span><br><span class="line">}</span><br><span class="line"><span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> String.format(<span class="string">&quot;{\&quot;name\&quot;: \&quot;%s\&quot;}&quot;</span>, builder.toString());</span><br><span class="line">json.put(<span class="string">&quot;payload&quot;</span>, AesUtils.X.encrypt(content));</span><br><span class="line">System.out.println(<span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(json));</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#x8BF7;&#x6C42;&#x7684;JSON&#x62A5;&#x6587;&#x5982;&#x4E0B;&#xFF1A;</span></span><br><span class="line">{</span><br><span class="line">    <span class="string">&quot;serialNumber&quot;</span>: <span class="string">&quot;&#x8BF7;&#x6C42;&#x6D41;&#x6C34;&#x53F7;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;payload&quot;</span>: <span class="string">&quot;0Dcf2plFpESprKjkdqNHM8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/zyJ4ipyLGvo5LX87d9oDAs=&quot;</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7528;&#x4E0A;&#x9762;&#x7684;&#x8BF7;&#x6C42;&#x62A5;&#x6587;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;&#xFF0C;&#x786E;&#x5B9E;&#x5B58;&#x5728;&#x95EE;&#x9898;&#xFF1A;</p>
<p><img src="/2021/09/01/9G5.009.%E6%A1%86%E6%9E%B6-SpringCloud-Gateway-throwable%E7%B3%BB%E5%88%97-Spring%20Cloud%20Gateway-ServerWebExchange%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95%E4%B8%8E%E8%AF%B7%E6%B1%82%E6%88%96%E8%80%85%E5%93%8D%E5%BA%94%E5%86%85%E5%AE%B9%E7%9A%84%E4%BF%AE%E6%94%B9/2.png"></p>
<p>&#x4E3B;&#x8981;&#x95EE;&#x9898;&#x662F;&#xFF1A;</p>
<ul>
<li>&#x8BF7;&#x6C42;&#x4F53;&#x5305;&#x6570;&#x636E;&#x88C5;&#x6210;&#x7684;Flux<DataBuffer>&#x5B9E;&#x4F8B;&#x88AB;&#x8BA2;&#x9605;&#x4E4B;&#x540E;&#xFF0C;&#x8BFB;&#x53D6;&#x5230;&#x7684;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x7684;&#x957F;&#x5EA6;&#x88AB;&#x622A;&#x65AD;&#x4E86;&#xFF0C;&#x63D0;&#x4F9B;&#x7684;&#x539F;&#x59CB;&#x8BF7;&#x6C42;&#x62A5;&#x6587;&#x91CC;&#x9762;&#x5B57;&#x7B26;&#x4E32;&#x957F;&#x5EA6;&#x8981;&#x5927;&#x4E8E;1000&#xFF0C;&#x8F6C;&#x6362;&#x6210;byte&#x6570;&#x7EC4;&#x7EDD;&#x5BF9;&#x8981;&#x5927;&#x4E8E;1000&#xFF0C;&#x4F46;&#x662F;&#x4E0A;&#x9762;&#x7684;&#x793A;&#x4F8B;&#x4E2D;&#x53EA;&#x8BFB;&#x53D6;&#x5230;&#x957F;&#x5EA6;&#x4E3A;673&#x7684;byte&#x6570;&#x7EC4;&#x3002;</DataBuffer></li>
<li>&#x8BFB;&#x53D6;&#x5230;&#x7684;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x88AB;&#x622A;&#x65AD;&#x540E;&#xFF0C;&#x5219;&#x4F7F;&#x7528;Jackson&#x8FDB;&#x884C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x65F6;&#x5019;&#x63D0;&#x793A;&#x6CA1;&#x6709;&#x8BFB;&#x53D6;&#x5230;&#x5B57;&#x7B26;&#x4E32;&#x7684;EOF&#x6807;&#x8BC6;&#xFF0C;&#x5BFC;&#x81F4;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5931;&#x8D25;&#x3002;<br>&#x65E2;&#x7136;&#x9047;&#x5230;&#x4E86;&#x95EE;&#x9898;&#xFF0C;&#x5C31;&#x60F3;&#x529E;&#x6CD5;&#x89E3;&#x51B3;&#x3002;&#x9996;&#x5148;&#x7B2C;&#x4E00;&#x6B65;&#x5B9A;&#x4F4D;&#x4E00;&#x4E0B;&#x662F;&#x4EC0;&#x4E48;&#x539F;&#x56E0;&#xFF0C;&#x76F4;&#x89C9;&#x544A;&#x8BC9;&#x7B14;&#x8005;&#xFF1A;&#x8981;&#x5F00;&#x542F;&#x4E00;&#x4E0B;DEBUG&#x65E5;&#x5FD7;&#x8FDB;&#x884C;&#x89C2;&#x5BDF;&#xFF0C;&#x5982;&#x679C;&#x8FD8;&#x6CA1;&#x6709;&#x5934;&#x7EEA;&#x53EF;&#x80FD;&#x8981;&#x8DDF;&#x8E2A;&#x4E00;&#x4E0B;&#x6E90;&#x7801;&#x3002;</li>
</ul>
<p>&#x5F00;&#x542F;DEBUG&#x65E5;&#x5FD7;&#x7EA7;&#x522B;&#x4E4B;&#x540E;&#x505A;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;&#xFF0C;&#x53D1;&#x73B0;&#x4E86;&#x4E00;&#x4E9B;&#x53EF;&#x7591;&#x7684;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#xFF1A;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">2019-05-19 11:16:15.660 [reactor-http-nio-2] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0xa9b527e5, L:/0:0:0:0:0:0:0:1:9090 - R:/0:0:0:0:0:0:0:1:58012] READ COMPLETE</span><br><span class="line">2019-05-19 11:16:15.660 [reactor-http-nio-2] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0xa9b527e5, L:/0:0:0:0:0:0:0:1:9090 ! R:/0:0:0:0:0:0:0:1:58012] INACTIVE</span><br><span class="line">2019-05-19 11:16:15.660 [reactor-http-nio-3] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0x5554e091, L:/0:0:0:0:0:0:0:1:9090 - R:/0:0:0:0:0:0:0:1:58013] READ: 1024B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 50 4f 53 54 20 2f 6f 72 64 65 72 2f 6a 73 6f 6e |POST /order/json|</span><br><span class="line">|00000010| 20 48 54 54 50 2f 31 2e 31 0d 0a 61 63 63 65 73 | HTTP/1.1..acces|</span><br><span class="line">|00000020| 73 54 6f 6b 65 6e 3a 20 31 30 30 38 36 0d 0a 43 |sToken: 10086..C|</span><br><span class="line">|00000030| 6f 6e 74 65 6e 74 2d 54 79 70 65 3a 20 61 70 70 |ontent-Type: app|</span><br><span class="line">|00000040| 6c 69 63 61 74 69 6f 6e 2f 6a 73 6f 6e 0d 0a 55 |lication/json..U|</span><br><span class="line">|00000050| 73 65 72 2d 41 67 65 6e 74 3a 20 50 6f 73 74 6d |ser-Agent: Postm|</span><br><span class="line">|00000060| 61 6e 52 75 6e 74 69 6d 65 2f 37 2e 31 33 2e 30 |anRuntime/7.13.0|</span><br><span class="line">|00000070| 0d 0a 41 63 63 65 70 74 3a 20 2a 2f 2a 0d 0a 43 |..Accept: */*..C|</span><br><span class="line">|00000080| 61 63 68 65 2d 43 6f 6e 74 72 6f 6c 3a 20 6e 6f |ache-Control: no|</span><br><span class="line">|00000090| 2d 63 61 63 68 65 0d 0a 50 6f 73 74 6d 61 6e 2d |-cache..Postman-|</span><br><span class="line">|000000a0| 54 6f 6b 65 6e 3a 20 31 31 32 30 38 64 35 39 2d |Token: 11208d59-|</span><br><span class="line">|000000b0| 65 61 34 61 2d 34 62 39 63 2d 61 30 33 39 2d 30 |ea4a-4b9c-a039-0|</span><br><span class="line">|000000c0| 30 65 36 64 38 61 30 65 33 65 66 0d 0a 48 6f 73 |0e6d8a0e3ef..Hos|</span><br><span class="line">|000000d0| 74 3a 20 6c 6f 63 61 6c 68 6f 73 74 3a 39 30 39 |t: localhost:909|</span><br><span class="line">|000000e0| 30 0d 0a 63 6f 6f 6b 69 65 3a 20 63 75 73 74 6f |0..cookie: custo|</span><br><span class="line">|000000f0| 6d 43 6f 6f 6b 69 65 4e 61 6d 65 3d 63 75 73 74 |mCookieName=cust|</span><br><span class="line">|00000100| 6f 6d 43 6f 6f 6b 69 65 56 61 6c 75 65 0d 0a 61 |omCookieValue..a|</span><br><span class="line">|00000110| 63 63 65 70 74 2d 65 6e 63 6f 64 69 6e 67 3a 20 |ccept-encoding: |</span><br><span class="line">|00000120| 67 7a 69 70 2c 20 64 65 66 6c 61 74 65 0d 0a 63 |gzip, deflate..c|</span><br><span class="line">|00000130| 6f 6e 74 65 6e 74 2d 6c 65 6e 67 74 68 3a 20 35 |ontent-length: 5|</span><br><span class="line">|00000140| 34 31 36 0d 0a 43 6f 6e 6e 65 63 74 69 6f 6e 3a |416..Connection:|</span><br><span class="line">|00000150| 20 6b 65 65 70 2d 61 6c 69 76 65 0d 0a 0d 0a 7b | keep-alive....{|</span><br><span class="line">|00000160| 0a 20 20 20 20 22 73 65 72 69 61 6c 4e 75 6d 62 |.    &quot;serialNumb|</span><br><span class="line">|00000170| 65 72 22 3a 20 22 e8 af b7 e6 b1 82 e6 b5 81 e6 |er&quot;: &quot;..........|</span><br><span class="line">|00000180| b0 b4 e5 8f b7 22 2c 0a 20 20 20 20 22 70 61 79 |.....&quot;,.    &quot;pay|</span><br><span class="line">|00000190| 6c 6f 61 64 22 3a 20 22 30 44 63 66 32 70 6c 46 |load&quot;: &quot;0Dcf2plF|</span><br><span class="line">|000001a0| 70 45 53 70 72 4b 6a 6b 64 71 4e 48 4d 38 6a 6a |pESprKjkdqNHM8jj|</span><br><span class="line">|000001b0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|</span><br><span class="line">|000001c0| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|</span><br><span class="line">|000001d0| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|</span><br><span class="line">|000001e0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|</span><br><span class="line">|000001f0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|</span><br><span class="line">|00000200| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|</span><br><span class="line">|00000210| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|</span><br><span class="line">|00000220| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|</span><br><span class="line">|00000230| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|</span><br><span class="line">|00000240| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|</span><br><span class="line">|00000250| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|</span><br><span class="line">|00000260| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|</span><br><span class="line">|00000270| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|</span><br><span class="line">|00000280| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|</span><br><span class="line">|00000290| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|</span><br><span class="line">|000002a0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|</span><br><span class="line">|000002b0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|</span><br><span class="line">|000002c0| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|</span><br><span class="line">|000002d0| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|</span><br><span class="line">|000002e0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|</span><br><span class="line">|000002f0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|</span><br><span class="line">|00000300| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|</span><br><span class="line">|00000310| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|</span><br><span class="line">|00000320| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|</span><br><span class="line">|00000330| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|</span><br><span class="line">|00000340| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|</span><br><span class="line">|00000350| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|</span><br><span class="line">|00000360| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|</span><br><span class="line">|00000370| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|</span><br><span class="line">|00000380| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|</span><br><span class="line">|00000390| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|</span><br><span class="line">|000003a0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|</span><br><span class="line">|000003b0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|</span><br><span class="line">|000003c0| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|</span><br><span class="line">|000003d0| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|</span><br><span class="line">|000003e0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|</span><br><span class="line">|000003f0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">2019-05-19 11:16:15.662 [reactor-http-nio-2] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0xa9b527e5, L:/0:0:0:0:0:0:0:1:9090 ! R:/0:0:0:0:0:0:0:1:58012] UNREGISTERED</span><br><span class="line">2019-05-19 11:16:15.665 [reactor-http-nio-3] DEBUG reactor.ipc.netty.http.server.HttpServerOperations - [id: 0x5554e091, L:/0:0:0:0:0:0:0:1:9090 - R:/0:0:0:0:0:0:0:1:58013] Increasing pending responses, now 1</span><br><span class="line">2019-05-19 11:16:15.671 [reactor-http-nio-3] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0x5554e091, L:/0:0:0:0:0:0:0:1:9090 - R:/0:0:0:0:0:0:0:1:58013] READ COMPLETE</span><br></pre></td></tr></table></figure>

<p>&#x6CE8;&#x610F;&#x4E00;&#x4E0B;&#x5173;&#x952E;&#x5B57;READ: 1024B&#xFF0C;&#x8FD9;&#x91CC;&#x5E94;&#x8BE5;&#x662F;&#x5E95;&#x5C42;&#x7684;Reactor-Netty&#x8BFB;&#x53D6;&#x7684;&#x6700;&#x5927;&#x6570;&#x636E;&#x62A5;&#x7684;&#x957F;&#x5EA6;&#x9650;&#x5236;&#xFF0C;&#x6253;&#x5370;&#x51FA;&#x6765;&#x7684;&#x6570;&#x636E;&#x62A5;&#x521A;&#x597D;&#x4E5F;&#x662F;1024B&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x8FD9;&#x4E2A;&#x5E94;&#x8BE5;&#x5C31;&#x662F;&#x5BFC;&#x81F4;&#x8BF7;&#x6C42;&#x4F53;&#x88AB;&#x622A;&#x65AD;&#x7684;&#x6839;&#x672C;&#x539F;&#x56E0;&#xFF1B;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x4E0D;&#x5355;&#x5355;&#x4F1A;&#x51FA;&#x73B0;&#x5728;&#x8BF7;&#x6C42;&#x4F53;&#x7684;&#x83B7;&#x53D6;&#xFF0C;&#x4E5F;&#x4F1A;&#x51FA;&#x73B0;&#x5728;&#x54CD;&#x5E94;&#x4F53;&#x7684;&#x5199;&#x5165;&#x3002;&#x65E2;&#x7136;&#x8FD9;&#x4E2A;&#x662F;&#x5171;&#x6027;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x90A3;&#x4E48;&#x9879;&#x76EE;Github&#x4E0A;&#x80AF;&#x5B9A;&#x6709;&#x5BF9;&#x5E94;&#x7684;Issue&#xFF0C;&#x627E;&#x5230;&#x4E00;&#x4E2A;&#x4E92;&#x52A8;&#x6BD4;&#x8F83;&#x957F;&#x7684;<a target="_blank" rel="noopener" href="https://github.com/spring-cloud/spring-cloud-gateway/issues/581">gateway request size limit 1024B because netty default limit 1024,how to solve it? #581</a>&#xFF0C;&#x4ECE;&#x56DE;&#x7B54;&#x6765;&#x770B;&#xFF0C;&#x5B98;&#x65B9;&#x5EFA;&#x8BAE;&#x4F7F;&#x7528;ModifyRequestBodyGatewayFilterFactory&#x548C;ModifyResponseBodyGatewayFilterFactory&#x5B8C;&#x6210;&#x5BF9;&#x5E94;&#x7684;&#x529F;&#x80FD;&#x3002;&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x501F;&#x9274;&#x4E00;&#x4E0B;ModifyRequestBodyGatewayFilterFactory&#x7684;&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#x4FEE;&#x6539;&#x4E4B;&#x524D;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x56E0;&#x4E3A;&#x4EE3;&#x7801;&#x7684;&#x903B;&#x8F91;&#x6BD4;&#x8F83;&#x957F;&#x548C;&#x590D;&#x6742;&#xFF0C;&#x89E3;&#x5BC6;&#x8BF7;&#x6C42;&#x4F53;&#x7684;&#x8FC7;&#x6EE4;&#x5668;&#x62C6;&#x5206;&#x5230;&#x65B0;&#x7684;&#x7C7B;RequestEncryptionGlobalFilter&#xFF0C;&#x52A0;&#x5BC6;&#x54CD;&#x5E94;&#x4F53;&#x7684;&#x8FC7;&#x6EE4;&#x5668;&#x62C6;&#x5206;&#x5230;ResponseDecryptionGlobalFilter&#xFF1A;</p>
<p>RequestEncryptionGlobalFilter&#x7684;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestEncryptionGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;HttpMessageReader&lt;?&gt;&gt; messageReaders = HandlerStrategies.withDefaults().messageReaders();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">2</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {</span><br><span class="line">        <span class="keyword">return</span> processRequest(exchange, chain);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">processRequest</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {</span><br><span class="line">        <span class="type">ServerRequest</span> <span class="variable">serverRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultServerRequest</span>(exchange, messageReaders);</span><br><span class="line">        <span class="type">DataBufferFactory</span> <span class="variable">bufferFactory</span> <span class="operator">=</span> exchange.getResponse().bufferFactory();</span><br><span class="line">        Mono&lt;String&gt; rawBody = serverRequest.bodyToMono(String.class).map(s -&gt; s);</span><br><span class="line">        BodyInserter&lt;Mono&lt;String&gt;, ReactiveHttpOutputMessage&gt; bodyInserter = BodyInserters.fromPublisher(rawBody, String.class);</span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">tempHeaders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        tempHeaders.putAll(exchange.getRequest().getHeaders());</span><br><span class="line">        tempHeaders.remove(HttpHeaders.CONTENT_LENGTH);</span><br><span class="line">        <span class="type">CachedBodyOutputMessage</span> <span class="variable">outputMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CachedBodyOutputMessage</span>(exchange, tempHeaders);</span><br><span class="line">        <span class="keyword">return</span> bodyInserter.insert(outputMessage, <span class="keyword">new</span> <span class="title class_">BodyInserterContext</span>()).then(Mono.defer(() -&gt; {</span><br><span class="line">            Flux&lt;DataBuffer&gt; body = outputMessage.getBody();</span><br><span class="line">            <span class="type">DataBufferHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataBufferHolder</span>();</span><br><span class="line">            body.subscribe(dataBuffer -&gt; {</span><br><span class="line">                <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> dataBuffer.readableByteCount();</span><br><span class="line">                holder.length = len;</span><br><span class="line">                <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[len];</span><br><span class="line">                dataBuffer.read(bytes);</span><br><span class="line">                DataBufferUtils.release(dataBuffer);</span><br><span class="line">                <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes, StandardCharsets.UTF_8);</span><br><span class="line">                <span class="type">JsonNode</span> <span class="variable">jsonNode</span> <span class="operator">=</span> readNode(text);</span><br><span class="line">                <span class="type">JsonNode</span> <span class="variable">payload</span> <span class="operator">=</span> jsonNode.get(<span class="string">&quot;payload&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">payloadText</span> <span class="operator">=</span> payload.asText();</span><br><span class="line">                <span class="type">byte</span>[] content = AesUtils.X.decrypt(payloadText);</span><br><span class="line">                <span class="type">String</span> <span class="variable">requestBody</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(content, StandardCharsets.UTF_8);</span><br><span class="line">                log.info(<span class="string">&quot;&#x4FEE;&#x6539;&#x8BF7;&#x6C42;&#x4F53;payload,&#x4FEE;&#x6539;&#x524D;:{},&#x4FEE;&#x6539;&#x540E;:{}&quot;</span>, payloadText, requestBody);</span><br><span class="line">                rewritePayloadNode(requestBody, jsonNode);</span><br><span class="line">                <span class="type">DataBuffer</span> <span class="variable">data</span> <span class="operator">=</span> bufferFactory.allocateBuffer();</span><br><span class="line">                data.write(jsonNode.toString().getBytes(StandardCharsets.UTF_8));</span><br><span class="line">                holder.dataBuffer = data;</span><br><span class="line">            });</span><br><span class="line">            <span class="type">ServerHttpRequestDecorator</span> <span class="variable">requestDecorator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerHttpRequestDecorator</span>(exchange.getRequest()) {</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> HttpHeaders <span class="title function_">getHeaders</span><span class="params">()</span> {</span><br><span class="line">                    <span class="type">long</span> <span class="variable">contentLength</span> <span class="operator">=</span> tempHeaders.getContentLength();</span><br><span class="line">                    <span class="type">HttpHeaders</span> <span class="variable">httpHeaders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">                    httpHeaders.putAll(<span class="built_in">super</span>.getHeaders());</span><br><span class="line">                    <span class="keyword">if</span> (contentLength &gt; <span class="number">0</span>) {</span><br><span class="line">                        httpHeaders.setContentLength(contentLength);</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        httpHeaders.set(HttpHeaders.TRANSFER_ENCODING, <span class="string">&quot;chunked&quot;</span>);</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">return</span> httpHeaders;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Flux&lt;DataBuffer&gt; <span class="title function_">getBody</span><span class="params">()</span> {</span><br><span class="line">                    <span class="keyword">return</span> Flux.just(holder.dataBuffer);</span><br><span class="line">                }</span><br><span class="line">            };</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange.mutate().request(requestDecorator).build());</span><br><span class="line">        }));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rewritePayloadNode</span><span class="params">(String text, JsonNode root)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">JsonNode</span> <span class="variable">node</span> <span class="operator">=</span> objectMapper.readTree(text);</span><br><span class="line">            <span class="type">ObjectNode</span> <span class="variable">objectNode</span> <span class="operator">=</span> (ObjectNode) root;</span><br><span class="line">            objectNode.set(<span class="string">&quot;payload&quot;</span>, node);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setPayloadTextNode</span><span class="params">(String text, JsonNode root)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">ObjectNode</span> <span class="variable">objectNode</span> <span class="operator">=</span> (ObjectNode) root;</span><br><span class="line">            objectNode.set(<span class="string">&quot;payload&quot;</span>, <span class="keyword">new</span> <span class="title class_">TextNode</span>(text));</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JsonNode <span class="title function_">readNode</span><span class="params">(String in)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">return</span> objectMapper.readTree(in);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">DataBufferHolder</span> {</span><br><span class="line"></span><br><span class="line">        DataBuffer dataBuffer;</span><br><span class="line">        <span class="type">int</span> length;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>ResponseDecryptionGlobalFilter&#x7684;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResponseDecryptionGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> NettyWriteResponseFilter.WRITE_RESPONSE_FILTER_ORDER - <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {</span><br><span class="line">        <span class="keyword">return</span> processResponse(exchange, chain);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">processResponse</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {</span><br><span class="line">        <span class="type">ServerHttpResponseDecorator</span> <span class="variable">responseDecorator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerHttpResponseDecorator</span>(exchange.getResponse()) {</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">writeWith</span><span class="params">(Publisher&lt;? extends DataBuffer&gt; body)</span> {</span><br><span class="line">                <span class="type">String</span> <span class="variable">originalResponseContentType</span> <span class="operator">=</span> exchange.getAttribute(ORIGINAL_RESPONSE_CONTENT_TYPE_ATTR);</span><br><span class="line">                <span class="type">HttpHeaders</span> <span class="variable">httpHeaders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">                httpHeaders.add(HttpHeaders.CONTENT_TYPE, originalResponseContentType);</span><br><span class="line">                <span class="type">ResponseAdapter</span> <span class="variable">responseAdapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseAdapter</span>(body, httpHeaders);</span><br><span class="line">                <span class="type">DefaultClientResponse</span> <span class="variable">clientResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultClientResponse</span>(responseAdapter, ExchangeStrategies.withDefaults());</span><br><span class="line">                Mono&lt;String&gt; rawBody = clientResponse.bodyToMono(String.class).map(s -&gt; s);</span><br><span class="line">                BodyInserter&lt;Mono&lt;String&gt;, ReactiveHttpOutputMessage&gt; bodyInserter = BodyInserters.fromPublisher(rawBody, String.class);</span><br><span class="line">                <span class="type">CachedBodyOutputMessage</span> <span class="variable">outputMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CachedBodyOutputMessage</span>(exchange, exchange.getResponse().getHeaders());</span><br><span class="line">                <span class="keyword">return</span> bodyInserter.insert(outputMessage, <span class="keyword">new</span> <span class="title class_">BodyInserterContext</span>())</span><br><span class="line">                        .then(Mono.defer(() -&gt; {</span><br><span class="line">                            Flux&lt;DataBuffer&gt; messageBody = outputMessage.getBody();</span><br><span class="line">                            Flux&lt;DataBuffer&gt; flux = messageBody.map(buffer -&gt; {</span><br><span class="line">                                <span class="type">CharBuffer</span> <span class="variable">charBuffer</span> <span class="operator">=</span> StandardCharsets.UTF_8.decode(buffer.asByteBuffer());</span><br><span class="line">                                DataBufferUtils.release(buffer);</span><br><span class="line">                                <span class="type">JsonNode</span> <span class="variable">jsonNode</span> <span class="operator">=</span> readNode(charBuffer.toString());</span><br><span class="line">                                <span class="type">JsonNode</span> <span class="variable">payload</span> <span class="operator">=</span> jsonNode.get(<span class="string">&quot;payload&quot;</span>);</span><br><span class="line">                                <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> payload.toString();</span><br><span class="line">                                <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> AesUtils.X.encrypt(text);</span><br><span class="line">                                log.info(<span class="string">&quot;&#x4FEE;&#x6539;&#x54CD;&#x5E94;&#x4F53;payload,&#x4FEE;&#x6539;&#x524D;:{},&#x4FEE;&#x6539;&#x540E;:{}&quot;</span>, text, content);</span><br><span class="line">                                setPayloadTextNode(content, jsonNode);</span><br><span class="line">                                <span class="keyword">return</span> getDelegate().bufferFactory().wrap(jsonNode.toString().getBytes(StandardCharsets.UTF_8));</span><br><span class="line">                            });</span><br><span class="line">                            <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> getDelegate().getHeaders();</span><br><span class="line">                            <span class="keyword">if</span> (!headers.containsKey(HttpHeaders.TRANSFER_ENCODING)) {</span><br><span class="line">                                flux = flux.doOnNext(data -&gt; headers.setContentLength(data.readableByteCount()));</span><br><span class="line">                            }</span><br><span class="line">                            <span class="keyword">return</span> getDelegate().writeWith(flux);</span><br><span class="line">                        }));</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange.mutate().response(responseDecorator).build());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setPayloadTextNode</span><span class="params">(String text, JsonNode root)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">ObjectNode</span> <span class="variable">objectNode</span> <span class="operator">=</span> (ObjectNode) root;</span><br><span class="line">            objectNode.set(<span class="string">&quot;payload&quot;</span>, <span class="keyword">new</span> <span class="title class_">TextNode</span>(text));</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JsonNode <span class="title function_">readNode</span><span class="params">(String in)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">return</span> objectMapper.readTree(in);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ResponseAdapter</span> <span class="keyword">implements</span> <span class="title class_">ClientHttpResponse</span> {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Flux&lt;DataBuffer&gt; flux;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> HttpHeaders headers;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">ResponseAdapter</span><span class="params">(Publisher&lt;? extends DataBuffer&gt; body, HttpHeaders headers)</span> {</span><br><span class="line">            <span class="built_in">this</span>.headers = headers;</span><br><span class="line">            <span class="keyword">if</span> (body <span class="keyword">instanceof</span> Flux) {</span><br><span class="line">                flux = (Flux) body;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                flux = ((Mono) body).flux();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Flux&lt;DataBuffer&gt; <span class="title function_">getBody</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">return</span> flux;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> HttpHeaders <span class="title function_">getHeaders</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">return</span> headers;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> HttpStatus <span class="title function_">getStatusCode</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getRawStatusCode</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> MultiValueMap&lt;String, ResponseCookie&gt; <span class="title function_">getCookies</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6A21;&#x62DF;&#x8BF7;&#x6C42;&#xFF1A;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">POST /order/json HTTP/1.1</span><br><span class="line">Host: localhost:9090</span><br><span class="line">accessToken: 10086</span><br><span class="line">Content-Type: application/json</span><br><span class="line">User-Agent: PostmanRuntime/7.13.0</span><br><span class="line">Accept: */*</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Postman-Token: 3a830202-f3d1-450e-839f-ae8f3b88bced,b229feb1-7c8b-4d25-a039-09345f3fe8f0</span><br><span class="line">Host: localhost:9090</span><br><span class="line">cookie: customCookieName=customCookieValue</span><br><span class="line">accept-encoding: gzip, deflate</span><br><span class="line">content-length: 5416</span><br><span class="line">Connection: keep-alive</span><br><span class="line">cache-control: no-cache</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    &quot;serialNumber&quot;: &quot;&#x8BF7;&#x6C42;&#x6D41;&#x6C34;&#x53F7;&quot;,</span><br><span class="line">    &quot;payload&quot;: &quot;0Dcf2plFpESprKjkdqNHM8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/zyJ4ipyLGvo5LX87d9oDAs=&quot;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// &#x54CD;&#x5E94;</span><br><span class="line">{&quot;serialNumber&quot;:&quot;&#x8BF7;&#x6C42;&#x6D41;&#x6C34;&#x53F7;&quot;,&quot;userId&quot;:null,&quot;payload&quot;:&quot;7S2VqLu4J6LdW0As50JgZ0eFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+Dm8rTVHylECORYnLNgnfWx0ENJ9a6E+abYhyFJ9zSIda&quot;}</span><br></pre></td></tr></table></figure>

<p>&#x5F7B;&#x5E95;&#x89E3;&#x51B3;&#x4E86;&#x4E4B;&#x524D;&#x7684;&#x8BF7;&#x6C42;&#x6216;&#x8005;&#x54CD;&#x5E94;&#x62A5;&#x6587;&#x622A;&#x65AD;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x7B14;&#x8005;&#x53D1;&#x73B0;&#x4E86;&#x5F88;&#x591A;&#x535A;&#x6587;&#x90FD;&#x5728;(&#x7167;&#x642C;)&#x66F4;&#x6539;&#x8BFB;&#x53D6;DataBuffer&#x5B9E;&#x4F8B;&#x65F6;&#x5019;&#x7684;&#x4EE3;&#x7801;&#x903B;&#x8F91;&#xFF0C;&#x5176;&#x5B9E;&#x90A3;&#x6BB5;&#x903B;&#x8F91;&#x662F;&#x4E0D;&#x76F8;&#x5173;&#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x7528;BufferedReader&#x57FA;&#x4E8E;&#x884C;&#x8BFB;&#x53D6;&#x7136;&#x540E;&#x7528;StringBuilder&#x627F;&#x8F7D;&#xFF0C;&#x6216;&#x8005;&#x50CF;&#x672C;&#x6587;&#x90A3;&#x6837;&#x76F4;&#x63A5;&#x8BFB;&#x53D6;&#x4E3A;byte&#x6570;&#x7EC4;&#x7B49;&#x7B49;&#xFF0C;&#x56E0;&#x4E3A;&#x6839;&#x672C;&#x7684;&#x539F;&#x56E0;&#x662F;&#x5E95;&#x5C42;&#x7684;Reactor-Netty&#x7684;&#x6570;&#x636E;&#x5757;&#x8BFB;&#x53D6;&#x5927;&#x5C0F;&#x9650;&#x5236;&#x5BFC;&#x81F4;&#x83B7;&#x53D6;&#x5230;&#x7684;DataBuffer&#x5B9E;&#x4F8B;&#x91CC;&#x9762;&#x7684;&#x6570;&#x636E;&#x662F;&#x4E0D;&#x5B8C;&#x6574;&#x7684;&#xFF0C;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x5C31;&#x662F;&#x53C2;&#x7167;Spring Cloud Gateway&#x672C;&#x8EAB;&#x63D0;&#x4F9B;&#x7684;&#x57FA;&#x7840;&#x7C7B;&#x5E93;&#x8FDB;&#x884C;&#x6539;&#x9020;(&#x6682;&#x65F6;&#x6CA1;&#x53D1;&#x73B0;&#x6709;&#x5165;&#x53E3;&#x53EF;&#x4EE5;&#x8C03;&#x6574;Reactor-Netty&#x7684;&#x914D;&#x7F6E;)&#xFF0C;&#x96BE;&#x5EA6;&#x4E5F;&#x4E0D;&#x5927;&#x3002;</p>
<h1 id="&#x5C0F;&#x7ED3;"><a href="#&#x5C0F;&#x7ED3;" class="headerlink" title="&#x5C0F;&#x7ED3;"></a>&#x5C0F;&#x7ED3;</h1><p>&#x521A;&#x597D;&#x9047;&#x5230;&#x4E00;&#x4E2A;&#x9700;&#x6C42;&#x9700;&#x8981;&#x505A;&#x7F51;&#x5173;&#x7684;&#x52A0;&#x89E3;&#x5BC6;&#x5305;&#x62EC;&#x8BF7;&#x6C42;&#x4F53;&#x548C;&#x54CD;&#x5E94;&#x4F53;&#x7684;&#x4FEE;&#x6539;&#xFF0C;&#x8FD9;&#x91CC;&#x987A;&#x4FBF;&#x628A;Spring Cloud Gateway&#x4E00;&#x4E9B;&#x6D89;&#x53CA;&#x5230;&#x8FD9;&#x65B9;&#x9762;&#x7684;&#x4E00;&#x4E9B;&#x5185;&#x5BB9;&#x68B3;&#x7406;&#x4E86;&#x4E00;&#x904D;&#xFF0C;&#x987A;&#x4FBF;&#x628A;&#x5751;&#x8E29;&#x4E86;&#x5E76;&#x4E14;&#x586B;&#x5B8C;&#x3002;&#x4E0B;&#x4E00;&#x6B65;&#x5C1D;&#x8BD5;&#x6309;&#x7167;&#x76EE;&#x524D;&#x5B98;&#x65B9;&#x63D0;&#x4F9B;&#x7684;&#x53EF;&#x7528;&#x7EC4;&#x4EF6;&#x4FEE;&#x6539;&#x4E00;&#x4E0B;&#x5B9E;&#x73B0;&#x81EA;&#x5B9A;&#x4E49;&#x7684;&#x903B;&#x8F91;&#xFF0C;&#x5305;&#x62EC;Hystrix&#x3001;&#x57FA;&#x4E8E;Eureka&#x548C;Ribbon&#x7684;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x3001;&#x9650;&#x6D41;&#x7B49;&#x7B49;&#x3002;</p>
<h1 id="&#x53C2;&#x8003;&#xFF1A;"><a href="#&#x53C2;&#x8003;&#xFF1A;" class="headerlink" title="&#x53C2;&#x8003;&#xFF1A;"></a>&#x53C2;&#x8003;&#xFF1A;</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.throwable.club/2019/05/18/spring-cloud-gateway-modify-request-response/">Spring Cloud Gateway-ServerWebExchange&#x6838;&#x5FC3;&#x65B9;&#x6CD5;&#x4E0E;&#x8BF7;&#x6C42;&#x6216;&#x8005;&#x54CD;&#x5E94;&#x5185;&#x5BB9;&#x7684;&#x4FEE;&#x6539;</a></li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/springcloud-gateway/" rel="tag">springcloud-gateway</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BD%91%E5%85%B3/" rel="tag">网关</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2021/09/01/9G5.010.%E6%A1%86%E6%9E%B6-SpringCloud-Gateway-throwable%E7%B3%BB%E5%88%97-Spring%20Cloud%20Gateway-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%99%A8%E9%80%9A%E8%BF%87Hystrix%E5%AE%9E%E7%8E%B0%E9%99%8D%E7%BA%A7%E5%A4%84%E7%90%86/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            框架-SpringCloud-Gateway-throwable系列-Spring Cloud Gateway-使用自定义过滤器通过Hystrix实现降级处理
          
        </div>
      </a>
    
    
      <a href="/2021/09/01/9G5.011.%E6%A1%86%E6%9E%B6-SpringCloud-Gateway-throwable%E7%B3%BB%E5%88%97-%E5%9F%BA%E4%BA%8ENetty%E5%92%8CSpringBoot%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%BD%BB%E9%87%8F%E7%BA%A7RPC%E6%A1%86%E6%9E%B6-%E5%8D%8F%E8%AE%AE%E7%AF%87/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">框架-SpringCloud-Gateway-throwable系列-基于Netty和SpringBoot实现一个轻量级RPC框架-协议篇</div>
      </a>
    
  </nav>

  
   
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2022
        <i class="ri-heart-fill heart_icon"></i> xugang.xie
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="xugang.xie&#39;s blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>